[
  {
    "objectID": "notebooks/whatsAtRisk/notebook.html",
    "href": "notebooks/whatsAtRisk/notebook.html",
    "title": "Appendix",
    "section": "",
    "text": "import { heroImage } from \"/helpers/hero.js\";\nhero_url = \"./../../images/atRisk.webp\";\n\nhero = heroImage(notebookTitle, hero_url);\nhtml`${hero}`;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nimport { atlasTOC } from '/helpers/toc.ojs' \n{\n  await nbText // force wait/reload with nbText to load so headings have correct labels/languages\n  return atlasTOC({\n      heading: `&lt;b&gt;${_lang({en:\"In this notebook\", fr:\"Dans ce notebook\"})}&lt;/b&gt;`,\n      skip: [notebookTitle, \"notebook-title\", \"Appendix\", \"source-code\"]\n      })\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n// pretty view of language toggle\nviewof prettyLanguageView = {\n  return Inputs.bind(\n    Inputs.radio(languages, {\n      label: _lang(nbText.supportNbText.labels.language),\n      format: (d) =&gt; d.label\n    }),\n    viewof language\n  );\n}\n\n\n\n\n\n\n\n{\n  const title = _lang(nbText.overview.header)\n  return md`# ${title}`\n}\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.overview.blocks.opener)\n  return md`${text}`\n}\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.africaMap.blocks.h1)\n  return md`# ${text}`\n}\n\n\n\n\n\n\n\n{\n  const template = _lang(nbText.africaMap.blocks.opener)\n  const items = [\n    {name: 'vop_blurb', value: _lang(nbText.vopNoteMd.blurb)}\n  ]\n  const format = Lang.reduceReplaceTemplateItems(template, items)\n  return md`${format}`\n}\n\n\n\n\n\n\n\n// format admin selections\n// bind to appendix inputs, add template to format\ngeoImpactAdminSelectors = {\n  const labelCountry = _lang(nbText.supportNbText.words.country.singular)\n  const labelRegion = _lang(nbText.supportNbText.words.region.singular)\n  const labelSubregion = _lang(nbText.supportNbText.words.subregion.singular)\n  \n  return Inputs.form(\n    [\n      Inputs.bind(\n        Inputs.select(dataAdmin0, {\n          label: labelCountry,\n          format: (x) =&gt; x.label\n        }),\n        viewof selectAdmin0\n      ),\n      Inputs.bind(\n        Inputs.select(dataAdmin1, {\n          label: labelRegion,\n          format: (x) =&gt; x.label\n        }),\n        viewof selectAdmin1\n      ),\n      Inputs.bind(\n        Inputs.select(dataAdmin2, {\n          label: labelSubregion,\n          format: (x) =&gt; x.label\n        }),\n        viewof selectAdmin2\n      )\n    ],\n    {\n      template: adminFormTemplate\n    }\n  );\n}\n\n\n\n\n\n\n\n// define choices for the data value\nviewof selectGeoDataType = {\n  const options = [\n    {\n      key: \"population\", // lookup id for data option\n      dataColumn: \"rural_pop\", // data column\n      label: _lang(nbText.africaMap.inputs.mapLayer.options.ruralPop.label), // label\n      labelTip: _lang(\n        nbText.africaMap.inputs.mapLayer.options.ruralPop.labelTip\n      ), // label for tooltip\n      labelLegend: _lang(\n        nbText.africaMap.inputs.mapLayer.options.ruralPop.labelLegend\n      ), // label for legend\n      formatFunc: formatNumCompactShort({locale: language.locale}), // formatting function for raw data value\n      formatFuncLegend: formatNumCompactShort({locale: language.locale}), // formatting function for legend\n      colorRange: colorScales.range.yellowGreen, // color range\n      colorUnknown: colorScales.unknown // unknown fill color\n    },\n    {\n      key: \"vop\",\n      dataColumn: \"vop_total\",\n      label: _lang(nbText.africaMap.inputs.mapLayer.options.vop.label),\n      labelTip: _lang(nbText.africaMap.inputs.mapLayer.options.vop.labelTip),\n      labelLegend: Lang.reduceReplaceTemplateItems(\n        _lang(nbText.africaMap.inputs.mapLayer.options.vop.labelLegend),\n        [{ name: \"unit\", value: intDollarUnit }]\n      ),\n      formatFunc: formatIntDollar({locale: language.locale}),\n      formatFuncLegend: formatUSD({locale: language.locale}),\n      colorRange: colorScales.range.yellowGreen,\n      colorUnknown: colorScales.unknown\n    }\n  ];\n  return Inputs.radio(\n    options.sort((a, b) =&gt; b.key.localeCompare(a.key)),\n    {\n      width: 300,\n      label: _lang(nbText.africaMap.inputs.mapLayer.label),\n      format: (x) =&gt; x.label,\n      value: options.find((t) =&gt; t.key === \"vop\")\n    }\n  );\n}\n\n\n\n\n\n\n\nplotChoroplethGeoImpact = {\n  const data = mapDataGeoImpact\n  const selector = selectGeoDataType\n  const vopCaption = _lang(nbText.vopNoteMd.caption);\n  const missingDataLabel = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.missingMapDataBlurb),\n    [{name: \"data_label\", value: selector.label}]\n  )\n  \n  const plot = Plot.plot({\n    width: mapWidth,\n    height: 550,\n    caption: `${missingDataLabel} ${vopCaption}`,\n    projection: {\n      type: \"azimuthal-equal-area\",\n      domain: data\n    },\n    color: {\n      legend: true,\n      label: selector.labelLegend,\n      range: selector.colorRange,\n      unknown: selector.colorUnknown,\n      tickFormat: selector.formatFuncLegend,\n    },\n    marks: [\n      // geo data\n      Plot.geo(data.features, {\n        fill: (d) =&gt; {\n          const dataColumn = selector.dataColumn\n          const fillValue = d.properties.data ? d.properties.data[dataColumn] : null; // handle missing data\n          return fillValue\n        },\n        stroke: \"#fff\",\n        strokeWidth: 0.5\n      }),\n      // admin2 highlight \n      // if Admin selection includes admin2, highlight section\n      Plot.geo(adminSelections.selectAdmin2.value \n               ? data.features.filter(d =&gt; d.properties.admin2_name == adminSelections.selectAdmin2.value)\n               : [], {\n        fill: null,\n        stroke: \"#333\",\n        strokeWidth: 1.5\n      }),\n      // geo pointer\n      Plot.geo(data, Plot.pointer(\n        Plot.centroid({\n        stroke: \"#333\",\n        strokeWidth: 1.5,\n      }))),\n      // tooltip\n      Plot.tip(\n        data.features,\n        Plot.pointer(\n          Plot.centroid({\n            channels: {\n              name: {\n                // region label, based on selection\n                label: getLowerLevelAdminLabel(), // plot-level so inputs don't reload\n                value: (d) =&gt; {\n                  const translated = _lang(td.admin0_name.values?.[d.properties.admin_name]);\n                  return translated ?? d.properties.admin_name\n                }\n              },\n              data: {\n                label: selector.labelTip,\n                value: (d) =&gt; {\n                const dataColumn = selector.dataColumn\n                const data = d.properties.data ? d.properties.data[dataColumn] : undefined\n                return data\n              },\n              }\n            },\n            format: {\n              name: true,\n              data: (d) =&gt; selector.formatFunc(d)\n            }\n          })\n        )\n      )\n    ]\n  });\n\n  return plot\n}\n\n\n\n\n\n\n\nbuildInlineDownloadButton(\n  mapDataGeoImpact.features.map((d) =&gt; d.properties),\n  _lang(download_translation),\n  `${selectGeoDataType.key}`,\n);\n\n\n\n\n\n\n\nheaderQuickInsightsGeoImpact = {\n  const template = _lang(nbText.africaMap.insights.title)\n  const items = [\n    {name: \"insight_string\", value: _lang(nbText.supportNbText.labels.quickInsights)},\n    {name: \"admin_selection\", value: getAdminSelection().label},\n  ]\n  const format = Lang.reduceReplaceTemplateItems(template, items)\n  return md`### ${format}`\n}\n\n\n\n\n\n\n\n// text insights for geo impact\ntextDynamicInsights_geoImpact = {\n  const adminSelection = getAdminSelectionLabelWithParen({\n    admin0Label: _lang(\n      td.admin0_name.values?.[getAdminSelectionAdmin0().value ?? \"SSA\"][\"article3\"]\n    ),\n    adminSublabel: getAdminSelection().label\n  });\n  const i = dynamicInsights_geoImpact.insight;\n\n  const translateCrop = (crop) =&gt; _lang(td.crop.values?.[crop]);\n  const topCommoditiesFiltered = i.topCommodities.filter((d) =&gt; d.data !== 0);\n  const topCommoditiesList = topCommoditiesFiltered.map(\n    (d, i) =&gt;\n      `${\n        i == topCommoditiesFiltered.length - 1\n          ? `${_lang(nbText.supportNbText.words.and)} `\n          : \"\"\n      }**${translateCrop(d.label)}** (**${d.value}**)`\n  );\n  const topLivestockFiltered = i.topLivestock.filter((d) =&gt; d.data !== 0);\n  const topLivestockList = topLivestockFiltered.map(\n    (d, i) =&gt;\n      `${\n        i == topLivestockFiltered.length - 1\n          ? `${_lang(nbText.supportNbText.words.and)} `\n          : \"\"\n      }**${translateCrop(d.label)}** (**${d.value}**)`\n  );\n\n  // new code\n  const langBasePath = nbText.africaMap.insights;\n  const langOverview = Lang.reduceReplaceTemplateItems(\n    _lang(langBasePath.insightOverview),\n    [\n      { name: \"admin_selection\", value: adminSelection },\n      { name: \"total_vop\", value: i.totalVop }\n    ]\n  );\n\n  const langAreaAndPop = Lang.reduceReplaceTemplateItems(\n    _lang(langBasePath.insightAreaAndPop),\n    [\n      { name: \"area\", value: i.totalHa },\n      { name: \"population\", value: i.totalPop }\n    ]\n  );\n\n  const langTopCommodity = Lang.reduceReplaceTemplateItems(\n    _lang(langBasePath.insightTopCommodity),\n    [\n      { name: \"commodity_word\", value: \"commodities\" },\n      {\n        name: \"verb\",\n        value:\n          topCommoditiesFiltered.length == 1\n            ? _lang(nbText.supportNbText.words.toBe.singular)\n            : _lang(nbText.supportNbText.words.toBe.plural)\n      },\n      { name: \"list_string\", value: topCommoditiesList.join(\", \") }\n    ]\n  );\n\n  const langTopLivestock = Lang.reduceReplaceTemplateItems(\n    _lang(langBasePath.insightTopLivestock),\n    [\n      {\n        name: \"verb\",\n        value:\n          topLivestockFiltered.length == 1\n            ? _lang(nbText.supportNbText.words.toBe.singular)\n            : _lang(nbText.supportNbText.words.toBe.plural)\n      },\n      { name: \"list_string\", value: topLivestockList.join(\", \") }\n    ]\n  );\n\n  return md`${langOverview}\n\n${langAreaAndPop}\n\n${langTopCommodity}\n\n${langTopLivestock}`;\n}\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.climateRisks.intro.h1)\n  return md`# ${text}`\n}\n\n\n\n\n\n\n\n{\n  const adminSelection = getAdminSelectionLabelWithParen({\n    admin0Label: Lang.toSentenceCase(\n      _lang(\n        td.admin0_name.values?.[getAdminSelectionAdmin0().value ?? \"SSA\"][\"article2\"]\n      )\n    ),\n    adminSublabel: getAdminSelection().label\n  });\n  const format = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.climateRisks.intro.opener),\n    [{ name: \"admin_selection\", value: adminSelection }]\n  );\n  return md`${format}`;\n}\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.climateRisks.compoundHazards.h2)\n  return md`## ${text}`\n}\n\n\n\n\n\n\n\n{\n  const text = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.climateRisks.compoundHazards.opener),\n    [\n      {name: \"vop_note\", value: _lang(nbText.vopNoteMd.blurb)},\n      {name: \"admin_selection\", value: getAdminSelection().label}\n    ]\n  )\n  return md`${text}`\n}\n\n\n\n\n\n\n\n// format admin selections\n// bind to appendix inputs, add template to format\nInputs.form(\n  [\n    Inputs.bind(\n      Inputs.select(dataAdmin0, { label: adminRegions.labels.admin0, format: x =&gt; x.label }),\n      viewof selectAdmin0\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin1, { label: adminRegions.labels.admin1, format: x =&gt; x.label }),\n      viewof selectAdmin1\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin2, { label: adminRegions.labels.admin2, format: x =&gt; x.label }),\n      viewof selectAdmin2\n    )\n  ],\n  {\n    template: adminFormTemplate\n  }\n)\n\n\n\n\n\n\n\nviewof selectScenarioAndTimeframe = {\n  // scenario and timeframe\n\n  const historicLabel = `${_lang(nbText.climateRisks.compoundHazards.inputs.dropdownScenario.historic)}: 1995-2014`\n\n  const data = [\n    {label: historicLabel, scenario: 'historic', timeframe: 'historic'},\n    {label: 'SSP245: 2021-2040', scenario: 'ssp245', timeframe: '2021_2040'},\n    {label: 'SSP245: 2041-2060', scenario: 'ssp245', timeframe: '2041_2060'},\n    {label: 'SSP585: 2021-2040', scenario: 'ssp585', timeframe: '2021_2040'},\n    {label: 'SSP585: 2041-2060', scenario: 'ssp585', timeframe: '2041_2060'},\n  ]\n  \n  return Inputs.select(data, {\n    label: _lang(nbText.climateRisks.compoundHazards.inputs.dropdownScenario.label),\n    format: x =&gt; x.label,\n    value: data.find(d =&gt; d.timeframe === 'historic')\n  });\n}\n\n\n\n\n\n\n\n{\n  const labelPerc = _lang(nbText.climateRisks.compoundHazards.stackedBar.tooltipLabels.totalVop)\n  const labelHazard = _lang(nbText.climateRisks.compoundHazards.stackedBar.tooltipLabels.hazard)\n  const labelVop = _lang(nbText.climateRisks.compoundHazards.stackedBar.tooltipLabels.vopRisk)\n  const xLabel = _lang(nbText.climateRisks.compoundHazards.stackedBar.xLabel)\n  const marginLeft = _lang({en: 110, fr: 150});\n  \n  const _anyData = T.tidy(\n    data_hazardVoP,\n    T.filter((d) =&gt; ![\"any\", \"no hazard\"].includes(d.hazard)), // only hazard components\n    T.groupBy(\n      [\n        \"admin0_name\",\n        \"admin1_name\",\n        \"admin2_name\",\n        \"scenario\",\n        \"timeframe\",\n        \"severity\",\n        \"crop\"\n      ],\n      [\n        T.summarize({\n          vop_any: T.sum(\"vop\")\n        })\n      ]\n    )\n  );\n\n  const _dataWithAnyColumn = T.tidy(\n    data_hazardVoP,\n    T.leftJoin(_anyData, {\n      by: [\n        \"admin0_name\",\n        \"admin1_name\",\n        \"admin2_name\",\n        \"scenario\",\n        \"timeframe\",\n        \"crop\",\n        \"severity\"\n      ]\n    })\n  );\n\n  const data = _dataWithAnyColumn;\n  const dataAny = data.filter((d) =&gt; d.hazard == \"any\"); // combined\n  const dataBars = [\n    ...data.filter((d) =&gt; d.hazard !== \"any\" && d.vop !== 0) // remove the combined hazard\n  ];\n  const yDomain = cropNames\n    .filter((d) =&gt; {\n      const availableCrops = _.uniq(dataBars.map((d) =&gt; d.crop));\n      return availableCrops.includes(d.crop);\n    })\n    .sort((a,b) =&gt; {\n      // sort by type, then name\n      if (a.type &lt; b.type) return -1\n      if (a.type &gt; b.type) return 1\n\n      if (a.cropName &lt; b.cropName) return -1\n      if (a.cropName &gt; b.cropName) return 1\n\n      return 0\n    })\n    .map((d) =&gt; d.cropName);\n  const vopCaption = _lang(nbText.vopNoteMd.caption);\n\n  return Plot.plot({\n    width: 1200,\n    height: 850,\n    marginLeft,\n    marginRight: 85,\n    caption: vopCaption,\n    color: {\n      domain: hazardPlotLookup.color.domain,\n      range: hazardPlotLookup.color.range,\n      legend: true\n    },\n    x: {\n      ticks: 1,\n      axis: \"top\",\n      domain: [0, 100],\n      grid: true,\n      label: xLabel\n    },\n    y: {\n      domain: yDomain,\n      label: null\n    },\n    marks: [\n      // main y-axis\n      Plot.axisY({\n        tickSize: 0\n      }),\n      // pointer white-out\n      Plot.axisY(\n        Plot.pointerY({\n          fill: \"white\",\n          textStroke: \"white\",\n          textStrokeWidth: 2,\n          tickSize: 0\n        })\n      ),\n      // bold pointer\n      Plot.axisY(\n        Plot.pointerY({\n          fontWeight: \"bold\",\n          tickSize: 0\n        })\n      ),\n      // hazard component bars\n      Plot.barX(\n        dataBars,\n        Plot.stackX(\n          { order: hazardPlotLookup.color.domain },\n          {\n            x: (d) =&gt; (d.vop / d.vop_total) * 100,\n            y: (d) =&gt; hazardPlotLookup.crops[d.crop],\n            fill: (d) =&gt; hazardPlotLookup.names[d.hazard],\n            stroke: \"#fff\",\n            strokeWidth: 0.25\n          }\n        )\n      ),\n      // tooltip\n      Plot.tip(\n        dataBars,\n        Plot.pointerY(\n          Plot.stackX(\n            { order: hazardPlotLookup.color.domain },\n            {\n              x: (d) =&gt; (d.vop / d.vop_total) * 100,\n              y: (d) =&gt; hazardPlotLookup.crops[d.crop],\n              fill: (d) =&gt; hazardPlotLookup.names[d.hazard],\n              channels: {\n                perc: {\n                  label: labelPerc,\n                  value: (d) =&gt; {\n                    const percent = formatPercentWhole(d.vop_any / d.vop_total);\n                    const vop = formatIntDollar({locale: language.locale})(d.vop_any);\n                    return `${percent} (${vop})`;\n                  }\n                  // value: (d) =&gt; formatUSD(d.vop_any)\n                },\n                hazard: {\n                  label: labelHazard,\n                  value: (d) =&gt; hazardPlotLookup.names[d.hazard]\n                },\n                vop: {\n                  label: labelVop,\n                  value: (d) =&gt; {\n                    const percent = formatPercentWhole(d.vop / d.vop_total);\n                    const vop = formatIntDollar({locale: language.locale})(d.vop);\n                    return `${percent} (${vop})`;\n                  }\n                }\n              },\n              format: {\n                x: false,\n                y: false,\n                fill: false,\n                vop: true,\n                hazard: true,\n                perc: true\n              },\n              lineWidth: 50\n            }\n          )\n        )\n      ),\n      // total VoP, sidebar highlight\n      Plot.textX(\n        dataAny,\n        Plot.pointerY({\n          x: 100,\n          y: (d) =&gt; hazardPlotLookup.crops[d.crop],\n          text: (d) =&gt; {\n            const value = formatIntDollar({locale: language.locale})(d.vop_total);\n            return `${value}`;\n          },\n          textAnchor: \"start\",\n          dx: 5\n        })\n      )\n    ]\n  });\n}\n\n\n\n\n\n\n\nbuildInlineDownloadButton(\n  data_hazardVoP,\n  _lang(download_translation),\n  `CropClimateExposure_${selectScenarioAndTimeframe.label.replace(/\\s/g, \"\")}`,\n);\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.climateRisks.hazardImpact.h1)\n  return md`## ${text}`\n}\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.climateRisks.hazardImpact.intro)\n  return md`${text}`\n}\n\n\n\n\n\n\n\n// picking hazard\nviewof selectHazard = {\n  const data = new Map(\n    Object.keys(hazardPlotLookup.names)\n    .filter(d =&gt; d !== 'no hazard') // remove no hazard option\n    .map(d =&gt; [hazardPlotLookup.names[d], d])\n  );\n  return Inputs.select(data, {\n    value: 'dry',\n    label: _lang(nbText.climateRisks.hazardImpact.inputs.dropdownHazard.label)\n  });\n}\n\n\n\n\n\n\n\n{\n  const template = _lang(nbText.climateRisks.hazardImpact.plots.crops.header)\n  const items = [{name: \"hazard_string\", value: hazardPlotLookup.names[selectHazard].toLowerCase()}]\n  const format = Lang.reduceReplaceTemplateItems(template, items)\n  return md`### ${format}`\n}\n\n\n\n\n\n\n\n{\n  const data = data_hazardVoP.filter((d) =&gt; {\n    return (\n      d.hazard == selectHazard &&\n      d.vop !== 0 &&\n      riskDataTypes.crop.crop.includes(d.crop)\n    ); // lookup crop type\n  });\n  const marginLeft = _lang({en: 110, fr: 120});\n  return makeTopCropBarChart(data, {marginLeft});\n}\n\n\n\n\n\n\n\nbuildInlineDownloadButton(\n  data_hazardVoP.filter((d) =&gt; {\n    return (\n      d.hazard == selectHazard &&\n      d.vop !== 0 &&\n      riskDataTypes.crop.crop.includes(d.crop)\n    );\n  }),\n  _lang(download_translation),\n  `CropRisk_${selectHazard}`,\n);\n\n\n\n\n\n\n\n{\n  const template = _lang(nbText.climateRisks.hazardImpact.plots.livestock.header)\n  const items = [{name: \"hazard_string\", value: hazardPlotLookup.names[selectHazard].toLowerCase()}]\n  const format = Lang.reduceReplaceTemplateItems(template, items)\n  return md`### ${format}`\n}\n\n\n\n\n\n\n\n{\n  const data = data_hazardVoP.filter((d) =&gt; {\n    return (\n      d.hazard == selectHazard &&\n      d.vop !== 0 &&\n      riskDataTypes.crop.livestock.includes(d.crop)\n    ); // lookup crop type\n  });\n  const marginLeft = _lang({en: 110, fr: 150});\n  return makeTopCropBarChart(data, {marginLeft});\n}\n\n\n\n\n\n\n\nbuildInlineDownloadButton(\n  data_hazardVoP.filter((d) =&gt; {\n    return (\n      d.hazard == selectHazard &&\n      d.vop !== 0 &&\n      riskDataTypes.crop.livestock.includes(d.crop)\n    );\n  }),\n  _lang(download_translation),\n  `LivestockRisk_${selectHazard}`,\n);\n\n\n\n\n\n\n\n{\n  const format = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.climateRisks.hazardImpact.insights.title),\n    [\n      { name: \"insight_string\", value: _lang(nbText.supportNbText.labels.quickInsights) },\n      { name: \"admin_selection\", value: getAdminSelection().label },\n      { name: \"scenario\", value: selectScenarioAndTimeframe.label }\n    ]\n  );\n  return md`### ${format}`\n}\n\n\n\n\n\n\n\n{\n  const selectedHazard = hazardPlotLookup.names[selectHazard]\n  const langLookup = {\n    hazard: selectedHazard,\n    hazardBlurb: Lang.reduceReplaceTemplateItems(\n      _lang(nbText.climateRisks.hazardImpact.insights.hazardBlurb),\n      [{name: \"hazard_string\", value: selectedHazard}]\n    ),\n    labels: {\n      totalVopCrop: _lang(\n        nbText.climateRisks.hazardImpact.insights.labels.totalVopCrop\n      ),\n      totalVopLivestock: _lang(\n        nbText.climateRisks.hazardImpact.insights.labels.totalVopLivestock\n      ),\n      exposureCrop: _lang(\n        nbText.climateRisks.hazardImpact.insights.labels.exposureCrop\n      ),\n      exposureLivestock: _lang(\n        nbText.climateRisks.hazardImpact.insights.labels.exposureLivestock\n      )\n    }\n  };\n\n  const crop = insight_totalExposedVop.filter(\n    (d) =&gt; d.totalExposedVop !== 0 && d.cropType == \"crop\"\n  )?.[0]?.[\"totalExposedVop\"];\n  const livestock = insight_totalExposedVop.filter(\n    (d) =&gt; d.totalExposedVop !== 0 && d.cropType == \"livestock\"\n  )?.[0]?.[\"totalExposedVop\"];\n\n  const topCrop = insight_topCrops.filter(\n    (d) =&gt; d.vop !== 0 && d.cropType == \"crop\"\n  )?.[0];\n  const topLivestock = insight_topCrops.filter(\n    (d) =&gt; d.vop !== 0 && d.cropType == \"livestock\"\n  )?.[0];\n\n  const missingValue = \"---\";\n\n  function showResult(value, format) {\n    if (value === null || value === undefined) return missingValue;\n    return format(value);\n  }\n\n  const topCropString =\n    topCrop !== undefined\n      ? `**${hazardPlotLookup.crops[topCrop?.[\"crop\"]]}** (**${formatIntDollar({locale: language.locale})(\n          topCrop?.[\"vop\"]\n        )}**)`\n      : `**${missingValue}**`;\n  const topLivestockString =\n    topLivestock !== undefined\n      ? `**${\n          hazardPlotLookup.crops[topLivestock?.[\"crop\"]]\n        }** (**${formatIntDollar({locale: language.locale})(topLivestock?.[\"vop\"])}**)`\n      : `**${missingValue}**`;\n\n  return md`${langLookup.hazardBlurb}\n\n- ${langLookup.labels.totalVopCrop}: **${showResult(crop, formatIntDollar({locale: language.locale}))}**\n- ${langLookup.labels.totalVopLivestock}: **${showResult(\n    livestock,\n    formatIntDollar({locale: language.locale})\n  )}**\n- ${langLookup.labels.exposureCrop}: ${topCropString}\n- ${langLookup.labels.exposureLivestock}: ${topLivestockString}\n`;\n}\n\n\n\n\n\n\n\n{\n  const intro = _lang(nbText.climateRisks.hazardImpact.insights.blurbBiggestHazard)\n  return md`${intro}\n- **${hazardPlotLookup.names[insight_rankedHazardVopTotals?.[0]?.['hazard']]}**: **${formatIntDollar({locale: language.locale})(insight_rankedHazardVopTotals?.[0]?.['totalVop'])}**\n- **${hazardPlotLookup.names[insight_rankedHazardVopTotals?.[1]?.['hazard']]}**: **${formatIntDollar({locale: language.locale})(insight_rankedHazardVopTotals?.[1]?.['totalVop'])}**`\n}\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.adaptiveCapacities.h1)\n  return md`# ${text}`\n}\n\n\n\n\n\n\n\n{\n  const adminSelection = getAdminSelectionLabelWithParen({\n    admin0Label: _lang(\n      td.admin0_name.values?.[getAdminSelectionAdmin0().value ?? \"SSA\"][\"article3\"]\n    ),\n    adminSublabel: getAdminSelection().label\n  });\n  const format = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.adaptiveCapacities.intro),\n    [{name: \"admin_selection\", value: adminSelection}]\n  )\n  return md`${format}`\n}\n\n\n\n\n\n\n\n// format admin selections\n// bind to appendix inputs, add template to format\nInputs.form(\n  [\n    Inputs.bind(\n      Inputs.select(dataAdmin0, { label: adminRegions.labels.admin0, format: x =&gt; x.label }),\n      viewof selectAdmin0\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin1, { label: adminRegions.labels.admin1, format: x =&gt; x.label }),\n      viewof selectAdmin1\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin2, { label: adminRegions.labels.admin2, format: x =&gt; x.label }),\n      viewof selectAdmin2\n    )\n  ],\n  {\n    template: adminFormTemplate\n  }\n)\n\n\n\n\n\n\n\n// define choices for the data value\nviewof selectAcDataTypeNew = {\n  const options = dataLayerOptionsAdaptiveCapacities;\n  \n  return Inputs.radio(options, {\n    width: 300,\n    label: _lang(nbText.adaptiveCapacities.inputs.mapLayer.label),\n    format: (x) =&gt; x.label,\n    value: options.find((t) =&gt; t.key === \"pov\"),\n    sort: true\n  });\n}\n\n\n\n\n\n\n\nplotChoroplethAdaptiveCapacity1 = {\n  const data = mapFeaturesAdaptiveCapacity; // geo, with bound data\n  const selector = selectAcDataTypeNew;\n  const options = dataLayerOptionsAdaptiveCapacities;\n\n  const filler = selectAcDataTypeNew.key === \"edu\" ? (c) =&gt; c : transformPercent\n\n  function _getOption(key, data = options) {\n    return data.find((x) =&gt; x.key == key);\n  }\n\n  const missingDataLabel = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.missingMapDataBlurb),\n    [{ name: \"data_label\", value: selector.label }]\n  );\n\n  return Plot.plot({\n    caption: missingDataLabel,\n    marginBottom: 20,\n    width: mapWidth,\n    height: 550,\n    projection: {\n      type: \"azimuthal-equal-area\",\n      domain: {\n        type: \"FeatureCollection\",\n        features: data\n      }\n    },\n    color: {\n      // scheme: 'Cividis',\n      legend: true,\n      // domain: [0, 100],\n      range:\n        selector.key === \"pov\"\n          ? selector.colorDomain\n          : selector.colorDomain.slice().reverse(),\n      unknown: selector.colorUnknown,\n      label: selector.labelLegend\n    },\n    marks: [\n      // geo data\n      Plot.geo(data, {\n        // convert non-null to percent\n        fill: (d) =&gt; filler(d.properties.data[selector.dataColumn]),\n        stroke: \"#fff\",\n        strokeWidth: 0.5\n      }),\n      // admin2 highlight\n      // if Admin selection includes admin2, highlight section\n      Plot.geo(\n        adminSelections.selectAdmin2.value\n          ? data.filter(\n              (d) =&gt; d.properties.admin2_name == adminSelections.selectAdmin2.value\n            )\n          : [],\n        {\n          fill: null,\n          stroke: \"#333\",\n          strokeWidth: 1.5\n        }\n      ),\n      // geo pointer\n      Plot.geo(\n        data,\n        Plot.pointer(\n          Plot.centroid({\n            stroke: \"#333\",\n            strokeWidth: 1.5\n          })\n        )\n      ),\n      // tooltip\n      Plot.tip(\n        data,\n        Plot.pointer(\n          Plot.centroid({\n            lineWidth: Infinity,\n            channels: {\n              name: {\n                label:\n                  // label for region, by admin selection\n                  // plot-level so inputs don't reload\n                  adminSelections.selectAdmin0.value\n                    ? adminRegions.labels.admin2\n                    : adminRegions.labels.admin0,\n                value: (d) =&gt; {\n                  const translated = _lang(td.admin0_name.values?.[d.properties.admin_name]);\n                  return translated ?? d.properties.admin_name\n                }\n              },\n              percent: {\n                // specific selected value\n                label: selector.label,\n                value: (d) =&gt; {\n                  const dataColumn = selector.dataColumn;\n                  // const data = d.properties.data[dataColumn]\n                  const data = formatPercentNoSymbol(\n                    transformPercent(d.properties.data[dataColumn])\n                  );\n                  return data;\n                }\n              },\n              totalPopulation: {\n                label: selector.labelPop,\n                value: (d) =&gt;\n                  formatNumCompactShort({locale: language.locale})(d.properties.data[selector.popColumn])\n              },\n              ac_pov: {\n                label: _getOption(\"pov\").label,\n                value: (d) =&gt; {\n                  const dataColumn = _getOption(\"pov\").dataColumn;\n                  const pov_rate = formatPercentNoSymbol(\n                    transformPercent(d.properties.data[dataColumn])\n                  );\n                  return `${pov_rate}%`\n                }\n              },\n              ac_edu: {\n                label: _getOption(\"edu\").label,\n                value: (d) =&gt; {\n                  const dataColumn = _getOption(\"edu\").dataColumn;\n                  return `${d.properties.data[dataColumn].toFixed(2)} Yrs`\n                  // return formatPercentNoSymbol(\n                  //   transformPercent(d.properties.data[dataColumn])\n                  // );\n                }\n              },\n              ac_fem: {\n                label: _getOption(\"fem\").label,\n                value: (d) =&gt; {\n                  const dataColumn = _getOption(\"fem\").dataColumn;\n                  return formatPercentNoSymbol(\n                    transformPercent(d.properties.data[dataColumn])\n                  );\n                }\n              }\n            },\n            format: {\n              name: true,\n              totalPopulation: true,\n              ac_pov: true,\n              ac_edu: true,\n              ac_fem: true\n              // percent: true\n            }\n          })\n        )\n      )\n    ]\n  });\n}\n\n\n\n\n\n\n\nbuildInlineDownloadButton(\n  dataAdaptiveCapacity,\n  _lang(download_translation),\n  \"AdaptiveCapacityMap\",\n);\n\n\n\n\n\n\n\n{\n  const format = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.adaptiveCapacities.insights.title),\n    [\n      { name: \"insight_string\", value: _lang(nbText.supportNbText.labels.quickInsights) },\n      { name: \"admin_selection\", value: getAdminSelection().label },\n    ]\n  );\n  return md`## ${format}`\n}\n\n\n\n\n\n\n\ntextDynamicInsights_adaptiveCapacities2 = {\n  // return md`TODO: based on icicle data`\n\n  // dynamic insight based on selected region\n\n  const admin2 = adminSelections.selectAdmin2.value;\n  const admin2MadLib = adaptiveCapacityInsightMadLib2(\n    dynamicInsights_adaptiveCapacity.insights.admin2,\n    admin2\n  );\n  const admin1 = adminSelections.selectAdmin1.value;\n  const admin1MadLib = adaptiveCapacityInsightMadLib2(\n    dynamicInsights_adaptiveCapacity.insights.admin1,\n    admin1\n  );\n  const admin0 = adminSelections.selectAdmin0.label ?? globalSelection.label;\n  const admin0Insights = dynamicInsights_adaptiveCapacity.insights.admin0;\n  const admin0MadLib = adaptiveCapacityInsightMadLib2(\n    admin0Insights,\n    admin0\n  );\n\n  const langWithinAdmin1 = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.adaptiveCapacities.insights.nestedLocationBlurb),\n    [\n      { name: \"admin_inner\", value: admin2 },\n      { name: \"admin_outer\", value: admin1 }\n    ]\n  );\n  const withinAdmin1 = admin2\n    ? `${langWithinAdmin1}`\n    : ``;\n\n  const langWithinAdmin0 = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.adaptiveCapacities.insights.nestedLocationBlurb),\n    [\n      { name: \"admin_inner\", value: admin1 },\n      { name: \"admin_outer\", value: admin0 }\n    ]\n  );\n  const withinAdmin0 = admin1\n    ? `${langWithinAdmin0}`\n    : ``;\n\n  // Text sections ------------------------------\n  const admin2Text = md`${admin2MadLib}`;\n\n  const admin1Text = md`${withinAdmin1} ${admin1MadLib}`;\n\n  const admin0Text = md`${withinAdmin0} ${admin0MadLib}`;\n\n  // Final text ------------------------------\n  return md`${admin2 ? admin2Text : \"\"}\n${admin1 ? admin1Text : \"\"}\n${admin0Insights ? admin0Text : \"\"}\n`;\n}\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.adaptiveCapacities.delvingDeeper.h2)\n  return md`## ${text}`\n}\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.adaptiveCapacities.delvingDeeper.intro)\n  return md`${text}`\n}\n\n\n\n\n\n\n\n// format admin selections\n// bind to appendix inputs, add template to format\nInputs.form(\n  [\n    Inputs.bind(\n      Inputs.select(dataAdmin0, { label: adminRegions.labels.admin0, format: x =&gt; x.label }),\n      viewof selectAdmin0\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin1, { label: adminRegions.labels.admin1, format: x =&gt; x.label }),\n      viewof selectAdmin1\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin2, { label: adminRegions.labels.admin2, format: x =&gt; x.label }),\n      viewof selectAdmin2\n    )\n  ],\n  {\n    template: adminFormTemplate\n  }\n)\n\n\n\n\n\n\n\nbreadcrumb = {\n  const svg = d3\n    .create(\"svg\")\n    .attr(\"viewBox\", `0 0 ${breadcrumbWidth * 4.75} ${breadcrumbHeight}`)\n    .style(\"font\", \"11px sans-serif\")\n    .style(\"margin\", \"2px\");\n\n  const g = svg\n    .selectAll(\"g\")\n    .data(icicle.sequence)\n    .join(\"g\")\n    .attr(\"transform\", (d, i) =&gt; `translate(${i * breadcrumbWidth}, 0)`);\n\n  g.append(\"polygon\")\n    .attr(\"points\", breadcrumbPoints)\n    .attr(\"fill\", (d) =&gt; icicle_color(d.data.name))\n    .attr(\"stroke\", \"white\");\n\n  g.append(\"text\")\n    .attr(\"x\", (breadcrumbWidth + 10) / 2)\n    .attr(\"y\", 15)\n    .attr(\"dy\", \"0.35em\")\n    .attr(\"text-anchor\", \"middle\")\n    .attr(\"fill\", \"white\")\n    .text((d) =&gt; icicle_alias[d.data.name]);\n\n  if (icicle.sequence.length &gt; 1) {\n    svg\n      .append(\"text\")\n      .text(icicle.percentage &gt; 0 ? icicle.percentage + \"%\" : \"\")\n      .attr(\"x\", (icicle.sequence.length + 0.25) * breadcrumbWidth)\n      .attr(\"y\", breadcrumbHeight / 2)\n      .attr(\"dy\", \"0.35em\")\n      .attr(\"text-anchor\", \"middle\");\n  }\n\n  return svg.node();\n}\n\n\n\n\n\n\n\nviewof icicle = {\n  const root = partition(icicle_data);\n  let frozen = false;\n  let frozenSequence = [];\n  // const padding = 10;\n  const svg = d3.create(\"svg\");\n  // Make this into a view, so that the currently hovered sequence is available to the breadcrumb\n  const element = svg.node();\n  element.value = { sequence: [], percentage: 0.0 };\n\n  svg\n    .attr(\"viewBox\", `0 0 ${width} ${height}`)\n    .style(\"font\", \"12px sans-serif\");\n\n  svg\n    .append(\"rect\")\n    .attr(\"width\", width)\n    .attr(\"height\", height)\n    .attr(\"fill\", \"none\");\n\n  const segment = svg\n    .append(\"g\")\n    .attr(\"transform\", (d) =&gt;\n      narrow ? `translate(${-root.y1}, 40)` : `translate(0, ${-root.y1 + 40})`\n    )\n    .selectAll(\"rect\")\n    .data(\n      root.descendants().filter((d) =&gt; {\n        return d.depth;\n      })\n    )\n    .join(\"rect\")\n    .attr(\"fill\", (d) =&gt; icicle_color(d.data.name))\n    .attr(\"x\", segmentX)\n    .attr(\"y\", segmentY)\n    .attr(\"width\", segmentWidth)\n    .attr(\"height\", segmentHeight)\n    .on(\"mouseenter\", (event, d) =&gt; {\n      if (frozen) return;\n      // Get the ancestors of the current segment, minus the root\n      const sequence = d.ancestors().reverse().slice(1);\n      // Highlight the ancestors\n      segment.attr(\"fill-opacity\", (node) =&gt;\n        sequence.indexOf(node) &gt;= 0 ? 1.0 : 0.3\n      );\n      const percentage = (100 * (d.value / root.value)).toPrecision(3);\n      element.value = { sequence, percentage };\n      element.dispatchEvent(new CustomEvent(\"input\"));\n    })\n    .on(\"click\", (event, d) =&gt; {\n      if (frozen) {\n        frozen = false;\n        return;\n      } else {\n        frozen = true;\n        frozenSequence = d.ancestors().reverse().slice(1);\n        segment.attr(\"fill-opacity\", (node) =&gt;\n          frozenSequence.indexOf(node) &gt;= 0 ? 1.0 : 0.3\n        );\n        const percentage = (100 * (d.value / root.value)).toPrecision(3);\n        element.value = { sequence: frozenSequence, percentage };\n        element.dispatchEvent(new CustomEvent(\"input\"));\n        event.stopPropagation(); // prevent svg click from firing\n      }\n    });\n\n  svg.on(\"mouseleave\", () =&gt; {\n    if (frozen) return;\n    segment.attr(\"fill-opacity\", 1);\n    // Update the value of this view\n    element.value = { sequence: [], percentage: 0.0 };\n    element.dispatchEvent(new CustomEvent(\"input\"));\n  });\n\n  svg.on(\"click\", () =&gt; {\n    if (frozen) {\n      frozen = false;\n      frozenSequence = [];\n      segment.attr(\"fill-opacity\", 1);\n      element.value = { sequence: [], percentage: 0.0 };\n      element.dispatchEvent(new CustomEvent(\"input\"));\n    }\n  });\n\n  // add legend\n  const colorScale = d3\n    .scaleOrdinal()\n    .domain([\"Better\", \"Moderate\", \"Worse\"])\n    .range([\"#F4BB21\", \"#FC8A34\", \"#EC5A47\"]);\n\n  svg\n    .append(\"rect\")\n    .attr(\"x\", 1)\n    .attr(\"y\", 5)\n    .attr(\"rx\", 10) // Add rounded corners\n    .attr(\"ry\", 10) // Add rounded corners\n    .attr(\"width\", 300) // Adjust the width to fit the legend\n    .attr(\"height\", 30) // Adjust the height to fit the legend\n    .attr(\"fill\", \"#fff\");\n  // .attr(\"stroke\", \"black\");\n\n  const legend = svg\n    .selectAll(\".legend\")\n    .data(colorScale.domain())\n    .enter()\n    .append(\"g\")\n    .attr(\"class\", \"legend\")\n    .attr(\"transform\", function (d, i) {\n      return \"translate(\" + (i * 100 + 25) + \",11)\";\n    });\n\n  legend\n    .append(\"rect\")\n    .attr(\"x\", 0)\n    .attr(\"width\", 18)\n    .attr(\"height\", 18)\n    .style(\"fill\", colorScale);\n\n  legend\n    .append(\"text\")\n    .attr(\"x\", 24)\n    .attr(\"y\", 9)\n    .attr(\"dy\", \".35em\")\n    .text(function (d) {\n      return d;\n    });\n\n  return element;\n}\n\n\n\n\n\n\n\nicicle_pct_table = {\n  // A little function to basically calcualte the same thing as the breadcrumb but for all the admin region.\n  // This is what users should see if going to a tabular view and also what they should download. It is much easier to understand and work with.\n  const summarize_icicle = (csv, icicle_keys = null) =&gt; {\n    const rows = csv.map(row =&gt; ({\n      parts: row.path.split(\"_\").slice(1),\n      value: +row.value\n    }));\n    const total = d3.sum(rows, (d) =&gt; d.value);\n\n    const maxDepth = Math.max(...rows.map((r) =&gt; r.parts.length));\n    const levelNames = icicle_keys\n      ? Object.keys(icicle_keys)\n      : [...Array(maxDepth).keys()].map((i) =&gt; `level${i + 1}`);\n\n    const lookupName = (dim, key) =&gt; {\n      if (!icicle_keys) return key;\n      return icicle_keys[dim]?.[key]?.[0] ?? key;\n    };\n\n    const genderTotals = {};\n    rows.forEach((r) =&gt; {\n      const gender = r.parts[0];\n      genderTotals[gender] = (genderTotals[gender] || 0) + r.value;\n    });\n\n    // Recursive helper\n    const recurse = (rows, depth = 0, prefix = []) =&gt; {\n      if (!rows.length) return [];\n      if (depth &gt;= maxDepth) return [];\n\n      return d3\n        .rollups(\n          rows,\n          (v) =&gt; d3.sum(v, (d) =&gt; d.value),\n          (d) =&gt; d.parts[depth]\n        )\n        .flatMap(([k, sum]) =&gt; {\n          const current = [...prefix, k];\n          const rowObj = {};\n          levelNames.forEach((col, i) =&gt; {\n            rowObj[col] = current[i] ? lookupName(col, current[i]) : null;\n          });\n          rowObj.pct_total = (100 * sum) / total;\n          // pct relative to gender\n          const genderKey = prefix[0];\n          if (genderKey && genderTotals[genderKey]) {\n            rowObj.pct_of_gender = (100 * sum) / genderTotals[genderKey];\n          }\n          return [\n            rowObj,\n            ...recurse(\n              rows.filter((r) =&gt; r.parts[depth] === k),\n              depth + 1,\n              current\n            )\n          ];\n        });\n    };\n\n    return recurse(rows);\n  };\n\n  return buildInlineDownloadButton(\n    summarize_icicle(icicle_raw, icicle_keys),\n    _lang(download_translation),\n    `AdaptiveCapacityIcicle_${selectAdmin0.label.replace(/\\s/g, \"\")}`\n  )\n  \n}\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.summary.h1)\n  return md`# ${text}`\n}\n\n\n\n\n\n\n\ndynamicSummaryCell = {\n  let dynamicSummary = \"\";\n  // add filter to do nothing in case where no admin0 is selected\n  if (adminSelections.selectAdmin0.value !== null) {\n    dynamicSummary = Lang.reduceReplaceTemplateItems(\n      _lang(nbText.summary.dynamicSummarylist),\n      [{ name: \"markdownList\", value: dynamicSummaryMarkdown }]\n    );\n  }\n  const admin0 = _lang(\n    td.admin0_name.values?.[getAdminSelectionAdmin0().value ?? 'SSA'][\"article3\"]\n  );\n  const intro = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.summary.blocks.dynamicSummary.intro),\n    [{ name: \"admin0\", value: admin0 }]\n  );\n\n  return md`${intro} ${dynamicSummary}`;\n}\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.summary.blocks.closer)\n  return md`${text}`\n}\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.methods.h1)\n  return md`# ${text}`\n}\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.methods.section1)\n  return md`## ${text}`\n}\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.methods.section1.subsections);\n  return md`${text}`\n}\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.methods.section2)\n  return md`## ${text}`\n}\n\n\n\n\n\n\n\n{\n  const text = _lang(nbText.methods.section2.subsections)\n  return md`${text}`\n}\n\n\n\n\n\n\n\nAppendix\n\nmd`---\n## Work by Topic\n*Cells that power different sections*`;\n\n\n\n\n\n\n\nmd`---\n### Support notebook\n[Support Notebook](https://observablehq.com/@periscopic/ab-atlas-spotlight-support): used for imports across spotlights.`;\n\n\n\n\n\n\n\nmd`---\n### Notebook Variables\n_Main variables across notebook_`;\n\n\n\n\n\n\n\n// main title of the notebook\nnotebookTitle = _lang({\n  en: \"Evaluate Climate Risks\",\n  fr: \"Evaluer les risques climatiques\",\n});\n\n\n\n\n\n\n\n// info for the admin selectors\nadminRegions = {\n  return {\n    labels: {\n      admin0: Lang.toSentenceCase(\n        _lang(nbText.supportNbText.words.country.singular)\n      ),\n      admin1: Lang.toSentenceCase(\n        _lang(nbText.supportNbText.words.region.singular)\n      ),\n      admin2: Lang.toSentenceCase(\n        _lang(nbText.supportNbText.words.subregion.singular)\n      )\n    },\n    allLabels: {\n      admin1: _lang(nbText.supportNbText.labels.allRegions),\n      admin2: _lang(nbText.supportNbText.labels.allSubregions),\n    }\n  };\n}\n\n\n\n\n\n\n\nfunction getLowerLevelAdminLabel(selections = adminSelections) {\n  // based on admin selection, get the lower level label\n  if (selections.selectAdmin2.value) return adminRegions.labels.admin2;\n  if (selections.selectAdmin1.value) return adminRegions.labels.admin2;\n  if (selections.selectAdmin0.value) return adminRegions.labels.admin1;\n  else return adminRegions.labels.admin0;\n}\n\n\n\n\n\n\n\n// width of the maps\nmapWidth = 625;\n\n\n\n\n\n\n\nmd`**Language and notebook text**`;\n\n\n\n\n\n\n\nimport { Lang } from \"7d46679f7d0d917e\";\n\n\n\n\n\n\n\nlanguages = [\n  { key: \"en\", label: \"English\", locale: \"en-US\" },\n  { key: \"fr\", label: \"Français\", locale: \"fr-FR\" },\n];\n\n\n\n\n\n\n\n// get the default language key from parameter, or use default\ndefaultLangKey = {\n  const name = \"lang\";\n  const list = languages.map((d) =&gt; d.key);\n  const defaultKey = \"en\";\n\n  const queryParam = await Lang.getParamFromList({ name, list });\n\n  return queryParam ?? defaultKey;\n}\n\n\n\n\n\n\n\n// helper shorthand for Lang text-getting\n_lang = Lang.lg(language.key);\n\n\n\n\n\n\n\n// main toggle of language key\nviewof language = Inputs.radio(languages, {\n  label: \"Main language toggle\",\n  format: (d) =&gt; d.key,\n  value: languages.find((x) =&gt; x.key === defaultLangKey),\n})\n\n\n\n\n\n\n\nnbText = {\n  // text in the notebook\n  // recommendation: only use objects for better tab-completion\n  return {\n    supportNbText: {\n      labels: {\n        allRegions: {\n          en: \"All regions\",\n          fr: \"Toutes les régions\"\n        },\n        allSubregions: {\n          en: \"All subregions\",\n          fr: \"Toutes les sous-régions\"\n        },\n        quickInsights: {\n          en: \"Quick Insights\",\n          fr: \"Aperçu Rapide\"\n        },\n        language: {\n          en: \"Language\",\n          fr: \"Langue\"\n        },\n        tocTitle: {\n          en: \"In this notebook\",\n          fr: \"Dans ce notebook\"\n        },\n        crop: {\n          en: \"Crop\",\n          fr: \"Récolte\"\n        },\n        sort: {\n          en: \"Sort\",\n          fr: \"Trier\"\n        },\n        sortTotals: {\n          en: \"Sort totals\",\n          fr: \"Trier les totaux\"\n        },\n        sortBars: {\n          en: \"Sort bars\",\n          fr: \"Trier les barres\"\n        },\n        confidenceIntervals: {\n          en: \"Confidence intervals\",\n          fr: \"Intervalles de confiance\"\n        },\n        highlightAez: {\n          en: \"Highlight AEZ\",\n          fr: \"Surligner AEZ\"\n        },\n        highlightPractice: {\n          en: \"Highlight a practice\",\n          fr: \"Surligner une pratique\"\n        }\n      },\n      phrases: {\n        inTotal: {\n          en: \"In total, there are\",\n          fr: \"Au total, il y a\"\n        },\n        specificHas: {\n          en: `**:::item:::** has`,\n          fr: `**:::item:::** a`\n        }\n      },\n      words: {\n        toBe: {\n          singular: {\n            en: \"is\",\n            fr: \"est\"\n          },\n          plural: {\n            en: \"are\",\n            fr: \"sont\"\n          }\n        },\n        and: {\n          en: \"and\",\n          fr: \"et\"\n        },\n        percentage: {\n          singular: {\n            en: \"percentage\",\n            fr: \"pourcentage\"\n          },\n          plural: {\n            en: \"percentages\",\n            fr: \"pourcentages\"\n          }\n        },\n        crop: {\n          singular: {\n            en: \"crop\",\n            fr: \"récolte\"\n          },\n          plural: {\n            en: \"crops\",\n            fr: \"récoltes\"\n          }\n        },\n        country: {\n          singular: {\n            en: \"country\",\n            fr: \"pays\"\n          },\n          plural: {\n            en: \"countries\",\n            fr: \"des pays\"\n          }\n        },\n        region: {\n          singular: {\n            en: \"region\",\n            fr: \"région\"\n          },\n          plural: {\n            en: \"regions\",\n            fr: \"régions\"\n          }\n        },\n        subregion: {\n          singular: {\n            en: \"subregion\",\n            fr: \"sous-région\"\n          },\n          plural: {\n            en: \"subregions\",\n            fr: \"sous-régions\"\n          }\n        },\n        commodity: {\n          singular: {\n            en: \"commodity\",\n            fr: \"produits de base\"\n          },\n          plural: {\n            en: \"commodities\",\n            fr: \"produits\"\n          }\n        },\n        overview: {\n          en: \"overview\",\n          fr: \"vue d’ensemble\"\n        },\n        practice: {\n          singular: {\n            en: \"practice\",\n            fr: \"pratique\"\n          },\n          plural: {\n            en: \"practices\",\n            fr: \"pratiques\"\n          }\n        },\n        observation: {\n          singular: {\n            en: \"observation\",\n            fr: \"observation\"\n          },\n          plural: {\n            en: \"observations\",\n            fr: \"observations\"\n          }\n        },\n        increase: {\n          en: \"increase\",\n          fr: \"augmentation\"\n        },\n        decrease: {\n          en: \"decrease\",\n          fr: \"diminution\"\n        }\n      }\n    },\n    frontMatter: {\n      heroImage: {\n        url: {\n          en: await FileAttachment(\n            \"Evaluate-climate-risks.webp\"\n          ).url(),\n          fr: await FileAttachment(\n            \"Evaluate-climate-risks-fr.webp\"\n          ).url()\n        }\n      }\n    },\n    missingMapDataBlurb: {\n      en: `Grey regions signal lack of :::data_label::: data.`,\n      fr: `Les zones grisées désignent un manque de données reliées à :::data_label:::.`\n    },\n    vopNoteMd: {\n      // note about VoP source for captions\n      caption: {\n        en: `Monetary VoP values are represented in 2005 international dollars.`,\n        fr: `Les valeurs monétaires de la VDP sont représentées en dollars internationaux de 2005.`\n      },\n      // narrative info, with link to wiki\n      blurb: {\n        en: `VoP, 2005 [international dollars](https://en.wikipedia.org/wiki/International_dollar)`,\n        fr: `VDP, en [dollars internationaux](https://en.wikipedia.org/wiki/International_dollar) de 2005`\n      }\n    },\n    overview: {\n      header: {\n        en: \"Overview\",\n        fr: \"Vue d’Ensemble\"\n      },\n      blocks: {\n        opener: {\n          en: \"African agriculture will be tested by climate change. Rising temperatures, unpredictable rainfall, and flooding will disrupt the growth and production of crops and livestock, jeopardizing food security and livelihoods for millions. This notebook aims to empower users to understand the climate risks facing African agriculture, as well as identify the adaptation barriers in terms of education, women's empowerment, and poverty. You can follow the narrative for the continent as a whole, or select individual countries for geography-specific statistics.\",\n          fr: \"L'agriculture africaine sera mise à l'épreuve par le changement climatique. La hausse des températures, l'imprévisibilité des précipitations et les inondations perturberont la croissance et la production des cultures et du bétail, mettant en péril la sécurité alimentaire et les moyens de subsistance de millions de personnes. Ce notebook vise à permettre aux utilisateurs de comprendre les risques climatiques auxquels est confrontée l'agriculture africaine, ainsi que d'identifier les obstacles à l'adaptation en termes d'éducation, d'autonomisation des femmes et de pauvreté. Vous pouvez suivre le récit pour l'ensemble du continent ou sélectionner des pays individuels pour obtenir des statistiques spécifiques à la géographie.\"\n        }\n      }\n    },\n    africaMap: {\n      blocks: {\n        h1: {\n          en: \"What Does Africa Have to Lose?\",\n          fr: \"Qu'est-ce que l'Afrique a à perdre?\"\n        },\n        opener: {\n          en: `African agriculture is valuable, both in terms of food production and farmers. Here you can explore how the value of production (:::vop_blurb:::) and size of the rural population differ between specific countries and regions. This context is important for understanding the unique vulnerabilities facing the agricultural sector on the continent, or for specific geographies of interest.`,\n          fr: `L'agriculture africaine est de valeur, tant en termes de production alimentaire que d'agriculteurs. Ici, vous pouvez explorer comment la valeur de la production (:::vop_blurb:::) et la taille de la population rurale diffèrent entre des pays et des régions spécifiques. Ce contexte est important pour comprendre les vulnérabilités uniques auxquelles est confronté le secteur agricole sur le continent, ou pour des zones géographiques spécifiques.`\n        }\n      },\n      inputs: {\n        mapLayer: {\n          label: {\n            en: \"Map layer\",\n            fr: \"Couche cartographique\"\n          },\n          options: {\n            ruralPop: {\n              label: {\n                en: \"Rural population\",\n                fr: \"Population rurale\"\n              },\n              labelTip: {\n                en: \"Rural population\",\n                fr: \"Population rurale\"\n              },\n              labelLegend: {\n                en: \"Rural population\",\n                fr: \"Population rurale\"\n              }\n            },\n            vop: {\n              label: {\n                en: \"Total Value of Production (VoP)\",\n                fr: \"Valeur totale de la production (VDP)\"\n              },\n              labelTip: {\n                en: \"VoP\",\n                fr: \"VDP\"\n              },\n              labelLegend: {\n                en: `Value of Production (:::unit:::)`,\n                fr: `Valeur de la production (:::unit:::)`\n              }\n            }\n          }\n        }\n      },\n      insights: {\n        title: {\n          en: `:::insight_string::: for :::admin_selection:::`,\n          fr: `:::insight_string::: pour :::admin_selection:::`\n        },\n        insightOverview: {\n          en: `**:::admin_selection:::**'s total value of crop and livestock production is **:::total_vop:::**.`,\n          fr: `La valeur totale de production végétale et animale **:::admin_selection:::** est de **:::total_vop:::**.`\n        },\n        insightAreaAndPop: {\n          en: `Its crops are produced over an area of **:::area:::** hectares, with rural areas encompassing a population of **:::population:::** people.`,\n          fr: `Ses cultures sont produites sur une superficie de **:::area:::** hectares, avec ses zones rurales abritant une population de **:::population:::** personnes.`\n        },\n        insightTopCommodity: {\n          en: `The top :::commodity_word::: by value: :::list_string:::.`,\n          fr: `Les principaux produits de base, en termes de valeur: :::list_string:::.`\n        },\n        insightTopLivestock: {\n          en: `The top livestock species in terms of population: :::list_string:::.`,\n          fr: `Les principales espèces animales en termes de population: :::list_string:::.`\n        }\n      }\n    },\n    climateRisks: {\n      intro: {\n        h1: {\n          en: \"Climate Risks\",\n          fr: \"Risques Climatiques\"\n        },\n        opener: {\n          en: `In **:::admin_selection:::**, climate change can impact crops and livestock in diverse ways. The specific risks can vary not only by region but also by the type of crop or livestock. Use the interactive features below to select specific locations and climate change scenarios. This will help you understand the unique hazards each faces and identify the most economically important crops and livestock that are exposed to hazards.`,\n          fr: `**:::admin_selection:::**, le changement climatique peut avoir des répercussions diverses sur les cultures et le bétail. Les risques spécifiques peuvent varier non seulement en fonction de la région, mais aussi du type de culture ou d'élevage. Utilisez les fonctions interactives ci-dessous pour sélectionner des lieux spécifiques et des scénarios de changement climatique. Cela vous aidera à comprendre les aléas spécifiques auxquels chacun est confronté et à identifier les cultures et les élevages les plus importants sur le plan économique qui sont exposés à ces aléas.`\n        }\n      },\n      compoundHazards: {\n        h2: {\n          en: \"Compound Hazards\",\n          fr: \"Risques Exacerbés\"\n        },\n        opener: {\n          en: `Understand the value of production (:::vop_note:::) at risk from across different hazards alone and in combination. Hover over the bars in the chart below to explore the proportions of agricultural value in **:::admin_selection:::** that will be exposed to different hazard combinations.`,\n          fr: `Comprenez la valeur de la production (:::vop_note:::) menacée par les différents aléas, seuls ou combinés. Survolez les barres du graphique ci-dessous pour découvrir la proportion de la valeur agricole en **:::admin_selection:::** qui sera exposée à différentes combinaisons de risques.`\n        },\n        inputs: {\n          dropdownScenario: {\n            label: {\n              en: \"Scenario\",\n              fr: \"Scénario\"\n            },\n            historic: {\n              en: \"Historic\",\n              fr: \"Historique\"\n            }\n          }\n        },\n        stackedBar: {\n          xLabel: {\n            en: \"Total VoP (%)\",\n            fr: \"VDP Total (%)\"\n          },\n          tooltipLabels: {\n            vopRisk: {\n              en: \"VoP at risk from hazard\",\n              fr: \"VDP en danger à cause d’un risque\"\n            },\n            hazard: {\n              en: \"Hazard\",\n              fr: \"Danger\"\n            },\n            totalVop: {\n              en: \"Total VoP at risk\",\n              fr: \"VDP Total en danger\"\n            }\n          }\n        }\n      },\n      hazardImpact: {\n        // define by data field values\n        hazards: {\n          wet: { en: \"Wet alone\", fr: \"Humide\" },\n          dry: { en: \"Dry alone\", fr: \"Sec\" },\n          heat: { en: \"Heat alone\", fr: \"Chaud\" },\n          dry_heat: { en: \"Dry and heat\", fr: \"Sec et Chaud\" },\n          dry_wet: { en: \"Dry and wet\", fr: \"Sec et Humide\" },\n          heat_wet: { en: \"Heat and wet\", fr: \"Chaud et Humide\" },\n          dry_heat_wet: {\n            en: \"Heat, wet, and dry\",\n            fr: \"Chaud, Humide, et Sec\"\n          },\n          no_hazard: { en: \"No hazard\", fr: \"Aucun danger\" }\n        },\n        h1: {\n          en: \"Hazards with the Most Exposure\",\n          fr: \"Aléas présentant la plus forte exposition\"\n        },\n        intro: {\n          en: \"Select different hazard combinations and see which crops and livestock have the most VoP at risk.\",\n          fr: \"Sélectionnez différentes combinaisons de risques et voyez quelles cultures et quels animaux sont les plus menacés.\"\n        },\n        inputs: {\n          dropdownHazard: {\n            label: {\n              en: \"Hazard\",\n              fr: \"Danger\"\n            }\n          }\n        },\n        plots: {\n          general: {\n            noPlotMessage: {\n              en: \"No VoP exposure\",\n              fr: \"Aucune exposition VoP\"\n            },\n            vopLabel: {\n              en: \"VoP at risk\",\n              fr: \"VDP à risque\"\n            }\n          },\n          crops: {\n            header: {\n              en: `Crops most at exposed under :::hazard_string:::`,\n              fr: `Les cultures les plus exposés à :::hazard_string:::`\n            }\n          },\n          livestock: {\n            header: {\n              en: `Livestock most at exposed under :::hazard_string:::`,\n              fr: `Les bétails le plus exposés à :::hazard_string:::`\n            }\n          }\n        },\n        insights: {\n          title: {\n            en: `:::insight_string::: for :::admin_selection::: (:::scenario:::)`,\n            fr: `:::insight_string::: pour :::admin_selection::: (:::scenario:::)`\n          },\n          hazardBlurb: {\n            en: `For hazard: **:::hazard_string:::**`,\n            fr: `Pour le risque: **:::hazard_string:::**`\n          },\n          labels: {\n            totalVopCrop: {\n              en: \"Total Exposed VoP, Crop\",\n              fr: \"Valeur Totale de la Production À Risque, Culture\"\n            },\n            totalVopLivestock: {\n              en: \"Total Exposed VoP, Livestock\",\n              fr: \"Valeur Totale de la Production À Risque, Bétail\"\n            },\n            exposureCrop: {\n              en: \"Crop, greatest exposure\",\n              fr: \"Culture, plus à risque\"\n            },\n            exposureLivestock: {\n              en: \"Livestock, greatest exposure\",\n              fr: \"Bétail, plus à risque:\"\n            }\n          },\n          blurbBiggestHazard: {\n            en: \"The biggest hazards for selection and scenario/timeframe are:\",\n            fr: \"Les risques les plus importants pour la sélection et scénario/période sont les suivants:\"\n          }\n        }\n      }\n    },\n    adaptiveCapacities: {\n      h1: {\n        en: \"Adaptive Capacities\",\n        fr: \"Capacités Adaptatives\"\n      },\n      intro: {\n        en: `Farmers ability to adapt to climate change in **:::admin_selection:::** hinges on several key socio-economic factors. These include poverty, education, and gender inequality, which significantly influence their vulnerability and their capacity to respond effectively. Explore the map and indexes below to gain a deeper understanding of the geographic distribution of these variables across the region. Each of the three indexes are scored between 0 and 100. For the poverty index, lower values indicate lower levels of poverty. For Education and Female Empowerment, a higher score indicates increased levels of educational attainment and female decision making power.`,\n        fr: `La capacité des agriculteurs **:::admin_selection:::** à s'adapter au changement climatique dépend de plusieurs facteurs socio-économiques clés. Il s'agit notamment de la pauvreté, de l'éducation et de l'inégalité entre les genres, qui influencent considérablement leur vulnérabilité et leur capacité à réagir efficacement. La carte et les indices ci-dessous permettent de mieux comprendre la répartition géographique de ces variables dans la région. Chacun des trois indices est noté entre 0 et 100. Pour l'indice de pauvreté, des valeurs plus faibles indiquent des niveaux de pauvreté moins élevés. Pour l'indice d'éducation et d'autonomisation des femmes, un score plus élevé indique des niveaux d'éducation plus élevés et un pouvoir de décision plus important pour les femmes.`\n      },\n      inputs: {\n        mapLayer: {\n          label: {\n            en: \"Map layer\",\n            fr: \"Couche de carte\"\n          },\n          options: {\n            general: {\n              labels: {\n                population: {\n                  en: \"Population\",\n                  fr: \"Population\"\n                }\n              }\n            },\n            pov: {\n              label: {\n                en: \"Poverty Rate\",\n                fr: \"Taux de pauvreté\"\n              },\n              labelLegend: {\n                en: \"Poverty Rate (% of population under $3.65 per day)\",\n                fr: \"Taux de pauvreté (% de la population vivant avec moins de 3,65 $ par jour)\"\n              }\n            },\n            edu: {\n              label: {\n                en: \"Education Attainment\",\n                fr: \"Niveau d'éducation\"\n              },\n              labelLegend: {\n                en: \"Education Attainment (Years of schooling)\",\n                fr: \"Niveau d'éducation (années de scolarité)\"\n              }\n            },\n            fem: {\n              label: {\n                en: \"Female empowerment index\",\n                fr: \"Indicateur d’autonomisation des femmes\"\n              },\n              labelLegend: {\n                en: \"Female empowerment index (higher is better)\",\n                fr: \"Indicateur d’autonomisation des femmes (plus c’est élevé, mieux c’est)\"\n              }\n            }\n          }\n        }\n      },\n      insights: {\n        title: {\n          en: `:::insight_string::: for :::admin_selection:::`,\n          fr: `:::insight_string::: pour :::admin_selection:::`\n        },\n        madLib: {\n          en: `**:::admin:::**: the education index is **:::index_edu:::**, the female empowerment index is **:::index_fem:::**, and the poverty index is **:::index_pov:::**.`,\n          fr: `**:::admin:::**: l’indice d'éducation est de **:::index_edu:::**,  l’index d’autonomisation des femmes et de **:::index_fem:::** et l’indice de pauvreté est de **:::index_pov:::**.`\n        },\n        nestedLocationBlurb: {\n          en: `**:::admin_inner:::** is located within **:::admin_outer:::**.`,\n          fr: `**:::admin_inner:::** est situé dans **:::admin_outer:::**.`\n        }\n      },\n      delvingDeeper: {\n        h2: {\n          en: \"Delving Deeper\",\n          fr: \"Approfondir\"\n        },\n        intro: {\n          en: \"By analyzing overlays of poverty levels, education attainment, and female empowerment, you can gain additional insights into the diverse challenges and opportunities faced by communities. This deeper understanding of barriers to adaptation can help you to identify the localized context in which climate risk needs to be addressed.\",\n          fr: \"En analysant les superpositions des niveaux de pauvreté, du niveau d'éducation et de l'autonomisation des femmes, vous pouvez obtenir des informations supplémentaires sur les divers défis et opportunités auxquels sont confrontées les communautés. Cette meilleure compréhension des obstacles à l'adaptation peut vous aider à identifier le contexte local dans lequel les risques climatiques doivent être abordés.\"\n        },\n        plot: {\n          legend: {\n            domain: {\n              en: [\"Better\", \"Moderate\", \"Worse\"],\n              fr: [\"Meilleur\", \"Moyen\", \"Pire\"]\n            }\n          },\n          nameMap: {\n            population: {\n              en: \"Total Population\",\n              fr: \"Population Totale\"\n            },\n            poverty0: {\n              en: \"Low Poverty\",\n              fr: \"Faible Niveau de Pauvreté\"\n            },\n            poverty1: {\n              en: \"Moderate Poverty\",\n              fr: \"Moyen Niveau de Pauvreté\"\n            },\n            poverty2: {\n              en: \"High Poverty\",\n              fr: \"Haut Niveau de Pauvreté\"\n            },\n            education0: {\n              en: \"0-1 Years of Education\",\n              fr: \"0-1 ans d'éducation\"\n            },\n            education1: {\n              en: \"1-5 Years of Education\",\n              fr: \"1-5 ans d'éducation\"\n            },\n            education2: {\n              en: \"5+ Years of Education\",\n              fr: \"5+ ans d'éducation\"\n            },\n            gender0: {\n              en: \"Low Female Empowerment\",\n              fr: \"Faible Autonomisation des Femmes\"\n            },\n            gender1: {\n              en: \"Moderate Female Empowerment\",\n              fr: \"Moyenne Autonomisation des Femmes\"\n            },\n            gender2: {\n              en: \"High Female Empowerment\",\n              fr: \"Haute Autonomisation des Femmes\"\n            }\n          }\n        }\n      }\n    },\n    summary: {\n      h1: {\n        en: \"Summary\",\n        fr: \"Résumé\"\n      },\n      blocks: {\n        dynamicSummary: {\n          intro: {\n            en: `The people of **:::admin0:::** need to be ready with strategies to make crops and livestock more resilient to combat the changing climate.`,\n            fr: `Les habitants **:::admin0:::** doivent être prêts à mettre en place des stratégies visant à rendre les cultures et le bétail plus résistants pour lutter contre le changement climatique.`\n          }\n        },\n        closer: {\n          en: \"This work aims to enhance crop variety and livestocks breed, reduce emissions, promote sustainable land management, and educate and train populations on climate-smart agriculture practices.\",\n          fr: \"Ces travaux visent à améliorer la variété des cultures et la race des animaux, à réduire les émissions, à promouvoir la gestion durable des terres et à éduquer et former les populations aux pratiques agricoles intelligentes face au climat.\"\n        }\n      },\n      dynamicSummarylist: {\n        en: `A range of strategies and policies can be implemented in support of researching and addressing the impact of climate change on agriculture, including:\n\n:::markdownList:::`,\n        fr: `Une série de stratégies et de politiques peuvent être mises en œuvre pour soutenir la recherche et la prise en compte de l'impact du changement climatique sur l'agriculture:\n\n:::markdownList:::`\n      }\n    },\n    methods: {\n      h1: {\n        en: \"Methods & Sources\",\n        fr: \"Méthodes & Sources\"\n      },\n      section1: {\n        en: \"Datasets\",\n        fr: \"Ensembles de Données\",\n        subsections: {\n          en: `### Exposure (Value of Production)\n- **[Crop value of production](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/exposure_catalog/mapspam2017/mapspam2017_vop_parquet/mapspam2017_vop_parquet.json)** data comes from  MapSPAM 2017 V2r3 (Spatial Production Allocation Model) where production values are multiplied by country specific FAOstat international crop prices in (2005 International Dollars).\nAn [international dollar](https://en.wikipedia.org/wiki/International_dollar) (2005) is a hypothetical unit of currency that has the same purchasing power parity as the U.S. dollar had in the United States in 2005, allowing for comparison of what consumers can buy in different countries with the same amount of money.\nThis dataset is an updated version of MapSPAM specifically tailored for this project. It includes bug fixes and incorporates country-specific values of production instead of global averages.\n- **[Livestock value of production](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/exposure_catalog/GLW3_livestock/GLW3_livestock_vopPQ/GLW3_livestock_vopPQ.json)** in 2005 International Dollars were provided by the authors of [Herrero et al. (2013)](https://www.pnas.org/doi/full/10.1073/pnas.1308149110/).\n\n### Adaptive Capacities\n- **[Population](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/population/worldpop_2020/pop_2020_parquet/pop_2020_parquet.json)** data is from the [WorldPop Unconstrained Global Mosaic](https://hub.worldpop.org/geodata/listing?id=64) for 2020.\n- **[Poverty](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/adaptive-capacity/poverty/grdi/grdi_historical_2010-2020/grdi_historical_2010-2020.json)** data is from the [Global Gridded Deprivation Index](https://sedac.ciesin.columbia.edu/data/set/povmap-grdi-v1).\n-  **[Education](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/adaptive-capacity/education_catalog/catalog.json)** data for the icicle plot is the mean male and female educational attainment from the [2005-2015 IHME Estimates for ages 15-49](https://ghdx.healthdata.org/record/ihme-data/africa-educational-attainment-geospatial-estimates-2000-2015). The education rate combines educational attainment with expected years of schooling in a [composite index as part of the Sub-national HDI](https://globaldatalab.org/shdi/metadata/edindex/).\n- **[Female Empowerment](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/adaptive-capacity/women-and-gender/female-empowerment/GenderEquity_1995-2015/GenderEquity_1995-2015.json)** is a composite index of  domestic violence, employment, reproductive healthcare, decision making power, and family planning. The index is from [Rettig, Erica (2022)](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/8GJKYW) and based on input data from the [DHS Program](https://dhsprogram.com).\n\n### Boundaries\n[Administrative areas](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/boundary_catalog/geoBoundaries_SSA/collection.json) used in this notebook come from [geoBoundaries 6.0.0](https://github.com/wmgeolab/geoBoundaries). The gbHumanitarian boundaries are used and if not available then the gbOpen boundaries are substituted.\n\n### Climate Hazards & Risk\n[Climate hazards](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/hazard_catalog/catalog.json) were calculated using five datasets [CHIRPS](https://www.chc.ucsb.edu/data/chirps)/[CHIRTS](https://www.chc.ucsb.edu/data/chirtsdaily), [AgERA5](https://doi.org/10.24381/cds.6c68c9bb), [CMIP6 projections](https://github.com/SantanderMetGroup/ATLAS), and [crop calendars](https://zenodo.org/records/5062513). Using the R workflows mentioned below, raw hazard data were converted to risk, intersected with exposure and extracted by administrative boundaries to generate tabular data in parquet form, for example [severe_adm_int.parquet](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/hazard_catalog/hazard_risk_vop_annual/annual_digital-atlas/hazards/hazard_risk_vop/annual/severe_adm_int.parquet/annual_digital-atlas/hazards/hazard_risk_vop/annual/severe_adm_int.parquet.json).`,\n\n          fr: `### Exposition au Risques (Valeur de Production)\n- **[Les données sur la valeur de la production des cultures](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/exposure_catalog/mapspam2017/mapspam2017_vop_parquet/mapspam2017_vop_parquet.json)** proviennent de MapSPAM 2017 V2r3 (Modèle d'Allocation de Production Spatiale) où les valeurs de production sont multipliées par les prix internationaux des cultures de la FAOstat spécifiques à chaque pays en (dollars internationaux de 2005). Un [dollar international](https://en.wikipedia.org/wiki/International_dollar) (2005) est une unité monétaire hypothétique qui a la même parité de pouvoir d'achat que le dollar américain aux États-Unis en 2005, ce qui permet de comparer ce que les consommateurs peuvent acheter dans différents pays avec la même somme d'argent. Cet ensemble de données est une version mise à jour de MapSPAM spécialement conçue pour ce projet. Il comprend des corrections de bogues et incorpore des valeurs de production spécifiques à chaque pays au lieu de moyennes mondiales.\n- **[La valeur de la production animale](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/exposure_catalog/GLW3_livestock/GLW3_livestock_vopPQ/GLW3_livestock_vopPQ.json)** en dollars internationaux de 2005 a été fournie par les auteurs de [Herrero et al. (2013)](https://www.pnas.org/doi/full/10.1073/pnas.1308149110/).\n\n### Capacités Adaptatives\n- **[Les données démographiques proviennent](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/population/worldpop_2020/pop_2020_parquet/pop_2020_parquet.json)** [WorldPop Unconstrained Global Mosaic](https://hub.worldpop.org/geodata/listing?id=64) pour 2020.\n- **[Les données de pauvreté](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/adaptive-capacity/poverty/grdi/grdi_historical_2010-2020/grdi_historical_2010-2020.json)** proviennent du [Global Gridded Deprivation Index](https://sedac.ciesin.columbia.edu/data/set/povmap-grdi-v1).\n- **[Les données sur l'éducation](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/adaptive-capacity/education_catalog/catalog.json)** pour le dendrogramme sont le niveau d'éducation moyen des hommes et des femmes selon les [estimations de l'IHME 2005-2015 pour les 15-49 ans](https://ghdx.healthdata.org/record/ihme-data/africa-educational-attainment-geospatial-estimates-2000-2015). Le taux d'éducation combine le niveau d'éducation et le nombre d'années de scolarisation prévues dans [un indice composite dans le cadre de l'IDH sous-national.](https://globaldatalab.org/shdi/metadata/edindex/).\n- **[L'autonomisation des femmes](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/adaptive-capacity/women-and-gender/female-empowerment/GenderEquity_1995-2015/GenderEquity_1995-2015.json)** est un indice composite de la violence domestique, de l'emploi, des soins de santé reproductive, du pouvoir de décision et de la planification familiale. L'indice est tiré de [Rettig, Erica (2022)](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/8GJKYW) et basé sur les données du [programme DHS](https://dhsprogram.com).\n\n### Délimitations\nLes [zones administratives](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/boundary_catalog/geoBoundaries_SSA/collection.json) utilisées dans ce notebook proviennent de [geoBoundaries 6.0.0](https://github.com/wmgeolab/geoBoundaries). Les frontières gbHumanitarian sont utilisées et, si elles ne sont pas disponibles, les frontières gbOpen sont substituées.\n\n### Risques & Dangers Climatiques\nLes [risques climatiques](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/hazard_catalog/catalog.json) ont été calculés à l'aide de cinq ensembles de données: [CHIRPS](https://www.chc.ucsb.edu/data/chirps)/[CHIRTS](https://www.chc.ucsb.edu/data/chirtsdaily), [AgERA5](https://doi.org/10.24381/cds.6c68c9bb), [projections CMIP6](https://github.com/SantanderMetGroup/ATLAS), et [calendriers des cultures](https://zenodo.org/records/5062513). À l'aide des flux de travail R mentionnés ci-dessous, les données brutes sur les aléas ont été converties en risques, recoupées avec l'exposition et extraites par les limites administratives pour générer des données tabulaires sous forme de parquet, par exemple [severe_adm_int.parquet](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/hazard_catalog/hazard_risk_vop_annual/annual_digital-atlas/hazards/hazard_risk_vop/annual/severe_adm_int.parquet/annual_digital-atlas/hazards/hazard_risk_vop/annual/severe_adm_int.parquet.json).`\n        }\n      },\n      section2: {\n        en: \"Methods\",\n        fr: \"Méthodologie\",\n        subsections: {\n          en: `### Climate Hazard Risk\n\nA detailed and replicable R workflow for generating raw climate hazards data is available at the [AdaptationAtlas/Hazards](https://github.com/AdaptationAtlas/hazards).\n\nThe transformation of raw climate hazards into generic and crop-specific hazard risks was achieved using a separate, but equally replicable, R workflow, which can be found in the GitHub project [atlas/hazards_prototype](https://github.com/AdaptationAtlas/hazards_prototype). \n\nThe process for calculating risk comprises several critical steps:\n\n1. **Annual or Seasonal Summarization**: Raw hazard data is aligned with the [GGCMI Phase 3 crop calendar for maize](https://zenodo.org/records/5062513), then climate hazards are summarized at either annual or seasonal timescales. Future updates of the Atlas will incorporate crop-specific calendars.\n\n2. **Occurrence**: For each season or year in a time series, we classify the risk of hazard occurrence (present/absent) across three severity levels (moderate, severe, extreme). Note, hazard severity is fixed to “severe” in this notebook.\n   \n  The specific hazards used in this analysis are: \n  \n  - **Dry** = number of soil water stress days [NDWS](https://github.com/AdaptationAtlas/hazards/wiki/Hazards-definitions). Severe risk = NDWS &gt; 20 days (same across all crops and livestock).\n  - **Heat (crops)** = days where maximum temperature &gt; 35ºC [NTx35](https://github.com/AdaptationAtlas/hazards/wiki/Hazards-definitions). Severe risk = NTx35 &gt; 20 days (same across all crops).\n  - **Heat (livestock)** = thermal humidity index [THI](https://github.com/AdaptationAtlas/hazards/wiki/Hazards-definitions). Severe risk is livestock class specific, see Table 2 of [Thorton et al. 2021](https://doi.org/10.1111/gcb.15825).\n  - **Wet** = number of waterlogging days [NDWL0](https://github.com/AdaptationAtlas/hazards/wiki/Hazards-definitions).  Severe risk = NDWL0 &gt; 5 days (same across all crops and livestock).\n    \n  More details on hazard definitions and thresholds for severity classes can found in the atlas/hazards wiki. Future 2024 updates of the Atlas will add crop specific maximum temperature thresholds and a notebook will be created to allow users to explore hazard risks in more detail.\n\n3. **Risk**: We average the classified hazards over the years or seasons encompassed by the time-series to obtain an estimation of occurrence risk. \n\n4. **Compound Risks**: To assess the risk of compound hazards, we multiply the risks associated with dry, heat, and wet conditions. This multiplication highlights areas where multiple hazards may coincide, posing greater risk to agricultural outputs.\n\n5. **Integration with Economic Data**: Finally, we multiply the compound crop hazard risk data with crop value of production data. For example, if a crop is exposed to a hazard in 50% of growing seasons and the value of production is $2M/year then, on average, $1M of production is exposed to the hazard.  The exposed value of production is then extracted by administrative areas to indicate potential economic impacts on crop production.\n\n### Adaptive Capacity\nTo calculate the population distribution according to adaptive capacity variables, we followed these steps:\n\n1. **Data Classification**: We categorized the variables—poverty rates, Female Empowerment Index, and educational attainment—into three classes each. The classification of the Female Empowerment Index and poverty was based on the tertile distribution of the dataset. For educational attainment, we grouped the data into three categories: 0-1 years of education, 1-5 years of education, and over 5 years of education.\n\n2. **Spatial Intersection**: Next, we spatially overlaid these classified variables with population data. This step identified the specific combination of variable classes for each population segment.\n\n3. **Spatial Extraction**: We then extracted this overlaid data by administrative boundaries. This allowed us to quantify the population within each area, falling into each adaptive capacity category.\n\nThrough this methodology, we generated a comprehensive dataset illustrating the distribution of the population by the three elements, encompassing every combination within each administrative region.`,\n\n          fr: `### Risques Climatiques\n\nUn flux de travail R détaillé et reproductible pour générer des données brutes sur les aléas climatiques est disponible sur [AdaptationAtlas/Hazards](https://github.com/AdaptationAtlas/hazards).\n\nLa transformation des aléas climatiques bruts en risques génériques et spécifiques aux cultures a été réalisée à l'aide d'un flux de travail R distinct, mais également reproductible, qui peut être trouvé dans le projet GitHub [atlas/hazards_prototype](https://github.com/AdaptationAtlas/hazards_prototype). \n\nLe processus de calcul des risques comprend plusieurs étapes critiques:\n\n1. **Synthèse annuelle ou saisonnière**: Les données brutes sur les risques sont alignées sur le [calendrier des cultures de la phase 3 de GGCMI pour le maïs](https://zenodo.org/records/5062513), puis les risques climatiques sont résumés à l'échelle annuelle ou saisonnière. Les futures mises à jour de l'atlas intégreront des calendriers spécifiques aux cultures.\n\n2. **Occurrence**: Pour chaque saison ou année d'une série temporelle, nous classons le risque d'occurrence de l'aléa (présent/absent) selon trois niveaux de gravité (modéré, grave, extrême). Dans ce *notebook*, la gravité des aléas est fixée à \"grave\".\n   \n  Les risques spécifiques utilisés dans cette analyse sont les suivants: \n  \n  - **Sec** = nombre de jours de stress hydrique du sol [NDWS](https://github.com/AdaptationAtlas/hazards/wiki/Hazards-definitions). Risque grave = NDWS &gt; 20 jours (identique pour toutes les cultures et le bétail).\n  - **Chaleur (cultures)** = jours où la température maximale est &gt; 35ºC [NTx35](https://github.com/AdaptationAtlas/hazards/wiki/Hazards-definitions). Risque grave = NTx35 &gt; 20 jours (identique pour toutes les cultures).\n  - **Chaleur (bétail)** = indice d'humidité thermique [THI](https://github.com/AdaptationAtlas/hazards/wiki/Hazards-definitions). Le risque grave est spécifique à la classe de bétail, voir le tableau 2 de [Thorton et al. 2021](https://doi.org/10.1111/gcb.15825).\n  - **Humidité** = nombre de jours d'engorgement [NDWL0](https://github.com/AdaptationAtlas/hazards/wiki/Hazards-definitions).  Risque grave = NDWL0 &gt; 5 jours (identique pour toutes les cultures et le bétail).\n    \n  Pour plus de détails sur les définitions des risques et les seuils des classes de gravité, voir le wiki atlas/risques. Les futures mises à jour de l'atlas en 2024 ajouteront des seuils de température maximale spécifiques aux cultures et un *notebook* sera créé pour permettre aux utilisateurs d'explorer les risques de manière plus détaillée.\n\n3. **Risque**: Nous faisons la moyenne des aléas classés sur les années ou les saisons concernées par la série chronologique afin d'obtenir une estimation du risque d'occurrence. \n\n4. **Risques Composés**: Pour évaluer les risques composés, nous multiplions les risques associés aux conditions de sécheresse, de chaleur et d'humidité. Cette multiplication met en évidence les zones où des risques multiples peuvent coïncider, ce qui représente un risque plus important pour la production agricole.\n\n5. **Intégration avec les Données Économiques**: Enfin, nous multiplions les données sur les risques composés pour les cultures par les données sur la valeur de la production des cultures. Par exemple, si une culture est exposée à un danger pendant 50 % des saisons de croissance et que la valeur de la production est de 2 millions de dollars par an, alors, en moyenne, 1 million de dollars de la production est exposée au danger. La valeur de la production exposée est ensuite extraite par zone administrative pour indiquer les impacts économiques potentiels sur la production agricole.\n\n### Capacité d’Adaptation\nPour calculer la répartition de la population en fonction des variables de la capacité d'adaptation, nous avons suivi les étapes suivantes:\n\n1. **Classification des Données**: Nous avons classé les variables - taux de pauvreté, indice d'autonomisation des femmes et niveau d'instruction - en trois classes chacune. La classification de l'indice d'émancipation des femmes et de la pauvreté était basée sur la distribution par tertile de l'ensemble des données. Pour le niveau d'éducation, nous avons regroupé les données en trois catégories : 0-1 année d'éducation, 1-5 années d'éducation et plus de 5 années d'éducation.\n\n2. **Intersection Spatiale**: Ensuite, nous avons superposé dans l'espace ces variables classées avec les données démographiques. Cette étape a permis d'identifier la combinaison spécifique de classes de variables pour chaque segment de population.\n\n3. **Extraction Spatiale**: Nous avons ensuite extrait ces données superposées en fonction des limites administratives. Cela nous a permis de quantifier la population dans chaque zone, tombant dans chaque catégorie de capacité d'adaptation.\n\nGrâce à cette méthodologie, nous avons généré un ensemble de données complet illustrant la répartition de la population en fonction des trois éléments, englobant toutes les combinaisons au sein de chaque région administrative.`\n        }\n      }\n    }\n  };\n}\n\n\n\n\n\n\n\n// data translation values\ntd = {\n  let data = await FileAttachment(\"abAtlas-td-translation-data-v3.json\").json()\n\n  // // update SSA default\n  // data.admin0_name.values.SSA.en = \"Sub-Saharan Africa\"\n  // // cote d'ivoire, comma version duplicate\n  // data.admin0_name.values[\"Côte d’Ivoire\"] = data.admin0_name.values[\"Côte d'Ivoire\"]\n  \n  return data\n}\n\n\n\n\n\n\n\nmd`---\n### Notebook Styling\n*styling helpers*\nStylesheet is a named cell, which is necessary to include for embeds.`;\n\n\n\n\n\n\n\nmd`**Color Scales**`;\n\n\n\n\n\n\n\n// color scale info\ncolorScales = {\n  return {\n    range: {\n      green: ['#E4F5D0', '#015023'],\n      blue: ['#E8F2FF', '#003E6B'],\n      brown: ['#FFFDE5', '#A87B00'],\n      yellowGreen: ['#F7D732', '#216729'],\n      orangeRed: ['#F4BB21', '#EC5A47'],\n    },\n    unknown: \"#ccc\"\n  }\n}\n\n\n\n\n\n\n\nmd`---\n### Admin Selection\n*Global admin selector using dropdowns*\n\nThis is the global selector for the selected region\n- The completed data is contained within adminSelections to be used in queries\n- Dropdowns are defined below then bound for each section\n  - Defined as separate cells since they dynamically respond to different values\n    - In narrative, they are simply views of the data  \n  - Dropdowns are dynamic based on higher-level choices\n  - Options are defined from the geographic data\n  - null value means unselected region\n- Dropdowns are added to each section, using Inputs.bind to create synchronized inputs (see viewof for input definitions). A form input is used to consolidate and apply a template to format.`;\n\n\n\n\n\n\n\n// get admin0 options from geo\ndataAdmin0 = {\n  const data = admin0.features.map((d) =&gt; d.properties);\n  // add a blank value\n  return [null, ...data.map((d) =&gt; d.admin_name)].map((d) =&gt; {\n    return {\n      label:\n        d == null ? globalSelection.label : _lang(td.admin0_name.values?.[d].general),\n      value: d\n    };\n  });\n}\n\n\n\n\n\n\n\n// get admin1 options based on admin0 selection\n// (the admin1 regions within selected admin0)\ndataAdmin1 = {\n  // admin 1, filter by 0 \n  // const data = boundaries.admin1.features.map(d =&gt; d.properties)\n  // .filter(d =&gt; d.admin0_name == selectAdmin0.value)\n  const data = await geo_db.query(`SELECT DISTINCT admin1_name FROM admin1_geom WHERE admin0_name = '${selectAdmin0.value}'`)\n  // add blank value\n  const allLabel = {\n    label: adminRegions.allLabels.admin1,\n    value: null\n  }\n  return [allLabel, ...data.map(d =&gt; {\n    return {\n      label: d.admin1_name,\n      value: d.admin1_name,\n    }\n  })].map(d =&gt; {\n    return {label: d.label, value: d.value}\n  })\n}\n\n\n\n\n\n\n\n// get admin2 options based on admin1 selection\n// (the admin2 regions within selected admin1)\ndataAdmin2 = {\n  // const data = boundaries.admin2.features.map(d =&gt; d.properties)\n  // .filter(d =&gt; d.admin0_name == selectAdmin0.value && d.admin1_name == selectAdmin1.value)\n  const data = await geo_db.query(`SELECT DISTINCT admin2_name FROM admin2_geom WHERE admin0_name = '${selectAdmin0.value}' AND admin1_name = '${cleanAdminInput_SQL(selectAdmin1.value)}'`)\n  // add blank value\n  const allLabel = {\n    label: adminRegions.allLabels.admin2,\n    value: null\n  }\n  return [allLabel, ...data.map(d =&gt; {\n    return {\n      label: d.admin2_name,\n      value: d.admin2_name,\n    }\n  })].map(d =&gt; {\n    return {label: d.label, value: d.value}\n  })\n}\n\n\n\n\n\n\n\nviewof selectAdmin0 = Inputs.select(dataAdmin0, {label: adminRegions.labels.admin0, format: x =&gt; x.label})\n\n\n\n\n\n\n\nviewof selectAdmin1 = Inputs.select(dataAdmin1, {label: adminRegions.labels.admin1, format: x =&gt; x.label})\n\n\n\n\n\n\n\nviewof selectAdmin2 = Inputs.select(dataAdmin2, {label: adminRegions.labels.admin2, format: x =&gt; x.label})\n\n\n\n\n\n\n\n// selected admin regions from dropdowns\nadminSelections = new Object({\n  selectAdmin0: selectAdmin0,\n  selectAdmin1: selectAdmin1,\n  selectAdmin2: selectAdmin2,\n});\n\n\n\n\n\n\n\n// template to format admin selection form\nadminFormTemplate = (inputs) =&gt;\n  htl.html`&lt;div style=\"display: flex; gap: 3em\"&gt;${inputs}&lt;/div&gt;`;\n\n\n\n\n\n\n\ngetAdminSelectionLabelWithParen = ({\n  selections = adminSelections,\n  admin0Label,\n  adminSublabel,\n} = {}) =&gt; {\n  // return admin0 selection and admin1/admin2 selection if chosen (in parentheses)\n  if (selections.selectAdmin1.value === null) {\n    return admin0Label;\n  } else {\n    return `${admin0Label} (${adminSublabel})`;\n  }\n};\n\n\n\n\n\n\n\nmd`---\n### Admin Selection - Display\n*Showing admin selections*`;\n\n\n\n\n\n\n\n// options for the global admin selection\n// used when no admin selection is made\nglobalSelection = {\n  return {\n    label: _lang(td.admin0_name.values.SSA.general),\n    value: null\n  }\n}\n\n\n\n\n\n\n\nfunction getAdminSelection(selections = adminSelections) {\n  // get the most granular admin selection made\n  const a0 = selections.selectAdmin0;\n  const a1 = selections.selectAdmin1;\n  const a2 = selections.selectAdmin2;\n  const global = globalSelection;\n\n  return a2.value ? a2 : a1.value ? a1 : a0.value ? a0 : global;\n}\n\n\n\n\n\n\n\nfunction getAdminSelectionAdmin0(selections = adminSelections) {\n  // get the selected admin0 or global value\n  const a0 = selections.selectAdmin0;\n  const global = globalSelection.label;\n\n  return a0 ? a0 : global;\n}\n\n\n\n\n\n\n\nfunction getAdminSelectionMarkdownPath(selections = adminSelections) {\n  // function to show selected admin region\n  // return path showing nested admin selection\n\n  const delim = \" → \";\n  const path = [\n    selections.selectAdmin0,\n    selections.selectAdmin1,\n    selections.selectAdmin2,\n  ].filter((d) =&gt; d);\n\n  const formatted = path\n    .filter((d) =&gt; d)\n    .map((d, i) =&gt; {\n      return i == path.length - 1 ? `**${d}**` : `*${d}*`;\n    });\n\n  return formatted.length == 0\n    ? `**${globalSelection.label}**` // no selection, all of Africa\n    : `${formatted.join(delim)}`;\n}\n\n\n\n\n\n\n\nmd`---\n### Choropleth map - Geographic Impact\n*Showing context for admin selection*\n\nThere is some hoop-jumping to get the right data based on the Admin Selection. The tabular data is then bound to the applicable geojson, and visualized with Plot.`;\n\n\n\n\n\n\n\ndataPopulation = async (admin_query) =&gt; {\n  return await db.query(`\nselect * \nfrom population\n${admin_query}\n`);\n};\n\n\n\n\n\n\n\n// // total VoP data\ndataTotalVoP = async (admin_query) =&gt; {\n  return await db.query(`\nselect admin0_name\n  , admin1_name\n  , admin2_name\n  , SUM(value) as vop_total\n  from vop\n  ${admin_query}\n  group by admin0_name, admin1_name, admin2_name\n  order by admin0_name, admin1_name, admin2_name\n`);\n};\n\n\n\n\n\n\n\n// grab tabular data for choropleth\ndataGeoImpact = {\n let admin_query\n  if (adminSelections.selectAdmin1.value) {\n    admin_query = `WHERE admin0_name = '${adminSelections.selectAdmin0.value}' AND admin1_name = '${cleanAdminInput_SQL(adminSelections.selectAdmin1.value)}' AND admin2_name IS NOT NULL`\n  } else if (adminSelections.selectAdmin0.value) {\n    admin_query = `WHERE admin0_name = '${adminSelections.selectAdmin0.value}' AND admin1_name IS NOT NULL AND admin2_name IS NULL`\n  } else {\n    admin_query = `WHERE admin1_name IS NULL`\n  }\n  // get data for choropleth map based on choice\n  const dataSource = selectGeoDataType.key == \"population\"\n    ? await dataPopulation(admin_query)\n    : await dataTotalVoP(admin_query)\n  return dataSource \n}\n\n\n\n\n\n\n\n// bind geojson to tabular data\nmapDataGeoImpact = {\n  // no selections\n  if (!adminSelections.selectAdmin0.value) {\n    return bindTabularToGeo({\n      data: dataGeoImpact,\n      dataBindColumn: \"admin0_name\",\n      geoData: boundaries.admin0,\n      geoDataBindColumn: \"admin0_name\"\n    });\n  }\n  // admin0 selected only\n  else if (!adminSelections.selectAdmin1.value) {\n    const data = T.tidy(\n      dataGeoImpact,\n      T.mutate({ a1_a0: (d) =&gt; [d.admin1_name, d.admin0_name].join(\"_\") })\n    );\n    const geoData = {\n      ...boundaries.admin1,\n      features: boundaries.admin1.features.filter(\n        (d) =&gt; d.properties.admin0_name == adminSelections.selectAdmin0.value\n      )\n    };\n\n    return bindTabularToGeo({\n      data: data,\n      dataBindColumn: \"a1_a0\",\n      geoData: geoData,\n      geoDataBindColumn: \"a1_a0\"\n    });\n  }\n\n  // admin1 is selected\n  // show all admin2 regions within admin1\n  else {\n    const data = T.tidy(\n      dataGeoImpact,\n      T.mutate({\n        a2_a1_a0: (d) =&gt; [d.admin2_name, d.admin1_name, d.admin0_name].join(\"_\")\n      })\n    );\n    const geoData = {\n      ...boundaries.admin2,\n      features: boundaries.admin2.features.filter((d) =&gt; {\n        return d.properties.admin1_name == adminSelections.selectAdmin1.value\n          && d.properties.admin0_name == adminSelections.selectAdmin0.value\n      })\n    };\n\n    return bindTabularToGeo({\n      data: data,\n      dataBindColumn: \"a2_a1_a0\",\n      geoData: geoData,\n      geoDataBindColumn: \"a2_a1_a0\"\n    });\n  }\n}\n\n\n\n\n\n\n\nmd`---\n### Dynamic Insights - Geographic Impact\n*quick insights for given admin selection*\n\n- Sql cells add a row that is the combined value for all admin regions, where all admin names are null.`;\n\n\n\n\n\n\n\nmd`Here are the combined data and insights for creating the dynamic narrative. Data tables are below.`;\n\n\n\n\n\n\n\n// dynamic insights for an Admin Selection\ndynamicInsights_geoImpact = {\n  let admin2_null = !selectAdmin2.value\n  // define data\n  const totalVop = admin2_null ? dynInsightGeo_vopTotals : filterByAdminNames(dynInsightGeo_vopTotals);\n  const totalHa = admin2_null ? dynInsightGeo_haTotals: filterByAdminNames(dynInsightGeo_haTotals); \n  const population = admin2_null ? dynInsightGeo_population : filterByAdminNames(dynInsightGeo_population);\n  const topCommodities = admin2_null ? dynInsightGeo_rankedNonAnimals: filterByAdminNames(dynInsightGeo_rankedNonAnimals);\n  const topLivestock = admin2_null ? dynInsightGeo_rankedAnimals : filterByAdminNames(dynInsightGeo_rankedAnimals);\n\n  // format functions\n  const locale = language.locale;\n  const _formatTopNVop = formatIntDollar({locale: locale});\n  const _formatNumber = formatNumCompactLong({locale: locale});\n\n  function getTopValue({ d, i } = {}) {\n    return {\n      data: d?.[i]?.vop_total,\n      value: formatWithDefault({\n        value: d?.[i]?.vop_total,\n        format: _formatTopNVop\n      }),\n      label: formatWithDefault({\n        value: d?.[i]?.crop\n      })\n    };\n  }\n\n  // make insights ------------------------------------\n  return {\n    data: {\n      totalVop,\n      totalHa,\n      population,\n      topCommodities,\n      topLivestock\n    },\n    insight: {\n      totalVop: formatWithDefault({\n        value: totalVop?.[0]?.vop_total,\n        format: _formatTopNVop\n      }),\n      totalHa: formatWithDefault({\n        value: totalHa?.[0]?.ha_total,\n        format: _formatNumber\n      }),\n      totalPop: formatWithDefault({\n        value: population?.[0]?.rural_pop,\n        format: _formatNumber\n      }),\n      topCommodities: [0, 1, 2].map((x) =&gt;\n        getTopValue({ d: topCommodities, i: x })\n      ),\n      topLivestock: [0, 1, 2].map((x) =&gt;\n        getTopValue({ d: topLivestock, i: x })\n      ),\n    }\n  };\n}\n\n\n\n\n\n\n\nmd`---\n#### Data cells for insights`;\n\n\n\n\n\n\n\ninsight_adminQuery = {\n  let admin_query\nif (adminSelections.selectAdmin1.value) {\n  admin_query = `WHERE admin0_name = '${adminSelections.selectAdmin0.value}' AND admin1_name = '${cleanAdminInput_SQL(adminSelections.selectAdmin1.value)}' AND admin2_name IS NOT NULL`\n} else if (adminSelections.selectAdmin0.value) {\n  admin_query = `WHERE admin0_name = '${adminSelections.selectAdmin0.value}' AND admin1_name IS NOT NULL AND admin2_name IS NULL`\n} else {\n  admin_query = `WHERE admin1_name IS NULL`\n}\n  return admin_query\n}\n\n\n\n\n\n\n\n// total harvested area\ndynInsightGeo_haTotals = {\n  let admin_query = insight_adminQuery\n  \n  return await db.query(`\nwith tblHA as (\n  -- total VoP and harvested area\n  SELECT admin0_name, admin1_name, admin2_name, SUM(value) AS ha_total\n    FROM ha\n    ${admin_query}\n    AND exposure = 'ha'\n    GROUP BY 1, 2, 3\n)\n\n-- QUERY ------------------------------------------\n(\n  -- total for all regions\n  select null as admin0_name\n    , null as admin1_name\n    , null as admin2_name\n    , ha_total\n    from (\n      select sum(ha_total) as ha_total\n        from tblHA\n    )\n  \n  union\n  \n  select * \n    from tblHA\n  \n  order by 1, 2, 3\n)\n`)\n}\n\n\n\n\n\n\n\ndynInsightGeo_vopTotals = {\n  let admin_query = insight_adminQuery\n\n  \n  return db.query(`\n-- total value of production\nwith tbl as (\n  -- total VoP and harvested area\n  SELECT admin0_name, admin1_name, admin2_name, SUM(value) AS vop_total\n    FROM vop\n    ${admin_query}\n    GROUP BY 1, 2, 3\n    ORDER BY 1, 2, 3\n)\n\n-- QUERY ------------------------------------------\n(\n  -- total for all regions\n  select null as admin0_name\n    , null as admin1_name\n    , null as admin2_name\n    , vop_total\n    from (\n      select sum(vop_total) as vop_total\n        from tbl\n    )\n  \n  union\n  \n  select * \n    from tbl\n  \n  order by 1, 2, 3\n)\n`)\n}\n\n\n\n\n\n\n\ndynInsightGeo_population = {\n      let admin_query = insight_adminQuery\nreturn await db.query(`\nwith tbl as (\n  -- population data\n  select admin0_name\n    , admin1_name\n    , admin2_name\n    , total_pop\n    , rural_pop\n    from population\n    ${admin_query}\n    order by admin0_name\n    , admin1_name\n    , admin2_name\n)\n\n-- QUERY ------------------------------------------\n(\n  -- total for all regions\n  select null as admin0_name\n    , null as admin1_name\n    , null as admin2_name\n    , *\n    from (\n      select sum(total_pop) as total_pop\n        , sum(rural_pop) as rural_pop\n        from tbl\n    )\n  \n  union\n  \n  select *\n    from tbl\n  \n  order by 1, 2, 3\n)\n`)\n}\n\n\n\n\n\n\n\ndynInsightGeo_rankedNonAnimals = {\nlet admin_query = insight_adminQuery\n\n  let data = await db.query(`\n  -- Combine global totals with regional data\n  WITH tbl_vop AS (\n    -- Fetch the base data for NON-animals\n    SELECT admin0_name,\n           admin1_name,\n           admin2_name,\n           crop,\n           value AS vop_total\n    FROM vop_crop\n    ${admin_query}\n  ),\n  \n  -- Calculate global totals (where admin names are null)\n  global_total_crop AS (\n    SELECT NULL AS admin0_name,\n           NULL AS admin1_name,\n           NULL AS admin2_name,\n           crop,\n           SUM(vop_total) AS vop_total\n    FROM tbl_vop\n    GROUP BY crop\n  )\n  \n  -- Combine global totals with regional data\n  SELECT * FROM global_total_crop\n  UNION ALL\n  SELECT * FROM tbl_vop\n  ORDER BY admin0_name, admin1_name, admin2_name, vop_total DESC\n`)\n  \n  const groupedData = data.reduce((acc, item) =&gt; {\n  const key = `${item.admin0_name}-${item.admin1_name}-${item.admin2_name}`;\n  if (!acc[key]) acc[key] = [];\n  acc[key].push(item);\n  return acc;\n}, {});\n\n// Rank within each group\nconst rankedData = Object.values(groupedData).flatMap(group =&gt; {\n  return group.sort((a, b) =&gt; b.vop_total - a.vop_total).slice(0, 3).map((item, index) =&gt; ({\n    ...item,\n    rank: index + 1\n  }));\n});\n  return rankedData\n}\n\n\n\n\n\n\n\ndynInsightGeo_rankedAnimals = {\n  let admin_query = insight_adminQuery\n  \n  let data = await db.query(`\n  -- Simplified SQL query to fetch animal data, including global totals\n  WITH tbl_base AS (\n    -- Base animal data grouped by crop type\n    SELECT admin0_name,\n           admin1_name,\n           admin2_name,\n           CASE \n             WHEN crop LIKE 'cattle\\_%' ESCAPE '\\\\' THEN 'cattle'\n             WHEN crop LIKE 'goats\\_%' ESCAPE '\\\\' THEN 'goats'\n             WHEN crop LIKE 'pigs\\_%' ESCAPE '\\\\' THEN 'pigs'\n             WHEN crop LIKE 'poultry\\_%' ESCAPE '\\\\' THEN 'poultry'\n             WHEN crop LIKE 'sheep\\_%' ESCAPE '\\\\' THEN 'sheep'\n             ELSE 'other'\n           END AS crop,\n           SUM(value) AS vop_total\n    FROM vop_animal\n    ${admin_query}\n    GROUP BY admin0_name, admin1_name, admin2_name, crop\n  ),\n  \n  -- Global totals where admin names are null\n  global_total_animal AS (\n    SELECT NULL AS admin0_name,\n           NULL AS admin1_name,\n           NULL AS admin2_name,\n           crop,\n           SUM(vop_total) AS vop_total\n    FROM tbl_base\n    GROUP BY crop\n  )\n  \n  -- Combine global totals with the base data\n  SELECT * FROM global_total_animal\n  UNION ALL\n  SELECT * FROM tbl_base\n  ORDER BY admin0_name, admin1_name, admin2_name, vop_total DESC\n`);\n  const groupedData = data.reduce((acc, item) =&gt; {\n  const key = `${item.admin0_name || 'TOTAL'}-${item.admin1_name || 'TOTAL'}-${item.admin2_name || 'TOTAL'}`;\n  if (!acc[key]) acc[key] = [];\n  acc[key].push(item);\n  return acc;\n}, {});\n\n// Rank within each group\nconst rankedData = Object.entries(groupedData).flatMap(([key, group]) =&gt; {\n  // Sort by value within the group\n  const sortedGroup = group.sort((a, b) =&gt; b.value - a.value);\n  \n  // Take the top 3 crops for each region\n  const top3 = sortedGroup.slice(0, 3).map((item, index) =&gt; ({\n    ...item,\n    rank: index + 1\n  }));\n\n  return top3;\n});\n  return rankedData\n}\n\n\n\n\n\n\n\nmd`---\n### Bar Charts - Hazards and Exposures\n*getting data based on admin selection and hazard options*`;\n\n\n\n\n\n\n\nmd`#### Plot Function\nMaking the top VoP bar charts`;\n\n\n\n\n\n\n\n// make the bar chart for top crops\n// approach is passing in data for selected hazard and crop type\nfunction makeTopCropBarChart(data, { marginLeft = 100 } = {}) {\n  const vopCaption = _lang(nbText.vopNoteMd.caption);\n  const vopLabel = _lang(\n    nbText.climateRisks.hazardImpact.plots.general.vopLabel,\n  );\n  const noDataMessage = _lang(\n    nbText.climateRisks.hazardImpact.plots.general.noPlotMessage,\n  );\n\n  // if no data is available for selected hazard, show a message\n  if (data.length == 0) {\n    return md`*${noDataMessage}*`;\n  }\n  const topN = 10;\n\n  return Plot.plot({\n    width: 1200,\n    height: 350,\n    marginLeft,\n    caption: vopCaption,\n    x: {\n      tickFormat: formatUSD({ locale: language.locale }),\n      label: `${vopLabel} (${intDollarUnit})`,\n      grid: true,\n    },\n    y: {\n      label: null,\n      tickSize: 0,\n    },\n    color: {\n      domain: hazardPlotLookup.color.domain,\n      range: hazardPlotLookup.color.range,\n    },\n    marks: [\n      Plot.barX(data, {\n        x: \"vop\",\n        y: (d) =&gt; hazardPlotLookup.crops[d.crop],\n        fill: (d) =&gt; hazardPlotLookup.names[d.hazard],\n        sort: { y: \"x\", reverse: true, limit: 10 },\n        channels: {\n          vop: {\n            label: vopLabel,\n            value: \"vop\",\n          },\n        },\n        tip: {\n          format: {\n            x: false,\n            y: false,\n            fill: false,\n            vop: (d) =&gt; formatIntDollar({ locale: language.locale })(d),\n          },\n        },\n      }),\n    ],\n  });\n}\n\n\n\n\n\n\n\nmd`#### Hazard Data`;\n\n\n\n\n\n\n\nmd`The hazard data includes a 'generic' crop, which is a large value that dwarfs other crop values. We exclude this from the chart.`;\n\n\n\n\n\n\n\nmd`Below is a table of the explanations of every hazard component. The 'any' hazard is the combination of all of the below hazards.\n\n| hazard | description |\n| --- | --- |\n| dry | risk of dry hazard occurring alone |\n| heat | risk of heat hazard occurring alone |\n| wet | risk of wet hazard occurring alone |\n| dry+heat | risk of dry and heat hazard occurring together |\n| dry+wet | risk of dry and wet hazard occurring together |\n| heat+wet | risk of heat and wet hazard occurring together |\n| dry+heat+wet | risk of dry and heat and wet hazard occurring together |\n| No hazard | no hazard applied\n\n*If there are zeros for individual hazards then it means it always occurs in combination with another hazard and does not occur alone.*`;\n\n\n\n\n\n\n\n// data for selected hazard scenario, with total vop\ndata_hazardVoP = T.tidy(\n  dataHazardSelected,\n  T.leftJoin(dataHazardVoPTotalSelected, {\n    by: [\"admin0_name\", \"admin1_name\", \"admin2_name\", \"crop\"],\n  }),\n  T.filter((d) =&gt; d.crop !== \"generic\"), // remove generic\n);\n\n\n\n\n\n\n\ndataHazardVoPTotalSelected = T.tidy(\n  dataHazardSelected,\n  T.filter((d) =&gt; d.hazard !== \"any\"),\n  T.groupBy(\n    [\n      \"admin0_name\",\n      \"admin1_name\",\n      \"admin2_name\",\n      \"severity\",\n      \"scenario\",\n      \"timeframe\",\n      \"crop\",\n    ],\n    [\n      T.summarize({\n        vop_total: T.sum(\"vop\"),\n      }),\n    ],\n  ),\n);\n\n\n\n\n\n\n\nmd`#### Lookups`;\n\n\n\n\n\n\n\n// unique crops in the hazard data\nhazardCrops = {\n  const query = await db.query(`select crop\n  , count(*) as count\n  from haz_risk_vop_int\n  group by 1\n  order by 1`);\n\n  return query\n }\n\n\n\n\n\n\n\n// formatting crop names\ncropNames = {\n  const raw = T.tidy(\n    hazardCrops,\n    T.distinct(\"crop\"),\n    T.select(\"crop\"),\n    T.mutate({\n      type: (d) =&gt; (/_/.test(d.crop) ? \"livestock\" : \"crop\")\n    }),\n    T.arrange([\"type\", \"cropName\"])\n  );\n  let data = raw;\n\n  // translation\n\n  const translateCrop = (crop) =&gt; td.crop.values?.[crop];\n  data = data.map((d) =&gt; {\n    const arr = Lang.toSentenceCase(_lang(translateCrop(d.crop))).split(\"_\");\n    const mainHalf = arr.slice(0, 1);\n    const backHalf = arr\n      .slice(1)\n      .filter((d) =&gt; d !== \"de\")\n      .join(\" \");\n    const paren = backHalf.length &gt; 0 ? `(${backHalf})` : \"\";\n    const formatted = [...mainHalf, paren].join(\" \").trimEnd();\n    return {\n      ...d,\n      cropName: formatted\n    };\n  });\n\n  return data;\n}\n\n\n\n\n\n\n\n// lookups for hazard plot\nhazardPlotLookup = {\n  const hazards = {\n    wet: _lang(nbText.climateRisks.hazardImpact.hazards.wet),\n    dry: _lang(nbText.climateRisks.hazardImpact.hazards.dry),\n    heat: _lang(nbText.climateRisks.hazardImpact.hazards.heat),\n    dry_heat: _lang(nbText.climateRisks.hazardImpact.hazards.dry_heat),\n    dry_wet: _lang(nbText.climateRisks.hazardImpact.hazards.dry_wet),\n    heat_wet: _lang(nbText.climateRisks.hazardImpact.hazards.heat_wet),\n    dry_heat_wet: _lang(nbText.climateRisks.hazardImpact.hazards.dry_heat_wet),\n    no_hazard: _lang(nbText.climateRisks.hazardImpact.hazards.no_hazard)\n  };\n  return {\n    names: {\n      wet: hazards.wet,\n      dry: hazards.dry,\n      heat: hazards.heat,\n      \"dry+heat\": hazards.dry_heat,\n      \"dry+wet\": hazards.dry_wet,\n      \"heat+wet\": hazards.heat_wet,\n      \"dry+heat+wet\": hazards.dry_heat_wet,\n      \"no hazard\": hazards.no_hazard\n    },\n    color: {\n      domain: [\n      hazards.wet,\n      hazards.dry,\n      hazards.heat,\n      hazards.dry_heat,\n      hazards.dry_wet,\n      hazards.heat_wet,\n      hazards.dry_heat_wet,\n      hazards.no_hazard\n      ],\n      range: [\n        \"#4FB5B7\",\n        \"#FCC42C\",\n        \"#FC8A34\",\n        \"#EE624F\",\n        \"#B34E65\",\n        \"#8C3E5F\",\n        \"#523D4E\",\n        \"#EFEFEF\"\n      ]\n    },\n    crops: cropNames.reduce((acc, obj) =&gt; {\n      acc[obj.crop] = obj.cropName;\n      return acc;\n    }, {})\n  };\n}\n\n\n\n\n\n\n\nmd`#### Selecting VoP data by scenario\n- The data is queried as separate components for each admin region to reduce query size and allow for dynamic null handling. A table is chosen based on the selected admin region.`;\n\n\n\n\n\n\n\n// pick the admin dataset based on admin selection\ndataHazardSelected = {\n  if (adminSelections.selectAdmin2.value) return dataHazardAdmin2\n  else if (adminSelections.selectAdmin1.value) return dataHazardAdmin1\n  else if (adminSelections.selectAdmin0.value) return dataHazardAdmin0\n  else return dataHazardAdminAll\n}\n\n\n\n\n\n\n\ndataHazardAdminAll = await db.query(`\n  -- Admin0 total for Sub-Saharan Africa (SSA) regions\n  WITH HazardRiskBase AS (\n    -- Filter by chosen scenario and timeframe, focusing on severe hazards\n    SELECT admin0_name,\n           admin1_name,\n           admin2_name,\n           scenario,\n           timeframe,\n           crop,\n           severity,\n           hazard,\n           value AS vop\n    FROM haz_risk_vop_int\n    WHERE severity = 'severe'\n    and timeframe = '${selectScenarioAndTimeframe.timeframe}'\n    and scenario = '${selectScenarioAndTimeframe.scenario}'\n  ),\n\n  -- Data for SSA regions only, where admin1_name is NULL (Admin0 level)\n  Admin0SSAData AS (\n    SELECT *\n    FROM HazardRiskBase\n    WHERE admin1_name IS NULL\n  ),\n\n  -- Aggregate VoP for each crop by hazard type across Admin0 regions\n  AggregatedCropData AS (\n    SELECT severity,\n           scenario,\n           timeframe,\n           hazard,\n           crop,\n           SUM(vop) AS vop\n    FROM Admin0SSAData\n    GROUP BY severity, scenario, timeframe, hazard, crop\n  )\n\n  -- Output: Admin0 level crop data with null admin names for SSA\n  SELECT NULL AS admin0_name, \n         NULL AS admin1_name, \n         NULL AS admin2_name,\n         severity, \n         scenario, \n         timeframe, \n         hazard, \n         crop, \n         vop\n  FROM AggregatedCropData\n`);\n\n\n\n\n\n\n\ndataHazardAdmin0 = db.query(`\n  select admin0_name\n    , admin1_name\n    , admin2_name\n    , scenario\n    , timeframe\n    , crop\n    , severity\n    , hazard\n    , value as vop\n    from haz_risk_vop_int\n    where severity = 'severe' -- hard-coded\n    -- and hazard in ('heat', 'wet', 'dry') -- single hazards alone\n    and timeframe = '${selectScenarioAndTimeframe.timeframe}'\n    and scenario = '${selectScenarioAndTimeframe.scenario}'\n    and admin1_name is null\n  and admin0_name = '${adminSelections.selectAdmin0.value}'`);\n\n\n\n\n\n\n\ndataHazardAdmin1 = db.query(`-- admin1 level hazard data\n  -- chosen scenario and timeframe VoP\n  select admin0_name\n    , admin1_name\n    , admin2_name\n    , scenario\n    , timeframe\n    , crop\n    , severity\n    , hazard\n    , value as vop\n    from haz_risk_vop_int\n    where severity = 'severe' -- hard-coded\n    -- and hazard in ('heat', 'wet', 'dry') -- single hazards alone\n    and timeframe = '${selectScenarioAndTimeframe.timeframe}'\n    and scenario = '${selectScenarioAndTimeframe.scenario}'\n    and admin0_name = '${adminSelections.selectAdmin0.value}'\n    and admin1_name = '${cleanAdminInput_SQL(adminSelections.selectAdmin1.value)}'\n    and admin2_name is null\n`);\n\n\n\n\n\n\n\ndataHazardAdmin2 = db.query(`-- admin2 level hazard data\n  -- chosen scenario and timeframe VoP\n  select admin0_name\n    , admin1_name\n    , admin2_name\n    , scenario\n    , timeframe\n    , crop\n    , severity\n    , hazard\n    , value as vop\n    from haz_risk_vop_int\n    where severity = 'severe' -- hard-coded\n    -- and hazard in ('heat', 'wet', 'dry') -- single hazards alone\n    and timeframe = '${selectScenarioAndTimeframe.timeframe}'\n    and scenario = '${selectScenarioAndTimeframe.scenario}'\n    and admin0_name = '${adminSelections.selectAdmin0.value}'\n    and admin1_name = '${cleanAdminInput_SQL(adminSelections.selectAdmin1.value)}'\n    and admin2_name = '${cleanAdminInput_SQL(adminSelections.selectAdmin2.value)}'\n`);\n\n\n\n\n\n\n\nmd`---\n### Dynamic Insights - Hazards and exposures`;\n\n\n\n\n\n\n\n// get selected hazard for insights, define crop type\ndata_selectedHazardCropType = T.tidy(\n  data_hazardVoP,\n  T.filter((d) =&gt; d.hazard == selectHazard),\n  T.mutate({\n    cropType: (d) =&gt; {\n      if (riskDataTypes.crop.crop.includes(d.crop)) return \"crop\";\n      if (riskDataTypes.crop.livestock.includes(d.crop)) return \"livestock\";\n      return \"other\";\n    },\n  }),\n  T.arrange([\"cropType\", T.desc(\"vop\")]),\n);\n\n\n\n\n\n\n\n// combined crop and livestock exposed for selection\ninsight_totalExposedVop = T.tidy(\n  data_selectedHazardCropType,\n  T.groupBy(\n    [\"cropType\"],\n    [\n      T.summarize({\n        totalExposedVop: T.sum(\"vop\"),\n      }),\n    ],\n  ),\n);\n\n\n\n\n\n\n\n// top crop and livestock for selection\ninsight_topCrops = {\n  const topCrop = T.tidy(\n    data_selectedHazardCropType,\n    T.select([\"cropType\", \"crop\", \"vop\"]),\n    T.filter((d) =&gt; d.cropType == \"crop\"),\n    T.sliceMax(1, \"vop\")\n  );\n  const topLivestock = T.tidy(\n    data_selectedHazardCropType,\n    T.select([\"cropType\", \"crop\", \"vop\"]),\n    T.filter((d) =&gt; d.cropType == \"livestock\"),\n    T.sliceMax(1, \"vop\")\n  );\n  return [\n    ...topCrop,\n    ...topLivestock\n  ]\n}\n\n\n\n\n\n\n\n// total vop exposed by each hazard\ninsight_rankedHazardVopTotals = T.tidy(\n  data_hazardVoP,\n  T.groupBy(\n    [\"hazard\"],\n    [\n      T.summarize({\n        totalVop: T.sum(\"vop\"),\n      }),\n    ],\n  ),\n  T.filter((d) =&gt; ![\"any\", \"no hazard\"].includes(d.hazard)), // remove combined and no hazard\n  T.arrange(T.desc(\"totalVop\")),\n);\n\n\n\n\n\n\n\nmd`---\n### Choropleth map - Adaptive Capacities\n*Population affected by admin region*\n- Fetch the data separately for the different admin levels and generate map data for each\n- Serve different data based on admin selection`;\n\n\n\n\n\n\n\n// map layer options\ndataLayerOptionsAdaptiveCapacities = [\n  {\n    key: \"pov\", // lookup id for data option\n    dataColumn: \"ac_pov\", // data column (decimal of AC)\n    label: _lang(nbText.adaptiveCapacities.inputs.mapLayer.options.pov.label), // label\n    labelLegend: _lang(\n      nbText.adaptiveCapacities.inputs.mapLayer.options.pov.labelLegend,\n    ), // label for color legend\n  },\n  {\n    key: \"edu\",\n    dataColumn: \"ac_edu\",\n    label: _lang(nbText.adaptiveCapacities.inputs.mapLayer.options.edu.label),\n    labelLegend: _lang(\n      nbText.adaptiveCapacities.inputs.mapLayer.options.edu.labelLegend,\n    ),\n  },\n  {\n    key: \"fem\",\n    dataColumn: \"ac_fem\",\n    label: _lang(nbText.adaptiveCapacities.inputs.mapLayer.options.fem.label),\n    labelLegend: _lang(\n      nbText.adaptiveCapacities.inputs.mapLayer.options.fem.labelLegend,\n    ),\n  },\n].map((d) =&gt; ({\n  // apply common values across all options\n  ...d,\n  labelPop: \"Population\", // tooltip label for population affected\n  popColumn: \"total_pop\", // population column\n  colorDomain: colorScales.range.orangeRed, // color domain\n  colorUnknown: colorScales.unknown, // unknown fill color\n}));\n\n\n\n\n\n\n\n// filter adaptive capacity data, get relevant features\nmapFeaturesAdaptiveCapacity = {\n  // if null selection for all admins, return admin0 level\n  if (!adminSelections.selectAdmin0.value) return mapDataAdaptiveCapacityAdmin0.features\n  // return admin2 level\n  else {\n    return mapDataAdaptiveCapacityAdmin2.features.filter((d) =&gt; {\n      return (\n        d.properties.admin0_name ===\n          (adminSelections.selectAdmin0.value || d.properties.admin0_name) &&\n        d.properties.admin1_name ===\n          (adminSelections.selectAdmin1.value || d.properties.admin1_name)\n      );\n    });\n  }\n}\n\n\n\n\n\n\n\nmapDataAdaptiveCapacityAdmin2 = {\n  const data = T.tidy(\n    dataAdaptiveCapacity,\n    // add data join for geo data\n    T.mutate({\n      a2_a1_a0: (d) =&gt; [d.admin2_name, d.admin1_name, d.admin0_name].join(\"_\")\n    })\n  );\n  const geoData = boundaries.admin2;\n\n  return bindTabularToGeo({\n    data: data,\n    dataBindColumn: \"a2_a1_a0\",\n    geoData: geoData,\n    geoDataBindColumn: \"a2_a1_a0\"\n  });\n}\n\n\n\n\n\n\n\nmapDataAdaptiveCapacityAdmin0 = {\n  const data = dataAdaptiveCapacity\n  const geoData = boundaries.admin0;\n\n  return bindTabularToGeo({\n    data: data,\n    dataBindColumn: \"admin0_name\",\n    geoData: geoData,\n    geoDataBindColumn: \"admin0_name\"\n  });\n}\n\n\n\n\n\n\n\ndataAdaptiveCapacity = {\n  const country = adminSelections.selectAdmin0.value;\n  const admin1 = adminSelections.selectAdmin1.value || null;\n  const admin2 = adminSelections.selectAdmin2.value || null;\n\n  let adminQuery = `WHERE admin0_name ${country ? `= '${country}'` : 'IS NOT NULL'}`\n  adminQuery += !country ? ` AND admin1_name IS NULL` :  `AND admin2_name IS NOT NULL`\n\n  \n  // const adminQuery = `\n  //   WHERE admin0_name ${country ? `= '${country}'` : 'IS NOT NULL'}\n  //   AND admin1_name ${admin1 ? `= '${admin1}'` : 'IS NULL'}\n  //   AND admin2_name ${admin2 ? `= '${admin2}'` : 'IS NULL'}`\n  \n  return await db.query(`\n    WITH filtered_ac AS (\n        SELECT \n            admin0_name,\n            admin1_name,\n            admin2_name,\n            \"GenderEquity_1995.2015\" AS ac_fem,\n            \"IHME_edu.years_2014\" AS ac_edu,\n            \"GASP_poor365_2017\" AS ac_pov\n        FROM vul_ac2\n        ${adminQuery}\n    ),\n    filtered_pop AS (\n        SELECT \n            admin0_name,\n            admin1_name,\n            admin2_name,\n            total_pop,\n            rural_pop\n        FROM population\n        ${adminQuery}\n    )\n    \n    SELECT v.*, p.total_pop, p.rural_pop\n    FROM filtered_ac v\n    JOIN filtered_pop p\n    ON v.admin0_name = p.admin0_name\n    AND (v.admin1_name = p.admin1_name OR (v.admin1_name IS NULL AND p.admin1_name IS NULL))\n    AND (v.admin2_name = p.admin2_name OR (v.admin2_name IS NULL AND p.admin2_name IS NULL));\n`)\n      // ${admin1 ? `AND v.admin1_name = p.admin1_name`: ''}\n    // ${admin2 ? `AND v.admin2_name = p.admin1_name`: ''}\n}\n\n\n\n\n\n\n\nmd`---\n### Dynamic Insights - Adapative Capacities\n*insights and helpers*`;\n\n\n\n\n\n\n\n// data and insights for\ndynamicInsights_adaptiveCapacity = {\n  const data = dataAdaptiveCapacity;\n\n  // format functions\n  const _formatNumber = formatNumCompactLong;\n\n  // source data -------------------------------\n\n  let exportData = {\n    admin0: data,\n    admin1: undefined,\n    admin2: undefined\n  };\n\n  if (!Object.values(adminSelections).every((d) =&gt; d.value === null)) {\n    // selected admin0 data\n    const filteredData0 = adminSelections.selectAdmin0.value\n      ? data.filter((d) =&gt; {\n          return (\n            d.admin0_name === (adminSelections.selectAdmin0.value || d.admin0_name)\n          );\n        })\n      : undefined;\n\n    // selected admin1 data\n    const filteredData1 = adminSelections.selectAdmin1.value\n      ? data.filter((d) =&gt; {\n          return (\n            d.admin0_name === (adminSelections.selectAdmin0.value || d.admin0_name) &&\n            d.admin1_name === (adminSelections.selectAdmin1.value || d.admin1_name)\n          );\n        })\n      : undefined;\n\n    // selected admin2 data\n    const filteredData2 = adminSelections.selectAdmin2.value\n      ? data.filter((d) =&gt; {\n          return (\n            d.admin0_name === (adminSelections.selectAdmin0.value || d.admin0_name) &&\n            d.admin1_name === (adminSelections.selectAdmin1.value || d.admin1_name) &&\n            d.admin2_name === (adminSelections.selectAdmin2.value || d.admin2_name)\n          );\n        })\n      : undefined;\n\n    exportData = {\n      admin0: filteredData0,\n      admin1: filteredData1,\n      admin2: filteredData2\n    };\n  }\n\n  // insights from source -------------------------------\n  function findAdmin2ACStats(data) {\n    // admin2 stats\n    // - find the counts for each AC\n    // - find majorities\n    // - find regions that have all and none for binary ACs\n    return T.tidy(\n      data,\n      T.mutate({\n        ac_edu_pop: (d) =&gt; (d.ac_edu === null ? null : d.ac_edu * d.total_pop),\n        ac_fem_pop: (d) =&gt; (d.ac_fem === null ? null : d.ac_fem * d.total_pop),\n        ac_pov_pop: (d) =&gt; (d.ac_pov === null ? null : d.ac_pov * d.total_pop)\n      }),\n      T.summarize({\n        total_pop: T.sum(\"total_pop\"),\n        ac_edu_pop: T.sum(\"ac_edu_pop\"),\n        ac_fem_pop: T.sum(\"ac_fem_pop\"),\n        ac_pov_pop: T.sum(\"ac_pov_pop\")\n      }),\n      T.mutate({\n        ac_edu_maj: (d) =&gt; d.ac_edu_pop &gt; (0.5 * d.total_pop),\n        ac_fem_maj: (d) =&gt; d.ac_fem_pop &gt; (0.5 * d.total_pop),\n        ac_pov_maj: (d) =&gt; d.ac_pov_pop &gt; (0.5 * d.total_pop),\n      }),\n      T.mutate({\n        ac_edu_perc: (d) =&gt; d.ac_edu_pop / d.total_pop,\n        ac_fem_perc: (d) =&gt; d.ac_fem_pop / d.total_pop,\n        ac_pov_perc: (d) =&gt; d.ac_pov_pop / d.total_pop,\n      })\n    );\n  }\n\n  const insights0 = exportData.admin0\n    ? findAdmin2ACStats(exportData.admin0)\n    : null;\n  const insights1 = exportData.admin1\n    ? findAdmin2ACStats(exportData.admin1)\n    : null;\n  const insights2 = exportData.admin2\n    ? findAdmin2ACStats(exportData.admin2)\n    : null;\n\n  const insights = {\n    admin0: insights0?.[0],\n    admin1: insights1?.[0],\n    admin2: insights2?.[0]\n  };\n\n  // admin selection total ---------------------------------\n  // - sum the admin2 population values for given admin selection\n  function sumPopulations(data) {\n    return T.tidy(\n      data,\n      T.summarize({\n        total_pop: T.sum(\"total_pop\"),\n        rural_pop: T.sum(\"rural_pop\")\n      })\n    );\n  }\n\n  // get total based on admin selection\n  // overwrite total if more granular data is non-null\n  let totalPopulations;\n  totalPopulations = exportData.admin0\n    ? sumPopulations(exportData.admin0)\n    : totalPopulations;\n  totalPopulations = exportData.admin1\n    ? sumPopulations(exportData.admin1)\n    : totalPopulations;\n  totalPopulations = exportData.admin2\n    ? sumPopulations(exportData.admin2)\n    : totalPopulations;\n  totalPopulations = totalPopulations?.[0];\n  totalPopulations[\"total_pop_format\"] = _formatNumber(\n    totalPopulations[\"total_pop\"]\n  );\n  totalPopulations[\"rural_pop_format\"] = _formatNumber(\n    totalPopulations[\"rural_pop\"]\n  );\n\n  // all/none admin2's within admin0 ---------------------------------\n  // the admin2's within the selected admin0 that are all/none AC\n  function findAdmin2ACStatsAdmin0(data) {\n    // admin2 stats\n    // - find regions that have all and none for binary ACs\n    return T.tidy(\n      data,\n      // all or none of ACs\n      T.mutate({\n        admin0_ac_all: (d) =&gt;\n          // include all admin2's if showing all regions\n          (adminSelections.selectAdmin0.value\n            ? d.admin0_name == adminSelections.selectAdmin0.value\n            : true) &&\n          d.ac_edu &gt; 0.5 &&\n          d.ac_fem &gt; 0.5 &&\n          d.ac_pov &lt;= 0.5, // reversed\n        admin0_ac_none: (d) =&gt;\n          (adminSelections.selectAdmin0.value\n            ? d.admin0_name == adminSelections.selectAdmin0.value\n            : true) &&\n          d.ac_edu &lt;= 0.5 &&\n          d.ac_fem &lt;= 0.5 &&\n          d.ac_pov &gt; 0.5 \n      }),\n      T.summarize({\n        admin2_count: T.n(),\n        admin0_ac_all_count: T.sum(\"admin0_ac_all\"),\n        admin0_ac_none_count: T.sum(\"admin0_ac_none\")\n      })\n    );\n  }\n\n  const extremeAC2Stats = findAdmin2ACStatsAdmin0(exportData.admin0)?.[0];\n\n  return {\n    data: exportData,\n    insights: insights,\n    population_sums: totalPopulations,\n    admin0LevelA2AllNone: extremeAC2Stats\n  };\n}\n\n\n\n\n\n\n\nmd`#### Helpers`;\n\n\n\n\n\n\n\n// define the mad lib for adaptive capacity admin1 and admin 0 levels\nfunction adaptiveCapacityInsightMadLib(data, adminName) {\n  const madLib = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.adaptiveCapacities.insights.madLib),\n    [\n      { name: \"admin\", value: adminName },\n      {\n        name: \"index_edu\",\n        value: formatPercentNoSymbol(transformPercent(data?.ac_edu_perc)),\n      },\n      {\n        name: \"index_fem\",\n        value: formatPercentNoSymbol(transformPercent(data?.ac_fem_perc)),\n      },\n      {\n        name: \"index_pov\",\n        value: formatPercentNoSymbol(transformPercent(data?.ac_pov_perc)),\n      },\n    ],\n  );\n\n  return `${madLib}`;\n}\n\n// // define the mad lib for adaptive capacity admin1 and admin 0 levels\n// function adaptiveCapacityInsightMadLib(data, adminName) {\n\n//   return `In **${adminName}**, the education index is **${formatPercentNoSymbol(transformPercent(data?.ac_edu_perc))}**, the female empowerment index is **${formatPercentNoSymbol(transformPercent(data?.ac_fem_perc))}**, and the poverty index is **${formatPercentNoSymbol(transformPercent(data?.ac_pov_perc))}**.`\n// }\n\n\n\n\n\n\n\n// define the mad lib for adaptive capacity admin1 and admin 0 levels\nfunction adaptiveCapacityInsightMadLib2(data, adminName) {\n  const education_years = data?.ac_edu_perc.toFixed(2);\n  const female_empowerment = (data?.ac_fem_perc * 100).toFixed(0); //formatPercentWhole(data?.ac_fem_perc)\n  const poverty_rate = formatPercentWhole(data?.ac_pov_perc);\n\n  return `In **${adminName}**, the average educational attainment is **${education_years}** years, the female empowerment index is **${female_empowerment}**, and **${poverty_rate}** live in poverty.`;\n}\n\n\n\n\n\n\n\ntextDynamicInsights_adaptiveCapacities1 = {\n  // return md`TODO: based on icicle data`\n\n  // dynamic insight based on selected region\n\n  const admin2 = adminSelections.selectAdmin2.value;\n  const admin2MadLib = adaptiveCapacityInsightMadLib(\n    dynamicInsights_adaptiveCapacity.insights.admin2,\n    admin2\n  );\n  const admin1 = adminSelections.selectAdmin1.value;\n  const admin1MadLib = adaptiveCapacityInsightMadLib(\n    dynamicInsights_adaptiveCapacity.insights.admin1,\n    admin1\n  );\n  const admin0 = adminSelections.selectAdmin0.label ?? globalSelection.label;\n  const admin0Insights = dynamicInsights_adaptiveCapacity.insights.admin0;\n  const admin0MadLib = adaptiveCapacityInsightMadLib(\n    admin0Insights,\n    admin0\n  );\n\n  const langWithinAdmin1 = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.adaptiveCapacities.insights.nestedLocationBlurb),\n    [\n      { name: \"admin_inner\", value: admin2 },\n      { name: \"admin_outer\", value: admin1 }\n    ]\n  );\n  const withinAdmin1 = admin2\n    ? `${langWithinAdmin1}`\n    : ``;\n\n  const langWithinAdmin0 = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.adaptiveCapacities.insights.nestedLocationBlurb),\n    [\n      { name: \"admin_inner\", value: admin1 },\n      { name: \"admin_outer\", value: admin0 }\n    ]\n  );\n  const withinAdmin0 = admin1\n    ? `${langWithinAdmin0}`\n    : ``;\n\n  // Text sections ------------------------------\n  const admin2Text = md`${admin2MadLib}`;\n\n  const admin1Text = md`${withinAdmin1} ${admin1MadLib}`;\n\n  const admin0Text = md`${withinAdmin0} ${admin0MadLib}`;\n\n  // Final text ------------------------------\n  return md`\n#### Old Insight:\n${admin2 ? admin2Text : \"\"}\n${admin1 ? admin1Text : \"\"}\n${admin0Insights ? admin0Text : \"\"}\n`;\n}\n\n\n\n\n\n\n\nmd`---\n### Adaptive Capacity Icicle - Adaptive Capacities\nNote: data uses SSA for combined admin region (see icicle_csv)`;\n\n\n\n\n\n\n\nicicle_raw = {\n  const country = adminSelections.selectAdmin0.value || \"SSA\";\n  const admin1 = adminSelections.selectAdmin1.value || null;\n  const admin2 = adminSelections.selectAdmin2.value || null;\n  \n  let adminQuery = `WHERE admin0_name = '${country}' AND admin1_name`\n  adminQuery += !admin1 ? ` IS NULL` : ` = '${cleanAdminInput_SQL(admin1)}'`\n  adminQuery += ` AND admin2_name`\n  adminQuery += !admin2 ? ` IS NULL` : ` = '${cleanAdminInput_SQL(admin2)}'`\n  // let adminQuery = `WHERE admin0_name = 'Angola' AND admin1_name IS NULL`\n  // return adminQuery\n  return db.query(`SELECT path, value FROM icicle_data ${adminQuery}`)\n}\n\n\n\n\n\n\n\nicicle_data = buildHierarchy(icicle_raw);\n\n\n\n\n\n\n\nicicle_keys = new Object({\n  poverty: {\n    poverty0: [\"Low Poverty\"],\n    poverty1: [\"Moderate Poverty\"],\n    poverty1: [\"High Poverty\"],\n  },\n  education: {\n    education0: [\"0-1 Years of Education\"],\n    education1: [\"1-5 Years of Education\"],\n    education3: [\"5+ Years of Education\"],\n  },\n  gender: {\n    gender0: [\"Low Female Empowerment\"],\n    gender1: [\"Moderate Female Empowerment\"],\n    gender2: [\"High Female Empowerment\"],\n  },\n});\n\n\n\n\n\n\n\nicicle_alias = {\n  const base = nbText.adaptiveCapacities.delvingDeeper.plot.nameMap\n  const nameMap = {\n    population: _lang(base.population),\n    poverty0: _lang(base.poverty0),\n    poverty1: _lang(base.poverty1),\n    poverty2: _lang(base.poverty2),\n    education0: _lang(base.education0),\n    education1: _lang(base.education1),\n    education2: _lang(base.education2),\n    gender0: _lang(base.gender0),\n    gender1: _lang(base.gender1),\n    gender2: _lang(base.gender2)\n  };\n  return nameMap;\n}\n\n\n\n\n\n\n\npartition = (data) =&gt;\n  d3\n    .partition()\n    .padding(1)\n    .size(narrow ? [height, width] : [width, height])(\n    d3\n      .hierarchy(data)\n      .sum((d) =&gt; d.value)\n      .sort((a, b) =&gt; b.value - a.value),\n  );\n\n\n\n\n\n\n\nicicle_color = d3\n  .scaleOrdinal()\n  .domain([\n    \"population\",\n    \"poverty2\",\n    \"poverty1\",\n    \"poverty0\",\n    \"education2\",\n    \"education1\",\n    \"education0\",\n    \"gender2\",\n    \"gender1\",\n    \"gender0\",\n  ])\n  .range([\n    \"#a4a4a4\",\n    \"#ec5a47\",\n    \"#fc8a34\",\n    \"#f4bb21\",\n    \"#f4bb21\",\n    \"#fc8a34\",\n    \"#ec5a47\",\n    \"#f4bb21\",\n    \"#fc8a34\",\n    \"#ec5a47\",\n  ]);\n\n\n\n\n\n\n\ntargetHeight = 350;\n\n\n\n\n\n\n\nnarrowHeight = 600;\n\n\n\n\n\n\n\nheight = narrow ? narrowHeight : targetHeight;\n\n\n\n\n\n\n\nnarrow = width &lt;= 0;\n\n\n\n\n\n\n\nsegmentX = (d) =&gt; (narrow ? d.y0 : d.x0);\n\n\n\n\n\n\n\nsegmentY = (d) =&gt; (narrow ? d.x0 : d.y0);\n\n\n\n\n\n\n\nsegmentWidth = (d) =&gt; (narrow ? d.y1 - d.y0 : d.x1 - d.x0);\n\n\n\n\n\n\n\nsegmentHeight = (d) =&gt; (narrow ? d.x1 - d.x0 : d.y1 - d.y0);\n\n\n\n\n\n\n\nfunction buildHierarchy(csv) {\n  // Helper function that transforms the given CSV into a hierarchical format.\n  const root = { name: \"root\", children: [] };\n  for (let i = 0; i &lt; csv.length; i++) {\n    const sequence = csv[i][\"path\"];\n    const size = +csv[i][\"value\"];\n    if (isNaN(size)) {\n      // e.g. if this is a header row\n      continue;\n    }\n    const parts = sequence.split(\"_\");\n    let currentNode = root;\n    for (let j = 0; j &lt; parts.length; j++) {\n      const children = currentNode[\"children\"];\n      const nodeName = parts[j];\n      let childNode = null;\n      let foundChild = false;\n      // Search for existing child with the same name\n      for (let k = 0; k &lt; children.length; k++) {\n        if (children[k][\"name\"] === nodeName) {\n          childNode = children[k];\n          foundChild = true;\n          break;\n        }\n      }\n      // If not found, create a new child node\n      if (!foundChild) {\n        childNode = { name: nodeName, children: [] };\n        children.push(childNode);\n      }\n      currentNode = childNode;\n      // If it's the last part of the sequence, create a leaf node\n      if (j === parts.length - 1) {\n        childNode.value = size;\n      }\n    }\n  }\n  return root;\n}\n\n\n\n\n\n\n\nbreadcrumbWidth = 200;\n\n\n\n\n\n\n\nbreadcrumbHeight = 35;\n\n\n\n\n\n\n\n// Generate a string that describes the points of a breadcrumb SVG polygon.\nfunction breadcrumbPoints(d, i) {\n  const tipWidth = 10;\n  const points = [];\n  points.push(\"0,0\");\n  points.push(`${breadcrumbWidth},0`);\n  points.push(`${breadcrumbWidth + tipWidth},${breadcrumbHeight / 2}`);\n  points.push(`${breadcrumbWidth},${breadcrumbHeight}`);\n  points.push(`0,${breadcrumbHeight}`);\n  if (i &gt; 0) {\n    // Leftmost breadcrumb; don't include 6th vertex.\n    points.push(`${tipWidth},${breadcrumbHeight / 2}`);\n  }\n  return points.join(\" \");\n}\n\n\n\n\n\n\n\nmd`This notebook reuses much of the 'buildHierarchy' function from the original [Sequences sunburst](https://gist.github.com/kerryrodden/7090426) gist, which was published with the following [license](https://gist.github.com/kerryrodden/7090426#file-license):\n\n&gt; Copyright 2013 Google Inc. All Rights Reserved.\n&gt; \n&gt; Licensed under the Apache License, Version 2.0 (the \"License\");\n&gt; you may not use this file except in compliance with the License.\n&gt; You may obtain a copy of the License at\n&gt; \n&gt;    http://www.apache.org/licenses/LICENSE-2.0\n&gt; \n&gt; Unless required by applicable law or agreed to in writing, software\n&gt; distributed under the License is distributed on an \"AS IS\" BASIS,\n&gt; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n&gt; See the License for the specific language governing permissions and\n&gt; limitations under the License.`;\n\n\n\n\n\n\n\nmd`---\n## Data\n*Data sources*\n- Data is from local files downloaded from S3, uploaded as a file attachments\n- Data is then wrapped as a duckDB database table (separate tables for each parquet file)\n- We are using some simplified data sources, suffixed with reduced.parquet in the S3 bucket`;\n\n\n\n\n\n\n\nmd`### Tabular data\n- **haz_risk_vop_int**: risk data showing effect hazards have on crops. Interactions are independent.\n  - risk_prototype/data/hazard_risk_vop_ac/annual/haz_risk_vop_int_ac_reduced.parquet  \n- **population**: population data by admin levels\n  - population/population_long.parquet\n- **vop_ha**: Value of Production (VoP) and hectare data (Ha) exposures by admin level. No hazards applied.\n  - risk_prototype/data/exposure/exposure_adm_sum.parquet\n- **vul_ac**: adaptive capacity data (update)\n  - vulnerability/vulnerability_RawIndex_adminALL.parquet`;\n\n\n\n\n\n\n\ndb = {\n document.body.style.cursor = \"wait\";\n let db = await DuckDBClient.of({\n    haz_risk_vop_int: FileAttachment(\"haz_risk_vop_int_gzip.parquet\"),\n    population: FileAttachment(\"population_long.parquet\"),\n    vop_ha: FileAttachment(\"exposure_adm_sum_sorted.parquet\"),\n    vul_ac: FileAttachment(\"vulnerability_RawIndex_adminALL.parquet\"),\n    vul_ac2: FileAttachment(\"AC_adminALL.parquet\"),\n    icicle_data: FileAttachment(\"All-adm_ssa_icicle_data_3class.parquet\")\n  });\n  await db.query(`CREATE TABLE vop AS SELECT * FROM vop_ha WHERE \"exposure\" = 'vop'`)\n  await db.query(`CREATE TABLE ha AS SELECT * FROM vop_ha WHERE \"exposure\" = 'ha'`)\n  await db.query(`\n        CREATE TABLE vop_crop AS \n        SELECT * \n        FROM vop_ha \n        WHERE NOT (\n          crop LIKE 'cattle\\_%' ESCAPE '\\\\'\n          OR crop LIKE 'goats\\_%' ESCAPE '\\\\'\n          OR crop LIKE 'pigs\\_%' ESCAPE '\\\\'\n          OR crop LIKE 'poultry\\_%' ESCAPE '\\\\'\n          OR crop LIKE 'sheep\\_%' ESCAPE '\\\\'\n        )\n        AND crop NOT LIKE 'total_%' ESCAPE '\\\\'\n        AND exposure = 'vop'`)\n  await db.query(`\n        CREATE TABLE vop_animal AS\n        SELECT *\n        FROM vop_ha\n        WHERE (\n          crop LIKE 'cattle\\_%' ESCAPE '\\\\'\n          OR crop LIKE 'goats\\_%' ESCAPE '\\\\'\n          OR crop LIKE 'pigs\\_%' ESCAPE '\\\\'\n          OR crop LIKE 'poultry\\_%' ESCAPE '\\\\'\n          OR crop LIKE 'sheep\\_%' ESCAPE '\\\\'\n        )\n        AND crop NOT LIKE 'total_%' ESCAPE '\\\\' -- remove total lines\n        AND exposure = 'vop'`)\n  document.body.style.cursor = \"default\";\n  return db\n}\n\n\n\n\n\n\n\nmd`### Geographic data\nGeo files were converted to TopoJSON and reduced in complexity before uploading to the notebook, see [Simplify large spatial files](https://observablehq.com/d/258c68ee969e8ed5?collection=@periscopic/ab-atlas) notebook for method.\n- **admin0**: broadest level, country boundaries\n  - boundaries/atlas-region_admin0_harmonized.geojson\n- **admin1**: one level down from admin0, regions within each admin0 region\n  - boundaries/atlas-region_admin1_harmonized.geojson\n- **admin2**: lowest level, subregions of every admin1 region\n  - boundaries/atlas-region_admin2_harmonized.geojson`;\n\n\n\n\n\n\n\nboundaries = {\n  return {\n    admin0: admin0,\n    admin1: await get_admin1(),\n    admin2: await get_admin2()\n  }\n}\n\n\n\n\n\n\n\ngeo_db = {\n  let db = await DuckDBClient.of({\n    // admin0_geom: FileAttachment(\"atlas-region_admin0_simplified.parquet\"),\n    admin1_geom: FileAttachment(\"atlas-region_admin1_simplified.parquet\")\n  });\n  await db.query(`\n    CREATE VIEW admin2_geom AS\n    SELECT *\n    FROM read_parquet(\"${resolveWindowsCacheIssue(\n      \"https://digital-atlas.s3.amazonaws.com/boundaries/atlas-region_admin2_simplified.parquet\"\n    )}\")`);\n  return db;\n}\n\n\n\n\n\n\n\npartitioned_boundries =\n  \"https://digital-atlas.s3.amazonaws.com/boundaries/subnational-boundaries_simplified\";\n\n\n\n\n\n\n\niso3_list = new Object({\n  Nigeria: \"NGA\",\n  Sudan: \"SDN\",\n  Cameroon: \"CMR\",\n  Ethiopia: \"ETH\",\n  Mauritania: \"MRT\",\n  \"Côte d’Ivoire\": \"CIV\",\n  Ghana: \"GHA\",\n  Madagascar: \"MDG\",\n  Djibouti: \"DJI\",\n  Benin: \"BEN\",\n  \"Equatorial Guinea\": \"GNQ\",\n  Eritrea: \"ERI\",\n  Tanzania: \"TZA\",\n  Somalia: \"SOM\",\n  \"Guinea-Bissau\": \"GNB\",\n  Mali: \"MLI\",\n  \"Central African Republic\": \"CAF\",\n  Gambia: \"GMB\",\n  Chad: \"TCD\",\n  Kenya: \"KEN\",\n  \"Congo - Kinshasa\": \"COD\",\n  Angola: \"AGO\",\n  Lesotho: \"LSO\",\n  Guinea: \"GIN\",\n  Liberia: \"LBR\",\n  \"Burkina Faso\": \"BFA\",\n  \"Congo - Brazzaville\": \"COG\",\n  Burundi: \"BDI\",\n  Zimbabwe: \"ZWE\",\n  Mozambique: \"MOZ\",\n  Botswana: \"BWA\",\n  Malawi: \"MWI\",\n  Uganda: \"UGA\",\n  Zambia: \"ZMB\",\n  \"South Sudan\": \"SSD\",\n  Togo: \"TGO\",\n  Senegal: \"SEN\",\n  Niger: \"NER\",\n  \"Sierra Leone\": \"SLE\",\n  \"South Africa\": \"ZAF\",\n  Rwanda: \"RWA\",\n  Namibia: \"NAM\",\n  Gabon: \"GAB\",\n  Eswatini: \"SWZ\",\n});\n\n\n\n\n\n\n\nadmin_iso = iso3_list[selectAdmin0.value];\n\n\n\n\n\n\n\nadmin0 = {\n  let admin0 = await FileAttachment(\"atlas-region_admin0_harmonized.json\").json()\n return topojson.feature(admin0, admin0.objects[\"atlas-region_admin0_harmonized\"])\n}\n\n\n\n\n\n\n\nget_admin1 = async () =&gt; {\n  let country = adminSelections.selectAdmin0.value;\n  let admin1 = adminSelections.selectAdmin1.value;\n  if (country) {\n    document.body.style.cursor = \"wait\";\n    let admin1_query = `WHERE admin0_name = '${country}'`;\n    // let response = await geo_db.query(`\n    //   SELECT *\n    //   FROM admin1_geom\n    //   ${admin1_query}`)\n\n    let response = await geo_db.query(`\n        SELECT *\n        FROM \"${resolveWindowsCacheIssue(\n          partitioned_boundries +\n            \"/admin0=\" +\n            admin_iso +\n            \"/admin_level=1/\" +\n            admin_iso +\n            \".parquet\",\n        )}\"\n    `);\n    let wkb_list = response.map((d) =&gt; d.geometry);\n    let data = await response.map(({ geometry, ...rest }) =&gt; rest);\n    const features = [];\n    for (let i = 0; i &lt; wkb_list.length; i++) {\n      const pointer = GEOS.geosGeomFromWKB(wkb_list[i]);\n      let geojson = await GEOS.geosGeomToGeojson(pointer, GEOS.geos);\n      geojson = turfRewind(geojson, { reverse: true });\n      const feature = {\n        type: \"Feature\",\n        geometry: geojson,\n        properties: data[i],\n      };\n      features.push(feature);\n      GEOS.geos.GEOSGeom_destroy(pointer);\n    }\n    const geojson = {\n      type: \"FeatureCollection\",\n      features: features,\n    };\n    // return { names: [\"Full Country\"].concat(a1_names), GEOJSON: geojson };\n    document.body.style.cursor = \"default\";\n    return geojson;\n  }\n};\n\n\n\n\n\n\n\nget_admin2 = async () =&gt; {\n  let country = adminSelections.selectAdmin0.value;\n  let admin1 = adminSelections.selectAdmin1.value;\n  if (country) {\n    document.body.style.cursor = \"wait\";\n    // let admin2_query = `WHERE admin0_name = '${country}'`\n    // admin2_query += !admin1? \"\":` AND admin1_name = '${cleanAdminInput_SQL(admin1)}'`\n    // let response = await geo_db.query(`\n    //   SELECT *\n    //   FROM admin2_geom\n    //   ${admin2_query}`)\n    // let response = await geo_db.query(`\n    //     SELECT *\n    //     FROM \"${partitioned_boundries}/admin0=${admin_iso}/admin_level=2/${admin_iso}.parquet\"\n    // `)\n    console.log(\n      \"a2_path:\",\n      resolveWindowsCacheIssue(\n        partitioned_boundries +\n          \"/admin0=\" +\n          admin_iso +\n          \"/admin_level=2/\" +\n          admin_iso +\n          \".parquet\",\n      ),\n    );\n    let response = await geo_db.query(`\n        SELECT *\n        FROM \"${resolveWindowsCacheIssue(partitioned_boundries + \"/admin0=\" + admin_iso + \"/admin_level=2/\" + admin_iso + \".parquet\")}\"\n    `);\n    let wkb_list = response.map((d) =&gt; d.geometry);\n    let data = await response.map(({ geometry, ...rest }) =&gt; rest);\n    const features = [];\n    for (let i = 0; i &lt; wkb_list.length; i++) {\n      const pointer = GEOS.geosGeomFromWKB(wkb_list[i]);\n      let geojson = await GEOS.geosGeomToGeojson(pointer, GEOS.geos);\n      geojson = turfRewind(geojson, { reverse: true });\n      const feature = {\n        type: \"Feature\",\n        geometry: geojson,\n        properties: data[i],\n      };\n      features.push(feature);\n      GEOS.geos.GEOSGeom_destroy(pointer);\n    }\n    const geojson = {\n      type: \"FeatureCollection\",\n      features: features,\n    };\n    document.body.style.cursor = \"default\";\n    return geojson;\n  }\n};\n\n\n\n\n\n\n\nmd`### Dynamic summary links\nCSV of links to include for different admin0 selections\n- Local Drive Google Sheet`;\n\n\n\n\n\n\n\n// dynamic bulleted list data\ndynamicSummaryData = {\n  const raw = await FileAttachment(\"dynamic-summary-links.csv\").csv()\n\n  return raw.filter((d) =&gt; d.admin0_name.length &gt; 0)\n}\n\n\n\n\n\n\n\ndynamicSummarySelectedLinks = {\n  // filter and check link number\n  const data = dynamicSummaryData\n  const admin0Selection = adminSelections.selectAdmin0.value ?? \"DEFAULT\"\n  \n  const numLinks = data.filter(d =&gt; d.admin0_name == admin0Selection).length\n  return numLinks == 0\n    ? data.filter(d =&gt; d.admin0_name == 'DEFAULT')\n    : data.filter(d =&gt; d.admin0_name == admin0Selection)\n\n  \n}\n\n\n\n\n\n\n\ndynamicSummaryMarkdown = {\n  const linkArr = dynamicSummarySelectedLinks.map(d =&gt; `- [${d.link_text}](${d.link_url})${d.description.length &gt; 0 ? `: ${d.description}`: \"\"}`)\n  return linkArr.join(\"\\n\")\n}\n\n\n\n\n\n\n\nmd`***\n## Helpers\n*Functions and other good stuff*`;\n\n\n\n\n\n\n\nmd`---\n### Risk data grouping\n*Lookups for risk data binning, such as hazards and crop types*`;\n\n\n\n\n\n\n\n// lookup for risk data type groupings\n// used by inputs and for grouping up data\nriskDataTypes = new Object({\n  crop: {\n    crop: [\n      \"arabica coffee\",\n      \"banana\",\n      \"barley\",\n      \"bean\",\n      \"cassava\",\n      \"chickpea\",\n      \"cocoa\",\n      \"coconut\",\n      \"cotton\",\n      \"cowpea\",\n      \"generic\",\n      \"groundnut\",\n      \"lentil\",\n      \"maize\",\n      \"oilpalm\",\n      \"pearl millet\",\n      \"pigeonpea\",\n      \"plantain\",\n      \"potato\",\n      \"rice\",\n      \"robusta coffee\",\n      \"sesameseed\",\n      \"small millet\",\n      \"sorghum\",\n      \"soybean\",\n      \"sugarcane\",\n      \"sunflower\",\n      \"sweet potato\",\n      \"tea\",\n      \"tobacco\",\n      \"wheat\",\n      \"yams\",\n    ],\n    livestock: [\n      \"cattle_highland\",\n      \"cattle_tropical\",\n      \"goats_highland\",\n      \"goats_tropical\",\n      \"pigs_highland\",\n      \"pigs_tropical\",\n      \"poultry_highland\",\n      \"poultry_tropical\",\n      \"sheep_highland\",\n      \"sheep_tropical\",\n    ],\n  },\n});\n\n\n\n\n\n\n\nmd`---\n### Dynamic insights\n*functions for formatting results*`;\n\n\n\n\n\n\n\nfunction filterByAdminNames(data) {\n  // filter down data by combined selected admin0/admin1/admin2 Admin Selections\n  // pass data from query, use tidyjs to filter by admin selection\n  const result = T.tidy(\n    data,\n    T.filter((d) =&gt; {\n      return (\n        d.admin0_name == adminSelections.selectAdmin0.value &&\n        d.admin1_name == adminSelections.selectAdmin1.value &&\n        d.admin2_name == adminSelections.selectAdmin2.value\n      );\n    }),\n  );\n  return result;\n}\n\n\n\n\n\n\n\n// wrapper for format functions, show chosen default\nfunction formatWithDefault({\n  value = 1000,\n  format = (d) =&gt; d,\n  defaultValue = \"---\",\n  debug = false,\n} = {}) {\n  // apply a formatting function to a value\n  // return default value if undefined or null\n  if (!(value === null || value === undefined)) {\n    return format(value);\n  } else {\n    return defaultValue;\n  }\n}\n\n\n\n\n\n\n\nmd`---\n### Data functions: format and transform\n*apply formatting to/transform a value*\n\n- Reference: [Intl.NumberFormat()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/NumberFormat/NumberFormat)`;\n\n\n\n\n\n\n\nmd`**Transforms**`;\n\n\n\n\n\n\n\n// transform non-number to percent value\ntransformPercent = (d) =&gt; {\n  if (d === undefined || d === null) return d;\n  else return d * 100;\n};\n\n\n\n\n\n\n\nmd`**Formatting**`;\n\n\n\n\n\n\n\n// format non-number as percent\nformatPercentTenth = (d) =&gt; {\n  if (d === undefined || d === null) return d;\n  else return d3.format(\".1%\")(d);\n};\n\n\n\n\n\n\n\n// format non-number as percent\nformatPercentWhole = (d) =&gt; {\n  if (d === undefined || d === null) return d;\n  else return d3.format(\".0%\")(d);\n};\n\n\n\n\n\n\n\n// format non-number with no floating point\n// for index values\nformatPercentNoSymbol = (d) =&gt; {\n  if (d === undefined || d === null) return d;\n  else return d3.format(\".0f\")(d);\n};\n\n\n\n\n\n\n\nfunction formatUSD({ locale = \"en-US\" } = {}) {\n  const formatter = formatNumCompactShort({ locale });\n\n  return (number) =&gt; {\n    const formattedNum = formatter(number);\n    return \"$\" + formattedNum;\n  };\n}\n\n\n\n\n\n\n\nintDollarYear = 2005; // year of international year data\n\n\n\n\n\n\n\nintDollarUnit = `${intDollarYear} Int$`; // full unit for international dollars\n\n\n\n\n\n\n\n// format US currency\nfunction formatIntDollar({ locale = \"en-US\" } = {}) {\n  return (number, unit = intDollarUnit.replace(\"$\", \"\")) =&gt; {\n    let formattedNumber = formatUSD({ locale })(number);\n    let intDollar = unit + formattedNumber;\n    return intDollar;\n  };\n}\n\n\n\n\n\n\n\n// format number, long notation\nformatNumCompactLong = function ({ locale = \"en-US\" } = {}) {\n  return function (number) {\n    return new Intl.NumberFormat(locale, {\n      notation: \"compact\",\n      compactDisplay: \"long\",\n      unitDisplay: \"long\",\n    }).format(number);\n  };\n};\n\n\n\n\n\n\n\n// format number, short notation\nformatNumCompactShort = ({ locale = \"en-US\" } = {}) =&gt;\n  new Intl.NumberFormat(locale, {\n    notation: \"compact\",\n    compactDisplay: \"short\",\n  }).format;\n\n\n\n\n\n\n\nmd`---\n### Querying data\n*functions for querying data*`;\n\n\n\n\n\n\n\nfunction getUniqueValues(col, tbl, db) {\n  // return unique values of from db tbl as a list\n  return db\n    .query(`select distinct ${col} from ${tbl}`)\n    .then((x) =&gt; x.map((d) =&gt; d[col]));\n}\n\n\n\n\n\n\n\nfunction bindTabularToGeo({\n  data = [],\n  dataBindColumn = \"dataBindColumn\",\n  geoData = [],\n  geoDataBindColumn = \"geoDataBindColumn\",\n}) {\n  if (!data.length || !geoData.features || !geoData.features.length) {\n    return {\n      type: \"FeatureCollection\",\n      features: [],\n    };\n  }\n  // bind data to geojson\n  const index = new Map(data.map((d) =&gt; [d[dataBindColumn], d])); // map data by dataBindColumn\n  const geojson = JSON.parse(JSON.stringify(geoData)); // do a copy, rather than mutate\n  // join up data to geojson\n  for (const f of geojson.features) {\n    f.properties.data = index.get(f.properties[geoDataBindColumn]);\n  }\n  return geojson;\n}\n\n\n\n\n\n\n\nmd`***\n## Testing Queries\n*Test queries of the tabular data*`;\n\n\n\n\n\n\n\n{\n  const debugString = md`**Query hidden: Debug: non-zero hazard data counts**\n\n_(update boolean within this cell to run)_ \n  - this checks the number of results for every combination of hazard data \n  - ~3% of choices have no data across all crops`\n  \n  const hideQuery = true;\n\n  return hideQuery\n    ? debugString\n    : db.query(`\nwith tbl as (\n  select admin0_name\n    , admin1_name\n    , admin2_name\n    , scenario\n    , timeframe\n    , count(*) as total_count\n    , count(case when value &lt;&gt; 0 then 1 end) as non_zero_count\n    from haz_risk_vop_int\n    -- where admin0_name = 'Angola'\n    where severity = 'moderate' -- hard-coded\n    and hazard != 'any'\n    group by admin0_name\n    , admin1_name\n    , admin2_name\n    , scenario\n    , timeframe\n    order by non_zero_count\n)\n\nselect * \n  from tbl\n  -- where non_zero_count = 0\n`);\n}\n\n\n\n\n\n\n\nmd`***\n## Imports\n*External imports*`;\n\n\n\n\n\n\n\nimport { toc } from \"@nebrius/indented-toc\";\n\n\n\n\n\n\n\nimport { T } from \"@pbeshai/tidyjs\";\n\n\n\n\n\n\n\nimport {\n  cleanAdminInput_SQL,\n  resolveWindowsCacheIssue,\n} from \"cbd32f92c155bf5b\";\n\n\n\n\n\n\n\nGEOS = {\n  const initgeosJs = (await import(\"https://cdn.skypack.dev/geos-wasm@2.0.0\"))\n    .default;\n  const geos = await initgeosJs();\n\n  function geosGeomFromWKB(wkb) {\n    const wkbPtr = geos.Module._malloc(wkb.length); //Allocate memory for the geom\n    geos.Module.HEAPU8.set(wkb, wkbPtr);\n    const geomPtr = geos.GEOSGeomFromWKB_buf(wkbPtr, wkb.length);\n    geos.Module._free(wkbPtr);\n    return geomPtr;\n  }\n  \n  const geosGeomToGeojson = (\n    await import(\"https://cdn.skypack.dev/geos-wasm/helpers\")\n  ).geosGeomToGeojson;\n\n  return { geosGeomToGeojson, geosGeomFromWKB, geos };\n}\n\n\n\n\n\n\n\nturfRewind = require(\"@turf/turf\").then((t) =&gt; t.rewind);\n\n\n\n\n\n\n\nimport { buildInlineDownloadButton } from \"1bda5f9b60c64223\";\n\n\n\n\n\n\n\ndownload_translation = new Object({\n  en: \"Download Data\",\n  fr: \"Télécharger les Données\",\n});\n\n\n\n\n\n\n\nmd`---\n\n## Other`;\n\n\n\n\n\n\n\nfunction makeDevNotes({\n  // adding dev notes as a html summary (collapsible)\n  title = \"Plot dev notes\",\n  emojis = \"👆🛠\",\n  text = md`Update this text using the \\`text\\` field.`,\n} = {}) {\n  return htl.html`&lt;details&gt;\n&lt;summary&gt;${title} ${emojis}&lt;/summary&gt;${text}&lt;/details&gt;`;\n}\n\n\n\n\n\n\n\n{\n  const text = `### v1.2.0: adding language conversion\n- language toggle \n\n### v1.1.2: Adaptive capacity formatting\n- Update adaptive capacity data\n  - AC data for map are indices and should be describes as such, not as rates\n  - Update insights to be about selected indexes rather than population affected\n\n### v1.1.1 Map fix (2024-03-26)\nLooking at map with multiple regions shown for choropleth\n- Fix binding when you've selected admin1:\n  - Bind data by BOTH admin1 and admin0, not just admin1\n\n### v1.1 Data Update (2024-03-19)\n- Hazard field is now 'no hazard' (all lowercase)\n- VoP values are the total across all severities, not just hard-coded to 'moderate'\n\n### v1.0.1 (2024-03-15)\n- Adding cover image\n\n### v1.0 (2024-03-15)\n- Updating hazard data\n  - Included 'No hazard' as option, so updated how data is extracted (no longer joining up totals)\n    - Using new option as definition of distribution\n    - Update removal from component bar charts\n  - Not using the explicit 'any' column, instead defining using sum of component values (to avoid any rounding errors)\n- Cleanup\n  - Remove unused hazard helpers\n  - Clean up documentation for data sources\n\n### v0.6 (2024-03-11)\n\n- Collapse y-axis for percent chart when crop hazards are zero (preserve order for crops and livestock)\n- Remove 'no hazard' from hazard bar chart dropdown\n- Update perc chart tooltip\n  - Total VoP at risk is now in terms of colored bars only (using any hazard data)\n  - Format to match percent and money with hazard exposure\n  - Fix bar ordering\n- Update adaptive capacity icicle\n  - includes SSA and updated colors\n- Update adaptive capacity map data\n`;\n\n  const newestVersion = text.split('###')\n    .filter(d =&gt; d)\n    .map(d =&gt; d.trim())\n    ?.[0]\n    .split('\\n')\n    ?.[0]\n\n  return makeDevNotes({\n    text: md`${text}`,\n    title: newestVersion ?? \"Dev notes\",\n    emojis: \"🪵✏️\"\n  })\n}\n\n\n\n\n\n\n\nconvertToCSV = (data) =&gt; {\n  if (!data?.length) return \"\";\n\n  const headers = Object.keys(data[0]);\n  const escapeValue = (val) =&gt; {\n    if (val == null) return \"\";\n    const str = String(val);\n    return str.includes(\",\") || str.includes('\"') || str.includes(\"\\n\")\n      ? `\"${str.replace(/\"/g, '\"\"')}\"`\n      : str;\n  };\n\n  return [\n    headers.map(escapeValue).join(\",\"),\n    ...data.map((row) =&gt; headers.map((key) =&gt; escapeValue(row[key])).join(\",\")),\n  ].join(\"\\n\");\n};\n\n\n\n\n\n\n\n{ const _anyData = T.tidy(\n    data_hazardVoP,\n    T.filter((d) =&gt; ![\"any\", \"no hazard\"].includes(d.hazard)), // only hazard components\n    T.groupBy(\n      [\n        \"admin0_name\",\n        \"admin1_name\",\n        \"admin2_name\",\n        \"scenario\",\n        \"timeframe\",\n        \"severity\",\n        \"crop\"\n      ],\n      [\n        T.summarize({\n          vop_any: T.sum(\"vop\")\n        })\n      ]\n    )\n  );\n\n  const _dataWithAnyColumn = T.tidy(\n    data_hazardVoP,\n    T.leftJoin(_anyData, {\n      by: [\n        \"admin0_name\",\n        \"admin1_name\",\n        \"admin2_name\",\n        \"scenario\",\n        \"timeframe\",\n        \"crop\",\n        \"severity\"\n      ]\n    })\n  );\n\n  const data = _dataWithAnyColumn;\n  const dataAny = data.filter((d) =&gt; d.hazard == \"any\"); // combined\n  const dataBars = [\n    ...data.filter((d) =&gt; d.hazard !== \"any\" && d.vop !== 0) // remove the combined hazard\n  ];\n return dataBars\n}"
  },
  {
    "objectID": "notebooks/projectedImpacts/notebook.html",
    "href": "notebooks/projectedImpacts/notebook.html",
    "title": "Appendix",
    "section": "",
    "text": "import { heroImage } from \"/helpers/hero.js\";\nhero_url = \"./../../images/projectedImpacts.webp\";\n\nhero = heroImage(notebookTitle, hero_url);\nhtml`${hero}`;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nimport { atlasTOC } from '/helpers/toc.ojs' \n{\n  await nbText // force wait/reload with nbText to load so headings have correct labels/languages\n  return atlasTOC({\n      heading: `&lt;b&gt;${_lang({en:\"In this notebook\", fr:\"Dans ce notebook\"})}&lt;/b&gt;`,\n      skip: [notebookTitle, \"notebook-title\", \"Appendix\", \"source-code\"]\n      })\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nviewof prettyLanguageView = {\n  return Inputs.bind(\n    Inputs.radio(languages, {\n      label: _lang({en: \"Language\", fr: \"Langue\"}),\n      format: (d) =&gt; d.label\n    }),\n    viewof language\n  );\n}\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.overview.title)}\n\n${_lang(nbText.overview.text)}`;\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.regionalPicture.title)}\n\n${_lang(nbText.regionalPicture.text)}`;\n\n\n\n\n\n\n\n{\n  const form = Inputs.form(\n    [\n      Inputs.bind(\n        Inputs.select(\n          [\"maize\", \"rice\", \"wheat\"],\n          {label: _lang(nbText.general.crop),\n          format: c =&gt; _lang(nbText.general.crops[c])}\n        ),\n      viewof crop_selector_yield),\n      Inputs.bind(\n        Inputs.select(\n          avaliable_unRegions,\n          {label: _lang(nbText.regionalPicture.beeswarm.yAxis),\n          format: d =&gt;  _lang(nbText.regionalPicture.beeswarm.regions[d || \"all\"])} // No region is NULL so add a label\n        ),\n      viewof sel_region),\n    ],\n    {\n      template: formTemplate()\n    }\n  )\n  return form\n}\n\n\n\n\n\n\n\n{\n  // ============================================================================\n  // DATA PREPARATION\n  // ============================================================================\n  \n  const cleanData = impacts_metaanalysis_data\n    .filter(d =&gt; \n      !sel_region || d?.UNRegion === sel_region\n    )\n    .map(d =&gt; ({\n      ...d,\n      temp_band: classifyTempBand(d.preindustrial_temp_delta)\n    }));\n\n    const violin_tt_html = (temp, adaptation, mean, min, max, sd, n_obs) =&gt; {\n      return `&lt;strong&gt;With Adaptatation:&lt;/strong&gt; ${adaptation}&lt;br/&gt;\n              &lt;strong&gt;Temperature:&lt;/strong&gt; ${temp}&lt;br/&gt;\n              &lt;strong&gt;Yield loss (%):&lt;/strong&gt;&lt;br/&gt;\n              &lt;strong&gt;Mean:&lt;/strong&gt; ${mean.toFixed(2)}&lt;br/&gt;\n              &lt;strong&gt;Min:&lt;/strong&gt; ${min.toFixed(2)}&lt;br/&gt;\n              &lt;strong&gt;Max:&lt;/strong&gt; ${max.toFixed(2)}&lt;br/&gt;\n              &lt;strong&gt;Std Dev:&lt;/strong&gt; ${sd.toFixed(2)}&lt;br/&gt;\n              &lt;strong&gt;Observations:&lt;/strong&gt; ${n_obs}&lt;br/&gt;`\n    }\n\n  // ============================================================================\n  // HELPER FUNCTIONS\n  // ============================================================================\n  \n  function classifyTempBand(temp) {\n    if (temp &lt;= 2) return \"≤ 2°C\" // return \"≤ 1.5°C\";\n    if (temp &lt;= 3) return \"2-3°C\"// return \"1.5–2.5°C\";\n    return \"&gt; 3°C\"; // \"&gt; 2.5°C\"\n  }\n\n  function gaussianKernel(u) {\n    return Math.exp(-0.5 * u * u) / Math.sqrt(2 * Math.PI);\n  }\n\n  function silvermanBandwidth(values) {\n    const n = values.length;\n    if (n &lt; 2) return 1.5;\n    const sd = d3.deviation(values) || 1;\n    return Math.max(1, 1.06 * sd * Math.pow(n, -0.2));\n  }\n\n  function computeKDE(grid, samples, bandwidth) {\n    const invBw = 1 / bandwidth;\n    return grid.map(gridPoint =&gt; {\n      const density = d3.mean(samples, v =&gt; \n        gaussianKernel((gridPoint - v) * invBw)\n      ) * invBw;\n      return [gridPoint, density || 0];\n    });\n  }\n  \n  function kdeWithinExtent(samples, step=0.25) { // Clamp the tails of the violin to min and max\n    const [lo, hi] = d3.extent(samples);\n    const bw = silvermanBandwidth(samples);\n    const grid = d3.range(lo, hi + step, step);\n    const density = computeKDE(grid, samples, bw);\n    const maxDensity = d3.max(density, d =&gt; d[1]) || 0;\n    return { density, maxDensity, lo, hi };\n  }\n\n  function computeDensitiesPerAdaptation(dataSubset) {\n    return d3.groups(dataSubset, d =&gt; d.Adaptation)\n      .map(([adaptation, records]) =&gt; {\n        const values = records.map(d =&gt; d.yield_impact_pct);\n        const { density, maxDensity, lo, hi } = kdeWithinExtent(values);\n        return { adaptation, records, density, maxDensity, lo, hi };\n    });\n  }\n\n  // ============================================================================\n  // SCALES AND DIMENSIONS\n  // ============================================================================\n  \n  const margin = { top: 60, right: 30, bottom: 30, left: 80 };\n  const width = 1000;\n  const height = 600;\n  const innerW = width - margin.left - margin.right;\n  const innerH = height - margin.top - margin.bottom;\n\n  // Y scale (yield impact)\n  // const yExtent = d3.extent(cleanData, d =&gt; d.yield_impact_pct);\n  const yExtent = [-100, 100]\n  const padding = 0;\n  const yMin = Math.min((yExtent[0] ?? -10) - padding, 0);\n  const yMax = Math.max((yExtent[1] ?? 10) + padding, 0);\n  \n  const yScale = d3.scaleLinear()\n    .domain([yMin, yMax])\n    .nice()\n    .range([innerH, 0]);\n\n  const yGrid = d3.range(\n    yScale.domain()[0], \n    yScale.domain()[1] + 1e-9, \n    (yScale.domain()[1] - yScale.domain()[0]) / 100\n  );\n\n  // Temperature band columns\n  // const tempBands = [\"≤ 1.5°C\", \"1.5–2.5°C\", \"&gt; 2.5°C\"];\n  const tempBands = [\"≤ 2°C\", \"2-3°C\", \"&gt; 3°C\"]\n  const xBandScale = d3.scaleBand()\n    .domain(tempBands)\n    .range([0, innerW])\n    .padding(0.15);\n\n  // Adaptation categories within each column\n  const adaptationTypes = Array.from(\n    new Set(cleanData.map(d =&gt; d.Adaptation))\n  ).sort(d3.ascending);\n  \n  const xInnerScale = d3.scalePoint()\n    .domain(adaptationTypes)\n    .range([0, xBandScale.bandwidth()])\n    .padding(0.6);\n\n  // Color scale\n  const colorScale = d3.scaleOrdinal()\n    .domain(adaptationTypes)\n    .range(d3.schemeTableau10);\n\n  // Violin width scale (shared across all columns)\n  const maxDensityGlobal = d3.max(\n    tempBands.map(band =&gt; {\n      const subset = cleanData.filter(d =&gt; d.temp_band === band);\n      return d3.max(computeDensitiesPerAdaptation(subset), d =&gt; d.maxDensity);\n    })\n  ) || 1;\n  \n  const maxViolinHalfWidth = Math.min(45, (xBandScale.bandwidth() / adaptationTypes.length) * 0.35);\n  const widthScale = d3.scaleLinear()\n    .domain([0, maxDensityGlobal])\n    .range([0, maxViolinHalfWidth]);\n\n  // Violin area generator\n  const areaGenerator = d3.area()\n    .curve(d3.curveCatmullRom)\n    .x0(d =&gt; -widthScale(d[1]))\n    .x1(d =&gt; +widthScale(d[1]))\n    .y(d =&gt; yScale(d[0]));\n\n  // ============================================================================\n  // SVG SETUP\n  // ============================================================================\n  const id = \"impactfulViolin\"\n  const svg = d3.create(\"svg\")\n    .attr(\"width\", width)\n    .attr(\"height\", height)\n    // .style(\"background\", \"#fafafa\")\n    // .style(\"font-family\", \"'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif\");\n\n  const chartArea = svg.append(\"g\")\n    .attr(\"transform\", `translate(${margin.left},${margin.top})`);\n\n  d3.selectAll(`#${id}-tooltip`).remove();\n  const tooltip = d3\n    .select(\"body\")\n    .append(\"div\")\n    .attr(\"id\", `${id}-tooltip`)\n    .attr(\"class\", \"plotTooltip hazardTip\")\n    .style(\"position\", \"absolute\");\n\n  // ============================================================================\n  // DRAW COLUMNS (TEMPERATURE BANDS)\n  // ============================================================================\n  \n  const columnsGroup = chartArea.append(\"g\").attr(\"class\", \"columns\");\n  const jitterGenerator = d3.randomUniform.source(d3.randomLcg(42))(\n    -maxViolinHalfWidth * 0.85, \n    maxViolinHalfWidth * 0.85\n  );\n\n  tempBands.forEach(band =&gt; {\n    const columnGroup = columnsGroup.append(\"g\")\n      .attr(\"transform\", `translate(${xBandScale(band)},0)`);\n\n    // Column header\n    columnGroup.append(\"text\")\n      .attr(\"x\", xBandScale.bandwidth() / 2)\n      .attr(\"y\", -12)\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"font-weight\", 700)\n      .attr(\"font-size\", 14)\n      .attr(\"fill\", \"#1a1a1a\")\n      .text(band);\n\n    // Compute densities for this temperature band\n    const bandData = cleanData.filter(d =&gt; d.temp_band === band);\n    const densities = computeDensitiesPerAdaptation(bandData);\n\n    // Draw violins\n    densities.forEach(({ adaptation, density, records }) =&gt; {\n      const cx = xInnerScale(adaptation);\n      if (cx == null) return;\n\n      // Calc group stats for the tooltip and mean lines\n      const meanYield = d3.mean(records, d =&gt; d.yield_impact_pct);\n      const sdYield = d3.deviation(records, d =&gt; d.yield_impact_pct);\n      const minYield = d3.min(records, d =&gt; d.yield_impact_pct);\n      const maxYield = d3.max(records, d =&gt; d.yield_impact_pct);\n      const n_obs = records.length\n\n\n      const violinGroup = columnGroup.append(\"g\")\n        .attr(\"transform\", `translate(${cx},0)`);\n\n      violinGroup.append(\"path\")\n        .attr(\"d\", areaGenerator(density))\n        .attr(\"fill\", colorScale(adaptation))\n        .attr(\"fill-opacity\", 0.2)\n        .attr(\"stroke\", colorScale(adaptation))\n        .attr(\"stroke-width\", 1.5)\n        .style(\"filter\", \"drop-shadow(0 1px 2px rgba(0,0,0,0.05))\");\n\n      violinGroup\n        .on(\"mousemove\", (event, d) =&gt; {\n          tooltip\n            .style(\"top\", event.pageY - 10 + \"px\")\n            .style(\"left\", event.pageX + 10 + \"px\")\n            .style(\"opacity\", 1)\n            .style(\"display\", \"block\")\n            .html(violin_tt_html(band, adaptation, meanYield, minYield, maxYield, sdYield, n_obs));\n        })\n          .on(\"mouseout\", function (event, d) {\n            d3.select(`#${id}-tooltip`).style(\"display\", \"none\");\n        });\n      \n      // Mean line\n      const meanY = yScale(meanYield);\n      violinGroup.append(\"line\")\n        .attr(\"x1\", -maxViolinHalfWidth * 0.4)\n        .attr(\"x2\", maxViolinHalfWidth * 0.4)\n        .attr(\"y1\", meanY)\n        .attr(\"y2\", meanY)\n        .attr(\"stroke\", colorScale(adaptation))\n        .attr(\"stroke-width\", 2.5)\n        .attr(\"stroke-opacity\", 0.9);\n    });\n\n\n    // Draw data points\n    columnGroup.append(\"g\")\n      .selectAll(\"circle\")\n      .data(bandData)\n      .join(\"circle\")\n        .attr(\"cx\", d =&gt; xInnerScale(d.Adaptation) + jitterGenerator())\n        .attr(\"cy\", d =&gt; yScale(d.yield_impact_pct))\n        .attr(\"r\", 2.5)\n        .attr(\"fill\", d =&gt; colorScale(d.Adaptation))\n        .attr(\"fill-opacity\", 0.1)\n        .attr(\"stroke\", d =&gt; colorScale(d.Adaptation))\n        .attr(\"stroke-width\", 0.15)\n        .style(\"cursor\", \"pointer\")\n      .append(\"title\")\n        .text(d =&gt; `${d.Crop} • ${d.Country}\nTemperature: ${d.preindustrial_temp_delta}°C\nYield Impact: ${d.yield_impact_pct.toFixed(2)}%\nAdaptation: ${d.Adaptation}\nReference: ${d.Reference}`);\n  });\n\n  // ============================================================================\n  // AXES AND GRIDLINES\n  // ============================================================================\n  \n  // Y-axis\n  const yAxis = chartArea.append(\"g\")\n    .attr(\"class\", \"y-axis\")\n    .call(d3.axisLeft(yScale).ticks(8).tickSize(-innerW))\n    .call(g =&gt; g.select(\".domain\").remove())\n    .call(g =&gt; g.selectAll(\".tick line\")\n      .attr(\"stroke\", \"#e0e0e0\")\n      .attr(\"stroke-dasharray\", \"2,2\"))\n    .call(g =&gt; g.selectAll(\".tick text\")\n      .attr(\"fill\", \"#666\")\n      .attr(\"font-size\", 11));\n\n  // Zero reference line\n  chartArea.append(\"line\")\n    .attr(\"x1\", 0)\n    .attr(\"x2\", innerW)\n    .attr(\"y1\", yScale(0))\n    .attr(\"y2\", yScale(0))\n    .attr(\"stroke\", \"#333\")\n    .attr(\"stroke-width\", 1.5)\n    .attr(\"stroke-dasharray\", \"4,4\");\n\n  // Adaptation category ticks (within each column)\n  // const innerAxisGenerator = d3.axisBottom(xInnerScale).tickSize(0);\n  // tempBands.forEach(band =&gt; {\n  //   chartArea.append(\"g\")\n  //     .attr(\"transform\", `translate(${xBandScale(band)},${innerH})`)\n  //     .call(innerAxisGenerator)\n  //     .call(g =&gt; g.select(\".domain\").remove())\n  //     .call(g =&gt; g.selectAll(\"text\")\n  //       .attr(\"dy\", \"1em\")\n  //       .attr(\"font-size\", 10)\n  //       .attr(\"fill\", \"#666\")\n  //       .text(d =&gt; _lang(nbText.regionalPicture.beeswarm.legend[d])));\n  // });\n\n  // ============================================================================\n  // LABELS\n  // ============================================================================\n  \n  // Y-axis label\n  svg.append(\"text\")\n    .attr(\"transform\", `translate(20,${height/2}) rotate(-90)`)\n    .attr(\"text-anchor\", \"middle\")\n    .attr(\"font-weight\", 600)\n    .attr(\"font-size\", 13)\n    .attr(\"fill\", \"#333\")\n    .text(\"Yield Impact (%)\");\n\n  // X-axis label\n  svg.append(\"text\")\n    .attr(\"x\", width / 2)\n    .attr(\"y\", 10)\n    .attr(\"text-anchor\", \"middle\")\n    .attr(\"font-weight\", 600)\n    .attr(\"font-size\", 13)\n    .attr(\"fill\", \"#333\")\n    .text(\"Temperature Increase from Pre-Industrial Levels\");\n\n  // ============================================================================\n  // Legend\n  // ============================================================================\n\n  const legendItems = adaptationTypes.map(a =&gt; ({\n    key: a,\n    // use your localized label if available; else fall back to the raw key\n    label: (_lang?.(nbText?.regionalPicture?.beeswarm?.legend?.[a])) ?? a,\n    color: colorScale(a)\n  }));\n\n  const sw = 12;            // swatch size\n  const rowH = 20;          // row height\n  const gap = 8;            // gap between swatch and text\n  const colWidth = 170;     // width per legend column\n  const cols = legendItems.length &gt; 6 ? 2 : 1;\n\n  // position top-right inside the chart area\n  const legendX = margin.left + 5;\n  const legendY = margin.top + 8;\n\n  const legend = svg.append(\"g\")\n    .attr(\"class\", \"legend\")\n    .attr(\"transform\", `translate(${legendX}, ${legendY})`)\n    .attr(\"aria-label\", \"Legend\");\n\n  const items = legend.append(\"g\");\n\n  items.selectAll(\"g.item\")\n    .data(legendItems)\n    .join(\"g\")\n      .attr(\"class\", \"item\")\n      .attr(\"transform\", (d, i) =&gt; {\n        const col = Math.floor(i / Math.ceil(legendItems.length / cols));\n        const row = i % Math.ceil(legendItems.length / cols);\n        return `translate(${col * colWidth}, ${row * rowH})`;\n      })\n    .each(function(d) {\n      const g = d3.select(this);\n        g.append(\"rect\")\n          .attr(\"width\", sw)\n          .attr(\"height\", sw)\n          .attr(\"rx\", 2)\n          .attr(\"ry\", 2)\n          .attr(\"y\", 0)\n          .attr(\"fill\", d.color)\n          .attr(\"fill-opacity\", 0.2)\n          .attr(\"stroke\", d.color)\n          .attr(\"stroke-width\", 1.5);\n        \n        g.append(\"text\")\n          .attr(\"x\", sw + gap)\n          .attr(\"y\", sw/2)\n          .attr(\"dominant-baseline\", \"middle\")\n          .attr(\"font-size\", 11)\n          .attr(\"fill\", \"#333\")\n          .text(d.label);\n    });\n\n  return svg.node();\n}\n\n\n\n\n\n\n\nbeeswarm_insight_title = {\n  let template = _lang(nbText.regionalPicture.beeswarmInsight.title)\n  let items = [\n    {name: \"SelectedCrop\", value: selected_crop_global.map((c) =&gt; _lang(nbText.general.crops[c]))},\n    {name: \"warmingLevel\", value: warming_level},\n  ]\nreturn md`### ${Lang.reduceReplaceTemplateItems(template, items)}`\n}\n\n\n\n\n\n\n\nviewof warming_level = {\n  return Inputs.select(\n      temp_opts,\n      {label: _lang(nbText.regionalPicture.selectors.warmingLevel.title) }\n  )  \n}\n\n\n\n\n\n\n\nviolin_insight = {\n\n  let band_sel = warming_level\n  const tempBand_data = {\n    temp_band: band_sel,\n    ...violin_insight_data.median_yields[band_sel],\n    ...violin_insight_data.worst_region[band_sel]\n  };\n// return tempBand_data\n  //Point 1\n  const template_insight1 = _lang(nbText.regionalPicture.beeswarmInsight.text.insight1)\n  const values_insight1 = [\n        {name: \"warmingLevel\", value: band_sel},\n        {name: \"crops\", value: selected_crop_global.map((c) =&gt; _lang(nbText.general.crops[c]))},\n        {name: \"yieldReduction\", value: tempBand_data.median_without_adaptation.toFixed(2)}\n    ]\n  const insight1 = Lang.reduceReplaceTemplateItems(template_insight1, values_insight1)\n\n  //Point 2\n  let template_insight2 = _lang(nbText.regionalPicture.beeswarmInsight.text.insight2.mostAffected)\n  let values_insight2 = [\n      {name: \"mostAffected_adaptation\", value: tempBand_data.worst_region_with_adaptation.region},\n      {name: \"mostAffected_noadaptation\", value: tempBand_data.worst_region_without_adaptation.region},\n    ]\n  const insight2 = Lang.reduceReplaceTemplateItems(template_insight2, values_insight2)\n\n  //Point 3\n  let insight3;\n  if (!!tempBand_data.median_with_adaptation) {\n    let template_insight3 = _lang(nbText.regionalPicture.beeswarmInsight.text.insight3.compelling);\n    const values_insight3 = [\n      {name: \"loss_gain\", value: \"losses\"}, // Hard coded for now as all data is better with adaptation\n      {name: \"withAdaptation\", value: tempBand_data.median_with_adaptation.toFixed(2)},\n    ]\n    insight3 = Lang.reduceReplaceTemplateItems(template_insight3, values_insight3)\n  } else {\n    insight3 = _lang(nbText.regionalPicture.beeswarmInsight.text.insight3.notCompelling);\n  }\n  \nreturn md`\n* ${insight2}\n* ${insight1}\n* ${insight3}`\n}\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.zoomToStable.title)}\n\n${_lang(nbText.zoomToStable.text)}`;\n\n\n\n\n\n\n\nzoom_in_selectors = {\n  const form = Inputs.form(zoom_in_elements, {template: formTemplate()})\n  return form\n}\n\n\n\n\n\n\n\n// format admin selections\n// bind to appendix inputs, add template to format\ngeoImpactAdminSelectors = Inputs.form(\n  [\n    Inputs.bind(\n      Inputs.select(dataAdmin0, { label: _lang(nbText.general.country), format: x =&gt; x == null ? _lang(nbText.general.adminNames['SSA']): _lang(nbText.general.adminNames[x])}),\n      viewof selectAdmin0\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin1, { label: _lang(nbText.general.region) }),\n      viewof selectAdmin1\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin2, { label: _lang(nbText.general.subRegion) }),\n      viewof selectAdmin2\n    )\n  ],\n  {\n    template: formTemplate()\n  }\n)\n\n\n\n\n\n\n\n// define choices for the data value\nviewof selectGeoDataType = {\n  const options = [\n/*    \n    {\n      key: \"population\", // lookup id for data option\n      dataColumn: \"rural_pop\", // data column\n      label: \"Rural population\", // label\n      labelTip: \"Rural population\", // label for tooltip\n      labelLegend: \"Rural population\", // label for legend\n      formatFunc: formatNumCompactShort, // formatting function for raw data value\n      colorRange: colorScales.range.yellowGreen, // color range\n      colorUnknown: colorScales.unknown, // unknown fill color \n    },\n    {\n      key: \"vop\",\n      dataColumn: \"vop_total\",\n      label: \"Total Value of Production (VoP)\",\n      labelTip: \"VoP\",\n      labelLegend: \"Value of Production ($)\",\n      formatFunc: formatUSD,\n      colorRange: colorScales.range.yellowGreen,\n      colorUnknown: colorScales.unknown,\n    },\n*/\n    {\n      key: \"wmean_yield_rfd\",\n      dataColumn: \"wmean_yield_rfd\",\n      label: _lang(nbText.zoomToStable.selectors.layer.values.rainfed),//\"Mean rainfed potential yield\", \n      labelTip: \"rfd\",\n      labelLegend: _lang(nbText.zoomToStable.selectors.layer.values.rainfed),\n      formatFunc: formatNumCompactShort,\n      colorRange: colorScales.range.yellowGreen,\n      colorUnknown: colorScales.unknown,\n    },\n    {\n      key: \"wmean_yield_irr\",\n      dataColumn: \"wmean_yield_irr\",\n      label:  _lang(nbText.zoomToStable.selectors.layer.values.irrigated),\n      labelTip: \"irr\",\n      labelLegend: _lang(nbText.zoomToStable.selectors.layer.values.irrigated),\n      formatFunc: formatNumCompactShort,\n      colorRange: colorScales.range.yellowGreen,\n      colorUnknown: colorScales.unknown,\n    },\n  ];\n  return Inputs.radio(options.sort((a,b) =&gt; b.key.localeCompare(a.key)), {\n    width: 300,\n    label:  _lang(nbText.zoomToStable.selectors.layer.title),\n    format: (x) =&gt; x.label,\n    value: options.find((t) =&gt; t.key === \"wmean_yield_rfd\")\n  });\n}\n\n\n\n\n\n\n\nplotChoroplethGeoImpact = {\n  const data = mapDataGeoImpact\n  const selector = selectGeoDataType\n  const dataColumn = mapDataColumn;\n  \n  // return plot\n  return Plot.plot({\n    width: mapWidth,\n    height: 550,\n    caption: _lang(nbText.general.greyNoData),\n    projection: {\n      type: \"azimuthal-equal-area\",\n      domain: data\n    },\n    color: {\n      legend: true,\n      label: selector.labelLegend,\n      range: selector.colorRange,\n      unknown: selector.colorUnknown,\n      tickFormat: selector.formatFunc,\n    },\n    marks: [\n      // geo data\n      Plot.geo(data.features, {\n        fill: (d) =&gt; {\n          const fillValue = d.properties.data ? d.properties.data[dataColumn] : null; // handle missing data\n          return fillValue\n        },\n        stroke: \"#fff\",\n        strokeWidth: 0.5\n      }),\n      // admin2 highlight \n      // if Admin selection includes admin2, highlight section\n      Plot.geo(adminSelections.selectAdmin2 \n               ? data.features.filter(d =&gt; d.properties.admin2_name == adminSelections.selectAdmin2)\n               : [], {\n        fill: null,\n        stroke: \"#333\",\n        strokeWidth: 1.5\n      }),\n      // geo pointer\n      Plot.geo(data, Plot.pointer(\n        Plot.centroid({\n        stroke: \"#333\",\n        strokeWidth: 1.5,\n      }))),\n      // tooltip\n      Plot.tip(\n        data.features,\n        Plot.pointer(\n          Plot.centroid({\n            channels: {\n              name: {\n                // region label, based on selection\n                label: getLowerLevelAdminLabel(), // plot-level so inputs don't reload\n                value: (d) =&gt; d.properties.admin_name\n              },\n              country: (d) =&gt; d.properties.admin0_name,\n              data: {\n                label: selector.labelTip,\n                value: (d) =&gt; {\n                const data = d.properties.data ? d.properties.data[dataColumn] : undefined\n                return data\n              },\n              }\n            },\n            format: {\n              name: true,\n              country: false,\n              data: (d) =&gt; selector.formatFunc(d)\n            }\n          })\n        )\n      )\n    ]\n  });\n}\n\n\n\n\n\n\n\nmap_insights = {\n  async function quick_insight_map_admin_rank(data_column){\n    let none_admins_for_same_level = getAdminsNoneForSameLevel()\n    let query = `\n        SELECT *\n        FROM aggregated\n        WHERE cycle = '${selected_cycle_options.cycle}'\n        AND crop = '${crop_selector_dynamic_insights}'\n        AND cultivar = '${selected_cultivar.value}'`\n    if (none_admins_for_same_level.length &gt; 0) {\n      query += ` AND ${none_admins_for_same_level.map(col =&gt; `${col} IS NULL`).join(' AND ')}`\n    }\n    let same_level = await db.query(query)\n      .then((r) =&gt; r.toArray())\n    // Sort by absolute yield changes, descending order\n    // TODO: absolute value?\n    same_level.sort((a, b) =&gt; Math.abs(a[data_column]) - Math.abs(b[data_column])).reverse();\n  \n    let ranking = 0;\n    let selected_admin = get_selected_admin_atfc();\n    let admins_to_names = {\n      admin0_name: \"countries\",\n      admin1_name: \"regions\",\n      admin2_name: \"subregions\",\n    }\n    for (let i = 0; i &lt; same_level.length; i++){\n      let obj = same_level[i];\n      if (obj[selected_admin.admin] != selected_admin.highlight)\n        continue\n      ranking = i + 1;\n      break\n    }\n    \n    return {\n      data: same_level,\n      ranking: ranking,\n      selected_geo: selected_admin.highlight,\n      admin_name: admins_to_names[selected_admin.admin],\n      out_of: same_level.length,\n    };\n  }\n\n  function average_first_insight_for_all_subsaharan_africa(filtered) {\n    const yield_in_selected_geo = filtered.filter(d =&gt; d.admin1_name == null)\n    const colname = get_yield_column(selected_yield_output.label, selectGeoDataType.labelTip);\n    //const colname = \"yield_\"+selectGeoDataType.labelTip+\"_avg\";\n    const values = yield_in_selected_geo.map(d =&gt; d[mapDataColumn]);\n    let obj = {}\n    obj[colname] = average(values)\n    return [obj]\n  }\n\n\n  // Title\n  let geogs = Object.values(adminSelections).filter(d =&gt; d !== null)\n  if (geogs.length == 0){ \n    // geogs = _lang(nbText.general.country_article2.SSA);  \n    geogs = _lang(nbText.general.adminNames.SSA);  \n  } else {\n    geogs = geogs.map(val =&gt; _lang(nbText.general.adminNames[val]) || val).join(\", \")\n    // geogs = geogs.map(val =&gt; _lang(nbText.general.country_article2[val]) || val).join(\", \")\n  }\n  let yield_in_selected_geo = dataYield.filter(filterYieldDataByAdmins);\n  if (selectAdmin0 == null){\n    yield_in_selected_geo = average_first_insight_for_all_subsaharan_africa(yield_in_selected_geo) \n  }\n\n  let title_template = _lang(nbText.zoomToStable.MapInsight.title)\n\n  let title_values = [\n    {name:\"geography\", value: geogs},\n    {name:\"scenario_selection\", value: selected_scenario.label.toLowerCase()},\n    {name:\"crop_selection\", value: _lang(nbText.general.crops[crop_selector_dynamic_insights.toLowerCase()])}\n  ]\n  \n  const title = Lang.reduceReplaceTemplateItems(title_template, title_values)\n\n  // Globals\n  const _outputName = _lang(nbText.zoomToStable.selectors.YieldOutput.values[selected_yield_output.label]).toLowerCase()\n  const _outputUnit = _outputName.match(/\\(([^)]+)\\)/g);\n\n  //Insight 1\n  let insight1 = \"\"\n  // Rainfed yield\n  if (yield_in_selected_geo !== null && yield_in_selected_geo.length == 1){\n    let yield_in_selected_geo_obj = yield_in_selected_geo[0];\n    if (yield_in_selected_geo_obj[mapDataColumn] != null){\n      let rounded = Math.round(yield_in_selected_geo_obj[mapDataColumn] * 100) / 100;\n      \n      let insight1_template = _lang(nbText.zoomToStable.MapInsight.insight1)\n      \n      let insight1_values = [\n        {name:\"geography\", value: geogs},\n        {name:\"scenario_selection\", value: selected_scenario.label.toLowerCase()},\n        {name:\"crop_selection\", value: crop_selector_dynamic_insights},\n        {name:\"yield_selection\", value: _outputName},\n        {name:\"value\", value: rounded}\n      ]\n      \n      insight1 = `* ${Lang.reduceReplaceTemplateItems(insight1_template, insight1_values)}`  \n    }\n  }\n\n  // Insight 2\n  let insight2 = \"\"\nlet pre_filtered = await db.query(`\n  SELECT *\n  FROM aggregated \n  WHERE cycle = '${selected_cycle_options.cycle}'\n  AND crop = '${crop_selector_dynamic_insights.toLowerCase()}'\n  AND cultivar = '${selected_cultivar.value}'\n`).then((r) =&gt; r.toArray())\n  \n  if (adminSelections.selectAdmin0 != null){\n   pre_filtered = pre_filtered.filter(filterYieldDataByAdmins);\n  }\n\n  // A climate change scenario ...\n  if (selected_scenario.label.toLowerCase() != \"historical\"){\n    let climate_change_scenarios;\n    if (adminSelections.selectAdmin0 == null){\n      const africa_pre_filtered = pre_filtered.filter(d =&gt; d.admin1_name == null && d.ssp == selected_scenario.ssp);\n      const horizons = [2030, 2050];\n      climate_change_scenarios = [];\n      for(let i = 0; i &lt; horizons.length; i++){\n        const temp_h = horizons[i];\n        let averaged_horizon = average_first_insight_for_all_subsaharan_africa(\n          africa_pre_filtered.filter(d =&gt; d.horizon == temp_h)\n        );\n        averaged_horizon[0][\"horizon\"] = temp_h;\n        averaged_horizon[0][\"ssp\"] = selected_scenario.ssp; \n        climate_change_scenarios.push(...averaged_horizon)\n      }\n    } else {\n      climate_change_scenarios = pre_filtered.filter((d) =&gt; (\n        (d.ssp == selected_scenario.ssp)\n      ));\n    }\n    for (let i = 0; i &lt; climate_change_scenarios.length; i++){\n      let emissions = climate_change_scenarios[i].ssp == \"SSP370\" ? \"moderate \": \"high \";\n      emissions += climate_change_scenarios[i].ssp\n      let impact = Math.round(climate_change_scenarios[i][mapDataColumn] * 100) / 100;\n      let horizon = climate_change_scenarios[i].horizon\n      if (horizon == 2005)\n        continue\n      let change;\n      if (impact == 0)\n        change = \"neutral\"\n      else\n        change = impact &gt; 0 ? \"positive\" : \"negative\";\n\n      let insight2_template = _lang(nbText.zoomToStable.MapInsight.insight2)\n      \n      let insight2_values = [\n        {name:\"emission_level\", value: emissions},\n        {name:\"horizon\", value: horizon},\n        {name:\"change_type\", value: _lang(nbText.general[change])},\n        {name:\"impact_pct\", value: impact},\n        {name:\"change_unit\", value: _outputUnit}\n      ]\n\n      insight2 += `* ${Lang.reduceReplaceTemplateItems(insight2_template, insight2_values)}\\n`\n\n      // insights += `* A climate change scenario with ${emissions} emissions by **${horizon}** has a **${change}** impact on yield of ${impact}%. \\n`\n    }\n  }\n\n  let insight3 = \"\"\n  if (selected_yield_output.label == \"Yield change (%)\"){\n    const values_col = get_yield_column(\"Yield change (%)\", selectGeoDataType.labelTip);\n    const change_values = pre_filtered\n      .filter(d =&gt; ((d[values_col] !== null)))\n      .map(d =&gt; d[values_col]);\n    let max_change = Math.round(arrayMax(change_values) * 100) / 100;\n    let min_change = Math.round(arrayMin(change_values) * 100) / 100;\n\n    let insight3_template = _lang(nbText.zoomToStable.MapInsight.insight3)\n    \n    let insight3_values = [\n      {name:\"minChange\", value: min_change},\n      {name:\"maxChange\", value: max_change},\n    ]\n\n    insight3 = `* ${Lang.reduceReplaceTemplateItems(insight3_template, insight3_values)}`\n\n//     insights += `* The projected yield changes arise from simulating yield under various plausible futures, which implies uncertainty. Accordingly, the range of projected changes is **${min_change}%** to **${max_change}%** across the climate models used.\n// `\n  }\n\n  //insight 4\n  let insight4 = \"\"\n  if (adminSelections.selectAdmin0 != null){\n    // Absolute yield changes\n    let data_column = get_yield_column(\"Yield change (ton/ha)\", selectGeoDataType.labelTip);\n    let result = await quick_insight_map_admin_rank(data_column);\n    \n    let insight4_template = _lang(nbText.zoomToStable.MapInsight.insight4)\n    let insight4_values = [\n      {name:\"geography\", value: result.selected_geo},\n      {name:\"rank\", value: result.ranking},\n      {name:\"num\", value: result.out_of},\n      {name:\"adminLvl\", value: result.admin_name},\n    ]\n\n    insight4 = `* ${Lang.reduceReplaceTemplateItems(insight4_template, insight4_values)}`\n    // insights += `* Across all of Sub-Saharan Africa, ${result.selected_geo} ranks ${result.ranking} out of ${result.out_of} ${result.admin_name} at the same level, with regard to absolute yield changes.\\n`\n  }\n\n  \n  return md`\n### ${title}\n${insight1}\n${insight2}\n${insight3}\n${insight4}`\n  \n// ${insights}`\n}\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.adaptFutureChange.title)}\n\n${_lang(nbText.adaptFutureChange.text)}`;\n\n\n\n\n\n\n\natfc_form = Inputs.form([\n    viewof atfc_crop_selector,\n    viewof atfc_cycle_selector,\n    viewof atfc_scenario_selector\n], {template: formTemplate()})\n\n\n\n\n\n\n\ngeoImpactAdminSelectorsAFC = Inputs.form(\n  [\n    Inputs.bind(\n      Inputs.select(dataAdmin0, { label: _lang(nbText.general.country), format: x =&gt; x == null ? _lang(nbText.general.adminNames['SSA']): _lang(nbText.general.adminNames[x])}),\n      viewof selectAdmin0\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin1, { label: _lang(nbText.general.region) }),\n      viewof selectAdmin1\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin2, { label: _lang(nbText.general.subRegion) }),\n      viewof selectAdmin2\n    )\n  ],\n  {\n    template: formTemplate()\n  }\n)\n\n\n\n\n\n\n\nviewof radioSortDotPlotCrop = {\n  const data = [\n    {\n      key: \"observations\",\n      label: _lang(nbText.adaptFutureChange.selectors.sort.values.noAdapt),\n      channel: \"nObs\",\n      reverse: true,\n    },\n    {\n      key: \"mean\",\n      label: _lang(nbText.adaptFutureChange.selectors.sort.values.meanDiff),\n      channel: \"x\",\n      reverse: true,\n    },\n    {\n      key: \"alpha\",\n      label: _lang(nbText.adaptFutureChange.selectors.sort.values.alphabet),\n      channel: \"y\",\n      reverse: false,\n    },\n  ]\n  return Inputs.radio(data, { label: \"Sort\", format: d =&gt; d.label, value: data.find(x =&gt; x.key === 'mean') });\n}\n\n\n\n\n\n\n\nplotDotAEZ = {\n  const baseData = dataYieldATFC;\n  const plotData = baseData.filter(d =&gt; (\n      (d.crop.toLowerCase().trim() == selected_crop_atfc.toLowerCase().trim())\n    )\n  );\n  var toHiglight = get_selected_admin_atfc();\n  if (selectAdmin0 == null){\n    toHiglight = {\n      admin: \"admin0_name\",\n      highlight: \"\"\n    }\n  }\n  const aezColor = {\n    domain: [\n      \"historical\",\n      \"2030\",\n      \"2050\",\n    ],\n    range: [\n      \"#74B95A\",\n      \"#F3D6B0\",\n      \"#B02B19\",\n    ],\n  }\n  const aezData = T.tidy(\n    plotData,\n    T.filter((d) =&gt; {\n      if (toHiglight.highlight == null) return d;\n      return d[toHiglight.admin] == toHiglight.highlight;\n    }),\n    T.arrange(\"mean_difference\")\n  );\n  \n  const colorDomain = aezColor.domain;\n  const colorRange = aezColor.range;\n  const marginBottom = 0;\n  const marginTop = 50;\n  const yHeight = 35;\n  const height =\n    marginTop +\n    marginBottom +\n    d3.group(plotData, (d) =&gt; d.adaptation).size * yHeight;\n  const _formatNum = formatNum;\n  // const _toggleCIs = toggleCIsCrop[0]; // Remove as CI are too small to see on plot\n  const _radioSort = radioSortDotPlotCrop;\n  \n  return Plot.plot({\n    height,\n    marginBottom,\n    marginTop,\n    marginLeft: 160,\n    marginRight: 50,\n    width: 1000,\n    x: {\n      axis: \"top\",\n      nice: true,\n      grid: true,\n      label: _lang(nbText.adaptFutureChange.plot.xAxis.title),\n      labelAnchor: \"center\",\n      labelOffset: 40,\n      labelArrow: \"none\"\n    },\n    y: {\n      tickSize: 0,\n      label: null\n    },\n    color: {\n      domain: colorDomain,\n      range: colorRange,\n      tickFormat: l =&gt; l === \"historical\"? _lang(nbText.general.historical) : l,\n      legend: true\n    },\n    marks: [\n      // main y-axis\n      Plot.axisY({\n        tickSize: 0,\n        tickFormat: d =&gt; _lang(nbText.adaptFutureChange.plot.yAxis[d])\n      }),\n      // pointer white-out\n      Plot.axisY(\n        Plot.pointerY({\n          fill: \"white\",\n          textStroke: \"white\",\n          textStrokeWidth: 2,\n          tickSize: 0,\n          tickFormat: d =&gt; _lang(nbText.adaptFutureChange.plot.yAxis[d])\n        })\n      ),\n      // bold pointer\n      Plot.axisY(\n        Plot.pointerY({\n          fontWeight: \"bold\",\n          tickSize: 0,\n          tickFormat: d =&gt; _lang(nbText.adaptFutureChange.plot.yAxis[d])\n        })\n      ),\n      // zero point\n      Plot.ruleX([0], { stroke: \"#333\", strokeDasharray: [4] }),\n      // base dots\n      Plot.dot(plotData, {\n        x: \"mean_difference\",\n        y: \"adaptation\",\n        sort: { y: _radioSort.channel, reverse: _radioSort.reverse },\n        r: 8,\n        stroke: \"#fff\",\n        strokeWidth: 0.7,\n        fill: \"#efefef\",\n        channels: {\n          nObs: {\n            label: \"# Observations\",\n            value: \"N_Obs\"\n          }\n        }\n      }),\n      // selection: span lines: CI - Removed as the CI are so small they do not apperar\n      // Plot.ruleY(_toggleCIs == \"Visible\" ? aezData : [], {\n      //   y: \"adaptation\",\n      //   x1: (d) =&gt; (d.ci_upper == null ? null : d.ci_upper),\n      //   x2: (d) =&gt; (d.ci_lower  == null ? null : d.ci_lower),\n      //   stroke: \"#333\"\n      // }),\n      // selection: mean diff dots\n      Plot.dot(aezData, {\n        x: \"mean_difference\",\n        y: \"adaptation\",\n        fill: (d) =&gt; {\n          return d.horizon;\n        },\n        r: 8,\n        stroke: \"#fff\",\n        strokeWidth: 0.7,\n        channels: {\n          aez: {\n            label: _lang(nbText.adaptFutureChange.plot.channels.aez),\n            value: \"horizon\"\n          },\n          // nObs: {\n          //   label: _lang(nbText.adaptFutureChange.plot.channels.nObs),\n          //   value: \"N_Obs\"\n          // },\n          diff: {\n            label: _lang(nbText.adaptFutureChange.plot.channels.diff),\n            value: \"mean_difference\"\n          },\n          control: {\n            label: _lang(nbText.adaptFutureChange.plot.channels.control),\n            value: \"Mean_Control\"\n          },\n          prac: {\n            label: _lang(nbText.adaptFutureChange.plot.channels.prac),\n            value: \"adaptation\"\n          },\n          crop: {\n            label: _lang(nbText.general.crop),\n            value: \"Crop\"\n          },\n          ciLow: {\n            label: _lang(nbText.adaptFutureChange.plot.channels.ciLow),\n            value: \"Lower\"\n          },\n          ciHigh: {\n            label: _lang(nbText.adaptFutureChange.plot.channels.ciHigh),\n            value: \"Upper\"\n          }\n        },\n        tip: {\n          format: {\n            x: false,\n            y: false,\n            fill: false,\n            prac: false,\n            crop: false,\n            aez: (d) =&gt; d === \"historical\"? _lang(nbText.general.historical) : d,\n            diff: (d) =&gt; _formatNum(d),\n            control: (d) =&gt; _formatNum(d),\n            ciLow: (d) =&gt; _formatNum(d),\n            ciHigh: (d) =&gt; _formatNum(d),\n            nObs: true\n          }\n        }\n      }),\n      // dot highlight on hover\n      Plot.dot(\n        aezData,\n        Plot.pointer({\n          x: \"mean_difference\",\n          y: \"adaptation\",\n          r: 8,\n          fill: (d) =&gt; {\n            return d.horizon;\n          },\n          stroke: \"#333\",\n          strokeWidth: 0.7,\n          channels: {\n            nObs: {\n              label: \"# Observations\",\n              value: \"N_Obs\"\n            }\n          }\n        })\n      ),\n      // observation counts\n      // Plot.textY(\n      //   aezData,\n      //   Plot.map(\n      //     { text: (values) =&gt; values.map((d) =&gt; d + \" obs.\") },\n      //     Plot.groupY(\n      //       { text: \"sum\" },\n      //       {\n      //         y: \"adaptation\",\n      //         text: \"N_Obs\",\n      //         frameAnchor: \"right\",\n      //         textAnchor: \"start\",\n      //         dx: 16\n      //       }\n      //     )\n      //   )\n      // ),\n    ]\n  });\n}\n\n\n\n\n\n\n\nadaptation_insights = {\n\n  //Title Processing\n  let geogs = Object.values(adminSelections).filter(d =&gt; d !== null)\n  if (geogs.length == 0){ // renamed to avaoid future name issues if using geos-wasm\n    // geogs = _lang(nbText.general.country_article2.SSA);  \n    geogs = _lang(nbText.general.adminNames.SSA);  \n  } else {\n    // geogs = geogs.map(val =&gt; _lang(nbText.general.country_article2[val]) || val).join(\", \")\n    geogs = geogs.map(val =&gt; _lang(nbText.general.adminNames[val]) || val).join(\", \")\n  }\n  let title_template = _lang(nbText.adaptFutureChange.insight.title)\n  let title_values = [\n    {name:\"geography\", value: geogs},\n    {name:\"scenario_name\", value: atfc_scenario_selector.toLowerCase()},\n    {name:\"crop_name\", value: selected_crop_atfc}\n  ]\n  let title = Lang.reduceReplaceTemplateItems(title_template, title_values)\n\n  //Conditionals for insight 1 and 2\n  let insight1 = ''\n  let insight2 = ''\n  //Insight 1 processing\n\n  var selected_geo = get_selected_admin_atfc();\n  if (selectAdmin0 == null){\n    selected_geo = {\n      admin: \"admin0_name\",\n      highlight: \"SSA\"\n    }\n  }\n  if (highlighted_data.length &gt; 0){\n    let better_than_no_adpt = get_adpt_options_higher_yield_than_no_adaptation(highlighted_data);\n    let num_options_better_than_no_apt = better_than_no_adpt.length;\n    let lower_best = round(Math.min(...better_than_no_adpt.map(d =&gt; d[\"2050\"])), 2);\n    let upper_best = round(Math.max(...better_than_no_adpt.map(d =&gt; d[\"historical\"])), 2);\n\n    let insight1_template = _lang(nbText.adaptFutureChange.insight.insight1)\n    \n    let insight1_values = [\n      {name:\"selected_geo\", value: _lang(nbText.general.countries_article[selected_geo.highlight])},\n      {name:\"numBetter\", value: num_options_better_than_no_apt},\n      {name:\"lowerBest\", value: lower_best},\n      {name:\"upperBest\", value: upper_best}\n    ]\n    insight1 = `* ${Lang.reduceReplaceTemplateItems(insight1_template, insight1_values)}`\n\n    //Insight 2 processing\n\n    // Select top 3 or less\n    const top = Math.min(...[3, better_than_no_adpt.length]);\n    const best_options = [];\n    let max_improvement = 0;\n    for(let j = 0; j &lt; top; j ++){\n      best_options.push(better_than_no_adpt[j].option);\n      max_improvement = Math.max(better_than_no_adpt[j].historical, max_improvement);\n    }\n    let insight2_template = _lang(nbText.adaptFutureChange.insight.insight2)\n    let insight2_values = [\n      {name:\"bestOptions\", value: best_options.map((d) =&gt; _lang(nbText.summary.adaptationOptions[d])).join(\", \")},\n      {name:\"maxImprovement\", value: round(max_improvement, 2)}\n    ]\n\n    insight2 = `* ${Lang.reduceReplaceTemplateItems(insight2_template, insight2_values)}`\n  }\n\n\n  let insight3 = `* ${_lang(nbText.adaptFutureChange.insight.insight3)}`\n  \n  return md`\n### ${title}\n${insight1}\n${insight2}\n${insight3}`\n}\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.summary.title)}`;\n\n\n\n\n\n\n\nsummary_text = {\n  let vals_without_adapt = quick_insights_projected_2.filter(d =&gt; d.crops.length == 4).map(d =&gt; d.without_adaptation);\n  let avg = average(vals_without_adapt);\n  let template_insight1 = _lang(nbText.summary.text1)\n  let insight1 = Lang.reduceReplaceTemplateItems(template_insight1, [{name:\"avg_loss\", value: round(avg, 2)}])\n  // let insights = `Climate change without adaptation implies a reduction of ${round(avg, 2)}% in the supply of cereal grains in Sub-Saharan Africa.`\n  let insight2 = ''\n  if (adminSelections.selectAdmin0 != null && highlighted_data.length &gt; 0){\n    const selected_geo = get_selected_admin_atfc();\n    let better_than_no_adpt = get_adpt_options_higher_yield_than_no_adaptation(highlighted_data);\n    let num_options_better_than_no_apt = better_than_no_adpt.length;\n    let lower_best = round(Math.min(...better_than_no_adpt.map(d =&gt; d[\"2050\"])), 2);\n    let upper_best = round(Math.max(...better_than_no_adpt.map(d =&gt; d[\"historical\"])), 2);\n    \n    // Select top 3 or less\n    const top = Math.min(...[3, better_than_no_adpt.length]);\n    const best_options = [];\n    let max_improvement = 0;\n    for(let j = 0; j &lt; top; j ++){\n      let option = _lang(nbText.summary.adaptationOptions[better_than_no_adpt[j].option])\n      best_options.push(option);\n      max_improvement = Math.max(better_than_no_adpt[j].historical, max_improvement);\n    }\n    let template_insight2 = _lang(nbText.summary.text2)\n    let values_insight2 = [\n      {name:\"selectedGeo\", value: _lang(nbText.general.countries_article[selected_geo.highlight])},\n      {name:\"bestOptions\", value: best_options.join(\", \")}\n    ]\n    insight2 = Lang.reduceReplaceTemplateItems(template_insight2, values_insight2)\n  }\n  return md`\n${insight1}\n\n${insight2}` \n  \n}\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.MethodsSources.title)}`;\n\n\n\n\n\n\n\nmd`## ${_lang(nbText.MethodsSources.sources.title)}`;\n\n\n\n\n\n\n\nmd`### ${_lang(nbText.MethodsSources.sources.cropYieldDB.title)}\n\n${_lang(nbText.MethodsSources.sources.cropYieldDB.text)}`;\n\n\n\n\n\n\n\nmd`### ${_lang(nbText.MethodsSources.sources.cropYieldProjections.title)}\n\n${_lang(nbText.MethodsSources.sources.cropYieldProjections.text)}`;\n\n\n\n\n\n\n\nmd`### ${_lang(nbText.MethodsSources.sources.harvestedArea.title)}\n\n${_lang(nbText.MethodsSources.sources.harvestedArea.text)}`;\n\n\n\n\n\n\n\nmd`### ${_lang(nbText.MethodsSources.sources.boundaries.title)}\n\n${_lang(nbText.MethodsSources.sources.boundaries.text)}`;\n\n\n\n\n\n\n\nmd`## ${_lang(nbText.MethodsSources.methods.title)}`;\n\n\n\n\n\n\n\nmd`### ${_lang(nbText.MethodsSources.methods.beeswarm.title)}\n\n${_lang(nbText.MethodsSources.methods.beeswarm.text)}`;\n\n\n\n\n\n\n\nmd`### ${_lang(nbText.MethodsSources.methods.mappingHistoricalFuture.title)}\n\n${_lang(nbText.MethodsSources.methods.mappingHistoricalFuture.text)}`;\n\n\n\n\n\n\n\nmd`### ${_lang(nbText.MethodsSources.methods.adaptationAnalysis.title)}\n\n${_lang(nbText.MethodsSources.methods.adaptationAnalysis.text)}`;\n\n\n\n\n\n\n\nmd`## ${_lang(nbText.MethodsSources.methods.references.title)}\n\n- Alimagham, S. et al. (2024) Climate change impact and adaptation of rainfed cereal crops in sub-Saharan Africa. European Journal of Agronomy 155 (127137), [doi:10.1016/j.eja.2024.127137](https://doi.org/10.1016/j.eja.2024.127137)\n- Hasegawa, T., Wakatsuki, H., Ju, H. et al. (2022) A global dataset for the projected impacts of climate change on four major crops. Sci Data 9, 58. [doi:10.1038/s41597-022-01150-7](https://doi.org/10.1038/s41597-022-01150-7)\n- Yu, Q., You, L., Wood-Sichra, U., et al. (2020) A cultivated planet in 2010: 2. the global gridded agricultural production maps, Earth Syst. Sci. Data Discuss., 2020. [doi:10.5194/essd-2020-11](https://doi.org/10.5194/essd-2020-11)`;\n\n\n\n\n\n\n\nAppendix\n\n{\n  return md`---\n## Work by Topic\n*Cells that power different sections*`\n}\n\n\n\n\n\n\n\n{\n  return md`---\n### Support notebook\n[Support Notebook](https://observablehq.com/@periscopic/ab-atlas-spotlight-support): used for imports across spotlights.`\n}\n\n\n\n\n\n\n\n{\n  return md`---\n### Notebook Variables\n_Main variables across notebook_`\n}\n\n\n\n\n\n\n\n// main title of the notebook\nnotebookTitle = _lang({\n  en: \"View Projected Climate Impacts\",\n  fr: \"Visualiser les projections d’ impacts climatiques\",\n});\n\n\n\n\n\n\n\n// info for the admin selectors\nadminRegions = {\n  return {\n    labels: {\n      admin0: 'Country',\n      admin1: 'Region',\n      admin2: 'Subregion'\n    }\n  };\n}\n\n\n\n\n\n\n\nfunction getLowerLevelAdminLabel(selections = adminSelections) {\n  // based on admin selection, get the lower level label\n  if (selections.selectAdmin2) return _lang(nbText.general.subRegion);\n  if (selections.selectAdmin1) return _lang(nbText.general.subRegion);\n  if (selections.selectAdmin0) return _lang(nbText.general.region);\n  else return _lang(nbText.general.country);\n}\n\n\n\n\n\n\n\n// width of the maps\nmapWidth = 625;\n\n\n\n\n\n\n\nmd`### Language and Translation tools`;\n\n\n\n\n\n\n\nimport { Lang } from \"7d46679f7d0d917e\";\n\n\n\n\n\n\n\n_lang = Lang.lg(language.key);\n\n\n\n\n\n\n\nlanguages = [\n  { key: \"en\", label: \"English\", locale: \"en-US\" },\n  { key: \"fr\", label: \"Français\", locale: \"fr-FR\" },\n];\n\n\n\n\n\n\n\ndefaultLangKey = {\n  const name = \"lang\";\n  const list = languages.map((d) =&gt; d.key);\n  const defaultKey = \"en\";\n\n  const queryParam = await Lang.getParamFromList({ name, list });\n\n  return queryParam ?? defaultKey;\n}\n\n\n\n\n\n\n\nviewof language = Inputs.radio(languages, {\n  label: \"Main language toggle\",\n  format: (d) =&gt; d.key,\n  value: languages.find((x) =&gt; x.key === defaultLangKey),\n})\n\n\n\n\n\n\n\nnbText = new Object({\n  toc: {\n    title: { en: \"In this notebook\", fr: \"Dans ce notebook\" },\n  },\n  overview: {\n    title: { en: \"Overview\", fr: \"Vue d’Ensemble\" },\n    text: {\n      en: `Sub-Saharan Africa’s greatest challenge is to be able to feed a population of 2.1 billion people by 2050 (about 2.5x larger than today) ideally on the same amount of arable land, and under less hospitable weather conditions due to climate change. But by 2050, most of the region will experience at least 2ºC warmer temperatures. Without adaptation, climate change could have dire consequences on food supply, in particular because over 95% of crop production happens under rainfed conditions and weather variability dictates more than one-third of year-on-year yield fluctuations. Cereal grains including maize, sorghum, rice, millet, and wheat are especially important as they provide 50% of daily caloric intake across the region. In this notebook, users can investigate the projected reductions in yield for key cereal crops and the adaptation benefits of some options for specific locations.`,\n      fr: `Le plus grand défi de l'Afrique subsaharienne est de pouvoir nourrir une population de 2,1 milliards de personnes d'ici 2050 (environ 2,5 fois plus qu'aujourd'hui), idéalement sur la même quantité de terres arables, et dans des conditions météorologiques moins hospitalières en raison du changement climatique. Mais d'ici 2050, la plupart de la région connaîtra des températures au moins 2ºC plus chaudes. Sans adaptation, le changement climatique pourrait avoir des conséquences désastreuses sur l'approvisionnement alimentaire, notamment parce que plus de 95 % de la production agricole se fait sous des conditions de culture pluviale et que la variabilité climatique dicte plus d'un tiers des fluctuations annuelles des rendements. Les céréales, notamment le maïs, le sorgho, le riz, le millet et le blé, sont particulièrement importantes car elles fournissent 50 % de l'apport calorique quotidien dans toute la région. Dans ce notebook, les utilisateurs peuvent examiner les réductions projetées des rendements pour les principales cultures céréalières et les avantages de l'adaptation de certaines options pour des lieux spécifiques.`,\n    },\n  },\n  regionalPicture: {\n    title: { en: \"The Regional Picture\", fr: \"La Situation Régionale\" },\n    text: {\n      en: `The beeswarm plot visualization below helps you explore climate change impacts on maize, wheat, rice, and soybean for various regions in Sub-Saharan Africa. The impacts can be navigated by crop and levels of warming, and can be visualized with adaptation and without adaptation.`,\n      fr: `La visualisation en diagramme de nuage de points ci-dessous vous aide à explorer les impacts du changement climatique sur le maïs, le blé, le riz et le soja pour diverses régions d'Afrique subsaharienne. Les impacts peuvent être explorés par culture et par niveaux de réchauffement, et peuvent être visualisés avec ou sans adaptation.`,\n    },\n    selectors: {\n      crops: {\n        title: { en: \"Crops\", fr: \"Cultures\" },\n      },\n      warmingLevel: {\n        title: { en: \"Warming Level (℃)\", fr: \"Niveau de réchauffement (℃)\" },\n      },\n      adaptation: {\n        title: { en: \"Adaptation\", fr: \"Adaptation\" },\n        values: {\n          Yes: { en: \"Yes\", fr: \"Oui\" },\n          No: { en: \"No\", fr: \"Non\" },\n          \"All data\": { en: \"All data\", fr: \"Toutes les données\" },\n        },\n      },\n    },\n    beeswarm: {\n      xAxis: {\n        en: \"Climate impacts relative to 2005 (%)\",\n        fr: \"Impacts climatiques par rapport à 2005 (%)\",\n      },\n      yAxis: { en: \"UN Region\", fr: \"Région ONU\" },\n      regions: {\n        all: { en: \"All\", fr: \"Tous\" },\n        Western: { en: \"Western\", fr: \"Ouest\" },\n        Southern: { en: \"Southern\", fr: \"Sud\" },\n        Northern: { en: \"Northern\", fr: \"Nord\" },\n        Eastern: { en: \"Eastern\", fr: \"Est\" },\n        Central: { en: \"Central\", fr: \"Central\" },\n      },\n      legend: {\n        \"With adaptation\": { en: \"With Adaptation\", fr: \"Avec Adaptation\" },\n        \"Without adaptation\": {\n          en: \"Without Adaptation\",\n          fr: \"Sans Adaptation\",\n        },\n        Yes: { en: \"With Adaptation\", fr: \"Avec Adaptation\" },\n        No: { en: \"Without Adaptation\", fr: \"Sans Adaptation\" },\n      },\n    },\n    beeswarmInsight: {\n      title: {\n        en: `Quick insights for :::SelectedCrop::: and warming level (:::warmingLevel:::)`,\n        fr: `Aperçus rapides pour les cultures de :::SelectedCrop::: et niveau de réchauffement (:::warmingLevel:::)`,\n      },\n      text: {\n        insight1: {\n          en: `At :::warmingLevel:::, **:::crops:::** is projected to experience a median yield reduction of **:::yieldReduction:::%** if no adaptation actions are taken`,\n          fr: `À :::warmingLevel:::, les cultures sélectionnées de **:::crops:::** devraient connaître une réduction médiane des rendements de **:::yieldReduction:::%** si aucune mesure d'adaptation n'est prise.`,\n        },\n        insight2: {\n          main: {\n            en: `The most negatively impacted region is :::mostAffected:::`,\n            fr: `La région la plus négativement impactée est :::mostAffected:::`,\n          },\n          mostAffected: {\n            en: `The most negatively impacted region is **:::mostAffected_adaptation:::** with adaptation and **:::mostAffected_noadaptation:::** without adaptation`,\n            fr: `La région la plus négativement impactée est **:::mostAffected_adaptation:::** avec adaptation et **:::mostAffected_noadaptation:::** sans adaptation`,\n          },\n        },\n        insight3: {\n          compelling: {\n            en: `Adaptation can offset these projected :::loss_gain::: with yield changes under adaptation being **:::withAdaptation:::%**.`,\n            fr: `L'adaptation peut compenser ces projections de pertes avec des changements de rendement sous adaptation étant de **:::withAdaptation:::%**.`,\n          },\n          notCompelling: {\n            en: \"No compelling evidence of adaptation benefits exists in our data\",\n            fr: \"Aucune preuve convaincante des avantages de l'adaptation n'existe dans nos données.\",\n          },\n        },\n      },\n      regions: {\n        \"Western Africa\": { en: \"Western Africa\", fr: \"L’Afrique de l’Ouest\" },\n        \"Southern Africa\": { en: \"Southern Africa\", fr: \"L’Afrique du Sud\" },\n        \"Northern Africa\": { en: \"Northern Africa\", fr: \"L’Afrique du Nord\" },\n        \"Eastern Africa\": { en: \"Eastern Africa\", fr: \"L’Afrique de l’Est\" },\n        \"Central Africa\": { en: \"Central Africa\", fr: \"L’Afrique Centrale\" },\n      },\n    },\n  },\n  zoomToStable: {\n    title: {\n      en: \"Zooming Into Africa’s Staple Cereal Crops\",\n      fr: \"Un zoom sur les cultures céréalières de base en Afrique\",\n    },\n    text: {\n      en: `Global and regional averages hide a much more nuanced story about climate impacts on crop yield at national and subnational scales. Moreover, future scenarios also matter, with the trajectory of climate change inducing different levels of impact. This section navigates through country-level and within-country variation in projected impacts on crop yield using crop model-based projections.`,\n      fr: `Les moyennes mondiales et régionales masquent une histoire bien plus nuancée des impacts climatiques sur les rendements des cultures à l'échelle nationale et infranationale. De plus, les scénarios futurs sont également importants, la trajectoire du changement climatique induisant différents niveaux d'impact. Cette section explore les variations au niveau des pays et à l'intérieur des pays concernant les impacts projetés sur les rendements des cultures en utilisant des projections basées sur des modèles de culture.`,\n    },\n    selectors: {\n      growSeason: {\n        title: { en: \"Growing Season\", fr: \"Saison de croissance\" },\n        values: {\n          both: { en: \"Both (Average)\", fr: \"Les deux (Moyenne)\" },\n          first: { en: \"First\", fr: \"Première\" },\n          second: { en: \"Second\", fr: \"Deuxième\" },\n        },\n      },\n      YieldOutput: {\n        title: { en: \"Yield Output\", fr: \"Production de rendement\" },\n        values: {\n          \"Yield change (ton/ha)\": {\n            en: \"Yield change (ton/ha)\",\n            fr: \"Changement de rendement (tonnes/ha)\",\n          },\n          \"Yield (ton/ha)\": {\n            en: \"Yield (ton/ha)\",\n            fr: \"Rendement (tonnes/ha)\",\n          },\n          \"Yield change (%)\": {\n            en: \"Yield change (%)\",\n            fr: \"Changement de rendement (%)\",\n          },\n          \"Uncertainty in yield (ton/ha)\": {\n            en: \"Uncertainty in yield (ton/ha)\",\n            fr: \"Incertitude du rendement (tonnes/ha)\",\n          },\n        },\n      },\n      Cultivar: {\n        title: { en: \"Cultivar\", fr: \"Cultivar\" },\n        values: {\n          current: { en: \"Current\", fr: \"Actuel\" },\n          early: { en: \"Early maturity\", fr: \"Maturité précoce\" },\n          late: { en: \"Late maturity\", fr: \"Maturité tardive\" },\n        },\n      },\n      layer: {\n        title: { en: \"Map Layer\", fr: \"Couche de la carte\" },\n        values: {\n          rainfed: {\n            en: \"Mean rainfed potential yield\",\n            fr: \"Rendement potentiel moyen en culture pluviale\",\n          },\n          irrigated: {\n            en: \"Mean irrigated potential yield\",\n            fr: \"Rendement potentiel moyen en culture irriguée\",\n          },\n        },\n      },\n    },\n    MapInsight: {\n      title: {\n        en: \"Quick Insights for :::geography:::, under :::scenario_selection::: for :::crop_selection:::\",\n        fr: \"Aperçu rapide pour la région de :::geography:::, sous :::scenario_selection::: pour les cultures de :::crop_selection:::\",\n      },\n      insight1: {\n        // en:  \":::geography:::’s :::scenario_selection::: :::crop_selection::: rainfed/irrigated :::yield_selection::: is **:::value:::**\",\n        en: \"The :::yield_selection::: for  :::crop_selection::: is **:::value:::**\",\n        fr: \"Le changement de rendement des cultures de :::crop_selection::: en culture pluviale :::yield_selection::: est de **:::value:::**\",\n        // fr:  \":::geography:::’s :::scenario_selection::: :::crop_selection::: rainfed/irrigated :::yield_selection::: is **:::value:::**\"\n      },\n      insight2: {\n        en: \"A climate change scenario with :::emission_level::: emissions by **:::horizon:::** has a **:::change_type:::** impact on yield of :::impact_pct:::  :::change_unit:::\",\n        fr: \"Un scénario de changement climatique avec des :::emission_level::: d'ici **:::horizon:::** a un impact **:::change_type:::** sur le rendement de :::impact_pct:::  :::change_unit:::\",\n      },\n      insight3: {\n        en: \"The projected yield changes arise from simulating yield under various plausible futures, which implies uncertainty. Accordingly, the range of projected changes is **:::minChange:::%** to **:::maxChange:::%** across the climate models used\",\n        fr: \"Les projections de changements de rendement résultent de la simulation du rendement sous divers futurs plausibles, ce qui implique une incertitude. En conséquence, l’intervalle de projection de changement est de **:::minChange:::%** à **:::maxChange:::%** à travers les modèles climatiques utilisés.\",\n      },\n      insight4: {\n        en: \"Across all of Sub-Saharan Africa, :::geography::: ranks :::rank::: out of :::num::: :::adminLvl::: at the same level, with regard to absolute yield changes\",\n        fr: \"Dans toute l'Afrique subsaharienne, :::geography::: se classe :::rank::: sur :::num::: au même niveau, en ce qui concerne les changements absolus de rendement\",\n      },\n    },\n  },\n  adaptFutureChange: {\n    title: {\n      en: \"Adapting To The Future Changes\",\n      fr: \"S'adapter aux changements futurs\",\n    },\n    text: {\n      en: `Adaptation is no longer optional, it is a must-do for all Sub-Saharan African countries. This section allows exploring some adaptation solutions, and their specific benefits across and within countries in the region.`,\n      fr: `L'adaptation n'est plus optionnelle, elle est incontournable pour tous les pays d'Afrique subsaharienne. Cette section permet d'explorer certaines solutions d'adaptation et leurs avantages spécifiques à travers les pays et au sein des pays de la région.`,\n    },\n    selectors: {\n      sort: {\n        title: { en: \"Sort\", fr: \"Trier\" },\n        values: {\n          noAdapt: { en: \"No adaptation\", fr: \"Sans adaptation\" },\n          meanDiff: { en: \"Mean difference\", fr: \"Différence moyenne\" },\n          alphabet: { en: \"Alphabetical\", fr: \"Alphabétique\" },\n        },\n      },\n      confidence: {\n        title: { en: \"Confidence intervals\", fr: \"Intervalles de confiance\" },\n        visible: { en: \"Visible\", fr: \"Visible\" }, // Added in even though same to make adding/updating easier\n      },\n    },\n    plot: {\n      yAxis: {\n        \"Late maturity, irrigation\": {\n          en: \"Late maturity - irrigation\",\n          fr: \"Maturité tardive - irrigation\",\n        },\n        \"Current cultivar, irrigation\": {\n          en: \"Current cultivar - irrigation\",\n          fr: \"Cultivar actuel - irrigation\",\n        },\n        \"Early maturity, irrigation\": {\n          en: \"Early maturity - irrigation\",\n          fr: \"Maturité précoce - irrigation\",\n        },\n        \"Late maturity, no irrigation\": {\n          en: \"Late maturity - no irrigation\",\n          fr: \"Maturité tardive - sans irrigation\",\n        },\n        \"No adaptation\": { en: \"No adaptation\", fr: \"Sans adaptation\" },\n        \"Early maturity, no irrigation\": {\n          en: \"Early maturity - no irrigation\",\n          fr: \"Maturité précoce - sans irrigation\",\n        },\n      },\n      xAxis: {\n        title: { en: \"Yield (ton/ha)\", fr: \"Rendement (tonnes/ha)\" },\n      },\n      channels: {\n        aez: { en: \"Horizon\", fr: \"Horizon\" },\n        nObs: { en: \"Observations\", fr: \"Observations\" },\n        diff: { en: \"Mean\", fr: \"Moyenne\" }, // Was mean difference but it is actuall just mean value\n        control: { en: \"Mean control\", fr: \"Moyenne du témoin\" },\n        prac: { en: \"adaptation\", fr: \"Adaptation\" },\n        ciLow: {\n          en: \"Lower Confidence interval\",\n          fr: \"Intervalle de confiance inférieur\",\n        },\n        ciHigh: {\n          en: \"Upper Confidence interval\",\n          fr: \"Intervalle de confiance supérieur\",\n        },\n      },\n    },\n    insight: {\n      title: {\n        en: \"Quick Insights for :::geography:::, :::scenario_name::: scenario, and :::crop_name:::\",\n        fr: \"Aperçu rapide pour la région de :::geography:::, sous :::scenario_name::: pour les cultures de :::crop_name:::\",\n      },\n      insight1: {\n        en: \":::selected_geo:::'s adaptation analysis show that :::numBetter::: options would generate yield improvements for historical and future periods. These improvements vary between :::lowerBest::: (ton/ha) to :::upperBest::: (ton/ha) compared to no adaptation\",\n        fr: \"L'analyse d'adaptation :::selected_geo::: montre que :::numBetter::: options généreraient des améliorations de rendement pour les périodes historiques et futures. Ces améliorations varient entre :::lowerBest::: (tonnes/ha) - :::upperBest::: (tonnes/ha) par rapport à l'absence d'adaptation.\",\n      },\n      insight2: {\n        en: \"Adaptation options with the greatest benefits include :::bestOptions:::, which together can generate yield gains of up to :::maxImprovement::: ton/ha compared to a no adaptation situation\",\n        fr: \"Les options d'adaptation avec les plus grands bénéfices incluent :::bestOptions:::, qui ensemble peuvent générer des gains de rendement allant jusqu'à :::maxImprovement::: (tonne/ha) par rapport à une situation sans adaptation.\",\n      },\n      insight3: {\n        en: \"Explore more adaptation options for a greater number of crops and systems at our notebook on [On-farm Solutions for Today](https://observablehq.com/d/7539fd16f4fc40e3)\",\n        fr: \"Explorez plus d'options d'adaptation pour un plus grand nombre de cultures et de systèmes dans notre notebook sur [les solutions agricoles pour aujourd'hui](https://observablehq.com/d/7539fd16f4fc40e3)\",\n      },\n    },\n  },\n  summary: {\n    title: { en: \"Summary\", fr: \"Résumé\" },\n    text1: {\n      en: \"Climate change without adaptation implies a reduction of :::avg_loss:::% in the supply of cereal grains in Sub-Saharan Africa\",\n      fr: \"Le changement climatique sans adaptation implique une réduction de :::avg_loss:::% de l'approvisionnement en céréales en Afrique subsaharienne.\",\n    },\n    text2: {\n      en: `Specifically in :::selectedGeo:::, these reductions would come on top of already low yields from inadequate crop management. Adaptation investments should target **:::bestOptions:::** to reduce downstream risks of food insecurity, hunger, and poverty that may stem from projected yield reductions.`,\n      fr: `En particulier :::selectedGeo:::, ces réductions s'ajouteraient à des rendements déjà faibles dus à une gestion inadéquate des cultures. Les investissements dans l'adaptation devraient cibler  **:::bestOptions:::** pour réduire les risques en aval d'insécurité alimentaire, de faim et de pauvreté qui pourraient découler des réductions de rendement projetées.`,\n    },\n    adaptationOptions: {\n      \"Late maturity, irrigation\": {\n        en: \"late maturity with irrigation\",\n        fr: \"maturité tardive avec irrigation\",\n      },\n      \"Current cultivar, irrigation\": {\n        en: \"current cultivar with irrigation\",\n        fr: \"cultivar actuel avec irrigation\",\n      },\n      \"Early maturity, irrigation\": {\n        en: \"early maturity with irrigation\",\n        fr: \"maturité précoce avec irrigation\",\n      },\n      \"Late maturity, no irrigation\": {\n        en: \"late maturity with no irrigation\",\n        fr: \"maturité tardive sans irrigation\",\n      },\n      \"Early maturity, no irrigation\": {\n        en: \"early maturity with no irrigation\",\n        fr: \"maturité précoce sans irrigation\",\n      },\n    },\n  },\n  MethodsSources: {\n    title: { en: \"Methods & Sources\", fr: \"Méthodes et sources\" },\n    sources: {\n      title: { en: \"Datasets\", fr: \"Jeux de données\" },\n      cropYieldDB: {\n        title: {\n          en: \"Crop yield meta-analysis database\",\n          fr: \"Base de données de méta-analyse des rendements des cultures\",\n        },\n        text: {\n          en: `The crop yield meta analysis dataset is from [Hasegawa et al. (2022)](https://doi.org/10.1038/s41597-022-01150-7). This dataset compiles estimates of climate change impacts on crop productivity derived from crop simulations under historical and future climates, with and without adaptation. The climate change impact estimates are derived from a comprehensive literature review of 202 studies published between 1984 and 2020. The dataset includes a total of 8,703 individual simulations, covers four crops (maize, rice, soybean, and wheat), and extends to 91 countries across the globe. The data include crop yield estimates under historical and future climates (for various emissions trajectories), current and future temperature and precipitation levels, and the use (or not) of adaptation options.`,\n          fr: `Le jeu de données de méta-analyse des rendements des cultures provient de [Hasegawa et al. (2022)](https://doi.org/10.1038/s41597-022-01150-7). Ce jeu de données compile des estimations des impacts du changement climatique sur la productivité des cultures dérivées de simulations de cultures sous climats historiques et futurs, avec et sans adaptation. Les estimations des impacts du changement climatique sont dérivées d'une revue complète de la littérature de 202 études publiées entre 1984 et 2020. Le jeu de données inclut un total de 8 703 simulations individuelles, couvre quatre cultures (maïs, riz, soja et blé), et s'étend à 91 pays à travers le monde. Les données comprennent des estimations des rendements des cultures sous climats historiques et futurs (pour divers scénarios d'émissions), les niveaux actuels et futurs de température et de précipitations, et l'utilisation (ou non) des options d'adaptation.`,\n        },\n      },\n      cropYieldProjections: {\n        title: {\n          en: \"Crop yield projections for cereals under climate change and adaptation\",\n          fr: \"Projections de rendements des céréales sous l'effet du changement climatique et de l'adaptation\",\n        },\n        text: {\n          en: `The historical and future simulated crop yield for maize, sorghum, millet, and wheat were derived from the [Global Yield Gap Atlas (GYGA)](https://www.yieldgap.org/). The method for deriving these data is described by [Alimagham et al. (2024)](https://doi.org/10.1016/j.eja.2024.127137). In brief, the WOFOST (World Food Studies) crop model is used to simulate water-limited and potential (i.e., irrigated) production of each of the four crops across 109 reference weather station locations in Sub-Saharan Africa. The historical weather data (1995–2014) were derived from local weather stations, whereas the future climate data for 2030 (2021-2040) and 2050 (2041–2060) are from bias-corrected General Circulation Models (GCMs) from the Coordinated Modelling Intercomparison Project-Phase 6 (CMIP6). The GCMs were GFDL-ESM4, IPSL-CM6A-LR, MPI-ESM1–2-HR, MRI-ESM2–0, and UKESM1–0-LL. Two Shared Socioeconomic Pathways (SSPs) were used, namely, SSP3-7.0 and SSP5-8.5. The bias correction of the future weather data uses the delta method, as documented by [Navarro-Racines et al. (2020)](https://doi.org/10.1038/s41597-019-0343-8). Carbon dioxide (CO2) concentrations were specified for each future scenario and time period.\n\nThe crop model also requires soil and management (cultivar, planting dates) data as inputs. These data are available through the GYGA portal. Originally, these data have been collected and evaluated through an extensive network of agronomists and crop modelers that make part of the GYGA project. Cultivars are specified using thermal times derived from locally available planting, flowering, and maturity times. In addition to current cultivars, simulations are also conducted for ‘late maturity’ (12% longer thermal time) and ‘early maturity’ (12% shorter thermal time) cultivars. Soil data were obtained from the Africa Soil Information Service ([AfSIS](https://www.isric.org/projects/africa-soil-information-service-afsis)). At each weather station location, estimates of yield, phenology (planting, flowering, harvest time) were used into a random forest (RF) regressor that helped create extrapolated estimates of yield and phenology across the entirety of Sub-Saharan Africa using gridded weather data from elsewhere in the continent. The RF regressor explains over 90% of the variance in the WOFOST simulated yield, tested out of sample across scenarios and locations.\n\nGYGA simulated crop yield reports two types of adaptations, namely, shifts in cultivars, and irrigation. For cultivars, early and late maturity (in addition to currently used cultivars) are reported. For irrigation, a fully irrigated crop model simulation is available. The full combinatorial (i.e., each cultivar with and without irrigation) of these is available. This allows exploring five adaptation scenarios, in addition to the no adaptation (i.e., rainfed, current cultivar) scenario. All GYGA data are available at  https://www.yieldgap.org/. Specific licensing arrangements depending on user and/or institution type are described [here](https://www.yieldgap.org/web/guest/subscription-and-service).`,\n          fr: `Les rendements historiques et futurs simulés pour le maïs, le sorgho, le millet et le blé ont été dérivés du [Global Yield Gap Atlas (GYGA)](https://www.yieldgap.org/). La méthode pour obtenir ces données est décrite par [Alimagham et al. (2024)](https://doi.org/10.1016/j.eja.2024.127137). En résumé, le modèle de culture WOFOST (World Food Studies) est utilisé pour simuler la production sous contrainte hydrique et la production potentielle (c'est-à-dire irriguée) de chacune des quatre cultures dans 109 stations météorologiques de référence en Afrique subsaharienne. Les données météorologiques historiques (1995-2014) proviennent de stations météorologiques locales, tandis que les données climatiques futures pour 2030 (2021-2040) et 2050 (2041-2060) proviennent de modèles de circulation générale (GCM) corrigés des biais du projet de comparaison de modèles coordonnés - Phase 6 (CMIP6). Les GCM utilisés étaient GFDL-ESM4, IPSL-CM6A-LR, MPI-ESM1-2-HR, MRI-ESM2-0, et UKESM1-0-LL. Deux trajectoires socio-économiques partagées (SSP) ont été utilisées, à savoir SSP3-7.0 et SSP5-8.5. La correction des biais des données climatiques futures utilise la méthode delta, comme documenté par [Navarro-Racines et al. (2020)](https://doi.org/10.1038/s41597-019-0343-8). Les concentrations de dioxyde de carbone (CO2) étaient spécifiées pour chaque scénario futur et chaque période.\n\nLe modèle de culture nécessite également des données sur le sol et la gestion (cultivar, dates de plantation) comme entrées. Ces données sont disponibles via le portail GYGA. À l'origine, ces données ont été collectées et évaluées grâce à un vaste réseau d'agronomes et de modélisateurs de cultures faisant partie du projet GYGA. Les cultivars sont spécifiés en utilisant les temps thermiques dérivés des périodes de plantation, de floraison et de maturité disponibles localement. En plus des cultivars actuels, des simulations sont également effectuées pour des cultivars de \"maturité tardive\" (temps thermique 12% plus long) et de \"maturité précoce\" (temps thermique 12% plus court). Les données sur les sols ont été obtenues auprès du service d'information sur les sols en Afrique ([AfSIS](https://www.isric.org/projects/africa-soil-information-service-afsis)). À chaque station météorologique, les estimations de rendement et de phénologie (plantation, floraison, récolte) ont été utilisées dans un régressif par forêt aléatoire (RF) qui a permis de créer des estimations extrapolées de rendement et de phénologie pour l'ensemble de l'Afrique subsaharienne en utilisant des données météorologiques maillées provenant d'ailleurs sur le continent. Le régressif RF explique plus de 90% de la variance dans le rendement simulé par WOFOST, testé hors échantillon à travers des scénarios et des lieux.\n\nGYGA rapporte deux types d'adaptations pour les rendements simulés, à savoir les changements de cultivars et l'irrigation. Pour les cultivars, les maturités précoce et tardive (en plus des cultivars actuellement utilisés) sont rapportées. Pour l'irrigation, une simulation de modèle de culture entièrement irriguée est disponible. La combinaison complète (c'est-à-dire chaque cultivar avec et sans irrigation) de ces scénarios est disponible. Cela permet d'explorer cinq scénarios d'adaptation, en plus du scénario sans adaptation (c'est-à-dire pluvial, cultivar actuel). Toutes les données GYGA sont disponibles sur https://www.yieldgap.org/. Les arrangements de licence spécifiques en fonction du type d'utilisateur et/ou d'institution sont décrits [ici](https://www.yieldgap.org/web/guest/subscription-and-service).`,\n        },\n      },\n      harvestedArea: {\n        title: { en: \"Harvested Area\", fr: \"Superficie récoltée\" },\n        text: {\n          en: `[Harvested area data](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/exposure_catalog/mapspam2017/crop_ha/crop_ha.json) comes from  MapSPAM 2017 V2r3 (Spatial Production Allocation Model). This dataset is an updated version of MapSPAM specifically tailored for this project. It includes bug fixes and incorporates more data sources and at greater resolution. The MapSPAM methodology is fully documented by [Yu et al. (2020)](https://doi.org/10.5194/essd-2020-11).`,\n          fr: `[Les données de superficie récoltée](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/exposure_catalog/mapspam2017/crop_ha/crop_ha.json?.language=fr) proviennent de MapSPAM 2017 V2r3 (Spatial Production Allocation Model). Ce jeu de données est une version mise à jour de MapSPAM spécifiquement adaptée à ce projet. Il comprend des corrections de bogues et intègre davantage de sources de données avec une résolution plus élevée. La méthodologie de MapSPAM est entièrement documentée par [Yu et al. (2020)](https://doi.org/10.5194/essd-2020-11).`,\n        },\n      },\n      boundaries: {\n        title: { en: \"Boundaries\", fr: \"Délimitations\" },\n        text: {\n          en: `[Administrative areas](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/boundary_catalog/geoBoundaries_SSA/collection.json) used in this notebook come from [geoBoundaries 6.0.0](https://github.com/wmgeolab/geoBoundaries). The gbHumanitarian boundaries are used and if not available then the gbOpen boundaries are substituted.`,\n          fr: `[Les zones administratives](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/boundary_catalog/geoBoundaries_SSA/collection.json?.language=fr) utilisées dans ce notebook proviennent de [geoBoundaries 6.0.0](https://github.com/wmgeolab/geoBoundaries). Les frontières gbHumanitarian sont utilisées et, si elles ne sont pas disponibles, les frontières gbOpen sont substituées.`,\n        },\n      },\n    },\n    methods: {\n      title: { en: \"Methods\", fr: \"Méthodologie\" },\n      beeswarm: {\n        title: {\n          en: \"Crop yield meta analysis (beeswarm plot)\",\n          fr: \"Méta-analyse des rendements des cultures (diagramme de nuage de points)\",\n        },\n        text: {\n          en: `We produced a beeswarm plot that shows the individual estimates of crop yield from the meta-analysis dataset. We subset the original dataset to cover only Sub-Saharan Africa (SSA), and display data per region within SSA. We allow splits of the data for visualization by warming levels, crops, and adaptation (with and without adaptation).`,\n          fr: `Nous avons produit un diagramme de nuage de points qui montre les estimations individuelles des rendements des cultures à partir du jeu de données de méta-analyse. Nous avons extrait un sous-ensemble du jeu de données original pour ne couvrir que l'Afrique subsaharienne (SSA), et afficher les données par région au sein de la SSA. Nous permettons de diviser les données pour la visualisation par niveaux de réchauffement, cultures, et adaptation (avec et sans adaptation).`,\n        },\n      },\n      mappingHistoricalFuture: {\n        title: {\n          en: \"Mapping historical and future projected crop yields\",\n          fr: \"Cartographie des rendements des cultures historiques et projetés futurs\",\n        },\n        text: {\n          en: `We aggregate GYGA’s crop yield projections at three administrative levels, namely, national, subnational level 1 (referred to as region across the notebook), and subnational level 2 (referred to as subregion across the notebook). The aggregation uses the weighted average of the crop yield and the harvested area present within the point location where a WOFOST simulation has been conducted, within the respective administrative boundaries. Data aggregation is done for rainfed and irrigated crop yields, for each crop, and for each scenario (period and Shared Socioeconomic Pathway –SSP) separately. Four indicators are mapped, namely, the average yield (in ton/ha), the yield change (in ton/ha), yield change (in percentage), and the uncertainty in yield (in ton/ha). For the latter, the individual climate model projections are used to compute the range (max. – min.) across the individual GCM projections.`,\n          fr: `Nous agrégeons les projections de rendement des cultures de GYGA à trois niveaux administratifs, à savoir, national, sous-national niveau 1 (appelé région dans le notebook), et sous-national niveau 2 (appelé sous-région dans le notebook). L'agrégation utilise la moyenne pondérée du rendement des cultures et de la superficie récoltée présente à l'emplacement où une simulation WOFOST a été réalisée, dans les limites administratives respectives. L'agrégation des données est effectuée pour les rendements des cultures en sec et irriguées, pour chaque culture, et pour chaque scénario (période et Trajectoire Socio-économique Partagée – SSP) séparément. Quatre indicateurs sont cartographiés, à savoir, le rendement moyen (en tonnes/ha), le changement de rendement (en tonnes/ha), le changement de rendement (en pourcentage), et l'incertitude du rendement (en tonnes/ha). Pour ce dernier, les projections individuelles des modèles climatiques sont utilisées pour calculer l'écart (max. – min.) entre les projections individuelles des GCM.`,\n        },\n      },\n      adaptationAnalysis: {\n        title: { en: \"Analysis of adaptation\", fr: \"Analyse de l'adaptation\" },\n        text: {\n          en: `We display the mean yield of each adaptation option as simulated for each of the crops, for each climate scenario, and at different administrative boundary levels, namely, all Sub-Saharan Africa, national, subnational level 1, and subnational level 2. The objective is to provide a clear overview of the simulated yield level in the historical and future scenarios without adaptation, and the comparative performance of the various adaptation solutions against the no adaptation scenario. Crop yield is aggregated using weighted average against the MapSPAM harvested area. Confidence intervals extend to 5–95% of the individual GCMs (of which there are five).`,\n          fr: `Nous affichons le rendement moyen de chaque option d'adaptation tel que simulé pour chacune des cultures, pour chaque scénario climatique, et à différents niveaux de limites administratives, à savoir, toute l'Afrique subsaharienne, national, sous-national niveau 1 et sous-national niveau 2. L'objectif est de fournir une vue d'ensemble claire du niveau de rendement simulé dans les scénarios historiques et futurs sans adaptation, et de la performance comparative des différentes solutions d'adaptation par rapport au scénario sans adaptation. Le rendement des cultures est agrégé en utilisant la moyenne pondérée par rapport à la superficie récoltée de MapSPAM. Les intervalles de confiance s'étendent de 5 à 95 % des modèles climatiques globaux (GCM) individuels (dont il y en a cinq).`,\n        },\n      },\n      references: {\n        title: { en: \"References\", fr: \"Références\" },\n      },\n    },\n  },\n  appendix: {\n    title: { en: \"Appendix\", fr: \"Annexes\" },\n    text: {\n      en: \"This large section includes all the cells that power the notebook.This large section includes all the cells that power the notebook.\",\n      fr: \"Cette grande section comprend toutes les cellules qui alimentent le notebook\",\n    },\n  },\n  general: {\n    positive: { en: \"positive\", fr: \"positif\" },\n    negative: { en: \"negative\", fr: \"négatif\" },\n    crops: {\n      maize: { en: \"Maize\", fr: \"Maïs\" },\n      rice: { en: \"Rice\", fr: \"Riz\" },\n      wheat: { en: \"Wheat\", fr: \"Blé\" },\n      sorghum: { en: \"Sorghum\", fr: \"Sorgho\" },\n      millet: { en: \"Millet\", fr: \"Millet\" },\n    },\n    crop: { en: \"Crop\", fr: \"Culture\" },\n    country: { en: \"Country\", fr: \"Pays\" },\n    region: { en: \"Region\", fr: \"Région\" },\n    subRegion: { en: \"Sub-Region\", fr: \"Sous-région\" },\n    scenario: { en: \"Scenario\", fr: \"Scénario\" },\n    historical: { en: \"Historical\", fr: \"Historique\" },\n    noData: { en: \"No Data\", fr: \"\" },\n    greyNoData: {\n      en: \"Grey regions signal lack of data\",\n      fr: \"Les régions grises indiquent un manque de données\",\n    },\n    emission_ssp370: { en: \"Moderate emissions\", fr: \"émissions modérées\" },\n    emission_ssp585: { en: \"High emissions\", fr: \"émissions élevées\" },\n    countries_article: {\n      Angola: { en: \"Angola\", fr: \"En Angola\" },\n      Benin: { en: \"Benin\", fr: \"Au Bénin\" },\n      Botswana: { en: \"Botswana\", fr: \"Au Botswana\" },\n      \"Burkina Faso\": { en: \"Burkina Faso\", fr: \"Au Burkina Faso\" },\n      Burundi: { en: \"Burundi\", fr: \"Au Burundi\" },\n      Cameroon: { en: \"Cameroon\", fr: \"Au Cameroun\" },\n      \"Central African Republic\": {\n        en: \"Central African Republic\",\n        fr: \"En République Centrafricaine\",\n      },\n      Chad: { en: \"Chad\", fr: \"Au Tchad\" },\n      \"Congo - Brazzaville\": {\n        en: \"Congo - Brazzaville\",\n        fr: \"Au Congo - Brazzaville\",\n      },\n      \"Congo - Kinshasa\": { en: \"Congo - Kinshasa\", fr: \"Au Congo - Kinshasa\" },\n      \"Côte d'Ivoire\": { en: \"Côte d'Ivoire\", fr: \"En Côte d'Ivoire\" },\n      Djibouti: { en: \"Djibouti\", fr: \"A Djibouti\" },\n      \"Equatorial Guinea\": {\n        en: \"Equatorial Guinea\",\n        fr: \"En Guinée Équatoriale\",\n      },\n      Eritrea: { en: \"Eritrea\", fr: \"En Érythrée\" },\n      Eswatini: { en: \"Eswatini\", fr: \"En Eswatini\" },\n      Ethiopia: { en: \"Ethiopia\", fr: \"En Éthiopie\" },\n      Gabon: { en: \"Gabon\", fr: \"Au Gabon\" },\n      Gambia: { en: \"Gambia\", fr: \"En Gambie\" },\n      Ghana: { en: \"Ghana\", fr: \"Au Ghana\" },\n      Guinea: { en: \"Guinea\", fr: \"En Guinée\" },\n      \"Guinea-Bissau\": { en: \"Guinea-Bissau\", fr: \"En Guinée-Bissau\" },\n      Kenya: { en: \"Kenya\", fr: \"Au Kenya\" },\n      Lesotho: { en: \"Lesotho\", fr: \"Au Lesotho\" },\n      Liberia: { en: \"Liberia\", fr: \"Au Libéria\" },\n      Madagascar: { en: \"Madagascar\", fr: \"À Madagascar\" },\n      Malawi: { en: \"Malawi\", fr: \"Au Malawi\" },\n      Mali: { en: \"Mali\", fr: \"Au Mali\" },\n      Mauritania: { en: \"Mauritania\", fr: \"En Mauritanie\" },\n      Mozambique: { en: \"Mozambique\", fr: \"Au Mozambique\" },\n      Namibia: { en: \"Namibia\", fr: \"En Namibie\" },\n      Niger: { en: \"Niger\", fr: \"Au Niger\" },\n      Nigeria: { en: \"Nigeria\", fr: \"Au Nigéria\" },\n      Rwanda: { en: \"Rwanda\", fr: \"Au Rwanda\" },\n      Senegal: { en: \"Senegal\", fr: \"Au Sénégal\" },\n      \"Sierra Leone\": { en: \"Sierra Leone\", fr: \"À Sierra Leone\" },\n      Somalia: { en: \"Somalia\", fr: \"En Somalie\" },\n      \"South Africa\": { en: \"South Africa\", fr: \"En Afrique du Sud\" },\n      \"South Sudan\": { en: \"South Sudan\", fr: \"Au Soudan du Sud\" },\n      Sudan: { en: \"Sudan\", fr: \"Au Soudan\" },\n      Tanzania: { en: \"Tanzania\", fr: \"En Tanzanie\" },\n      Togo: { en: \"Togo\", fr: \"Au Togo\" },\n      Uganda: { en: \"Uganda\", fr: \"En Ouganda\" },\n      Zambia: { en: \"Zambia\", fr: \"En Zambie\" },\n      Zimbabwe: { en: \"Zimbabwe\", fr: \"Au Zimbabwe\" },\n      SSA: { en: \"Sub-Saharan Africa\", fr: \"En Afrique Subsaharienne\" },\n    },\n    country_article2: {\n      Angola: { en: \"Angola\", fr: \"L’Angola\" },\n      Benin: { en: \"Benin\", fr: \"Le Bénin\" },\n      Botswana: { en: \"Botswana\", fr: \"Le Botswana\" },\n      \"Burkina Faso\": { en: \"Burkina Faso\", fr: \"Le Burkina Faso\" },\n      Burundi: { en: \"Burundi\", fr: \"Le Burundi\" },\n      Cameroon: { en: \"Cameroon\", fr: \"Le Cameroun\" },\n      \"Central African Republic\": {\n        en: \"Central African Republic\",\n        fr: \"La République Centrafricaine\",\n      },\n      Chad: { en: \"Chad\", fr: \"Le Tchad\" },\n      \"Congo - Brazzaville\": {\n        en: \"Congo - Brazzaville\",\n        fr: \"Le Congo - Brazzaville\",\n      },\n      \"Congo - Kinshasa\": { en: \"Congo - Kinshasa\", fr: \"Le Congo - Kinshasa\" },\n      \"Côte d'Ivoire\": { en: \"Côte d'Ivoire\", fr: \"La Côte d'Ivoire\" },\n      Djibouti: { en: \"Djibouti\", fr: \"Djibouti\" },\n      \"Equatorial Guinea\": {\n        en: \"Equatorial Guinea\",\n        fr: \"La Guinée Équatoriale\",\n      },\n      Eritrea: { en: \"Eritrea\", fr: \"L’Érythrée\" },\n      Eswatini: { en: \"Eswatini\", fr: \"L’Eswatini\" },\n      Ethiopia: { en: \"Ethiopia\", fr: \"L’Éthiopie\" },\n      Gabon: { en: \"Gabon\", fr: \"Le Gabon\" },\n      Gambia: { en: \"Gambia\", fr: \"La  Gambie\" },\n      Ghana: { en: \"Ghana\", fr: \"Le Ghana\" },\n      Guinea: { en: \"Guinea\", fr: \"La Guinée\" },\n      \"Guinea-Bissau\": { en: \"Guinea-Bissau\", fr: \"La Guinée-Bissau\" },\n      Kenya: { en: \"Kenya\", fr: \"Le Kenya\" },\n      Lesotho: { en: \"Lesotho\", fr: \"Le Lesotho\" },\n      Liberia: { en: \"Liberia\", fr: \"Le Libéria\" },\n      Madagascar: { en: \"Madagascar\", fr: \"Madagascar\" },\n      Malawi: { en: \"Malawi\", fr: \"Le Malawi\" },\n      Mali: { en: \"Mali\", fr: \"Le Mali\" },\n      Mauritania: { en: \"Mauritania\", fr: \"La Mauritanie\" },\n      Mozambique: { en: \"Mozambique\", fr: \"Le Mozambique\" },\n      Namibia: { en: \"Namibia\", fr: \"La Namibie\" },\n      Niger: { en: \"Niger\", fr: \"Le Niger\" },\n      Nigeria: { en: \"Nigeria\", fr: \"Le Nigéria\" },\n      Rwanda: { en: \"Rwanda\", fr: \"Le Rwanda\" },\n      Senegal: { en: \"Senegal\", fr: \"Le Sénégal\" },\n      \"Sierra Leone\": { en: \"Sierra Leone\", fr: \"Sierra Leone\" },\n      Somalia: { en: \"Somalia\", fr: \"La Somalie\" },\n      \"South Africa\": { en: \"South Africa\", fr: \"L’Afrique du Sud\" },\n      \"South Sudan\": { en: \"South Sudan\", fr: \"Le Soudan du Sud\" },\n      Sudan: { en: \"Sudan\", fr: \"Le Soudan\" },\n      Tanzania: { en: \"Tanzania\", fr: \"La Tanzanie\" },\n      Togo: { en: \"Togo\", fr: \"Le Togo\" },\n      Uganda: { en: \"Uganda\", fr: \"L’Ouganda\" },\n      Zambia: { en: \"Zambia\", fr: \"La Zambie\" },\n      Zimbabwe: { en: \"Zimbabwe\", fr: \"Le Zimbabwe\" },\n      SSA: { en: \"SSA\", fr: \"L’Afrique Subsaharienne\" },\n    },\n    adminNames: {\n      \"Full Country\": { en: \"Full Country\", fr: \"Pays Entier\" },\n      Angola: {\n        en: \"Angola\",\n        fr: \"Angola\",\n      },\n      Benin: {\n        en: \"Benin\",\n        fr: \"Bénin\",\n      },\n      Botswana: {\n        en: \"Botswana\",\n        fr: \"Botswana\",\n      },\n      \"Burkina Faso\": {\n        en: \"Burkina Faso\",\n        fr: \"Burkina Faso\",\n      },\n      Burundi: {\n        en: \"Burundi\",\n        fr: \"Burundi\",\n      },\n      Cameroon: {\n        en: \"Cameroon\",\n        fr: \"Cameroun\",\n      },\n      \"Central African Republic\": {\n        en: \"Central African Republic\",\n        fr: \"République Centrafricaine\",\n      },\n      Chad: {\n        en: \"Chad\",\n        fr: \"Tchad\",\n      },\n      \"Congo - Brazzaville\": {\n        en: \"Congo - Brazzaville\",\n        fr: \"Congo - Brazzaville\",\n      },\n      \"Congo - Kinshasa\": {\n        en: \"Congo - Kinshasa\",\n        fr: \"Congo - Kinshasa\",\n      },\n      \"Côte d’Ivoire\": {\n        en: \"Côte d’Ivoire\",\n        fr: \"Côte d’Ivoire\",\n      },\n      Djibouti: {\n        en: \"Djibouti\",\n        fr: \"Djibouti\",\n      },\n      \"Equatorial Guinea\": {\n        en: \"Equatorial Guinea\",\n        fr: \"Guinée Équatoriale\",\n      },\n      Eritrea: {\n        en: \"Eritrea\",\n        fr: \"Érythrée\",\n      },\n      Eswatini: {\n        en: \"Eswatini\",\n        fr: \"Eswatini\",\n      },\n      Ethiopia: {\n        en: \"Ethiopia\",\n        fr: \"Éthiopie\",\n      },\n      Gabon: {\n        en: \"Gabon\",\n        fr: \"Gabon\",\n      },\n      Gambia: {\n        en: \"Gambia\",\n        fr: \"Gambie\",\n      },\n      Ghana: {\n        en: \"Ghana\",\n        fr: \"Ghana\",\n      },\n      Guinea: {\n        en: \"Guinea\",\n        fr: \"Guinée\",\n      },\n      \"Guinea-Bissau\": {\n        en: \"Guinea-Bissau\",\n        fr: \"Guinée-Bissau\",\n      },\n      Kenya: {\n        en: \"Kenya\",\n        fr: \"Kenya\",\n      },\n      Lesotho: {\n        en: \"Lesotho\",\n        fr: \"Lesotho\",\n      },\n      Liberia: {\n        en: \"Liberia\",\n        fr: \"Libéria\",\n      },\n      Madagascar: {\n        en: \"Madagascar\",\n        fr: \"Madagascar\",\n      },\n      Malawi: {\n        en: \"Malawi\",\n        fr: \"Malawi\",\n      },\n      Mali: {\n        en: \"Mali\",\n        fr: \"Mali\",\n      },\n      Mauritania: {\n        en: \"Mauritania\",\n        fr: \"Mauritanie\",\n      },\n      Mozambique: {\n        en: \"Mozambique\",\n        fr: \"Mozambique\",\n      },\n      Namibia: {\n        en: \"Namibia\",\n        fr: \"Namibie\",\n      },\n      Niger: {\n        en: \"Niger\",\n        fr: \"Niger\",\n      },\n      Nigeria: {\n        en: \"Nigeria\",\n        fr: \"Nigéria\",\n      },\n      Rwanda: {\n        en: \"Rwanda\",\n        fr: \"Rwanda\",\n      },\n      Senegal: {\n        en: \"Senegal\",\n        fr: \"Sénégal\",\n      },\n      \"Sierra Leone\": {\n        en: \"Sierra Leone\",\n        fr: \"Sierra Leone\",\n      },\n      Somalia: {\n        en: \"Somalia\",\n        fr: \"Somalie\",\n      },\n      \"South Africa\": {\n        en: \"South Africa\",\n        fr: \"Afrique du Sud\",\n      },\n      \"South Sudan\": {\n        en: \"South Sudan\",\n        fr: \"Soudan du Sud\",\n      },\n      Sudan: {\n        en: \"Sudan\",\n        fr: \"Soudan\",\n      },\n      Tanzania: {\n        en: \"Tanzania\",\n        fr: \"Tanzanie\",\n      },\n      Togo: {\n        en: \"Togo\",\n        fr: \"Togo\",\n      },\n      Uganda: {\n        en: \"Uganda\",\n        fr: \"Ouganda\",\n      },\n      Zambia: {\n        en: \"Zambia\",\n        fr: \"Zambie\",\n      },\n      Zimbabwe: {\n        en: \"Zimbabwe\",\n        fr: \"Zimbabwe\",\n      },\n      SSA: {\n        en: \"Sub-Saharan Africa\",\n        fr: \"Afrique Subsaharienne\",\n      },\n      \"Sub-Saharan Africa\": {\n        en: \"Sub-Saharan Africa\",\n        fr: \"Afrique Subsaharienne\",\n      },\n    },\n  },\n});\n\n\n\n\n\n\n\nhtml`&lt;style&gt;\n.plotTooltip {\n  z-index:2;\n  padding: 10px 10px;\n  color: black;\n  border-radius: 4px;\n  border: 1px solid rgba(0,0,0,1);\n  pointer-events: none;\n  transform: translate(-50%, -100%);\n  font-family: \"IBM Plex Sans\", \"Source Serif Pro\";\n  font-size: 14px;\n  background: rgba(255,255,255, 1);\n  transition: 0.3s opacity ease-out, 0.1s border-color ease-out;\n  position: relative;\n  display: none;\n}\n\n.plotTooltip::before {\n  content: \"\";\n  position: absolute;\n  top: 100%;\n  left: 50%;\n  margin-left: -5px;\n  border-width: 5px;\n  border-style: solid;\n  border-color: black transparent transparent transparent;\n}\n\n.plotTooltip::after {\n  content: \"\";\n  position: absolute;\n  top: calc(100% - 1px);\n  left: 50%;\n  margin-left: -4.9px;\n  border-width: 4.9px;\n  border-style: solid;\n  border-color: white transparent transparent transparent;\n}\n&lt;/style&gt;`;\n\n\n\n\n\n\n\nformTemplate = ({ gap = \"2em\" } = {}) =&gt; {\n  // template for input display\n  return (inputs) =&gt;\n    html`&lt;div style=\"display: flex; gap: ${gap};\"&gt;${inputs}&lt;/div&gt;`;\n};\n\n\n\n\n\n\n\nhtml`&lt;style&gt;\n    /* Styling for tooltip labels */\n    .tooltip {\n        position: relative;\n        display: inline-block;\n        cursor: pointer;\n        width: 100%;\n    }\n\n    .tooltip .tooltiptext {\n        position: absolute;\n        z-index: 1;\n        visibility: hidden; \n        left: 0;\n        bottom: 100%;\n        background-color: #efefef;\n        color: #333;\n        border: 0px solid #333;\n        border-radius: 0;\n        padding: 0px 0px;\n        margin-bottom: 00px;\n        text-transform: none;\n        font-size: 14px;\n        line-height: 1.6;\n        text-align: left;\n        opacity: 0;\n        transition: opacity 0.3s;\n    }\n\n    .tooltip:hover .tooltiptext {\n        visibility: visible;\n        opacity: 1;\n        cursor: default;\n    }\n&lt;/style&gt;`;\n\n\n\n\n\n\n\n{\n  return md`**Color Scales**`\n}\n\n\n\n\n\n\n\n// color scale info\ncolorScales = {\n  return {\n    range: {\n      green: ['#E4F5D0', '#015023'],\n      blue: ['#E8F2FF', '#003E6B'],\n      brown: ['#FFFDE5', '#A87B00'],\n      yellowGreen: ['#F7D732', '#216729'],\n      orangeRed: ['#F4BB21', '#EC5A47'],\n    },\n    unknown: \"#ccc\"\n  }\n}\n\n\n\n\n\n\n\nmd`---\n### Admin Selection\n*Global admin selector using dropdowns*\n\nThis is the global selector for the selected region\n- The completed data is contained within adminSelections to be used in queries\n- Dropdowns are defined below then bound for each section\n  - Defined as separate cells since they dynamically respond to different values\n    - In narrative, they are simply views of the data  \n  - Dropdowns are dynamic based on higher-level choices\n  - Options are defined from the geographic data\n  - null value means unselected region\n- Dropdowns are added to each section, using Inputs.bind to create synchronized inputs (see viewof for input definitions). A form input is used to consolidate and apply a template to format.`;\n\n\n\n\n\n\n\n// get admin0 options from geo\ndataAdmin0 = {\n  const data = admin0_boundaries.features.map(d =&gt; d.properties)\n  // add a blank value\n  return [null, ...data.map(d =&gt; d.admin_name)]\n}\n\n\n\n\n\n\n\n// get admin1 options based on admin0 selection\n// (the admin1 regions within selected admin0)\ndataAdmin1 = {\n  // admin 1, filter by 0 \n  const data = admin1_boundaries.features.map(d =&gt; d.properties)\n  .filter(d =&gt; d.admin0_name == selectAdmin0)\n  // add blank value\n  return [null, ...data.map(d =&gt; d.admin1_name)]\n}\n\n\n\n\n\n\n\n// get admin2 options based on admin1 selection\n// (the admin2 regions within selected admin1)\ndataAdmin2 = {\n  const data = boundaries.admin2.features.map(d =&gt; d.properties)\n  .filter(d =&gt; d.admin0_name == selectAdmin0 && d.admin1_name == selectAdmin1)\n  // add blank value\n  return [null, ...data.map(d =&gt; d.admin2_name)]\n}\n\n\n\n\n\n\n\nmd`## Global impacts data`;\n\n\n\n\n\n\n\ncrop_options_items = {\n  return [\n      {id: 0, Crop: \"maize\"},\n      {id: 1, Crop: \"rice\"}, \n      {id: 2, Crop: \"soybean\"},\n      {id: 3, Crop: \"wheat\"}\n  ];\n}\n\n\n\n\n\n\n\n// make a label for selector\n// html with tooltip on hover\nfunction makeTooltipLabel({\n  labelText = \"Dropdown label\",\n  tooltipText = \"Tooltip text\",\n} = {}) {\n  return htl.html`&lt;span class=\"tooltip\"&gt;\n    &lt;span for=\"inputField\"&gt;${labelText}&lt;/span&gt;\n    &lt;span class=\"tooltiptext\"&gt;${tooltipText}&lt;/span&gt;\n&lt;/span&gt;`;\n}\n\n\n\n\n\n\n\ndebounce = (delay, input) =&gt; {\n  class DelayedEvent extends Event {}\n  let id;\n  input.addEventListener(\"input\", (e) =&gt; {\n    if (e instanceof DelayedEvent) return;\n    e.stopImmediatePropagation();\n    clearTimeout(id);\n    id = setTimeout(\n      () =&gt; input.dispatchEvent(new DelayedEvent(\"input\", { bubbles: true })),\n      delay,\n    );\n  });\n  return input;\n};\n\n\n\n\n\n\n\ndebounceDelay = 500; // ms delay to respond\n\n\n\n\n\n\n\nviewof select_crop = {\n  const checkbox = Inputs.checkbox(crop_options_items.map((d) =&gt; d.Crop), { label: \"Crops\", value: ['maize'] });\n  checkbox.addEventListener('input', () =&gt; {\n    if (checkbox.value.length === 0) {\n      checkbox.value = ['maize'];\n    }\n  });\n  return checkbox }\n\n\n\n\n\n\n\nviewof crop_selector_yield = {\n  return Inputs.select(\n    [\"maize\", \"rice\", \"wheat\"],\n    {label: _lang(nbText.general.crop),\n    format: c =&gt; _lang(nbText.general.crops[c])}\n  )  \n}\n\n\n\n\n\n\n\nviewof sel_region = {\n  return Inputs.select(\n    avaliable_unRegions,\n    {label: _lang(nbText.regionalPicture.beeswarm.yAxis),\n    format: d =&gt;  _lang(nbText.regionalPicture.beeswarm.regions[d || \"all\"])} // No region is NULL so add a label\n  )  \n}\n\n\n\n\n\n\n\nselected_crop_global = [crop_selector_yield];\n\n\n\n\n\n\n\nwarming_level_options = {\n  return {\n      0: {min: -Infinity, max: 1.5, label: \"&lt;1.5\"},\n      1: {min: 1.5, max: 2.0, label: \"1.5-2.0\"},\n      2: {min: 2.0, max: 3.0, label: \"2.0-3.0\"},\n      3: {min: 3.0, max: Infinity, label: \"&gt;3.0\"}\n  }\n}\n\n\n\n\n\n\n\nimpacts_metaanalysis_data = {\n  // Excuse the names.. the R export \"cleaned\" them...\n  let sqlQuery = `\n    SELECT \n      LOWER(Crop) as Crop,\n      Country,\n      \"Projected.yield..t.ha.\" as proj_yield,\n      \"Climate.impacts....\" as yield_impact_pct,\n      \"Global.delta.T.from.pre.industrial.period\" as preindustrial_temp_delta,\n      \"Global.delta.T.from.2005\" as temp_delta_2005,\n      Reference,\n      Adaptation,\n    FROM projected_impacts\n    WHERE Region = 'Africa'\n    AND LOWER(Crop) = '${crop_selector_yield}'`\n\n  let filtered = await db2.query(sqlQuery) // Put this in a seperate db (non-encrypted) to boost load time of first figure\n\n  filtered = filtered.map(item =&gt; ({\n    ...item,\n    UNRegion: country_to_region[item.Country.toLowerCase().trim()]\n  }));\n  return filtered;\n}\n\n\n\n\n\n\n\ndb2 = DuckDBClient.of({\n  projected_impacts: FileAttachment(\"projected-impacts_hasagawa.parquet\"),\n});\n\n\n\n\n\n\n\navaliable_unRegions = new Set([\n  null,\n  ...impacts_metaanalysis_data.map((d) =&gt; d.UNRegion),\n]); // null for all of africa\n\n\n\n\n\n\n\nviolin_insight_data = {\n  let data = impacts_metaanalysis_data\n    .map(d =&gt; ({\n      ...d,\n      temp_band: classifyTempBand(d.preindustrial_temp_delta)\n    }));\n\n  let region_data = data\n    .filter(d =&gt; \n      !sel_region || d?.UNRegion === sel_region\n    )\n\n  const median_yields = Object.fromEntries(\n    d3.groups(region_data, d =&gt; d.temp_band).map(([b, rows]) =&gt; [\n      b,\n      {\n        median_without_adaptation: d3.median(rows.filter(d =&gt; d.Adaptation === \"No\"), d =&gt; +d.yield_impact_pct) ?? null,\n        median_with_adaptation: d3.median(rows.filter(d =&gt; d.Adaptation === \"Yes\"), d =&gt; +d.yield_impact_pct) ?? null,\n      }\n    ])\n  );\n  \n  const worstRegionsByBand = Object.fromEntries( // this should use the unfiltered data with all regions\n    d3.groups(data, d =&gt; d.temp_band ?? \"Unspecified\").map(([b, rows]) =&gt; {\n      const by = subset =&gt; {\n        const rmap = d3.rollup(subset, v =&gt; d3.median(v, d =&gt; +d.yield_impact_pct), d =&gt; d.UNRegion ?? \"Unspecified\");\n        if (!rmap.size) return null;\n        const minVal = d3.min(rmap.values());\n        const worst = [...rmap].filter(([, m]) =&gt; m === minVal)\n                        .map(([r, medianLoss]) =&gt; ({ region: r, medianLoss }));\n        \n        return worst.length === 1 ? worst[0] : worst;\n      };\n      return [b, {\n        worst_region_without_adaptation: by(rows.filter(d =&gt; d.Adaptation === \"No\")),\n        worst_region_with_adaptation: by(rows.filter(d =&gt; d.Adaptation === \"Yes\")),\n      }];\n    })\n  );\n  \n  return{\n    median_yields,\n    worst_region: worstRegionsByBand\n  }\n}\n\n\n\n\n\n\n\nfunction classifyTempBand(temp) {\n  if (temp &lt;= 2) return \"≤ 2°C\"; // return \"≤ 1.5°C\";\n  if (temp &lt;= 3) return \"2-3°C\"; // return \"1.5–2.5°C\";\n  return \"&gt; 3°C\"; // \"&gt; 2.5°C\"\n}\n\n\n\n\n\n\n\ntemp_opts = [\"≤ 2°C\", \"2-3°C\", \"&gt; 3°C\"];\n\n\n\n\n\n\n\nmd`## Dynamic Insights`;\n\n\n\n\n\n\n\ncountry_to_region = {\n    return {\n  \"algeria\": \"Northern\",\n   \"egypt\": \"Northern\",\n   \"libya\": \"Northern\",\n   \"morocco\": \"Northern\",\n   \"sudan\": \"Northern\",\n   \"tunisia\": \"Northern\",\n   \"western sahara\": \"Northern\",\n   \"syria\": \"Northern\",\n   \"british indian ocean territory\": \"Eastern\",\n   \"burundi\": \"Eastern\",\n   \"comoros\": \"Eastern\",\n   \"djibouti\": \"Eastern\",\n   \"eritrea\": \"Eastern\",\n   \"ethiopia\": \"Eastern\",\n   \"french southern territories\": \"Eastern\",\n   \"kenya\": \"Eastern\",\n   \"madagascar\": \"Eastern\",\n   \"malawi\": \"Eastern\",\n   \"mauritius\": \"Eastern\",\n   \"mayotte\": \"Eastern\",\n   \"mozambique\": \"Eastern\",\n   \"réunion\": \"Eastern\",\n   \"rwanda\": \"Eastern\",\n   \"seychelles\": \"Eastern\",\n   \"somalia\": \"Eastern\",\n   \"south sudan\": \"Eastern\",\n   \"uganda\": \"Eastern\",\n   \"united republic of tanzania\": \"Eastern\",\n   \"zambia\": \"Eastern\",\n   \"zimbabwe\": \"Eastern\",\n   \"tanzania\": \"Eastern\",\n   \"angola\": \"Central\",\n   \"cameroon\": \"Central\",\n   \"central african republic\": \"Central\",\n   \"chad\": \"Central\",\n   \"congo\": \"Central\",\n   \"democratic republic of the congo\": \"Central\",\n   \"equatorial guinea\": \"Central\",\n   \"gabon\": \"Central\",\n   \"sao tome and principe\": \"Central\",\n   \"botswana\": \"Southern\",\n   \"eswatini\": \"Southern\",\n   \"lesotho\": \"Southern\",\n   \"namibia\": \"Southern\",\n   \"south africa\": \"Southern\",\n   \"benin\": \"Western\",\n   \"burkina faso\": \"Western\",\n   \"cabo verde\": \"Western\",\n   \"cote d'lvoire\": \"Western\",\n   \"gambia\": \"Western\",\n   \"ghana\": \"Western\",\n   \"guinea\": \"Western\",\n   \"guinea-bissau\": \"Western\",\n   \"liberia\": \"Western\",\n   \"mali\": \"Western\",\n   \"mauritania\": \"Western\",\n   \"niger\": \"Western\",\n   \"nigeria\": \"Western\",\n   \"saint helena, ascension and tristan da cunha\": \"Western\",\n   \"saint helena\": \"Western\",\n   \"ascension island\": \"Western\",\n   \"tristan da cunha\": \"Western\",\n   \"senegal\": \"Western\",\n   \"sierra leone\": \"Western\",\n   \"togo\": \"Western\",\n   \"sudan savanna\": \"Western\",\n   \"guinea bissau\": \"Western\"\n  }}\n\n\n\n\n\n\n\nviewof crop_selector_dynamic_insights = {\n  return Inputs.select(\n    [\"maize\", \"sorghum\", \"millet\", \"wheat\"],\n    {label: _lang(nbText.general.crop),\n    format: c =&gt; _lang(nbText.general.crops[c])}\n  )  \n}\n\n\n\n\n\n\n\ncycle_selector_options_di = {\n  return {\n      0: {cycle: \"both\", label: _lang(nbText.zoomToStable.selectors.growSeason.values.both)},\n      1: {cycle: \"1\", label: _lang(nbText.zoomToStable.selectors.growSeason.values.first)},\n      2: {cycle: \"2\", label: _lang(nbText.zoomToStable.selectors.growSeason.values.second)},\n  }\n}\n\n\n\n\n\n\n\nselected_cycle_options = Object.values(cycle_selector_options_di).find(\n  (option) =&gt; option.label === cycle_selector_di,\n);\n\n\n\n\n\n\n\nviewof cycle_selector_di = {\n  return Inputs.select(\n      Object.values(cycle_selector_options_di).map((x) =&gt; x.label),\n      {label: _lang(nbText.zoomToStable.selectors.growSeason.title) }\n  )  \n}\n\n\n\n\n\n\n\nscenario_options = {\n  return {\n      0: {ssp: \"SSP370\", horizon: 2030, label: \"SSP3-7.0: 2021-2040\"},\n      1: {ssp: \"SSP370\", horizon: 2005, label: _lang(nbText.general.historical)},\n      2: {ssp: \"SSP370\", horizon: 2050, label: \"SSP3-7.0: 2041-2060\"},\n      3: {ssp: \"SSP585\", horizon: 2030, label: \"SSP5-8.5: 2021-2040\"},\n      4: {ssp: \"SSP585\", horizon: 2050, label: \"SSP5-8.5: 2041-2060\"}\n  }\n}\n\n\n\n\n\n\n\nviewof scenario_selector_di = {\n  return Inputs.select(\n      Object.values(scenario_options).map((x) =&gt; x.label),\n      {label: _lang(nbText.general.scenario),\n       format: l =&gt; l === \"Historical\"? _lang(nbText.general.historical) : l}\n  )  \n}\n\n\n\n\n\n\n\nselected_scenario = Object.values(scenario_options).find(\n  (option) =&gt; option.label === scenario_selector_di,\n);\n\n\n\n\n\n\n\nyield_output_options = {\n  return {\n    0: {label: \"Yield change (ton/ha)\"},\n    1: {label: \"Yield (ton/ha)\"},\n    2: {label: \"Yield change (%)\"},\n    3: {label: \"Uncertainty in yield (ton/ha)\"},\n  }\n}\n\n\n\n\n\n\n\nviewof yield_output_selector_di = {\n let options \n   if (scenario_selector_di === \"Historique\" || scenario_selector_di === \"Historic\") {\n     options = [\"Yield (ton/ha)\", \"Uncertainty in yield (ton/ha)\"]\n   } else {\n     options = Object.values(yield_output_options).map((x) =&gt; x.label)\n   }\n  return Inputs.select(\n      options,\n      {label: _lang(nbText.zoomToStable.selectors.YieldOutput.title),\n       format: l =&gt; _lang(nbText.zoomToStable.selectors.YieldOutput.values[l])}\n  )  \n}\n\n\n\n\n\n\n\nselected_yield_output = Object.values(yield_output_options).find(\n  (option) =&gt; option.label === yield_output_selector_di,\n);\n\n\n\n\n\n\n\ncultivar_options = {\n  return {\n    0: {label: _lang(nbText.zoomToStable.selectors.Cultivar.values.current), value: \"current\"},\n    1: {label: _lang(nbText.zoomToStable.selectors.Cultivar.values.early), value: \"early\"},\n    2: {label: _lang(nbText.zoomToStable.selectors.Cultivar.values.late), value: \"late\"},\n  }\n}\n\n\n\n\n\n\n\nviewof cultivar_selector_di = {\n  return Inputs.select(\n      Object.values(cultivar_options).map((x) =&gt; x.label),\n      {label: _lang(nbText.zoomToStable.selectors.Cultivar.title) }\n  )  \n}\n\n\n\n\n\n\n\nselected_cultivar = Object.values(cultivar_options).find(\n  (option) =&gt; option.label === cultivar_selector_di,\n);\n\n\n\n\n\n\n\nzoom_in_elements = {\n  const form = [\n      viewof crop_selector_dynamic_insights,\n      viewof cycle_selector_di,\n      viewof scenario_selector_di,\n      viewof yield_output_selector_di,\n      viewof cultivar_selector_di,\n  ]\n  return form\n}\n\n\n\n\n\n\n\nviewof selectAdmin0 = Inputs.select(dataAdmin0, {label: adminRegions.labels.admin0})\n\n\n\n\n\n\n\nviewof selectAdmin1 = Inputs.select(dataAdmin1, {label: adminRegions.labels.admin1})\n\n\n\n\n\n\n\nviewof selectAdmin2 = Inputs.select(dataAdmin2, {label: adminRegions.labels.admin2})\n\n\n\n\n\n\n\n// selected admin regions from dropdowns\nadminSelections = new Object({\n  selectAdmin0,\n  selectAdmin1,\n  selectAdmin2,\n});\n\n\n\n\n\n\n\nfunction arrayMin(arr) {\n  var len = arr.length,\n    min = Infinity;\n  while (len--) {\n    if (arr[len] &lt; min) {\n      min = arr[len];\n    }\n  }\n  return min;\n}\n\n\n\n\n\n\n\nfunction arrayMax(arr) {\n  var len = arr.length,\n    max = -Infinity;\n  while (len--) {\n    if (arr[len] &gt; max) {\n      max = arr[len];\n    }\n  }\n  return max;\n}\n\n\n\n\n\n\n\nfunction get_yield_column(yield_output_selection, yield_type) {\n  return {\n    \"Yield (ton/ha)\": \"yield_\" + yield_type + \"_avg\",\n    \"Yield change (ton/ha)\": \"yield_\" + yield_type + \"_abs_change\",\n    \"Yield change (%)\": \"yield_\" + yield_type + \"_rlt_change\",\n    \"Uncertainty in yield (ton/ha)\": \"yield_\" + yield_type + \"_rng\",\n  }[yield_output_selection];\n}\n\n\n\n\n\n\n\nmapDataColumn = get_yield_column(\n  selected_yield_output.label,\n  selectGeoDataType.labelTip,\n);\n\n\n\n\n\n\n\nmd`## Adapting to the future changes`;\n\n\n\n\n\n\n\ncolorYellowGreen = [\"#F7D732\", \"#216729\"];\n\n\n\n\n\n\n\nformatNum = d3.format(\".2f\");\n\n\n\n\n\n\n\natfc_crop_options = {\n    const opts = {\n      0: {label: \"maize\", crop: \"maize\"},\n      1: {label: \"sorghum\", crop: \"sorghum\"},\n      2: {label: \"millet\", crop: \"millet\"},\n      3: {label: \"wheat\", crop: \"wheat\"},\n  }\n  return opts\n}\n\n\n\n\n\n\n\nviewof atfc_crop_selector = {\n  return Inputs.select(\n    Object.values(atfc_crop_options).map((x) =&gt; x.label),\n    {label: _lang(nbText.general.crop),\n    format: l =&gt; _lang(nbText.general.crops[l])}\n  )\n}\n\n\n\n\n\n\n\nselected_crop_atfc = Object.values(atfc_crop_options).find(\n  (option) =&gt; option.label == atfc_crop_selector,\n).crop;\n\n\n\n\n\n\n\n/*\n[Adaptation option selector] Selector for the combinatorial of fields ‘cultivar’ and ‘irrigation’ in data file. Cultivar options are current (labeled as “Current (no cultivar adaptation)”), early (labeled as “Early maturity”), and late (labeled as “Late maturity”). Irrigation options are Yes, No. “Yes” uses the “yield_irr” data (needs to be aggregated in the same way it was done for “yield_rfd” above) and the “No” uses the “yield_rfd”.as follows,\n    No adaptation – this is data from ‘current’ cultivar, and ‘yield_rfd’\n    Current cultivar, irrigation – this is data from current cultivar but yield_irr\n    Early maturity, no irrigation – this is data from early cultivar but yield_rfd\n    Early maturity, irrigation – this is data from early cultivar but yield_irr\n    Late maturity, no irrigation – this is data from late cultivar but yield_rfd\n    Late maturity, irrigation – this is data from late cultivar but yield_irr\n&lt;note: a second data file for adaptation will be shared by us. We’ll make it consistent with what you need.&gt;\n*/\nadapting_to_future_changes_options = {\n    const adapting_to_future_changes_options = {\n      0: {cultivar: \"\", label: \"\"},\n      1: {cultivar: \"current\", yield: \"yield_rfd\", label: \"No adaptation\"},\n      2: {cultivar: \"current\", yield: \"yield_irr\", label: \"Current cultivar, irrigation\"},\n      3: {cultivar: \"early\", yield: \"yield_rfd\", label: \"Early maturity, no irrigation\"},\n      4: {cultivar: \"early\", yield: \"yield_irr\", label: \"Early maturity, irrigation\"},\n      5: {cultivar: \"late\", yield: \"yield_rfd\", label: \"Late maturity, no irrigation\"},\n      6: {cultivar: \"late\", yield: \"yield_irr\", label: \"Late maturity, irrigation\"}\n  }\n  return adapting_to_future_changes_options\n}\n\n\n\n\n\n\n\natfc_scenario_selector_options = {\n  return {\n    0: {label: `SSP3-7.0 (${_lang(nbText.general.emission_ssp370)})`, ssp: \"SSP370\"},\n    1: {label: `SSP5-8.5 (${_lang(nbText.general.emission_ssp585)})`, ssp: \"SSP585\"},\n  }\n}\n\n\n\n\n\n\n\nviewof atfc_cycle_selector = {\n  return Inputs.select(\n      Object.values(cycle_selector_options_di).map((x) =&gt; x.cycle),\n      {label: _lang(nbText.zoomToStable.selectors.growSeason.title) }\n  )  \n}\n\n\n\n\n\n\n\nviewof atfc_scenario_selector = {\n  return Inputs.select(\n      Object.values(atfc_scenario_selector_options).map((x) =&gt; x.ssp),\n      {label: \"Scenario\"}\n  )\n}\n\n\n\n\n\n\n\ndataYieldATFC1 = {\n  return [\n    {\n      Practice:\"No adaptation\",\n      AEZ_Class_FAO: \"historical\",\n      Mean_Difference: 3,\n    },\n    {\n      Practice:\"No adaptation\",\n      AEZ_Class_FAO: \"2030\",\n      Mean_Difference: 2,\n    },\n    {\n      Practice:\"No adaptation\",\n      AEZ_Class_FAO: \"2050\",\n      Mean_Difference: 1,\n    },\n    {\n      Practice:\"Irrigation\",\n      AEZ_Class_FAO: \"historical\",\n      Mean_Difference: 3,\n    },\n    {\n      Practice:\"Irrigation\",\n      AEZ_Class_FAO: \"2030\",\n      Mean_Difference: 2,\n    },\n    {\n      Practice:\"Irrigation\",\n      AEZ_Class_FAO: \"2050\",\n      Mean_Difference: 1,\n    },\n    {\n      Practice:\"Early cultivar\",\n      AEZ_Class_FAO: \"historical\",\n      Mean_Difference: 3,\n    },\n    {\n      Practice:\"Early cultivar\",\n      AEZ_Class_FAO: \"2030\",\n      Mean_Difference: 2,\n    },\n    {\n      Practice:\"Early cultivar\",\n      AEZ_Class_FAO: \"2050\",\n      Mean_Difference: 1,\n    },\n    {\n      Practice:\"Late cultivar\",\n      AEZ_Class_FAO: \"historical\",\n      Mean_Difference: 3,\n    },\n    {\n      Practice:\"Late cultivar\",\n      AEZ_Class_FAO: \"2030\",\n      Mean_Difference: 2,\n    },\n    {\n      Practice:\"Late cultivar\",\n      AEZ_Class_FAO: \"2050\",\n      Mean_Difference: 1,\n    },\n    {\n      Practice:\"Irrigation & early cultivar\",\n      AEZ_Class_FAO: \"historical\",\n      Mean_Difference: 3,\n    },\n    {\n      Practice:\"Irrigation & late cultivar\",\n      AEZ_Class_FAO: \"2030\",\n      Mean_Difference: 2,\n    },\n    {\n      Practice:\"Irrigation & late cultivar\",\n      AEZ_Class_FAO: \"2050\",\n      Mean_Difference: 1,\n    },\n  ]\n}\n\n\n\n\n\n\n\ndataYieldATFC = {\n  let query = `\nSELECT *\nFROM afc_data \n${WhereAdminQuery_ATFC()} \nAND ssp = '${atfc_scenario_selector.toUpperCase()}'\nAND cycle = '${atfc_cycle_selector}'\n`\n  mutable DBloaded = true\n  return db.query(query).then((r) =&gt; r.toArray());\n\n//     let query = `\n// SELECT * \n// FROM afc_data \n// WHERE 1 = 1 \n// AND ssp = '${atfc_scenario_selector.toUpperCase()}'\n// AND cycle = '${atfc_cycle_selector}'\n// `;\n//   if (adminSelections.selectAdmin0 != null) {\n//     const none_admins = getAdminsNoneForSameLevel();\n//     for (let i = 0; i &lt; none_admins.length; i++)\n//       query += ` AND ${none_admins[i]} = ''`;\n//   }\n//   return db.query(query).then((r) =&gt; r.toArray());\n}\n\n\n\n\n\n\n\nWhereAdminQuery_ATFC = () =&gt; {\n  if (!selectAdmin0 || !selectAdmin1) {\n    // where admin0_name is null, it is ssa, return admin 0 data\n    return `WHERE admin1_name = ''`;\n  } else if (!selectAdmin2 && selectAdmin1) {\n    // where admin0 and admin1 is not null, return admin 1 for selected country\n    return `WHERE admin1_name != '' AND admin2_name = '' AND admin0_name = '${selectAdmin0}'`;\n  } else {\n    return `WHERE admin2_name != '' AND admin0_name = '${selectAdmin0}' AND admin1_name = '${selectAdmin1}'`;\n  }\n};\n\n\n\n\n\n\n\nfunction getRegionalGranularityLevel(adminSelections) {\n  if (adminSelections.selectAdmin0 == null) return \"admin0_name\";\n  if (adminSelections.selectAdmin1 == null) return \"admin1_name\";\n  if (adminSelections.selectAdmin2 == null) return \"admin2_name\";\n  return \"admin2_name\";\n}\n\n\n\n\n\n\n\nfunction get_selected_admin_atfc() {\n  if (adminSelections.selectAdmin0 == null) {\n    return { admin: \"admin0_name\", highlight: null };\n  } else {\n    if (adminSelections.selectAdmin1 == null) {\n      return { admin: \"admin0_name\", highlight: adminSelections.selectAdmin0 };\n    } else {\n      if (adminSelections.selectAdmin2 == null) {\n        return {\n          admin: \"admin1_name\",\n          highlight: adminSelections.selectAdmin1,\n        };\n      } else {\n        return {\n          admin: \"admin2_name\",\n          highlight: adminSelections.selectAdmin2,\n        };\n      }\n    }\n  }\n}\n\n\n\n\n\n\n\nfunction getAdminsNoneForSameLevel() {\n  if (adminSelections.selectAdmin0 == null)\n    return [\"admin0_name\", \"admin1_name\", \"admin2_name\"];\n  if (adminSelections.selectAdmin1 == null)\n    return [\"admin1_name\", \"admin2_name\"];\n  if (adminSelections.selectAdmin2 == null) return [\"admin2_name\"];\n  return [];\n}\n\n\n\n\n\n\n\nfunction round(x, places) {\n  const pot = Math.pow(10, places);\n  return Math.round(x * pot) / pot;\n}\n\n\n\n\n\n\n\nfunction get_adpt_options_higher_yield_than_no_adaptation(data) {\n  const maxMeanDifference = {\n    historical: -Infinity,\n    2030: -Infinity,\n    2050: -Infinity,\n  };\n\n  // Find the maximum mean_difference for \"No adaptation\" for each horizon\n  const options = new Set();\n  for (const row of data) {\n    if (row.adaptation == \"No adaptation\") {\n      maxMeanDifference[row.horizon] = Math.max(\n        maxMeanDifference[row.horizon],\n        row.mean_difference,\n      );\n      continue;\n    }\n    options.add(row.adaptation);\n  }\n\n  for (const row of data) {\n    if (row.adaptation == \"No adaptation\") continue;\n    if (row.mean_difference &lt; maxMeanDifference[row.horizon]) {\n      options.delete(row.adaptation);\n    }\n  }\n\n  let results = [];\n\n  for (const option of options) {\n    const filt = data.filter((d) =&gt; d.adaptation == option);\n    let obj = {\n      option: option,\n      historical:\n        filt.find((d) =&gt; d.horizon == \"historical\").mean_difference -\n        maxMeanDifference.historical,\n      2030:\n        filt.find((d) =&gt; d.horizon == \"2030\").mean_difference -\n        maxMeanDifference[\"2030\"],\n      2050:\n        filt.find((d) =&gt; d.horizon == \"2050\").mean_difference -\n        maxMeanDifference[\"2050\"],\n    };\n    results.push(obj);\n  }\n  results.sort((a, b) =&gt; a.historical - b.historical).reverse();\n  return results;\n}\n\n\n\n\n\n\n\nhighlighted_data = {\n  var selected_geo = get_selected_admin_atfc();\n    if (selectAdmin0 == null){\n      selected_geo = {\n        admin: \"admin0_name\",\n        highlight: \"\"\n      }\n    }\n\n  return dataYieldATFC.filter(d =&gt; (\n        (d.crop.toLowerCase().trim() == selected_crop_atfc.toLowerCase().trim()) &&\n        (d.cycle == atfc_cycle_selector) &&\n        (d.ssp == atfc_scenario_selector) &&\n        (d[selected_geo.admin] == selected_geo.highlight)\n      )\n    );\n}\n\n\n\n\n\n\n\nfunction average(vals) {\n  let sum = 0;\n  for (let i = 0; i &lt; vals.length; i++) {\n    sum += vals[i];\n  }\n  return sum / vals.length;\n}\n\n\n\n\n\n\n\ncontainsAll = (arr1, arr2) =&gt; arr2.every((arr2Item) =&gt; arr1.includes(arr2Item));\n\n\n\n\n\n\n\nmd`---\n### Admin Selection - Display\n*Showing admin selections*`;\n\n\n\n\n\n\n\n// options for the global admin selection\n// used when no admin selection is made\nglobalSelection = {\n  return {\n    label: \"Sub-Saharan Africa\",\n    labelGeneral: \"Africa\"\n  }\n}\n\n\n\n\n\n\n\nfunction getAdminSelection(selections = adminSelections) {\n  // get the most granular admin selection made\n  const a0 = selections.selectAdmin0;\n  const a1 = selections.selectAdmin1;\n  const a2 = selections.selectAdmin2;\n  const global = globalSelection.label;\n\n  return a2 ? a2 : a1 ? a1 : a0 ? a0 : global;\n}\n\n\n\n\n\n\n\nfunction getAdminSelectionAdmin0(selections = adminSelections) {\n  // get the selected admin0 or global value\n  const a0 = selections.selectAdmin0;\n  const global = globalSelection.label;\n\n  return a0 ? a0 : global;\n}\n\n\n\n\n\n\n\nfunction getAdminSelectionMarkdownPath(selections = adminSelections) {\n  // function to show selected admin region\n  // return path showing nested admin selection\n\n  const delim = \" → \";\n  const path = [\n    selections.selectAdmin0,\n    selections.selectAdmin1,\n    selections.selectAdmin2,\n  ].filter((d) =&gt; d);\n\n  const formatted = path\n    .filter((d) =&gt; d)\n    .map((d, i) =&gt; {\n      return i == path.length - 1 ? `**${d}**` : `*${d}*`;\n    });\n\n  return formatted.length == 0\n    ? `**${globalSelection.label}**` // no selection, all of Africa\n    : `${formatted.join(delim)}`;\n}\n\n\n\n\n\n\n\nmd`---\n### Choropleth map - Geographic Impact\n*Showing context for admin selection*\n\nThere is some hoop-jumping to get the right data based on the Admin Selection. The tabular data is then bound to the applicable geojson, and visualized with Plot.`;\n\n\n\n\n\n\n\ndataYield = {\n  let query = `\nSELECT *\nFROM aggregated\n${WhereAdminQuery()}\nAND ssp = '${selected_scenario.ssp}'\nAND horizon = '${selected_scenario.horizon}'\nAND cycle = '${selected_cycle_options.cycle}'\nAND crop = '${crop_selector_dynamic_insights}'\nAND cultivar = '${selected_cultivar.value}'\n`\n  let resp = await db.queryStream(query)\n  return resp.readRows()\n}\n\n\n\n\n\n\n\nselected_cultivar;\n\n\n\n\n\n\n\n// grab tabular data for choropleth\ndataGeoImpact = {\n  // get data for choropleth map based on choice\n  const dataSource = selectGeoDataType.key == \"population\"\n    ? dataYield\n    : dataYield\n\n  // select different data based on admin selections\n  if (adminSelections.selectAdmin1) {\n    // admin1 or 2 is selected, show all admin2's for selected admin1\n    return T.tidy(\n      dataSource,\n      T.filter((d) =&gt; {\n        return d.admin1_name == adminSelections.selectAdmin1\n          && d.admin2_name // always non-null\n      })\n    );\n  } else if (adminSelections.selectAdmin0) {\n    // admin0 is selected, with no admin1\n    // get all admin1 data for selected admin0\n    return T.tidy(\n      dataSource,\n      T.filter((d) =&gt; {\n        return d.admin0_name == adminSelections.selectAdmin0\n        && d.admin1_name // always non-null \n        && !d.admin2_name // always null\n      })\n    )\n  } else {\n    // end case: admin0 is not selected\n    // get all admin0 data\n    return T.tidy(\n      dataSource,\n      T.filter((d) =&gt; {\n        return !d.admin1_name // always null \n        && !d.admin2_name // always null\n      })\n    )\n  }\n}\n\n\n\n\n\n\n\n// bind geojson to tabular data\nmapDataGeoImpact = {\n  // no selections\n  if (!adminSelections.selectAdmin0) {\n    return bindTabularToGeo({\n      data: dataGeoImpact,\n      dataBindColumn: \"admin0_name\",\n      geoData: boundaries.admin0,\n      geoDataBindColumn: \"admin0_name\"\n    });\n  }\n  // admin0 selected only\n  else if (!adminSelections.selectAdmin1) {\n    const data = T.tidy(\n      dataGeoImpact,\n      T.mutate({ a1_a0: (d) =&gt; [d.admin1_name, d.admin0_name].join(\"_\") })\n    );\n    const geoData = {\n      ...boundaries.admin1,\n      features: boundaries.admin1.features.filter(\n        (d) =&gt; d.properties.admin0_name == adminSelections.selectAdmin0\n      )\n    };\n\n    return bindTabularToGeo({\n      data: data,\n      dataBindColumn: \"a1_a0\",\n      geoData: geoData,\n      geoDataBindColumn: \"a1_a0\"\n    });\n  }\n\n  // admin1 is selected\n  // show all admin2 regions within admin1\n  else {\n    const data = T.tidy(\n      dataGeoImpact,\n      T.mutate({\n        a2_a1_a0: (d) =&gt; [d.admin2_name, d.admin1_name, d.admin0_name].join(\"_\")\n      })\n    );\n    const geoData = {\n      ...boundaries.admin2,\n      features: boundaries.admin2.features.filter(\n        (d) =&gt; d.properties.admin1_name == adminSelections.selectAdmin1\n      )\n    };\n\n    return bindTabularToGeo({\n      data: data,\n      dataBindColumn: \"a2_a1_a0\",\n      geoData: geoData,\n      geoDataBindColumn: \"a2_a1_a0\"\n    });\n  }\n}\n\n\n\n\n\n\n\nfunction filterYieldDataByAdmins(d) {\n  if (adminSelections.selectAdmin0 == null) return d;\n  if (adminSelections.selectAdmin1 == null)\n    return (\n      d.admin0_name == adminSelections.selectAdmin0 && d.admin1_name == null\n    );\n  if (adminSelections.selectAdmin2 == null)\n    return (\n      d.admin0_name == adminSelections.selectAdmin0 &&\n      d.admin1_name == adminSelections.selectAdmin1 &&\n      d.admin2_name == null\n    );\n  return (\n    d.admin0_name == adminSelections.selectAdmin0 &&\n    d.admin1_name == adminSelections.selectAdmin1 &&\n    d.admin2_name == adminSelections.selectAdmin2\n  );\n}\n\n\n\n\n\n\n\nWhereAdminQuery = () =&gt; {\n  if (!selectAdmin0) {\n    // where admin0_name is null, it is ssa, return admin 0 data\n    return `WHERE admin1_name IS NULL`;\n  } else if (selectAdmin0 && !selectAdmin1) {\n    // Where admin0 is selected, return all admin 1 for that country\n    return `WHERE admin0_name == '${selectAdmin0}' AND admin1_name IS NOT NULL AND admin2_name IS NULL`;\n    // } else if (selectAdmin1 && !selectAdmin2) { // where admin0 and admin1 is selected, return all admin2 for that region/country\n    //   return `WHERE admin0_name = '${selectAdmin0}' AND admin1_name = '${selectAdmin1}' AND admin2_name IS NOT NULL`\n  } else {\n    return `WHERE admin0_name = '${selectAdmin0}' AND admin1_name = '${selectAdmin1}' AND admin2_name IS NOT NULL`;\n  }\n};\n\n\n\n\n\n\n\nmd`---\n## Data\n*Data sources*\n- Data is from local files downloaded from S3, uploaded as a file attachments\n- Data is then wrapped as a duckDB database table (separate tables for each parquet file)\n- We are using some simplified data sources, suffixed with reduced.parquet in the S3 bucket`;\n\n\n\n\n\n\n\nimport { db } from \"876b0cd897b4c214\";\n\n\n\n\n\n\n\nmutable DBloaded = false\n\n\n\n\n\n\n\n{\n  if (!DBloaded) {\n    document.body.style.cursor = \"wait\";\n  } else {\n    document.body.style.cursor = \"default\";\n  }\n}\n\n\n\n\n\n\n\nmd`### Geographic data\nGeo files were converted to TopoJSON and reduced in complexity before uploading to the notebook, see [Simplify large spatial files](https://observablehq.com/d/258c68ee969e8ed5?collection=@periscopic/ab-atlas) notebook for method.\n- **admin0**: broadest level, country boundaries\n  - boundaries/atlas-region_admin0_harmonized.geojson\n- **admin1**: one level down from admin0, regions within each admin0 region\n  - boundaries/atlas-region_admin1_simplified.parquet\n- **admin2**: lowest level, subregions of every admin1 region\n  - These are only loaded when needed and are called directly from the S3 bucket to reduce bandwidth and memory requirements\n  - https://digital-atlas.s3.amazonaws.com/boundaries/atlas-region_admin2_simplified.parquet`;\n\n\n\n\n\n\n\nadmin0_boundaries = {\n  const input0 = await FileAttachment(\"atlas-region_admin0_harmonized.json\").json()\n  return topojson.feature(input0, input0.objects[\"atlas-region_admin0_harmonized\"])\n}\n\n\n\n\n\n\n\nadmin1_boundaries = getadmin1();\n\n\n\n\n\n\n\nboundaries = {\n  const input1 = await getadmin1()\n  const input2 = await getadmin2()\n\n  const geo = {\n    admin0: admin0_boundaries,\n    admin1: admin1_boundaries,\n    admin2: await getadmin2(),\n  }\n  return geo\n}\n\n\n\n\n\n\n\ngetadmin1 = async () =&gt; {\n  let admin1_query = `WHERE admin0_name = '${selectAdmin0}'`;\n\n  let response = await geo_db.query(`\n    SELECT *\n    FROM admin1_geom\n    ${admin1_query}`);\n  let a1_names = response.map((d) =&gt; d.admin1_name);\n  // mutable admin1_names = [\"Full Country\"].concat(a1_names);\n  let wkb_list = response.map((d) =&gt; d.geometry);\n  let data = await response.map(({ geometry, ...rest }) =&gt; rest);\n\n  return geojsonFromWKB(wkb_list, data);\n};\n\n\n\n\n\n\n\ngetadmin2 = async () =&gt; {\n  if (!selectAdmin1) {\n    // If select Admin 1 is null, return without querying to save bandwidth\n    return {\n      type: \"FeatureCollection\",\n      features: [],\n    };\n  }\n  let admin2_query = `WHERE admin0_name = '${selectAdmin0}' AND admin1_name = '${selectAdmin1}'`;\n\n  let response = await geo_db.query(`\n    SELECT *\n    FROM admin2_geom\n    ${admin2_query}`);\n  let wkb_list = response.map((d) =&gt; d.geometry);\n  let data = await response.map(({ geometry, ...rest }) =&gt; rest);\n\n  return geojsonFromWKB(wkb_list, data);\n};\n\n\n\n\n\n\n\nfunction geojsonFromWKB(wkb, data = null) {\n  if (data && wkb.length !== data.length) {\n    throw new Error(\n      `Data length mismatch: expected ${wkb.length}, got ${data.length}`,\n    );\n  }\n\n  return {\n    type: \"FeatureCollection\",\n    features: wkb.map((wkbItem, i) =&gt; {\n      const geometry = wkx.Geometry.parse(Buffer.from(wkbItem)).toGeoJSON();\n      const geometryRewound = turfRewind(geometry, { reverse: true });\n      return {\n        type: \"Feature\",\n        geometry: geometryRewound,\n        properties: data ? data[i] : null,\n      };\n    }),\n  };\n}\n\n\n\n\n\n\n\ngeo_db = {\n  let db = await DuckDBClient.of({\n    admin1_geom: FileAttachment(\"atlas-region_admin1_simplified.parquet\")\n  });\n  await db.query(`\n    CREATE VIEW admin2_geom AS\n    SELECT *\n    FROM read_parquet(\"${resolveWindowsCacheIssue(\n      \"https://digital-atlas.s3.amazonaws.com/boundaries/atlas-region_admin2_simplified.parquet\"\n    )}\")`);\n  return db;\n}\n\n\n\n\n\n\n\nimport { resolveWindowsCacheIssue } from \"72281be2f13a0a72\";\n\n\n\n\n\n\n\nBuffer = (await import(\"https://cdn.jsdelivr.net/npm/buffer@6.0.3/+esm\"))\n  .Buffer;\n\n\n\n\n\n\n\nwkx = require(\"https://bundle.run/wkx@0.5.0\");\n\n\n\n\n\n\n\nturfRewind = require(\"@turf/turf\").then((t) =&gt; t.rewind);\n\n\n\n\n\n\n\nmd`***\n## Helpers\n*Functions and other good stuff*`;\n\n\n\n\n\n\n\nmd`---\n### Dynamic insights\n*functions for formatting results*`;\n\n\n\n\n\n\n\nfunction filterByAdminNames(data) {\n  // filter down data by combined selected admin0/admin1/admin2 Admin Selections\n  // pass data from query, use tidyjs to filter by admin selection\n  const result = T.tidy(\n    data,\n    T.filter((d) =&gt; {\n      return (\n        d.admin0_name == adminSelections.selectAdmin0 &&\n        d.admin1_name == adminSelections.selectAdmin1 &&\n        d.admin2_name == adminSelections.selectAdmin2\n      );\n    }),\n  );\n  return result;\n}\n\n\n\n\n\n\n\n// wrapper for format functions, show chosen default\nfunction formatWithDefault({\n  value = 1000,\n  format = (d) =&gt; d,\n  defaultValue = \"---\",\n  debug = false,\n} = {}) {\n  // apply a formatting function to a value\n  // return default value if undefined or null\n  if (value ?? true) {\n    return format(value);\n  } else {\n    return defaultValue;\n  }\n}\n\n\n\n\n\n\n\nmd`---\n### Data functions: format and transform\n*apply formatting to/transform a value*\n\n- Reference: [Intl.NumberFormat()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/NumberFormat/NumberFormat)`;\n\n\n\n\n\n\n\nmd`### Transforms`;\n\n\n\n\n\n\n\n// transform non-number to percent value\ntransformPercent = (d) =&gt; {\n  if (d === undefined || d === null) return d;\n  else return d * 100;\n};\n\n\n\n\n\n\n\nmd`### Formatting`;\n\n\n\n\n\n\n\n// format non-number as percent\nformatPercentTenth = (d) =&gt; {\n  if (d === undefined || d === null) return d;\n  else return d3.format(\".1%\")(d);\n};\n\n\n\n\n\n\n\n// format non-number as percent\nformatPercentWhole = (d) =&gt; {\n  if (d === undefined || d === null) return d;\n  else return d3.format(\".0%\")(d);\n};\n\n\n\n\n\n\n\n// format US currency\nformatUSD = new Intl.NumberFormat(\"en-US\", {\n  notation: \"compact\",\n  compactDisplay: \"short\",\n  style: \"currency\",\n  currency: \"usd\",\n}).format;\n\n\n\n\n\n\n\n// format number, long notation\nformatNumCompactLong = new Intl.NumberFormat(\"en-US\", {\n  notation: \"compact\",\n  compactDisplay: \"long\",\n  unitDisplay: \"long\",\n}).format;\n\n\n\n\n\n\n\n// format number, long notation\nformatNumCompactShort = new Intl.NumberFormat(\"en-US\", {\n  notation: \"compact\",\n  compactDisplay: \"short\",\n}).format;\n\n\n\n\n\n\n\nmd`---\n### Querying data\n*functions for querying data*`;\n\n\n\n\n\n\n\nfunction getUniqueValues(col, tbl, db) {\n  // return unique values of from db tbl as a list\n  return db\n    .query(`select distinct ${col} from ${tbl}`)\n    .then((x) =&gt; x.map((d) =&gt; d[col]))\n    .then((r) =&gt; r.toArray());\n}\n\n\n\n\n\n\n\nfunction bindTabularToGeo({\n  data = [],\n  dataBindColumn = \"dataBindColumn\",\n  geoData = [],\n  geoDataBindColumn = \"geoDataBindColumn\",\n}) {\n  // bind data to geojson\n  const index = new Map(data.map((d) =&gt; [d[dataBindColumn], d])); // map data by dataBindColumn\n  const geojson = JSON.parse(JSON.stringify(geoData)); // do a copy, rather than mutate\n  // join up data to geojson\n  for (const f of geojson.features) {\n    f.properties.data = index.get(f.properties[geoDataBindColumn]);\n  }\n  return geojson;\n}\n\n\n\n\n\n\n\nmd`## Imports`;\n\n\n\n\n\n\n\nimport { toc } from \"@nebrius/indented-toc\";\n\n\n\n\n\n\n\nimport { T } from \"@pbeshai/tidyjs\";\n\n\n\n\n\n\n\nquick_insights_projected_1 = FileAttachment(\n  \"quick_insights_projected_1@1.json\",\n).json();\n\n\n\n\n\n\n\nquick_insights_projected_2 = FileAttachment(\n  \"quick_insights_projected_2@1.json\",\n).json();\n\n\n\n\n\n\n\nquick_insights_projected_3 = FileAttachment(\n  \"quick_insights_projected_3_only_africa.json\",\n).json();"
  },
  {
    "objectID": "notebooks/heatstressProducers/notebook.html",
    "href": "notebooks/heatstressProducers/notebook.html",
    "title": "Appendix",
    "section": "",
    "text": "import { heroImage } from \"/helpers/hero.js\";\nhero_url = \"./../../images/hsh.webp\";\n\nhero = heroImage(notebookTitle, hero_url);\nhtml`${hero}`;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nimport { atlasTOC } from '/helpers/toc.ojs' \n{\n  await nbText // force wait/reload with nbText to load so headings have correct labels/languages\n  return atlasTOC({\n      heading: `&lt;b&gt;${_lang({en:\"In this notebook\", fr:\"Dans ce notebook\"})}&lt;/b&gt;`,\n      skip: [notebookTitle, \"notebook-title\", \"Appendix\", \"source-code\"]\n      })\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n// pretty view of language toggle\nviewof prettyLanguageView = {\n  return Inputs.bind(\n    Inputs.radio(languages, {\n      label: _lang(nbText.legends.language),\n      format: (d) =&gt; d.label\n    }),\n    viewof language\n  );\n}\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.sections.overview.title)}\n\n${_lang(nbText.sections.overview.intro)}`;\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.sections.futureWorkforce.title)}\n\n${_lang(nbText.sections.futureWorkforce.intro)}`;\n\n\n\n\n\n\n\n// format admin selections\n// bind to appendix inputs, add template to format\ngeoImpactAdminSelectors = Inputs.form(\n  [\n    Inputs.bind(\n      Inputs.select(dataAdmin0, { label: adminRegions.labels.admin0, format: x =&gt; x.label }),\n      viewof selectAdmin0\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin1, { label: adminRegions.labels.admin1, format: x =&gt; x.label }),\n      viewof selectAdmin1\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin2, { label: adminRegions.labels.admin2, format: x =&gt; x.label }),\n      viewof selectAdmin2\n    )\n  ],\n  {\n    template: adminFormTemplate\n  }\n)\n\n\n\n\n\n\n\n// define choices for the data value\nviewof selectGeoDataType = {\n  const options = [\n    {\n      key: \"ag_workforce_data_2\", // lookup id for data option\n      dataColumn: \"corrected_ag_pop\", // data column\n      label: _lang(nbText.sections.futureWorkforce.map.mapLayer.values.ag_workforce_data_2.label), // label\n      labelTip: _lang(nbText.sections.futureWorkforce.map.mapLayer.values.ag_workforce_data_2.labelTip), // label for tooltip\n      labelLegend: _lang(nbText.sections.futureWorkforce.map.mapLayer.values.ag_workforce_data_2.labelLegend), // label for legend\n      formatFunc: formatNumCompactShort({locale: language.locale}), // formatting function for raw data value\n      colorRange: colorScales.range.yellowGreen, // color range\n      colorUnknown: colorScales.unknown, // unknown fill color \n    },\n    {\n      key: \"ag_workforce_data_1\",\n      dataColumn: \"agw_total_mid\",\n      label: _lang(nbText.sections.futureWorkforce.map.mapLayer.values.ag_workforce_data_1.label), \n      labelTip: _lang(nbText.sections.futureWorkforce.map.mapLayer.values.ag_workforce_data_1.labelTip), \n      labelLegend: _lang(nbText.sections.futureWorkforce.map.mapLayer.values.ag_workforce_data_1.labelLegend), \n      formatFunc: d =&gt; `${formatNumCompactShort({locale: language.locale})(d)}%`,\n      colorRange: colorScales.range.redYellowGreen,\n      colorUnknown: colorScales.unknown,\n    },\n    {\n      key: \"ag_workforce_data\",\n      dataColumn: \"agw_total\",\n      label: _lang(nbText.sections.futureWorkforce.map.mapLayer.values.ag_workforce_data.label), \n      labelTip: _lang(nbText.sections.futureWorkforce.map.mapLayer.values.ag_workforce_data.labelTip), \n      labelLegend: _lang(nbText.sections.futureWorkforce.map.mapLayer.values.ag_workforce_data.labelLegend), \n      formatFunc: d =&gt; `${formatNumCompactShort({locale: language.locale})(d)}%`,\n      colorRange: colorScales.range.redYellowGreen,\n      colorUnknown: colorScales.unknown,\n    },\n    {\n      key: \"ag_workforce_data_15\",\n      dataColumn: \"agw_total_mid_abs\",\n      label: _lang(nbText.sections.futureWorkforce.map.mapLayer.values.ag_workforce_data_15.label), \n      labelTip: _lang(nbText.sections.futureWorkforce.map.mapLayer.values.ag_workforce_data_15.labelTip), \n      labelLegend: _lang(nbText.sections.futureWorkforce.map.mapLayer.values.ag_workforce_data_15.labelLegend), \n      formatFunc: formatNumCompactShort({locale: language.locale}),\n      colorRange: colorScales.range.yellowGreen,\n      colorUnknown: colorScales.unknown,\n    },\n    {\n      key: \"ag_workforce_data_10\",\n      dataColumn: \"agw_total_abs\",\n      label: _lang(nbText.sections.futureWorkforce.map.mapLayer.values.ag_workforce_data_10.label), \n      labelTip: _lang(nbText.sections.futureWorkforce.map.mapLayer.values.ag_workforce_data_10.labelTip), \n      labelLegend: _lang(nbText.sections.futureWorkforce.map.mapLayer.values.ag_workforce_data_10.labelLegend), \n      formatFunc: formatNumCompactShort({locale: language.locale}),\n      colorRange: colorScales.range.yellowGreen,\n      colorUnknown: colorScales.unknown,\n    },\n  ];\n  return Inputs.radio(options.sort((a,b) =&gt; b.key.localeCompare(a.key)), {\n    width: 300,\n    label: _lang(nbText.sections.futureWorkforce.map.mapLayer.title),\n    format: (x) =&gt; x.label,\n    value: options.find((t) =&gt; t.key === \"ag_workforce_data_2\")\n  });\n}\n\n\n\n\n\n\n\nplotChoroplethGeoImpact = {\n  const data = mapDataGeoImpact;\n  const selector = selectGeoDataType;\n\n  const allValues = data.features.flatMap((d) =&gt;\n    d.properties.data && d.properties.data[selector.dataColumn] !== undefined\n      ? [Math.abs(d.properties.data[selector.dataColumn])]\n      : []\n  );\n\n  const caption = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.sections.futureWorkforce.map.caption),\n    [{ name: \"selector\", value: selector.label }]\n  );\n\n  // return plot\n  return Plot.plot({\n    width: mapWidth,\n    height: 600,\n    caption,\n    projection: {\n      type: \"azimuthal-equal-area\",\n      domain: data\n    },\n    color: {\n      legend: true,\n      label: selector.labelLegend,\n      range: selector.colorRange,\n      unknown: selector.colorUnknown,\n      tickFormat: (d) =&gt; {\n        // Check if dataColumn is one of the specified types\n        if (\n          selector.dataColumn === \"corrected_ag_pop\" ||\n          selector.dataColumn === \"agw_total_mid_abs\" ||\n          selector.dataColumn === \"agw_total_abs\"\n        ) {\n          // Use the provided formatFunc and append a \"%\" symbol for these types\n          return selector.formatFunc(d);\n        } else {\n          // For other types, just use the formatFunc without appending a \"%\" symbol\n          return `${selector.formatFunc(d)}`;\n        }\n      },\n      domain:\n        selector.dataColumn === \"corrected_ag_pop\" ||\n        selector.dataColumn === \"agw_total_mid_abs\" ||\n        selector.dataColumn === \"agw_total_abs\"\n          ? [0, Math.max(...allValues)]\n          : [-Math.max(...allValues), Math.max(...allValues)]\n    },\n    marks: [\n      // geo data\n      Plot.geo(data.features, {\n        fill: (d) =&gt; {\n          const dataColumn = selector.dataColumn;\n          const fillValue = d.properties.data\n            ? d.properties.data[dataColumn]\n            : null; // handle missing data\n          return fillValue;\n        },\n        stroke: \"#fff\",\n        strokeWidth: 0.5\n      }),\n      // admin2 highlight\n      // if Admin selection includes admin2, highlight section\n      Plot.geo(\n        adminSelections.selectAdmin2.value\n          ? data.features.filter(\n              (d) =&gt; d.properties.admin2_name == adminSelections.selectAdmin2.value\n            )\n          : [],\n        {\n          fill: null,\n          stroke: \"#333\",\n          strokeWidth: 1.5\n        }\n      ),\n      // geo pointer\n      Plot.geo(\n        data,\n        Plot.pointer(\n          Plot.centroid({\n            stroke: \"#333\",\n            strokeWidth: 1.5\n          })\n        )\n      ),\n      // tooltip\n      Plot.tip(\n        data.features,\n        Plot.pointer(\n          Plot.centroid({\n            channels: {\n              name: {\n                // region label, based on selection\n                label: Lang.toTitleCase(getLowerLevelAdminLabel()), // plot-level so inputs don't reload\n                value: (d) =&gt; _lang(td.admin0_name.values?.[d.properties.admin_name]) ?? d.properties.admin_name\n              },\n              data: {\n                label: selector.labelTip,\n                value: (d) =&gt; {\n                  const dataColumn = selector.dataColumn;\n                  const data = d.properties.data\n                    ? d.properties.data[dataColumn]\n                    : undefined;\n                  return data;\n                }\n              }\n            },\n            format: {\n              name: true,\n              data: (d) =&gt; `${selector.formatFunc(d)}`\n            }\n          })\n        )\n      )\n    ]\n  });\n}\n\n\n\n\n\n\n\nbuildInlineDownloadButton(\n  dataGeoImpact,\n  _lang(download_translation),\n  `agWorkforce_${selectAdmin0.label.replace(/\\s/g, \"\")}`,\n);\n\n\n\n\n\n\n\nheaderQuickInsightsGeoImpact = {\n  const adminArticle = _lang(getAdminSelection()?.data?.article1);\n  const adminSelection = adminArticle ?? getAdminSelection().label;\n  const text = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.sections.quickInsightsGeneral.header),\n    [{ name: \"selection\", value: adminSelection }]\n  );\n\n  return md`### ${text}`;\n}\n\n\n\n\n\n\n\n// text insights for geo impact\ntextDynamicInsights_geoImpact = {\n  const adminSelection = getAdmin0WithAdminSubParens({articleField: \"article2\"});\n  const i = dynamicInsights_geoImpact.insight;\n\n  const currentAgPop = i.totalAgPop_noformat;\n  // totalVop is the projected change in agricultural population by 2050\n  const projectedChange2050 = i.totalAgPop_2_50_noformat;\n  const projectedChange2030 = i.totalAgPop_2_30_noformat;\n\n  // string for percent change\n  const percChangeType = (d) =&gt;\n    d &gt;= 0\n      ? _lang(nbText.sections.futureWorkforce.quickInsights.direction.inc)\n      : _lang(nbText.sections.futureWorkforce.quickInsights.direction.dec);\n\n  // Calculate the new total agricultural population for 2050\n  const newTotalAgPop2050 = currentAgPop + projectedChange2050;\n\n  // Calculate the percentage change\n  let percentChange50 =\n    ((projectedChange2050 - currentAgPop) / currentAgPop) * 100;\n  let changeType50 = percChangeType(percentChange50);\n  percentChange50 = Math.abs(percentChange50).toFixed(1); // Keeping two decimals for readability\n\n  let percentChange30 =\n    ((projectedChange2030 - currentAgPop) / currentAgPop) * 100;\n  let changeType30 = percChangeType(percentChange30);\n  percentChange30 = Math.abs(percentChange30).toFixed(1); // Keeping two decimals for readability\n\n  let percentChange_5 =\n    ((i.totalAgPop_5_50_noformat - currentAgPop) / currentAgPop) * 100;\n  let changeType_5 = percChangeType(percentChange_5);\n  percentChange_5 = Math.abs(percentChange_5).toFixed(1); // Keeping two decimals for readability\n\n  let percentChange30_5 =\n    ((i.totalAgPop_5_30_noformat - currentAgPop) / currentAgPop) * 100;\n  let changeType30_5 = percChangeType(percentChange30_5);\n  percentChange30_5 = Math.abs(percentChange30_5).toFixed(1); // Keeping two decimals for readability\n\n  const selectedCountry = getAdminSelection0().value; // Function to get the selected country\n  const countriesWithoutData = [\n    \"Burundi\",\n    \"Rwanda\",\n    \"Lesotho\",\n    \"Gabon\",\n    \"Eswatini\",\n    \"Equatorial Guinea\"\n  ];\n\n  const insightBase = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.sections.futureWorkforce.quickInsights.basePop),\n    [\n      { name: \"geo\", value: adminSelection },\n      { name: \"total\", value: i.totalAgPop }\n    ]\n  );\n  const insightPopChange = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.sections.futureWorkforce.quickInsights.popChange),\n    [\n      { name: \"change2030\", value: i.totalAgPop_2_30 },\n      { name: \"change2050\", value: i.totalAgPop_2_50 },\n      { name: \"direction2030\", value: changeType30 },\n      { name: \"direction2050\", value: changeType50 },\n      { name: \"perc2030\", value: percentChange30 },\n      { name: \"perc2050\", value: percentChange50 }\n    ]\n  );\n  const insightPopScenario = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.sections.futureWorkforce.quickInsights.popScenario),\n    [\n      { name: \"pop2030\", value: i.totalAgPop_5_30 },\n      { name: \"pop2050\", value: i.totalAgPop_5_50 },\n      { name: \"direction\", value: changeType30_5 },\n      { name: \"perc2030\", value: percentChange30_5 },\n      { name: \"perc2050\", value: percentChange_5 }\n    ]\n  )\n\n  // Check if the selected country is in the list of countries without data\n  if (countriesWithoutData.includes(selectedCountry)) {\n    return md`${_lang(nbText.sections.quickInsightsGeneral.noDataBlurb)}`;\n  } else {\n    return md`${styling}${insightBase}\n\n${insightPopChange}\n\n${insightPopScenario}`;\n  }\n}\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.sections.heatStress.title)}`;\n\n\n\n\n\n\n\nmd`${_lang(nbText.sections.heatStress.intro)}`;\n\n\n\n\n\n\n\n// format admin selections\n// bind to appendix inputs, add template to format\nInputs.form(\n  [\n    Inputs.bind(\n      Inputs.select(dataAdmin0, { label: adminRegions.labels.admin0, format: x =&gt; x.label }),\n      viewof selectAdmin0\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin1, { label: adminRegions.labels.admin1, format: x =&gt; x.label }),\n      viewof selectAdmin1\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin2, { label: adminRegions.labels.admin2, format: x =&gt; x.label }),\n      viewof selectAdmin2\n    )\n  ],\n  {\n    template: adminFormTemplate\n  }\n)\n\n\n\n\n\n\n\nviewof selectScenarioAndTimeframe = {\n  // scenario and timeframe\n\n  const data = [\n    {label: 'SSP245: 2030', scenario: 'SSP2', timeframe: '2030'},\n    {label: 'SSP245: 2050', scenario: 'SSP2', timeframe: '2050'},\n    {label: 'SSP585: 2030', scenario: 'SSP5', timeframe: '2030'},\n    {label: 'SSP585: 2050', scenario: 'SSP5', timeframe: '2050'},\n  ]\n  \n  return Inputs.select(data, {\n    label: _lang(nbText.legends.scenario),\n    format: x =&gt; x.label,\n    value: data.find(d =&gt; d.label === 'SSP245: 2050')\n  });\n}\n\n\n\n\n\n\n\nviewof selectThreshold = {\n  // scenario and timeframe\n\n  const data = [\n    {label: '28°C', threshold: '28'},\n    {label: '30°C', threshold: '30'},\n  ]\n  \n  return Inputs.select(data, {\n    label: _lang(nbText.legends.threshold),\n    format: x =&gt; x.label,\n    value: data.find(d =&gt; d.label === '28')\n  });\n}\n\n\n\n\n\n\n\n{\n  const _anyData = T.tidy(\n    data_hazardVoP,\n    T.groupBy(\n      [\n        \"admin0_name\",\n        \"admin1_name\",\n        \"admin2_name\",\n        \"scenario\",\n        \"timeframe\",\n        \"threshold\",\n        \"crop\"\n      ],\n      [\n        T.summarize({\n          vop_any: T.sum(\"vop\")\n        })\n      ]\n    )\n  );\n\n  const _dataWithAnyColumn = T.tidy(\n    data_hazardVoP,\n    T.leftJoin(_anyData, {\n      by: [\n        \"admin0_name\",\n        \"admin1_name\",\n        \"admin2_name\",\n        \"scenario\",\n        \"timeframe\",\n        \"crop\",\n        \"threshold\"\n      ]\n    })\n  );\n\n  const data = _dataWithAnyColumn;\n  const dataAny = data.filter((d) =&gt; d.hazard == \"any\"); // combined\n  const dataBars = [\n    ...data.filter((d) =&gt; d.hazard !== \"any\" && d.vop !== 0) // remove the combined hazard\n  ];\n  const _formatNumber = formatNumCompactShort({locale: language.locale});\n  const xDomain = cropNames\n  .filter(d =&gt; {\n    const availableCrops = _.uniq(dataBars.map(d =&gt; d.crop));\n    return availableCrops.includes(d.crop);\n  })\n  .map(d =&gt; {\n    const upperBound = parseInt(d.cropName, 10); // Assuming cropName is the upper bound\n    const lowerBound = Math.max(0, upperBound - 5);\n    return `${lowerBound}-${upperBound}%`;\n  });\n\n  const maxValue = d3.max(dataBars, (d) =&gt; d.vop) * 1.5; // adding 10% buffer\n\n  return Plot.plot({\n    // caption: `To ensure that the details across all bins are visible without being dominated by the initial range, the 0-5% bin has been intentionally excluded from this visualization.`,\n    caption: _lang(nbText.sections.heatStress.barChart.caption),\n    width,\n    height: 600,\n    marginLeft: 40,\n    marginRight: 40,\n    marginBottom: 40,\n    color: {\n      domain: hazardPlotLookup.color.domain,\n      range: hazardPlotLookup.color.range,\n      legend: true\n    },\n    x: {\n      domain: xDomain,\n      label: _lang(nbText.sections.heatStress.barChart.xLabel),\n      labelStyle: { fontSize: '36px' }, // Hypothetical API\n    },\n    y: {\n      nice: true,\n      grid: true,\n      label: _lang(nbText.sections.heatStress.barChart.yLabel),\n      tickFormat: d =&gt; _formatNumber(d),\n    },\n    marks: [\n      // main x-axis\n      Plot.axisX({\n        tickSize: 0,\n        // lineWidth: 3,\n      }),\n      // pointer white-out\n      Plot.axisX(\n        Plot.pointerX({\n          label: null,\n          fill: \"white\",\n          textStroke: \"white\",\n          textStrokeWidth: 1,\n          tickSize: 0\n        })\n      ),\n      // bold pointer\n      Plot.axisX(\n        Plot.pointerX({\n          fontWeight: \"bold\",\n          label: null,\n          tickSize: 0\n        })\n      ),\n      // hazard component bars\n      Plot.barY(\n        dataBars,\n        Plot.stackY(\n          { order: hazardPlotLookup.color.domain },\n          {\n            y: (d) =&gt; d.vop,\n            x: d =&gt; {\n      const upperBound = parseInt(hazardPlotLookup.crops[d.crop], 10); // Assuming this gives the upper bound as before\n      const lowerBound = Math.max(0, upperBound - 5);\n      return `${lowerBound}-${upperBound}%`;\n    },\n            fill: (d) =&gt; hazardPlotLookup.names[d.hazard],\n            stroke: \"#fff\",\n            strokeWidth: 0.25\n          }\n        )\n      ),\n      // tooltip\n      Plot.tip(\n        dataBars,\n        Plot.pointerX(\n          Plot.stackY(\n            { order: hazardPlotLookup.color.domain },\n            {\n              y: (d) =&gt; d.vop,\n              x: d =&gt; {\n      const upperBound = parseInt(hazardPlotLookup.crops[d.crop], 10); // Assuming this gives the upper bound as before\n      const lowerBound = Math.max(0, upperBound - 5);\n      return `${lowerBound}-${upperBound}%`;\n    },\n              fill: (d) =&gt; hazardPlotLookup.names[d.hazard],\n              channels: {\n                hazard: {\n                  label: _lang(nbText.sections.heatStress.barChart.tooltip.period),\n                  value: (d) =&gt; hazardPlotLookup.names[d.hazard]\n                },\n                vop: {\n                  label: _lang(nbText.sections.heatStress.barChart.tooltip.exposed),\n                  value: (d) =&gt; {\n                    const vop = d.vop;\n                    return `(${vop})`;\n                  },\n                  value:  (d) =&gt;  _formatNumber(d.vop)\n                }\n              },\n              format: {\n                x: false,\n                y: false,\n                fill: false,\n                vop: true,\n                hazard: true,\n                perc: true\n              }\n            }\n          )\n        )\n      ),\n      // total VoP, sidebar highlight\n      Plot.textY(\n        dataAny,\n        Plot.pointer({\n          y: maxValue,\n          x: d =&gt; {\n      const upperBound = parseInt(hazardPlotLookup.crops[d.crop], 10); // Assuming this gives the upper bound as before\n      const lowerBound = Math.max(0, upperBound - 5);\n      return `${lowerBound}-${upperBound}%`;\n    },\n          text: (d) =&gt; {\n            const value = d.vop_total;\n            return `${value}`;\n          },\n          textAnchor: \"start\",\n          dx: 6\n        })\n      )\n    ]\n  });\n}\n\n\n\n\n\n\n\n{\n  const _anyData = T.tidy(\n    data_hazardVoP,\n    T.groupBy(\n      [\n        \"admin0_name\",\n        \"admin1_name\",\n        \"admin2_name\",\n        \"scenario\",\n        \"timeframe\",\n        \"threshold\",\n        \"crop\"\n      ],\n      [\n        T.summarize({\n          vop_any: T.sum(\"vop\")\n        })\n      ]\n    )\n  );\n\n  const _dataWithAnyColumn = T.tidy(\n    data_hazardVoP,\n    T.leftJoin(_anyData, {\n      by: [\n        \"admin0_name\",\n        \"admin1_name\",\n        \"admin2_name\",\n        \"scenario\",\n        \"timeframe\",\n        \"crop\",\n        \"threshold\"\n      ]\n    })\n  );\n\n  const data = _dataWithAnyColumn;\n  return buildInlineDownloadButton(data, _lang(download_translation), `daysUnsafeHeatStress_${selectAdmin0.label.replace(/\\s/g, \"\")}`)\n}\n\n\n\n\n\n\n\nmd`${_lang(nbText.sections.heatStress.figureBody)}`;\n\n\n\n\n\n\n\nheaderQuickInsightsBars = {\n  const adminArticle = _lang(getAdminSelection()?.data?.article1);\n  const adminSelection = adminArticle ?? getAdminSelection().label;\n  const text = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.sections.quickInsightsGeneral.header),\n    [{ name: \"selection\", value: adminSelection }]\n  );\n\n  return md`### ${text}`;\n}\n\n\n\n\n\n\n\n{\n  const crop = insight_totalExposedVop.filter(\n    (d) =&gt; d.totalExposedVop !== 0 && d.cropType == \"crop\"\n  )?.[0]?.[\"totalExposedVop\"];\n\n  const totalExposedVopBaseline =\n    insight_totalExposedVop.find(\n      (d) =&gt; d.cropType === \"crop\" && d.hazard === \"baseline\"\n    )?.totalExposedVop || \"no data\";\n  const totalExposedVopProjection =\n    insight_totalExposedVop.find(\n      (d) =&gt; d.cropType === \"crop\" && d.hazard === \"projection\"\n    )?.totalExposedVop || \"no data\";\n  const totalExposedVopOver30 =\n    insight_totalExposedVop.find((d) =&gt; d.hazard === \"projection\")\n      ?.totalExposedVopOver30 || 0;\n  const totalExposedVopOver50 =\n    insight_totalExposedVop.find((d) =&gt; d.hazard === \"projection\")\n      ?.totalExposedVopOver50 || 0;\n  const totalExposedVopOver30_b =\n    insight_totalExposedVop.find((d) =&gt; d.hazard === \"baseline\")\n      ?.totalExposedVopOver30 || 0;\n  const totalExposedVopOver50_b =\n    insight_totalExposedVop.find((d) =&gt; d.hazard === \"baseline\")\n      ?.totalExposedVopOver50 || 0;\n\n  const formatVop = (vop) =&gt;\n    vop === \"no data\"\n      ? vop\n      : formatNumCompactShort({ locale: language.locale })(vop);\n\n  function findTopCropByHazard(hazardType) {\n    const filteredCrops = T.tidy(\n      data_selectedHazardCropType,\n      T.select([\"cropType\", \"crop\", \"vop\", \"hazard\"]),\n      T.filter((d) =&gt; d.cropType == \"crop\" && d.hazard == hazardType),\n      T.sliceMax(1, \"vop\")\n    );\n\n    return filteredCrops[0]; // Assuming there's at least one entry after filtering\n  }\n\n  // Calculate topCrop_b and topCrop_p using the adjusted function\n  const topCrop_b = findTopCropByHazard(\"baseline\");\n  const topCrop_p = findTopCropByHazard(\"projection\");\n\n  const lowerBound_b = hazardPlotLookup.crops[topCrop_b?.[\"crop\"]] - 5;\n  const upperBound_b = hazardPlotLookup.crops[topCrop_b?.[\"crop\"]];\n\n  const lowerBound_p = hazardPlotLookup.crops[topCrop_p?.[\"crop\"]] - 5;\n  const upperBound_p = hazardPlotLookup.crops[topCrop_p?.[\"crop\"]];\n\n  const missingValue = \"--- no data for that bin ---\";\n\n  function showResult(value, format) {\n    if (value === null || value === undefined) return missingValue;\n    return format(value);\n  }\n\n  function findMedianCropWithVop(data) {\n    const sortedData = [...data]\n      .filter((d) =&gt; !isNaN(d.vop))\n      .sort((a, b) =&gt; a.vop - b.vop);\n    const medianIndex = Math.floor(sortedData.length / 2);\n\n    if (sortedData.length === 0) return { crop: undefined, vop: undefined };\n\n    return sortedData.length % 2 !== 0\n      ? sortedData[medianIndex]\n      : sortedData[medianIndex];\n  }\n  const baselineData = data_selectedHazardCropType.filter(\n    (d) =&gt; d.hazard === \"baseline\" && d.cropType == \"crop\"\n  );\n  const projectionData = data_selectedHazardCropType.filter(\n    (d) =&gt; d.hazard === \"projection\"\n  );\n\n  const medianCropInfoBaseline = findMedianCropWithVop(baselineData);\n  const medianCropInfoProjection = findMedianCropWithVop(projectionData);\n\n  const getBinBounds = (cropValue) =&gt; {\n    // Assuming cropValue directly relates to the bin, adjust as necessary for your logic\n    const lowerBound = cropValue - (cropValue % 5); // Adjust based on how bins are defined\n    const upperBound = lowerBound + 5;\n    return { lowerBound, upperBound };\n  };\n\n  const medianCropBaselineBounds = getBinBounds(medianCropInfoBaseline.crop);\n  const medianCropProjectionBounds = getBinBounds(\n    medianCropInfoProjection.crop\n  );\n\n  // Example function to convert percentages to months\n  function percentToMonths(percent) {\n    return (percent * 12) / 100;\n  }\n\n  // Calculate months for baseline and projection median bins\n  const baselineMonthsLower = percentToMonths(\n    medianCropBaselineBounds.lowerBound\n  );\n  const baselineMonthsUpper = percentToMonths(\n    medianCropBaselineBounds.upperBound\n  );\n  const projectionMonthsLower = percentToMonths(\n    medianCropProjectionBounds.lowerBound\n  );\n  const projectionMonthsUpper = percentToMonths(\n    medianCropProjectionBounds.upperBound\n  );\n\n  let percentChange =\n    ((totalExposedVopOver50 - totalExposedVopOver50_b) /\n      totalExposedVopOver50_b) *\n    100;\n  percentChange = Math.abs(percentChange).toFixed(1);\n  let changeType = percentChange &gt;= 0 ? \"an increase\" : \"a decrease\";\n\n  let percentChange2 =\n    ((totalExposedVopOver30 - totalExposedVopOver30_b) /\n      totalExposedVopOver30_b) *\n    100;\n  percentChange2 = Math.abs(percentChange2).toFixed(1);\n  let changeType2 = percentChange &gt;= 0 ? \"an increase\" : \"a decrease\";\n\n  const scenarioLabel =\n    selectScenarioAndTimeframe.scenario === \"SSP2\" ? \"SSP2 4.5\" : \"SSP5 8.5\";\n\n  // const over30Insight = `For the baseline period, **${formatVop(\n  //   totalExposedVopOver50_b\n  // )}** people experienced unsafe working conditions for at least **half of the days** in the year. Under the scenario **${scenarioLabel}** and year **${\n  //   selectScenarioAndTimeframe.timeframe\n  // }**, it's expected to rise to **${formatVop(\n  //   totalExposedVopOver50\n  // )}** people.`;\n\n  const insightOver30 = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.sections.heatStress.quickInsights.overview),\n    [\n      { name: \"baseRisk\", value: formatVop(totalExposedVopOver30_b) },\n      { name: \"scenario\", value: scenarioLabel },\n      { name: \"year\", value: selectScenarioAndTimeframe.timeframe },\n      { name: \"projectionRisk\", value: formatVop(totalExposedVopOver30) }\n    ]\n  );\n\n  const insightOver50 = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.sections.heatStress.quickInsights.half),\n    [\n      { name: \"baseline\", value: formatVop(totalExposedVopOver50_b) },\n      { name: \"scenario\", value: scenarioLabel },\n      { name: \"year\", value: selectScenarioAndTimeframe.timeframe },\n      { name: \"projection\", value: formatVop(totalExposedVopOver50) }\n    ]\n  );\n\n  // const over50Insight = `For over **100 days** in a year, the people at risk for the baseline were **${formatVop(\n  //   totalExposedVopOver30_b\n  // )}**; under the scenario **${scenarioLabel}** and year **${\n  //   selectScenarioAndTimeframe.timeframe\n  // }**, it ascends to **${formatVop(totalExposedVopOver30)}**.`;\n\n  const medianExplanation = `When we say we're 'looking at the median', we mean focusing on the group in the exact middle when arranging everyone from the least to the most exposed to heat stress over the year. It's like finding the middle point in a line of people sorted by how long they're exposed to high heat.`;\n\n  const selectedCountry = getAdminSelection0().value; // Function to get the selected country\n  const countriesWithoutData = [\n    \"Burundi\",\n    \"Rwanda\",\n    \"Lesotho\",\n    \"Gabon\",\n    \"Eswatini\",\n    \"Equatorial Guinea\"\n  ];\n\n  // Check if the selected country is in the list of countries without data\n  if (countriesWithoutData.includes(selectedCountry)) {\n    return md`${_lang(nbText.sections.quickInsightsGeneral.noDataBlurb)}`;\n  } else {\n    return md`${insightOver30}\n\n${insightOver50}`;\n  }\n}\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.sections.workingHours.title)}\n\n${_lang(nbText.sections.workingHours.intro)}`;\n\n\n\n\n\n\n\nviewBindAdminSelectors = // format admin selections\n// bind to appendix inputs, add template to format\nInputs.form(\n  [\n    Inputs.bind(\n      Inputs.select(dataAdmin0, { label: adminRegions.labels.admin0, format: x =&gt; x.label }),\n      viewof selectAdmin0\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin1, { label: adminRegions.labels.admin1, format: x =&gt; x.label }),\n      viewof selectAdmin1\n    ),\n    Inputs.bind(\n      Inputs.select(dataAdmin2, { label: adminRegions.labels.admin2, format: x =&gt; x.label }),\n      viewof selectAdmin2\n    )\n  ],\n  {\n    template: adminFormTemplate\n  }\n)\n\n\n\n\n\n\n\nviewof selectScenarioAndTimeframe2 = {\n  // scenario and timeframe\n\n  const data = [\n    // {label: 'SSP245: 2030', scenario: 'SSP2', timeframe: '2030'},\n    {label: 'SSP245: 2050', scenario: 'SSP245', timeframe: '2050'},\n    // {label: 'SSP585: 2030', scenario: 'SSP5', timeframe: '2030'},\n    {label: 'SSP585: 2050', scenario: 'SSP585', timeframe: '2050'},\n  ]\n  \n  return Inputs.select(data, {\n    label: _lang(nbText.legends.scenario),\n    format: x =&gt; x.label,\n    value: data.find(d =&gt; d.label === 'SSP245: 2050')\n  });\n}\n\n\n\n\n\n\n\nviewof selectThreshold2 = {\n  // threshold\n\n  const data = [\n    {label: '28°C', threshold: '28'},\n    {label: '30°C', threshold: '30'},\n    {label: '32°C', threshold: '32'},\n  ]\n  \n  return Inputs.select(data, {\n    label: _lang(nbText.legends.threshold),\n    format: x =&gt; x.label,\n    value: data.find(d =&gt; d.label === '30')\n  });\n}\n\n\n\n\n\n\n\nviewof radios = {\n  const data = [\n    {\n      label: Lang.toTitleCase(_lang(nbText.legends.seasonTypes.planting)),\n      value: \"planting\"\n    },\n    {\n      label: Lang.toTitleCase(_lang(nbText.legends.seasonTypes.harvesting)),\n      value: \"harvesting\"\n    }\n  ];\n  return Inputs.radio(data, {\n    label: _lang(nbText.legends.season),\n    format: (x) =&gt; x.label,\n    value: data.find((x) =&gt; x.value == \"planting\")\n  });\n}\n\n\n\n\n\n\n\nplotHourSeasonLoss = {\n  const _anyData = T.tidy(\n    data_hourlyStress,\n    T.groupBy(\n      [\n        \"admin0_name\",\n        \"admin1_name\",\n        \"admin2_name\",\n        \"scenario\",\n        \"timeframe\",\n        \"threshold\",\n        \"hour_day\"\n      ],\n      [\n        T.summarize({\n          vop_any: T.mean(\"delta\")\n        })\n      ]\n    )\n  );\n\n  const _dataWithAnyColumn = T.tidy(\n    data_hourlyStress,\n    T.leftJoin(_anyData, {\n      by: [\n        \"admin0_name\",\n        \"admin1_name\",\n        \"admin2_name\",\n        \"scenario\",\n        \"timeframe\",\n        \"hour_day\",\n        \"threshold\"\n      ]\n    })\n  );\n\n  const data = _dataWithAnyColumn.filter(d =&gt; d.hazard == radios.value);\n  const dataAny = data.filter((d) =&gt; d.hazard == \"any\"); // combined\n  const dataBars = [\n    ...data.filter((d) =&gt; d.hazard !== \"any\" && d.delta !== 0) // remove the combined hazard\n  ];\n\n  const _formatPercent = (num) =&gt; {\n  return `${num.toFixed(1)}%`;\n};\n  const xDomain = hourlyNames.map(d =&gt; d.hourlyName);\n\n  const maxValue = d3.max(dataBars, (d) =&gt; d.delta) * 1.75; // adding 10% buffer\n\n  return Plot.plot({\n    // caption: `The data on the plot above is stacked for visualization purposes, but percentages are based on different parts of the year, depending on the season.`,\n    width: 800,\n    height: 500,\n    marginLeft: 40,\n    marginRight: 5,\n    marginBottom: 35,\n    color: {\n      domain: hourlyPlotLookup.color.domain,\n      range: hourlyPlotLookup.color.range,\n      legend: false\n    },\n    x: {\n      domain: xDomain,\n      label: _lang(nbText.sections.workingHours.barChart.xLabel)\n    },\n    y: {\n      domain: [0, maxValue],\n      grid: true,\n      label: _lang(nbText.sections.workingHours.barChart.yLabel),\n      // tickSize: 0, // Set tick size to 0 to hide the ticks\n      // tickFormat: () =&gt; \"\", // Return an empty string to hide tick labels\n    },\n    marks: [\n      // main y-axis\n      Plot.axisX({\n        tickSize: 0,\n      }),\n      // pointer white-out\n      Plot.axisX(\n        Plot.pointerX({\n          label: null,\n          fill: \"white\",\n          textStroke: \"white\",\n          textStrokeWidth: 2,\n          tickSize: 0\n        })\n      ),\n      // bold pointer\n      Plot.axisX(\n        Plot.pointerX({\n          label: null,\n          fontWeight: \"bold\",\n          tickSize: 0\n        })\n      ),\n      // hazard component bars\n      Plot.barY(\n        dataBars,\n        Plot.stackY(\n          { order: hourlyPlotLookup.color.domain },\n          {\n            y: (d) =&gt; d.delta,\n            x: (d) =&gt; hourlyPlotLookup.hours[d.hour_day],\n            fill: (d) =&gt; hourlyPlotLookup.names[d.hazard],\n            stroke: \"#fff\",\n            strokeWidth: 0.1,\n            width: 1 // Adjust this value to control the thickness of the bars\n          }\n        )\n      ),\n      // tooltip\n      Plot.tip(\n        dataBars,\n        Plot.pointerX(\n          Plot.stackY(\n            { order: hourlyPlotLookup.color.domain },\n            {\n              y: (d) =&gt; d.delta,\n              x: (d) =&gt; hourlyPlotLookup.hours[d.hour_day],\n              fill: (d) =&gt; hourlyPlotLookup.names[d.hazard],\n              channels: {\n                hazard: {\n                  label: _lang(nbText.sections.workingHours.barChart.tooltip.period),\n                  value: (d) =&gt; hourlyPlotLookup.names[d.hazard]\n                },\n                delta: {\n                  label: _lang(nbText.sections.workingHours.barChart.tooltip.perc),\n                  value: (d) =&gt; {\n                    const delta_num = d.delta;\n                    return `(${delta_num})`;\n                  },\n                  value:  (d) =&gt;  _formatPercent(d.delta)\n                }\n              },\n              format: {\n                x: false,\n                y: false,\n                fill: false,\n                delta: true,\n                hazard: true,\n                perc: true\n              }\n            }\n          )\n        )\n      ),\n      // total VoP, sidebar highlight\n      Plot.textY(\n        dataAny,\n        Plot.pointerX({\n          y: maxValue,\n          x: (d) =&gt; hourlyPlotLookup.hours[d.hour_day],\n          text: (d) =&gt; {\n            const value = d.delta_total;\n            return `${value}`;\n          },\n          textAnchor: \"start\",\n          dx: 5\n        })\n      )\n    ]\n  });\n}\n\n\n\n\n\n\n\n{\n  let data = T.tidy(\n    data_hourlyStress,\n    T.groupBy(\n      [\n        \"admin0_name\",\n        \"admin1_name\",\n        \"admin2_name\",\n        \"scenario\",\n        \"timeframe\",\n        \"threshold\",\n        \"hour_day\"\n      ],\n      [\n        T.summarize({\n          vop_any: T.mean(\"delta\")\n        })\n      ]\n    )\n  );\n  return buildInlineDownloadButton(data, _lang(download_translation), `hourlyHumanHeatStress_${selectAdmin0.label.replace(/\\s/g, \"\")}`)\n  }\n\n\n\n\n\n\n\nheaderQuickInsightsHourly = {\n  const adminArticle = _lang(getAdminSelection()?.data?.article1);\n  const adminSelection = adminArticle ?? getAdminSelection().label;\n  const text = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.sections.quickInsightsGeneral.header),\n    [{ name: \"selection\", value: adminSelection }]\n  );\n\n  return md`### ${text}\n${styling}`;\n}\n\n\n\n\n\n\n\ninsightsHourSeasonLoss = {\n  const i = dynamicInsights_geoImpact.insight;\n\n  const currentAgPop = i.totalAgPop_noformat;\n  // totalVop is the projected change in agricultural population by 2050\n\n  const projectedChange2050 = i.totalAgPop_5_50_noformat;\n  const projectedChange2030 = i.totalVopMid_noformat;\n  const pop_2050 = currentAgPop + projectedChange2050;\n  const crop = insight_totalExposedHourly.filter(\n    (d) =&gt; d.totalExposedHourly !== 0 && d.hour_dayType == \"hour_day\"\n  )?.[0]?.[\"totalExposedHourly\"];\n\n  const pop_sum2 = insight_totalExposedHourly.filter(\n    (d) =&gt; d.corrected_pop_sum !== 0 && d.hour_dayType == \"hour_day\"\n  )?.[0]?.[\"corrected_pop_sum\"];\n\n  const totalPercentHarvesting =\n    insight_totalExposedHourly.find(\n      (d) =&gt; d.hour_dayType === \"hour_day\" && d.hazard === \"harvesting\"\n    )?.totalExposedHourly || \"no data\";\n  const totalPercentPlanting =\n    insight_totalExposedHourly.find(\n      (d) =&gt; d.hour_dayType === \"hour_day\" && d.hazard === \"planting\"\n    )?.totalExposedHourly || \"no data\";\n\n  const formatVop = (vop) =&gt;\n    vop === \"no data\"\n      ? vop\n      : formatNumCompactShort({ locale: language.locale })(vop);\n\n  const topHour_day = insight_topHourly.filter(\n    (d) =&gt; d.delta !== 0 && d.hour_dayType == \"hour_day\"\n  )?.[0];\n\n  const missingValue = \"--- no data for that bin ---\";\n\n  function showResult(value, format) {\n    if (value === null || value === undefined) return missingValue;\n    return format(value);\n  }\n\n  // Find a row for each hazard type to get period and total_days\n  const harvestingInsight = insight_totalExposedHourly.find(\n    (d) =&gt; d.hazard === \"harvesting\"\n  );\n  const plantingInsight = insight_totalExposedHourly.find(\n    (d) =&gt; d.hazard === \"planting\"\n  );\n\n  const periodHarvesting =\n    insight_totalExposedHourly.find(\n      (d) =&gt; d.hour_dayType === \"hour_day\" && d.hazard === \"harvesting\"\n    )?.period || \"no data\";\n  const totalDaysHarvesting = harvestingInsight\n    ? harvestingInsight.days_period\n    : \"no data\";\n  const periodPlanting = plantingInsight ? plantingInsight.period : \"no data\";\n  const totalDaysPlanting = plantingInsight\n    ? plantingInsight.days_period\n    : \"no data\";\n\n  const pop_sum = harvestingInsight\n    ? harvestingInsight.corrected_pop_sum\n    : \"no data\";\n  const delta_mean = harvestingInsight\n    ? harvestingInsight.delta_pop_mean\n    : \"no data\";\n\n  const totalPercentHarvestingNumeric =\n    totalPercentHarvesting !== \"no data\"\n      ? parseFloat(totalPercentHarvesting)\n      : 0;\n  const totalDaysHarvestingNumeric =\n    totalDaysHarvesting !== \"no data\" ? parseFloat(totalDaysHarvesting) : 0;\n  const totalPercentPlantingNumeric =\n    totalPercentPlanting !== \"no data\" ? parseFloat(totalPercentPlanting) : 0;\n  const totalDaysPlantingNumeric =\n    totalDaysPlanting !== \"no data\" ? parseFloat(totalDaysPlanting) : 0;\n\n  const pop_sumNumeric = pop_2050 !== \"no data\" ? parseFloat(pop_2050) : 0;\n\n  const totalHoursLostHarvest =\n    (totalPercentHarvestingNumeric / 100) *\n    totalDaysHarvestingNumeric *\n    pop_sumNumeric;\n  const totalHoursLostPlanting =\n    (totalPercentPlantingNumeric / 100) *\n    totalDaysPlantingNumeric *\n    pop_sumNumeric;\n\n  const totalWorkingDaysLostHarvest = totalHoursLostHarvest / 8; // assuming 8h working day\n  const totalWorkingDaysLostPlanting = totalHoursLostPlanting / 8; // assuming 8h working day\n\n  const totalWorkingDaysLostHarvestFormatted = formatVop(\n    totalWorkingDaysLostHarvest.toFixed(1)\n  ); // formatting\n  const totalWorkingDaysLostPlantingFormatted = formatVop(\n    totalWorkingDaysLostPlanting.toFixed(1)\n  ); // formatting\n\n\n  const insightIntro = _lang(nbText.sections.workingHours.quickInsights.intro);\n  const insightBody = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.sections.workingHours.quickInsights.body),\n    [\n      { name: \"scenario\", value: selectScenarioAndTimeframe2.scenario },\n      { name: \"year\", value: selectScenarioAndTimeframe2.timeframe },\n      { name: \"totalHours\", value: formatVop(totalHoursLostHarvest) },\n      { name: \"daysHarvest\", value: formatVop(totalDaysHarvesting) },\n      { name: \"wholeWorkingDays\", value: totalWorkingDaysLostHarvestFormatted }\n    ]\n  );\n  const insightLostDays = Lang.reduceReplaceTemplateItems(\n    _lang(nbText.sections.workingHours.quickInsights.lostDays),\n    [\n      { name: \"period\", value: formatVop(totalDaysPlanting) },\n      { name: \"geo\", value: getAdmin0WithAdminSubParens({articleField: \"article1\"}) },\n      { name: \"lostDays\", value: totalWorkingDaysLostPlantingFormatted }\n    ]\n  );\n\n  const selectedCountry = getAdminSelection0().value; // Function to get the selected country\n  const countriesWithoutData = [\n    \"Burundi\",\n    \"Rwanda\",\n    \"Lesotho\",\n    \"Gabon\",\n    \"Eswatini\",\n    \"Equatorial Guinea\"\n  ];\n\n  // Check if the selected country is in the list of countries without data\n  if (countriesWithoutData.includes(selectedCountry)) {\n    return md`${_lang(nbText.sections.quickInsightsGeneral.noDataBlurb)}`;\n  } else {\n    return md` ${insightIntro} \n\n${insightBody}\n\n${insightLostDays}\n\n`;\n  }\n}\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.sections.summary.title)}\n\n${_lang(nbText.sections.summary.intro)}`;\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.sections.methods.title)}\n\n## ${_lang(nbText.sections.methods.agWorkforce.title)}\n${_lang(nbText.sections.methods.agWorkforce.body)}\n\n## ${_lang(nbText.sections.methods.heatStress.title)}\n${_lang(nbText.sections.methods.heatStress.body)}\n\n## ${_lang(nbText.sections.methods.hourlyExposure.title)}\n${_lang(nbText.sections.methods.hourlyExposure.body)}\n\n# ${_lang(nbText.sections.methods.additionalMethods.title)}\n${_lang(nbText.sections.methods.additionalMethods.body)}\n\n${_lang(nbText.sections.methods.additionalMethods.linkNote)}\n\n## ${_lang(nbText.sections.methods.citation.title)}\n${_lang(nbText.sections.methods.citation.body)}`;\n\n\n\n\n\n\n\nAppendix\n\nmd`---\n### Support notebook\n[Support Notebook](https://observablehq.com/@periscopic/ab-atlas-spotlight-support): used for imports across spotlights.`;\n\n\n\n\n\n\n\nmd`---\n### Translation\n_Notebook language handling and main text_`;\n\n\n\n\n\n\n\nimport { Lang } from \"7d46679f7d0d917e\";\n\n\n\n\n\n\n\nlanguages = [\n  { key: \"en\", label: \"English\", locale: \"en-US\" },\n  { key: \"fr\", label: \"Français\", locale: \"fr-FR\" },\n];\n\n\n\n\n\n\n\n// get the default language key from parameter, or use default\ndefaultLangKey = {\n  const name = \"lang\";\n  const list = languages.map((d) =&gt; d.key);\n  const defaultKey = \"en\";\n\n  const queryParam = await Lang.getParamFromList({ name, list });\n\n  return queryParam ?? defaultKey;\n}\n\n\n\n\n\n\n\n// helper shorthand for Lang text-getting\n_lang = Lang.lg(language.key);\n\n\n\n\n\n\n\n// main toggle of language key\nviewof language = Inputs.radio(languages, {\n  label: \"Main language toggle\",\n  format: (d) =&gt; d.key,\n  value: languages.find((x) =&gt; x.key === defaultLangKey),\n})\n\n\n\n\n\n\n\nnbText = {\n  return {\n    legends: {\n      language: {\n        en: \"language\",\n        fr: \"langue\"\n      },\n      toc: {\n        en: \"in this notebook\",\n        fr: \"dans ce notebook\"\n      },\n      adminSelections: {\n        country: {\n          en: \"country\",\n          fr: \"pays\"\n        },\n        region: {\n          en: \"region\",\n          fr: \"région\"\n        },\n        subregion: {\n          en: \"subregion\",\n          fr: \"sous-région\"\n        }\n      },\n      scenario: {\n        en: \"scenario\",\n        fr: \"scénario\"\n      },\n      threshold: {\n        en: \"threshold\",\n        fr: \"seuil\"\n      },\n      season: {\n        en: \"season\",\n        fr: \"saison\"\n      },\n      seasonTypes: {\n        planting: {\n          en: \"planting\",\n          fr: \"plantation\"\n        },\n        harvesting: {\n          en: \"harvesting\",\n          fr: \"récolte\"\n        }\n      }\n    },\n    sections: {\n      quickInsightsGeneral: {\n        header: {\n          en: \"Quick Insights for :::selection:::\",\n          fr: \"Aperçu Rapide pour :::selection:::\"\n        },\n        noDataBlurb: {\n          en: \"Currently, there is no available data for this country. Please, select another country.\",\n          fr: \"Actuellement, aucune donnée n’est disponible pour ce pays. Veuillez sélectionner un autre pays.\"\n        }\n      },\n      overview: {\n        title: {\n          en: \"Overview\",\n          fr: \"Vue d’Ensemble\"\n        },\n        intro: {\n          en: \"African food systems depend on manual labour for production, distribution, and processing. Economic development is leading to changes in the structure and size of the labour force. This change, in the number and size of the agricultural workforce, is happening in parallel to climate change. The intersection of these two drivers together pose a range of risks to the African continent's food systems. This notebook aims to communicate the size of the agricultural workforce at risk to extreme heat today, and in the future. It presents a new insight into this risk leveraging a range of new datasets and highlights how the workday for different labourers will be disrupted by climate change in the future. You can follow the narrative for the continent as a whole, or select individual countries for geography-specific statistics.\",\n          fr: \"Les systèmes alimentaires africains dépendent du travail manuel pour la production, la distribution et la transformation. Le développement économique entraîne des changements dans la structure et la taille de la population active. Ce changement, dans le nombre et la taille de la main-d’œuvre agricole, se produit parallèlement au changement climatique. L’intersection de ces deux facteurs présente une série de risques pour les systèmes alimentaires du continent africain. Ce carnet vise à communiquer la taille de la main d’œuvre agricole exposée aujourd’hui et à l’avenir à la chaleur extrême. Il présente un nouvel aperçu de ce risque en exploitant une série de nouveaux ensembles de données et souligne comment la journée de travail des différents travailleurs sera perturbée par le changement climatique à l'avenir. Vous pouvez suivre le récit du continent dans son ensemble ou sélectionner des pays individuels pour obtenir des statistiques spécifiques à la géographie.\"\n        }\n      },\n      futureWorkforce: {\n        title: {\n          en: \"The Future of the Agricultural Workforce\",\n          fr: \"L’avenir de la Main-d’Œuvre Agricole\"\n        },\n        intro: {\n          en: \"The agricultural workforce covers the entire employed portion of the employable population involved in the agriculture sector. In the African continent, the vast majority of these are farmers. However, the number of farmers and the size of the workforce is not static, and depends on structural factors which drive rural population growth, push or pull the rural population towards urban areas over time.  Here, you can explore how the size of the agricultural workforce today and how it will change as a result of these factors in the future.\",\n          fr: \"La main d’œuvre agricole couvre l’ensemble de la part occupée de la population employable impliquée dans le secteur agricole. Sur le continent africain, la grande majorité d’entre eux sont des agriculteurs. Cependant, le nombre d’agriculteurs et la taille de la main d’œuvre ne sont pas statiques et dépendent de facteurs structurels qui stimulent la croissance de la population rurale, poussent ou attirent la population rurale vers les zones urbaines au fil du temps. Ici, vous pouvez découvrir comment la taille de la main-d’œuvre agricole aujourd’hui et comment elle évoluera en raison de ces facteurs à l’avenir.\"\n        },\n        map: {\n          caption: {\n            en: `Grey regions signal lack of :::selector::: data`,\n            fr: `Les régions grises signalent un manque de données sur la :::selector:::`\n          },\n          mapLayer: {\n            title: {\n              en: \"Map Layer\",\n              fr: \"Couche de Carte\"\n            },\n            values: {\n              ag_workforce_data_2: {\n                label: {\n                  en: \"Ag population baseline (circa 2005)\",\n                  fr: \"Référence de la population agricole (vers 2005)\"\n                },\n                labelTip: {\n                  en: \"Ag population\",\n                  fr: \"Population agricole\"\n                },\n                labelLegend: {\n                  en: \"Ag population\",\n                  fr: \"Population agricole\"\n                }\n              },\n              ag_workforce_data_1: {\n                label: {\n                  en: \"Percentage change by 2030\",\n                  fr: \"Pourcentage de changement d’ici 2030\"\n                },\n                labelTip: {\n                  en: \"Population change by 2030\",\n                  fr: \"Changement en population d’ici 2030\"\n                },\n                labelLegend: {\n                  en: \"Population change by 2030 (%)\",\n                  fr: \"Changement en population d’ici 2030 (%)\"\n                }\n              },\n              ag_workforce_data: {\n                label: {\n                  en: \"Percentage change by 2050\",\n                  fr: \"Pourcentage de changement d’ici 2050\"\n                },\n                labelTip: {\n                  en: \"Population change by 2050\",\n                  fr: \"Changement en population d’ici 2050\"\n                },\n                labelLegend: {\n                  en: \"Population change by 2050 (%)\",\n                  fr: \"Changement en population d’ici 2050 (%)\"\n                }\n              },\n              ag_workforce_data_15: {\n                label: {\n                  en: \"Ag population in 2030\",\n                  fr: \"Population agricole en 2030\"\n                },\n                labelTip: {\n                  en: \"Ag population in 2030\",\n                  fr: \"Population agricole en 2030\"\n                },\n                labelLegend: {\n                  en: \"Ag population in 2030\",\n                  fr: \"Population agricole en 2030\"\n                }\n              },\n              ag_workforce_data_10: {\n                label: {\n                  en: \"Ag population in 2050\",\n                  fr: \"Population agricole en 2050\"\n                },\n                labelTip: {\n                  en: \"Ag population in 2050\",\n                  fr: \"Population agricole en 2050\"\n                },\n                labelLegend: {\n                  en: \"Ag population in 2050\",\n                  fr: \"Population agricole en 2050\"\n                }\n              }\n            }\n          }\n        },\n        quickInsights: {\n          direction: {\n            inc: {\n              en: \"an increase\",\n              fr: \"une augmentation\"\n            },\n            dec: {\n              en: \"a decrease\",\n              fr: \"une diminution\"\n            }\n          },\n          basePop: {\n            en: `**:::geo:::**’s total agricultural population is **:::total:::** for the baseline year, circa 2005.`,\n            fr: `La population agricole totale **:::geo:::** est de **:::total:::** pour l’année de référence, vers 2005.`\n          }, \n          popChange: {\n            en: `The total agricultural population is expected to change to **:::change2030:::** by 2030, and to **:::change2050:::** by 2050, under SSP245. These represent **:::direction2030:::** of **:::perc2030:::%** and **:::direction2050:::** of **:::perc2050:::%**, respectively.`,\n            fr: `La population agricole totale devrait passer à **:::change2030:::** d’ici 2030 et à **:::change2050:::** d’ici 2050, dans le cadre du SSP245. Cela représente **:::direction2030:::** de **:::perc2030:::%** et **:::direction2050:::** de **:::perc2050:::%**, respectivement.`\n          },\n          popScenario: {\n            en: `Under SSP585, the total agricultural population will be **:::pop2030:::** by 2030 and **:::pop2050:::** by 2050. These represent **:::direction:::** of **:::perc2030:::%** and **:::perc2050:::%**, respectively.`,\n            fr: `Dans le cadre du SSP585, la population agricole totale sera de **:::pop2030:::** d'ici 2030 et de **:::pop2050:::** d'ici 2050. Cela représente **:::direction:::** de **:::perc2030:::%** et **:::perc2050:::%**, respectivement.`\n          }\n        }\n      },\n      heatStress: {\n        title: {\n          en: \"Heat Stress in Numbers\",\n          fr: \"Le Stress Thermique en Chiffres\"\n        },\n        intro: {\n          en: \"An important question is how the increases in agricultural workforce on the African continent will be affected by climate change. A key indicator of climate change impacts on human well being is heat stress. The level of heat stress experienced by a person depends not only on temperature but also on humidity, which are together often represented in terms of Wet Bulb Globe Temperature, where thresholds exceeding 28°C are considered harmful, and those exceeding 32°C extremely harmful. Use the dropdowns below to explore how many days in the year the agricultural workforce will be exposed to harmful heat stress for specific geographies, temperature thresholds and climate change scenarios.\",\n          fr: \"Une question importante est de savoir comment les augmentations de la main-d'œuvre agricole sur le continent africain seront affectées par le changement climatique. Un indicateur clé des impacts du changement climatique sur le bien-être humain est le stress thermique. Le niveau de stress thermique ressenti par une personne dépend non seulement de la température mais aussi de l'humidité, qui sont souvent représentés conjointement en termes de température du globe humide, où des seuils dépassant 28°C sont considérés comme nuisibles, et ceux dépassant 32°C extrêmement nuisibles. Utilisez les menus déroulants ci-dessous pour explorer combien de jours dans l'année la main-d'œuvre agricole sera exposée à un stress thermique nuisible pour des géographies spécifiques, des seuils de température et des scénarios de changement climatique.\"\n        },\n        barChart: {\n          caption: {\n            en: \"To ensure that the details across all bins are visible without being dominated by the initial range, the 0-5% bin has been intentionally excluded from this visualization.\",\n            fr: \"Pour garantir que les détails dans tous les groupes sont visibles sans être dominés par la plage initiale, le groupe 0-5 % a été intentionnellement exclu de cette visualisation.\"\n          },\n          group: {\n            baseline: {\n              en: \"Baseline\",\n              fr: \"Référence\"\n            },\n            projection: {\n              en: \"Projection\",\n              fr: \"Projection\"\n            }\n          },\n          xLabel: {\n            en: \"Percent of Year Exceeding Safe Working Conditions\",\n            fr: \"Pourcentage de l'année dépassant les conditions de travail sécuritaires\"\n          },\n          yLabel: {\n            en: \"People Exposed\",\n            fr: \"Personnes Exposées\"\n          },\n          tooltip: {\n            exposed: {\n              en: \"Ag pop exposed\",\n              fr: \"Population agricole exposée\"\n            },\n            period: {\n              en: \"Period\",\n              fr: \"Période\"\n            }\n          }\n        },\n        figureBody: {\n          en: \"The figure presents the count of agricultural workers subject to unsafe Wet Bulb Globe Temperature (WBGT) levels across the year, based on both baseline data and projections. For instance, if a projection displays 16 million people within the 45%-50% bin, it means that these individuals are exposed to unsafe working conditions for a portion of their day, 45% to 50% of the days in the year.\",\n          fr: \"La figure présente le nombre de travailleurs agricoles soumis à des niveaux dangereux de température du globe humide (WBGT) tout au long de l’année, sur la base à la fois de données de base et de projections. Par exemple, si une projection affiche 16 millions de personnes dans la tranche 45 à 50 %, cela signifie que ces personnes sont exposées à des conditions de travail dangereuses pendant une partie de leur journée, soit 45 à 50 % des jours de l’année.\"\n        },\n        quickInsights: {\n          overview: {\n            en: `For over **100 days** in a year, the people at risk for the baseline were **:::baseRisk:::**; under the scenario **:::scenario:::** and year **:::year:::**, it ascends to **:::projectionRisk:::**.`,\n            fr: `Pendant plus de **100 jours** par an, les personnes à risque étaient de **:::baseRisk:::**; dans le scénario **:::scenario:::** et l'année **:::year:::**, il monte à **:::projectionRisk::: de personnes**.`\n          },\n          half: {\n            en: `For the baseline period, **:::baseline:::** people experienced unsafe working conditions for at least **half of the days** in the year. Under the scenario **:::scenario:::** and year **:::year:::**, it's expected to rise to **:::projection:::** people.`,\n            fr: `Pour la période de référence, **:::baseline:::** personnes ont connu des conditions de travail dangereuses pendant au moins la **moitié des jours** de l'année. Dans le scénario **:::scenario:::** et l'année **:::year:::**, on s'attend à ce qu'il s'élève à **:::projection:::** personnes.`\n          }\n        }\n      },\n      workingHours: {\n        title: {\n          en: \"Loss of Safe Working Hours\",\n          fr: \"Perte d'Heures de Travail Sécurisées\"\n        },\n        intro: {\n          en: \"Importantly, it is not just the days of climate disruptions to the agricultural workforce that matter. The hours during the day and the time in the growing season, whether planting, or harvesting, all influence  how these disruptions will take place and impact on the sector. Use the figure below to explore how these safe working hours will be disrupted for different populations under different climate scenarios, temperature thresholds, and different geographies on the African continent.\",\n          fr: \"Il est important de noter que ce ne sont pas seulement les jours de perturbations climatiques qui affectent la main-d'œuvre agricole qui comptent. Les heures pendant la journée et le moment dans la saison de croissance, que ce soit lors de la plantation ou de la récolte, influencent toutes la manière dont ces perturbations se produiront et auront un impact sur le secteur. Utilisez la figure ci-dessous pour explorer comment ces heures de travail sécurisées seront perturbées pour différentes populations sous différents scénarios climatiques, seuils de température et différentes géographies sur le continent africain.\"\n        },\n        barChart: {\n          xLabel: {\n            en: \"Hour of Day\",\n            fr: \"Heure de la Journée\"\n          },\n          yLabel: {\n            en: \"Percent Loss of Season due to Extreme Heat\",\n            fr: \"Pourcentage de Perte de Saison due à une Chaleur Extrême\"\n          },\n          tooltip: {\n            perc: {\n              en: \"Percent loss\",\n              fr: \"Pourcentage de perte\"\n            },\n            period: {\n              en: \"Period\",\n              fr: \"Période\"\n            }\n          }\n        },\n        quickInsights: {\n          intro: {\n            en: `The figure illustrates the percentage of the harvesting and planting seasons during which the Wet Bulb Globe Temperature (WBGT) surpasses safe working limits, as per the selected threshold, relative to the baseline. This highlights the projected changes for the future. For example, a **15%** figure for the harvesting season at 11am indicates that, under the specified scenario and year, there will be **15% fewer days** out of the total season where the population can work safely at that time.`,\n            fr: `La figure illustre le pourcentage des saisons de récolte et de plantation au cours desquelles la température du globe humide (WBGT) dépasse les limites de travail sécuritaire, selon le seuil sélectionné, par rapport à la référence. Cela met en évidence les changements projetés pour l’avenir. Par exemple, un chiffre de **15%** pour la saison de récolte à 11 heures du matin indique que, selon le scénario et l'année spécifiés, il y aura **15% de jours en moins** sur la saison totale où la population pourra travailler en toute sécurité à ce moment-là.`\n          },\n          body: {\n            en: `Under scenario **:::scenario:::** and year **:::year:::**, a policy of avoiding unsafe working hours would translate into **:::totalHours:::** working hours lost during the harvesting season, spanning **:::daysHarvest:::** days; if we consider a common working day to have 8 hours, this translates into **:::wholeWorkingDays:::** total working days lost in harvesting in a year.`,\n            fr: `Dans le scénario **:::scenario:::** et l’année **:::year:::**, une politique visant à éviter les heures de travail dangereuses se traduirait par **:::totalHours:::** heures de travail perdues pendant la saison des récoltes, s’étalant sur **:::daysHarvest:::** jours; si l’on considère qu’une journée de travail commune compte 8 heures, cela se traduit par **:::wholeWorkingDays:::** jours de travail perdus au total pour la récolte au cours d’une année.`\n          },\n          lostDays: {\n            en: `For the planting period, spanning **:::period:::** days, **:::geo:::** would lose **:::lostDays:::** whole working days.`,\n            fr: `Pour la période de plantation, qui s'étend sur **:::period:::** jours, **:::geo:::** perdrait **:::lostDays:::** jours de travail entiers.`\n          }\n        }\n      },\n      summary: {\n        title: {\n          en: \"Summary\",\n          fr: \"Résumé\"\n        },\n        intro: {\n          en: \"Climate change will drive disruptions to the African agricultural labour force. This has important implications for economic development, human health, gender equity, as well as food security. The size of the expected disruptions depend not only on climate stressors, such as increasing heat stress, but also on the expected change in the size of the agricultural workforce. There are a number of locations where these two factors will collide, driving increased risks, loss of safe working hours, agricultural productivity, and ultimately the right to work in a safe climate for millions. A number of solutions have been proposed to deal with this stress, including shifting working hours shifting in working hours, increased shade on farms, increased mechanisation, improved worker safety protocols, improved hydration and other heat stress coping mechanisms. Ultimately however, solutions on the scale of adaptation required have yet to be developed, and based on the size of this risk need to be addressed urgently to maintain human health and environmental rights, agricultural productivity, and food security, now and in the future.\",\n          fr: \"Le changement climatique entraînera des perturbations dans la main-d’œuvre agricole africaine. Cela a des implications importantes pour le développement économique, la santé humaine, l’équité entre les sexes ainsi que la sécurité alimentaire. L’ampleur des perturbations attendues dépend non seulement des facteurs de stress climatiques, tels que l’augmentation du stress thermique, mais également de l’évolution attendue de la taille de la main d’œuvre agricole. Il existe un certain nombre d’endroits où ces deux facteurs entreront en collision, entraînant une augmentation des risques, une perte d’heures de travail sûres, une perte de productivité agricole et, en fin de compte, le droit de travailler dans un climat sûr pour des millions de personnes. Un certain nombre de solutions ont été proposées pour faire face à ce stress, notamment le décalage des horaires de travail, l'augmentation de l'ombre dans les fermes, l'augmentation de la mécanisation, l'amélioration des protocoles de sécurité des travailleurs, l'amélioration de l'hydratation et d'autres mécanismes d'adaptation au stress thermique. Toutefois, en fin de compte, les solutions à l’échelle d’adaptation requise doivent encore être développées et, compte tenu de l’ampleur de ce risque, il convient d’y remédier de toute urgence afin de préserver la santé humaine et les droits environnementaux, la productivité agricole et la sécurité alimentaire, aujourd’hui et à l’avenir.\"\n        }\n      },\n      methods: {\n        title: {\n          en: \"Methods\",\n          fr: \"Méthodologie\"\n        },\n        agWorkforce: {\n          title: {\n            en: \"Agricultural workforce\",\n            fr: \"Main d'œuvre agricole\"\n          },\n          body: {\n            en: `We generated gridded predictions for the agricultural workforce by first harmonising subnational data from census statistics from a range of government sources, with national data from the [International Labour Organisation (ILO)](https://rshiny.ilo.org/dataexplorer36/?lang=en&segment=indicator&id=EAP_2WAP_SEX_AGE_RT_A) on the proportion of the population employed in agriculture. Then, using a geospatial version of the predictive framework introduced by [Mehrabi, Z (2023) Nat Sust](https://doi.org/10.1038/s41893-023-01110-y), we fit functions relating workforce size to [population statistics from Jones and O’Neill (2016)](https://www.cgd.ucar.edu/sections/iam/modeling/spatial-population), [gridded gdp from Wang and Sun (2022)](https://www.nature.com/articles/s41597-022-01300-x), and [agricultural land area by Ramankutty et al. (2008)](https://agupubs.onlinelibrary.wiley.com/doi/10.1029/2007GB002952). We employed stacked machine learning models (boosted regression trees, random forests) for the fitting process. Using these models and current and future gridded data we generated baseline-period (circa 2005) and future (2030, 2050) estimates of the agricultural workforce at 0.083 degrees resolution for the African continent.`,\n            fr: `Nous avons généré des prévisions en grille pour la main-d'œuvre agricole en harmonisant d'abord les données subnationales issues des statistiques de recensement provenant de diverses sources gouvernementales, avec les données nationales de [l'Organisation internationale du travail](https://rshiny.ilo.org/dataexplorer36/?lang=en&segment=indicator&id=EAP_2WAP_SEX_AGE_RT_A) (OIT) sur la proportion de la population employée dans l'agriculture. Ensuite, en utilisant une version géospatiale du cadre prédictif introduit par [Mehrabi, Z (2023) Nat Sust](https://doi.org/10.1038/s41893-023-01110-y), nous ajustons les fonctions reliant la taille de la main-d'œuvre aux [statistiques démographiques de Jones et O'Neill (2016)](https://www.cgd.ucar.edu/sections/iam/modeling/spatial-population), [le PIB maillé de Wang et Sun (2022)](https://www.nature.com/articles/s41597-022-01300-x), et la [superficie des terres agricoles par Ramankutty et al. (2008)](https://agupubs.onlinelibrary.wiley.com/doi/10.1029/2007GB002952). Nous avons utilisé des modèles d'apprentissage automatique empilés (arbres de régression améliorés, random forests) pour le processus d'ajustement. À l’aide de ces modèles et des données en grille actuelles et futures, nous avons généré des estimations pour la période de référence (vers 2005) et future (2030, 2050) de la main-d’œuvre agricole avec une résolution de 0,083 degrés pour le continent africain.`\n          }\n        },\n        heatStress: {\n          title: {\n            en: \"Heat stress\",\n            fr: \"Stress thermique\"\n          },\n          body: {\n            en: `We use high-resolution, daily gridded data from the Climate Hazards Center Coupled Model Intercomparison Project Phase 6 (CHC-CMIP6) dataset [Williams et al. (2024)](https://www.nature.com/articles/s41597-024-03074-w). The CHC-CMIP6 dataset provides future estimates for 2030 and 2050, whose delta fields are based on the CMIP6 multi-model ensemble forecasts for the SSP 245 and SSP 585 scenarios. As inputs to compute WBGT values, we take from the dataset three main variables: the daily maximum and minimum temperatures (Tmax and Tmin), as well as the maximum daily relative humidity (RHx) that occurs at the time of Tmax, for both, the observation period (circa 2005, average taken across 10 years), and the future projections under SSP 2.45 and 5.85 (years 2030 and 2050, average taken across 10 years).`,\n            fr: `Nous utilisons des données en grille quotidiennes à haute résolution provenant de l'ensemble de données de la phase 6 du projet de comparaison de modèles couplés du Climate Hazards Center (CHC-CMIP6) [Williams et al. (2024)](https://www.nature.com/articles/s41597-024-03074-w). L'ensemble de données CHC-CMIP6 fournit des estimations futures pour 2030 et 2050, dont les champs delta sont basés sur les prévisions d'ensemble multimodèles CMIP6 pour les scénarios SSP 245 et SSP 585. Comme entrées pour calculer les valeurs WBGT, nous prenons à partir de l'ensemble de données trois variables principales : les températures quotidiennes maximales et minimales (Tmax et Tmin), ainsi que l'humidité relative quotidienne maximale (RHx) qui se produit au moment de Tmax, pour les deux, la période d’observation (vers 2005, moyenne sur 10 ans) et les projections futures dans le cadre des PAS 2,45 et 5,85 (années 2030 et 2050, moyenne sur 10 ans).`\n          }\n        },\n        hourlyExposure: {\n          title: {\n            en: \"Hourly exposure\",\n            fr: \"Exposition horaire\"\n          },\n          body: {\n            en: `We examine agricultural workers' hourly exposure to heat stress during the harvesting and planting seasons, crucial periods in the agricultural calendar, where agricultural labourers are exposed to prolonged labour-intense outdoor activity, making them more susceptible to the impacts of heat stress. We use the crop calendars from [GGCMI Phase 3](https://zenodo.org/records/5062513), which provide the planting and harvesting dates for eighteen distinct crops and show exposure histograms during these periods. The histograms quantify the percentage of days within the harvesting or planting periods that surpass WBGT safety standards for each hour of the day. Here we compute and rely on hourly WBGT exceedances in present and future, for different SSPs and years. The calculations for the hourly temperature rely on Linvill’s (1990) method for predicting hourly temperatures from daily minimum and maximum measurements. To compute such temperature profiles, we rely on daylength values, mainly taken from [Spencer (1971)](https://www.mail-archive.com/sundial@uni-koeln.de/msg01050.html). This approach was used to create hourly temperature profiles; then, hourly heat index values relying on relative humidity values and following the [NOAA guidelines](https://www.wpc.ncep.noaa.gov/html/heatindex_equation.shtml); and, finally, hourly WBGT, which was evaluated at three different thresholds – 28, 30 and 32 degrees Celsius.`,\n            fr: `Nous examinons l'exposition horaire des travailleurs agricoles au stress thermique pendant les saisons de récolte et de plantation, périodes cruciales du calendrier agricole, où les travailleurs agricoles sont exposés à une activité extérieure prolongée et intense, les rendant plus sensibles aux impacts du stress thermique. Nous utilisons les calendriers de cultures de la [phase 3 du GGCMI](https://zenodo.org/records/5062513), qui fournissent les dates de plantation et de récolte de dix-huit cultures distinctes et affichent des histogrammes d'exposition pendant ces périodes. Les histogrammes quantifient le pourcentage de jours au cours des périodes de récolte ou de plantation qui dépassent les normes de sécurité du WBGT pour chaque heure de la journée. Ici, nous calculons et nous appuyons sur les dépassements horaires du WBGT dans le présent et le futur, pour différents SSP et années. Les calculs de température horaire s’appuient sur la méthode de Linvill (1990) pour prédire les températures horaires à partir de mesures quotidiennes minimales et maximales. Pour calculer de tels profils de température, nous nous appuyons sur les valeurs de longueur du jour, principalement tirées de [Spencer (1971)](https://www.mail-archive.com/sundial@uni-koeln.de/msg01050.html). Cette approche a été utilisée pour créer des profils de température horaires ; puis, les valeurs horaires de l'indice de chaleur basées sur les valeurs d'humidité relative et suivant les [directives de la NOAA](https://www.wpc.ncep.noaa.gov/html/heatindex_equation.shtml); et enfin le WBGT horaire, qui a été évalué à trois seuils différents – 28, 30 et 32 degrés Celsius.`\n          }\n        },\n        additionalMethods: {\n          title: {\n            en: \"Additional methods\",\n            fr: \"Méthodologie supplémentaire\"\n          },\n          body: {\n            en: `Full methodological details are contained in two forthcoming background papers:\n- Ormaza-Zulueta, N and Mehrabi, Z. *Mapping global agricultural workforce*\n- Ormaza-Zulueta, N and Mehrabi, Z. *Reductions in the agricultural workday in future due to climate change*`,\n            fr: `Les détails méthodologiques complets sont contenus dans deux documents de référence à venir:\n- Ormaza-Zulueta, N et Mehrabi, Z. *Cartographie de la main-d'œuvre agricole mondiale*\n- Ormaza-Zulueta, N et Mehrabi, Z. *Réductions de la journée de travail agricole à l'avenir en raison du changement climatique*`\n          },\n          linkNote: {\n            en: \"Links will be updated when published.\",\n            fr: \"Les liens seront mis à jour une fois publiés.\"\n          }\n        },\n        citation: {\n          title: {\n            en: \"Citation\",\n            fr: \"Citation\"\n          },\n          body: {\n            en: \"If the above links to background papers are not live, please use the following citation for this analysis: Ormaza-Zulueta, N and Mehrabi, Z. 2024. Widespread Workforce Disruptions. Africa Agriculture Adaptation Atlas. CGIAR.\",\n            fr: \"Si les liens ci-dessus vers les documents de référence ne sont pas actifs, veuillez utiliser la citation suivante pour cette analyse: Ormaza-Zulueta, N et Mehrabi, Z. 2024. Disruptions généralisées de la main-d'œuvre. Atlas de l’adaptation de l’agriculture en Afrique. GCRAI.\"\n          }\n        }\n      }\n    }\n  };\n}\n\n\n\n\n\n\n\n// data translation values\ntd = {\n  let data = await FileAttachment(\"abAtlas-td-translation-data-v1.json\").json()\n\n  // update SSA default\n  data.admin0_name.values.SSA.en = \"Sub-Saharan Africa\"\n  // cote d'ivoire, comma version duplicate\n  data.admin0_name.values[\"Côte d’Ivoire\"] = data.admin0_name.values[\"Côte d'Ivoire\"]\n  \n  return data\n}\n\n\n\n\n\n\n\nmd`---\n### Notebook Variables\n_Main variables across notebook_`;\n\n\n\n\n\n\n\n// main title of the notebook\nnotebookTitle = _lang({\n  en: \"Understand Heat Stress on Producers\",\n  fr: \"Comprendre le stress thermique sur les producteurs\",\n});\n\n\n\n\n\n\n\n// info for the admin selectors\nadminRegions = {\n  return {\n    labels: {\n      admin0: _lang(nbText.legends.adminSelections.country),\n      admin1: _lang(nbText.legends.adminSelections.region),\n      admin2: _lang(nbText.legends.adminSelections.subregion)\n    }\n  };\n}\n\n\n\n\n\n\n\nfunction getLowerLevelAdminLabel(selections = adminSelections) {\n  // based on admin selection, get the lower level label\n  if (selections.selectAdmin2.value) return adminRegions.labels.admin2;\n  if (selections.selectAdmin1.value) return adminRegions.labels.admin2;\n  if (selections.selectAdmin0.value) return adminRegions.labels.admin1;\n  else return adminRegions.labels.admin0;\n}\n\n\n\n\n\n\n\nmonetaryVoPNote = `Monetary VoP values are represented in 2005 international dollars.`; // note about VoP source\n\n\n\n\n\n\n\n// width of the maps\nmapWidth = 625;\n\n\n\n\n\n\n\nmd`---\n### Notebook Styling\n*styling helpers*\nStylesheet is a named cell, which is necessary to include for embeds.`;\n\n\n\n\n\n\n\nmd`**CSS styling**`;\n\n\n\n\n\n\n\nmd`**Color Scales**`;\n\n\n\n\n\n\n\n// color scale info\ncolorScales = {\n  return {\n    range: {\n      green: ['#E4F5D0', '#015023'],\n      blue: ['#E8F2FF', '#003E6B'],\n      brown: ['#FFFDE5', '#A87B00'],\n      yellowGreen: ['#F7D732', '#216729'],\n      orangeRed: ['#F4BB21', '#EC5A47'],\n      blueWhiteRed: ['#003E6B', '#FFFFFF', '#EC5A47'],\n      redYellowGreen: [\"#EC5A47\", \"#F4BB21\", '#216729']\n    },\n    unknown: \"#ccc\"\n  }\n}\n\n\n\n\n\n\n\nimport {\n  buildInlineDownloadButton,\n  downloadButtonCSS,\n  download_translation,\n} from \"1bda5f9b60c64223\";\n\n\n\n\n\n\n\ndownloadButtonCSS;\n\n\n\n\n\n\n\nmd`---\n### Admin Selection\n*Global admin selector using dropdowns*\n\nThis is the global selector for the selected region\n- The completed data is contained within adminSelections to be used in queries\n- Dropdowns are defined below then bound for each section\n  - Defined as separate cells since they dynamically respond to different values\n    - In narrative, they are simply views of the data  \n  - Dropdowns are dynamic based on higher-level choices\n  - Options are defined from the geographic data\n  - null value means unselected region\n- Dropdowns are added to each section, using Inputs.bind to create synchronized inputs (see viewof for input definitions). A form input is used to consolidate and apply a template to format.`;\n\n\n\n\n\n\n\n// get admin0 options from geo\ndataAdmin0 = {\n  const data = boundaries.admin0.features.map((d) =&gt; d.properties);\n  // add a blank value\n  return [null, ...data.map((d) =&gt; d.admin_name)].map((d) =&gt; {\n    return {\n      label:\n        d == null\n          ? globalSelection.label\n          : _lang(td.admin0_name.values?.[d].general),\n      value: d,\n      data: d == null ? globalSelection.data : td.admin0_name.values?.[d],\n    };\n  });\n}\n\n\n\n\n\n\n\n// get admin1 options based on admin0 selection\n// (the admin1 regions within selected admin0)\ndataAdmin1 = {\n  // admin 1, filter by 0 \n  const data = boundaries.admin1.features.map(d =&gt; d.properties)\n  .filter(d =&gt; d.admin0_name == selectAdmin0.value)\n  // add blank value\n  return [null, ...data.map(d =&gt; d.admin1_name)].map(d =&gt; {\n    return {label: d, value: d}\n  })\n}\n\n\n\n\n\n\n\n// get admin2 options based on admin1 selection\n// (the admin2 regions within selected admin1)\ndataAdmin2 = {\n  const data = boundaries.admin2.features.map(d =&gt; d.properties)\n  .filter(d =&gt; d.admin0_name == selectAdmin0.value && d.admin1_name == selectAdmin1.value)\n  // add blank value\n  return [null, ...data.map(d =&gt; d.admin2_name)].map(d =&gt; {\n    return {label: d, value: d}\n  })\n}\n\n\n\n\n\n\n\nviewof selectAdmin0 = Inputs.select(dataAdmin0, {label: adminRegions.labels.admin0, format: x =&gt; x.label})\n\n\n\n\n\n\n\nviewof selectAdmin1 = Inputs.select(dataAdmin1, {label: adminRegions.labels.admin1, format: x =&gt; x.label})\n\n\n\n\n\n\n\nviewof selectAdmin2 = Inputs.select(dataAdmin2, {label: adminRegions.labels.admin2, format: x =&gt; x.label})\n\n\n\n\n\n\n\n// selected admin regions from dropdowns\nadminSelections = new Object({\n  selectAdmin0: selectAdmin0,\n  selectAdmin1: selectAdmin1,\n  selectAdmin2: selectAdmin2,\n});\n\n\n\n\n\n\n\n// template to format admin selection form\nadminFormTemplate = (inputs) =&gt;\n  htl.html`&lt;div style=\"display: flex; gap: 3em\"&gt;${inputs}&lt;/div&gt;`;\n\n\n\n\n\n\n\nmd`---\n### Admin Selection - Display\n*Showing admin selections*`;\n\n\n\n\n\n\n\n// options for the global admin selection\n// used when no admin selection is made\nglobalSelection = {\n  return {\n    label: _lang(td.admin0_name.values.SSA.general),\n    value: null,\n    data: td.admin0_name.values.SSA\n  }\n}\n\n\n\n\n\n\n\nfunction getAdminSelection(selections = adminSelections) {\n  // get the most granular admin selection made\n  const a0 = selections.selectAdmin0;\n  const a1 = selections.selectAdmin1;\n  const a2 = selections.selectAdmin2;\n  const global = globalSelection;\n\n  return a2.value ? a2 : a1.value ? a1 : a0.value ? a0 : global;\n}\n\n\n\n\n\n\n\nfunction getAdminSelection0(selections = adminSelections) {\n  // get the most granular admin selection made\n  const a0 = selections.selectAdmin0;\n\n  return a0;\n}\n\n\n\n\n\n\n\nfunction getAdminSelectionAdmin0(selections = adminSelections) {\n  // get the selected admin0 or global value\n  const a0 = selections.selectAdmin0;\n  const global = globalSelection;\n\n  return a0.value ? a0 : global;\n}\n\n\n\n\n\n\n\nfunction getAdminSelectionMarkdownPath(selections = adminSelections) {\n  // function to show selected admin region\n  // return path showing nested admin selection\n\n  const delim = \" → \";\n  const path = [\n    selections.selectAdmin0.label,\n    selections.selectAdmin1.label,\n    selections.selectAdmin2.label,\n  ].filter((d) =&gt; d);\n\n  const formatted = path\n    .filter((d) =&gt; d)\n    .map((d, i) =&gt; {\n      return i == path.length - 1 ? `**${d}**` : `*${d}*`;\n    });\n\n  return formatted.length == 0\n    ? `**${globalSelection.label}**` // no selection, all of Africa\n    : `${formatted.join(delim)}`;\n}\n\n\n\n\n\n\n\ngetAdmin0WithAdminSubParens = ({\n  articleField = \"general\",\n  showParens = true,\n} = {}) =&gt; {\n  // getting admin0, with admin1 in parens\n  // can specify admin0article lookup\n  const a0 = adminSelections.selectAdmin0;\n  const a1 = adminSelections.selectAdmin1;\n  const a2 = adminSelections.selectAdmin2;\n\n  const a0WithArticle =\n    a0.value == null\n      ? _lang(td.admin0_name.values?.[\"SSA\"]?.[articleField])\n      : _lang(td.admin0_name.values?.[a0.value]?.[articleField]);\n  if (a1.value == null) return a0WithArticle;\n  if (!showParens) return a0WithArticle;\n  const subLabel = a2.value == null ? a1.label : a2.label;\n  return `${a0WithArticle} (${subLabel})`;\n};\n\n\n\n\n\n\n\nmd`---\n### Choropleth map - Geographic Impact\n*Showing context for admin selection*\n\nThere is some hoop-jumping to get the right data based on the Admin Selection. The tabular data is then bound to the applicable geojson, and visualized with Plot.`;\n\n\n\n\n\n\n\n// population data\ndataPopulation = db.query(`\nselect * \nfrom ag_workforce_data\n`);\n\n\n\n\n\n\n\n// total VoP data\ndataTotalAgW = db.query(`\nselect admin0_name\n  , admin1_name\n  , admin2_name\n  , MEAN(percentage_change_SSP2_2050_ag) as agw_total\n  from ag_workforce_data\n  group by 1, 2, 3\n  order by 1, 2, 3\n`);\n\n\n\n\n\n\n\n// total VoP data\ndataTotalAgW_abs = db.query(`\nselect admin0_name\n  , admin1_name\n  , admin2_name\n  , SUM(corrected_index_ag_pop_SSP2_2050) as agw_total_abs\n  from ag_workforce_data\n  group by 1, 2, 3\n  order by 1, 2, 3\n`);\n\n\n\n\n\n\n\n// total Ag_SSP2_2030 data\ndataTotalAgWMid = db.query(`\nselect admin0_name\n  , admin1_name\n  , admin2_name\n  , MEAN(percentage_change_SSP2_2030_ag) as agw_total_mid\n  from ag_workforce_data\n  group by 1, 2, 3\n  order by 1, 2, 3\n`);\n\n\n\n\n\n\n\n// total VoP data\ndataTotalAgWMid_abs = db.query(`\nselect admin0_name\n  , admin1_name\n  , admin2_name\n  , SUM(corrected_index_ag_pop_SSP2_2030) as agw_total_mid_abs\n  from ag_workforce_data\n  group by 1, 2, 3\n  order by 1, 2, 3\n`);\n\n\n\n\n\n\n\n// grab tabular data for choropleth\ndataGeoImpact = {\n  // get data for choropleth map based on choice\n  let dataSource;\n\n  if (selectGeoDataType.key == \"ag_workforce_data_2\") {\n    dataSource = dataPopulation;\n  } else if (selectGeoDataType.key == \"ag_workforce_data\") {\n    dataSource = dataTotalAgW;\n  } else  if (selectGeoDataType.key == \"ag_workforce_data_15\") {\n    dataSource = dataTotalAgWMid_abs;\n  } else  if (selectGeoDataType.key == \"ag_workforce_data_10\") {\n    dataSource = dataTotalAgW_abs;\n  } else {\n    dataSource = dataTotalAgWMid;\n  }\n\n  // select different data based on admin selections\n  if (adminSelections.selectAdmin1.value) {\n    // admin1 or 2 is selected, show all admin2's for selected admin1\n    return T.tidy(\n      dataSource,\n      T.filter((d) =&gt; {\n        return d.admin0_name == adminSelections.selectAdmin0.value &&\n          d.admin1_name == adminSelections.selectAdmin1.value\n          && d.admin2_name // always non-null\n      })\n    );\n  } else if (adminSelections.selectAdmin0.value) {\n    // admin0 is selected, with no admin1\n    // get all admin1 data for selected admin0\n    return T.tidy(\n      dataSource,\n      T.filter((d) =&gt; {\n        return d.admin0_name == adminSelections.selectAdmin0.value\n        && d.admin1_name // always non-null \n        && !d.admin2_name // always null\n      })\n    )\n  } else {\n    // end case: admin0 is not selected\n    // get all admin0 data\n    return T.tidy(\n      dataSource,\n      T.filter((d) =&gt; {\n        return !d.admin1_name // always null \n        && !d.admin2_name // always null\n      })\n    )\n  }\n}\n\n\n\n\n\n\n\n// bind geojson to tabular data\nmapDataGeoImpact = {\n  // no selections\n  if (!adminSelections.selectAdmin0.value) {\n    return bindTabularToGeo({\n      data: dataGeoImpact,\n      dataBindColumn: \"admin0_name\",\n      geoData: boundaries.admin0,\n      geoDataBindColumn: \"admin0_name\"\n    });\n  }\n  // admin0 selected only\n  else if (!adminSelections.selectAdmin1.value) {\n    const data = T.tidy(\n      dataGeoImpact,\n      T.mutate({ a1_a0: (d) =&gt; [d.admin1_name, d.admin0_name].join(\"_\") })\n    );\n    const geoData = {\n      ...boundaries.admin1,\n      features: boundaries.admin1.features.filter(\n        (d) =&gt; d.properties.admin0_name == adminSelections.selectAdmin0.value\n      )\n    };\n\n    return bindTabularToGeo({\n      data: data,\n      dataBindColumn: \"a1_a0\",\n      geoData: geoData,\n      geoDataBindColumn: \"a1_a0\"\n    });\n  }\n\n  // admin1 is selected\n  // show all admin2 regions within admin1\n  else {\n    const data = T.tidy(\n      dataGeoImpact,\n      T.mutate({\n        a2_a1_a0: (d) =&gt; [d.admin2_name, d.admin1_name, d.admin0_name].join(\"_\")\n      })\n    );\n    const geoData = {\n      ...boundaries.admin2,\n      features: boundaries.admin2.features.filter(\n        (d) =&gt; d.properties.admin1_name == adminSelections.selectAdmin1.value && d.properties.admin0_name == adminSelections.selectAdmin0.value\n      )\n    };\n\n    return bindTabularToGeo({\n      data: data,\n      dataBindColumn: \"a2_a1_a0\",\n      geoData: geoData,\n      geoDataBindColumn: \"a2_a1_a0\"\n    });\n  }\n}\n\n\n\n\n\n\n\nmd`---\n### Dynamic Insights - Geographic Impact\n*quick insights for given admin selection*\n\n- Sql cells add a row that is the combined value for all admin regions, where all admin names are null.`;\n\n\n\n\n\n\n\nmd`Here are the combined data and insights for creating the dynamic narrative. Data tables are below.`;\n\n\n\n\n\n\n\n// dynamic insights for an Admin Selection\ndynamicInsights_geoImpact = {\n  // define data\n  const totalVop = filterByAdminNames(dynInsightGeo_vopTotals);\n  const population = filterByAdminNames(dynInsightGeo_population);\n  const perc30 = filterByAdminNames(dynInsightGeo_percentTotals_mid);\n  const perc50 = filterByAdminNames(dynInsightGeo_percentTotals);\n\n  // format functions\n  const _formatTopNVop = formatUSD;\n  const _formatNumber = formatNumCompactLong({locale: language.locale});\n\n  function getTopValue({ d, i } = {}) {\n    return {\n      data: d?.[i]?.agw_total,\n      value: formatWithDefault({\n        value: d?.[i]?.agw_total,\n        format: _formatNumber\n      }),\n      label: formatWithDefault({\n        value: d?.[i]?.crop\n      })\n    };\n  }\n\n  // make insights ------------------------------------\n  return {\n    data: {\n      totalVop,\n      population\n    },\n    insight: {\n      totalVop: formatWithDefault({\n        value: totalVop?.[0]?.agw_total,\n        format: _formatNumber\n      }),\n      totalPop: formatWithDefault({\n        value: population?.[0]?.total_pop,\n        format: _formatNumber\n      }),\n      totalRuralPop: formatWithDefault({\n        value: population?.[0]?.rural_pop,\n        format: _formatNumber\n      }),\n      totalAgPop: formatWithDefault({\n        value: population?.[0]?.ag_pop,\n        format: _formatNumber\n      }),\n      totalAgPop_noformat: formatWithDefault({\n        value: population?.[0]?.ag_pop\n      }),\n      totalAgPop_2_30: formatWithDefault({\n        value: population?.[0]?.ag_pop_2_30,\n        format: _formatNumber\n      }),\n      totalAgPop_2_30_noformat: formatWithDefault({\n        value: population?.[0]?.ag_pop_2_30\n      }),\n      totalAgPop_2_50: formatWithDefault({\n        value: population?.[0]?.ag_pop_2_50,\n        format: _formatNumber\n      }),\n      totalAgPop_2_50_noformat: formatWithDefault({\n        value: population?.[0]?.ag_pop_2_50\n      }),\n      totalAgPop_5_30: formatWithDefault({\n        value: population?.[0]?.ag_pop_5_30,\n        format: _formatNumber\n      }),\n      totalAgPop_5_30_noformat: formatWithDefault({\n        value: population?.[0]?.ag_pop_5_30\n      }),\n      totalAgPop_5_50: formatWithDefault({\n        value: population?.[0]?.ag_pop_5_50,\n        format: _formatNumber\n      }),\n      totalAgPop_5_50_noformat: formatWithDefault({\n        value: population?.[0]?.ag_pop_5_50\n      }),\n    }\n  };\n}\n\n\n\n\n\n\n\nmd`---\n#### Data cells for insights`;\n\n\n\n\n\n\n\n// total harvested area\ndynInsightGeo_percentTotals_mid = db.query(`\nwith tbl as (\n  -- total percentages\n  SELECT admin0_name, admin1_name, admin2_name, MEAN(percentage_change_SSP2_2030_ag) AS percent_change_30\n    FROM ag_workforce_data\n    GROUP BY 1, 2, 3\n    ORDER BY 1, 2, 3\n)\n\n-- QUERY ------------------------------------------\n(\n  -- total for all regions\n  select null as admin0_name\n    , null as admin1_name\n    , null as admin2_name\n    , percent_change_30\n    from (\n      select mean(percent_change_30) as percent_change_30\n        from tbl\n        where admin1_name is null\n    )\n  \n  union\n  \n  select * \n    from tbl\n  \n  order by 1, 2, 3\n)\n`);\n\n\n\n\n\n\n\n// total harvested area\ndynInsightGeo_percentTotals = db.query(`\nwith tbl as (\n  -- total percentages\n  SELECT admin0_name, admin1_name, admin2_name, MEAN(percentage_change_SSP2_2050_ag) AS percent_change_50\n    FROM ag_workforce_data\n    GROUP BY 1, 2, 3\n    ORDER BY 1, 2, 3\n)\n\n-- QUERY ------------------------------------------\n(\n  -- total for all regions\n  select null as admin0_name\n    , null as admin1_name\n    , null as admin2_name\n    , percent_change_50\n    from (\n      select mean(percent_change_50) as percent_change_50\n        from tbl\n        where admin1_name is null\n    )\n  \n  union\n  \n  select * \n    from tbl\n  \n  order by 1, 2, 3\n)\n`);\n\n\n\n\n\n\n\ndynInsightGeo_vopTotals = db.query(`\n-- total ag workforce\nwith tbl as (\n  -- total VoP and harvested area\n  SELECT admin0_name, admin1_name, admin2_name, sum(corrected_index_ag_pop_SSP2_2050) AS agw_total\n    FROM ag_workforce_data\n    GROUP BY 1, 2, 3\n    ORDER BY 1, 2, 3\n)\n\n-- QUERY ------------------------------------------\n(\n  -- total for all regions\n  select null as admin0_name\n    , null as admin1_name\n    , null as admin2_name\n    , agw_total\n    from (\n      select mean(agw_total) as agw_total\n        from tbl\n        where admin1_name is null\n    )\n  \n  union\n  \n  select * \n    from tbl\n  \n  order by 1, 2, 3\n)\n`);\n\n\n\n\n\n\n\ndynInsightGeo_population = db.query(`\nwith tbl as (\n  -- ag workforce population data\n  select admin0_name\n    , admin1_name\n    , admin2_name\n    , total\n    , rural\n    , corrected_ag_pop\n    , corrected_index_ag_pop_SSP2_2050\n    , corrected_index_ag_pop_SSP2_2030\n    , corrected_index_ag_pop_SSP5_2050\n    , corrected_index_ag_pop_SSP5_2030\n    from ag_workforce_data\n    order by admin0_name\n    , admin1_name\n    , admin2_name\n)\n\n-- QUERY ------------------------------------------\n(\n  -- total for all regions\n  select null as admin0_name\n    , null as admin1_name\n    , null as admin2_name\n    , *\n    from (\n      select sum(total) as total_pop\n        , sum(rural) as rural_pop\n        , sum(corrected_ag_pop) as ag_pop\n        , sum(corrected_index_ag_pop_SSP2_2030) as ag_pop_2_30\n        , sum(corrected_index_ag_pop_SSP2_2050) as ag_pop_2_50\n        , sum(corrected_index_ag_pop_SSP5_2050) as ag_pop_5_50\n        , sum(corrected_index_ag_pop_SSP5_2030) as ag_pop_5_30\n        from tbl\n        where admin1_name is null\n    )\n  \n  union\n  \n  select *\n    from tbl\n  \n  order by 1, 2, 3\n)\n`);\n\n\n\n\n\n\n\nmd`---\n### Bar Charts - Hazards and Exposures\n*getting data based on admin selection and hazard options*`;\n\n\n\n\n\n\n\nmd`#### Plot Function\nMaking the top VoP bar charts`;\n\n\n\n\n\n\n\n// make the bar chart for top crops\n// approach is passing in data for selected hazard and crop type\nfunction makeTopCropBarChart(data) {\n  // if no data is available for selected hazard, show a message\n  if (data.length == 0) {\n    return md`*No VoP exposure*`;\n  }\n  const topN = 10;\n\n  return Plot.plot({\n    width,\n    marginLeft: 100,\n    caption: monetaryVoPNote,\n    x: {\n      tickFormat: formatUSD,\n      label: \"VoP at risk ($)\",\n      grid: true,\n    },\n    y: {\n      label: null,\n      tickSize: 0,\n    },\n    color: {\n      domain: hazardPlotLookup.color.domain,\n      range: hazardPlotLookup.color.range,\n    },\n    marks: [\n      Plot.barX(data, {\n        x: \"vop\",\n        y: (d) =&gt; hazardPlotLookup.crops[d.crop],\n        fill: (d) =&gt; hazardPlotLookup.names[d.hazard],\n        sort: { y: \"x\", reverse: true, limit: 10 },\n        channels: {\n          vop: {\n            label: \"VoP at risk\",\n            value: \"vop\",\n          },\n        },\n        tip: {\n          format: {\n            x: false,\n            y: false,\n            fill: false,\n            vop: (d) =&gt; formatUSD(d),\n          },\n        },\n      }),\n    ],\n  });\n}\n\n\n\n\n\n\n\nmd`#### Hazard Data`;\n\n\n\n\n\n\n\ndata_hazardVoP = T.tidy(\n  // data for selected hazard scenario, with total vop\n  dataHazardSelected,\n  T.leftJoin(dataHazardVoPTotalSelected, {\n    by: [\"admin0_name\", \"admin1_name\", \"admin2_name\", \"crop\"],\n  }),\n);\n\n\n\n\n\n\n\ndataHazardVoPTotalSelected = T.tidy(\n  dataHazardSelected,\n  T.groupBy(\n    [\n      \"admin0_name\",\n      \"admin1_name\",\n      \"admin2_name\",\n      \"threshold\",\n      \"scenario\",\n      \"timeframe\",\n      \"crop\",\n    ],\n    [\n      T.summarize({\n        vop_total: T.sum(\"vop\"),\n      }),\n    ],\n  ),\n);\n\n\n\n\n\n\n\n// unique crops in the hazard data\nhazardCrops = {\n  const query = await db.query(`select crop\n  , count(*) as count\n  from heat_stress_data\n  group by 1\n  order by 1`);\n\n  return query\n }\n\n\n\n\n\n\n\n// formatting crop names\ncropNames = T.tidy(\n  hazardCrops,\n  T.distinct(\"crop\"),\n  T.select(\"crop\"),\n  T.mutate({\n    // Convert crop to number for sorting\n    cropNum: (d) =&gt; parseInt(d.crop, 10),\n    // Determine the type based on the original string format (adjust as needed)\n    type: (d) =&gt; (/_/.test(d.crop) ? \"livestock\" : \"crop\"),\n    // Format the crop name\n    cropName: (d) =&gt; {\n      let cropName = d.crop.charAt(0).toUpperCase() + d.crop.slice(1);\n      if (/_/.test(d.crop)) cropName = cropName.replace(\"_\", \" (\") + \")\";\n      return cropName;\n    },\n  }),\n  // Use the numeric version of crop for sorting, then remove it from the final result as it's no longer needed\n  T.arrange([\"type\", \"cropNum\"]),\n  T.select([\"type\", \"crop\", \"cropName\"]), // Assuming you want to keep these fields in the final output\n);\n\n\n\n\n\n\n\n// lookups for hazard plot\nhazardPlotLookup = {\n  return {\n    names: {\n      baseline: _lang(nbText.sections.heatStress.barChart.group.baseline),\n      projection: _lang(nbText.sections.heatStress.barChart.group.projection)\n    },\n    color: {\n      domain: [\n        _lang(nbText.sections.heatStress.barChart.group.baseline),\n        _lang(nbText.sections.heatStress.barChart.group.projection)\n      ],\n      range: [\"#B1B1B1\", \"#EC5A47\"]\n    },\n    crops: cropNames.reduce((acc, obj) =&gt; {\n      acc[obj.crop] = obj.cropName;\n      return acc;\n    }, {})\n  };\n}\n\n\n\n\n\n\n\nmd`#### Selecting Heat Stress data by scenario\n- The data is queried as separate components for each admin region to reduce query size and allow for dynamic null handling. A table is chosen based on the selected admin region.`;\n\n\n\n\n\n\n\n// pick the admin dataset based on admin selection\ndataHazardSelected = {\n  if (adminSelections.selectAdmin2.value) return dataHazardAdmin2\n  else if (adminSelections.selectAdmin1.value) return dataHazardAdmin1\n  else if (adminSelections.selectAdmin0.value) return dataHazardAdmin0\n  else return dataHazardAdminAll\n}\n\n\n\n\n\n\n\ndataHazardAdminAll = await db.query(`\n-- admin0, combine for Sub-Saharan Africa\nwith data_tbl as (\n  with tbl as (\n    -- total for all admin0 regions\n    with base as (\n      -- chosen scenario and timeframe, VoP\n      select admin0_name\n        , admin1_name\n        , admin2_name\n        , scenario\n        , timeframe\n        , crop\n        , threshold\n        , hazard\n        , value as vop\n        from heat_stress_data\n        where timeframe = '${selectScenarioAndTimeframe.timeframe}'\n        and scenario = '${selectScenarioAndTimeframe.scenario}'\n        and threshold = '${selectThreshold.threshold}'\n    )\n    \n    select *\n      from base\n      where admin1_name is null\n  )\n\n  -- total VoP for each crop\n  select threshold\n    , scenario\n    , timeframe\n    , hazard\n    , crop\n    , SUM(vop) as vop\n    from tbl\n    group by threshold\n    , scenario\n    , timeframe\n    , hazard\n    , crop\n)\n\nselect null as admin0_name -- add admin values as nulls\n  , null as admin1_name\n  , null as admin2_name\n  , *\n  from data_tbl\n`);\n\n\n\n\n\n\n\ndataHazardAdmin0 = await db.query(`\n-- admin0 level hazard data\nwith base as (\n  -- chosen scenario and timeframe VoP\n  select admin0_name\n    , admin1_name\n    , admin2_name\n    , scenario\n    , timeframe\n    , crop\n    , threshold\n    , hazard\n    , value as vop\n    from heat_stress_data\n    where timeframe = '${selectScenarioAndTimeframe.timeframe}'\n    and scenario = '${selectScenarioAndTimeframe.scenario}'\n    and threshold = '${selectThreshold.threshold}'\n)\n\nselect *\n  from base\n  where admin1_name is null\n  and admin0_name = '${adminSelections.selectAdmin0.value}'\n`);\n\n\n\n\n\n\n\ndataHazardAdmin1 = await db.query(`\n-- admin1 level hazard data\nwith base as (\n  -- chosen scenario and timeframe VoP\n  select admin0_name\n    , admin1_name\n    , admin2_name\n    , scenario\n    , timeframe\n    , crop\n    , threshold\n    , hazard\n    , value as vop\n    from heat_stress_data\n    where timeframe = '${selectScenarioAndTimeframe.timeframe}'\n    and scenario = '${selectScenarioAndTimeframe.scenario}'\n    and threshold = '${selectThreshold.threshold}'\n)\n\nselect *\n  from base\n  where admin0_name =' ${adminSelections.selectAdmin0.value}'\n  and admin1_name = '${adminSelections.selectAdmin1.value}'\n  and admin2_name is null\n`);\n\n\n\n\n\n\n\ndataHazardAdmin2 = await db.query(`\n-- admin2 level hazard data\nwith base as (\n  -- chosen scenario and timeframe VoP\n  select admin0_name\n    , admin1_name\n    , admin2_name\n    , scenario\n    , timeframe\n    , crop\n    , threshold\n    , hazard\n    , value as vop\n    from heat_stress_data\n    where timeframe = '${selectScenarioAndTimeframe.timeframe}'\n    and scenario = '${selectScenarioAndTimeframe.scenario}'\n    and threshold = '${selectThreshold.threshold}'\n)\n\nselect *\n  from base\n  where admin0_name = '${adminSelections.selectAdmin0.value}'\n  and admin1_name = '${adminSelections.selectAdmin1.value}'\n  and admin2_name = '${adminSelections.selectAdmin2.value}'\n`);\n\n\n\n\n\n\n\nmd`---\n#### Helpers`;\n\n\n\n\n\n\n\nhelpersHazard = {\n  return {\n    colorDomain: ['crop', 'livestock'],\n    colorRange: ['seagreen', 'sienna']\n  }\n}\n\n\n\n\n\n\n\nmd`---\n### Dynamic Insights - Heat Stress in Numbers`;\n\n\n\n\n\n\n\ndata_selectedHazardCropType = T.tidy(\n  data_hazardVoP,\n  T.filter(\n    (d) =&gt;\n      d.scenario === selectScenarioAndTimeframe.scenario &&\n      d.timeframe === selectScenarioAndTimeframe.timeframe &&\n      d.threshold == selectThreshold.threshold,\n  ),\n  T.mutate({\n    cropType: (d) =&gt; {\n      if (riskDataTypes.crop.crop.includes(d.crop)) return \"crop\";\n      return \"other\";\n    },\n    cropValue: (d) =&gt; parseFloat(d.crop), // Ensure cropValue is numeric\n  }),\n  T.arrange([\"cropType\", T.desc(\"vop\")]),\n);\n\n\n\n\n\n\n\n// combined crop and livestock exposed for selection\ninsight_totalExposedVop = T.tidy(\n  data_selectedHazardCropType,\n  T.filter((d) =&gt; d.cropType === \"crop\"),\n  T.groupBy(\n    [\"cropType\", \"hazard\"],\n    [\n      T.summarize({\n        totalExposedVop: T.sum(\"vop\"),\n        totalExposedVopOver30: T.sum((d) =&gt; (d.cropValue &gt;= 30 ? d.vop : 0)), // Sum for crops over 30%\n        totalExposedVopOver50: T.sum((d) =&gt; (d.cropValue &gt;= 55 ? d.vop : 0)), // Sum for crops over 50%\n      }),\n    ],\n  ),\n);\n\n\n\n\n\n\n\ninsight_topExp = {\n  const cropsByVop = T.tidy(\n    data_selectedHazardCropType,\n    T.select([\"cropType\", \"crop\", \"vop\", \"hazard\"]),\n    T.filter(d =&gt; d.cropType == \"crop\")\n  );\n  \n  // Find the top crop by vop\n  const topCrop = T.tidy(\n    cropsByVop,\n    T.sliceMax(1, \"vop\")\n  )[0];\n  \n  // Return the combination, including topCrop only if it's not '30' or '50'\n  return [topCrop].filter(d =&gt; d !== undefined);\n};\n\n\n\n\n\n\n\n// total vop exposed by each hazard\ninsight_rankedHazardVopTotals = T.tidy(\n  data_hazardVoP,\n  T.groupBy(\n    [\"hazard\"],\n    [\n      T.summarize({\n        totalVop: T.sum(\"vop\"),\n      }),\n    ],\n  ),\n  T.filter((d) =&gt; d.hazard !== \"any\"), // remove combined hazard\n  T.arrange(T.desc(\"totalVop\")),\n);\n\n\n\n\n\n\n\nmd`---\n## BarChart - Loss of Safe Working Hours`;\n\n\n\n\n\n\n\n// make the bar chart for top crops\n// approach is passing in data for selected hazard and crop type\nfunction makeHourlyBarChart(data) {\n  // if no data is available for selected hazard, show a message\n  if (data.length == 0) {\n    return md`*No VoP exposure*`;\n  }\n  const topN = 10;\n\n  return Plot.plot({\n    width,\n    marginLeft: 100,\n    caption: monetaryVoPNote,\n    x: {\n      tickFormat: formatUSD,\n      label: \"VoP at risk ($)\",\n      grid: true,\n    },\n    y: {\n      label: null,\n      tickSize: 0,\n    },\n    color: {\n      domain: hourlyPlotLookup.color.domain,\n      range: hourlyPlotLookup.color.range,\n    },\n    marks: [\n      Plot.barX(data, {\n        x: \"delta\",\n        y: (d) =&gt; hourlyPlotLookup.hours[d.hour_day],\n        fill: (d) =&gt; hourlyPlotLookup.names[d.hazard],\n        sort: { y: \"x\", reverse: true, limit: 10 },\n        channels: {\n          delta: {\n            label: \"VoP at risk\",\n            value: \"delta\",\n          },\n        },\n        tip: {\n          format: {\n            x: false,\n            y: false,\n            fill: false,\n            delta: (d) =&gt; formatUSD(d),\n          },\n        },\n      }),\n    ],\n  });\n}\n\n\n\n\n\n\n\n// data for selected hazard scenario, with total vop\ndata_hourlyStress = T.tidy(\n  dataHourlySelected,\n  T.leftJoin(dataHazardHourlyTotalSelected, {\n    by: [\"admin0_name\", \"admin1_name\", \"admin2_name\", \"hour_day\"],\n  }),\n);\n\n\n\n\n\n\n\ndataHazardHourlyTotalSelected = T.tidy(\n  dataHourlySelected,\n  T.groupBy(\n    [\n      \"admin0_name\",\n      \"admin1_name\",\n      \"admin2_name\",\n      \"threshold\",\n      \"scenario\",\n      \"timeframe\",\n      \"hour_day\",\n    ],\n    [\n      T.summarize({\n        delta_total: T.mean(\"delta\"),\n      }),\n    ],\n  ),\n);\n\n\n\n\n\n\n\n// pick the admin dataset based on admin selection\ndataHourlySelected = {\n  if (adminSelections.selectAdmin2.value) return dataHourlyAdmin2\n  else if (adminSelections.selectAdmin1.value) return dataHourlyAdmin1\n  else if (adminSelections.selectAdmin0.value) return dataHourlyAdmin0\n  else return dataHourlyAdminAll\n}\n\n\n\n\n\n\n\ndataHourlyAdmin0 = await db.query(`\n-- admin0 level hazard data\nwith base as (\n  -- chosen scenario and timeframe VoP\n  select admin0_name\n        , admin1_name\n        , admin2_name\n        , scenario\n        , timeframe\n        , hour_day\n        , threshold\n        , hazard\n        , period\n        , corrected_pop as corrected_pop_sum\n        , delta_pop as delta_pop_mean\n        , total_days as days_period\n        , avg_count as delta\n        from hourly_data\n        where timeframe = '${selectScenarioAndTimeframe2.timeframe}'\n        and scenario = '${selectScenarioAndTimeframe2.scenario}'\n        and threshold = '${selectThreshold2.threshold}'\n)\n\nselect *\n  from base\n  where admin1_name is null\n  and admin0_name = '${adminSelections.selectAdmin0.value}'\n`);\n\n\n\n\n\n\n\ndataHourlyAdmin1 = await db.query(`\n-- admin1 level hazard data\nwith base as (\n  -- chosen scenario and timeframe VoP\n  select admin0_name\n    , admin1_name\n    , admin2_name\n    , scenario\n    , timeframe\n    , hour_day\n    , threshold\n    , hazard\n    , period\n    , corrected_pop as corrected_pop_sum\n    , delta_pop as delta_pop_mean\n    , total_days as days_period\n    , avg_count as delta\n    from hourly_data\n    where timeframe = '${selectScenarioAndTimeframe2.timeframe}'\n    and scenario = '${selectScenarioAndTimeframe2.scenario}'\n    and threshold = '${selectThreshold2.threshold}'\n)\n\nselect *\n  from base\n  where admin0_name = '${adminSelections.selectAdmin0.value}'\n  and admin1_name = '${adminSelections.selectAdmin1.value}'\n  and admin2_name is null\n`);\n\n\n\n\n\n\n\ndataHourlyAdmin2 = await db.query(`\n-- admin2 level hazard data\nwith base as (\n  -- chosen scenario and timeframe VoP\n  select admin0_name\n        , admin1_name\n        , admin2_name\n        , scenario\n        , timeframe\n        , hour_day\n        , threshold\n        , hazard\n        , period\n        , corrected_pop as corrected_pop_sum\n        , delta_pop as delta_pop_mean\n        , total_days as days_period\n        , avg_count as delta\n    from hourly_data\n        where timeframe = '${selectScenarioAndTimeframe2.timeframe}'\n        and scenario = '${selectScenarioAndTimeframe2.scenario}'\n        and threshold = '${selectThreshold2.threshold}'\n)\n\nselect *\n  from base\n  where admin0_name = '${adminSelections.selectAdmin0.value}'\n  and admin1_name = '${adminSelections.selectAdmin1.value}'\n  and admin2_name = '${adminSelections.selectAdmin2.value}'\n`);\n\n\n\n\n\n\n\ndataHourlyAdminAll = await db.query(`\n-- admin0, combine for Sub-Saharan Africa\nwith data_tbl as (\n  with tbl as (\n    -- total for all admin0 regions\n    with base as (\n      -- chosen scenario and timeframe, VoP\n      select admin0_name\n        , admin1_name\n        , admin2_name\n        , scenario\n        , timeframe\n        , hour_day\n        , threshold\n        , hazard\n        , corrected_pop as corrected_pop_sum\n        , delta_pop as delta_pop_mean\n        , total_days as days_period\n        , avg_count as delta\n        from hourly_data\n        where timeframe = '${selectScenarioAndTimeframe2.timeframe}'\n        and scenario = '${selectScenarioAndTimeframe2.scenario}'\n        and threshold = '${selectThreshold2.threshold}'\n    )\n    \n    select *\n      from base\n      where admin1_name is null\n  )\n\n  -- total VoP for each crop\n  select threshold\n    , scenario\n    , timeframe\n    , hour_day\n    , hazard\n    , SUM(corrected_pop_sum) as corrected_pop_sum\n    , MEAN(delta_pop_mean) as delta_pop_mean\n    , MEAN(delta) as delta\n    , MEAN(days_period) as days_period\n    from tbl\n    group by scenario\n    , timeframe\n    , threshold\n    , hazard\n    , hour_day\n)\n\nselect null as admin0_name -- add admin values as nulls\n  , null as admin1_name\n  , null as admin2_name\n  , *\n  from data_tbl\n`);\n\n\n\n\n\n\n\n// lookups for hazard plot\nhourlyPlotLookup = {\n  return {\n    names: {\n      planting: Lang.toTitleCase(_lang(nbText.legends.seasonTypes.planting)),\n      harvesting: Lang.toTitleCase(_lang(nbText.legends.seasonTypes.harvesting))\n    },\n    color: {\n      domain: [\n        Lang.toTitleCase(_lang(nbText.legends.seasonTypes.planting)),\n        Lang.toTitleCase(_lang(nbText.legends.seasonTypes.harvesting)),\n      ],\n      range: [\n        // red for both\n        \"#4FB5B7\", \n        \"#FCC42C\",\n      ],\n      // range: [\n      //   \"#808000\", // Olive Green\n      //   \"#B5651D\", // Light Brown\n      // ],\n    },\n    hours: hourlyNames.reduce((acc, obj) =&gt; {\n      acc[obj.hour_day] = obj.hourlyName;\n      return acc;\n    }, {})\n  };\n}\n\n\n\n\n\n\n\n// unique crops in the hazard data\nhazardHours = {\n  const query = await db.query(`select hour_day\n  , count(*) as count\n  from hourly_data\n  group by 1\n  order by 1`);\n\n  return query\n }\n\n\n\n\n\n\n\n// formatting crop names\nhourlyNames = T.tidy(\n  hazardHours,\n  T.distinct(\"hour_day\"),\n  T.select(\"hour_day\"),\n  T.mutate({\n    // Convert to number for sorting\n    hourlyNum: (d) =&gt; parseInt(d.hour_day, 10),\n    // Determine the type based on the original string format (adjust as needed)\n    type: (d) =&gt; (/_/.test(d.hour_day) ? \"livestock\" : \"hour_day\"),\n    // Format the name\n    hourlyName: (d) =&gt; {\n      let hourlyName = d.hour_day;\n      if (/_/.test(d.hour_day))\n        hourlyName = hourlyName.replace(\"_\", \" (\") + \")\";\n      return hourlyName;\n    },\n  }),\n  // Use the numeric version of hour for sorting, then remove it from the final result as it's no longer needed\n  T.arrange([\"type\", \"hourlyNum\"]),\n  T.select([\"type\", \"hour_day\", \"hourlyName\"]),\n);\n\n\n\n\n\n\n\nmd`### Dynamic Insights - Loss of Safe Working Hours`;\n\n\n\n\n\n\n\ndata_selectedHourly = T.tidy(\n  data_hourlyStress,\n  T.filter(\n    (d) =&gt;\n      d.scenario === selectScenarioAndTimeframe2.scenario &&\n      d.timeframe === selectScenarioAndTimeframe2.timeframe,\n  ),\n  T.mutate({\n    hour_dayType: (d) =&gt; {\n      if (hourlyDataTypes.hour_day.hour_day.includes(d.hour_day))\n        return \"hour_day\";\n      return \"other\";\n    },\n    hour_dayValue: (d) =&gt; parseFloat(d.hour_day), // Ensure hour_dayValue is numeric\n  }),\n  T.select([\n    \"hour_dayType\",\n    \"hazard\",\n    \"hour_day\",\n    \"delta\",\n    \"period\",\n    \"days_period\",\n    \"corrected_pop_sum\",\n    \"delta_pop_sum\",\n  ]),\n  T.arrange([\"hour_dayType\", T.desc(\"delta\")]),\n);\n\n\n\n\n\n\n\n// hourly exposition data\ninsight_totalExposedHourly = T.tidy(\n  data_selectedHourly,\n  T.filter((d) =&gt; d.hour_dayType === \"hour_day\"),\n  T.groupBy(\n    [\"hour_dayType\", \"hazard\"],\n    [\n      T.summarize({\n        totalExposedHourly: T.sum(\"delta\"),\n        period: T.first(\"period\"),\n        days_period: T.first(\"days_period\"),\n        corrected_pop_sum: T.sum(\"corrected_pop_sum\"),\n        delta_pop_sum: T.mean(\"delta_pop_sum\"),\n      }),\n    ],\n  ),\n);\n\n\n\n\n\n\n\ninsight_topHourly = {\n  const hoursByDelta = T.tidy(\n    data_selectedHourly,\n    T.select([\"hour_dayType\", \"hour_day\", \"delta\"]),\n    T.filter(d =&gt; d.hour_dayType == \"hour_day\")\n  );\n  \n  // Find the top hour by delta\n  const topHour_day = T.tidy(\n    hoursByDelta,\n    T.sliceMax(1, \"delta\")\n  )[0];\n  \n  // Return the combination, including topCrop only if it's not '30' or '50'\n  return [topHour_day].filter(d =&gt; d !== undefined);\n};\n\n\n\n\n\n\n\nmd`#### Helpers`;\n\n\n\n\n\n\n\nicicle_alias = {\n  const nameMap = {\n    population: \"Total Population\",\n    poverty0: \"Low Poverty\",\n    poverty1: \"Moderate Poverty\",\n    poverty2: \"High Poverty\",\n    education0: \"0-1 Years of Education\",\n    education1: \"1-5 Years of Education\",\n    education2: \"5+ Years of Education\",\n    gender0: \"Low Female Empowerment\",\n    gender1: \"Moderate Female Empowerment\",\n    gender2: \"High Female Empowerment\"\n  };\n  return nameMap;\n}\n\n\n\n\n\n\n\npartition = (data) =&gt;\n  d3\n    .partition()\n    .padding(1)\n    .size(narrow ? [height, width] : [width, height])(\n    d3\n      .hierarchy(data)\n      .sum((d) =&gt; d.value)\n      .sort((a, b) =&gt; b.value - a.value),\n  );\n\n\n\n\n\n\n\nicicle_color = d3\n  .scaleOrdinal()\n  .domain([\n    \"population\",\n    \"poverty2\",\n    \"poverty1\",\n    \"poverty0\",\n    \"education2\",\n    \"education1\",\n    \"education0\",\n    \"gender2\",\n    \"gender1\",\n    \"gender0\",\n  ])\n  .range([\n    \"#efefef\",\n    \"#ec5a47\",\n    \"#fc8a34\",\n    \"#f4bb21\",\n    \"#f4bb21\",\n    \"#fc8a34\",\n    \"#ec5a47\",\n    \"#f4bb21\",\n    \"#fc8a34\",\n    \"#ec5a47\",\n  ]);\n\n\n\n\n\n\n\ntargetHeight = 350;\n\n\n\n\n\n\n\nnarrowHeight = 600;\n\n\n\n\n\n\n\nheight = narrow ? narrowHeight : targetHeight;\n\n\n\n\n\n\n\nnarrow = width &lt;= 0;\n\n\n\n\n\n\n\nsegmentX = (d) =&gt; (narrow ? d.y0 : d.x0);\n\n\n\n\n\n\n\nsegmentY = (d) =&gt; (narrow ? d.x0 : d.y0);\n\n\n\n\n\n\n\nsegmentWidth = (d) =&gt; (narrow ? d.y1 - d.y0 : d.x1 - d.x0);\n\n\n\n\n\n\n\nsegmentHeight = (d) =&gt; (narrow ? d.x1 - d.x0 : d.y1 - d.y0);\n\n\n\n\n\n\n\nfunction buildHierarchy(csv) {\n  // Helper function that transforms the given CSV into a hierarchical format.\n  const root = { name: \"root\", children: [] };\n  for (let i = 0; i &lt; csv.length; i++) {\n    const sequence = csv[i][0];\n    const size = +csv[i][1];\n    if (isNaN(size)) {\n      // e.g. if this is a header row\n      continue;\n    }\n    const parts = sequence.split(\"_\");\n    let currentNode = root;\n    for (let j = 0; j &lt; parts.length; j++) {\n      const children = currentNode[\"children\"];\n      const nodeName = parts[j];\n      let childNode = null;\n      let foundChild = false;\n      // Search for existing child with the same name\n      for (let k = 0; k &lt; children.length; k++) {\n        if (children[k][\"name\"] === nodeName) {\n          childNode = children[k];\n          foundChild = true;\n          break;\n        }\n      }\n      // If not found, create a new child node\n      if (!foundChild) {\n        childNode = { name: nodeName, children: [] };\n        children.push(childNode);\n      }\n      currentNode = childNode;\n      // If it's the last part of the sequence, create a leaf node\n      if (j === parts.length - 1) {\n        childNode.value = size;\n      }\n    }\n  }\n  return root;\n}\n\n\n\n\n\n\n\nbreadcrumbWidth = 200;\n\n\n\n\n\n\n\nbreadcrumbHeight = 35;\n\n\n\n\n\n\n\n// Generate a string that describes the points of a breadcrumb SVG polygon.\nfunction breadcrumbPoints(d, i) {\n  const tipWidth = 10;\n  const points = [];\n  points.push(\"0,0\");\n  points.push(`${breadcrumbWidth},0`);\n  points.push(`${breadcrumbWidth + tipWidth},${breadcrumbHeight / 2}`);\n  points.push(`${breadcrumbWidth},${breadcrumbHeight}`);\n  points.push(`0,${breadcrumbHeight}`);\n  if (i &gt; 0) {\n    // Leftmost breadcrumb; don't include 6th vertex.\n    points.push(`${tipWidth},${breadcrumbHeight / 2}`);\n  }\n  return points.join(\" \");\n}\n\n\n\n\n\n\n\nmd`### Tabular data\n- **ag_workforce_data**: ag workforce data showing current and projected ag populations under different scenarios and for different years. File: baseline_df_data.parquet.\n- **heat_stress_data**: number of ag workders facing different sums of days on a year where WBGT values exceed 30 degrees. File: heat_stress_data.parquet.\n- **hourly_data**: percent of hours across seasons (harvesting, planting) that exceed safe WBGT thresholds. File: hourly_data.parquet.\n- **population**: population data by admin levels\n  - population/population_long.parquet`;\n\n\n\n\n\n\n\ndb = {\n  return DuckDBClient.of({\n    population: FileAttachment(\"population_long.parquet\"),\n    vop_ha: FileAttachment(\"exposure_adm_sum.parquet\"),\n    ag_workforce_data: FileAttachment(\"baseline_df_data@16.parquet\"),\n    heat_stress_data: FileAttachment(\"heat_stress_data@7.parquet\"),\n    hourly_data: FileAttachment(\"hourly_data@20.parquet\"),\n  });\n}\n\n\n\n\n\n\n\nmd`### Geographic data\nGeo files were converted to TopoJSON and reduced in complexity before uploading to the notebook, see [Simplify large spatial files](https://observablehq.com/d/258c68ee969e8ed5?collection=@periscopic/ab-atlas) notebook for method.\n- **admin0**: broadest level, country boundaries\n  - boundaries/atlas-region_admin0_harmonized.geojson\n- **admin1**: one level down from admin0, regions within each admin0 region\n  - boundaries/atlas-region_admin1_harmonized.geojson\n- **admin2**: lowest level, subregions of every admin1 region\n  - boundaries/atlas-region_admin2_harmonized.geojson`;\n\n\n\n\n\n\n\nboundaries = {\n  const input0 = await FileAttachment(\"atlas-region_admin0_harmonized.json\").json()\n  const input1 = await FileAttachment(\"atlas-region_admin1_harmonizedV2@1.json\").json()\n  const input2 = await FileAttachment(\"atlas-region_admin2_harmonizedV2.json\").json()\n\n  const geo = {\n    admin0: topojson.feature(input0, input0.objects[\"atlas-region_admin0_harmonized\"]),\n    admin1: topojson.feature(input1, input1.objects[\"atlas-region_admin1_harmonizedV2\"]),\n    admin2: topojson.feature(input2, input2.objects[\"atlas-region_admin2_harmonizedV2\"]),\n  }\n  return geo\n}\n\n\n\n\n\n\n\nmd`---\n### Risk data grouping\n*Lookups for risk data binning, such as hazards and crop types*`;\n\n\n\n\n\n\n\n// lookup for risk data type groupings\n// used by inputs and for grouping up data\nriskDataTypes = new Object({\n  crop: {\n    crop: [\n      \"10\",\n      \"15\",\n      \"20\",\n      \"25\",\n      \"30\",\n      \"35\",\n      \"40\",\n      \"45\",\n      \"50\",\n      \"55\",\n      \"60\",\n      \"65\",\n      \"70\",\n      \"75\",\n      \"80\",\n      \"85\",\n      \"90\",\n      \"95\",\n    ],\n    livestock: [\n      \"cattle_highland\",\n      \"cattle_tropical\",\n      \"goats_highland\",\n      \"goats_tropical\",\n      \"pigs_highland\",\n      \"pigs_tropical\",\n      \"poultry_highland\",\n      \"poultry_tropical\",\n      \"sheep_highland\",\n      \"sheep_tropical\",\n    ],\n  },\n});\n\n\n\n\n\n\n\n// lookup for hourly data type groupings\n// used by inputs and for grouping up data\nhourlyDataTypes = new Object({\n  hour_day: {\n    hour_day: [\n      0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20,\n      21, 22, 23,\n    ],\n  },\n});\n\n\n\n\n\n\n\nmd`---\n### Dynamic insights\n*functions for formatting results*`;\n\n\n\n\n\n\n\nfunction filterByAdminNames(data) {\n  // filter down data by combined selected admin0/admin1/admin2 Admin Selections\n  // pass data from query, use tidyjs to filter by admin selection\n  const result = T.tidy(\n    data,\n    T.filter((d) =&gt; {\n      return (\n        d.admin0_name == adminSelections.selectAdmin0.value &&\n        d.admin1_name == adminSelections.selectAdmin1.value &&\n        d.admin2_name == adminSelections.selectAdmin2.value\n      );\n    }),\n  );\n  return result;\n}\n\n\n\n\n\n\n\n// wrapper for format functions, show chosen default\nfunction formatWithDefault({\n  value = 1000,\n  format = (d) =&gt; d,\n  defaultValue = \"---\",\n  debug = false,\n} = {}) {\n  // apply a formatting function to a value\n  // return default value if undefined or null\n  if (!(value === null || value === undefined)) {\n    return format(value);\n  } else {\n    return defaultValue;\n  }\n}\n\n\n\n\n\n\n\nmd`---\n### Data functions: format and transform\n*apply formatting to/transform a value*\n\n- Reference: [Intl.NumberFormat()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/NumberFormat/NumberFormat)`;\n\n\n\n\n\n\n\nmd`**Transforms**`;\n\n\n\n\n\n\n\n// transform non-number to percent value\ntransformPercent = (d) =&gt; {\n  if (d === undefined || d === null) return d;\n  else return d * 100;\n};\n\n\n\n\n\n\n\nmd`**Formatting**`;\n\n\n\n\n\n\n\n// format non-number as percent\nformatPercentTenth = (d) =&gt; {\n  if (d === undefined || d === null) return d;\n  else return d3.format(\".1%\")(d);\n};\n\n\n\n\n\n\n\n// format non-number as percent\nformatPercentWhole = (d) =&gt; {\n  if (d === undefined || d === null) return d;\n  else return d3.format(\".0%\")(d);\n};\n\n\n\n\n\n\n\n// format US currency\nformatUSD = new Intl.NumberFormat(\"en-US\", {\n  notation: \"compact\",\n  compactDisplay: \"short\",\n  style: \"currency\",\n  currency: \"usd\",\n}).format;\n\n\n\n\n\n\n\n// format number, long notation\nformatNumCompactLong = ({ locale = \"en-US\" } = {}) =&gt;\n  new Intl.NumberFormat(locale, {\n    notation: \"compact\",\n    compactDisplay: \"long\",\n    unitDisplay: \"long\",\n  }).format;\n\n\n\n\n\n\n\n// format number, short notation\nformatNumCompactShort = ({ locale = \"en-US\" } = {}) =&gt;\n  new Intl.NumberFormat(locale, {\n    notation: \"compact\",\n    compactDisplay: \"short\",\n  }).format;\n\n\n\n\n\n\n\nmd`---\n### Querying data\n*functions for querying data*`;\n\n\n\n\n\n\n\nfunction getUniqueValues(col, tbl, db) {\n  // return unique values of from db tbl as a list\n  return db\n    .query(`select distinct ${col} from ${tbl}`)\n    .then((x) =&gt; x.map((d) =&gt; d[col]));\n}\n\n\n\n\n\n\n\nfunction bindTabularToGeo({\n  data = [],\n  dataBindColumn = \"dataBindColumn\",\n  geoData = [],\n  geoDataBindColumn = \"geoDataBindColumn\",\n}) {\n  // bind data to geojson\n  const index = new Map(data.map((d) =&gt; [d[dataBindColumn], d])); // map data by dataBindColumn\n  const geojson = JSON.parse(JSON.stringify(geoData)); // do a copy, rather than mutate\n  // join up data to geojson\n  for (const f of geojson.features) {\n    f.properties.data = index.get(f.properties[geoDataBindColumn]);\n  }\n  return geojson;\n}\n\n\n\n\n\n\n\nmd`***\n## Imports\n*External imports*`;\n\n\n\n\n\n\n\nimport { T } from \"@pbeshai/tidyjs\";\n\n\n\n\n\n\n\nselectGeoDataType;"
  },
  {
    "objectID": "notebooks/explore/notebook.html",
    "href": "notebooks/explore/notebook.html",
    "title": "Appendix",
    "section": "",
    "text": "import { heroImage } from \"/helpers/hero.js\";\nhero_url = \"./../../images/explore.webp\";\n\nhero = heroImage(notebookTitle, hero_url);\nhtml`${hero}`;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nimport { atlasTOC } from '/helpers/toc.ojs' \n{\n  await nbText // force wait/reload with nbText to load so headings have correct labels/languages\n  return atlasTOC({\n      heading: `&lt;b&gt;${_lang({en:\"In this notebook\", fr:\"Dans ce notebook\"})}&lt;/b&gt;`,\n      skip: [notebookTitle, \"notebook-title\", \"Appendix\", \"source-code\"]\n      })\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nviewof prettyLanguageView = {\n  return Inputs.bind(\n    Inputs.radio(languages, {\n      label: _lang({en: \"Language\", fr: \"Langue\"}),\n      format: (d) =&gt; d.label\n    }),\n    viewof language\n  );\n}\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.overview.title)}\n\n_${_lang(nbText.overview.subTitle)}_\n\n${_lang(nbText.overview.text)}`;\n\n\n\n\n\n\n\nhtml`\n  &lt;div style=\"\n    margin:16px 0;\n    padding:14px 18px;\n    border-radius:8px;\n    background:linear-gradient(135deg, #4f7bd9, #6fa8dc);\n    color:#ffffff;\n  \"&gt;\n    &lt;div style=\"\n      font-size:1.15rem;\n      font-weight:600;\n      margin-bottom:4px;\n    \"&gt;\n      ${_lang({\n        en: \"Looking for raster maps?\",\n        fr: \"Vous cherchez des cartes raster ?\",\n      })}\n    &lt;/div&gt;\n\n    &lt;div style=\"\n      font-size:0.95rem;\n      line-height:1.4;\n    \"&gt;\n      ${_lang({\n        en: \"Raster layers are available in our previous Explore view.\",\n        fr: \"Les couches raster sont disponibles dans l’ancienne vue Explorer.\",\n      })}\n      &lt;a\n        href=\"http://agadaptationatlas-stage.org.s3-website-us-west-2.amazonaws.com/explore\"\n        target=\"_blank\"\n        rel=\"noopener noreferrer\"\n        style=\"\n          color:#ffffff;\n          font-weight:600;\n          text-decoration:underline;\n          margin-left:4px;\n        \"\n      &gt;\n        ${_lang({\n          en: \"Open Explore →\",\n          fr: \"Ouvrir Explorer →\",\n        })}\n      &lt;/a&gt;\n    &lt;/div&gt;\n  &lt;/div&gt;\n`;\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.selectCategory.title_main)}`;\n\n\n\n\n\n\n\nmd`### ${_lang(nbText.selectCategory.title)}\n${_lang(nbText.selectCategory.text)}`;\n\n\n\n\n\n\n\nviewof atlas_cat = Inputs.radio([\"Hazard\", \"Exposure\", \"Vulnerability\"], {\n  label: _lang(nbText.selectCategory.selector.title),\n  value: \"Hazard\",\n  format: (l) =&gt;  _lang(nbText.selectCategory.selector.options[l].title)\n})\n\n\n\n\n\n\n\n{\n  return md`${_lang(nbText.selectCategory.selector.options[atlas_cat].description)}`\n}\n\n\n\n\n\n\n\nmd`### ${_lang(nbText.selectVars.title)}\n${_lang(nbText.selectVars.text)}`;\n\n\n\n\n\n\n\ndefinitions = create_definitions(atlas_cat);\n\n\n\n\n\n\n\nviewof DataSelector_form = {\n  const form_elements = {\n    hazardGroup_form:\n      atlas_cat === \"Hazard\"\n        ? Inputs.form(\n            {\n              hazard_sel: ScrollingMultiSelect_collapsible(\n                // Object.keys(hazard_dict),\n                new Map(\n                  Object.entries(hazard_dict).map(([key, value]) =&gt; [\n                    _lang(nbText.general.hazards[key]),\n                    key\n                  ])\n                ),\n                {\n                  label: _lang(nbText.selectVars.forms.Hazard.selectors.hazard.title), \n                  values: Object.keys(hazard_dict),\n                }\n              ),\n              timeperiod_sel: ScrollingMultiSelect_collapsible(\n                new Map([\n                  [_lang(nbText.selectVars.forms.Hazard.selectors.period.options.baseline), \"historic\"],\n                  [\"2021-2040\", \"2021_2040\"],\n                  [\"2041-2060\", \"2041_2060\"]\n                ]),\n                {\n                  label: _lang(nbText.selectVars.forms.Hazard.selectors.period.title),\n                  values: [\"historic\", \"2021_2040\", \"2041_2060\" ]\n                }\n              )\n            },\n            {\n              template: (inputs) =&gt;\n                html`&lt;h4&gt;${_lang(nbText.selectVars.forms.Hazard.mainTitle)}&lt;/h4&gt;&lt;div style=\"display: flex; gap: 2em;\"&gt; ${Object.values(\n                  inputs\n                )}&lt;/div&gt;`\n            }\n          )\n        : \"\",\n    vulnerabilityGroup_form:\n      atlas_cat === \"Vulnerability\"\n        ? Inputs.form(\n            {\n              vulnerability_sel: ScrollingMultiSelect_collapsible(\n                [\"Education\", \"Poverty\", \"Gender\"],\n                {\n                  label: _lang(nbText.selectVars.forms.Vulnerability.selectors.variable.title),\n                  values: [\"Education\", \"Poverty\", \"Gender\"],\n                  format: (l) =&gt; _lang(nbText.selectVars.forms.Vulnerability.selectors.variable.options[l])\n                }\n              )\n            },\n            {\n              template: (inputs) =&gt;\n                html`&lt;h4&gt;${_lang(nbText.selectVars.forms.Vulnerability.mainTitle)}&lt;/h4&gt;&lt;div style=\"display: flex; gap: 2em;\"&gt; ${Object.values(\n                  inputs\n                )}&lt;/div&gt;`\n            }\n          )\n        : \"\",\n    exposureGroup_form:\n      atlas_cat === \"Exposure\"\n        ? Inputs.form(\n            {\n              exposureGroup_sel: ScrollingMultiSelect_collapsible(\n                // Object.values(commodities).flat(),\n                [\"Crop\", \"Livestock\", \"Population\"],\n                {\n                  label: \"Exposure Category\",\n                  values: [\"Crop\", \"Livestock\", \"Population\"],\n                  format: (l) =&gt; _lang(nbText.selectVars.forms.Exposure.selectors.variable.options[l])\n                }\n              )\n            },\n            {\n              template: (inputs) =&gt;\n                html`&lt;h4&gt;${_lang(nbText.selectVars.forms.Exposure.mainTitle)}&lt;/h4&gt;&lt;div style=\"display: flex; gap: 2em;\"&gt; ${Object.values(\n                  inputs\n                )}&lt;/div&gt;`\n            }\n          )\n        : \"\"\n  };\n\n  return Inputs.form(form_elements);\n}\n\n\n\n\n\n\n\nmd`### ${_lang(nbText.selectGeog.title)}\n${_lang(nbText.selectGeog.text)}`;\n\n\n\n\n\n\n\nviewof admin_aggregationLevel = {\n  const admin_choices = ['admin0_name', 'admin1_name', 'admin2_name']\n\n  let radio = Inputs.radio(admin_choices, {\n    label: _lang(nbText.selectGeog.selectors.aggregationLvl.title),\n    value: \"admin1_name\",\n    format: (l) =&gt; _lang(nbText.selectGeog.selectors.aggregationLvl.options[l])\n  });\n  let selectors = radio.querySelectorAll(\"input[name=input]\");\n  let labels = radio.querySelectorAll(\"label\");\n  if (selectors && selectors[2] && country === 'SSA') {\n    selectors[2].title = _lang(nbText.selectGeog.selectors.aggregationLvl.warning);\n  }\n  if (labels && labels[2] && country === 'SSA') {\n    labels[3].title =\n      _lang(nbText.selectGeog.selectors.aggregationLvl.warning);\n  labels[3].style.color = \"#b8310f\";\n  }\n  return radio;\n}\n\n\n\n\n\n\n\n{\n  let adminOptions = [\n    Inputs.bind(\n      Inputs.select(admin0_names, { label: _lang(nbText.selectGeog.selectors.admin0_name.title),\n                                   value: \"SSA\",\n                                  format: l =&gt; _lang(nbText.general.adminNames[l]) || l}),\n      viewof country\n    )\n  ];\n  \n  if ([\"admin1_name\", \"admin2_name\"].includes(admin_aggregationLevel)) {\n    adminOptions.push(\n      Inputs.bind(\n        Inputs.select(admin1_names, \n                      { \n                        label: _lang(nbText.selectGeog.selectors.admin1_name.title),\n                        format: l =&gt; _lang(nbText.general.adminNames[l]) || l\n                      }),\n        viewof admin1_sel\n      )\n    );\n  } \n  \n  if (admin_aggregationLevel === \"admin2_name\") {\n    adminOptions.push(\n      Inputs.bind(\n        Inputs.select(admin2_names, { label: _lang(nbText.selectGeog.selectors.admin2_name.title),\n                     format: l =&gt; _lang(nbText.general.adminNames[l]) || l\n                                    }),\n        viewof admin2_sel\n      )\n    );\n  }\n  return Inputs.form(adminOptions, {\n    template: (inputs) =&gt;\n      htl.html`&lt;div style=\"display: flex; gap: 3em\"&gt;${inputs}&lt;/div&gt;`\n  });\n}\n\n\n\n\n\n\n\n{\n  const levelLabel = _lang(\n    nbText.selectGeog.selectors.aggregationLvl.options[admin_aggregationLevel]\n  ).toLowerCase()\n\n  const levelText = _lang({\n    en: `at the ${levelLabel} level`,\n    fr: `au niveau ${levelLabel}`\n  })\n\n  let mainText = _lang({\n    en: `Viewing ${_lang(nbText.general.adminNames[country])}`,\n    fr: `Affichage de ${_lang(nbText.general.adminNames[country])}`\n  })\n\n  if (admin_aggregationLevel === \"admin2_name\" && admin1_sel !== \"Full Country\") {\n    mainText += _lang({\n      en: `, ${admin1_sel}`,\n      fr: `, ${admin1_sel}`\n    })\n  }\n\n  let highlightText = \"\"\n\n  if (admin_aggregationLevel === \"admin1_name\" && admin1_sel !== \"Full Country\") {\n    highlightText = _lang({\n      en: `${admin1_sel} is highlighted`,\n      fr: `${admin1_sel} est mis en surbrillance`\n    })\n  } else if (\n    admin_aggregationLevel === \"admin2_name\" &&\n    admin2_sel !== \"Full Region\"\n  ) {\n    highlightText = _lang({\n      en: `${admin2_sel} is highlighted`,\n      fr: `${admin2_sel} est mis en surbrillance`\n    })\n  }\n\n  return html`\n    &lt;p style=\"font-size:1.3rem; font-weight:600; margin:0 0 4px 0;\"&gt;\n      ${_lang({\n        en: \"Selection overview:\",\n        fr: \"Aperçu de la sélection :\"\n      })}\n    &lt;/p&gt;\n    &lt;p style=\"font-size:1.15rem; margin:0; padding-left:0.75rem;\"&gt;\n      &lt;strong&gt;\n        ${mainText} ${levelText}. &lt;br&gt;\n        ${highlightText ? `${highlightText}.` : \"\"}\n      &lt;/strong&gt;\n    &lt;/p&gt;\n  `\n}\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.ViewExplore.title)}\n${_lang(nbText.ViewExplore.text)}`;\n\n\n\n\n\n\n\nviewof previewType = Inputs.radio([\"Map\", \"Table\", \"Plot\"], {\n  //, \"Interactive Map\",\n  // Icons to these would be pretty\n  value: \"Map\",\n  label: _lang(nbText.ViewExplore.selectors.preview.title),\n  format: (l) =&gt; _lang(nbText.ViewExplore.selectors.preview.options[l])\n})\n\n\n\n\n\n\n\nviewof data_to_visualise = {\n  if (previewType === \"Map\") {\n    return generateMapForm()\n  } else if (previewType === \"Table\") {\n    return Inputs.search(NbData[\"explore_data\"], {placeholder: _lang(nbText.general.search)});\n  } else if (previewType === \"Plot\") {\n    return generatePlotForm()\n  }\n  \n  function generateMapForm() {\n    const form_elements = [];\n    if (atlas_cat === \"Hazard\") {\n      let hazardOptions = DataSelector_form.hazardGroup_form.hazard_sel;\n      form_elements.push(\n        Inputs.bind(\n          Inputs.select(\n            hazardOptions.map((value) =&gt; value),\n            // new Map(\n            //   hazardOptions.map((value) =&gt; [_lang(nbText.selectVars.forms.Hazard.selectors.hazard.options[value]), value])\n            // ),\n            { label: _lang(nbText.selectVars.forms.Hazard.selectors.hazard.title),\n              format: l =&gt; _lang(nbText.general.hazards[l])\n            }\n          ),\n          viewof hazard_sel\n        )\n      );\n      let timePeriodOptions = DataSelector_form.hazardGroup_form.timeperiod_sel;\n      form_elements.push(\n        Inputs.bind(\n          Inputs.select(\n            timePeriodOptions.map((value) =&gt; value),\n            // new Map(\n            //   timePeriodOptions.map((value) =&gt; [timePeriod_dict[value], value])\n            // ),\n            { label: _lang(nbText.selectVars.forms.Hazard.selectors.period.title),\n              format: l =&gt; _lang(nbText.selectVars.forms.Hazard.selectors.period.options[l]) || l\n            }\n          ),\n          viewof time_sel\n        )\n      );\n      if (time_sel !== \"historic\") {\n        form_elements.push(\n          Inputs.bind(\n            Inputs.select([\"SSP245\", \"SSP585\"], { label: _lang(nbText.ViewExplore.selectors.visualiseVars.hazards.scenario.title)}),\n            viewof ssp_sel\n          )\n        );\n      }\n    }\n    \n    if (atlas_cat === \"Vulnerability\") {\n      form_elements.push(\n        Inputs.bind(\n          Inputs.select(\n            DataSelector_form.vulnerabilityGroup_form.vulnerability_sel,\n            {\n              label: _lang(nbText.selectCategory.selector.options.Vulnerability.title),\n              format: l =&gt; _lang(nbText.selectVars.forms.Vulnerability.selectors.variable.options[l])||l\n              // label: \"Adaptive Capacity\"\n            }\n          ),\n          viewof ac_cat\n        )\n      );\n      if (ac_cat === \"Gender\") {\n        let ac_subcats = Object.keys(vulnerability_dict[\"gender\"])\n        form_elements.push(\n          Inputs.bind(\n            Inputs.select(ac_subcats, {\n              label: _lang(nbText.ViewExplore.selectors.visualiseVars.vulnerability.gender.title),\n              format: l =&gt; _lang(nbText.ViewExplore.selectors.visualiseVars.vulnerability.gender.options[l])\n            }),\n            viewof ac_subcat\n          )\n        );\n      } else if (ac_cat === \"Poverty\") {\n        // let ac_subcats = new Map(\n        //   Object.entries(vulnerability_dict[\"poverty\"]).map(([key, value]) =&gt; [\n        //     value,\n        //     key\n        //   ])\n        // );\n        let ac_subcats = Object.keys(vulnerability_dict[\"poverty\"])\n        form_elements.push(\n          Inputs.bind(\n            Inputs.select(ac_subcats, {\n              label:  _lang(nbText.ViewExplore.selectors.visualiseVars.vulnerability.poverty.title),\n              format: l =&gt; _lang(nbText.ViewExplore.selectors.visualiseVars.vulnerability.poverty.options[l])\n            }),\n            viewof ac_subcat\n          )\n        );\n      }\n    }\n    if (atlas_cat === \"Exposure\") {\n      let subTitle;\n      let subSelections;\n      if (exposure_cat === \"Population\") {\n        subTitle = _lang(nbText.ViewExplore.selectors.visualiseVars.exposure.population.title);\n        subSelections = [\"total_pop\", \"rural_pop\", \"urban_pop\"]\n      } else {\n        subTitle = _lang(nbText.ViewExplore.selectors.visualiseVars.exposure.commodity.title);\n        subSelections = commodities[exposure_cat];\n      }\n\n      form_elements.push(\n        Inputs.bind(\n          Inputs.select(\n            DataSelector_form.exposureGroup_form.exposureGroup_sel,\n            {\n              label: _lang(nbText.ViewExplore.selectors.visualiseVars.exposure.title),\n              format: l =&gt; _lang(nbText.selectVars.forms.Exposure.selectors.variable.options[l])\n            }\n          ),\n          viewof exposure_cat\n        )\n      );\n      form_elements.push(\n        Inputs.bind(\n          Inputs.select(subSelections, {\n            label: subTitle,\n            format: l =&gt; _lang(nbText.ViewExplore.selectors.visualiseVars.exposure.population.options[l] || nbText.general.commodities[l])\n          }),\n          viewof exposure_subCat\n        )\n      );\n      if (exposure_cat !== \"Population\") {\n        form_elements.push(\n                    Inputs.bind(\n              Inputs.select(exposure_var_choices, {\n                label: _lang(nbText.ViewExplore.selectors.visualiseVars.exposure.exposureVariable.title),\n                format: (t) =&gt; _lang(nbText.ViewExplore.selectors.visualiseVars.exposure.exposureVariable.options[t])\n              }),\n              viewof exposure_var\n            )\n        )\n      }\n    }\n    return Inputs.form(form_elements, {\n      template: (inputs) =&gt;\n        htl.html`&lt;h3&gt;${_lang(nbText.ViewExplore.selectors.visualiseVars.titleMap)}&lt;/h3&gt; &lt;div style=\"display: flex; gap: 3em\"&gt;${inputs}&lt;/div&gt;`\n    });\n  }\n  \n  function generatePlotForm() {\n    let form_elements = [];\n    let title = _lang(nbText.ViewExplore.selectors.visualiseVars.titlePlot);\n    if (atlas_cat === \"Exposure\") {\n      form_elements.push(\n        Inputs.bind(\n          Inputs.select(\n            DataSelector_form.exposureGroup_form.exposureGroup_sel,\n            {\n              label: _lang(nbText.ViewExplore.selectors.visualiseVars.exposure.title),\n              format: l =&gt; _lang(nbText.selectVars.forms.Exposure.selectors.variable.options[l])\n            }\n          ),\n          viewof exposure_cat\n        )\n      );\n      if (exposure_cat.includes(\"Crop\") || exposure_cat.includes(\"Livestock\")) {\n        form_elements.push(\n          Inputs.bind(\n            Inputs.select(exposure_var_choices, {\n              label: _lang(nbText.ViewExplore.selectors.visualiseVars.exposure.exposureVariable.title),\n              format: (t) =&gt; _lang(nbText.ViewExplore.selectors.visualiseVars.exposure.exposureVariable.options[t])\n            }),\n            viewof exposure_var\n          )\n        );\n      }\n    }\n    if (atlas_cat === \"Hazard\") {\n      let hazardOptions = DataSelector_form.hazardGroup_form.hazard_sel;\n      form_elements.push(\n        Inputs.bind(\n          Inputs.select(\n            hazardOptions.map((value) =&gt; value),\n            { label: _lang(nbText.selectVars.forms.Hazard.selectors.hazard.title),\n              format: l =&gt; _lang(nbText.general.hazards[l])\n            }\n          ),\n          viewof hazard_sel\n        )\n      );\n    }\n    if (atlas_cat === \"Vulnerability\") {\n      title = \"\";\n    }\n    return Inputs.form(form_elements, {\n      template: (inputs) =&gt;\n        htl.html`&lt;h3&gt;${title}&lt;/h3&gt; &lt;div style=\"display: flex; gap: 3em\"&gt;${inputs}&lt;/div&gt;`\n    });\n  }\n}\n\n\n\n\n\n\n\ndata_preview = {\n  if (previewType === \"Map\") {\n    return html`&lt;div&gt;${map()}&lt;/div&gt;`;\n    // } else if (previewType === \"Interactive Map\") {\n    //   return html`&lt;div&gt;${MapInfo.MapLegend}&lt;/div&gt; &lt;div&gt;${MapContainer}&lt;/div&gt;`;\n  } else if (previewType === \"Table\") {\n    return html`&lt;div&gt;${createTable()}&lt;/div&gt;`;\n  } else if (previewType === \"Plot\") {\n    // return html`&lt;div&gt;${container2}&lt;/div&gt;`;\n    return html`&lt;div&gt;${await createPlot()}&lt;/div&gt;`;\n  }\n}\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.download.title)}`;\n\n\n\n\n\n\n\nviewof download_format = {\n  // let downlaod_options;\n  let download_options = [\"Parquet\", \"CSV\", \"JSON\"]; //, \"GEOPARQUET\", \"GEOJSON\"];\n\n  return Inputs.radio(download_options, {\n    label: _lang(nbText.download.selector.title),\n    value: \"Parquet\"\n  });\n}\n\n\n\n\n\n\n\nhtml`&lt;div &gt;${download_button_initiate()}&lt;/div&gt;`;\n\n\n\n\n\n\n\nmd`### ${_lang(nbText.download.boundaries.title)}`;\n\n\n\n\n\n\n\ndownload_spatial_button();\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.STAC.title)}\n\n${_lang(nbText.STAC.text)}`;\n\n\n\n\n\n\n\nviewof codeLanguage = Inputs.radio([\"R\", \"Python\", \"NoCode\"], {\n  label: \"Language\",\n  value: \"NoCode\",\n  format: l =&gt; _lang(nbText.general[l]) || l\n})\n\n\n\n\n\n\n\ncodechunk = {\n\n  if (codeLanguage === \"NoCode\") {\n    return html`&lt;iframe src ='https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/catalog.json?.language=${language.key}' style=\"width:100%; height: 800px;\"&gt;`\n  } else {\n    let code_text = generate_codeText(codeLanguage)\n      let markdown_code = md`\n\\`\\`\\` ${codeLanguage.toLowerCase()}\n${code_text}\n\\`\\`\\``\n     return html`&lt;div style='overflow: auto; max-height: 800px; background-color:#F8F8F8;padding-left: 10px'&gt;${markdown_code}&lt;/div&gt;`\n  }\n\nfunction generate_codeText(codeLang) {\n  let code_text\n  switch (codeLang) {\n    case \"R\":\n      let r_adminQuery = country !== 'SSA' ? `admin_query &lt;- 'SELECT * from \"atlas-region_admin0_harmonized\" WHERE admin0_name = \\\\'${country}\\\\''` : `admin_query &lt;- 'SELECT * from \"atlas-region_admin0_harmonized\"'`\n    code_text = `library(terra)\nlibrary(rstac)\n\nadmin_path &lt;- '/vsis3/digital-atlas/boundaries/atlas-region_admin0_harmonized.parquet' \n${r_adminQuery}\nadminBounds &lt;- vect(admin_path, query = admin_query)\nstac_path &lt;- \"https:///digital-atlas.s3.amazonaws.com/stac/public_stac/catalog.json\"\nstac_catalog &lt;- read_stac(stac_path)\n\nchildren &lt;- links(stac_catalog, rel == 'child')\nchildren_df &lt;- do.call(\"rbind\", lapply(children, as.data.frame))\nprint(children_df$title)\n\nhazardCatalog &lt;- link_open(children[[grep(\"Hazard\", children)]])\nprint(hazardCatalog$description)\nhaz_children &lt;- links(hazardCatalog, rel == 'child')\nhaz_children_df &lt;- do.call(\"rbind\", lapply(haz_children, as.data.frame))\nhaz_children_df$description &lt;- sapply(haz_children, \\(x) {\n  child &lt;- link_open(x)\n  child$description\n})\n\nhazard_items &lt;- link_open(haz_children[[1]]) |&gt; \n    rstac::read_items(limit = 10)\n\nhazard_items |&gt; \n    rstac::items_as_tibble()\n\npossible_filters &lt;- items_properties(hazard_items)\n\nmeanNDWS_tifs &lt;- hazard_items |&gt; \n    rstac::items_filter(filter_fn = \\(x) {\n        (x$properties$\\`atlas:hazard\\` == \"NDWS\" \n        & x$properties$\\`atlas:statistic\\` == \"mean\") }) |&gt;\n    rstac::assets_url()\n\ncountry_data &lt;- meanNDWS_tifs |&gt; \n    gsub(x= _, 'https://digital-atlas.s3.amazonaws.com/', '/vsis3/digital-atlas') |&gt;\n    terra::rast() |&gt; \n    crop(adminBounds, mask = T)\n    \nplot(country_data)`;\n      break\n    case 'Python':\n      code_text = `import pystac\nimport rasterio\nimport pandas as pd\nfrom matplotlib import pyplot\nfrom pystac_client import Client\n\nstac_path = \"https://digital-atlas.s3.amazonaws.com/stac/public_stac/catalog.json\"\n\ncatalog = Client.open(stac_path)\nprint(catalog.title)\nprint(catalog.description)\n\nchildren = []\nfor child in catalog.get_children():\n    print(child)\n    title = child.title\n    id = child.id\n    description = child.description\n    self_href = child.self_href\n    keywords = child.extra_fields.get('keywords') or None\n    children.append({\n        'title': title,\n        'id': child.id,\n        'description': description,\n        'keywords': keywords,\n        'self_href': self_href\n    })\n\ncatalog_df = pd.DataFrame(children)\n\nhazardCatalog = catalog.get_child('hazard_catalog')\nprint(hazardCatalog.description)\n\nhazard_items = []\nfor child in hazardCatalog.get_children():\n    print(child)\n    title = child.title\n    id = child.id\n    description = child.description\n    self_href = child.self_href\n    keywords = child.extra_fields.get('keywords') or None\n    hazard_items.append({\n        'title': title,\n        'id': child.id,\n        'description': description,\n        'keywords': keywords,\n        'self_href': self_href\n    })\n\nhazardCatalog_df = pd.DataFrame(hazard_items)\n\nhazard_timeseries = hazardCatalog.get_child('hazard_timeseries_annual')\nprint(hazard_timeseries.description)\n\npossible_filters = next(hazard_timeseries.get_items()).properties.keys()\nprint(possible_filters)\n\ndef filter_items(item_generator:pystac.ItemCollection, filters:dict, limit:int=10):\n    count = 0\n    for item in item_generator:\n        for key, value in filters.items():\n            if item.properties.get(key) != value:\n                break\n        else:\n            yield item\n            count += 1\n            if count &gt;= limit:\n                break\n\nitem_filters: {'atlas:hazard': 'NDWS', 'atlas:statistic': 'mean'}\n\nmeanNDWS_items = filter_items(hazard_timeseries.get_items(), {'atlas:hazard': 'NDWS', 'atlas:statistic': 'mean'}, limit=10)\n\nNDWS_assets = []\nfor item in meanNDWS_items:\n    print(item)\n    assets = item.get_assets()\n    for key in assets.keys():\n        print(key)\n        NDWS_assets.append(assets.get(key).href)\n\n\nwith rasterio.open(NDWS_assets[0].replace('https://digital-atlas.s3.amazonaws.com/', 's3://digital-atlas')) as src:\n    print(src.meta)\n    pyplot.imshow(src.read(12))\n    pyplot.show()`\n      break\n  }\n  return code_text\n}\n  \n}\n\n\n\n\n\n\n\nmd`# ${_lang(nbText.methods_sources.title)}`;\n\n\n\n\n\n\n\nmd`## ${_lang(nbText.methods_sources.datasets.title)}`;\n\n\n\n\n\n\n\nmd`### ${_lang(nbText.methods_sources.datasets.boundaries.title)}\n${_lang(nbText.methods_sources.datasets.boundaries.text)}`;\n\n\n\n\n\n\n\nmd`### ${_lang(nbText.methods_sources.datasets.Hazards.title)}\n${_lang(nbText.methods_sources.datasets.Hazards.text)}`;\n\n\n\n\n\n\n\nmd`### ${_lang(nbText.methods_sources.datasets.exposureDS.title)}`;\n\n\n\n\n\n\n\nmd`#### ${_lang(nbText.methods_sources.datasets.exposureDS.vopHA.title)}\n${_lang(nbText.methods_sources.datasets.exposureDS.vopHA.text)}`;\n\n\n\n\n\n\n\nmd`#### ${_lang(nbText.methods_sources.datasets.exposureDS.population.title)}\n${_lang(nbText.methods_sources.datasets.exposureDS.population.text)}`;\n\n\n\n\n\n\n\nmd`### ${_lang(nbText.methods_sources.datasets.acDS.title)}`;\n\n\n\n\n\n\n\nmd`#### ${_lang(nbText.methods_sources.datasets.acDS.FemaleWellbeing.title)}\n ${_lang(nbText.methods_sources.datasets.acDS.FemaleWellbeing.text)}`;\n\n\n\n\n\n\n\nmd`#### ${_lang(nbText.methods_sources.datasets.acDS.poverty.title)}\n${_lang(nbText.methods_sources.datasets.acDS.poverty.text)}`;\n\n\n\n\n\n\n\nAppendix\n\nmd`## Imports`;\n\n\n\n\n\n\n\nGEOS = {\n  const initgeosJs = (await import(\"https://cdn.skypack.dev/geos-wasm@2.0.0\"))\n    .default;\n  const geos = await initgeosJs();\n\n  function geosGeomFromWKB(wkb) {\n    const wkbPtr = geos.Module._malloc(wkb.length); //Allocate memory for the geom\n    geos.Module.HEAPU8.set(wkb, wkbPtr);\n    const geomPtr = geos.GEOSGeomFromWKB_buf(wkbPtr, wkb.length);\n    geos.Module._free(wkbPtr);\n    return geomPtr;\n  }\n  \n  const geosGeomToGeojson = (\n    await import(\"https://cdn.skypack.dev/geos-wasm/helpers\")\n  ).geosGeomToGeojson;\n\n  return { geosGeomToGeojson, geosGeomFromWKB, geos };\n}\n\n\n\n\n\n\n\ngeo_db = {\n  let db = await DuckDBClient.of({\n    // admin0_geom: FileAttachment(\"atlas-region_admin0_simplified.parquet\"),\n    admin1_geom: FileAttachment(\"atlas-region_admin1_simplified.parquet\")\n  });\n  await db.query(`\n    CREATE VIEW admin2_geom AS\n    SELECT *\n    FROM read_parquet(\"${resolveWindowsCacheIssue(\n      \"https://digital-atlas.s3.amazonaws.com/boundaries/atlas-region_admin2_simplified.parquet\"\n    )}\")`);\n  return db;\n}\n\n\n\n\n\n\n\ndb = {\n  // const db = await DuckDBClient.of();\n  let db = await DuckDBClient.of({\n    // admin0_geom: FileAttachment(\"atlas-region_admin0_simplified.parquet\"),\n    // admin1_geom: FileAttachment(\"atlas-region_admin1_simplified.parquet\")\n  });\n  // await db.query(`\n  //   CREATE VIEW admin2_geom AS\n  //   SELECT *\n  //   FROM read_parquet(\"https://digital-atlas.s3.amazonaws.com/boundaries/atlas-region_admin2_simplified.parquet\")`);\n  // await db.query(`\n  //   CREATE VIEW exposurePopulation AS\n  //   SELECT *\n  //   FROM read_parquet('${s3Paths[\"Population\"]}')`);\n  // await db.query(`\n  //   CREATE VIEW Exposure AS\n  //   SELECT *\n  //   FROM read_parquet('${s3Paths[\"Exposure\"][\"exposure\"]}')`);\n  // // await build_DB(db, atlas_cat);\n  // await db.query(`\n  //     CREATE VIEW exposureCrop AS\n  //     SELECT *\n  //     FROM read_parquet('${s3Paths[\"Exposure\"][\"cropVOP\"]}')\n  //     UNION ALL\n  //     SELECT *\n  //     FROM read_parquet('${s3Paths[\"Exposure\"][\"cropHA\"]}')\n  //   `);\n  // await db.query(`\n  //     CREATE VIEW exposureLivestock AS\n  //     SELECT *\n  //     FROM read_parquet('${s3Paths[\"Exposure\"][\"livestockVOP\"]}')\n  //     WHERE \"crop\" NOT LIKE '%total%'\n  //     UNION ALL\n  //     SELECT *\n  //     FROM read_parquet('${s3Paths[\"Exposure\"][\"livestockNum\"]}')\n  //     WHERE \"crop\" NOT LIKE '%total%'\n  //   `);\n  await db.query(`\n      CREATE VIEW Hazard AS\n      SELECT admin0_name, admin1_name, admin2_name, scenario, timeframe, hazard, value\n      FROM read_parquet('${s3Paths[\"Hazard\"]}')\n    `);\n  return await db;\n}\n\n\n\n\n\n\n\nCheckORAdd_ExposureTable = async (db) =&gt; {\n  let tables = await db.describeTables().then((r) =&gt; r.map((d) =&gt; d.name));\n  if (!tables.includes(\"Exposure\")) {\n    await db.query(`\n    CREATE VIEW exposurePopulation AS\n    SELECT *\n    FROM read_parquet('${s3Paths[\"Population\"]}')`);\n    await db.query(`\n    CREATE VIEW Exposure AS\n    SELECT *\n    FROM read_parquet('${s3Paths[\"Exposure\"][\"exposure\"]}')`);\n    await db.query(`\n      CREATE VIEW exposureCrop AS\n          SELECT admin0_name, admin1_name, admin2_name, crop, exposure, \"value\" as old_value, CASE \n            WHEN value &lt; 1000 THEN 0\n              ELSE value\n            END AS value\n          FROM read_parquet('${s3Paths[\"Exposure\"][\"cropVOP\"]}')\n          UNION ALL\n          SELECT admin0_name, admin1_name, admin2_name, crop, exposure, \"value\" as old_value, CASE\n            WHEN value &lt; 1000 THEN 0\n              ELSE value\n            END AS value\n          FROM read_parquet('${s3Paths[\"Exposure\"][\"cropHA\"]}')`);\n    await db.query(`\n      CREATE VIEW exposureLivestock AS\n      SELECT *\n      FROM read_parquet('${s3Paths[\"Exposure\"][\"livestockVOP\"]}')\n      WHERE \"crop\" NOT LIKE '%total%'\n      UNION ALL\n      SELECT *\n      FROM read_parquet('${s3Paths[\"Exposure\"][\"livestockNum\"]}')\n      WHERE \"crop\" NOT LIKE '%total%'\n    `);\n  }\n};\n\n\n\n\n\n\n\nCheckORAdd_VulnTable = async (db) =&gt; {\n  let tables = await db.describeTables().then((r) =&gt; r.map((d) =&gt; d.name));\n  if (!tables.includes(\"Vulnerability\")) {\n    await db.query(`\n      CREATE VIEW Vulnerability AS\n      SELECT *\n      FROM read_parquet('${s3Paths[\"Vulnerability\"]}')\n    `);\n  }\n};\n\n\n\n\n\n\n\nimport { ScrollingMultiSelect_collapsible } from \"@brayden-youngberg/scrolling-multi-select\";\n\n\n\n\n\n\n\nturfRewind = require(\"@turf/turf\").then((t) =&gt; t.rewind);\n\n\n\n\n\n\n\nimport { resolveWindowsCacheIssue } from \"72281be2f13a0a72\";\n\n\n\n\n\n\n\nmd`## Notebook Variables`;\n\n\n\n\n\n\n\nnotebookTitle = _lang({\n  en: \"Explore the Datasets\",\n  fr: \"Explorer les jeux de données\",\n});\n\n\n\n\n\n\n\ntimePeriod_dict = new Object({\n  historic: \"Baseline\",\n  \"2021_2040\": \"2040\",\n  \"2041_2060\": \"2060\",\n});\n\n\n\n\n\n\n\ns3Paths = new Object({\n  Population: resolveWindowsCacheIssue(\n    \"s3://digital-atlas/population/worldpop_2020/population_adminALL.parquet\",\n  ),\n  Exposure: {\n    exposure: resolveWindowsCacheIssue(\n      \"s3://digital-atlas/exposure/exposure_adminALL.parquet\",\n    ),\n    cropVOP: resolveWindowsCacheIssue(\n      \"s3://digital-atlas/exposure/mapspam/processed/crop_ha_adm.parquet\",\n    ),\n    cropHA: resolveWindowsCacheIssue(\n      \"s3://digital-atlas/exposure/mapspam/processed/crop_vop_adm.parquet\",\n    ),\n    livestockVOP: resolveWindowsCacheIssue(\n      \"s3://digital-atlas/exposure/livestock/processed/livestock_vop_adm.parquet\",\n    ),\n    livestockNum: resolveWindowsCacheIssue(\n      \"s3://digital-atlas/exposure/livestock/processed/livestock_no_adm.parquet\",\n    ),\n  },\n  Hazard: resolveWindowsCacheIssue(\n    \"s3://digital-atlas/hazards/hazard_timeseries_mean/annual/haz_means_adm.parquet\",\n  ),\n  Vulnerability:\n    // \"https://digital-atlas.s3.amazonaws.com/vulnerability/vulnerability_adm0-1-2.parquet\"\n    resolveWindowsCacheIssue(\n      \"s3://digital-atlas/vulnerability/vulnerability_adminALL.parquet\",\n    ),\n});\n\n\n\n\n\n\n\nmerged_scale = [\"#EC5A47\", \"#ffb347\", \"#F7D732\", \"#a3ab2e\"].reverse();\n\n\n\n\n\n\n\nhazard_dict = new Object({\n  HSH_max: {\n    name: \"Max Human Heat Stress\",\n    thresholds: [27, 32, 41, 54],\n    // colours: [\"#b7e3c9\", \"#ffec80\", \"#ffb347\", \"#f78154\", \"#db3a34\"]\n    colours: merged_scale.concat([\"#B8547F\"]),\n  },\n  HSH_mean: {\n    name: \"Mean Human Heat Stress\",\n    thresholds: [27, 32, 41, 54],\n    // colours: [\"#b7e3c9\", \"#ffec80\", \"#ffb347\", \"#f78154\", \"#db3a34\"]\n    colours: merged_scale.concat([\"#B8547F\"]),\n  },\n  NDWL0: {\n    name: \"Number of Waterlogging Days\",\n    thresholds: [2, 5, 8],\n    // colours: [\"#b7e3c9\", \"#ffec80\", \"#ffb347\", \"#f78154\"]\n    colours: merged_scale,\n  },\n  NDWS: {\n    name: \"Number of Days of Water Stress\",\n    thresholds: [15, 20, 25],\n    // colours: [\"#b7e3c9\", \"#ffec80\", \"#ffb347\", \"#f78154\"]\n    colours: merged_scale,\n  },\n  NTx35: {\n    name: \"Number of Heat Stress Days for Maize\",\n    thresholds: [10, 20, 25],\n    // colours: [\"#b7e3c9\", \"#ffec80\", \"#ffb347\", \"#f78154\"]\n    colours: merged_scale,\n  },\n  NTx40: {\n    name: \"Number of Heat Stress Days for Generic Crops\",\n    thresholds: [1, 5, 10],\n    // colours: [\"#b7e3c9\", \"#ffec80\", \"#ffb347\", \"#f78154\"]\n    colours: merged_scale,\n  },\n  TAI: {\n    name: \"Thornthwaite's Aridity Index\",\n    thresholds: [40, 60, 80],\n    // colours: [\"#b7e3c9\", \"#ffec80\", \"#ffb347\", \"#f78154\"]\n    colours: merged_scale,\n  },\n  THI_max: {\n    name: \"Max Cattle Thermal Humidity Index\",\n    thresholds: [72, 78, 90],\n    // colours: [\"#b7e3c9\", \"#ffec80\", \"#ffb347\", \"#f78154\"]\n    colours: merged_scale,\n  },\n  THI_mean: {\n    name: \"Mean Cattle Thermal Humidity Index\",\n    thresholds: [72, 78, 90],\n    // colours: [\"#b7e3c9\", \"#ffec80\", \"#ffb347\", \"#f78154\"]\n    colours: merged_scale,\n  },\n  TAVG: {\n    name: \"Average Temperature\",\n    thresholds: [33, 36, 47],\n    colours: merged_scale,\n  },\n  PTOT: {\n    name: \"Total Precipitation\",\n    thresholds: [1200, 1600, 1800],\n    colours: merged_scale,\n  },\n});\n\n\n\n\n\n\n\nvulnerability_dict = new Object({\n  gender: {\n    domestic_violence: \"Lack of Domestic Violence\",\n    gender_equity: \"Gender Equity\", // leaving out the 1995-2015 equity index, as the rest of the AC vars are from ~2015, which is this\n    decision_making: \"Decision Making Power\",\n    education: \"Womens Education\",\n    family_planning: \"Access to Family Planning\",\n    reproductive_health: \"Reproductive Health\",\n  },\n  poverty: {\n    GSAP_poor215: \"% under $2.15 poverty line\",\n    GSAP_poor365: \"% under $3.65 poverty line\",\n    GSAP_poor685: \"% under $6.85 poverty line\",\n  },\n  education: {\n    educationYrs: \"Education(Yrs)\",\n  },\n});\n\n\n\n\n\n\n\nplotQuery_admin = {\n  if (country === \"SSA\") {\n    return `WHERE admin1_name IS NULL`;\n  } else if (country !== \"SSA\" && admin1_sel === \"Full Country\") {\n    return `WHERE admin0_name = '${country}' AND admin1_name IS NULL`;\n  } else if (admin1_sel !== \"Full Country\" && admin2_sel === \"Full Region\") {\n    return `WHERE admin0_name = '${country}' AND admin1_name = ${admin1_sel}`;\n  } else if (admin2_sel !== \"Full Region\") {\n    return `Where admin admin0_name = '${country}' AND admin1_name = ${admin1_sel} AND admin2_name = ${admin2_sel}`;\n  }\n}\n\n\n\n\n\n\n\nmapDataQuery_admin = {\n  // if (country === \"SSA\") {\n  //   return `WHERE admin1_name IS NULL`;\n  // } else if (country !== \"SSA\" && admin1_sel === \"Full Country\") {\n  //   return `WHERE admin0_name = '${country}' AND admin1_name IS NULL`;\n  // } else if (admin1_sel !== \"Full Country\" && admin2_sel === \"Full Region\") {\n  //   return `WHERE admin0_name = '${country}' AND admin1_name = ${admin1_sel}`;\n  // } else if (admin2_sel !== \"Full Region\") {\n  //   return `Where admin admin0_name = '${country}' AND admin1_name = ${admin1_sel} AND admin2_name = ${admin2_sel}`;\n  // }\n\n  let admin_query;\n  if (country === \"SSA\") {\n    if (admin_aggregationLevel === \"admin0_name\") {\n      admin_query = `WHERE admin1_name IS NULL`;\n    } else if (admin_aggregationLevel === \"admin1_name\") {\n      admin_query = `WHERE admin1_name IS NOT NULL AND admin2_name IS NULL`;\n    } else if (admin_aggregationLevel === \"admin2_name\") {\n      admin_query = `WHERE admin2_name IS NOT NULL`;\n    }\n  } else if (country !== \"SSA\" && admin1_sel === \"Full Country\") {\n    if (admin_aggregationLevel === \"admin0_name\") {\n      admin_query = `WHERE admin0_name = '${country}' AND admin1_name IS NULL`;\n    } else if (admin_aggregationLevel === \"admin1_name\") {\n      admin_query = `WHERE admin0_name = '${country}' AND admin1_name IS NOT NULL AND admin2_name IS NULL`;\n    } else if (admin_aggregationLevel === \"admin2_name\") {\n      admin_query = `WHERE admin0_name = '${country}' AND admin1_name IS NOT NULL AND admin2_name IS NOT NULL`;\n    }\n  } else if (admin1_sel !== \"Full Country\" && admin2_sel === \"Full Region\") {\n    if (admin_aggregationLevel === \"admin1_name\") {\n      admin_query = `WHERE admin0_name = '${country}' AND admin1_name ='${admin1_sel}' AND admin2_name IS NULL`;\n    } else if (admin_aggregationLevel === \"admin2_name\") {\n      admin_query = `WHERE admin0_name = '${country}' AND admin1_name ='${admin1_sel}' AND admin2_name IS NOT NULL`;\n    }\n  } else if (admin2_sel !== \"Full Region\") {\n    admin_query = `WHERE admin0_name = '${country}' AND admin1_name ='${admin1_sel}' AND admin2_name ='${admin2_sel}'`;\n  }\n  return admin_query;\n}\n\n\n\n\n\n\n\nplotQuery2_admin = {\n  if (country === \"SSA\") {\n    return `WHERE admin1_name IS NULL`;\n  } else if (country !== \"SSA\" && admin1_sel === \"Full Country\") {\n    return `WHERE admin0_name = '${country}' AND admin1_name IS NOT NULL AND admin2_name IS NULL`;\n  } else if (admin1_sel !== \"Full Country\" && admin2_sel === \"Full Region\") {\n    return `WHERE admin0_name = '${country}' AND admin1_name = '${admin1_sel}' AND admin2_name IS NOT NULL`;\n  } else if (admin2_sel !== \"Full Region\") {\n    return `WHERE admin0_name = '${country}' AND admin1_name = '${admin1_sel}' AND admin2_name = '${admin2_sel}'`;\n  }\n}\n\n\n\n\n\n\n\nall_data_query = {\n  let db_query;\n  if (atlas_cat === \"Vulnerability\") {\n    db_query = `\n      SELECT *,\n      FROM Vulnerability\n      ${mapDataQuery_admin}\n      AND \"group\" in ('${DataSelector_form.vulnerabilityGroup_form.vulnerability_sel\n        .join(\"', '\")\n        .toLowerCase()}')`;\n  } else if (atlas_cat === \"Exposure\") {\n    db_query = `\n      SELECT *\n      FROM Exposure\n      ${mapDataQuery_admin}\n      AND \"group\" in ('${DataSelector_form.exposureGroup_form.exposureGroup_sel\n        .join(\"', '\")\n        .toLowerCase()}')`;\n  } else if (atlas_cat === \"Hazard\") {\n    db_query = `\n    SELECT *\n    FROM Hazard\n    ${mapDataQuery_admin}\n    AND \"hazard\" IN ('${DataSelector_form.hazardGroup_form.hazard_sel.join(\n      \"', '\"\n    )}')\n    AND \"timeframe\" IN ('${DataSelector_form.hazardGroup_form.timeperiod_sel.join(\n      \"', '\"\n    )}')`;\n  }\n\n  return db_query;\n}\n\n\n\n\n\n\n\nmap_query = {\n  let db_query;\n  if (atlas_cat === \"Exposure\") {\n    if (exposure_cat === \"Population\") {\n      // const pop_group = exposure_subCat.split(\" \")[0].toLowerCase() + \"_pop\";\n      db_query = `\n      SELECT admin0_name, admin1_name, admin2_name, ${exposure_subCat} AS value\n      FROM \"${atlas_cat.toLowerCase() + exposure_cat}\"\n      `;\n    } else {\n      let exposure;\n      exposure = exposure_var;\n      db_query = `\n      SELECT *\n      FROM \"${atlas_cat.toLowerCase() + exposure_cat}\"\n      WHERE \"exposure\" LIKE '${exposure}'\n      AND \"crop\" LIKE '${exposure_subCat}'`;\n    }\n  } else if (atlas_cat === \"Vulnerability\") {\n    db_query = `\n      SELECT *\n      FROM Vulnerability\n      WHERE \"group\" LIKE '${ac_cat.toLocaleLowerCase()}'\n  `;\n    if (ac_cat === \"Gender\" || ac_cat === \"Poverty\") {\n      db_query = db_query + `AND \"variable\" LIKE '${ac_subcat}'`;\n    }\n  } else if (atlas_cat === \"Hazard\") {\n    db_query = `\n    SELECT *\n    FROM Hazard\n    WHERE \"hazard\" LIKE '${hazard_sel}'\n    AND \"scenario\" LIKE '${ssp_sel.toLowerCase()}' AND \"timeframe\" LIKE '${time_sel.toLowerCase()}'`;\n  } else {\n    db_query = null\n  }\n  return db_query;\n}\n\n\n\n\n\n\n\nNbData = {\n  if (atlas_cat === \"Vulnerability\") {\n    await CheckORAdd_VulnTable(db);\n  } else if (atlas_cat === \"Exposure\") {\n    await CheckORAdd_ExposureTable(db);\n  } else {\n  }\n  return {\n    explore_data: await db.query(all_data_query),\n    map_data: await db.query(map_query)\n  };\n}\n\n\n\n\n\n\n\nadmin_index = d3.index(\n  NbData[\"map_data\"],\n  (d) =&gt; d.admin0_name,\n  (d) =&gt; d.admin1_name,\n  (d) =&gt; d.admin2_name,\n);\n\n\n\n\n\n\n\ncrop_groups = new Object({\n  cattle: [\"cattle_tropical\", \"cattle_highland\"],\n  poultry: [\"poultry_tropical\", \"poultry_highland\"],\n  pigs: [\"pigs_tropical\", \"pigs_highland\"],\n  \"Small Ruminants\": [\n    \"sheep_tropical\",\n    \"sheep_highland\",\n    \"goats_tropical\",\n    \"goats_highland\",\n  ],\n  rootsTuber: [\"potato\", \"sweet potato\", \"yams\", \"cassava\"],\n  cereals: [\n    \"wheat\",\n    \"rice\",\n    \"maize\",\n    \"barley\",\n    \"pearl millet\",\n    \"small millet\",\n    \"sorghum\",\n  ],\n  legumes: [\n    \"bean\",\n    \"chickpea\",\n    \"cowpea\",\n    \"pigeonpea\",\n    \"lentil\",\n    \"groundnut\",\n    \"soybean\",\n  ],\n  fruitVeg: [\"plantain\", \"coconut\", \"banana\"],\n  nonEdible: [\n    \"cocoa\",\n    \"rapeseed\",\n    \"sesameseed\",\n    \"oilpalm\",\n    \"cotton\",\n    \"tea\",\n    \"tobacco\",\n    \"arabica coffee\",\n    \"sunflower\",\n    \"sugarcane\",\n    \"sugarbeet\",\n    \"robusta coffee\",\n  ],\n});\n\n\n\n\n\n\n\nmd`## Format helpers`;\n\n\n\n\n\n\n\nformatDollar = new Intl.NumberFormat(\"en-US\", {\n  notation: \"compact\",\n  compactDisplay: \"short\",\n  style: \"currency\",\n  currency: \"usd\",\n}).format;\n\n\n\n\n\n\n\nformatBigNums = new Intl.NumberFormat(\"en-US\", {\n  notation: \"compact\",\n  compactDisplay: \"short\",\n}).format;\n\n\n\n\n\n\n\nfunction format_val(val, unit) {\n  switch (unit) {\n    case \"dollar\":\n      return formatDollar(val);\n    case \"total\":\n      return formatBigNums(val);\n    case \"total_ha\":\n      return `${formatBigNums(val)} /ha`;\n    case \"index\":\n      return val.toFixed(2);\n    case \"percent\":\n      return `${(val * 100).toFixed(2)}%`;\n    case \"percent_NoDecimal\":\n      return `${(val * 100).toFixed(0)}%`;\n    default:\n      if (typeof unit === \"number\") {\n        return (val * unit).toFixed(1);\n      }\n      return val; // Default case if unit doesn't match any condition\n  }\n}\n\n\n\n\n\n\n\nvar_unit = {\n  if (atlas_cat === \"Hazard\") {\n    const clean_haz = hazard_sel.split(\"_\")[0];\n    return unit_dict[atlas_cat][clean_haz];\n  }\n\n  if (atlas_cat === \"Exposure\") {\n    if (exposure_var === \"vop\") {\n      return unit_dict[atlas_cat][exposure_var];\n    } else if (exposure_cat === \"Population\") {\n      return unit_dict[atlas_cat][\"populationTotal\"];\n    } else {\n      const clean_var = exposure_var;\n      const full_var = exposure_cat.toLowerCase() + clean_var;\n      return unit_dict[atlas_cat][full_var]; //.toLowerCase()\n    }\n  }\n\n  if (atlas_cat === \"Vulnerability\") {\n    return unit_dict[atlas_cat][ac_cat];\n  }\n}\n\n\n\n\n\n\n\nunit_dict = {\n  let day_lab = _lang(nbText.general.units.days)\n  let index_lab =  _lang(nbText.general.units.index)\n  let yr_lab = _lang(nbText.general.units.yrs)\n  let pop_lab = _lang(nbText.general.units.num_people)\n  let numAnimal_lab = _lang(nbText.general.units.num_animals)\n  \n  return {\n    Exposure: {\n      vop: { label: \"IND2005\", category: \"dollar\" },\n      livestocknumber: { label: numAnimal_lab, category: \"total\" },\n      cropha: { label: \"Ha\", category: \"total\" },\n      populationTotal: { label: pop_lab, category: \"total\" }\n    },\n    Hazard: {\n      THI: { label: index_lab, category: \"total\" },\n      TAVG: { label: \"ºC\", category: \"total\" },\n      TAI: { label: \"%\", category: \"total\" },\n      PTOT: { label: \"mm\", category: \"total\" },\n      NTx35: { label: day_lab, category: \"total\" },\n      NTx40: { label: day_lab, category: \"total\" },\n      NDWS: { label: day_lab, category: \"total\" },\n      NDWL0: { label: day_lab, category: \"total\" },\n      HSH: { label: index_lab, category: \"total\" }\n    },\n    Vulnerability: {\n      Gender: { label: index_lab, category: \"index\" },\n      Education: { label: yr_lab, category: \"total\" },\n      Poverty: { label: \"%\", category: \"percent\" }\n    }\n  }\n}\n\n\n\n\n\n\n\nmd`## Download Helpers`;\n\n\n\n\n\n\n\n\ndownload_button_initiate = () =&gt; {\n  const button = html`&lt;a class=atlas_button&gt;${_lang(nbText.download.button.prepare)}&lt;/a&gt;`;\n\n  button.onclick = async () =&gt; {\n    document.body.style.cursor = \"wait\";\n    button.textContent = \"Loading...\";\n    const utc_date = new Date().toISOString();\n    const dateregex = /^(\\d{4})-(\\d{2})-(\\d{2})/;\n    const yyyymmdd = utc_date.match(dateregex)[0];\n    let file_name = \"adaptation-atlas_\" + atlas_cat + \"_\" + yyyymmdd;\n    let file_ext = download_format.toLowerCase();\n    const full_name = file_name + \".\" + file_ext;\n\n    let downloadBlob;\n    if (download_format === \"Parquet\" || download_format === \"CSV\") {\n      downloadBlob = await downloadTabular(\n        file_name,\n        file_ext,\n        db,\n        download_format,\n        full_name,\n      );\n    } else if (download_format === \"JSON\") {\n      let cleanJSON = await NbData[\"explore_data\"].map((row) =&gt;\n        Object.fromEntries(row),\n      ); // not a totally valid json, needs fixing.\n      downloadBlob = new Blob([NbData[\"explore_data\"]], {\n        type: \"application/json\",\n      });\n    }\n    // const size = (downloadBlob.size / 1000000).toFixed(0);\n    const url = URL.createObjectURL(downloadBlob);\n    const downloadButton = html`&lt;a href=\"${url}\" download=\"${full_name}\" target=\"_blank\" class=\"atlas_button\"&gt;${_lang(nbText.download.button.download)} ${download_format} &lt;/a&gt;`; //(~${size} mb)\n    button.replaceWith(downloadButton);\n    document.body.style.cursor = \"default\";\n  };\n  return button;\n};\n\n\n\n\n\n\n\nasync function downloadTabular(\n  file_name,\n  file_ext,\n  db,\n  download_format,\n  full_name,\n) {\n  const regex = new RegExp(`${file_name}\\\\.${file_ext}`);\n  const db_connect = await db._db;\n  let files = await db_connect.globFiles(\"/tmp/*\" + \".\" + file_ext);\n  let file = files.find((d) =&gt; d.fileName.match(regex));\n  if (files.length === 0 || file === undefined) {\n    if (download_format === \"PARQUET\") {\n      let copied = await db.query(\n        `COPY (${all_data_query}) to '/tmp/${full_name}' (FORMAT 'PARQUET', COMPRESSION 'snappy')`,\n      );\n    } else {\n      let copied = await db.query(\n        `COPY (${all_data_query}) to '/tmp/${full_name}' (FORMAT 'CSV', HEADER, DELIMITER ',')`,\n      );\n    }\n    files = await db_connect.globFiles(\"/tmp/*\" + \".\" + file_ext);\n    file = files.find((d) =&gt; d.fileName.match(regex));\n  }\n  const app_type =\n    download_format === \"PARQUET\" ? \"application/octet-stream\" : \"text/csv\";\n  const buffer = await db_connect.copyFileToBuffer(file.fileName);\n  const downloadData = new Blob([buffer], {\n    type: app_type,\n  });\n  db_connect.dropFile(`/tmp/${full_name}`);\n  return downloadData;\n}\n\n\n\n\n\n\n\nasync function downloadSpatial(\n  // The issue with this one is that it needs to be long format somehow...\n  file_name,\n  file_ext,\n  download_format,\n  full_name,\n) {\n  if (download_format === \"PARQUET\") {\n  }\n}\n\n\n\n\n\n\n\ndownload_spatial_button = () =&gt; {\n  let adm_level = admin_aggregationLevel.match(/\\d+/)[0];\n  let downloadBlob = new Blob([JSON.stringify(adminLevel_spatial)], {\n    type: \"application/geo+json\",\n  });\n  let size = (downloadBlob.size / 1000000).toFixed(0);\n  let url = URL.createObjectURL(downloadBlob);\n\n  let button_template = _lang(nbText.download.boundaries.button);\n  let btn_txt = Lang.reduceReplaceTemplateItems(button_template, [\n    { name: \"adminLvl\", value: adm_level },\n  ]);\n\n  let downloadButton = html`&lt;a href=\"${url}\" download=\"Atlas-boundaries_admin${adm_level}.json\" target=\"_blank\" class=atlas_button&gt;${btn_txt}&lt;/a&gt;`;\n  return downloadButton;\n};\n\n\n\n\n\n\n\ndownload_metadata_button = () =&gt; {\n  let downloadBlob = new Blob([\",\"], {\n    type: \"text/csv\",\n  });\n  let size = (downloadBlob.size / 1000000).toFixed(0);\n  let url = URL.createObjectURL(downloadBlob);\n\n  let downloadButton = html`&lt;a href=\"${url}\" download=\"AdaptationAtlas_metadata.csv\" target=\"_blank\" style=\"background: grey; color: white; padding: 10px 20px; border-radius: 50px; text-decoration: none;\"&gt;Download Metadata&lt;/a&gt;`;\n  return downloadButton;\n};\n\n\n\n\n\n\n\nmd`## Geography`;\n\n\n\n\n\n\n\nadminLevel_spatial = {\n  let admFeatures;\n  if (country === \"SSA\") {\n    if (admin_aggregationLevel === \"admin0_name\") {\n      admFeatures = admin0_load;\n    } else if (admin_aggregationLevel === \"admin1_name\") {\n      admFeatures = admin1;\n    } else if (admin_aggregationLevel === \"admin2_name\") {\n      admFeatures = admin2;\n    }\n  } else if (country !== \"SSA\" && admin1_sel === \"Full Country\") {\n    if (admin_aggregationLevel === \"admin0_name\") {\n      admFeatures = admin0_load;\n      // let filtered = admin0_load.features.filter(\n      //   (d) =&gt; d.properties.admin0_name === country\n      // );\n      // // Create a new GeoJSON object with the filtered features\n      // admFeatures = {\n      //   type: admin0_filtered.type,\n      //   features: filtered\n      // };\n    } else if (admin_aggregationLevel === \"admin1_name\") {\n      admFeatures = admin1;\n    } else if (admin_aggregationLevel === \"admin2_name\") {\n      admFeatures = admin2;\n    }\n  } else if (country !== \"SSA\" && admin1_sel !== \"Full Country\") {\n    if (admin_aggregationLevel === \"admin1_name\") {\n      admFeatures = admin1;\n      // let filtered = admin1.features.filter(\n      //   (d) =&gt; d.properties.admin1_name === admin1_sel\n      // );\n      // // Create a new GeoJSON object with the filtered features\n      // admFeatures = {\n      //   type: admin1.type,\n      //   features: filtered\n      // };\n    } else if (admin_aggregationLevel === \"admin2_name\") {\n      admFeatures = admin2;\n    }\n  }\n\n  admFeatures.features.forEach((d) =&gt; {\n    const data = admin_index\n      .get(d.properties.admin0_name || null)\n      .get(d.properties.admin1_name || null)\n      .get(d.properties.admin2_name || null);\n    d.properties.value = data[\"value\"];\n  });\n\n  //   admFeatures.features.forEach((d) =&gt; {\n  //     const a2_data = index\n  //       .get(d.properties.admin0_name)\n  //       .get(d.properties.admin1_name)\n  //       .get(d.properties.admin2_name);\n  //     d.properties.value = a2_data[\"value\"];\n  //   });\n  // }\n  return admFeatures; // Will return either the updated features or undefined if 'country' is not \"SSA\"\n}\n\n\n\n\n\n\n\nadmin0_load = { \n  // Admin 2 is a geojson so that initial page load can be faster(not wait for DB setup)\n  let geojson = await FileAttachment(\n    \"atlas-region_admin0_simplified.geojson\"\n  ).json();\n  let a0_names = geojson.features.map((d) =&gt; d.properties.admin0_name);\n  mutable admin0_names = [\"SSA\"].concat(a0_names);\n  // if (country !== \"SSA\") {\n  //   let filtered = geojson.features.filter(\n  //     (d) =&gt; d.properties.admin0_name === country\n  //   );\n  //   geojson.features = filtered;\n  // } else {\n  //   return geojson;\n  // }\n  return geojson;\n\n  // let response = await db.query(`\n  //   SELECT *\n  //   FROM admin0_geom`);\n  // let a0_names = response.map((d) =&gt; d.admin0_name);\n  // mutable admin0_names = [\"SSA\"].concat(a0_names);\n  // let wkb_list = response.map((d) =&gt; d.geometry);\n  // let data = await response.map(({ geometry, ...rest }) =&gt; rest);\n  // const features = [];\n  // for (let i = 0; i &lt; wkb_list.length; i++) {\n  //   const pointer = GEOS.geosGeomFromWKB(wkb_list[i]);\n  //   const geojson = await GEOS.geosGeomToGeojson(pointer, GEOS.geos);\n  //   geojson.coordinates.forEach((polygon) =&gt; {\n  //     polygon.forEach((ring) =&gt; {\n  //       ring.reverse();\n  //     });\n  //   });\n  //   const feature = {\n  //     type: \"Feature\",\n  //     geometry: geojson,\n  //     properties: data[i]\n  //   };\n  //   features.push(feature);\n  //   GEOS.geos.GEOSGeom_destroy(pointer);\n  // }\n  // const geojson = {\n  //   type: \"FeatureCollection\",\n  //   features: features\n  // };\n  // return { names: [\"SSA\"].concat(a0_names), GEOJSON: geojson };\n}\n\n\n\n\n\n\n\nadmin0_filtered = {\n  if (country !== \"SSA\") {\n    let filtered = admin0_load.features.filter((d) =&gt; {\n      return d.properties.admin0_name === country;\n    });\n    // Create a new GeoJSON object with the filtered features\n    return {\n      type: admin0_load.type,\n      features: filtered\n    };\n  } else {\n    return admin0_load;\n  }\n}\n\n\n\n\n\n\n\nadmin1 = {\n  let admin1_query;\n  if (country === \"SSA\" && admin_aggregationLevel === \"admin1_name\") {\n    admin1_query = ``;\n  } else if (\n    admin_aggregationLevel === \"admin1_name\" ||\n    admin_aggregationLevel === \"admin2_name\"\n  ) {\n    admin1_query = `WHERE admin0_name = '${country}'`;\n  } else {\n    admin1_query = `WHERE admin1_name = ''`; // This will always return empty, so response will be empty geojson\n  }\n\n  let response = await geo_db.query(`\n    SELECT *\n    FROM admin1_geom\n    ${admin1_query}`);\n  let a1_names = response.map((d) =&gt; d.admin1_name);\n  mutable admin1_names = [\"Full Country\"].concat(a1_names);\n  let wkb_list = response.map((d) =&gt; d.geometry);\n  let data = await response.map(({ geometry, ...rest }) =&gt; rest);\n  const features = [];\n  for (let i = 0; i &lt; wkb_list.length; i++) {\n    const pointer = GEOS.geosGeomFromWKB(wkb_list[i]);\n    let geojson = await GEOS.geosGeomToGeojson(pointer, GEOS.geos);\n    geojson = turfRewind(geojson, { reverse: true });\n    const feature = {\n      type: \"Feature\",\n      geometry: geojson,\n      properties: data[i]\n    };\n    features.push(feature);\n    GEOS.geos.GEOSGeom_destroy(pointer);\n  }\n  const geojson = {\n    type: \"FeatureCollection\",\n    features: features\n  };\n  // return { names: [\"Full Country\"].concat(a1_names), GEOJSON: geojson };\n  return geojson;\n}\n\n\n\n\n\n\n\nadmin2 = {\n  let admin2_query;\n  if (admin2_sel !== \"Full Region\") {\n    admin2_query = `WHERE admin0_name = '${country}' and admin1_name = '${admin1_sel}'`; // and admin2_name = '${admin2_sel}'\n  } else if (\n    admin2_sel === \"Full Region\" &&\n    admin1_sel !== \"Full Country\" &&\n    admin_aggregationLevel === \"admin2_name\"\n  ) {\n    admin2_query = `WHERE admin0_name = '${country}' and admin1_name = '${admin1_sel}'`;\n  } else if (\n    admin1_sel === \"Full Country\" &&\n    country !== \"SSA\" &&\n    admin_aggregationLevel === \"admin2_name\"\n  ) {\n    admin2_query = `WHERE admin0_name = '${country}'`;\n  } else if (country === \"SSA\" && admin_aggregationLevel === \"admin2_name\") {\n    admin2_query = ``;\n  } else {\n    admin2_query = `where admin2_name = ''`;\n  }\n\n  let response = await geo_db.query(`\n    SELECT *\n    FROM admin2_geom\n    ${admin2_query}`); // WHERE admin0_name = '${country}' AND admin1_name = '${admin1_sel}'`);\n\n  //// THIS IS WHRE YOU ARE AT&gt;&gt;&gt;\n  let wkb_list = response.map((d) =&gt; d.geometry);\n  let data = await response.map(({ geometry, ...rest }) =&gt; rest);\n  const features = [];\n  for (let i = 0; i &lt; wkb_list.length; i++) {\n    const pointer = GEOS.geosGeomFromWKB(wkb_list[i]);\n    let geojson = await GEOS.geosGeomToGeojson(pointer, GEOS.geos);\n    geojson = turfRewind(geojson, { reverse: true });\n    const feature = {\n      type: \"Feature\",\n      geometry: geojson,\n      properties: data[i]\n    };\n    features.push(feature);\n    GEOS.geos.GEOSGeom_destroy(pointer);\n  }\n  const geojson = {\n    type: \"FeatureCollection\",\n    features: features\n  };\n  // return { names: [\"Full Region\"].concat(a2_names), GEOJSON: geojson };\n  return geojson;\n}\n\n\n\n\n\n\n\nappend_a2Names = {\n  let response = await geo_db.query(`\n    SELECT admin2_name\n    FROM admin2_geom\n    where admin0_name = '${country}' and admin1_name = '${admin1_sel}'`); // WHERE admin0_name = '${country}' AND admin1_name = '${admin1_sel}'`);\n  //// THIS IS WHRE YOU ARE AT&gt;&gt;&gt;\n  let a2_names = response.map((d) =&gt; d.admin2_name);\n  mutable admin2_names = [\"Full Region\"].concat(a2_names);\n  return a2_names;\n}\n\n\n\n\n\n\n\nmd`### Geography Selectors`;\n\n\n\n\n\n\n\nmutable admin0_names = [\"SSA\"]\n\n\n\n\n\n\n\nmutable admin1_names = [\"Full Country\"]\n\n\n\n\n\n\n\nmutable admin2_names = [\"Full Region\"]\n\n\n\n\n\n\n\nviewof country = {\n  const country = Inputs.select(admin0_names, {\n    label: \"Select Country\"\n  });\n  return country;\n}\n\n\n\n\n\n\n\nviewof admin1_sel = Inputs.select(admin1_names, { label: \"admin1\" })\n\n\n\n\n\n\n\nviewof admin2_sel = Inputs.select(admin2_names, { label: \"admin2\" })\n\n\n\n\n\n\n\nmd`## Selector Forms`;\n\n\n\n\n\n\n\nmd`### Hazard`;\n\n\n\n\n\n\n\nviewof hazard_sel = Inputs.select(\n  // Inputs.select(\n  //   new Map(\n  //     DataSelector_form.hazardGroup_form.hazard_sel.map((value) =&gt; [\n  //       hazard_dict[value].name,\n  //       value\n  //     ])\n  //   ),\n  //   { label: \"Hazard\" }\n  // ),\n  new Map(Object.entries(hazard_dict).map(([key, value]) =&gt; [value.name, key])),\n  { label: \"Hazard\" } //, format: ([name]) =&gt; `${name}`\n)\n\n\n\n\n\n\n\nviewof time_sel = Inputs.select(\n  new Map([\n    [\"Baseline\", \"historic\"],\n    [\"2040\", \"2021_2040\"],\n    [\"2060\", \"2041_2060\"]\n  ]),\n  { label: \"Time Period\", value: \"historic\" } //, format: ([name]) =&gt; `${name}`\n)\n\n\n\n\n\n\n\nviewof ssp_sel = {\n  const choices = time_sel === \"historic\" ? [\"Historic\"] : [\"SSP245\", \"SSP585\"];\n  return Inputs.select(choices, { label: \"Scenario\" });\n}\n\n\n\n\n\n\n\nmd`### Adaptive Capacity`;\n\n\n\n\n\n\n\nviewof ac_cat = Inputs.select([\"Education\", \"Poverty\", \"Gender\"], {\n  // value: \"Poverty\",\n  label: \"Adaptive Capacity\"\n})\n\n\n\n\n\n\n\nviewof ac_subcat = {\n  let subcats;\n  if (ac_cat === \"Gender\") {\n    subcats = new Map(\n      Object.entries(vulnerability_dict[\"gender\"]).map(([key, value]) =&gt; [\n        value,\n        key\n      ])\n    );\n  } else if (ac_cat === \"Poverty\") {\n    subcats = new Map(\n      Object.entries(vulnerability_dict[\"poverty\"]).map(([key, value]) =&gt; [\n        value,\n        key\n      ])\n    );\n  } else {\n    subcats = [];\n  }\n  return Inputs.select(subcats, {\n    label: `${ac_cat} Category`\n  });\n}\n\n\n\n\n\n\n\nmd`## Exposure`;\n\n\n\n\n\n\n\nviewof exposure_cat = Inputs.select([\"Crop\", \"Livestock\", \"Population\"], {\n  value: \"Crop\",\n  label: \"Exposure Category\"\n})\n\n\n\n\n\n\n\ncommodities = new Object({\n  Crop: [\n    \"wheat\",\n    \"rice\",\n    \"maize\",\n    \"barley\",\n    \"pearl millet\",\n    \"small millet\",\n    \"sorghum\",\n    \"potato\",\n    \"sweet potato\",\n    \"yams\",\n    \"cassava\",\n    \"bean\",\n    \"chickpea\",\n    \"cowpea\",\n    \"pigeonpea\",\n    \"lentil\",\n    \"soybean\",\n    \"groundnut\",\n    \"coconut\",\n    \"oilpalm\",\n    \"sunflower\",\n    \"rapeseed\",\n    \"sesameseed\",\n    \"sugarcane\",\n    \"sugarbeet\",\n    \"cotton\",\n    \"arabica coffee\",\n    \"robusta coffee\",\n    \"cocoa\",\n    \"tea\",\n    \"tobacco\",\n    \"banana\",\n    \"plantain\",\n  ],\n  Livestock: [\n    \"cattle_tropical\",\n    \"poultry_tropical\",\n    \"pigs_tropical\",\n    \"sheep_tropical\",\n    \"goats_tropical\",\n    \"cattle_highland\",\n    \"poultry_highland\",\n    \"pigs_highland\",\n    \"sheep_highland\",\n    \"goats_highland\",\n  ],\n});\n\n\n\n\n\n\n\nviewof exposure_subCat = {\n  let title;\n  let selections;\n  if (exposure_cat === \"Population\") {\n    title = \"Population Group\";\n    selections = new Map([\n      [\"Total Population\", \"total_pop\"],\n      [\"Rural Population\", \"rural_pop\"],\n      [\"Urban Population\", \"urban_pop\"]\n    ]);\n  } else {\n    title = \"Commodity\";\n    selections = commodities[exposure_cat];\n  }\n\n  return Inputs.select(selections, {\n    label: title\n  });\n}\n\n\n\n\n\n\n\nexposure_var_choices = {\n  let choices;\n  if (exposure_cat === \"Population\") {\n    choices = [\n      \"total_pop\",\n      \"rural_pop\",\n      \"urban_pop\"\n      // { name: \"Total Population\", variable: \"total_pop\" },\n      // { name: \"Rural Population\", variable: \"rural_pop\" },\n      // { name: \"Urban Population\", variable: \"urban_pop\" }\n    ]; //add density to raster\n  } else if (exposure_cat === \"Crop\") {\n    choices = [\n      'vop',\n      'ha'\n      // { name: \"Value of Production\", variable: \"vop\" },\n      // { name: \"Harvested Area\", variable: \"ha\" }\n    ];\n  } else {\n    choices = [\n      'vop',\n      'number'\n      // { name: \"Value of Production\", variable: \"vop\" },\n      // { name: \"Number of Animals\", variable: \"number\" }\n    ];\n  }\n  return choices;\n}\n\n\n\n\n\n\n\nviewof exposure_var = {\n  return Inputs.select(exposure_var_choices, {\n    label: \"Variable\",\n    format: (t) =&gt; _lang(nbText.ViewExplore.selectors.visualiseVars.exposure.exposureVariable.options[t])\n  });\n}\n\n\n\n\n\n\n\nmd`## Map Setup`;\n\n\n\n\n\n\n\nmd`### D3 map`;\n\n\n\n\n\n\n\nmap = () =&gt; {\n  const width = 950;\n  const height = 600;\n\n  let minValue;\n  let maxValue;\n\n  if (var_unit[\"category\"] === \"index\") {\n    minValue = 0;\n    maxValue = 1;\n  } else {\n    minValue = d3.min(adminLevel_spatial.features, (d) =&gt; d.properties.value);\n    maxValue = d3.max(adminLevel_spatial.features, (d) =&gt; d.properties.value);\n  }\n\n  d3.selectAll(\".mapTip\").remove();\n  const tooltip = d3\n    .select(\"body\")\n    .append(\"div\")\n    .attr(\"class\", \"plotTooltip mapTip\")\n    .style(\"position\", \"absolute\");\n\n  let color;\n  if (atlas_cat === \"Hazard\") {\n    color = d3.scaleThreshold(\n      hazard_dict[hazard_sel][\"thresholds\"],\n      hazard_dict[hazard_sel][\"colours\"],\n    );\n  } else if (\n    atlas_cat === \"Exposure\" &&\n    (exposure_cat === \"Crop\" || exposure_cat === \"Livestock\")\n  ) {\n    color = function (v) {\n      let nonZero_min = (minValue = d3.min(adminLevel_spatial.features, (d) =&gt;\n        d.properties.value && d.properties.value !== 0\n          ? d.properties.value\n          : Infinity,\n      ));\n      let d3color = d3\n        .scaleLog()\n        .domain([nonZero_min, maxValue])\n        .range([\"#F7D732\", \"#216729\"]);\n      return v === 0 ? \"lightgrey\" : d3color(v);\n    };\n  } else {\n    // Add a ability to flip color\n    let color_hex =\n      atlas_cat === \"Vulnerability\" && ac_cat === \"Poverty\"\n        ? [\"#216729\", \"#F7D732\"]\n        : [\"#F7D732\", \"#216729\"];\n    color = d3.scaleLinear().domain([minValue, maxValue]).range(color_hex);\n  }\n\n  const projection = d3\n    .geoAzimuthalEqualArea()\n    .fitSize([width, 600], adminLevel_spatial);\n\n  const path = d3.geoPath(projection);\n\n  const padding = 75;\n\n  const svg = d3\n    .create(\"svg\")\n    .attr(\"width\", width + 50)\n    .attr(\"viewBox\", [0, -padding, width, 600 + padding])\n    .style(\"background\", \"lightblue\") // set the background color\n    .style(\"cursor\", \"grab\");\n  // .style(\"border\", \"1px solid black\");\n\n  const map = svg\n    .append(\"g\")\n    .selectAll(\"path\")\n    .data(adminLevel_spatial.features)\n    .join(\"path\")\n    .attr(\"fill\", (d) =&gt; color(d.properties.value))\n    .attr(\"stroke\", \"#fff\")\n    .attr(\"stroke-width\", \"1\")\n    .attr(\"stroke-linejoin\", \"round\")\n    .attr(\"d\", path);\n\n  map\n    .on(\"mouseover\", (event, d) =&gt; {\n      d3.select(event.currentTarget).style(\"stroke\", \"black\").raise();\n    })\n    .on(\"mousemove\", (event, d) =&gt; {\n      tooltip\n        .style(\"top\", event.pageY - 10 + \"px\")\n        .style(\"left\", event.pageX + 10 + \"px\")\n        .style(\"opacity\", 1)\n        .style(\"display\", \"block\")\n        .html(\n          `${make_tooltip_admin(d.properties)}&lt;br&gt;${_lang(nbText.ViewExplore.exploreMap.value)}: ${format_val(\n            d.properties.value,\n            var_unit[\"category\"],\n          )} (${var_unit.label})`,\n        );\n    })\n    .on(\"mouseout\", function (event) {\n      d3.select(\".mapTip\").style(\"display\", \"none\");\n      d3.select(event.currentTarget).style(\"stroke\", \"#fff\");\n    });\n\n  // Section to add highlights for selected country when admin at limit\n  let selectedArea;\n  if (admin_aggregationLevel === \"admin0_name\" && country !== \"SSA\") {\n    selectedArea = adminLevel_spatial.features.filter(\n      (d) =&gt; d.properties.admin0_name === country,\n    );\n  } else if (\n    admin_aggregationLevel === \"admin1_name\" &&\n    admin1_sel !== \"Full Country\"\n  ) {\n    selectedArea = adminLevel_spatial.features.filter(\n      (d) =&gt; d.properties.admin1_name === admin1_sel,\n    );\n  } else if (admin2_sel !== \"Full Region\") {\n    selectedArea = adminLevel_spatial.features.filter(\n      (d) =&gt; d.properties.admin2_name === admin2_sel,\n    );\n  }\n  let outline;\n  if (selectedArea) {\n    outline = svg\n      .append(\"path\")\n      .data(selectedArea)\n      .attr(\"fill\", \"none\")\n      .attr(\"stroke\", \"red\")\n      .attr(\"stroke-width\", \"2\")\n      .attr(\"stroke-linejoin\", \"round\")\n      .attr(\"d\", path);\n  }\n\n  let legend_bg = svg // add a white bg box for the legend so it doesn't overlap on zoom\n    .append(\"g\")\n    .append(\"rect\")\n    .attr(\"width\", width)\n    .attr(\"height\", 70)\n    .attr(\"y\", -75)\n    .attr(\"fill\", \"white\")\n    .attr(\"opacity\", 0.9);\n\n  // createLinearLegend(svg, minValue, maxValue, width, height, color);\n  if (atlas_cat === \"Hazard\") {\n    createThresholdLegend(\n      svg,\n      hazard_dict[hazard_sel][\"thresholds\"],\n      hazard_dict[hazard_sel][\"colours\"],\n      height,\n      format_val,\n    );\n  } else {\n    createLinearLegend(svg, minValue, maxValue, width, height, color);\n  }\n\n  svg.call(\n    d3\n      .zoom()\n      .extent([\n        [0, 0],\n        [width, height],\n      ])\n      .scaleExtent([1, 8])\n      .on(\"zoom\", zoomed),\n  );\n\n  const resetButton = svg\n    .append(\"foreignObject\")\n    .attr(\"width\", 150)\n    .attr(\"height\", 50)\n    .attr(\"x\", 750)\n    .attr(\"y\", -65)\n    .html(\n      `&lt;button id=reset_button style=\"color: black;\"&gt;${_lang(nbText.ViewExplore.exploreMap.resetBtn)}&lt;/button&gt;`,\n    );\n\n  resetButton.select(\"button\").on(\"click\", () =&gt; {\n    svg\n      .transition()\n      .duration(750)\n      .call(\n        d3\n          .zoom()\n          .extent([\n            [0, 0],\n            [width, height],\n          ])\n          .scaleExtent([1, 8])\n          .on(\"zoom\", zoomed).transform,\n        d3.zoomIdentity,\n      );\n  });\n\n  return svg.node();\n\n  function zoomed({ transform }) {\n    map.attr(\"transform\", transform);\n    map.style(\"stroke-width\", 1 / transform.k);\n    if (outline) {\n      outline.attr(\"transform\", transform);\n      outline.style(\"stroke-width\", 1 / transform.k);\n    }\n  }\n\n  function make_tooltip_admin(d) {\n    let admin_text;\n    if (d.admin1_name === undefined) {\n      admin_text = `${_lang(nbText.general.adminlevels.admin0_name)}: ${_lang(nbText.general.adminNames[d.admin0_name])}`;\n    } else if (d.admin1_name !== undefined && d.admin2_name === undefined) {\n      admin_text = `${_lang(nbText.general.adminlevels.admin0_name)}: ${d.admin0_name}&lt;br&gt;${_lang(nbText.general.adminlevels.admin1_name)}: ${d.admin1_name}`;\n    } else if (d.admin1_name !== undefined && d.admin2_name !== undefined) {\n      admin_text = `${_lang(nbText.general.adminlevels.admin0_name)}: ${d.admin0_name}&lt;br&gt;${_lang(nbText.general.adminlevels.admin1_name)}: ${d.admin1_name}&lt;br&gt;${_lang(nbText.general.adminlevels.admin2_name)}: ${d.admin2_name}`;\n    }\n    return admin_text;\n  }\n\n  function createLinearLegend(svg, minValue, maxValue, width, height, color) {\n    const padding = 65;\n    const defs = svg.append(\"defs\");\n    const linearGradient = defs\n      .append(\"linearGradient\")\n      .attr(\"id\", \"linear-gradient\");\n\n    linearGradient\n      .selectAll(\"stop\")\n      .data([minValue, maxValue])\n      .join(\"stop\")\n      .attr(\"offset\", (d, i, n) =&gt; `${(100 * i) / (n.length - 1)}%`)\n      .attr(\"stop-color\", color);\n\n    const legend = svg\n      .append(\"g\")\n      .attr(\n        \"transform\",\n        `translate(${width - 700}, ${height - padding - 575})`,\n      );\n\n    legend\n      .append(\"rect\")\n      .attr(\"transform\", \"translate(0, -10)\")\n      .attr(\"width\", 250)\n      .attr(\"height\", 10)\n      .style(\"fill\", \"url(#linear-gradient)\");\n\n    const midValue = (minValue + maxValue) / 2;\n\n    legend\n      .append(\"g\")\n      .call(\n        d3\n          .axisBottom(\n            d3.scaleLinear().range([0, 250]).domain([minValue, maxValue]),\n          )\n          .tickValues([minValue, midValue, maxValue])\n          .tickFormat(\n            (v) =&gt;\n              `${format_val(v, var_unit[\"category\"])} ${var_unit.label === \"%\" ? \"\" : var_unit.label}`,\n          ),\n      )\n      .select(\".domain\");\n  }\n\n  function createThresholdLegend(svg, thresholds, colors, height, format_val) {\n    const padding = 65;\n    const legendWidth = 230;\n    const bandWidth = legendWidth / (thresholds.length - 1);\n    const legend = svg\n      .append(\"g\")\n      .attr(\n        \"transform\",\n        `translate(${width - 700}, ${height - padding - 575})`,\n      );\n\n    // Append color bands to legend\n    const labels = [\"low\", \"moderate\", \"severe\", \"extreme\", \"Vextreme\"];\n\n    colors.forEach((threshold, index) =&gt; {\n      legend\n        .append(\"rect\")\n        .attr(\"x\", index * bandWidth)\n        // .attr(\"y\", -10)\n        .attr(\"width\", bandWidth)\n        .attr(\"height\", 10)\n        .style(\"fill\", colors[index]);\n      // Add label\n      legend\n        .append(\"text\")\n        .attr(\"x\", index * bandWidth + bandWidth / 2)\n        .attr(\"y\", -15) // Adjust this value as needed for label positioning\n        .style(\"text-anchor\", \"middle\")\n        .text(_lang(nbText.general.levels[labels[index]]))\n        .attr(\"font-size\", \"12px\")\n        .attr(\"fill\", \"black\"); // Set the color of the label text\n    });\n  }\n};\n\n\n\n\n\n\n\nmd`## Definition boxes`;\n\n\n\n\n\n\n\ncreate_definitions = (category) =&gt; {\n  let def_text = _lang(definitionText[category].text);\n  return html`&lt;details style=\"padding: 0, 0 ;border-radius:5px;background:none;max-width:600px\"&gt;\n  &lt;summary style=\"cursor:pointer\"&gt;${_lang(definitionText[category].title)}&lt;/summary&gt;\n  &lt;div style=\"margin:.5em 0;border-top:1px dashed #888\"&gt;\n${md`${def_text}`}\n&lt;div&gt;&lt;/details&gt;`;\n};\n\n\n\n\n\n\n\nmd`## Plot Functions`;\n\n\n\n\n\n\n\nfunction createPlot() {\n  if (atlas_cat === \"Exposure\") {\n    if (exposure_cat.includes(\"Livestock\") || exposure_cat.includes(\"Crop\")) {\n      return exposure_treeplot();\n    } else if (exposure_cat === \"Population\") {\n      return population_stackbars();\n    }\n  } else if (atlas_cat === \"Hazard\") {\n    return hazard_stackBar(hazard_sel);\n  } else if (atlas_cat === \"Vulnerability\") {\n    return parallelCoordinatesScatterPlot();\n  }\n}\n\n\n\n\n\n\n\ncreateTable = () =&gt; {\n  let table = Inputs.table(data_to_visualise, {\n    rows: 25,\n    maxWidth: \"1000px\",\n  });\n  const style = document.createElement(\"style\");\n  style.innerHTML = `\n    .exploreTable th {\n      background-color: lightgrey !important;\n    }\n    .exploreTable tr:nth-child(odd) {\n      background: #f2f2f2!important;\n    }\n    .exploreTable td {\n      padding-left: 15px !important;\n    }\n  `;\n  table.classList.add(\"exploreTable\");\n  table.appendChild(style);\n\n  const checkboxes = table.querySelectorAll('table input[type=\"checkbox\"]');\n\n  // Remove all checkboxes\n  checkboxes.forEach(function (checkbox) {\n    checkbox.parentNode.removeChild(checkbox);\n  });\n\n  return table;\n};\n\n\n\n\n\n\n\nexposure_treeplot = async () =&gt; {\n  let admin_query;\n  if (country === \"SSA\") {\n    admin_query = `\"admin1_name\" IS NULL`;\n  } else if (country !== \"SSA\" && admin1_sel === \"Full Country\") {\n    admin_query = `\"admin0_name\" LIKE '${country}' AND \"admin1_name\" IS NOT NULL AND \"admin2_name\" IS NULL`;\n  } else if (country !== \"SSA\" && admin1_sel !== \"Full Country\") {\n    admin_query = `\"admin0_name\" LIKE '${country}' AND \"admin1_name\" LIKE '${admin1_sel}' AND \"admin1_name\" IS NOT NULL AND \"admin2_name\" IS NOT NULL`;\n  }\n  let formatTree = exposure_var === \"number\" ? formatBigNums : formatDollar;\n\n  let translateCrop = (d) =&gt; {\n    return (\n      _lang(nbText.ViewExplore.exposureTreemap.cropGroups[d]) ||\n      _lang(nbText.general.commodities[d]) ||\n      d\n    );\n  };\n\n  const data_unformatted = await db.query(`\nSELECT crop, SUM(value) as VOP, FROM Exposure\n${plotQuery_admin}\nAND \"exposure\" = '${exposure_var}'\nAND \"crop\" NOT IN ('total_highland', 'total_tropical')\nand \"group\" = '${exposure_cat.toLocaleLowerCase()}'\nGROUP BY crop`);\n\n  d3.selectAll(\".plotTooltip\").remove();\n  const tooltip = d3\n    .select(\"body\")\n    .append(\"div\")\n    .attr(\"class\", \"plotTooltip TreeTip\")\n    .style(\"position\", \"absolute\");\n\n  const data = new Object({\n    name: \"total\",\n    children: Object.entries(crop_groups).map(([groupName, crops]) =&gt; ({\n      name: groupName,\n      children: crops.map((cropName) =&gt; {\n        const cropData = data_unformatted.find((d) =&gt; d.crop === cropName);\n        return { name: cropName, value: cropData ? cropData.VOP : 0 };\n      }),\n    })),\n  });\n\n  const width = 1000;\n  const height = 600;\n\n  // This custom tiling function adapts the built-in binary tiling function\n  // for the appropriate aspect ratio when the treemap is zoomed-in.\n  function tile(node, x0, y0, x1, y1) {\n    d3.treemapBinary(node, 0, 0, width, height);\n    for (const child of node.children) {\n      child.x0 = x0 + (child.x0 / width) * (x1 - x0);\n      child.x1 = x0 + (child.x1 / width) * (x1 - x0);\n      child.y0 = y0 + (child.y0 / height) * (y1 - y0);\n      child.y1 = y0 + (child.y1 / height) * (y1 - y0);\n    }\n  }\n\n  // Compute the layout.\n  const hierarchy = d3\n    .hierarchy(data)\n    .sum((d) =&gt; d.value)\n    .sort((a, b) =&gt; b.value - a.value);\n  const root = d3.treemap().tile(tile)(hierarchy);\n\n  const smallest_crop = d3.min(data_unformatted, (d) =&gt; d.VOP);\n  const largest_group = d3.max(hierarchy.children.map((d) =&gt; d.value));\n\n  const colorScale = d3\n    .scaleLinear()\n    .domain([smallest_crop, largest_group])\n    .range([\"#F7D732\", \"#71913D\"]);\n\n  // Create the scales.\n  const x = d3.scaleLinear().rangeRound([0, width]);\n  const y = d3.scaleLinear().rangeRound([0, height]);\n\n  // Formatting utilities.\n  const format = d3.format(\",d\");\n  const name = (d) =&gt; d.data.name;\n\n  // Create the SVG container.\n  const svg = d3\n    // .select(container)\n    .create(\"svg\")\n    // .append(\"svg\")\n    .attr(\"viewBox\", [0.5, -50.5, width, height + 50])\n    .attr(\"width\", width)\n    .attr(\"height\", height + 50)\n    .attr(\"style\", \"max-width: 100%; height: auto;\");\n\n  // Display the root.\n  let group = svg.append(\"g\").call(render, root);\n\n  function render(group, root) {\n    const node = group\n      .selectAll(\"g\")\n      .data(root.children.concat(root))\n      .join(\"g\");\n\n    node\n      .filter((d) =&gt; (d === root ? d.parent : d.children))\n      .attr(\"cursor\", \"pointer\")\n      .on(\"click\", (event, d) =&gt; (d === root ? zoomout(root) : zoomin(d)));\n\n    // node.append(\"title\").text((d) =&gt; `${name(d)}\\n${formatTree(d.value)}`);\n    node\n      .on(\"mousemove\", (event, d) =&gt; {\n        let tipData = d.data;\n        tooltip\n          .style(\"top\", event.pageY - 10 + \"px\")\n          .style(\"left\", event.pageX + 10 + \"px\")\n          // .transition()\n          // .duration(200)\n          .style(\"opacity\", 1)\n          .style(\"display\", \"block\")\n          .html(`${translateCrop(name(d))} - ${formatTree(d.value)}`);\n      })\n      .on(\"mouseout\", function (event) {\n        d3.select(\".plotTooltip\")\n          // .transition()\n          // .duration(200)\n          // .style(\"opacity\", 0)\n          .style(\"display\", \"none\");\n      });\n\n    const rects = node\n      .append(\"rect\")\n      .attr(\"id\", (d) =&gt; (d.leafUid = DOM.uid(\"leaf\")).id)\n      .attr(\"fill\", (d) =&gt;\n        d === root\n          ? \"#e6e6e6\"\n          : d.children\n            ? colorScale(d.value)\n            : colorScale(d.value),\n      )\n      .attr(\"stroke\", \"#e6e6e6\");\n\n    node\n      .append(\"clipPath\")\n      .attr(\"id\", (d) =&gt; (d.clipUid = DOM.uid(\"clip\")).id)\n      .append(\"use\")\n      .attr(\"xlink:href\", (d) =&gt; d.leafUid.href);\n\n    let text = node\n      .append(\"text\")\n      .attr(\"clip-path\", (d) =&gt; d.clipUid)\n      // .attr(\"font-weight\", (d) =&gt; (d === root ? \"bold\" : null))\n      .attr(\"font-size\", (d) =&gt;\n        d === root ? \"20px\" : d.children ? \"15px\" : \"14px\",\n      )\n      .selectAll(\"tspan\")\n      .data((d) =&gt;\n        (d === root\n          ? (\n              translateCrop(name(d)) +\n              \" \" +\n              _lang(\n                nbText.ViewExplore.selectors.visualiseVars.exposure\n                  .exposureVariable.options[exposure_var],\n              ) +\n              \":\"\n            ).split(/(?=[A-Z][&][^A-Z])/g)\n          : // : d.data.name.split(/(?=[A-Z][^A-Z])/g)\n            translateCrop(name(d)).split(/(?=[A-Z][^A-Z])/g)\n        ) //.concat(d.value)\n          .concat(formatTree(d.value)),\n      )\n      .join(\"tspan\")\n      .attr(\"x\", 3)\n      .attr(\n        \"y\",\n        (d, i, nodes) =&gt; `${(i === nodes.length - 1) * 0.3 + 1.1 + i * 0.9}em`,\n      )\n      .attr(\"fill-opacity\", (d, i, nodes) =&gt;\n        i === nodes.length - 1 ? 0.7 : null,\n      )\n      .attr(\"font-weight\", (d, i, nodes) =&gt;\n        i === nodes.length - 1 ? \"normal\" : null,\n      )\n      .text((d) =&gt; d);\n\n    group.call(position, root);\n  }\n\n  function position(group, root) {\n    group\n      .selectAll(\"g\")\n      .attr(\"transform\", (d) =&gt;\n        d === root ? `translate(0,-55)` : `translate(${x(d.x0)},${y(d.y0)})`,\n      )\n      .selectAll(\"rect\")\n      .attr(\"width\", (d) =&gt; (d === root ? width : x(d.x1) - x(d.x0)))\n      .attr(\"height\", (d) =&gt; (d === root ? 55 : y(d.y1) - y(d.y0)));\n\n    group.selectAll(\"text\").attr(\"opacity\", (d) =&gt; {\n      const rect_width = x(d.x1) - x(d.x0);\n      const rect_height = y(d.y1) - y(d.y0);\n      return rect_height &lt; 70 || rect_width &lt; 70 ? 0 : 1;\n    });\n  }\n\n  // When zooming in, draw the new nodes on top, and fade them in.\n  function zoomin(d) {\n    const group0 = group.attr(\"pointer-events\", \"none\");\n    const group1 = (group = svg.append(\"g\").call(render, d));\n\n    x.domain([d.x0, d.x1]);\n    y.domain([d.y0, d.y1]);\n\n    svg\n      .transition()\n      .duration(750)\n      .call((t) =&gt; group0.transition(t).remove().call(position, d.parent))\n      .call((t) =&gt;\n        group1\n          .transition(t)\n          .attrTween(\"opacity\", () =&gt; d3.interpolate(0, 1))\n          .call(position, d),\n      );\n  }\n\n  // When zooming out, draw the old nodes on top, and fade them out.\n  function zoomout(d) {\n    const group0 = group.attr(\"pointer-events\", \"none\");\n    const group1 = (group = svg.insert(\"g\", \"*\").call(render, d.parent));\n\n    x.domain([d.parent.x0, d.parent.x1]);\n    y.domain([d.parent.y0, d.parent.y1]);\n\n    svg\n      .transition()\n      .duration(750)\n      .call((t) =&gt;\n        group0\n          .transition(t)\n          .remove()\n          .attrTween(\"opacity\", () =&gt; d3.interpolate(1, 0))\n          .call(position, d),\n      )\n      .call((t) =&gt; group1.transition(t).call(position, d.parent));\n  }\n\n  return svg.node();\n};\n\n\n\n\n\n\n\nhazard_stackBar = async (hazard) =&gt; {\n  // const data = bar_data[hazard];\n  const data = classifyAndCount(\n    await db.query(\n      `SELECT * From Hazard ${mapDataQuery_admin} and \"hazard\" = '${hazard}' and \"timeframe\" in ('${DataSelector_form.hazardGroup_form.timeperiod_sel.join(\n        \"', '\",\n      )}')`,\n    ),\n  )[hazard];\n  const colors = hazard_dict[hazard].colours;\n\n  const labels = [\"low\", \"moderate\", \"severe\", \"extreme\", \"Vextreme\"].slice(\n    0,\n    colors.length,\n  );\n\n  const transformedData = [];\n  for (const scenario in data) {\n    for (const period in data[scenario]) {\n      transformedData.push({\n        scenario,\n        period,\n        values: data[scenario][period],\n      });\n    }\n  }\n\n  const width = 750;\n  const height = 600;\n  const margin = { top: 30, right: 10, bottom: 15, left: 40 };\n\n  // SVG Container\n  const svg = d3\n    .create(\"svg\")\n    .attr(\"viewBox\", [0, 0, width, height])\n    .attr(\"width\", width)\n    .attr(\"height\", height);\n\n  d3.selectAll(\".plotTooltip\").remove();\n  const tooltip = d3\n    .select(\"body\")\n    .append(\"div\")\n    .attr(\"class\", \"plotTooltip barTip\")\n    .style(\"position\", \"absolute\");\n\n  // Set up x and y scales\n  const sortOrder = [\n    \"historic_historic\",\n    \"ssp245_2021_2040\",\n    \"ssp585_2021_2040\",\n    \"ssp245_2041_2060\",\n    \"ssp585_2041_2060\",\n  ];\n  const x = d3\n    .scaleBand()\n    // .domain(transformedData.map((d) =&gt; `${d.scenario}_${d.period}`))\n    .domain(\n      sortOrder.filter((d) =&gt;\n        transformedData.some((e) =&gt; e.scenario + \"_\" + e.period === d),\n      ),\n    )\n    .range([margin.left, width])\n    .padding(0.1);\n\n  const y = d3\n    .scaleLinear()\n    .domain([0, d3.max(transformedData, (d) =&gt; d3.sum(d.values))])\n    .nice()\n    .range([height - margin.bottom, margin.top]);\n\n  // Add x and y axes\n  svg\n    .append(\"g\")\n    .attr(\"class\", \"x-axis\")\n    .attr(\"transform\", `translate(0,${height - margin.bottom})`)\n    .call(\n      d3\n        .axisBottom(x)\n        .tickSize(0)\n        .tickFormat((d) =&gt; {\n          return d === \"historic_historic\"\n            ? _lang(\n                nbText.selectVars.forms.Hazard.selectors.period.options\n                  .historic,\n              )\n            : `${d.split(\"_\")[2]} (${d.split(\"_\")[0].toUpperCase()})`;\n        }),\n    );\n\n  svg\n    .append(\"g\")\n    .attr(\"class\", \"y-axis\")\n    .attr(\"transform\", `translate(${margin.left},0)`)\n    .call(d3.axisLeft(y).tickSize(0))\n    .selectAll(\".tick text\") // select the text elements of the ticks\n    .attr(\"dy\", \"0.5em\")\n    .style(\"text-anchor\", \"end\");\n\n  // Create stacks\n  const stack = d3\n    .stack()\n    .keys(d3.range(transformedData[0].values.length))\n    .value((d, key) =&gt; d.values[key]);\n\n  const series = stack(transformedData);\n\n  // Add bars\n  const bars = svg\n    .append(\"g\")\n    .selectAll(\"g\")\n    .data(series)\n    .join(\"g\")\n    .attr(\"fill\", (d, i) =&gt; colors[i])\n    .selectAll(\"rect\")\n    // .data((d) =&gt; d)\n    .data((d) =&gt; d.map((value) =&gt; ({ ...value, index: d.index })))\n    .join(\"rect\")\n    .attr(\"x\", (d) =&gt; x(`${d.data.scenario}_${d.data.period}`))\n    .attr(\"y\", (d) =&gt; y(d[1]))\n    .attr(\"height\", (d) =&gt; y(d[0]) - y(d[1]))\n    .attr(\"width\", x.bandwidth());\n\n  bars\n    .on(\"mouseover\", (event, d) =&gt; {\n      d3.select(event.currentTarget).style(\"stroke\", \"black\").raise();\n    })\n    .on(\"mousemove\", (event, d) =&gt; {\n      tooltip\n        .style(\"top\", event.pageY - 10 + \"px\")\n        .style(\"left\", event.pageX + 10 + \"px\")\n        .style(\"opacity\", 1)\n        .style(\"display\", \"block\")\n        .html(\n          `&lt;b&gt;${_lang(nbText.general.hazards[hazard])}&lt;/b&gt; &lt;br&gt; ${_lang(nbText.ViewExplore.hazardBars.lvl)}: ${_lang(\n            nbText.general.levels[labels[d.index]],\n          )} &lt;br&gt; ${_lang(nbText.ViewExplore.hazardBars.numAreas)}: ${d.data.values[d.index]}`,\n        );\n    })\n    .on(\"mouseout\", function (event) {\n      d3.select(\".plotTooltip\").style(\"display\", \"none\");\n      d3.select(event.currentTarget).style(\"stroke\", \"none\");\n    });\n  // Add y axis title\n  svg\n    .append(\"text\")\n    .attr(\"transform\", \"rotate(-90)\")\n    .attr(\"y\", 0)\n    .attr(\"x\", 0 - height / 2)\n    .attr(\"dy\", \"1em\")\n    .style(\"fontSize\", \"12px\")\n    .style(\"text-anchor\", \"middle\")\n    .text(_lang(nbText.ViewExplore.hazardBars.yaxis));\n\n  // append legend\n  const Legendpadding = 65;\n  const legendWidth = 200;\n  const bandWidth = legendWidth / (hazard_dict[hazard].thresholds.length - 1);\n  const legend = svg\n    .append(\"g\")\n    .attr(\"transform\", `translate(${margin.left + 11}, ${margin.top - 5})`);\n\n  colors.forEach((threshold, index) =&gt; {\n    legend\n      .append(\"rect\")\n      .attr(\"x\", index * bandWidth)\n      .attr(\"y\", -10)\n      .attr(\"width\", bandWidth)\n      .attr(\"height\", 10)\n      .style(\"fill\", colors[index]);\n    // Add label\n    legend\n      .append(\"text\")\n      .attr(\"x\", index * bandWidth + bandWidth / 2)\n      .attr(\"y\", -15) // Adjust this value as needed for label positioning\n      .style(\"text-anchor\", \"middle\")\n      .text(_lang(nbText.general.levels[labels[index]]))\n      .attr(\"font-size\", \"12px\")\n      .attr(\"fill\", \"black\"); // Set the color of the label text\n  });\n\n  return svg.node();\n};\n\n\n\n\n\n\n\nfunction classifyAndCount(data) {\n  const result = {};\n\n  // Helper function to classify a number based on thresholds\n  function classifyNumber(number, thresholds) {\n    for (let i = 0; i &lt; thresholds.length; i++) {\n      if (number &lt; thresholds[i]) {\n        return i;\n      }\n    }\n    return thresholds.length;\n  }\n\n  data.forEach((row) =&gt; {\n    const { admin0_name, scenario, timeframe, hazard, value } = row;\n    const thresholds = hazard_dict[hazard].thresholds;\n    if (!thresholds) {\n      console.error(`No thresholds found for hazard: ${hazard}`);\n      return;\n    }\n    const classification = classifyNumber(value, thresholds);\n\n    if (!result[hazard]) {\n      result[hazard] = {};\n    }\n    if (!result[hazard][scenario]) {\n      result[hazard][scenario] = {};\n    }\n    if (!result[hazard][scenario][timeframe]) {\n      result[hazard][scenario][timeframe] = Array(thresholds.length + 1).fill(\n        0,\n      );\n    }\n\n    result[hazard][scenario][timeframe][classification]++;\n  });\n\n  return result;\n}\n\n\n\n\n\n\n\npopulation_stackbars = async () =&gt; {\n  const width = 750;\n  const height = 560;\n  const margin = { top: 0, right: 10, bottom: 0, left: 120 };\n  const barHeight = 30; // Height of each bar\n  // Calculate the total height needed for all bars\n\n  const data = await db.query(`\n    SELECT admin0_name, admin1_name, admin2_name, rural_pop, urban_pop, total_pop \n    FROM exposurePopulation \n    ${plotQuery_admin}`);\n\n  data.sort((a, b) =&gt; b.total_pop - a.total_pop);\n\n  const totalHeight = data.length * barHeight;\n  // SVG Container\n  const svg = d3\n    .create(\"svg\")\n    .attr(\"viewBox\", [0, 0, width + margin.left + margin.right, totalHeight])\n    .attr(\"width\", width + margin.left + margin.right)\n    .attr(\"height\", totalHeight + margin.top + margin.bottom);\n\n  d3.selectAll(\".plotTooltip\").remove();\n  const tooltip = d3\n    .select(\"body\")\n    .append(\"div\")\n    .attr(\"class\", \"plotTooltip barTip\")\n    .style(\"position\", \"absolute\");\n  const keys = [\"rural_pop\", \"urban_pop\"];\n  const stackedData = d3\n    .stack()\n    .keys(keys)\n    .value((d, key) =&gt; d[key])(data);\n\n  // Set up scales\n  const x = d3\n    .scaleLinear()\n    .domain([0, d3.max(data, (d) =&gt; d.total_pop)])\n    .nice()\n    .range([margin.left, width - margin.right]);\n\n  const y = d3\n    .scaleBand()\n    .domain(data.map((d) =&gt; d[admin_aggregationLevel]))\n    .range([margin.top, totalHeight])\n    .padding(0.1);\n\n  const color = d3.scaleOrdinal().domain(keys).range([\"#216729\", \"#F7D732\"]);\n\n  // Draw the bars\n  const bars = svg\n    .append(\"g\")\n    .selectAll(\"g\")\n    .data(stackedData)\n    .join(\"g\")\n    .attr(\"fill\", (d) =&gt; color(d.key))\n    .selectAll(\"rect\")\n    .data((d) =&gt; d)\n    .join(\"rect\")\n    .attr(\"x\", (d) =&gt; x(d[0]))\n    .attr(\"y\", (d) =&gt; y(d.data[admin_aggregationLevel]))\n    .attr(\"height\", y.bandwidth())\n    .attr(\"width\", (d) =&gt; x(d[1]) - x(d[0]));\n\n  bars\n    .on(\"mouseover\", (event, d) =&gt; {\n      d3.select(event.currentTarget).style(\"stroke\", \"black\").raise();\n    })\n    .on(\"mousemove\", (event, d) =&gt; {\n      const key = event.target.parentNode.__data__.key;\n\n      tooltip\n        .style(\"top\", event.pageY - 10 + \"px\")\n        .style(\"left\", event.pageX + 10 + \"px\")\n        .style(\"opacity\", 1)\n        .style(\"display\", \"block\")\n        .html(\n          `${\n            d.data[admin_aggregationLevel]\n          } &lt;br&gt; ${_lang(nbText.ViewExplore.selectors.visualiseVars.exposure.exposureVariable.options[key])}: ${format_val(d[1] - d[0], \"total\")}`,\n        );\n    })\n    .on(\"mouseout\", function (event) {\n      d3.select(\".plotTooltip\").style(\"display\", \"none\");\n      d3.select(event.currentTarget).style(\"stroke\", \"none\");\n    });\n\n  // Add the Y axis\n  svg\n    .append(\"g\")\n    .attr(\"transform\", `translate(${margin.left}, 0)`)\n    .call(d3.axisLeft(y));\n\n  const legendSvg = d3\n    .create(\"svg\")\n    .attr(\"width\", width + 50)\n    .attr(\"height\", 75);\n\n  // Add legend to the new SVG\n  const legend = legendSvg\n    .append(\"g\")\n    .attr(\"class\", \"legend\")\n    .selectAll(\"g\")\n    .data(keys)\n    .join(\"g\")\n    .attr(\"transform\", (d, i) =&gt; `translate(10, ${i * 20})`);\n\n  legend\n    .append(\"rect\")\n    .attr(\"width\", 18)\n    .attr(\"height\", 18)\n    .attr(\"fill\", color);\n\n  legend\n    .append(\"text\")\n    .attr(\"x\", 24)\n    .attr(\"y\", 9)\n    .attr(\"dy\", \"0.35em\")\n    .text((d) =&gt;\n      _lang(\n        nbText.ViewExplore.selectors.visualiseVars.exposure.exposureVariable\n          .options[d],\n      ),\n    );\n  // .text((d) =&gt; (d === \"rural_pop\" ? \"Rural Population\" : \"Urban Population\"));\n\n  // Add the X axis\n  legendSvg\n    .append(\"g\")\n    .attr(\"transform\", `translate(0, 75)`)\n    .call(d3.axisTop(x).ticks(5));\n\n  const legendContainer = html`&lt;div style=\"width: 100%;\"&gt;${legendSvg.node()}&lt;/div&gt;`;\n  const scrollableContainer = html`&lt;div style=\"overflow-y: auto; width: 100%; height: ${\n    height + margin.top + margin.bottom\n  }px;padding=0px; margin=0px;\"&gt;${svg.node()}&lt;/div&gt;`;\n\n  const container = html`&lt;div&gt;${legendContainer}${scrollableContainer}&lt;/div&gt;`;\n  return container;\n};\n\n\n\n\n\n\n\nfunction format_slopeData(data) {\n  const order = [\"historic\", \"2021_2040\", \"2041_2060\"];\n\n  const admin_grouped = Array.from(\n    d3.group(data, (d) =&gt; d[\"hazard\"]),\n    ([admin_name, values]) =&gt; {\n      values.sort(\n        (a, b) =&gt; order.indexOf(a.timeframe) - order.indexOf(b.timeframe),\n      );\n      return {\n        admin_name,\n        values: values.map(({ timeframe, scenario, value, percentChange }) =&gt; ({\n          timeframe,\n          scenario,\n          value,\n          percentChange,\n        })),\n      };\n    },\n  );\n  return admin_grouped;\n}\n\n\n\n\n\n\n\ncalculatePercentChange = (data) =&gt; {\n  const baseline = {};\n\n  // Find historic baseline values\n  for (const row of data) {\n    if (row.scenario === \"historic\" && row.timeframe === \"historic\") {\n      baseline[row.hazard] = row.admin_mean;\n    }\n  }\n\n  const results = [];\n  for (const row of data) {\n    const hazard = row.hazard;\n    const scenario = row.scenario;\n    const timeframe = row.timeframe;\n    const value = row.admin_mean;\n    const baselineValue = baseline[hazard];\n\n    // Check if baseline value exists\n    if (baselineValue !== undefined && scenario !== \"historic\") {\n      const change = value - baselineValue;\n      const percentChange = (change / baselineValue) * 100;\n      results.push({ hazard, scenario, timeframe, value, percentChange });\n    } else {\n      results.push({ hazard, scenario, timeframe, value, percentChange: null });\n    }\n  }\n\n  return results;\n};\n\n\n\n\n\n\n\nfunction scaleHazardValue(value, minValue, maxValue) {\n  const thresholds = hazard_dict[\"HSH_max\"][\"thresholds\"];\n\n  // Calculate the range between the minimum and maximum values\n  const range = maxValue - minValue;\n\n  // Determine the scale based on thresholds\n  if (value &lt;= thresholds[0]) {\n    return 1;\n  } else if (value &lt;= thresholds[1]) {\n    return Math.ceil(\n      1 + ((value - thresholds[0]) / (thresholds[1] - thresholds[0])) * 2,\n    );\n  } else if (value &lt;= thresholds[2]) {\n    return Math.ceil(\n      4 + ((value - thresholds[1]) / (thresholds[2] - thresholds[1])) * 3,\n    );\n  } else if (value &lt;= thresholds[3]) {\n    return Math.ceil(\n      7 + ((value - thresholds[2]) / (thresholds[3] - thresholds[2])) * 3,\n    );\n  } else {\n    return 10;\n  }\n}\n\n\n\n\n\n\n\nparallelCoordinatesPlot = async () =&gt; {\n  const margin = { top: 30, right: 80, bottom: 25, left: 40 },\n    width = 1200 - margin.left - margin.right,\n    height = 600 - margin.top - margin.bottom;\n\n  let group_query;\n  if (\n    DataSelector_form.vulnerabilityGroup_form.vulnerability_sel.every(\n      (d) =&gt; d === \"Education\",\n    )\n  ) {\n    group_query = `AND \"group\" = 'education' OR \"variable\" = 'education'`;\n  } else {\n    group_query = `AND \"group\" in (${\n      \"'\" +\n      DataSelector_form.vulnerabilityGroup_form.vulnerability_sel\n        .join(\"', '\")\n        .toLowerCase() +\n      \"'\"\n    })`;\n  }\n\n  // let selected_country = \"\";\n  let data = await db.query(\n    `SELECT \"admin0_name\", \"admin1_name\", \"admin2_name\", \"group\", \"variable\", \"value\"\n     FROM Vulnerability \n     ${mapDataQuery_admin}\n     AND \"variable\" != 'GenderEquity_1995.2015'\n     ${group_query}`,\n  );\n  const data_vuln = pivotData(data);\n  let means = calculateMeans(data);\n  means.country = \"Regional Average\";\n\n  const color = d3\n    .scaleOrdinal()\n    .domain(data_vuln.map((d) =&gt; d.country))\n    .range(d3.schemeCategory10);\n\n  const svg = d3\n    .create(\"svg\")\n    .attr(\"id\", \"VulnerableParallelLine\")\n    .attr(\"viewBox\", [0, 0, width, height])\n    .attr(\"width\", width)\n    .attr(\"height\", height);\n\n  const dimensions = Object.keys(data_vuln[0]).filter((d) =&gt; d !== \"country\");\n  dimensions.sort();\n  const y = {};\n  for (const dim of dimensions) {\n    let y_extent =\n      dim === \"education-educationYrs\"\n        ? // ? d3.extent(data_vuln, (item) =&gt; item[dim])\n          [0, d3.max(data_vuln, (item) =&gt; item[dim])]\n        : [0, 1];\n    y[dim] = d3\n      .scaleLinear()\n      .domain(y_extent)\n      .range([height - margin.bottom, margin.top]);\n  }\n\n  const x = d3\n    .scalePoint()\n    .domain(dimensions)\n    .range([margin.left, width - margin.right]);\n\n  const line = d3\n    .line()\n    .defined((d) =&gt; !isNaN(d[1]))\n    .x((d) =&gt; x(d[0]))\n    .y((d) =&gt; y[d[0]](d[1]));\n\n  const tooltip = d3\n    .select(\"body\")\n    .append(\"div\")\n    .style(\"position\", \"absolute\")\n    .style(\"background-color\", \"white\")\n    .style(\"padding\", \"5px\")\n    .style(\"border\", \"1px solid black\")\n    .style(\"border-radius\", \"5px\")\n    .style(\"opacity\", 0);\n\n  let countrylines = svg\n    .selectAll(\".countryLines\")\n    .data(data_vuln)\n    .enter()\n    .append(\"path\")\n    .attr(\"class\", \"countryLines\")\n    .attr(\"d\", (d) =&gt; line(dimensions.map((p) =&gt; [p, d[p]])))\n    .style(\"fill\", \"none\")\n    .style(\n      \"stroke\",\n      \"lightgrey\", // (d.country === selected_country ? \"green\" : \"lightgrey\") //color(d.country)\n    )\n    .style(\"stroke-width\", 1.5)\n    .style(\"opacity\", 0.2) // (d) =&gt; (d.country === selected_country ? 0.9 : 0.2))\n    .on(\"mouseover\", function (event, d) {\n      // svg.selectAll(\".countryLines\").style(\"opacity\", 0.1);\n      d3.select(this).style(\"opacity\", 1).style(\"stroke\", \"#F29D2D\");\n      tooltip.transition().duration(0).style(\"opacity\", 0.9);\n      tooltip\n        .html(`${d.country}`)\n        .style(\"left\", event.pageX + 10 + \"px\")\n        .style(\"top\", event.pageY - 28 + \"px\");\n    })\n    .on(\"mouseout\", function (d) {\n      svg\n        .selectAll(\".countryLines\")\n        .style(\"opacity\", 0.2) // (d) =&gt; (d.country === selected_country ? 0.9 : 0.2));\n        .style(\"stroke\", \"lightgrey\");\n      tooltip.transition().duration(500).style(\"opacity\", 0);\n    });\n\n  let avg_lines = svg\n    .selectAll(\"avgPath\")\n    .data(means)\n    .enter()\n    .append(\"path\")\n    .attr(\"d\", (d) =&gt; line(dimensions.map((p) =&gt; [p, d[p]])))\n    .style(\"fill\", \"none\")\n    .style(\"stroke\", \"#2E7636\")\n    .style(\"stroke-width\", 1.5)\n    .style(\"opacity\", 1);\n\n  svg\n    .selectAll(\"myAxis\")\n    .data(dimensions)\n    .enter()\n    .append(\"g\")\n    .attr(\"transform\", (d) =&gt; \"translate(\" + x(d) + \")\")\n    .attr(\"pointer-events\", \"none\")\n    .each(function (d) {\n      d3.select(this).call(d3.axisLeft().scale(y[d]));\n    })\n    .append(\"text\")\n    .style(\"text-anchor\", \"middle\")\n    // .attr(\"y\", 10)\n    // .attr(\"x\", 0)\n    .attr(\"y\", (d, i) =&gt; {\n      return i % 2 === 0 ? 10 : height - margin.bottom + 20;\n    })\n    .text((d) =&gt; {\n      let split = d.split(\"-\");\n      console.log(d);\n      // let clean_text = vulnerability_dict[split[0]][split[1]];\n      let clean_text = _lang(nbText.general.acVars[split[1]]);\n      return clean_text;\n    })\n    .style(\"fill\", \"black\")\n    .style(\"font-size\", \"12px\");\n\n  svg\n    .selectAll(\"avgLabel\")\n    .data(means)\n    .enter()\n    .append(\"text\")\n    .attr(\"x\", width - margin.right) // Align it with the right margin\n    .attr(\"y\", (d) =&gt;\n      y[dimensions[dimensions.length - 1]](\n        d[dimensions[dimensions.length - 1]],\n      ),\n    )\n    .attr(\"dy\", \".35em\")\n    .attr(\"text-anchor\", \"start\")\n    .style(\"fill\", \"#2E7636\")\n    .selectAll(\"tspan\")\n    .data([country, \"Average\"])\n    .enter()\n    .append(\"tspan\")\n    .attr(\"x\", width - margin.right + 5) // Align both lines with the same x position\n    .attr(\"dy\", (d, i) =&gt; (i === 0 ? 0 : \"1.2em\")) // Offset the second line\n    .text((d) =&gt; d);\n\n  return svg.node();\n\n  function pivotData(data) {\n    const pivotedData = {};\n\n    data.forEach((row) =&gt; {\n      const country = row[admin_aggregationLevel];\n\n      if (!pivotedData[country]) {\n        pivotedData[country] = { country };\n      }\n      let combined_name = row.group + \"-\" + row.variable;\n      pivotedData[country][combined_name] = row.value;\n    });\n\n    return Object.values(pivotedData);\n  }\n\n  function calculateMeans(data) {\n    const groupedData = {};\n\n    // Group data by variable\n    data.forEach((row) =&gt; {\n      let combined_name = row.group + \"-\" + row.variable;\n      if (!groupedData[combined_name]) {\n        groupedData[combined_name] = [];\n      }\n      groupedData[combined_name].push(row.value);\n    });\n\n    // Calculate mean for each variable\n    const means = {};\n    for (const [variable, values] of Object.entries(groupedData)) {\n      const sum = values.reduce((acc, val) =&gt; acc + val, 0);\n      means[variable] = sum / values.length;\n    }\n\n    return [means];\n  }\n};\n\n\n\n\n\n\n\nparallelCoordinatesScatterPlot2 = async () =&gt; {\n  const margin = { top: 60, right: 80, bottom: 25, left: 40 },\n    width = 1200 - margin.left - margin.right,\n    height = 600 - margin.top - margin.bottom;\n\n  let group_query = `AND \"group\" in (${\n    \"'\" +\n    DataSelector_form.vulnerabilityGroup_form.vulnerability_sel\n      .join(\"', '\")\n      .toLowerCase() +\n    \"'\"\n  })`;\n\n  let data = await db.query(\n    `SELECT \"admin0_name\", \"admin1_name\", \"admin2_name\", \"group\", \"variable\", \"value\"\n     FROM Vulnerability \n     ${plotQuery2_admin}\n     AND \"variable\" != 'GenderEquity_1995.2015'\n     ${group_query}`,\n  );\n\n  const data_vuln = pivotData(data);\n  let means = calculateMeans(data);\n  means.country = \"Regional Average\";\n\n  const dimensions = Object.keys(data_vuln[0]).filter((d) =&gt; d !== \"country\");\n  const jitter = d3.randomUniform(-20, 20);\n\n  const color = d3\n    .scaleOrdinal()\n    .domain(data_vuln.map((d) =&gt; d.country))\n    .range(d3.schemeCategory10);\n\n  const svg = d3\n    .create(\"svg\")\n    .attr(\"id\", \"VulnerableParallelScatter\")\n    .attr(\"viewBox\", [0, 0, width, height])\n    .attr(\"width\", width)\n    .attr(\"height\", height);\n\n  // Define the variable categories (gender, poverty, education)\n  const categories = {\n    gender: {\n      values: dimensions.filter((d) =&gt; d.startsWith(\"gender\")),\n      range: [0, 1],\n      unit: 10,\n    },\n    poverty: {\n      values: dimensions.filter((d) =&gt; d.startsWith(\"poverty\")),\n      range: [0, 1],\n      unit: \"percent_NoDecimal\",\n    },\n    education: {\n      values: dimensions.filter((d) =&gt; d.startsWith(\"education\")),\n      range: [0, 13],\n      unit: \"total\",\n    },\n  };\n\n  // Flatten the categories into a single array, adding gaps between groups\n  const groupedDimensions = [\n    ...categories.gender.values,\n    ...categories.poverty.values,\n    ...categories.education.values,\n  ];\n\n  // Define the x scale, with larger spacing for the gaps\n  const x = d3\n    .scalePoint()\n    .domain(groupedDimensions)\n    .range([margin.left, width - margin.right])\n    .padding(0.3); // Add extra padding for the gaps\n\n  const y = {};\n  for (const dim of groupedDimensions) {\n    let group = dim.split(\"-\")[0];\n    let y_extent = categories[group].range;\n    y[dim] = d3\n      .scaleLinear()\n      .domain(y_extent)\n      .range([height - margin.bottom, margin.top]);\n  }\n\n  d3.selectAll(\".ParallelCoordTip\").remove();\n  const tooltip = d3\n    .select(\"body\")\n    .append(\"div\")\n    .attr(\"class\", \"plotTooltip ParallelCoordTip\")\n    .style(\"position\", \"absolute\");\n\n  // Create circles for each data point\n  groupedDimensions.forEach((dim) =&gt; {\n    if (dim === \"\") return; // Skip gaps\n\n    svg\n      .selectAll(`.dot-${dim}`)\n      .data(data_vuln)\n      .join(\"circle\")\n      .attr(\n        \"class\",\n        (d) =&gt; `dot-${dim} country-${d.country.replace(/\\s+/g, \"-\")}`,\n      )\n      .attr(\"cx\", () =&gt; x(dim) + jitter())\n      .attr(\"cy\", (d) =&gt; {\n        return y[dim](d[dim]);\n      })\n      .attr(\"r\", 5)\n      .style(\"fill\", \"lightgrey\")\n      .style(\"opacity\", 0.5)\n      .on(\"mouseover\", function (event, d) {\n        svg\n          .selectAll(`.country-${d.country.replace(/\\s+/g, \"-\")}`)\n          .attr(\"r\", 8)\n          .style(\"opacity\", 1)\n          .style(\"fill\", (d) =&gt; color(d.country))\n          .raise();\n        tooltip\n          .style(\"top\", event.pageY - 1 + \"px\")\n          .style(\"left\", event.pageX + 1 + \"px\")\n          .style(\"opacity\", 0.8)\n          .style(\"display\", \"block\")\n          .html(() =&gt; {\n            let admin_string = d.country;\n            let admin_names = admin_string.split(\"_\");\n            let admin0_name = admin_names[0];\n            let admin_join = admin_names\n              .filter((name) =&gt; name !== \"null\")\n              .join(\", \");\n            let splitVar = dim.split(\"-\");\n            let varname = _lang(nbText.general.acVars[splitVar[1]]);\n            let varValue = format_val(d[dim], categories[splitVar[0]].unit);\n            return `${admin_join}&lt;br/&gt;${varname}: ${varValue}`;\n          });\n        // .html(`${d.country}&lt;br/&gt;${dim}: ${d[dim].toFixed(2)}`);\n      })\n      .on(\"mouseout\", function (event, d) {\n        svg\n          .selectAll(`.country-${d.country.replace(/\\s+/g, \"-\")}`)\n          .attr(\"r\", 5)\n          .style(\"opacity\", 0.5)\n          .style(\"fill\", \"lightgrey\")\n          .lower();\n        tooltip.style(\"display\", \"none\");\n      });\n  });\n\n  // Add average points\n  let avg_points = svg\n    .selectAll(\".avg-dot\")\n    .data(groupedDimensions)\n    .enter()\n    .append(\"circle\")\n    .attr(\"class\", \"avg-dot\")\n    .attr(\"cx\", (d) =&gt; x(d))\n    .attr(\"cy\", (d) =&gt; y[d](means[0][d]))\n    .attr(\"r\", 7)\n    .style(\"fill\", \"#2E7636\")\n    .style(\"stroke\", \"white\")\n    .style(\"stroke-width\", 2);\n\n  avg_points\n    .on(\"mouseover\", function (event, d) {\n      svg.selectAll(`.avg-dot`).raise();\n      tooltip\n        .style(\"top\", event.pageY - 1 + \"px\")\n        .style(\"left\", event.pageX + 1 + \"px\")\n        .style(\"opacity\", 0.8)\n        .style(\"display\", \"block\")\n        .html(() =&gt; {\n          let admin_name = means.country;\n          let splitVar = d.split(\"-\");\n          let varname = _lang(nbText.general.acVars[splitVar[1]]);\n          let varValue = format_val(means[0][d], categories[splitVar[0]].unit);\n          return `${admin_name}&lt;br/&gt;${varname}: ${varValue}`;\n        });\n      // .html(`${d.country}&lt;br/&gt;${dim}: ${d[dim].toFixed(2)}`);\n    })\n    .on(\"mouseout\", function (event, d) {\n      svg.selectAll(`.avg-dot`);\n      // .lower();\n      tooltip.style(\"display\", \"none\");\n    });\n\n  svg\n    .selectAll(\"myAxis\")\n    .data(groupedDimensions)\n    .enter()\n    .append(\"g\")\n    .attr(\"transform\", (d) =&gt; \"translate(\" + x(d) + \")\")\n    .attr(\"pointer-events\", \"none\")\n    .each(function (d) {\n      let group = d.split(\"-\")[0];\n      d3.select(this).call(\n        d3\n          .axisLeft()\n          .scale(y[d])\n          .tickFormat((v) =&gt; format_val(v, categories[group].unit)),\n      );\n    })\n    .append(\"text\")\n    .style(\"text-anchor\", \"middle\")\n    .attr(\"y\", (d, i) =&gt; {\n      return i % 2 === 0 ? margin.top - 10 : height - margin.bottom + 20;\n    })\n    .text((d) =&gt; {\n      let split = d.split(\"-\");\n      let clean_text = _lang(nbText.general.acVars[split[1]]);\n      return clean_text;\n    })\n    .style(\"fill\", \"black\")\n    .style(\"font-size\", \"12px\");\n\n  const legendX = 10;\n  const legendY = 5;\n\n  const legend = svg\n    .append(\"g\")\n    .attr(\"transform\", `translate(${legendX}, ${legendY})`);\n\n  legend\n    .append(\"circle\")\n    .attr(\"cx\", 10)\n    .attr(\"cy\", 10)\n    .attr(\"r\", 7)\n    .style(\"fill\", \"#2E7636\");\n\n  // Append text next to the dot\n  legend\n    .append(\"text\")\n    .attr(\"x\", 20)\n    .attr(\"y\", 15)\n    .style(\"font-size\", \"12px\")\n    .style(\"fill\", \"#000\")\n    .text(\"Regional Average\");\n\n  return svg.node();\n\n  function pivotData(data) {\n    const pivotedData = {};\n\n    data.forEach((row) =&gt; {\n      // Use a default value for any missing (NULL) admin field\n      const admin0 = row.admin0_name;\n      const admin1 = row.admin1_name; //|| \"\";\n      const admin2 = row.admin2_name; //|| \"\"\n\n      // Create a unique key for each combination of admin0, admin1, admin2, admin3\n      const country = `${admin0}_${admin1}_${admin2}`;\n\n      if (!pivotedData[country]) {\n        pivotedData[country] = { country };\n      }\n\n      let combined_name = row.group + \"-\" + row.variable;\n      pivotedData[country][combined_name] = row.value;\n    });\n\n    // Return the pivoted data as an array of objects\n    return Object.values(pivotedData);\n  }\n\n  function calculateMeans(data) {\n    const groupedData = {};\n\n    data.forEach((row) =&gt; {\n      let combined_name = row.group + \"-\" + row.variable;\n      if (!groupedData[combined_name]) {\n        groupedData[combined_name] = [];\n      }\n      groupedData[combined_name].push(row.value);\n    });\n\n    const means = {};\n    for (const [variable, values] of Object.entries(groupedData)) {\n      const sum = values.reduce((acc, val) =&gt; acc + val, 0);\n      means[variable] = sum / values.length;\n    }\n\n    return [means];\n  }\n};\n\n\n\n\n\n\n\nparallelCoordinatesScatterPlot = async () =&gt; {\n  const margin = { top: 60, right: 80, bottom: 55, left: 75 },\n    width = 1000,\n    height = 600;\n\n  let group_query = `AND \"group\" in (${\n    \"'\" +\n    DataSelector_form.vulnerabilityGroup_form.vulnerability_sel\n      .join(\"', '\")\n      .toLowerCase() +\n    \"'\"\n  })`;\n\n  let data = await db.query(\n    `SELECT \"admin0_name\", \"admin1_name\", \"admin2_name\", \"group\", \"variable\", \"value\"\n     FROM Vulnerability \n     ${plotQuery2_admin}\n     AND \"variable\" != 'GenderEquity_1995.2015'\n     ${group_query}`,\n  );\n\n  const data_vuln = pivotData(data);\n\n  data_vuln.forEach((entry) =&gt; {\n    Object.keys(entry).forEach((key) =&gt; {\n      if (key.startsWith(\"poverty-\")) {\n        entry[key] = 1 - entry[key]; // Invert value\n      }\n    });\n  });\n\n  let means = calculateMeans(data_vuln);\n\n  means.country = \"Regional Average\";\n\n  const dimensions = Object.keys(data_vuln[0]).filter((d) =&gt; d !== \"country\");\n  const jitter = d3.randomUniform(-15, 15);\n\n  const color_dep = d3\n    .scaleOrdinal()\n    .domain(data_vuln.map((d) =&gt; d.country))\n    .range(d3.schemeCategory10);\n\n  const svg = d3\n    .create(\"svg\")\n    .attr(\"id\", \"VulnerableParallelScatter\")\n    .attr(\"viewBox\", [0, 0, width, height])\n    .attr(\"width\", width)\n    .attr(\"height\", height);\n\n  // Define the variable categories (gender, poverty, education)\n  const categories = {\n    gender: {\n      values: dimensions.filter((d) =&gt; d.startsWith(\"gender\")),\n      range: [0, 1],\n      unit: 100,\n      color: \"black\",\n    },\n    poverty: {\n      values: dimensions.filter((d) =&gt; d.startsWith(\"poverty\")),\n      range: [0, 1],\n      unit: \"percent_NoDecimal\",\n      color: \"black\",\n    },\n    education: {\n      values: dimensions.filter((d) =&gt; d.startsWith(\"education\")),\n      range: [0, 13],\n      unit: \"total\",\n      color: \"black\",\n    },\n  };\n\n  const color = (group, value) =&gt; {\n    // let color_range = group === 'poverty' ? ['green', 'red'] : ['red', 'green']\n    let color_range = [\"red\", \"green\"];\n    return d3.scaleLinear().domain(categories[group].range).range(color_range)(\n      value,\n    );\n  };\n\n  // Flatten the categories into a single array, adding gaps between groups\n  const groupedDimensions = [\n    ...categories.gender.values.sort(),\n    ...categories.poverty.values.sort(),\n    ...categories.education.values.sort(),\n  ];\n\n  const x = d3\n    .scalePoint()\n    .domain(groupedDimensions)\n    .range([margin.left, width - margin.right]);\n\n  const y_group = {\n    gender: d3\n      .scaleLinear()\n      .domain(categories.gender.range)\n      .range([height - margin.bottom, margin.top]),\n    poverty: d3\n      .scaleLinear()\n      .domain(categories.poverty.range)\n      .range([height - margin.bottom, margin.top]),\n    education: d3\n      .scaleLinear()\n      .domain(categories.education.range)\n      .range([height - margin.bottom, margin.top]),\n  };\n\n  const y = {};\n  groupedDimensions\n    .filter((d) =&gt; d !== \"\")\n    .forEach((dim) =&gt; {\n      let group = dim.split(\"-\")[0];\n      console.log(group);\n      let y_extent = categories[group].range;\n      y[dim] = d3\n        .scaleLinear()\n        .domain(y_extent)\n        .range([height - margin.bottom, margin.top]);\n    });\n\n  d3.selectAll(\".ParallelCoordTip\").remove();\n  const tooltip = d3\n    .select(\"body\")\n    .append(\"div\")\n    .attr(\"class\", \"plotTooltip ParallelCoordTip\")\n    .style(\"position\", \"absolute\");\n\n  // Create circles for each data point\n  groupedDimensions\n    .filter((d) =&gt; d !== \"\")\n    .forEach((dim) =&gt; {\n      let splitVar = dim.split(\"-\");\n      let varname = _lang(\n        nbText.ViewExplore.parallelCoords.acVars[splitVar[1]],\n      );\n      let group = splitVar[0];\n      svg\n        .selectAll(`.dot-${dim}`)\n        .data(data_vuln)\n        .join(\"circle\")\n        .attr(\n          \"class\",\n          (d) =&gt; `dot-${dim} country-${d.country.replace(/\\s+/g, \"-\")}`,\n        )\n        .attr(\"cx\", () =&gt; x(dim) + jitter())\n        .attr(\"cy\", (d) =&gt; {\n          return y[dim](d[dim]);\n        })\n        .attr(\"r\", 5)\n        // .style(\"fill\", 'lightgrey')\n        .style(\"fill\", (d) =&gt; color(group, d[dim]))\n        .style(\"opacity\", 0.1)\n        .on(\"mouseover\", function (event, d) {\n          svg\n            .selectAll(`.country-${d.country.replace(/\\s+/g, \"-\")}`)\n            .attr(\"r\", 8)\n            .style(\"opacity\", 1)\n            .raise();\n          console.log(\"ttip\", `.legend-${group}`);\n          svg.selectAll(`.legend-${group}`).style(\"opacity\", 1);\n          tooltip\n            .style(\"top\", event.pageY - 1 + \"px\")\n            .style(\"left\", event.pageX + 1 + \"px\")\n            .style(\"opacity\", 0.8)\n            .style(\"display\", \"block\")\n            .html(() =&gt; {\n              let admin_string = d.country;\n              let admin_names = admin_string.split(\"_\");\n              admin_names[0] =\n                _lang(nbText.general.adminNames[admin_names[0]]) ||\n                admin_names[0];\n              // let admin0_name = _lang(nbText.general.adminNames[admin_names[0]])\n              let admin_join = admin_names\n                .filter((name) =&gt; name !== \"null\")\n                .join(\", \");\n              let varValue = format_val(d[dim], categories[group].unit);\n              return `${admin_join}&lt;br/&gt;${varname}: ${varValue}`;\n            });\n          // .html(`${d.country}&lt;br/&gt;${dim}: ${d[dim].toFixed(2)}`);\n        })\n        .on(\"mouseout\", function (event, d) {\n          svg\n            .selectAll(`.country-${d.country.replace(/\\s+/g, \"-\")}`)\n            .attr(\"r\", 5)\n            .style(\"opacity\", 0.1)\n            .lower();\n\n          svg.selectAll(`.legend-${group}`).style(\"opacity\", 0.5);\n          tooltip.style(\"display\", \"none\");\n        });\n    });\n\n  // Add average points\n  let avg_points = svg\n    .selectAll(\".avg-dot\")\n    .data(groupedDimensions.filter((d) =&gt; d !== \"\"))\n    .enter()\n    .append(\"circle\")\n    .attr(\"class\", \"avg-dot\")\n    .attr(\"cx\", (d) =&gt; x(d))\n    .attr(\"cy\", (d) =&gt; y[d](means[0][d]))\n    .attr(\"r\", 7)\n    .style(\"fill\", \"grey\")\n    // .style(\"fill\", \"#2E7636\")\n    .style(\"stroke\", \"white\")\n    .style(\"stroke-width\", 2);\n\n  avg_points\n    .on(\"mouseover\", function (event, d) {\n      let splitVar = d.split(\"-\");\n      let varname = _lang(\n        nbText.ViewExplore.parallelCoords.acVars[splitVar[1]],\n      );\n      let group = splitVar[0];\n      svg.selectAll(`.avg-dot`).attr(\"r\", 8).raise();\n      svg.selectAll(`.legend-${group}`).style(\"opacity\", 1);\n      tooltip\n        .style(\"top\", event.pageY - 1 + \"px\")\n        .style(\"left\", event.pageX + 1 + \"px\")\n        .style(\"opacity\", 0.8)\n        .style(\"display\", \"block\")\n        .html(() =&gt; {\n          let admin_name = means.country; // TODO: Lang add here\n          let varValue = format_val(means[0][d], categories[group].unit);\n          return `${admin_name}&lt;br/&gt;${varname}: ${varValue}`;\n        });\n      // .html(`${d.country}&lt;br/&gt;${dim}: ${d[dim].toFixed(2)}`);\n    })\n    .on(\"mouseout\", function (event, d) {\n      svg.selectAll(`.legend-${d.split(\"-\")[0]}`).style(\"opacity\", 1);\n      svg.selectAll(`.avg-dot`).attr(\"r\", 7);\n      // .lower();\n      tooltip.style(\"display\", \"none\");\n    });\n\n  Object.keys(categories).forEach((cat) =&gt; {\n    svg\n      .append(\"g\")\n      .attr(\"class\", `legend-${cat}`)\n      .attr(\"transform\", `translate(${x(categories[cat].values[0]) - 20},0)`)\n      .style(\"opacity\", 0.5)\n      .call(\n        d3\n          .axisLeft(y_group[cat])\n          .tickFormat((v) =&gt; format_val(v, categories[cat].unit)),\n      )\n      .call((g) =&gt; {\n        g.selectAll(\".tick text\").attr(\"fill\", categories[cat].color);\n        g.selectAll(\".tick line\").attr(\"stroke\", categories[cat].color);\n        g.select(\".domain\").attr(\"stroke\", categories[cat].color); // Axis line color\n      });\n    // .append(\"text\")  // Vertical title\n    // .attr(\"x\", -40)\n    // .attr(\"y\", (height / 2))\n    // .attr(\"text-anchor\", \"middle\")\n    // .attr(\"transform\", `rotate(-90, -40, ${height / 2})`)\n    // .style(\"font-size\", \"14px\")\n    // .style(\"fill\", categories[cat].color)\n    // .text(`${Lang.toSentenceCase(cat)} Variables`)\n  });\n\n  svg\n    .selectAll(\"myAxis\")\n    .data(groupedDimensions)\n    .enter()\n    .append(\"g\")\n    .attr(\"transform\", (d) =&gt; \"translate(\" + x(d) + \")\")\n    .attr(\"pointer-events\", \"none\")\n    .append(\"text\")\n    .style(\"text-anchor\", \"middle\")\n    .attr(\"y\", (d, i) =&gt; {\n      return i % 2 === 0 ? margin.top - 10 : height - margin.bottom + 20;\n    })\n    .text((d) =&gt; {\n      let split = d.split(\"-\");\n      let clean_text = _lang(\n        nbText.ViewExplore.parallelCoords.acVars[split[1]],\n      );\n      return clean_text;\n    })\n    .style(\"fill\", (d) =&gt; {\n      return categories[d.split(\"-\")[0]].color;\n    })\n    .style(\"font-size\", \"10px\");\n\n  const dotLegendX = 10;\n  const dotLegendY = 5;\n\n  const legend = svg\n    .append(\"g\")\n    .attr(\"transform\", `translate(${dotLegendX}, ${dotLegendY})`);\n\n  legend\n    .append(\"circle\")\n    .attr(\"cx\", 10)\n    .attr(\"cy\", 10)\n    .attr(\"r\", 8)\n    .style(\"fill\", \"grey\");\n\n  // Append text next to the dot\n  legend\n    .append(\"text\")\n    .attr(\"x\", 23)\n    .attr(\"y\", 15)\n    .style(\"font-size\", \"13px\")\n    .style(\"fill\", \"#000\")\n    .text(_lang(nbText.general.regionalAvg));\n\n  // Add lines and titles for each group\n  addGroupTitleLine(\"gender\", \"Gender\", categories.gender.color);\n  addGroupTitleLine(\"poverty\", \"Poverty\", categories.poverty.color);\n  addGroupTitleLine(\"education\", \"Education\", categories.education.color);\n\n  //// Add a legend from red to green\n  const gradientWidth = 250;\n  const gradientHeight = 15;\n  const legendX = width / 2 - 125;\n  const legendY = 5;\n\n  // Append a defs element for the gradient\n  const defs = svg.append(\"defs\");\n\n  const linearGradient = defs\n    .append(\"linearGradient\")\n    .attr(\"id\", \"AClinear-gradient\");\n\n  // linearGradient\n  //   .append('stop')\n  //     .selectAll(\"stop\")\n  //     .data([minValue, maxValue])\n  //     .join(\"stop\")\n  //     .attr(\"offset\", (d, i, n) =&gt; `${(100 * i) / (n.length - 1)}%`)\n  //     .attr(\"stop-color\", color);\n\n  linearGradient.append(\"stop\").attr(\"offset\", \"0%\").attr(\"stop-color\", \"red\");\n\n  linearGradient\n    .append(\"stop\")\n    .attr(\"offset\", \"100%\")\n    .attr(\"stop-color\", \"green\");\n\n  // Draw the rectangle using the gradient\n  svg\n    .append(\"rect\")\n    .attr(\"x\", legendX)\n    .attr(\"y\", legendY)\n    .attr(\"width\", gradientWidth)\n    .attr(\"height\", gradientHeight)\n    .style(\"fill\", \"url(#AClinear-gradient)\");\n\n  // Add labels for the gradient\n  svg\n    .append(\"text\")\n    .attr(\"x\", legendX - 5)\n    .attr(\"y\", legendY + gradientHeight / 2 + 5)\n    .attr(\"text-anchor\", \"end\")\n    .style(\"font-size\", \"12px\")\n    .text(\"Low adaptive capacity\");\n\n  svg\n    .append(\"text\")\n    .attr(\"x\", legendX + gradientWidth + 5)\n    .attr(\"y\", legendY + gradientHeight / 2 + 5)\n    .attr(\"text-anchor\", \"start\")\n    .style(\"font-size\", \"13px\")\n    .text(\"High adaptive capacity\");\n\n  return svg.node();\n\n  ///// Helper Functions //////\n\n  function pivotData(data) {\n    const pivotedData = {};\n\n    data.forEach((row) =&gt; {\n      // Use a default value for any missing (NULL) admin field\n      const admin0 = row.admin0_name;\n      const admin1 = row.admin1_name; //|| \"\";\n      const admin2 = row.admin2_name; //|| \"\"\n\n      // Create a unique key for each combination of admin0, admin1, admin2, admin3\n      const country = `${admin0}_${admin1}_${admin2}`;\n\n      if (!pivotedData[country]) {\n        pivotedData[country] = { country };\n      }\n\n      let combined_name = row.group + \"-\" + row.variable;\n      pivotedData[country][combined_name] = row.value;\n    });\n\n    // Return the pivoted data as an array of objects\n    return Object.values(pivotedData);\n  }\n\n  function calculateMeans(data) {\n    const groupedData = {};\n    data.forEach((row) =&gt; {\n      // Loop through each key in the object (ignoring the 'country' key)\n      Object.keys(row).forEach((key) =&gt; {\n        if (key !== \"country\") {\n          if (!groupedData[key]) {\n            groupedData[key] = [];\n          }\n          groupedData[key].push(row[key]);\n        }\n      });\n    });\n\n    const means = {};\n    for (const [variable, values] of Object.entries(groupedData)) {\n      const sum = values.reduce((acc, val) =&gt; acc + val, 0);\n      means[variable] = sum / values.length;\n    }\n\n    return [means];\n  }\n\n  function addGroupTitleLine(group, groupLabel, color) {\n    const groupValues = categories[group].values;\n    let groupStart = x(groupValues[0]) - 15;\n    let groupEnd = x(groupValues[groupValues.length - 1]) + 15;\n\n    if (groupStart === groupEnd) {\n      groupStart = groupStart - 25;\n      groupEnd = groupStart + 25;\n    }\n    svg\n      .append(\"line\")\n      .attr(\"x1\", groupStart)\n      .attr(\"x2\", groupEnd)\n      .attr(\"y1\", height - 20)\n      .attr(\"y2\", height - 20)\n      .attr(\"stroke\", color)\n      .attr(\"stroke-width\", 2);\n\n    // Append the group label centered on the line\n    svg\n      .append(\"text\")\n      .attr(\"x\", (groupStart + groupEnd) / 2) // Center the title between start and end\n      .attr(\"y\", height - 5) // Position the title above the line\n      .attr(\"text-anchor\", \"middle\")\n      .style(\"font-size\", \"14px\")\n      .style(\"font-weight\", \"bold\")\n      .style(\"fill\", color)\n      .text(groupLabel);\n  }\n};\n\n\n\n\n\n\n\nTooltipCSS = html`&lt;style&gt;\n.plotTooltip {\n  padding: 10px 10px;\n  color: black;\n  border-radius: 4px;\n  border: 1px solid rgba(0,0,0,1);\n  pointer-events: none;\n  transform: translate(-50%, -100%);\n  font-family: \"IBM Plex Sans\", \"Source Serif Pro\";\n  font-size: 14px;\n  background: rgba(255,255,255, 1);\n  transition: 0.3s opacity ease-out, 0.1s border-color ease-out;\n  position: relative;\n  display: none;\n}\n\n.plotTooltip::before {\n  content: \"\";\n  position: absolute;\n  top: 100%;\n  left: 50%;\n  margin-left: -5px;\n  border-width: 5px;\n  border-style: solid;\n  border-color: black transparent transparent transparent;\n}\n\n.plotTooltip::after {\n  content: \"\";\n  position: absolute;\n  top: calc(100% - 1px);\n  left: 50%;\n  margin-left: -4.9px;\n  border-width: 4.9px;\n  border-style: solid;\n  border-color: white transparent transparent transparent;\n}\n&lt;/style&gt;`;\n\n\n\n\n\n\n\nfunction tocOneliner({\n  selector = \"h1\", // selectors to include (can comma-separate, like \"h1,h2,h3\")\n  heading = \"&lt;b&gt;In this notebook&lt;/b&gt;\", // heading for ToC\n  delim = \"&nbsp;|&nbsp;\", // delimiter between links\n  skip = [], // text content for headers to exclude\n} = {}) {\n  // return a one-liner table of contents\n  // allow for skips\n  // modified from https://observablehq.com/@mbostock/toc\n\n  return Generators.observe((notify) =&gt; {\n    let headings = [];\n\n    function observed() {\n      let h = Array.from(document.querySelectorAll(selector));\n      h = h.filter((d) =&gt; !skip.includes(d.textContent));\n      if (h.length !== headings.length || h.some((h, i) =&gt; headings[i] !== h)) {\n        notify(\n          html`${heading}&lt;br&gt;${Array.from((headings = h), (h, i) =&gt; {\n            const end = i === headings.length - 1;\n            return Object.assign(\n              html`&lt;a href=#${h.id}&gt;${DOM.text(h.textContent)}&lt;/a&gt;${\n                end ? \"\" : delim\n              }`,\n              { onclick: (e) =&gt; (e.preventDefault(), h.scrollIntoView()) },\n            );\n          })}`,\n        );\n      }\n    }\n\n    const observer = new MutationObserver(observed);\n    observer.observe(document.body, { childList: true, subtree: true });\n    observed();\n    return () =&gt; observer.disconnect();\n  });\n}\n\n\n\n\n\n\n\nmd`## Language and Translation tools`;\n\n\n\n\n\n\n\nimport { Lang } from \"7d46679f7d0d917e\";\n\n\n\n\n\n\n\n_lang = Lang.lg(language.key);\n\n\n\n\n\n\n\nlanguages = [\n  { key: \"en\", label: \"English\", locale: \"en-US\" },\n  { key: \"fr\", label: \"Français\", locale: \"fr-FR\" },\n];\n\n\n\n\n\n\n\ndefaultLangKey = {\n  const name = \"lang\";\n  const list = languages.map((d) =&gt; d.key);\n  const defaultKey = \"en\";\n\n  const queryParam = await Lang.getParamFromList({ name, list });\n\n  return queryParam ?? defaultKey;\n}\n\n\n\n\n\n\n\nviewof language = Inputs.radio(languages, {\n  label: \"Main language toggle\",\n  format: (d) =&gt; d.key,\n  value: languages.find((x) =&gt; x.key === defaultLangKey),\n})\n\n\n\n\n\n\n\nnbText = new Object({\n  nbTitle: { en: \"Explore The Datasets\", fr: \"Explorez les données\" },\n  toc: {\n    title: { en: \"In this notebook\", fr: \"Dans ce notebook\" },\n  },\n  overview: {\n    title: { en: \"Overview\", fr: \"Vue d’Ensemble\" },\n    subTitle: {\n      en: `Explore and export the data in the [Adaptation Atlas](https://adaptationatlas.cgiar.org)`,\n      fr: `Explorez et exportez les données de [L’Adaptation l'Atlas](https://adaptationatlas.cgiar.org)`,\n    },\n    text: {\n      en: \"This notebook enables you to explore and download the data that underpins much of the analysis within the African Agricultural Adaptation Atlas. Filter and export the data in multiple formats to perform external analysis or use the tables and plots in this notebook to gain insights into broad continental trends or region-specific statistics.\",\n      fr: \"Ce notebook vous permet d'explorer et de télécharger les données qui constituent la base d’une grande partie de l'analyse au sein de African Agricultural Adaptation Atlas. Filtrez et exportez les données dans plusieurs formats pour effectuer des analyses externes ou utilisez les tableaux et graphiques de ce notebook pour obtenir des aperçus sur les tendances continentales générales ou les statistiques spécifiques à une région.\",\n    },\n  },\n  selectCategory: {\n    title_main: {\n      en: \"Define The Data Focus\",\n      fr: \"Définir le focus des données\",\n    },\n    title: { en: \"Select A Category\", fr: \"Sélectionnez une catégorie\" },\n    text: {\n      en: \"Choose between these categories: Hazard, Adaptive Capacity, and Exposure. These three categories are essential for a comprehensive understanding of climate risk, enabling effective assessment and management strategies.\",\n      fr: \"Choisissez parmi ces catégories : Aléa, Capacité d'adaptation et Exposition. Ces trois catégories sont essentielles pour une compréhension globale du risque climatique, permettant des stratégies d'évaluation et de gestion efficaces.\",\n    },\n    selector: {\n      title: { en: \"Category\", fr: \"Catégorie \" },\n      options: {\n        Hazard: {\n          title: { en: \"Hazard\", fr: \"Aléa\" },\n          description: {\n            en: \"Climate Hazards include individual, extreme climate events as well as shifting trends over time. Both acute events and long term changes can pose a serious threat to crops, livestock, people, and other assets.\",\n            fr: \"Les aléas climatiques incluent des événements climatiques extrêmes individuels ainsi que des tendances changeantes au fil du temps. Tant les événements aigus que les changements à long terme peuvent représenter une menace sérieuse pour les cultures, le bétail, les personnes et d'autres actifs.\",\n          },\n        },\n        Vulnerability: {\n          title: { en: \"Adaptive Capacity\", fr: \"Capacité d'adaptation\" },\n          description: {\n            en: \"A population's ability to adapt to a changing climate is directly influenced by different socio-economic variables. Variables such as education, female empowerment, and poverty can promote or inhibit a person's ability to respond, recover, and adapt to climate related risks.\",\n            fr: \"La capacité d'une population à s'adapter à un climat changeant est directement influencée par différentes variables socio-économiques. Des variables telles que l'éducation, l'autonomisation des femmes et la pauvreté peuvent favoriser ou entraver la capacité d'une personne à répondre, se rétablir et s'adapter aux risques liés au climat.\",\n          },\n        },\n        Exposure: {\n          title: { en: \"Exposure\", fr: \"Exposition\" },\n          description: {\n            en: \"Crop and livestock production systems are vulnerable to climate hazards such as heat stress, temperature fluctuations, and changes in precipitation patterns. Agriculture in Sub-Saharan Africa is primarily driven by small-holder farmers and plays an important role in both global and local food security. Exposure happens when these livelihoods and commodities are exposed to hazardous climate conditions. To fully understand climate risk, the level and scale of exposure must be understood.\",\n            fr: \"Les systèmes de production des cultures et du bétail sont vulnérables aux aléas climatiques tels que le stress thermique, les fluctuations de température et les changements dans les régimes de précipitations. L'agriculture en Afrique subsaharienne est principalement portée par de petits exploitants agricoles et joue un rôle important dans la sécurité alimentaire tant mondiale que locale. L'exposition se produit lorsque ces moyens de subsistance et ces produits sont confrontés à des conditions climatiques dangereuses. Pour comprendre pleinement le risque climatique, le niveau et l'échelle de l'exposition doivent être évalués.\",\n          },\n        },\n      },\n    },\n  },\n  selectVars: {\n    title: {\n      en: \"Select the variables of interest\",\n      fr: \"Sélectionnez les variables d'intérêt\",\n    },\n    text: {\n      en: \"There are many different variables within the categories of hazard, exposure, and vulnerability. Use the selector below to choose one or multiple of these variables to explore or download.\",\n      fr: \"Il existe de nombreuses variables différentes dans les catégories d'aléa, d'exposition et de vulnérabilité. Utilisez le sélecteur ci-dessous pour choisir une ou plusieurs de ces variables à explorer ou à télécharger.\",\n    },\n    forms: {\n      Hazard: {\n        mainTitle: {\n          en: \"Hazard Selectors (One of each must be selected)\",\n          fr: \"Sélecteurs d'Aléas (Un de chaque doit être sélectionné)\",\n        },\n        selectors: {\n          hazard: {\n            title: { en: \"Hazard\", fr: \"Aléa\" },\n          },\n          period: {\n            title: { en: \"Time Period\", fr: \"Période de temps\" },\n            options: {\n              baseline: { en: \"Baseline\", fr: \"Référence\" },\n              historic: { en: \"Baseline\", fr: \"Référence\" },\n              \"2021_2040\": { en: \"2040\", fr: \"2040\" },\n              \"2041_2060\": { en: \"2060\", fr: \"2060\" },\n            },\n          },\n        },\n      },\n      Vulnerability: {\n        mainTitle: {\n          en: \"Adaptive Capacity Selectors\",\n          fr: \"Sélecteurs de capacité d’adaptation\",\n        },\n        selectors: {\n          variable: {\n            title: { en: \"Variables\", fr: \"Variables\" },\n            options: {\n              Gender: { en: \"Gender\", fr: \"Genre\" },\n              Education: { en: \"Education\", fr: \"Éducation\" },\n              Poverty: { en: \"Poverty\", fr: \"Pauvreté\" },\n            },\n          },\n        },\n      },\n      Exposure: {\n        mainTitle: {\n          en: \"Exposure Selectors\",\n          fr: \"\",\n        },\n        selectors: {\n          variable: {\n            title: { en: \"Variables\", fr: \"Variables\" },\n            options: {\n              Crop: { en: \"Crop\", fr: \"Cultures\" },\n              Livestock: { en: \"Livestock\", fr: \"Bétail\" },\n              Population: { en: \"Population\", fr: \"Population\" },\n            },\n          },\n        },\n      },\n    },\n  },\n  selectGeog: {\n    title: {\n      en: \"Select Geographies\",\n      fr: \"Sélectionnez les géographies\",\n    },\n    text: {\n      en: \"Use the toggles below to explore data and spatial patterns within your region of interest. Adjust the aggregation level to reveal patterns of hazard, vulnerability, and exposure, both within and between countries. These crucial insights often become clear only when viewed at higher spatial resolutions. Once you've selected an aggregation level, you can use the country, region, and sub-region selectors to focus on specific areas.\",\n      fr: \"Utilisez les options ci-dessous pour explorer les données et les modèles spatiaux dans votre région d'intérêt. Ajustez le niveau d'agrégation pour révéler les schémas d'aléa, de vulnérabilité et d'exposition, à la fois au sein des pays et entre eux. Ces informations cruciales deviennent souvent claires uniquement lorsqu'elles sont observées à des résolutions spatiales plus élevées. Une fois que vous avez sélectionné un niveau d'agrégation, vous pouvez utiliser les sélecteurs de pays, de région et de sous-région pour vous concentrer sur des zones spécifiques.\",\n    },\n    selectors: {\n      aggregationLvl: {\n        title: { en: \"Map Level\", fr: \"Niveau cartographique\" },\n        options: {\n          admin0_name: { en: \"Country\", fr: \"Pays\" },\n          admin1_name: { en: \"Region\", fr: \"Région\" },\n          admin2_name: { en: \"Sub-Region\", fr: \"Sous-région\" },\n        },\n        warning: {\n          en: \"Warning: Selecting all sub-regions in SSA may affect page performance\",\n          fr: \"\",\n        },\n      },\n      admin0_name: {\n        title: { en: \"Country\", fr: \"Pays\" },\n      },\n      admin1_name: {\n        title: { en: \"Region\", fr: \"Région\" },\n      },\n      admin2_name: {\n        title: { en: \"Sub-Region\", fr: \"Sous-région\" },\n      },\n    },\n  },\n  ViewExplore: {\n    title: { en: \"Interact with the data\", fr: \"Interagir avec les données\" },\n    text: {\n      en: \"Use the map below to view spatial patterns in the data, select the table to preview the data before downloading it, or gain quick insights using the plots.\",\n      fr: \"Utilisez la carte ci-dessous pour visualiser les modèles spatiaux dans les données, sélectionnez le tableau pour prévisualiser les données avant de les télécharger, ou obtenez rapidement des informations en utilisant les graphiques.\",\n    },\n    selectors: {\n      preview: {\n        title: { en: \"Preview Type\", fr: \"Type d'Aperçu\" },\n        options: {\n          Map: { en: \"Map\", fr: \"Carte\" },\n          Table: { en: \"Table\", fr: \"Tableau\" },\n          Plot: { en: \"Plot\", fr: \"Graphique\" },\n        },\n      },\n      visualiseVars: {\n        titleMap: { en: \"Variable To Map\", fr: \"Variable à cartographier\" },\n        titlePlot: { en: \"Variable To Plot\", fr: \"\" },\n        hazards: {\n          // hazard and timeperiod can be stolen from other section\n          scenario: {\n            title: { en: \"Scenario\", fr: \"Scénario\" },\n          },\n        },\n        vulnerability: {\n          gender: {\n            title: { en: \"Gender Variable\", fr: \"Variable de Genre\" },\n            options: {\n              domestic_violence: {\n                en: \"Domestic Safety\",\n                fr: \"Sécurité domestique\",\n              },\n              gender_equity: { en: \"Gender Equity\", fr: \"Égalité des sexes\" },\n              decision_making: {\n                en: \"Decision Making Power\",\n                fr: \"Pouvoir de décision\",\n              },\n              education: { en: \"Womens Education\", fr: \"Éducation des femmes\" },\n              family_planning: {\n                en: \"Access to Family Planning\",\n                fr: \"Accès à la planification familiale\",\n              },\n              reproductive_health: {\n                en: \"Reproductive Health\",\n                fr: \"Santé reproductive\",\n              },\n            },\n          },\n          poverty: {\n            title: { en: \"Poverty variable\", fr: \"Variable de Pauvreté\" },\n            options: {\n              GSAP_poor215: { en: \"% under $2.15 poverty line\", fr: \"\" },\n              GSAP_poor365: { en: \"% under $3.65 poverty line\", fr: \"\" },\n              GSAP_poor685: { en: \"% under $6.85 poverty line\", fr: \"\" },\n            },\n          },\n        },\n        exposure: {\n          title: { en: \"Exposure Category\", fr: \"Catégorie d'Exposition\" },\n          population: {\n            title: { en: \"Population Group\", fr: \"Groupe de Population\" },\n            options: {\n              total_pop: { en: \"Total Population\", fr: \"Population Totale\" },\n              rural_pop: { en: \"Rural Population\", fr: \"Population Rurale\" },\n              urban_pop: { en: \"Urban Population\", fr: \"Population Urbaine\" },\n            },\n          },\n          commodity: {\n            title: { en: \"Commodity\", fr: \"Produit\" },\n          },\n          exposureVariable: {\n            title: { en: \"Variable\", fr: \"Variable\" },\n            options: {\n              total_pop: { en: \"Total Population\", fr: \"Population Totale\" },\n              rural_pop: { en: \"Rural Population\", fr: \"Population Rurale\" },\n              urban_pop: { en: \"Urban Population\", fr: \"Population Urbaine\" },\n              vop: { en: \"Value of Production\", fr: \"Valeur de la Production\" },\n              ha: { en: \"Harvested Area\", fr: \"Superficie Récoltée\" },\n              number: { en: \"Number of Animals\", fr: \"Nombre d'Animaux\" },\n            },\n          },\n        },\n      },\n    },\n    exploreMap: {\n      resetBtn: { en: \"Reset Zoom\", fr: \"Réinitialiser le zoom\" },\n      value: { en: \"Value\", fr: \"Valeur\" },\n    },\n    hazardBars: {\n      numAreas: {\n        en: \"Number of Areas\",\n        fr: \"Nombre d'Unités Administratives\",\n      },\n      yaxis: {\n        en: \"Number of Admin Units\",\n        fr: \"Nombre d'Unités Administratives\",\n      },\n      lvl: { en: \"Level\", fr: \"\" },\n    },\n    exposureTreemap: {\n      cropGroups: {\n        total: { en: \"Total\", fr: \"Total\" },\n        cattle: { en: \"Cattle\", fr: \"Bovins\" },\n        poultry: { en: \"Poultry\", fr: \"Volailles\" },\n        pigs: { en: \"Pigs\", fr: \"Porcs\" },\n        cereals: { en: \"Cereals\", fr: \"Céréales\" },\n        rootsTuber: { en: \"Roots & Tubers\", fr: \"Racines et Tubercules\" },\n        legumes: { en: \"Legumes\", fr: \"Légumineuses\" },\n        fruitVeg: { en: \"Fruits & Vegetables\", fr: \"Fruits et Légumes\" },\n        nonEdible: { en: \"Non-edible Crops\", fr: \"Cultures non comestibles\" },\n      },\n    },\n    parallelCoords: {\n      acVars: {\n        domestic_violence: {\n          en: \"Domestic Safety\",\n          fr: \"Sécurité domestique\",\n        },\n        gender_equity: {\n          en: \"Gender Equity\",\n          fr: \"Égalité des sexes\",\n        },\n        decision_making: {\n          en: \"Decision Making Power\",\n          fr: \"Pouvoir de décision\",\n        },\n        education: {\n          en: \"Womens Education\",\n          fr: \"Éducation des femmes\",\n        },\n        family_planning: {\n          en: \"Access to Family Planning\",\n          fr: \"Accès à la planification familiale\",\n        },\n        reproductive_health: {\n          en: \"Reproductive Health\",\n          fr: \"Santé reproductive\",\n        },\n        GSAP_poor215: {\n          en: \"Above $2.15/day\",\n          fr: \"Au-dessus de 2,15 $/jour\",\n        },\n        GSAP_poor365: {\n          en: \"Above $3.65/day\",\n          fr: \"Au-dessus de 3,65 $/jour\",\n        },\n        GSAP_poor685: {\n          en: \"Above $6.85/day\",\n          fr: \"Au-dessus de 6,85 $/jour\",\n        },\n        educationYrs: {\n          en: \"Education(Yrs)\",\n          fr: \"Éducation (années)\",\n        },\n      },\n    },\n  },\n  download: {\n    title: { en: \"Download The Data\", fr: \"Télécharger les données\" },\n    selector: {\n      title: { en: \"Download Format\", fr: \"Format de téléchargement\" },\n    },\n    button: {\n      prepare: { en: \"Prepare Download\", fr: \"Préparer le téléchargement\" },\n      download: { en: \"Download\", fr: \"Télécharger\" },\n    },\n    boundaries: {\n      title: {\n        en: \"Download Boundary Data\",\n        fr: \"Télécharger les données des frontières\",\n      },\n      button: {\n        en: \"Download Admin :::adminLvl::: Boundaries\",\n        fr: \"Télécharger les frontières administratives :::adminLvl:::\",\n      },\n    },\n  },\n  methods_sources: {\n    title: { en: \"Methods & Sources\", fr: \"Méthodes & Sources\" },\n    methods: {\n      title: { en: \"Methods\", fr: \"Méthodologie\" },\n    },\n    datasets: {\n      title: { en: \"Datasets\", fr: \"Jeux de données\" },\n      boundaries: {\n        title: { en: \"Boundaries\", fr: \"Délimitations\" },\n        text: {\n          en: `[Administrative areas](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/boundary_catalog/geoBoundaries_SSA/collection.json) used in this notebook come from [geoBoundaries 6.0.0](https://github.com/wmgeolab/geoBoundaries). The gbHumanitarian boundaries are used and if not available then the gbOpen boundaries are substituted.`,\n          fr: `[Les zones administratives](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/boundary_catalog/geoBoundaries_SSA/collection.json?.language=fr) utilisées dans ce notebook proviennent de [geoBoundaries 6.0.0](https://github.com/wmgeolab/geoBoundaries). Les frontières gbHumanitarian sont utilisées et, si elles ne sont pas disponibles, les frontières gbOpen sont substituées.`,\n        },\n      },\n      acDS: {\n        title: {\n          en: \"Adaptive Capacity Datasets\",\n          fr: \"Jeux de données sur la capacité d’adaptation\",\n        },\n        FemaleWellbeing: {\n          title: {\n            en: \"Female Well-being and Empowerment data\",\n            fr: \"Données sur le bien-être et l'autonomisation des femmes\",\n          },\n          text: {\n            en: `The [Female Empowerment Index](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/adaptive-capacity/women-and-gender/female-empowerment/collection.json) combines data on domestic violence, employment, reproductive healthcare, decision-making power, and family planning. The index, and the variables it is derived from, are from [Rettig, Erica (2022)](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/8GJKYW) and are build using data from [DHS Program](https://dhsprogram.com). The individual variables and the Empowerment Index are based on the 2015 calculations. All of these have been normalized between 0 and 1, where 0 represents lowest empowerment and 1 represents highest empowerment`,\n            fr: `[L'Indice d'Autonomisation des Femmes](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/adaptive-capacity/women-and-gender/female-empowerment/collection.json?.language=fr) combine des données sur la violence domestique, l'emploi, les soins de santé reproductive, le pouvoir de décision et la planification familiale. L'indice, et les variables dont il est dérivé, proviennent de [Rettig, Erica (2022)](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/8GJKYW) et sont construits à partir des données du [programme DHS](https://dhsprogram.com). Les variables individuelles et l'Indice d'Autonomisation sont basés sur les calculs de 2015. Tous ces éléments ont été normalisés entre 0 et 1, où 0 représente le plus faible niveau d'autonomisation et 1 le plus élevé.`,\n          },\n        },\n        poverty: {\n          title: {\n            en: \"Poverty\",\n            fr: \"Pauvreté\",\n          },\n          text: {\n            en: md`Poverty data is derived from the [World Bank global subnational poverty atlas](https://datacatalog.worldbank.org/search/dataset/0042041/global_subnational_poverty_atlas_gsap) dataset.`,\n            fr: md`Les données sur la pauvreté sont tirées de [l'ensemble de données de l'atlas mondial de la pauvreté infranationale de la Banque mondiale](https://datacatalog.worldbank.org/search/dataset/0042041/global_subnational_poverty_atlas_gsap).`,\n          },\n        },\n        education: {\n          title: { en: \"Education\", fr: \"Éducation\" },\n          text: {\n            en: \"Years of education is the mean male and female educational attainment from the [2005-2015 IHME Estimates for ages 15-49](https://ghdx.healthdata.org/record/ihme-data/africa-educational-attainment-geospatial-estimates-2000-2015).\",\n            fr: \"Les années d’éducation correspondent à la moyenne de la scolarité des hommes et des femmes, selon les estimations de l’IHME pour la période [2005-2015 pour les personnes âgées de 15 à 49 ans.](https://ghdx.healthdata.org/record/ihme-data/africa-educational-attainment-geospatial-estimates-2000-2015)\",\n          },\n        },\n      },\n      exposureDS: {\n        title: {\n          en: \"Exposure Datasets\",\n          fr: \"Jeux de données sur l’exposition\",\n        },\n        population: {\n          title: {\n            en: \"Population\",\n            fr: \"Population\",\n          },\n          text: {\n            en: \"Population data is from the WorldPop Unconstrained Global Mosaic for 2020. The population data is masked Africapolis data to separate the population groups into rural, urban, and total. The final raster dataset used is at a resolution of 0.083 degrees (5 arc minutes).\",\n            fr: \"Les données démographiques proviennent de la mosaïque mondiale sans contrainte WorldPop pour 2020. Les données démographiques sont des données Africapolis masquées pour séparer les groupes de population en zones rurales, urbaines et totales. Le jeu de données raster final utilisé a une résolution de 0,083 degré (5 minutes d'arc).\",\n          },\n        },\n        vopHA: {\n          title: {\n            en: \"Crop and Livestock data\",\n            fr: \"Données sur les cultures et le bétail\",\n          },\n          text: {\n            en: md`[Crop value of production](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/exposure_catalog/mapspam2017/mapspam2017_vop_parquet/mapspam2017_vop_parquet.json) data comes from MapSPAM 2017 V2r3 (Spatial Production Allocation Model) where production values are multiplied by country specific FAOstat international crop prices in (2005 International Dollars). An [international dollar](https://en.wikipedia.org/wiki/International_dollar) (2005) is a hypothetical unit of currency that has the same purchasing power parity as the U.S. dollar had in the United States in 2005, allowing for comparison of what consumers can buy in different countries with the same amount of money. This dataset is an updated version of MapSPAM specifically tailored for this project. It includes bug fixes and incorporates country-specific values of production instead of global averages.\n\n[Livestock value of production](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/exposure_catalog/GLW3_livestock/GLW3_livestock_vopPQ/GLW3_livestock_vopPQ.json) in 2005 International Dollars were provided by the authors of [Herrero et al. (2013)](https://www.pnas.org/doi/full/10.1073/pnas.1308149110/).`,\n            fr: md`[Les données sur la valeur de la production des cultures](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/exposure_catalog/mapspam2017/mapspam2017_vop_parquet/mapspam2017_vop_parquet.json) proviennent de MapSPAM 2017 V2r3 (Modèle d'Allocation de Production Spatiale) où les valeurs de production sont multipliées par les prix internationaux des cultures de la FAOstat spécifiques à chaque pays en (dollars internationaux de 2005). Un [dollar international](https://en.wikipedia.org/wiki/International_dollar) (2005) est une unité monétaire hypothétique qui a la même parité de pouvoir d'achat que le dollar américain aux États-Unis en 2005, ce qui permet de comparer ce que les consommateurs peuvent acheter dans différents pays avec la même somme d'argent. Cet ensemble de données est une version mise à jour de MapSPAM spécialement conçue pour ce projet. Il comprend des corrections de bogues et incorpore des valeurs de production spécifiques à chaque pays au lieu de moyennes mondiales.\n\n[La valeur de la production animale](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/exposure_catalog/GLW3_livestock/GLW3_livestock_vopPQ/GLW3_livestock_vopPQ.json) en dollars internationaux de 2005 a été fournie par les auteurs de [Herrero et al. (2013)](https://www.pnas.org/doi/full/10.1073/pnas.1308149110/).\n`,\n          },\n        },\n      },\n      Hazards: {\n        title: {\n          en: \"Historic and future climate hazards\",\n          fr: \"Risques climatiques historiques et futurs\",\n        },\n        text: {\n          en: md`[Climate hazards](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/hazard_catalog/catalog.json) were calculated using five datasets [CHIRPS](https://www.chc.ucsb.edu/data/chirps)/[CHIRTS](https://www.chc.ucsb.edu/data/chirtsdaily), [AgERA5](https://doi.org/10.24381/cds.6c68c9bb), [CMIP6 projections](https://github.com/SantanderMetGroup/ATLAS), and [crop calendars](https://zenodo.org/records/5062513). Using the R workflows mentioned below the hazard values were summarized for each 3 month window as well as the annual average and extracted by administrative boundaries to generate a tabular parquet dataset.`,\n          fr: md`[Les risques climatiques](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/hazard_catalog/catalog.json) ont été calculés à l'aide de cinq ensembles de données : [CHIRPS](https://www.chc.ucsb.edu/data/chirps)/[CHIRTS](https://www.chc.ucsb.edu/data/chirtsdaily), [AgERA5](https://doi.org/10.24381/cds.6c68c9bb), [projections CMIP6](https://github.com/SantanderMetGroup/ATLAS) et [calendriers de cultures](https://zenodo.org/records/5062513). À l'aide des flux de travail R mentionnés ci-dessous, les valeurs de risque ont été résumées pour chaque fenêtre de 3 mois ainsi que la moyenne annuelle et extraites par limites administratives pour générer un ensemble de données de parquet tabulaire.`,\n        },\n      },\n    },\n  },\n  STAC: {\n    title: {\n      en: \"Learn about the data in the Atlas STAC\",\n      fr: \"En savoir plus sur les données dans l'Atlas STAC\",\n    },\n    text: {\n      en: `Browse and access data through the [STAC (Spatio Temporal Asset Catalog)](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/catalog.json) for all datasets related to the Africa Agriculture Adaptation Atlas. The data provided in this notebook is limited to our processed and admin level datasets. However, raster data for all of our analysis can be found and downloaded using our STAC and S3 bucket. The below example will walk you through how to explore and access the data using the STAC in R or Python, or explore the data using the no-code interface.`,\n      fr: `Parcourez et accédez aux données via le [STAC (Catalogue d'Actifs Spatio-Temporels)](https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/catalog.json) pour tous les ensembles de données liés à l'Atlas Africain d'Adaptation Agricole. Les données fournies dans ce notebook se limitent à nos ensembles de données traités et au niveau administratif. Cependant, les données raster pour toutes nos analyses peuvent être trouvées et téléchargées en utilisant notre STAC et notre bucket S3. L'exemple ci-dessous vous guidera sur la manière d'explorer et d'accéder aux données en utilisant le STAC en R ou Python, ou d'explorer les données en utilisant l'interface sans code.`,\n    },\n  },\n  general: {\n    hazards: {\n      HSH_mean: {\n        en: \"Mean Human Heat Stress\",\n        fr: \"Stress thermique humain moyen\",\n      },\n      HSH_max: {\n        en: \"Max Human Heat Stress\",\n        fr: \"Stress thermique humain maximal\",\n      },\n      NDWL0: {\n        en: \"Number of Waterlogging Days\",\n        fr: \"Nombre de jours de saturation en eau\",\n      },\n      NDWS: {\n        en: \"Number of Days of Water Stress\",\n        fr: \"Nombre de jours de stress hydrique\",\n      },\n      NTx35: {\n        en: \"Number of Heat Stress Days for Maize\",\n        fr: \"Nombre de jours de stress thermique pour le maïs\",\n      },\n      NTx40: {\n        en: \"Number of Heat Stress Days for Generic Crops\",\n        fr: \"Nombre de jours de stress thermique pour les cultures génériques\",\n      },\n      TAI: {\n        en: \"Thornthwaite's Aridity Index\",\n        fr: \"Indice d'Aridité de Thornthwaite\",\n      },\n      THI_max: {\n        en: \"Max Cattle Thermal Humidity Index\",\n        fr: \"Indice de Température-Humidité Maximal pour le Bétail\",\n      },\n      THI_mean: {\n        en: \"Mean Cattle Thermal Humidity Index\",\n        fr: \"Indice de Température-Humidité Moyen pour le Bétail \",\n      },\n      TAVG: { en: \"Average Temperature\", fr: \"Température Moyenne\" },\n      PTOT: { en: \"Total Precipitation\", fr: \"Précipitation Totale\" },\n    },\n    commodities: {\n      wheat: { en: \"Wheat\", fr: \"Blé\" },\n      rice: { en: \"Rice\", fr: \"Riz\" },\n      maize: { en: \"Maize\", fr: \"Maïs\" },\n      barley: { en: \"Barley\", fr: \"Orge\" },\n      \"pearl millet\": { en: \"Pearl Millet\", fr: \"Millet Perlé\" },\n      \"small millet\": { en: \"Small Millet\", fr: \"Petit Millet\" },\n      sorghum: { en: \"Sorghum\", fr: \"Sorgho\" },\n      potato: { en: \"Potato\", fr: \"Pomme de Terre\" },\n      \"sweet potato\": { en: \"Sweet Potato\", fr: \"Patate Douce\" },\n      yams: { en: \"Yams\", fr: \"Igname\" },\n      cassava: { en: \"Cassava\", fr: \"Manioc\" },\n      bean: { en: \"Bean\", fr: \"Haricot\" },\n      chickpea: { en: \"Chickpea\", fr: \"Pois Chiche\" },\n      cowpea: { en: \"Cowpea\", fr: \"Niébé\" },\n      pigeonpea: { en: \"Pigeonpea\", fr: \"Pois Cajan\" },\n      lentil: { en: \"Lentil\", fr: \"Lentille\" },\n      soybean: { en: \"Soybean\", fr: \"Soja\" },\n      groundnut: { en: \"Groundnut\", fr: \"Arachide\" },\n      coconut: { en: \"Coconut\", fr: \"Noix de Coco\" },\n      oilpalm: { en: \"Oil Palm\", fr: \"Palmier à Huile\" },\n      sunflower: { en: \"Sunflower\", fr: \"Tournesol\" },\n      rapeseed: { en: \"Rapeseed\", fr: \"Colza\" },\n      sesameseed: { en: \"Sesame Seed\", fr: \"Graines de Sésame\" },\n      sugarcane: { en: \"Sugarcane\", fr: \"Canne à Sucre\" },\n      sugarbeet: { en: \"Sugarbeet\", fr: \"Betterave à Sucre\" },\n      cotton: { en: \"Cotton\", fr: \"Coton\" },\n      \"arabica coffee\": { en: \"Arabica Coffee\", fr: \"Café Arabica\" },\n      \"robusta coffee\": { en: \"Robusta Coffee\", fr: \"Café Robusta\" },\n      cocoa: { en: \"Cocoa\", fr: \"Cocoa\" },\n      tea: { en: \"Tea\", fr: \"thé\" },\n      tobacco: { en: \"Tobacco\", fr: \"Tabac\" },\n      banana: { en: \"Banana\", fr: \"Banane\" },\n      plantain: { en: \"Plantain\", fr: \"Banane Plantain\" },\n      cattle_tropical: { en: \"Tropical Cattle\", fr: \"Bovins tropicaux\" },\n      poultry_tropical: { en: \"Tropical Poultry\", fr: \"Volaille tropicale\" },\n      pigs_tropical: { en: \"Tropical Pigs\", fr: \"Porcs tropicaux\" },\n      sheep_tropical: { en: \"Tropical Sheep\", fr: \"Moutons tropicaux\" },\n      goats_tropical: { en: \"Tropical Goats\", fr: \"Chèvres tropicales\" },\n      cattle_highland: {\n        en: \"Highland Cattle\",\n        fr: \"Bovins des hauts plateaux\",\n      },\n      poultry_highland: {\n        en: \"Highland Poultry\",\n        fr: \"Volaille des hauts plateaux\",\n      },\n      pigs_highland: { en: \"Highland Pigs\", fr: \"Porcs des hauts plateaux\" },\n      sheep_highland: {\n        en: \"Highland Sheep\",\n        fr: \"Moutons des hauts plateaux\",\n      },\n      goats_highland: {\n        en: \"Highland Goats\",\n        fr: \"Chèvres des hauts plateaux\",\n      },\n    },\n    adminlevels: {\n      admin0_name: { en: \"Country\", fr: \"Pays\" },\n      admin1_name: { en: \"Region\", fr: \"Région\" },\n      admin2_name: { en: \"Sub-Region\", fr: \"Sous-région\" },\n    },\n    levels: {\n      low: { en: \"Low\", fr: \"Faible\" },\n      moderate: { en: \"Moderate\", fr: \"Modéré\" },\n      severe: { en: \"Severe\", fr: \"Sévère\" },\n      extreme: { en: \"Extreme\", fr: \"Extrême\" },\n      Vextreme: { en: \"Very Extreme\", fr: \"Très Extrême\" },\n    },\n    search: { en: \"Search\", fr: \"Rechercher\" },\n    acVars: {\n      domestic_violence: {\n        en: \"Domestic Safety\",\n        fr: \"Sécurité Domestique\",\n      },\n      gender_equity: {\n        en: \"Gender Equity\",\n        fr: \"Égalité des sexes\",\n      },\n      decision_making: {\n        en: \"Decision Making Power\",\n        fr: \"Pouvoir de décision\",\n      },\n      education: {\n        en: \"Womens Education\",\n        fr: \"Éducation des femmes\",\n      },\n      family_planning: {\n        en: \"Access to Family Planning\",\n        fr: \"Accès à la planification familiale\",\n      },\n      reproductive_health: {\n        en: \"Reproductive Health\",\n        fr: \"Santé reproductive\",\n      },\n      GSAP_poor215: {\n        en: \"% population under $2.15\",\n        fr: \"% de la population sous 2,15$\",\n      },\n      GSAP_poor365: {\n        en: \"% population under $3.65\",\n        fr: \"% de la population sous 3,65$\",\n      },\n      GSAP_poor685: {\n        en: \"% population under $6.85\",\n        fr: \"% de la population sous 6,85$\",\n      },\n      educationYrs: {\n        en: \"Education(Yrs)\",\n        fr: \"Éducation (années)\",\n      },\n    },\n    adminNames: {\n      \"Full Country\": { en: \"Full Country\", fr: \"Pays Entier\" },\n      \"Full Region\": { en: \"Full Region\", fr: \"Région complète\" },\n      Angola: {\n        en: \"Angola\",\n        fr: \"Angola\",\n      },\n      Benin: {\n        en: \"Benin\",\n        fr: \"Bénin\",\n      },\n      Botswana: {\n        en: \"Botswana\",\n        fr: \"Botswana\",\n      },\n      \"Burkina Faso\": {\n        en: \"Burkina Faso\",\n        fr: \"Burkina Faso\",\n      },\n      Burundi: {\n        en: \"Burundi\",\n        fr: \"Burundi\",\n      },\n      Cameroon: {\n        en: \"Cameroon\",\n        fr: \"Cameroun\",\n      },\n      \"Central African Republic\": {\n        en: \"Central African Republic\",\n        fr: \"République Centrafricaine\",\n      },\n      Chad: {\n        en: \"Chad\",\n        fr: \"Tchad\",\n      },\n      \"Congo - Brazzaville\": {\n        en: \"Congo - Brazzaville\",\n        fr: \"Congo - Brazzaville\",\n      },\n      \"Congo - Kinshasa\": {\n        en: \"Congo - Kinshasa\",\n        fr: \"Congo - Kinshasa\",\n      },\n      \"Côte d’Ivoire\": {\n        en: \"Côte d’Ivoire\",\n        fr: \"Côte d’Ivoire\",\n      },\n      Djibouti: {\n        en: \"Djibouti\",\n        fr: \"Djibouti\",\n      },\n      \"Equatorial Guinea\": {\n        en: \"Equatorial Guinea\",\n        fr: \"Guinée Équatoriale\",\n      },\n      Eritrea: {\n        en: \"Eritrea\",\n        fr: \"Érythrée\",\n      },\n      Eswatini: {\n        en: \"Eswatini\",\n        fr: \"Eswatini\",\n      },\n      Ethiopia: {\n        en: \"Ethiopia\",\n        fr: \"Éthiopie\",\n      },\n      Gabon: {\n        en: \"Gabon\",\n        fr: \"Gabon\",\n      },\n      Gambia: {\n        en: \"Gambia\",\n        fr: \"Gambie\",\n      },\n      Ghana: {\n        en: \"Ghana\",\n        fr: \"Ghana\",\n      },\n      Guinea: {\n        en: \"Guinea\",\n        fr: \"Guinée\",\n      },\n      \"Guinea-Bissau\": {\n        en: \"Guinea-Bissau\",\n        fr: \"Guinée-Bissau\",\n      },\n      Kenya: {\n        en: \"Kenya\",\n        fr: \"Kenya\",\n      },\n      Lesotho: {\n        en: \"Lesotho\",\n        fr: \"Lesotho\",\n      },\n      Liberia: {\n        en: \"Liberia\",\n        fr: \"Libéria\",\n      },\n      Madagascar: {\n        en: \"Madagascar\",\n        fr: \"Madagascar\",\n      },\n      Malawi: {\n        en: \"Malawi\",\n        fr: \"Malawi\",\n      },\n      Mali: {\n        en: \"Mali\",\n        fr: \"Mali\",\n      },\n      Mauritania: {\n        en: \"Mauritania\",\n        fr: \"Mauritanie\",\n      },\n      Mozambique: {\n        en: \"Mozambique\",\n        fr: \"Mozambique\",\n      },\n      Namibia: {\n        en: \"Namibia\",\n        fr: \"Namibie\",\n      },\n      Niger: {\n        en: \"Niger\",\n        fr: \"Niger\",\n      },\n      Nigeria: {\n        en: \"Nigeria\",\n        fr: \"Nigéria\",\n      },\n      Rwanda: {\n        en: \"Rwanda\",\n        fr: \"Rwanda\",\n      },\n      Senegal: {\n        en: \"Senegal\",\n        fr: \"Sénégal\",\n      },\n      \"Sierra Leone\": {\n        en: \"Sierra Leone\",\n        fr: \"Sierra Leone\",\n      },\n      Somalia: {\n        en: \"Somalia\",\n        fr: \"Somalie\",\n      },\n      \"South Africa\": {\n        en: \"South Africa\",\n        fr: \"Afrique du Sud\",\n      },\n      \"South Sudan\": {\n        en: \"South Sudan\",\n        fr: \"Soudan du Sud\",\n      },\n      Sudan: {\n        en: \"Sudan\",\n        fr: \"Soudan\",\n      },\n      Tanzania: {\n        en: \"Tanzania\",\n        fr: \"Tanzanie\",\n      },\n      Togo: {\n        en: \"Togo\",\n        fr: \"Togo\",\n      },\n      Uganda: {\n        en: \"Uganda\",\n        fr: \"Ouganda\",\n      },\n      Zambia: {\n        en: \"Zambia\",\n        fr: \"Zambie\",\n      },\n      Zimbabwe: {\n        en: \"Zimbabwe\",\n        fr: \"Zimbabwe\",\n      },\n      SSA: {\n        en: \"Sub-Saharan Africa\",\n        fr: \"Afrique Subsaharienne\",\n      },\n      \"Sub-Saharan Africa\": {\n        en: \"Sub-Saharan Africa\",\n        fr: \"Afrique Subsaharienne\",\n      },\n    },\n    units: {\n      index: { en: \"Index\", fr: \"Indice\" },\n      days: { en: \"Days\", fr: \"Jours\" },\n      yrs: { en: \"Years\", fr: \"Années\" },\n      num_people: { en: \"Num. People\", fr: \"Nb. Personnes\" },\n      num_animals: { en: \"Num. Animals\", fr: \"Nb. Animaux\" },\n    },\n    NoCode: { en: \"No Code\", fr: \"Sans Code\" },\n  },\n});\n\n\n\n\n\n\n\ndefinitionText = new Object({\n  Hazard: {\n    title: { en: \"Hazard Definitions\", fr: \"Définitions des Aléas\" },\n    text: {\n      en: `#### Max Human Heat Stress (HSH_max):  \n**Thresholds:**\n\n| Hazard Level | Value |\n|--------------|----------------------------|\n| Low          | ≤ 27                       |\n| Moderate     | &gt; 27 and ≤ 32              |\n| High         | &gt; 32 and ≤ 41              |\n| Extreme      | &gt; 41 and ≤ 54              |\n| Very Extreme | &gt; 54                       |\n\n**Definition:** Human heat stress index, maximum value of the growing season.  \n**Description:** The heat index (HI) is calculated using daily data and empirical equations based on Steadman (1979a; 1979b), relating the HI to dry-bulb temperature (°C) and relative humidity (%). The maximum value for each month is first calculated, followed by the climatological mean of each month, and then the maximum, mean, and median of the year.  \n**Units:** Index (HI)  \n\n#### Mean Human Heat Stress (HSH_mean):  \n**Thresholds:** \n\n| Hazard Level | Value |\n|--------------|----------------------------|\n| Low          | ≤ 27                       |\n| Moderate     | &gt; 27 and ≤ 32              |\n| High         | &gt; 32 and ≤ 41              |\n| Extreme      | &gt; 41 and ≤ 54              |\n| Very Extreme | &gt; 54                       |\n\n**Definition:** Human heat stress index, mean of the growing season.  \n**Description:** The heat index (HI) is calculated using daily data and empirical equations based on Steadman (1979a; 1979b), relating the HI to dry-bulb temperature (°C) and relative humidity (%). The mean value for each month is first calculated, followed by the climatological mean of each month, and then the maximum, mean, and median of the year.  \n**Units:** Index (HI)  \n\n#### Number of Waterlogging Days (NDWL0):  \n**Thresholds:**   \n\n| Hazard Level | Value |\n|--------------|----------------------------|\n| Low          | ≤ 2                        |\n| Moderate     | &gt; 2 and ≤ 5                |\n| High         | &gt; 2 and ≤ 8                |\n| Extreme      | &gt; 8                        |\n\n**Definition:** Total number of waterlogging days (at starting saturation, 0%) per season.  \n**Description:** A waterlogging day occurs when the soil moisture is just above field capacity and moving toward saturation. This index is calculated using a simple water balance model that utilizes daily precipitation from CHIRPS, daily temperatures from CHIRTS, and solar radiation from AgERA5.  \n**Units:** Days  \n\n#### Number of Days of Water Stress (NDWS):  \n**Thresholds:**   \n\n| Hazard Level | Value |\n|--------------|----------------------------|\n| Low          | ≤ 15                       |\n| Moderate     | &gt; 15 and ≤ 20              |\n| High         | &gt; 20 and ≤ 25              |\n| Extreme      | &gt; 25                       |\n\n**Definition:** Total number of water stress days per season.  \n**Description:** A water stress day is defined as a day in which the ratio of actual to potential evapotranspiration is less than 0.5. This index is calculated using a simple water balance model that utilizes daily precipitation from CHIRPS, daily temperatures from CHIRTS, and solar radiation from AgERA5.  \n**Units:** Days  \n\n#### Number of Heat Stress Days for Maize (NTx35):  \n**Thresholds:**  \n\n| Hazard Level | Value |\n|--------------|----------------------------|\n| Low          | ≤ 10                       |\n| Moderate     | &gt; 10 and ≤ 20              |\n| High         | &gt; 20 and ≤ 25              |\n| Extreme      | &gt; 25                       |\n\n**Definition:** Total number of heat stress days per season for maize.  \n**Description:** The number of days with daily maximum temperatures above 35°C during the growing season, using a maize crop calendar.  \n**Units:** Days  \n\n#### Number of Heat Stress Days for Generic Crops (NTx40):  \n**Thresholds:**  \n\n| Hazard Level | Value |\n|--------------|----------------------------|\n| Low          | ≤ 1                        |\n| Moderate     | &gt; 1 and ≤ 5                |\n| High         | &gt; 5 and ≤ 10               |\n| Extreme      | &gt; 10                       |\n\n**Definition:** Total number of heat stress days per season for generic crops.  \n**Description:** The number of days with daily maximum temperatures above 40°C per month, without using a crop calendar.  \n**Units:** Days  \n\n#### Thornthwaite's Aridity Index (TAI):  \n**Thresholds:**   \n\n| Hazard Level | Value |\n|--------------|----------------------------|\n| Low          | ≤ 40                       |\n| Moderate     | &gt; 40 and ≤ 60              |\n| High         | &gt; 60 and ≤ 80              |\n| Extreme      | &gt; 80                       |\n\n**Definition:** Thornthwaite's Aridity Index.  \n**Description:** The Thornthwaite aridity index is calculated as 100 X (d / n), where d is the sum of monthly differences between precipitation and PET for months where precipitation is less than PET, and n is the sum of monthly PET for those months.  \n**Units:** Index  \n\n#### Max Cattle Thermal Humidity Index (THI_max):  \n**Thresholds:**   \n\n| Hazard Level | Value |\n|--------------|----------------------------|\n| Low          | ≤ 72                       |\n| Moderate     | &gt; 72 and ≤ 78              |\n| High         | &gt; 78 and ≤ 90              |\n| Extreme      | &gt; 90                       |\n\n**Definition:** Cattle thermal humidity index, maximum value of the season.  \n**Description:** The heat index (HI) for cattle is calculated using daily data and empirical equations based on Rahimi et al. (2020). The THI is calculated as THI1 = (1.8 × Tdb + 32) - [(0.55 - 0.0055 × RH) × (1.8 × Tdb - 26.8)], where Tdb is the dry bulb temperature (maximum temperature, °C), and RH is the relative humidity (%).  \n**Units:** Index (THI)  \n\n#### Mean Cattle Thermal Humidity Index (THI_mean):  \n**Thresholds:**   \n\n| Hazard Level | Value |\n|--------------|----------------------------|\n| Low          | ≤ 72                       |\n| Moderate     | &gt; 72 and ≤ 78              |\n| High         | &gt; 78 and ≤ 90              |\n| Extreme      | &gt; 90                       |\n\n**Definition:** Cattle thermal humidity index, mean value of the season.  \n**Description:** The heat index (HI) for cattle is calculated using daily data and empirical equations based on Rahimi et al. (2020). The THI is calculated as THI1 = (1.8 × Tdb + 32) - [(0.55 - 0.0055 × RH) × (1.8 × Tdb - 26.8)], where Tdb is the dry bulb temperature (maximum temperature, °C), and RH is the relative humidity (%).  \n**Units:** Index (THI)  \n\n#### Average Temperature (TAVG):  \n**Thresholds:**  \n\n| Hazard Level | Value |\n|--------------|----------------------------|\n| Low          | ≤ 33                       |\n| Moderate     | &gt; 33 and ≤ 36              |\n| High         | &gt; 38 and ≤ 47              |\n| Extreme      | &gt; 47                       |\n\n**Definition:** Mean temperature.  \n**Description:** The average temperature for a given period, typically calculated as the mean of daily temperatures.  \n**Units:** °C  \n\n#### Total Precipitation (PTOT):  \n**Thresholds:**  \n\n| Hazard Level | Value |\n|--------------|----------------------------|\n| Low          | ≤ 1200                     |\n| Moderate     | &gt; 1200 and ≤ 1600          |\n| High         | &gt; 1600 and ≤ 1800          |\n| Extreme      | &gt; 1800                     |\n\n**Definition:** Total precipitation.  \n**Description:** The total amount of precipitation accumulated over a specific period, typically a month or year.  \n**Units:** mm`,\n      fr: `#### Stress thermique humain maximal (HSH_max):  \n**Seuils:**  \n\n| Niveau d'Aléas | Valeur |\n|----------------|----------------------------|\n| Faible         | ≤ 27                       |\n| Modéré         | &gt; 27 et ≤ 32               |\n| Sévère         | &gt; 32 et ≤ 41               |\n| Extrême        | &gt; 41 et ≤ 54               |\n| Très Extrême   | &gt; 54                       |\n\n**Définition:** Indice de stress thermique humain, valeur maximale de la saison de croissance.  \n**Description:** L'indice de chaleur (HI) est calculé en utilisant des données quotidiennes et des équations empiriques basées sur Steadman (1979a; 1979b), reliant le HI à la température de l'air sec (°C) et à l'humidité relative (%). La valeur maximale pour chaque mois est d'abord calculée, suivie de la moyenne climatologique de chaque mois, puis des valeurs maximale, moyenne et médiane de l'année.  \n**Unités:** Indice (HI)  \n\n#### Stress thermique humain moyen (HSH_mean):  \n**Seuils:**  \n\n| Niveau d'Aléas | Valeur |\n|----------------|----------------------------|\n| Faible         | ≤ 27                       |\n| Modéré         | &gt; 27 et ≤ 32               |\n| Sévère         | &gt; 32 et ≤ 41               |\n| Extrême        | &gt; 41 et ≤ 54               |\n| Très Extrême   | &gt; 54                       |\n\n**Définition:** Indice de stress thermique humain, moyenne de la saison de croissance.  \n**Description:** L'indice de chaleur (HI) est calculé en utilisant des données quotidiennes et des équations empiriques basées sur Steadman (1979a; 1979b), reliant le HI à la température à bulbe sec (°C) et à l'humidité relative (%). La valeur moyenne pour chaque mois est d'abord calculée, suivie de la moyenne climatologique de chaque mois, puis des valeurs maximale, moyenne et médiane de l'année.  \n**Unités:** Indice (HI)  \n\n#### Nombre de jours de saturation en eau (NDWL0):  \n**Seuils:**    \n\n| Niveau d'Aléas | Valeur |\n|----------------|----------------------------|\n| Faible         | ≤ 2                        |\n| Modéré         | &gt; 2 et ≤ 5                 |\n| Sévère         | &gt; 5 et ≤ 8                 |\n| Extrême        | &gt; 8                        |\n\n**Définition:** Nombre total de jours de saturation en eau (à saturation initiale, 0 %) par saison.  \n**Description:** Un jour de saturation en eau se produit lorsque l'humidité du sol est juste au-dessus de la capacité au champ et se dirige vers la saturation. Cet indice est calculé en utilisant un modèle simple de bilan hydrique qui utilise les précipitations quotidiennes de CHIRPS, les températures quotidiennes de CHIRTS et le rayonnement solaire d'AgERA5.  \n**Unités:** Jours  \n\n#### Nombre de jours de stress hydrique (NDWS):  \n**Seuils:**  \n\n| Niveau d'Aléas | Valeur |\n|----------------|----------------------------|\n| Faible         | ≤ 15                       |\n| Modéré         | &gt; 15 et ≤ 20               |\n| Sévère         | &gt; 20 et ≤ 25               |\n| Extrême        | &gt; 25                       |\n\n**Définition:** Nombre total de jours de stress hydrique par saison.  \n**Description:** Un jour de stress hydrique est défini comme un jour où le ratio de l'évapotranspiration réelle à l'évapotranspiration potentielle est inférieur à 0,5. Cet indice est calculé en utilisant un modèle simple de bilan hydrique qui utilise les précipitations quotidiennes de CHIRPS, les températures quotidiennes de CHIRTS et le rayonnement solaire d'AgERA5.  \n**Unités:** Jours  \n\n#### Nombre de jours de stress thermique pour le maïs (NTx35):  \n**Seuils:**   \n\n| Niveau d'Aléas | Valeur |\n|----------------|----------------------------|\n| Faible         | ≤ 10                       |\n| Modéré         | &gt; 10 et ≤ 20               |\n| Sévère         | &gt; 20 et ≤ 25               |\n| Extrême        | &gt; 25                       |\n\n**Définition:** Nombre total de jours de stress thermique par saison pour le maïs.  \n**Description:** Le nombre de jours avec des températures maximales quotidiennes au-dessus de 35 °C pendant la saison de croissance, en utilisant un calendrier de culture du maïs.  \n**Unités:** Jours  \n\n#### Nombre de jours de stress thermique pour les cultures génériques (NTx40):  \n**Seuils:**   \n\n| Niveau d'Aléas | Valeur |\n|----------------|----------------------------|\n| Faible         | ≤ 1                        |\n| Modéré         | &gt; 1 et ≤ 5                 |\n| Sévère         | &gt; 5 et ≤ 10                |\n| Extrême        | &gt; 10                       |\n\n**Définition:** Nombre total de jours de stress thermique par saison pour les cultures génériques.  \n**Description:** Le nombre de jours avec des températures maximales quotidiennes au-dessus de 40 °C par mois, sans utiliser de calendrier de culture.  \n**Unités:** Jours  \n\n#### Indice d'Aridité de Thornthwaite (TAI):  \n**Seuils:**   \n\n| Niveau d'Aléas | Valeur |\n|----------------|----------------------------|\n| Faible         | ≤ 40                       |\n| Modéré         | &gt; 40 et ≤ 60               |\n| Sévère         | &gt; 60 et ≤ 80               |\n| Extrême        | &gt; 80                       |\n\n**Définition:** Indice d'aridité de Thornthwaite.  \n**Description:** L'indice d'aridité de Thornthwaite est calculé comme 100 × (d / n), où d est la somme des différences mensuelles entre les précipitations et l'ETP pour les mois où les précipitations sont inférieures à l'ETP, et n est la somme mensuelle de l'ETP pour ces mois.  \n**Unités:** Indice  \n\n#### Indice de Température-Humidité Maximal pour le Bétail (THI_max):  \n**Seuils:**  \n\n| Niveau d'Aléas | Valeur |\n|----------------|----------------------------|\n| Faible         | ≤ 72                       |\n| Modéré         | &gt; 72 et ≤ 78               |\n| Sévère         | &gt; 78 et ≤ 90               |\n| Extrême        | &gt; 90                       |\n\n**Définition:** Indice de température-humidité pour le bétail, valeur maximale de la saison.  \n**Description:** L'indice de chaleur (HI) pour le bétail est calculé en utilisant des données quotidiennes et des équations empiriques basées sur Rahimi et al. (2020). Le THI est calculé comme THI1 = (1,8 × Tdb + 32) - [(0,55 - 0,0055 × RH) × (1,8 × Tdb - 26,8)], où Tdb est la température à bulbe sec (température maximale, °C), et RH est l'humidité relative (%).  \n**Unités:** Indice (THI)  \n\n#### Indice de Température-Humidité Moyen pour le Bétail (THI_mean):  \n**Seuils:**  \n\n| Niveau d'Aléas | Valeur |\n|----------------|----------------------------|\n| Faible         | ≤ 72                       |\n| Modéré         | &gt; 72 et ≤ 78               |\n| Sévère         | &gt; 78 et ≤ 90               |\n| Extrême        | &gt; 90                       |\n\n**Définition:** Indice de température-humidité pour le bétail, valeur moyenne de la saison.  \n**Description:** L'indice de chaleur (HI) pour le bétail est calculé en utilisant des données quotidiennes et des équations empiriques basées sur Rahimi et al. (2020). Le THI est calculé comme THI1 = (1,8 × Tdb + 32) - [(0,55 - 0,0055 × RH) × (1,8 × Tdb - 26,8)], où Tdb est la température à bulbe sec (température maximale, °C), et RH est l'humidité relative (%).  \n**Unités:** Indice (THI)  \n\n#### Température Moyenne (TAVG):  \n**Seuils:**  \n\n| Niveau d'Aléas | Valeur |\n|----------------|----------------------------|\n| Faible         | ≤ 33                       |\n| Modéré         | &gt; 33 et ≤ 36               |\n| Sévère         | &gt; 36 et ≤ 47               |\n| Extrême        | &gt; 47                       |\n\n**Définition:** Température moyenne.  \n**Description:** La température moyenne pour une période donnée, généralement calculée comme la moyenne des températures quotidiennes.  \n**Unités:** °C  \n\n#### Précipitation Totale (PTOT):  \n**Seuils:**  \n\n| Niveau d'Aléas | Valeur |\n|----------------|----------------------------|\n| Faible         | ≤ 1200                     |\n| Modéré         | &gt; 1200 et ≤ 1600           |\n| Sévère         | &gt; 1600 et ≤ 1800           |\n| Extrême        | &gt; 1800                     |\n\n**Définition:** Précipitation totale.  \n**Description:** La quantité totale de précipitations accumulées sur une période spécifique, généralement un mois ou une année.  \n**Unités:** mm`,\n    },\n  },\n  Exposure: {\n    title: { en: \"Exposure Definitions\", fr: \"Définitions de l'Exposition\" },\n    text: {\n      en: `#### Value Of Production (VOP):  \n**Unit:** International Dollar for 2005 (Int$2005)  \n**Description:** Value of Production (VOP) represents the total economic value of agricultural goods produced within a specified area.\n\n#### Harvested Area (HA):\n**Unit:** Hectare (ha)  \n**Description:** Harvested area (HA) is the total land area, measured in hectares (ha), used for the cultivation of a crop within a given region.\n\n#### Livestock Head (number):\n**Unit:** Total  \n**Description:** Livestock head refers to the total number of animals present in a given area.`,\n      fr: `#### La Valeur de la Production (VOP)\n**Unité:** Dollar International de 2005 (Int$2005)  \n**Description:** La Valeur de la Production représente la valeur économique totale des biens agricoles produits dans une zone spécifiée.  \n\n#### Superficie Récoltée (HA):\n**Unité:** Hectare (ha)  \n**Description:** La superficie récoltée est la superficie totale des terres, mesurée en hectares (ha), utilisée pour la culture d'une récolte dans une région donnée. \n\n#### Effectif du Bétail (nombre): \n**Unité:** Total  \n**Description:** L'effectif du bétail fait référence au nombre total d'animaux présents dans une zone administrative donnée.`,\n    },\n  },\n  Vulnerability: {\n    title: {\n      en: \"Adaptive Capacity Definitions\",\n      fr: \"Définitions de la Capacité d'Adaptation\",\n    },\n    text: {\n      en: `#### Education: \n**Description:** Years of education across the population (combined male and female)  \n**Unit:** Years\n\n#### Poverty: \n**Description:** Percent of Population underneath the provided poverty line  \n**Unit:** % of Population\n\n#### Gender: \n**Description:** A set of indexes showing female well-being. All are normalized between 0-1 where 0 is poor and 1 is good.  \n**Unit:** Index\n`,\n      fr: `#### Éducation: \n**Description:**  Nombre d'années d'éducation dans la population (hommes et femmes combinés)  \n**Unité:** Années\n\n#### Pauvreté: \n**Description:** Pourcentage de la population en dessous du seuil de pauvreté fourni.  \n**Unité:** % de la population\n\n#### Genre: \n**Description:** Un ensemble d'indices montrant le bien-être des femmes. Tous sont normalisés entre 0 et 1, où 0 est mauvais et 1 est bon.  \n**Unité:** Indice\n`,\n    },\n  },\n});"
  },
  {
    "objectID": "docs/translation.html",
    "href": "docs/translation.html",
    "title": "Lang Module Guide",
    "section": "",
    "text": "Author: Zach Bogart, Brayden Youngberg\nVersion: 2.0.1\n\n\nThe Lang module provides a set of helper functions to manage translations, template insertions, and string formatting in JavaScript notebooks and apps. It is especially useful for multi-language support and dynamic text replacement.\n\n\n\n\nDefine available languages with keys, labels, and locales:\n\nimport { lang as Lang } from \"/helpers/lang.js\"\n// or if running into errors due to cells running before the import: \n// const lang = await import(\"/helpers/lang.js\");\n// or if only needing the main lg function:\n// import { lg } from \"/helpers/lang.js\"\n\nlanguages = [\n  { key: \"en\", label: \"English\", locale: \"en-US\" },\n  { key: \"fr\", label: \"Français\", locale: \"fr-FR\" }\n];\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nStructure your translations as a nested object or external JSON, with language keys for each field:\n\nnbText = new Object({\n  \"hello\": {\n    \"en\": \"hello\",\n    \"fr\": \"Bonjour\"\n  },\n  \"error\": {\n    \"en\": \"Whoops\"\n  },\n  \"insert\": {\n    \"small\": {\n      \"en\": \"This is an insertion example: :::field:::\",\n      \"fr\": \"Ceci est un exemple d'insertion: :::field:::\"\n    },\n    \"big\": {\n      \"en\": \"This is an insertion example: :::field::: :::name:::\",\n      \"fr\": \"Ceci est un exemple d'insertion: :::field::: :::name:::\"\n    }\n  }\n})\n\n\n\n\n\n\n\n\n\nCreate a master toggle to pick the language key (Observable Inputs):\n\nviewof language = Inputs.radio(languages, {\n  label: \"Main language toggle\",\n  format: (d) =&gt; d.key,\n  value: languages.find((x) =&gt; x.key === defaultLangKey),\n})\n\n\n\n\n\n\nA “pretty” toggle with label that changes based on the language:\n\nNOTE: it is required to do this in a new Input, as there would be a circular definition otherwise\n\n\nviewof prettyLanguageView = {\n  return Inputs.bind(\n    Inputs.radio(languages, {\n      label: Lang.getText({en: \"Language\", fr: \"Langue\"}, { key: language.key }),\n      format: (d) =&gt; d.label\n    }),\n    viewof language\n  );\n}\n\n\n\n\n\n\n\n\n\nGet a translation for the current language:\n\nLang.getText(nbText.hello, { key: language.key });\n\n\n\n\n\n\n\n\nTo avoid repeating the language key, use lg:\n\n_lang = Lang.lg(language.key);\n_lang(nbText.hello);\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nReplace placeholders in template strings with dynamic values.\n\n\n\n{\n    const template = Lang.getText(nbText.insert.small, { key: language.key });\n    const items = [{ name: \"field\", value: \"hello world!\" }];\n    return Lang.reduceReplaceTemplateItems(template, items);\n}\n\n\n\n\n\n\n\n\n\n\n{\n    const template = Lang.getText(nbText.insert.big, { key: language.key });\n    const greeting = Lang.getText(nbText.hello, { key: language.key });\n    const items = [\n    { name: \"field\", value: greeting },\n    { name: \"name\", value: \"Alice\" }\n    ];\n    return Lang.reduceReplaceTemplateItems(template, items);\n}\n\n\n\n\n\n\n\n\n\n\n{\n    const customTemplate = \"This is a test: &gt;field&lt;\";\n    const result = Lang.reduceReplaceTemplateItems(\n        customTemplate,\n        [{ name: \"field\", value: \"hello world!\" }],\n        { start: \"&gt;\", end: \"&lt;\" }\n    );\n    return result\n}\n\n\n\n\n\n\n\n\n\n\nFind missing language keys in your text object:\n\nLang.listLeavesMissingObjectKeys(nbText, [\"en\", \"fr\"]);\n// Returns an array of paths to missing translations\n\n\n\n\n\n\n\n\n\n\nLang.toTitleCase(\"welcome to my home\");\n\n\n\n\n\n\n\nLang.toSentenceCase(\"welcome to my home\");\n\n\n\n\n\n\n\n\n\n\n\n\nSet the default language using a URL parameter (?lang=fr):\n\nqueryLanguage = await Lang.getParamFromList({\n  name: \"lang\",\n  list: languages.map((d) =&gt; d.key)\n});\n\ndefaultLangKey = queryLanguage ?? \"en\";\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nFunction\nDescription\n\n\n\n\nlg(defaultKey)\nReturns a function to fetch text for a default language key.\n\n\ngetText(textObj, { key })\nGets text for the specified language key.\n\n\ngetRegexForNamedInsertion(item, opts)\nReturns regex to match placeholders (default: :::item:::).\n\n\nreduceReplaceTemplateItems(...)\nReplaces all placeholders in a template with provided values.\n\n\nlistLeavesMissingObjectKeys(obj, keys)\nLists object leaves missing specified keys.\n\n\ngetParamFromList({ name, list, ... })\nReturns query parameter value if it exists in a provided list.\n\n\ntoTitleCase(str)\nConverts a string to title case.\n\n\ntoSentenceCase(str)\nConverts a string to sentence case.\n\n\n\n\nLinks: Observable Notebook Example\nHappy translating!"
  },
  {
    "objectID": "docs/translation.html#overview",
    "href": "docs/translation.html#overview",
    "title": "Lang Module Guide",
    "section": "",
    "text": "The Lang module provides a set of helper functions to manage translations, template insertions, and string formatting in JavaScript notebooks and apps. It is especially useful for multi-language support and dynamic text replacement."
  },
  {
    "objectID": "docs/translation.html#installation-defining-languages",
    "href": "docs/translation.html#installation-defining-languages",
    "title": "Lang Module Guide",
    "section": "",
    "text": "Define available languages with keys, labels, and locales:\n\nimport { lang as Lang } from \"/helpers/lang.js\"\n// or if running into errors due to cells running before the import: \n// const lang = await import(\"/helpers/lang.js\");\n// or if only needing the main lg function:\n// import { lg } from \"/helpers/lang.js\"\n\nlanguages = [\n  { key: \"en\", label: \"English\", locale: \"en-US\" },\n  { key: \"fr\", label: \"Français\", locale: \"fr-FR\" }\n];"
  },
  {
    "objectID": "docs/translation.html#setting-up-translation-json",
    "href": "docs/translation.html#setting-up-translation-json",
    "title": "Lang Module Guide",
    "section": "",
    "text": "Structure your translations as a nested object or external JSON, with language keys for each field:\n\nnbText = new Object({\n  \"hello\": {\n    \"en\": \"hello\",\n    \"fr\": \"Bonjour\"\n  },\n  \"error\": {\n    \"en\": \"Whoops\"\n  },\n  \"insert\": {\n    \"small\": {\n      \"en\": \"This is an insertion example: :::field:::\",\n      \"fr\": \"Ceci est un exemple d'insertion: :::field:::\"\n    },\n    \"big\": {\n      \"en\": \"This is an insertion example: :::field::: :::name:::\",\n      \"fr\": \"Ceci est un exemple d'insertion: :::field::: :::name:::\"\n    }\n  }\n})"
  },
  {
    "objectID": "docs/translation.html#language-toggle-ui-observable-example",
    "href": "docs/translation.html#language-toggle-ui-observable-example",
    "title": "Lang Module Guide",
    "section": "",
    "text": "Create a master toggle to pick the language key (Observable Inputs):\n\nviewof language = Inputs.radio(languages, {\n  label: \"Main language toggle\",\n  format: (d) =&gt; d.key,\n  value: languages.find((x) =&gt; x.key === defaultLangKey),\n})\n\n\n\n\n\n\nA “pretty” toggle with label that changes based on the language:\n\nNOTE: it is required to do this in a new Input, as there would be a circular definition otherwise\n\n\nviewof prettyLanguageView = {\n  return Inputs.bind(\n    Inputs.radio(languages, {\n      label: Lang.getText({en: \"Language\", fr: \"Langue\"}, { key: language.key }),\n      format: (d) =&gt; d.label\n    }),\n    viewof language\n  );\n}"
  },
  {
    "objectID": "docs/translation.html#retrieving-translations",
    "href": "docs/translation.html#retrieving-translations",
    "title": "Lang Module Guide",
    "section": "",
    "text": "Get a translation for the current language:\n\nLang.getText(nbText.hello, { key: language.key });\n\n\n\n\n\n\n\n\nTo avoid repeating the language key, use lg:\n\n_lang = Lang.lg(language.key);\n_lang(nbText.hello);"
  },
  {
    "objectID": "docs/translation.html#template-insertion",
    "href": "docs/translation.html#template-insertion",
    "title": "Lang Module Guide",
    "section": "",
    "text": "Replace placeholders in template strings with dynamic values.\n\n\n\n{\n    const template = Lang.getText(nbText.insert.small, { key: language.key });\n    const items = [{ name: \"field\", value: \"hello world!\" }];\n    return Lang.reduceReplaceTemplateItems(template, items);\n}\n\n\n\n\n\n\n\n\n\n\n{\n    const template = Lang.getText(nbText.insert.big, { key: language.key });\n    const greeting = Lang.getText(nbText.hello, { key: language.key });\n    const items = [\n    { name: \"field\", value: greeting },\n    { name: \"name\", value: \"Alice\" }\n    ];\n    return Lang.reduceReplaceTemplateItems(template, items);\n}\n\n\n\n\n\n\n\n\n\n\n{\n    const customTemplate = \"This is a test: &gt;field&lt;\";\n    const result = Lang.reduceReplaceTemplateItems(\n        customTemplate,\n        [{ name: \"field\", value: \"hello world!\" }],\n        { start: \"&gt;\", end: \"&lt;\" }\n    );\n    return result\n}"
  },
  {
    "objectID": "docs/translation.html#checking-for-missing-translations",
    "href": "docs/translation.html#checking-for-missing-translations",
    "title": "Lang Module Guide",
    "section": "",
    "text": "Find missing language keys in your text object:\n\nLang.listLeavesMissingObjectKeys(nbText, [\"en\", \"fr\"]);\n// Returns an array of paths to missing translations"
  },
  {
    "objectID": "docs/translation.html#string-formatting-helpers",
    "href": "docs/translation.html#string-formatting-helpers",
    "title": "Lang Module Guide",
    "section": "",
    "text": "Lang.toTitleCase(\"welcome to my home\");\n\n\n\n\n\n\n\nLang.toSentenceCase(\"welcome to my home\");"
  },
  {
    "objectID": "docs/translation.html#advanced-default-language-from-url",
    "href": "docs/translation.html#advanced-default-language-from-url",
    "title": "Lang Module Guide",
    "section": "",
    "text": "Set the default language using a URL parameter (?lang=fr):\n\nqueryLanguage = await Lang.getParamFromList({\n  name: \"lang\",\n  list: languages.map((d) =&gt; d.key)\n});\n\ndefaultLangKey = queryLanguage ?? \"en\";"
  },
  {
    "objectID": "docs/translation.html#api-reference",
    "href": "docs/translation.html#api-reference",
    "title": "Lang Module Guide",
    "section": "",
    "text": "Function\nDescription\n\n\n\n\nlg(defaultKey)\nReturns a function to fetch text for a default language key.\n\n\ngetText(textObj, { key })\nGets text for the specified language key.\n\n\ngetRegexForNamedInsertion(item, opts)\nReturns regex to match placeholders (default: :::item:::).\n\n\nreduceReplaceTemplateItems(...)\nReplaces all placeholders in a template with provided values.\n\n\nlistLeavesMissingObjectKeys(obj, keys)\nLists object leaves missing specified keys.\n\n\ngetParamFromList({ name, list, ... })\nReturns query parameter value if it exists in a provided list.\n\n\ntoTitleCase(str)\nConverts a string to title case.\n\n\ntoSentenceCase(str)\nConverts a string to sentence case.\n\n\n\n\nLinks: Observable Notebook Example\nHappy translating!"
  },
  {
    "objectID": "docs/doc_index.html",
    "href": "docs/doc_index.html",
    "title": "Adaptation Atlas Documentation Index",
    "section": "",
    "text": "Tips on Notebook Development\n\nGuidelines for Observable Notebooks\nNotebook Translation Guide"
  },
  {
    "objectID": "docs/nb_guidelines.html",
    "href": "docs/nb_guidelines.html",
    "title": "Overview",
    "section": "",
    "text": "Show the code\nimport { atlasHero } from \"/helpers/uiComponents.ojs\"\n\n{\n  let hero_url = \"./../images/default_crop.webp\"\n  return atlasHero(nbTitle, hero_url)\n}"
  },
  {
    "objectID": "docs/nb_guidelines.html#headers",
    "href": "docs/nb_guidelines.html#headers",
    "title": "Overview",
    "section": "Headers",
    "text": "Headers\nWe recommend using title case for headers. Main section headings should be a question which is answered by the narrative and figures in the following section. For example, instead of “Identifying Risk Hotspots”, consider using “Where Is Most At Risk?”\nTo best format the sections within the narrative, please use header tags:\n\nAdding “#” before text creates an H1 header. Use it for headings of main sections.\nAdding “##” before text creates an H2 header. Use it for chart titles.\nAdding “###” before text creates an H3 header. Use it for subtitles within charts and for titles for data insights related to charts.\n\nBecause our content requires dynamic headers for translation, the standard Quarto header syntax needs a slight adjustment. There are several ways to create dynamic headers, but the method described here is the most straightforward and closely aligned with standard Quarto formatting:\n```{ojs}\nheading1 = _lang({en: \"Heading 1\", fr: \"Titre 1\"}) // define ojs var for heading\n```\n\n# ``{ojs} heading1` {#example-heading2} &lt;!-- Use the ojs var as a heading & add an id--&gt;\nNote that the id for the heading is assigned. This is important for the TOC generation and is required."
  },
  {
    "objectID": "docs/nb_guidelines.html#table-of-contents",
    "href": "docs/nb_guidelines.html#table-of-contents",
    "title": "Overview",
    "section": "Table of Contents",
    "text": "Table of Contents\nWe have put together a table of contents function that should be used across notebooks. This can be imported from the ‘helpers’ directory. Below is an example of its use:\n\n\nShow the code\nimport { atlasTOC } from \"/helpers/uiComponents.ojs\"\n\ntoc_bottom = atlasTOC({\n  skip: ['notebook-title', 'appendix', 'source-code'], // heading ids to skip\n  heading: `&lt;b&gt;In This Notebook&lt;/b&gt;`,\n  selector: \"h1\", // Selectors to include (e.g., \"h1,h2,h3\")\n})\n\nhtl.html`\n      &lt;div class='floating-toc'&gt;\n      ${toc_bottom}\n      &lt;/div&gt;\n      `\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nNotice that by defining the id’s for each header, we can specify which ones to ignore in the TOC. The function defaults to only show h1 headers but this can be adjusted by changing the selector variable, but in general it should stay as h1. You can copy the code above to use in notebooks and it should work with no modifications."
  },
  {
    "objectID": "docs/nb_guidelines.html#dynamic-insights",
    "href": "docs/nb_guidelines.html#dynamic-insights",
    "title": "Overview",
    "section": "Dynamic Insights",
    "text": "Dynamic Insights\nAs can be seen in the “What’s at Risk” notebook, we have developed dynamic insights within the text that changes based on the selection of various controls throughout the tool. To emphasize that this text is dynamic, we bold the dynamic portion of the sentence.\nDynamic Insights are to be placed in a subsection with an H3 header ““###”” below each visualization at the end of each main section.\nThese dynamic insights can be in partial or full sentence form, and in either an bulleted list or not (could vary depending on the specific insight)."
  },
  {
    "objectID": "docs/nb_guidelines.html#color-scales",
    "href": "docs/nb_guidelines.html#color-scales",
    "title": "Overview",
    "section": "Color Scales",
    "text": "Color Scales\nBelow are some example linear color scales you can use, all defined by endpoint color values.\nPlease note that color scales may need to be designed on a chart-by-chart basis. The color scales listed below are a few developed for various charts in the “What’s at Risk?” and “On-farm Solutions for Today” notebooks.\nRegarding the direction to apply the scales, we have been mapping green (from the yellowGreen scale) to normatively “better” values and red (from the orangeRed scale) to normatively “worse” values.\n\n\nShow the code\ncolorScales = [\n  { name: \"yellowGreen\", range: [\"#F7D732\", \"#216729\"] },\n  { name: \"orangeRed\", range: [\"#F4BB21\", \"#EC5A47\"] }\n]\n\nviewof select = Inputs.select(colorScales, {label: \"Show a color scale\", format: x =&gt; x.name})\n\nPlot.plot({\n  color: {\n    type: \"linear\",\n    range: select.range,\n  },\n  marks: [\n    Plot.cell(d3.range(50), {x: d =&gt; d, fill: d =&gt; d})\n  ],\n  axis: null,\n  height: 30,\n  x: {padding: -0.1},\n  width: 600\n})\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nShow the code\nviewof copyImport = Inputs.button(`Copy ${select.name} color range`, {reduce: () =&gt; navigator.clipboard.writeText(select.range)})"
  },
  {
    "objectID": "docs/nb_guidelines.html#visualizations",
    "href": "docs/nb_guidelines.html#visualizations",
    "title": "Overview",
    "section": "Visualizations",
    "text": "Visualizations\nTo ensure a good user experience, all plots, maps, and figures within the notebooks should have a consistent fixed height to prevent page shifts during interactive changes. A maximum height of 800px is recommended, although it can be adjusted based on specific design requirements. The height parameter should be set, especially for maps, where different admins will have different sizes, resulting in large content shifts if not set. A maximum width of 1000px is suggested. Text should be large enough to be read with ease.\nMost previous Data Exploration Notebooks have used the Observable Plot library for creating visualizations. Examples using this library can be found here or within the Atlas here. Some also use d3 to create more complex or interactive visualizations. Any JS plotting library should work fine so long as they allow:\n\nDynamic Plots: Plots should adapt dynamically based on user inputs such as region or crop selection, provided no data is unavailable.\nTooltips for Additional Information: Tooltips can enhance understanding but should not overwhelm the main plot. Plots should generally convey information succinctly and effectively."
  },
  {
    "objectID": "docs/nb_guidelines.html#data-download-buttons",
    "href": "docs/nb_guidelines.html#data-download-buttons",
    "title": "Overview",
    "section": "Data Download buttons",
    "text": "Data Download buttons\nEvery figure should include a data download button that can be used to download the data used in the figure. For consistency and ease, there is a function in the /helpers folder that can be used to create the download button.\n```{ojs}\nimport { downloadButton } from \"/helpers/uiComponents.ojs\"\ndata = [{a: 1, b: 2}, {a: 3, b: 4}, {a: 5, b: 6}]\ndownloadButton(data, filename, label = \"Download\")\n\n```"
  },
  {
    "objectID": "docs/nb_guidelines.html#selectors",
    "href": "docs/nb_guidelines.html#selectors",
    "title": "Overview",
    "section": "Selectors",
    "text": "Selectors\nThe Observable standard library comes with many inputs/selectors pre-included. These should be used when possible, rather than building selectors from scratch or importing them from elsewhere. Documentation on these selectors can be found here with many examples on ObservableHQ. We use a custom CSS to modify the styling of these inputs, these should be automatically applied on quarto render and preview.\nWhen multiple selectors are used together - such as to select multiple admin levels - they should be grouped together in a single horizontal block using an Inputs.form, or other methods where necessary. When multiple selectors are used across a notebook to select the same variable in different places, there should be one master selector that is updated when other selectors are used (using Inputs.bind()). The below example shows how to do this, along with how to use the Inputs.form selector to group selectors together:\n\n\nShow the code\nviewof var1_master = Inputs.radio([\"var1\", \"var2\", \"var3\"], {label: \"Variable 1\", value: \"var1\"})\n\nviewof form = Inputs.form( // returns a JS object of {var1: ..., var2: ...}\n  {\n    var1: Inputs.bind(\n      Inputs.radio([\"1\", \"2\", \"3\"], {label: \"Variable 1\", value: var1_master}),\n      viewof var1_master\n    ),\n    var2: Inputs.select([\"a\", \"b\", \"c\"], {label: \"Variable 2\", value: \"var2\"})\n  },\n  {\n    template: (inputs) =&gt; htl.html`\n      &lt;div style=\"display: flex; gap: 3em\"&gt;\n        ${Object.values(inputs)}\n      &lt;/div&gt;`\n  }\n)\n\nform\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nShow the code\nvar1_master"
  },
  {
    "objectID": "docs/nb_guidelines.html#images",
    "href": "docs/nb_guidelines.html#images",
    "title": "Overview",
    "section": "Images",
    "text": "Images\nEach notebook should include a single hero image in .webp format, optimized for minimal file size without noticeable quality loss. Save the image in the /images directory using the notebook’s name as the filename. Included in the /helpers folder is a function to crop an image to the required size of 800x175 pixels and convert it to webP, if not already in this format. It is not required to use this function, but images do need to be in webP and cropped to this size for best performance. If a specific part of the image should be used, it should be manually cropped, rather than using the function.\nThe below example shows how to use this function:\nquarto run helpers/cropToWebP.ts 'default_im.webp' 'default_crop.webp'"
  },
  {
    "objectID": "docs/nb_guidelines.html#storing-data",
    "href": "docs/nb_guidelines.html#storing-data",
    "title": "Overview",
    "section": "Storing Data",
    "text": "Storing Data\nA lot of the processing of data is/should be done before hand due to the limitations of client-side processing and page performance. This pre-processed data should be stored in the Adaptation Atlas S3 bucket in a cloud-optimized format, such as parquet for tabular data. For development this data could be sotored elsewhere, but should be migrated to the Atlas S3 bucket for production. Get in touch with us to complete this. Files that may need to be updated should be stored in the S3 bucket to allow easier updating and version control.\nTo easily manage data and allow users to access the raw datasets being queried and pulled from the S3, data paths, alongside some metadata, should be stored in a JSON file in the notebook sub-directory in the /data folder. At minimum this should include a dataset name, source, and the sections the data is used. See the example below:\n{\n    \"HeatData\" : {\n      \"source\": \"https://digital-atlas.s3.us-east-1.amazonaws.com/heat.parquet\",\n      \"name\": \"Historical and Future heat Data\",\n      \"sections\": [\n        \"Where is the heat?\",\n        \"How hot will it be in the Future?\"\n      ]\n    },\n    \"OtherData\": {\n      \"source\": \"https://digital-atlas.s3.us-east-1.amazonaws.com/example.parquet\",\n      \"name\": \"Some More Data\",\n      \"sections\": [\n        \"Section 1\"\n      ]\n    }\n}\nData can also be stored within the quarto project and loaded into quarto notebooks using File Attachments. This should be reserved for the translations and small files with a specific use - such as datasets needed for a single plot or files requiring a specific format. Any data stored within the project should be within a sub-directory in the /data folder with the notebook name."
  },
  {
    "objectID": "docs/nb_guidelines.html#importing-data",
    "href": "docs/nb_guidelines.html#importing-data",
    "title": "Overview",
    "section": "Importing data",
    "text": "Importing data\nIn general, DuckDB-wasm should be used for data import, querying, and some data processing. DuckDB can be used to directly query parquet data from the S3 bucket in an incredibly efficient manner. Some of the datasets used may be extremly large and contain may rows and columns - importing all of them at once would be terrible for page performance. We strongly suggest dynamically querying data by admin region and variable of interest to limit the about of data imported at a time. For large files, we suggest reading them as views, rather than tables, this can be seen in the below example. Some basic functions and data aggregation methods can also be performed using DuckDB, but JS methods can also be used for this, and are sometimes more efficient. Regarding data manipulation, it is recommended to consolidate data wrangling into a few OJS cells rather than splitting each processing step into seperate cells. For example, you can use a block within a js cell to define multiple lines (see Cells from Observable Documentation for examples).\nTo use DuckDB to import subsets data into the documents from the S3:\n\n\nShow the code\nviewof time = Inputs.radio([\"historic\", \"2021_2040\", \"2041_2060\"], {label: \"Timeframe\", value: \"historic\"})\n\ndb = {\n  let db = await DuckDBClient.of()\n  await db.query(`\n    CREATE VIEW Hazard AS\n    SELECT admin0_name, admin1_name, admin2_name, scenario, timeframe, hazard, value\n    FROM read_parquet(\"s3://digital-atlas/hazards/hazard_timeseries_mean/annual/haz_means_adm.parquet\")\n  `);\n  return await db;\n}\n\ndata = {\n // The query below can be made dynamic using template literals\n // and it will automatically re-run when the interpolated values change.\n  let query = `\n    SELECT *\n    FROM Hazard\n    WHERE admin1_name IS NULL\n    AND \"hazard\" IN ('HSH_max', 'HSH_mean', 'NDWL0', 'NDWS', 'NTx35', 'NTx40', 'TAI', 'THI_max', 'THI_mean', 'TAVG', 'PTOT')\n    AND \"timeframe\" = '${time}'\n    LIMIT 3`\n  return db.query(query)\n}\n\ndata\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nTo load File Attachements follow this pattern:\n```{ojs}  \ndata = await FileAttachment(\"/data/shared/atlas-region_admin0_simplified.json\").json()\n```\nImportant Note: Windows devices using certain web browsers have a error which results in cached parquet data becoming invalid when using DuckDB. This results in errors across any figure/section using this data when the page is reloaded or refreshed. The GitHub issue can be followed here. The solution to this is to prevent the use of cached parquet data on windows devices. There is an included function in the /helpers folder which itentifies if the device is a windows device and prevents the use of cached data though “cache busting”. It is required to use this function when loading parquet data into a notebook. Its use can be seen in the above example using DuckDB."
  },
  {
    "objectID": "docs/nb_guidelines.html#country-boundaries-and-geospatial-data",
    "href": "docs/nb_guidelines.html#country-boundaries-and-geospatial-data",
    "title": "Overview",
    "section": "Country Boundaries and Geospatial data",
    "text": "Country Boundaries and Geospatial data\nFor all spatial data within the Adaptation Atlas data explorations, use the following guidelines to maintain consistency and efficiency:\n\nEnsure that all maps, geographic selectors, and other geospatial elements utilize the Adaptation Atlas boundary dataset. These boundaries are based on the GAUL 2024, but include modifications so that country boundaries appear as each country represents themselves, including disputed areas.\nIn general the Data Explorations should provide data to admin level 2 where possible, although data should be limited to the highest resolution data avaliable.\nAnalysis and any raster extraction should use the highest resoltuon boundaries from the Atlas boundary dataset.\nAny visualizations within the data explorations should use the low or very low resolution boundaries, unless there is a valid reason for using higher resolution boundaries. This is to insure fast page load speeds, as there is a signifigant difference in file sizes between dataset resolution.\nOnly one set of admin boundaries should be used in each data exploration - all datasets with a spatial “aspect” should be stored in raw tabular format and merged to the admin boundries within each notebook using the matching ‘admin0_name’, ‘admin1_name’, and ‘admin2_name’ columns. This will prevent multiple large boundary datasets from being loaded in each notebook."
  },
  {
    "objectID": "docs/nb_guidelines.html#ojs-in-quarto",
    "href": "docs/nb_guidelines.html#ojs-in-quarto",
    "title": "Overview",
    "section": "OJS in Quarto",
    "text": "OJS in Quarto\nOJS is slighty different than vanilla JavaScript and cells will automatically re-run when a variable they are dependent on is changed. The main differences can be outlined in the documentation. Quarto includes code blocks and OJS itself is based on cells, so it is important to note some differences. It is possible to have multiple OJS Cells within a quarto code block, and OJS cells can include blocks of JavaScript code. This can be seen in the below example, which return the same resutl using 3 different ways of structuring the code:\nExample 1:\n```{ojs}\nx = 10\n\ny = x + 5\n\nresult = y * 10\n```\nExample 2:\n```{ojs}\nx = 10\n```\n\n```{ojs}\ny = x + 5\n```\n\n```{ojs}\nresult = y * 10\n```\nExample 3:\n```{ojs}\nresult = {\n  let x = 10\n  let y = x + 5\n  return y * 10\n}\n```\nExample 1 and 2 are exactly the same, just split up across quarto code blocks. Both result in globals of x and y and result. Example 3 uses 1 quarto code block and 1 OJS cell with a block to return just result rather than the intermediate variables. In general, using a block to avoid assigning globals is preferred. Multiple OJS cells can be used in one Quarto code blocks, but aim for consistent and logical methods of organizing code.\nInline code blocks are useful for simple and short code such as selectors and text chunks. NOTE: These should only have 1 backtick at the start. The below example uses a extra backtick at the start as a hack to get the code to show correctly and prevent it from executing. For more about inline code, see the Quarto docs\nThis is some text in my document ``{ojs} \"example\".toUpperCase()`\n\n\n### ``{ojs} \"example_h3\".toUpperCase()`"
  },
  {
    "objectID": "docs/nb_guidelines.html#modular-code",
    "href": "docs/nb_guidelines.html#modular-code",
    "title": "Overview",
    "section": "Modular code",
    "text": "Modular code\n\nQuarto Modules\nElements of a notebook can be split into multiple different .qmd documents. This can be useful in keeping code cleaner and more organized. This can be done using the {{&lt; include _myFile.qmd &gt;}} shortcode\nA few important considerations when doing this: - Variables, Functions, and JS modules are shared between the imports because the include/merge is done on build/render. - This means having x defined in both or importing the same module in both will result in an error. - There are no performance implications of doing this, since the files are merged on build. - Any additional qmd module files used for these imports should be in the same directory as the main notebook, and imported modules should begin with an underscore so that quarto does not try to render them as standalone\n\n\nImports in OJS\nOJS cells also have the ability to call in imports. Unlike the above quarto imports, this is done post-render on the client.This can include importing other OJS cells, using the .ojs extension, importing local JS code and modules, and importing modules from NPM. Although possible, this method should not be used to import large sections of a notebook - the above Quarto imports are better suited for this. However, this is useful for sharing functions and importing external libraries.\nTo import a local JS module or code in an OJS file (documented here):\n```{ojs}\nimport { lang as Lang } from \"/helpers/lang.js\"\n\nimport { atlasTOC, atlasHero  } from \"/helpers/uiComponents.ojs\"\n```\nTo import an NPM module or something from an observableHQ notebook:\n```{ojs}\ntopojson = require(\"topojson\") // Regular import\nd3 = require(\"d3@7\") // With a version\nimport {resolveWindowsCacheIssue} from \"cbd32f92c155bf5b\" // From an observableHQ notebook\ninitgeosJs = (await import(\"https://cdn.skypack.dev/geos-wasm\")).default; // Directly from a CDN\nduckdb = import(\"https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.1-dev215.0/+esm\")\n\n```\n\n\nFolder and File structure\nThe main folder structure for the project is as follows:\n.\n├── index.qmd                   # Main index file required by Quarto\n├── data\n│   ├── notebook_name           # Named folder containing individual notebook data\n│   │   ├── dataset1.json       # Notebook specific data not stored in S3\n│   │   └── S3_data.json        # Paths to data stored externally in S3\n│   │   └── translations.json   # Notebook specific translations\n│   └── shared                  # Data shared across notebooks\n├── helpers                     # Code and modules shared between notebooks\n├── images\n│   └── notebook_name.webp      # A single hero image for each notebook\n├── notebooks                   # Code for all notebooks will end here\n│   └── notebook_name           # Named folder containing individual notebook code\n│       ├── notebook_name.qmd   # Main notebook file\n│       ├── _module1.qmd        # Module imported into main notebook\n│       ├── _module2.qmd\n│       └── notebook_stye.css   # Notebook specific styling\n├── _quarto.yml                 # Main project configuration\n├── README.md                   # Main project README\n├── _site                       # Output directory build by Quarto on render\n└── styles.css                  # Main project styling\nA concise and descriptive folder name should be used for each notebook, and this name should be used consistently across the main project folders (i.e. as the sub-directory names in the /notebooks, and /data folders and file names in the /images folder)."
  },
  {
    "objectID": "docs/nb_guidelines.html#shared-data",
    "href": "docs/nb_guidelines.html#shared-data",
    "title": "Overview",
    "section": "Shared Data",
    "text": "Shared Data\nAt the moment the only data shared across all notebooks is the admin0 boundaries and some general translations. The admin1 and admin2 boundaries are stored and queried from the S3 bucket, but will be included in this folder in the future following a data update."
  },
  {
    "objectID": "docs/nb_guidelines.html#helpers-and-functions",
    "href": "docs/nb_guidelines.html#helpers-and-functions",
    "title": "Overview",
    "section": "Helpers and functions",
    "text": "Helpers and functions\nThe /helpers folder contains code and modules that are used across the notebooks. This includes the lang module for the translations, some style builders to build elements on the page such as the TOC and hero image, and functions to handle other tasks. This folder also includes a post-render script which is automatically run to minify the CSS and JS files."
  },
  {
    "objectID": "docs/nb_guidelines.html#styling",
    "href": "docs/nb_guidelines.html#styling",
    "title": "Overview",
    "section": "Styling",
    "text": "Styling\nThe main styling for the project can be found in the root directory under styles.css. Any styling that is notebook specific should be stored within the `/notebooks/notebook_name/” directory and applied using the yaml header at the top of the document/imported with OJS, or it should be including within the notebook code itself as a style block."
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Adaptation Atlas Notebooks",
    "section": "",
    "text": "Adaptation Atlas V1 Notebooks\n\n\n\n\n\nNo notebooks have been configured yet.\n\n\n\n\nOther Documentation and Notebook Guidelines\n\nGuidelines for Developing Observable Notebooks\nNotebook Translation Guide"
  },
  {
    "objectID": "notebooks/gender/notebook.html",
    "href": "notebooks/gender/notebook.html",
    "title": "",
    "section": "",
    "text": "import { heroImage } from \"/helpers/hero.js\";\nhero_url = \"./../../images/womenClimate.webp\";\n\nhero = heroImage(nbTitle, hero_url);\nhtml`${hero}`;\nimport { atlasTOC } from '/helpers/toc.ojs' \n{\n  await nbText // force wait/reload with nbText to load so headings have correct labels/languages\n  return atlasTOC({\n      heading: `&lt;b&gt;${_lang({en:\"In this notebook\", fr:\"Dans ce notebook\"})}&lt;/b&gt;`,\n      skip: [nbTitle, \"notebook-title\", \"Appendix\", \"source-code\"]\n      })\n}"
  },
  {
    "objectID": "notebooks/gender/notebook.html#langnbtext.genderedafriag.womendominate.title",
    "href": "notebooks/gender/notebook.html#langnbtext.genderedafriag.womendominate.title",
    "title": "",
    "section": "",
    "text": "genderCropHeatmap = {\n//| echo: true\n//| code-fold: true\n//| code-summary: \"View plot code\"\n  const data = crop_gender_data;\n\n  const margin = { top: 40, right: 0, bottom: 5, left: 100 };\n  const width = 475 \n  const height = 320\n\n  const tooltip = d3\n    .select(\"body\")\n    .append(\"div\")\n    .attr(\"class\", \"plotTooltip\")\n    .style(\"position\", \"absolute\");\n\n  const svg = d3\n    .create(\"svg\")\n    .attr(\"viewBox\", [\n      0,\n      0,\n      width + margin.left + margin.right,\n      height + margin.top + margin.bottom\n    ])\n    // .attr(\"width\", \"85%\")\n    .attr(\"height\", \"90%\");\n\n  const xScale = d3\n    .scaleBand()\n    .domain(data.map((d) =&gt; d.country))\n    .range([margin.left, width - margin.right])\n    .padding(0.05);\n\n  const yScale = d3\n    .scaleBand()\n    .domain([\n      \"Cereals\",\n      \"Legumes\",\n      \"Roots & Tubers\",\n      \"Fruits & Vegetables\",\n      \"Non-edible crops\"\n    ])\n    .range([margin.top, height - margin.bottom])\n    .padding(0.05);\n\n  // const colorScale = d3.scaleSequential(d3.interpolateBlues).domain([0, 100]);\n  const colorScale = d3\n    .scaleLinear()\n    .domain([21, 61])\n    .range([\"#F7D732\", \"#216729\"]);\n\n  svg\n    .selectAll(\"rect\")\n    .data(\n      data.flatMap((d) =&gt;\n        [\n          \"Cereals\",\n          \"Legumes\",\n          \"Roots & Tubers\",\n          \"Fruits & Vegetables\",\n          \"Non-edible crops\"\n        ].map((type) =&gt; ({\n          country: d.country,\n          type,\n          value: d[type]\n        }))\n      )\n    )\n    .join(\"rect\")\n    .attr(\"x\", (d) =&gt; xScale(d.country))\n    .attr(\"y\", (d) =&gt; yScale(d.type))\n    .attr(\"width\", xScale.bandwidth())\n    .attr(\"height\", yScale.bandwidth())\n    .attr(\"fill\", (d) =&gt; (d.value !== null ? colorScale(d.value) : \"white\"))\n    .on(\"mouseover\", function (event, d) {\n      mutable hover_data = d;\n    })\n    .on(\"mousemove\", (event, d) =&gt; {\n      tooltip\n        .style(\"top\", event.pageY - 10 + \"px\")\n        .style(\"left\", event.pageX + 10 + \"px\")\n        .style(\"opacity\", 1)\n        .html(\n          `${_lang(nbText.General.adminNames[d.country])}&lt;br&gt;${_lang(nbText.GenderedAfriAG.FemaleParticipationCrops.plot.crops[d.type])}: ${\n            d.value !== null ? d.value + \"%\" : _lang(nbText.General.noDataAvailable)\n          }`\n        );\n    })\n    .on(\"mouseout\", function (event, d) {\n      mutable hover_data = null;\n      tooltip.style(\"opacity\", 0);\n    });\n\n  svg\n    .append(\"g\")\n    .attr(\"transform\", `translate(0, ${height - margin.bottom})`)\n    .attr(\"stroke-width\", \".5px\")\n    .call(d3.axisBottom(xScale).tickFormat((d) =&gt; _lang(nbText.General.adminNames[d])))\n    .selectAll(\"text\")\n    .style(\"font-size\", \"8px\");\n\n  svg\n    .append(\"g\")\n    .attr(\"transform\", `translate(${margin.left}, 0)`)\n    .attr(\"stroke-width\", \".5px\")\n    .call(d3.axisLeft(yScale).tickFormat((d) =&gt; _lang(nbText.GenderedAfriAG.FemaleParticipationCrops.plot.crops[d])))\n    .selectAll(\"text\")\n    .style(\"font-size\", \"8px\");\n\n  svg\n    .append(\"g\")\n    .attr(\"transform\", `translate(100,-10) scale(0.75)`)\n    .append(heatmap_legend);\n\n  return svg.node();\n}"
  },
  {
    "objectID": "notebooks/gender/notebook.html#langnbtext.genderinvestments.title",
    "href": "notebooks/gender/notebook.html#langnbtext.genderinvestments.title",
    "title": "",
    "section": "",
    "text": "View plot code\ngenderInvestmentLollipop = {\n  const margin = { top: 10, right: 70, bottom: 35, left: 85 };\n  const width = 350 - margin.left - margin.right;\n  const height = 200 - margin.top - margin.bottom;\n\n  const lollipop_admin = admin1_sel === \"Full Country\" ? _lang(nbText.General.adminNames[country]) : admin1_sel;\n\n  const tooltip = d3\n    .select(\"body\")\n    .append(\"div\")\n    .attr(\"class\", \"plotTooltip\")\n    .style(\"position\", \"absolute\");\n\n  let tooltipText;\n  if (admin1_sel !== \"Full Country\") {\n    tooltipText = (d) =&gt;\n      `${_lang(nbText.GenderInvestments.GenderIndex.plot.domains[d])}&lt;br&gt;${lollipop_admin} ${_lang(nbText.General.mean)}: ${filteredData[d].toFixed(\n        2\n      )}&lt;br&gt;${region_name} ${_lang(nbText.General.mean)}: ${regional_avg[d].toFixed(2)}`;\n  } else {\n    tooltipText = (d) =&gt;\n      `${_lang(nbText.GenderInvestments.GenderIndex.plot.domains[d])}&lt;br&gt;${lollipop_admin} ${_lang(nbText.General.mean)}: ${filteredData[d].toFixed(\n        2\n      )}`;\n  }\n\n  const svg = d3\n    .create(\"svg\")\n    .attr(\"viewBox\", [\n      0,\n      0,\n      width + margin.left + margin.right,\n      height + margin.top + margin.bottom\n    ])\n    .attr(\"width\", \"90%\")\n    .attr(\"height\", \"90%\");\n\n  const g = svg\n    .append(\"g\")\n    .attr(\"transform\", `translate(${margin.left},${margin.top})`);\n\n  const data = roi[0];\n  const variablesToKeep = [\n    \"empowerment_index\",\n    \"decisions\",\n    \"domestic_violence\",\n    \"education\",\n    \"employment\",\n    \"family_planning\",\n    \"reproductive_health\"\n  ];\n  const filteredData = Object.fromEntries(\n    Object.entries(data).filter(([key, value]) =&gt; variablesToKeep.includes(key))\n  );\n\n  const variables = Object.keys(filteredData);\n  variables.sort(\n    (a, b) =&gt; variablesToKeep.indexOf(a) - variablesToKeep.indexOf(b)\n  );\n\n  const region_name =\n    country === \"SSA\" || admin1_sel === \"Full Country\" ? \"SSA\" : country;\n\n  const xScale = d3.scaleLinear().domain([0, 1]).range([0, width]);\n\n  const yScale = d3\n    .scaleBand()\n    .domain(variables)\n    .range([0, height])\n    .padding(0.1);\n\n  let countryLine_offset = 2;\n\n  if (admin1_sel !== \"Full Country\") {\n    countryLine_offset = 2.75;\n    const meanLine_offset = 1.5;\n\n    const meanLine = g\n      .selectAll(\".mean-line\")\n      .data(variables)\n      .enter()\n      .append(\"line\")\n      .attr(\"class\", \"mean-line\")\n      .attr(\"x1\", 0)\n      .attr(\"x2\", (d) =&gt; xScale(regional_avg[d]))\n      .attr(\n        \"y1\",\n        (d) =&gt; yScale(d) + yScale.bandwidth() / meanLine_offset\n      )\n      .attr(\n        \"y2\",\n        (d) =&gt; yScale(d) + yScale.bandwidth() / meanLine_offset\n      )\n      .attr(\"stroke\", \"grey\")\n      .attr(\"stroke-width\", 0.75);\n\n    meanLine\n      .on(\"mousemove\", (event, d) =&gt; {\n        tooltip\n          .style(\"top\", event.pageY - 10 + \"px\")\n          .style(\"left\", event.pageX + 10 + \"px\")\n          .style(\"opacity\", 1)\n          .html(tooltipText(d));\n      })\n      .on(\"mouseout\", function (event, d) {\n        tooltip.style(\"opacity\", 0);\n      });\n\n    const meanDot = g\n      .selectAll(\".mean-dot\")\n      .data(variables)\n      .enter()\n      .append(\"circle\")\n      .attr(\"class\", \"mean-dot\")\n      .attr(\"cx\", (d) =&gt; xScale(regional_avg[d]))\n      .attr(\n        \"cy\",\n        (d) =&gt; yScale(d) + yScale.bandwidth() / meanLine_offset\n      )\n      .attr(\"r\", 2)\n      .attr(\"fill\", \"grey\");\n\n    meanDot\n      .on(\"mousemove\", (event, d) =&gt; {\n        tooltip\n          .style(\"top\", event.pageY - 10 + \"px\")\n          .style(\"left\", event.pageX + 10 + \"px\")\n          .style(\"opacity\", 1)\n          .html(tooltipText(d));\n      })\n      .on(\"mouseout\", function (event, d) {\n        tooltip.style(\"opacity\", 0);\n      });\n    g.append(\"g\")\n      .attr(\"transform\", `translate(195, 70) scale(0.35)`)\n      .append(loli_legend);\n  }\n\n  const line = g\n    .selectAll(\".line\")\n    .data(variables)\n    .enter()\n    .append(\"line\")\n    .attr(\"class\", \"line\")\n    .attr(\"x1\", 0.1)\n    .attr(\"x2\", (d) =&gt; xScale(filteredData[d]))\n    .attr(\n      \"y1\",\n      (d) =&gt; yScale(d) + yScale.bandwidth() / countryLine_offset\n    )\n    .attr(\n      \"y2\",\n      (d) =&gt; yScale(d) + yScale.bandwidth() / countryLine_offset\n    )\n    .attr(\"stroke\", \"#57832b\")\n    .attr(\"stroke-width\", 0.75);\n\n  line\n    .on(\"mousemove\", (event, d) =&gt; {\n      tooltip\n        .style(\"top\", event.pageY - 10 + \"px\")\n        .style(\"left\", event.pageX + 10 + \"px\")\n        .style(\"opacity\", 1)\n        .html(tooltipText(d));\n    })\n    .on(\"mouseout\", function (event, d) {\n      tooltip.style(\"opacity\", 0);\n    });\n\n  const dot = g\n    .selectAll(\".dot\")\n    .data(variables)\n    .enter()\n    .append(\"circle\")\n    .attr(\"class\", \"dot\")\n    .attr(\"cx\", (d) =&gt; xScale(filteredData[d]))\n    .attr(\n      \"cy\",\n      (d) =&gt; yScale(d) + yScale.bandwidth() / countryLine_offset\n    )\n    .attr(\"r\", 3)\n    .attr(\"fill\", \"#57832b\");\n\n  dot\n    .on(\"mousemove\", (event, d) =&gt; {\n      tooltip\n        .style(\"top\", event.pageY - 10 + \"px\")\n        .style(\"left\", event.pageX + 10 + \"px\")\n        .style(\"opacity\", 1)\n        .html(tooltipText(d));\n    })\n    .on(\"mouseout\", function (event, d) {\n      tooltip.style(\"opacity\", 0);\n    });\n\n  g.append(\"g\")\n    .attr(\"transform\", `translate(0,${height})`)\n    .call(d3.axisBottom(xScale))\n    .attr(\"stroke-width\", \".5px\")\n    .attr(\"font-size\", \"8px\");\n\n  g.append(\"text\")\n    .attr(\"transform\", `translate(${width / 2}, ${height + margin.bottom - 5})`)\n    .style(\"text-anchor\", \"middle\")\n    .text(_lang(nbText.GenderInvestments.GenderIndex.plot.title_X))\n    .attr(\"font-size\", \"8px\");\n\n  g.append(\"g\")\n    .call(d3.axisLeft(yScale).tickSize(0).tickFormat((d) =&gt; _lang(nbText.GenderInvestments.GenderIndex.plot.domains[d])))\n    .attr(\"stroke-width\", \".5px\")\n    .attr(\"font-size\", \"8px\");\n\n  return svg.node();\n}"
  },
  {
    "objectID": "notebooks/gender/notebook.html#text-translations-and-language-support",
    "href": "notebooks/gender/notebook.html#text-translations-and-language-support",
    "title": "",
    "section": "Text translations and language support",
    "text": "Text translations and language support\n\nnbTitle = _lang({\n  en: \"Analyze Women's Exposure to Climate Hazards\",\n  fr: \"Analyser l'exposition des femmes aux aléas climatiques\",\n});\n// h1\nOverview = _lang(nbText.overview.title);\nAgIsGendered = _lang(nbText.GenderedAfriAG.title);\nGenderInvestments = _lang(nbText.GenderInvestments.title);\nGenderHotspots = _lang(nbText.GenderHotspots.title);\nBridgeGap = _lang(nbText.BridgeGap.title);\nSummary = _lang(nbText.Summary.title);\n\n// h2\nWomenDominate = _lang(nbText.GenderedAfriAG.WomenDominate.title);\nFemaleParticipation = _lang(\n  nbText.GenderedAfriAG.FemaleParticipationLabor.title,\n);\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nnbText = await FileAttachment(\"/data/genderNotebook/Gender_nbText.json\").json()\n\nimport { lang as Lang } from \"/helpers/lang.js\"\n\n_lang = await Lang.lg(language.key)\n\ndefaultLangKey = {\n  const list = languages.map((d) =&gt; d.key);\n  const defaultKey = \"en\";\n  const queryParam = await Lang.getParamFromList({ name: \"lang\", list });\n  return queryParam ?? defaultKey;\n}\n\nlanguages = [\n  { key: \"en\", label: \"English\", locale: 'en-US' },\n  { key: \"fr\", label: \"Français\", locale: 'fr-FR' }\n]\n\nviewof language = Inputs.radio(languages, {\n  label: \"Main language toggle\",\n  format: (d) =&gt; d.key,\n  value: languages.find((x) =&gt; x.key === defaultLangKey),\n})"
  },
  {
    "objectID": "notebooks/gender/notebook.html#notebook-data-import",
    "href": "notebooks/gender/notebook.html#notebook-data-import",
    "title": "",
    "section": "Notebook Data Import",
    "text": "Notebook Data Import\n\ndb = {\n  const db = await DuckDBClient.of({\n    gender: FileAttachment(\"/data/genderNotebook/a0a1_gender_variables.parquet\"),\n    hazards: FileAttachment(\"/data/genderNotebook/HS_hazards.parquet\"),\n    mapspam_vop: FileAttachment(\"/data/genderNotebook/mapspam_vop.parquet\")\n  });\n  return db;\n}\n\n\n// Heatmap Data\ntask_gender_data = FileAttachment(\"/data/genderNotebook/task_gender_data.json\").json()\ncrop_gender_data = FileAttachment(\"/data/genderNotebook/crop_gender_data.json\").json()\ncrop_groups = FileAttachment(\"/data/genderNotebook/crop_groups.json\").json()\ncrop_gender_means = FileAttachment(\"/data/genderNotebook/crop_gender_means.json\").json()\n\n// Admin Data\nadmin1_boundaries = FileAttachment(\n  \"/data/genderNotebook/atlas-region_admin1_harmonizedV2.json\"\n).json()\n\nadmin0_boundaries = FileAttachment(\"/data/genderNotebook/atlas-region_admin0_simplified.json\").json()\n\n// Solutions\n\ngender_solutions = FileAttachment(\"/data/genderNotebook/gender_solutions.json\").json()"
  },
  {
    "objectID": "notebooks/gender/notebook.html#boundary-selection-and-delivery",
    "href": "notebooks/gender/notebook.html#boundary-selection-and-delivery",
    "title": "",
    "section": "Boundary Selection and delivery",
    "text": "Boundary Selection and delivery\n\na0_list = [\"SSA\"].concat(\n  Array.from(\n    new Set(\n      Object.values(\n        admin0_boundaries.objects[\"atlas-region_admin0_harmonized\"].geometries\n      ).map((d) =&gt; d.properties.admin0_name)\n    )\n  )\n)\n\na1_list = {\n  const filteredData = admin1_boundaries.objects[\n    \"atlas-region_admin1_harmonizedV2\"\n  ].geometries.filter((d) =&gt; d.properties.admin0_name === country);\n\n  const a1Names = Array.from(\n    new Set(filteredData.map((d) =&gt; d.properties.admin1_name))\n  );\n  return [\"Full Country\"].concat(a1Names);\n}\n\nmutable clickedAdmin0 = null\n\nviewof country = {\n  // Create the selection input.\n  const country = Inputs.select(a0_list, {\n    // label: html`&lt;b&gt;Select Country:&lt;/b&gt;`,\n    label: \"Select Country\",\n    value: clickedAdmin0\n  });\n\n  // Update clickedAdmin0 when the selection changes.\n  country.addEventListener(\"input\", () =&gt; {\n    mutable clickedAdmin0 = country.value === \"SSA\" ? null : country.value;\n  });\n  return country;\n}\n\nviewof admin1_sel = Inputs.select(a1_list, { label: \"admin1\" })\n\nadmin_form = () =&gt; {\n  return Inputs.form(\n    [\n      Inputs.bind(Inputs.select(a0_list, { label: _lang(nbText.General.country), format: (v) =&gt; _lang(nbText.General.adminNames[v]) }), viewof country),\n      Inputs.bind(\n        Inputs.select(a1_list, { label: _lang(nbText.General.region), format: (v) =&gt; v === \"Full Country\" ? _lang(nbText.General.adminNames[v]): v }),\n        viewof admin1_sel\n      )\n    ],\n    {\n      template: (inputs) =&gt;\n        htl.html`&lt;div style=\"display: flex; gap: 3em\"&gt;${inputs}&lt;/div&gt;`\n    }\n  );\n}"
  },
  {
    "objectID": "notebooks/gender/notebook.html#notebook-helpers",
    "href": "notebooks/gender/notebook.html#notebook-helpers",
    "title": "",
    "section": "Notebook Helpers",
    "text": "Notebook Helpers\n\nimport { downloadButton } from \"/helpers/uiComponents.ojs\";\n\nformatDollar = new Intl.NumberFormat(\"en-US\", {\n  notation: \"compact\",\n  compactDisplay: \"short\",\n  style: \"currency\",\n  currency: \"usd\",\n}).format;"
  },
  {
    "objectID": "notebooks/gender/notebook.html#dictionaries",
    "href": "notebooks/gender/notebook.html#dictionaries",
    "title": "",
    "section": "Dictionaries",
    "text": "Dictionaries\n\nF_dict = new Object({\n  women_in_agric: \"Women in Agriculture\",\n  empowerment_index: \"Empowerment Index\",\n  education: \"Education\",\n  domestic_violence: \"Domestic Safety\",\n  reproductive_health: \"Reproductive Health\",\n  family_planning: \"Family Planning\",\n  employment: \"Employment\",\n  decisions: \"Decision Making\",\n});\n\nhazard_dict = new Object({\n  human: \"HSH\",\n  crop: \"NTx35\",\n  livestock: \"THI\",\n});\n\nhazard_bivariate_thresholds = new Object({\n  human: { low: 27, high: 42 },\n  livestock: { low: 72, high: 90 },\n  crop: { low: 9, high: 25 },\n});\n\nscenario_dict = new Object({\n  historic: \"Historic\",\n  ssp245: \"SSP245\",\n  ssp585: \"SSP585\",\n});"
  },
  {
    "objectID": "notebooks/gender/notebook.html#backend-section-agisgendered",
    "href": "notebooks/gender/notebook.html#backend-section-agisgendered",
    "title": "",
    "section": "Backend Section: AgIsGendered",
    "text": "Backend Section: AgIsGendered\n\nHeatmap Legend\n\nheatmap_legend = () =&gt; {\n  const svg = d3.create(\"svg\").attr(\"width\", 200).attr(\"height\", 60);\n\n  const defs = svg.append(\"defs\");\n  const linearGradient = defs\n    .append(\"linearGradient\")\n    .attr(\"id\", \"linear-gradient\");\n\n  linearGradient\n    .attr(\"x1\", \"0%\")\n    .attr(\"y1\", \"0%\")\n    .attr(\"x2\", \"100%\")\n    .attr(\"y2\", \"0%\");\n\n  linearGradient\n    .append(\"stop\")\n    .attr(\"offset\", \"0%\")\n    .attr(\"stop-color\", \"#F7D732\");\n  linearGradient\n    .append(\"stop\")\n    .attr(\"offset\", \"100%\")\n    .attr(\"stop-color\", \"#216729\");\n\n  svg\n    .append(\"rect\")\n    .attr(\"width\", 100)\n    .attr(\"height\", 15)\n    .style(\"fill\", \"url(#linear-gradient)\")\n    .attr(\"transform\", \"translate(15,30)\");\n\n  const legendScale = d3.scaleLinear().range([0, 100]).domain([0, 1]);\n\n  const legendAxis = d3\n    .axisTop()\n    .scale(legendScale)\n    .tickValues([0, 1])\n    .tickFormat((d) =&gt;\n      d === 0\n        ? _lang(nbText.GenderedAfriAG.LegendScale.low)\n        : _lang(nbText.GenderedAfriAG.LegendScale.high),\n    )\n    .tickSize(0);\n\n  svg\n    .append(\"g\")\n    .attr(\"class\", \"legend axis\")\n    .attr(\"transform\", \"translate(15,30)\")\n    .call(legendAxis)\n    .style(\"font-size\", \"10px\");\n\n  svg.selectAll(\".axis path\").style(\"stroke\", \"none\");\n\n  return svg.node();\n};\n\n\n\n\n\n\n\n\nWomen Dominate Section\n\nData\n\nmutable hover_data = null\n\nroot_tube_total = {\n  const total = await db.query(\n    `SELECT SUM(\"value\") as rt_sum, admin0_name\n     FROM \"mapspam_vop\"\n     WHERE crop IN (${crop_groups[\"Roots & Tubers\"]})\n     GROUP BY admin0_name`\n  );\n\n  const women_total = total.map((d) =&gt; {\n    const match = crop_gender_data.find((item) =&gt; item.country === d.admin0_name);\n    return match && match['Roots & Tubers'] ? d.rt_sum * (match['Roots & Tubers']/100) : null;\n  });\n\n  const sum_W_total = women_total.reduce((acc, val) =&gt; acc + (val || 0), 0)\n  \n\n  return sum_W_total;\n}\n\ncrop_cat = {\n  if (hover_data === null) {\n    return null;\n  } else {\n    return hover_data.type;\n  }\n}\n\nselection_total = {\n  if (crop_cat === null) {\n    return null;\n  } else {\n    const total = await db.query(\n      `Select  SUM(\"value\") as crop_sum\n  FROM mapspam_vop\n  WHERE admin0_name LIKE '%${hover_data.country}'\n  AND crop in (${crop_groups[crop_cat]})`\n    );\n    return Math.round(total[0][\"crop_sum\"]);\n  }\n}\n\ngender_data = db.query(`Select *\n  FROM gender`)\n\nhazard_data = db.query(`Select admin0_name, admin1_name, scenario, timeframe as time, value as hs_value, hazard\n  FROM hazards\n  WHERE hazard LIKE '%${hazard_dict[heat_hazard]}%'\n  AND admin2_name IS NULL`)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nDynamic Headline\n\ngenderCropHeadline = () =&gt; {\n  const container = html`&lt;div style=\"height: 120px; overflow: hidden;\"&gt;`;\n  let text;\n  let fill_items;\n\n  if (hover_data === null) {\n    text = md`${_lang(nbText.GenderedAfriAG.WomenDominate.headline.default)}`;\n  } else if (hover_data.value !== null) {\n    const involvementLevel =\n      hover_data.value &gt; crop_gender_means[\"country_mean\"][hover_data.country]\n        ? \"more\"\n        : \"less\";\n    const productionValue = formatDollar(\n      selection_total * (hover_data.value / 100),\n    );\n    fill_items = [\n      {\n        name: \"country\",\n        value: _lang(nbText.General.article_adminNames[hover_data.country]),\n      },\n      { name: \"involvement\", value: _lang(nbText.General[involvementLevel]) },\n      {\n        name: \"cropType\",\n        value: _lang(\n          nbText.GenderedAfriAG.FemaleParticipationCrops.plot.crops[\n            hover_data.type\n          ],\n        ),\n      },\n      { name: \"cropPCT\", value: hover_data.value },\n      { name: \"cropValue\", value: productionValue },\n    ];\n    let template = _lang(\n      nbText.GenderedAfriAG.WomenDominate.headline.valid_hover,\n    );\n    text = md`${Lang.reduceReplaceTemplateItems(template, fill_items)}`;\n  } else {\n    let template = _lang(\n      nbText.GenderedAfriAG.WomenDominate.headline.null_hover,\n    );\n    fill_items = [\n      {\n        name: \"country\",\n        value: _lang(nbText.General.article_adminNames[hover_data.country]),\n      },\n      {\n        name: \"cropType\",\n        value: _lang(\n          nbText.GenderedAfriAG.FemaleParticipationCrops.plot.crops[\n            hover_data.type\n          ],\n        ),\n      },\n    ];\n    text = md`${Lang.reduceReplaceTemplateItems(template, fill_items)}`;\n  }\n  return text;\n};"
  },
  {
    "objectID": "notebooks/gender/notebook.html#backend-section-genderinvestments",
    "href": "notebooks/gender/notebook.html#backend-section-genderinvestments",
    "title": "",
    "section": "Backend Section: GenderInvestments",
    "text": "Backend Section: GenderInvestments\n\nData\n\nroi = {\n  function calculateMeanVariables(raw_data) {\n    return raw_data.reduce((acc, obj) =&gt; {\n      Object.keys(obj).forEach((key) =&gt; {\n        if (typeof obj[key] === \"number\" && !isNaN(obj[key])) {\n          acc[key] = (acc[key] || 0) + obj[key] / raw_data.length;\n        }\n      });\n      return acc;\n    }, {});\n  }\n  let roiData;\n  if (country !== \"SSA\") {\n    if (admin1_sel === \"Full Country\" || admin1_sel === null) {\n      const raw_data = non_topo.filter((d) =&gt; d.admin0_name === country);\n      roiData = [calculateMeanVariables(raw_data)];\n    } else {\n      roiData = non_topo.filter((d) =&gt; d.admin1_name === admin1_sel);\n    }\n  } else {\n    roiData = [calculateMeanVariables(non_topo)];\n  }\n  return roiData;\n}\n\nregional_avg = {\n  const surrounding = non_topo.filter((d) =&gt; d.admin1_name !== \"na\");\n\n  const variablesToKeep = [\n    \"decisions\",\n    \"domestic_violence\",\n    \"education\",\n    \"employment\",\n    \"family_planning\",\n    \"empowerment_index\",\n    \"reproductive_health\"\n  ];\n\n  // Calculate the mean value for each variable\n  const meanValues = variablesToKeep.reduce((acc, variable) =&gt; {\n    const sum = surrounding.reduce((sum, area) =&gt; sum + area[variable], 0);\n    acc[variable] = sum / surrounding.length;\n    return acc;\n  }, {});\n\n  return meanValues;\n}\n\nnon_topo = {\n  if (country === \"SSA\" || admin1_sel === \"Full Country\") {\n    return db.query(`SELECT * FROM gender`);\n  } else {\n    return db.query(`SELECT * FROM gender WHERE admin0_name LIKE '${country}'`);\n  }\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nlolipop Legend\n\nloli_legend = () =&gt; {\n  const svg = d3.create(\"svg\").attr(\"width\", 200).attr(\"height\", 100);\n\n  const box = svg\n    .append(\"rect\")\n    .attr(\"width\", 200)\n    .attr(\"height\", 100)\n    .attr(\"rx\", 10)\n    .attr(\"ry\", 10)\n    .attr(\"fill\", \"#f0f0f0\");\n\n  const color = d3\n    .scaleOrdinal()\n    .domain([\"Regional average\", \"Admin average\"])\n    .range([\"#216729\", \"grey\"]);\n\n  const circles = svg\n    .selectAll(\"circle\")\n    .data([\"Regional average\", \"Admin average\"])\n    .join(\"circle\")\n    .attr(\"cx\", 30)\n    .attr(\"cy\", (d, i) =&gt; 35 + i * 30)\n    .attr(\"r\", 6)\n    .attr(\"fill\", (d) =&gt; color(d));\n\n  let region_name;\n  if (admin1_sel !== \"Full Country\") {\n    region_name = admin1_sel;\n  }\n\n  const labels = svg\n    .selectAll(\"text\")\n    // .data([region_name + \" average\", country + \" average\"])\n    .data([\"regional_avg\", \"national_avg\"])\n    .join(\"text\")\n    .attr(\"x\", 45)\n    .attr(\"y\", (d, i) =&gt; 40 + i * 30)\n    .text((d) =&gt; _lang(nbText.General[d]));\n\n  return svg.node();\n};"
  },
  {
    "objectID": "notebooks/gender/notebook.html#backend-section-genderhotspots",
    "href": "notebooks/gender/notebook.html#backend-section-genderhotspots",
    "title": "",
    "section": "Backend Section: GenderHotspots",
    "text": "Backend Section: GenderHotspots\n\nData\n\nlabels = [\"low\", \"moderate\", \"high\"]\nindex = d3.index(\n  BiVar_merge,\n  (d) =&gt; d.admin0_name,\n  (d) =&gt; d.admin1_name\n)\n\nBiVar_merge = {\n  // const hazard_regex = /(_mean$ |/i;\n  const filtered_haz = hazard_data.filter(\n    (d) =&gt;\n      d.scenario === ssp && //Note the ! operator i nnext line\n      !d.hazard.includes(\"mean\") && // could be mean or max\n      (d.time === \"2041_2060\" || d.time === \"historic\")\n    // d.admin1_name !== null //hazard_regex.test(d.hazard)\n  );\n  const mergedData = filtered_haz.map((item2) =&gt; {\n    const matchingItem = gender_data.find(\n      (item1) =&gt;\n        item1[\"admin0_name\"] === item2[\"admin0_name\"] &&\n        item1[\"admin1_name\"] === item2[\"admin1_name\"]\n    );\n\n    return matchingItem ? { ...matchingItem, ...item2 } : item2;\n  });\n\n  return mergedData;\n}\n\nfiltered_haz = hazard_data.filter(\n  (d) =&gt; d.scenario === 'historic' && !d.hazard.includes(\"max\") //&&\n  // d.admin1_name !== null //hazard_regex.test(d.hazard)\n)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nSelectors\n\nviewof sel_gender_var = Inputs.select(\n  new Map(Object.entries(F_dict).map(([key, value]) =&gt; [value, key])),\n  { label: \"Variable\", value: \"women_in_agric\" }\n)\n\nssp = bivar_form[\"scenario\"]\nheat_hazard = BiVariable_form[\"hazard\"]\nG_variable = BiVariable_form[\"Gender_var\"]\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nBivariate Map\n\nLegend\n\nbi_color = {\n  if (G_variable === \"women_in_agric\") {\n    return [\n      \"#e8e8e8\",\n      \"#e4acac\",\n      \"#c85a5a\",\n      \"#b0d5df\",\n      \"#ad9ea5\",\n      \"#985356\",\n      \"#64acbe\",\n      \"#627f8c\",\n      \"#574249\"\n    ];\n  } else {\n    return [\n      \"#e8e8e8\",\n      \"#ddb395\",\n      \"#d17a3d\",\n      \"#a7c4d4\",\n      \"#a7b395\",\n      \"#a77a3d\",\n      \"#65a0bf\",\n      \"#65a095\",\n      \"#657a3d\"\n    ];\n  }\n}\n\nbi_legend = () =&gt; {\n  const k = 50;\n  const arrow = \"arrow-id\";\n  d3.select(\".biLegend\").remove();\n  const tooltip = d3\n    .select(\"body\")\n    .append(\"div\")\n    .attr(\"class\", `plotTooltip biLegend`)\n    .style(\"position\", \"absolute\")\n    .style(\"opacity\", 0);\n\n  const svg = d3\n    .create(\"svg\")\n    .attr(\"width\", 500) // increased size\n    .attr(\"height\", 500) // increased size\n    .attr(\"viewBox\", \"0 0 525 525\") // increased viewBox\n    .attr(\"font-family\", \"sans-serif\")\n    .attr(\"font-size\", 10);\n  //\n\n  const g = svg\n    .append(\"g\")\n    .attr(\n      \"transform\",\n      `rotate(-45 ${(k * 3) / 2},${(k * 3) / 2}) translate(50, 100)`\n    );\n\n  g.append(\"marker\")\n    .attr(\"id\", arrow)\n    .attr(\"markerHeight\", 10)\n    .attr(\"markerWidth\", 10)\n    .attr(\"refX\", 6)\n    .attr(\"refY\", 3)\n    .attr(\"orient\", \"auto\")\n    .append(\"path\")\n    .attr(\"d\", \"M0,0L9,3L0,6Z\");\n\n  d3.cross(d3.range(3), d3.range(3)).forEach(([i, j]) =&gt; {\n    const x = i * k;\n    const y = (3 - 1 - j) * k;\n    const fillColor = bi_color[j * 3 + i];\n    const titleText = `${_lang(nbText.GenderHotspots.selectors.GenderVar.domains[G_variable])}: ${_lang(nbText.General[labels[j]])}&lt;br&gt;${_lang(nbText.GenderHotspots.plot.heatLabels[heat_hazard])}: ${_lang(nbText.General[labels[i]])}`;\n\n    g.append(\"rect\")\n      .attr(\"width\", k)\n      .attr(\"height\", k)\n      .attr(\"x\", x)\n      .attr(\"y\", y)\n      .attr(\"fill\", fillColor)\n      .on(\"mousemove\", (event, d) =&gt; {\n        tooltip\n          .style(\"top\", event.pageY - 10 + \"px\")\n          .style(\"left\", event.pageX + 1 + \"px\")\n          .style(\"opacity\", 1)\n          .html(titleText);\n      })\n      .on(\"mouseout\", function (event, d) {\n        mutable hover_data = null;\n        tooltip.style(\"opacity\", 0);\n      });\n  });\n\n  g.append(\"line\")\n    .attr(\"marker-end\", `url(#${arrow})`)\n    .attr(\"x1\", 0)\n    .attr(\"x2\", 3 * k)\n    .attr(\"y1\", 3 * k)\n    .attr(\"y2\", 3 * k)\n    .attr(\"stroke\", \"black\")\n    .attr(\"stroke-width\", 1.5);\n\n  g.append(\"line\")\n    .attr(\"marker-end\", `url(#${arrow})`)\n    .attr(\"y2\", 0)\n    .attr(\"y1\", 3 * k)\n    .attr(\"stroke\", \"black\")\n    .attr(\"stroke-width\", 1.5);\n\n  g.append(\"text\")\n    // .attr(\"font-weight\", \"bold\")\n    .attr(\"font-size\", \"13px\")\n    .attr(\"dy\", \"0.71em\")\n    .attr(\"transform\", `rotate(90) translate(${(3 / 2) * k},6)`)\n    .attr(\"text-anchor\", \"middle\")\n    .text(_lang(nbText.GenderHotspots.selectors.GenderVar.domains[G_variable]));\n\n  g.append(\"text\")\n    // .attr(\"font-weight\", \"bold\")\n    .attr(\"font-size\", \"13px\")\n    .attr(\"dy\", \"0.71em\")\n    .attr(\"transform\", `translate(${(3 / 2) * k},${3 * k + 6})`)\n    .attr(\"text-anchor\", \"middle\")\n    .text(_lang(nbText.GenderHotspots.plot.heatLabels[heat_hazard]));\n\n  return svg.node();\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nBivariate Insight\n\nbiVar_insight = () =&gt; {\n  let filtered =\n    country === \"SSA\"\n      ? BiVar_merge.filter((d) =&gt; d.admin1_name === null).map((d) =&gt; ({\n          ...d,\n          admin_name: d.admin0_name,\n        }))\n      : BiVar_merge.filter(\n          (d) =&gt; d.admin0_name === country && d.admin1_name !== null,\n        ).map((d) =&gt; ({ ...d, admin_name: d.admin1_name }));\n\n  const heat_HotSpot = filtered.reduce(\n    (max, obj) =&gt;\n      obj.hs_value &gt; max.hs_value\n        ? {\n            admin_name: obj.admin_name,\n            hs_value: obj.hs_value,\n            ac_value: obj[G_variable],\n          }\n        : max,\n    { admin_name: null, hs_value: -Infinity },\n  );\n\n  const classifyHSValue = (value) =&gt; {\n    const thresholds = hazard_bivariate_thresholds[heat_hazard];\n    return value &lt; thresholds.low\n      ? \"low\"\n      : value &lt;= thresholds.high\n        ? \"moderate\"\n        : \"high\";\n  };\n\n  const classifyACValue = (value) =&gt; {\n    const values =\n      country === \"SSA\"\n        ? BiVar_merge.filter((d) =&gt; d.admin1_name === null).map(\n            (d) =&gt; d[G_variable],\n          )\n        : BiVar_merge.filter((d) =&gt; d.admin1_name !== null).map(\n            (d) =&gt; d[G_variable],\n          );\n    const val_class = d3.scaleQuantile(values, d3.range(3))(value);\n    return val_class === 0 ? \"low\" : val_class === 1 ? \"moderate\" : \"high\";\n  };\n\n  const gender_HotSpot = filtered.reduce(\n    (extreme, obj) =&gt;\n      G_variable === \"women_in_agric\"\n        ? obj[G_variable] &gt; extreme.value\n          ? {\n              admin_name: obj.admin_name,\n              value: obj[G_variable],\n              hs_value: obj.hs_value,\n            }\n          : extreme\n        : obj[G_variable] &lt; extreme.value\n          ? {\n              admin_name: obj.admin_name,\n              value: obj[G_variable],\n              hs_value: obj.hs_value,\n            }\n          : extreme,\n    G_variable === \"women_in_agric\"\n      ? { admin_name: null, value: -Infinity }\n      : { admin_name: null, value: Infinity },\n  );\n  let classified_ac = classifyACValue(heat_HotSpot.ac_value);\n  let classified_hs = classifyHSValue(gender_HotSpot.hs_value);\n\n  let regionIntro =\n    country === \"SSA\" ? { en: \"\", fr: \"\" } : { en: \"\", fr: \"la region de\" };\n  let regionIntro_cap =\n    country === \"SSA\" ? { en: \"\", fr: \"\" } : { en: \"\", fr: \"La region de\" };\n  let template_fillers = [\n    {\n      name: \"country\",\n      value: _lang(nbText.General.article_adminNames[country]),\n    },\n    { name: \"regionIntro\", value: _lang(regionIntro) },\n    { name: \"regionIntro_cap\", value: _lang(regionIntro_cap) },\n    {\n      name: \"highest_gender\",\n      value: translateA0_only(gender_HotSpot.admin_name),\n    },\n    {\n      name: \"HS_level\",\n      value: _lang(\n        nbText.GenderHotspots.dynamicLevels[classified_hs.toLowerCase()],\n      ),\n    },\n    {\n      name: \"heatstress_var\",\n      value: _lang(\n        nbText.GenderHotspots.plot.heatLabels[heat_hazard],\n      ).toLowerCase(),\n    },\n    { name: \"highest_hs\", value: translateA0_only(heat_HotSpot.admin_name) },\n    {\n      name: \"AC_level\",\n      value: _lang(\n        nbText.GenderHotspots.dynamicLevels[classified_ac.toLowerCase()],\n      ),\n    },\n  ];\n  let md_text;\n  let template;\n  if (G_variable === \"women_in_agric\") {\n    template = _lang(nbText.GenderHotspots.dynamicInsight_womenInAgri);\n  } else {\n    template_fillers.push({\n      name: \"gender_var\",\n      value: _lang(nbText.GenderHotspots.domains[G_variable]).toLowerCase(),\n    });\n    template = _lang(nbText.GenderHotspots.dynamicInsight_FEMI);\n  }\n\n  return md`${Lang.reduceReplaceTemplateItems(template, template_fillers)}`;\n\n  function translateA0_only(adminName) {\n    const translatedName = _lang(nbText.General.article_adminNames[adminName]);\n    return translatedName === undefined ? adminName : translatedName;\n  }\n};"
  },
  {
    "objectID": "notebooks/gender/notebook.html#backend-section-bridgegap",
    "href": "notebooks/gender/notebook.html#backend-section-bridgegap",
    "title": "",
    "section": "Backend Section: BridgeGap",
    "text": "Backend Section: BridgeGap\n\nData\n\nadaptationOptions = Array.from(\n  new Set(gender_solutions.map((d) =&gt; d[\"Adaptation Options\"])),\n);\n\n\n\n\n\n\n\n\nTable\n\ntableHTML = () =&gt; {\n  const columns = [\n    \"Sector\",\n    \"Gender Outcome Score\",\n    \"Geography\",\n    \"Confidence in Result\",\n    \"Risk\",\n  ];\n\n  const table_data = gender_solutions.filter(\n    (d) =&gt; d[\"Adaptation Options\"] === adaptation,\n  );\n\n  let table = `\n  &lt;style&gt;\n          .tableTooltip::after {\n            content: attr(data-tooltip);\n            position: absolute;\n            transform: translateX(1%);\n            background: rgba(255,255,255,0.95);\n            color: #333;\n            border: 1px solid #333;\n            padding: 10px; \n            border-radius: 5px;\n            opacity: 0;\n            pointer-events: none;\n            transition: opacity 0.5s;\n            z-index: 1;\n        }\n\n        .tableTooltip:hover::after {\n            opacity: 1;\n        }\n    td, th {\n      border-right: 1px solid lightgray;\n      color: black;\n    }\n\n  &lt;/style&gt;&lt;table style=\"table-layout: fixed; min-height: 100%; min-width: 85%; font-size: 13px;\"&gt;&lt;thead&gt;&lt;tr style=\"background-color:  #CCC;\"&gt;${columns\n    .map(\n      (c) =&gt;\n        `&lt;th style=\"padding: 10px; height: 40px; vertical-align: middle;\" &gt;${_lang(nbText.BridgeGap.table.headings[c])}&lt;/th&gt;`,\n    )\n    .join(\"\")}&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;`;\n\n  for (let [index, row] of table_data.entries()) {\n    let rowColor = index % 2 === 0 ? \"#f2f2f2\" : \"#ffffff\";\n    table += `&lt;tr style=\"background-color: ${rowColor};\"&gt;${columns\n      .map((c) =&gt; {\n        if (c === \"Gender Outcome Score\" && row[c]) {\n          let outcome = row[c];\n          let sign = \"\";\n          let tipText;\n          if (outcome === \"Enabling\") {\n            sign = `&lt;span style=\"color: lightgreen; font-weight: bold; font-size: 16px; \"&gt;+&lt;/span&gt;`;\n            tipText = _lang(nbText.BridgeGap.table.tooltip.enable);\n          } else if (outcome === \"Reinforcing\") {\n            sign = `&lt;span style=\"color: #57832b; font-weight: bold; font-size: 16px; \"&gt;+&lt;/span&gt;`;\n            tipText = _lang(nbText.BridgeGap.table.tooltip.reinforce);\n          } else if (outcome === \"Constraining\") {\n            sign = `&lt;span style=\"color: orange; font-weight: bold; font-size: 16px; \"&gt;-&lt;/span&gt;`;\n            tipText = _lang(nbText.BridgeGap.table.tooltip.constrain);\n          } else {\n            sign = `&lt;span style=\"color: red; font-weight: bold; font-size: 16px; \"&gt;-&lt;/span&gt;`;\n            tipText = _lang(nbText.BridgeGap.table.tooltip.counteract);\n          }\n          return `&lt;td style=\"vertical-align: middle;padding: 0 20px;\"&gt;\n          &lt;span class=\"tableTooltip\" data-tooltip=\"${tipText}\"&gt;${sign} ${_lang(nbText.BridgeGap.table.values[row[c].toLowerCase()])}&lt;/span&gt;\n        &lt;/td&gt;`;\n        } else if (c === \"Geography\" && row[c]) {\n          return `&lt;td style=\"vertical-align: middle;padding: 3px 20px;\"&gt;${row[c]\n            .split(\",\")\n            .map((country) =&gt;\n              country_flags[country.trim()]\n                ? `&lt;span class=\"tableTooltip\" data-tooltip=\"${_lang(nbText.General.adminNames[country.trim()])}\"&gt;${\n                    country_flags[country.trim()].outerHTML\n                  }&lt;/span&gt;`\n                : country,\n            )\n            .join(\" \")}&lt;/td&gt;`;\n        } else if (c === \"Risk\" && row[c]) {\n          return `&lt;td style=\"vertical-align: middle;padding: 0 20px;\"&gt;${row[c]\n            .split(\",\")\n            .map((risk) =&gt;\n              climate_risk_icons[risk.trim()]\n                ? `&lt;span class=\"tableTooltip\" data-tooltip=\"${_lang(nbText.BridgeGap.table.tooltip[risk.trim().toLowerCase()])}\" style=\"margin-right: 10px;\"&gt;${\n                    climate_risk_icons[risk.trim()].outerHTML\n                  }&lt;/span&gt;`\n                : risk,\n            )\n            .join(\" \")}&lt;/td&gt;`;\n        } else if (c === \"Confidence in Result\" && row[c]) {\n          let agreementColor;\n          if (row[c] === \"High\") {\n            agreementColor = \"green\";\n          } else if (row[c] === \"Medium\") {\n            agreementColor = \"orange\";\n          } else {\n            agreementColor = \"red\";\n          }\n          return `&lt;td style=\"vertical-align: middle; padding: 0 15px\"&gt;\n                   &lt;div style=\"display: flex; align-items: center;\"&gt;\n                     &lt;div style=\"background-color: ${agreementColor}; height: 10px; width: 20px; margin-left: 10px; margin-right: 10px; border-radius: 20%;\"&gt;&lt;/div&gt;\n                     &lt;div&gt;${_lang(nbText.BridgeGap.table.values[row[c].toLowerCase()])}&lt;/div&gt;\n                   &lt;/div&gt;\n                  &lt;/td&gt;`;\n        } else {\n          return `&lt;td style=\"vertical-align: middle;padding: 0 20px;\"&gt;\n${row[c]\n  .split(\", \")\n  .map((v) =&gt; _lang(nbText.BridgeGap.table.values[v.toLowerCase()]))\n  .join(\", \")}\n          &lt;/td&gt;`;\n        }\n      })\n      .join(\"\")}&lt;/tr&gt;`;\n  }\n\n  table += `&lt;/tbody&gt;&lt;/table&gt;`;\n\n  let tableContainer = `&lt;div style=\"max-height: 100%;\"&gt;${table}&lt;/div&gt;`;\n\n  return html`${tableContainer}`;\n};"
  },
  {
    "objectID": "notebooks/gender/notebook.html#icons",
    "href": "notebooks/gender/notebook.html#icons",
    "title": "",
    "section": "Icons",
    "text": "Icons\n\ncountry_flags = new Object({\n  Cameroon: html`&lt;svg width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#CC212D\" d=\"M12 5v26h12V5H12zm7.882 15.59L18 19.223l-1.882 1.367l.719-2.212l-1.882-1.367h2.326L18 14.798l.719 2.212h2.326l-1.882 1.367l.719 2.213z\"&gt;&lt;/path&gt;&lt;path fill=\"#288541\" d=\"M4 5a4 4 0 0 0-4 4v18a4 4 0 0 0 4 4h8V5H4z\"&gt;&lt;/path&gt;&lt;path fill=\"#FEE833\" d=\"M32 5h-8v26h8a4 4 0 0 0 4-4V9a4 4 0 0 0-4-4zM18.719 17.011L18 14.798l-.719 2.213h-2.326l1.882 1.367l-.719 2.212L18 19.223l1.882 1.367l-.719-2.212l1.882-1.367z\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  \"Burkina Faso\": html`&lt;svg width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#009E49\" d=\"M19.602 18.942l.99 3.048L18 20.106l-2.593 1.884l.99-3.048L15.101 18H0v9a4 4 0 0 0 4 4h28a4 4 0 0 0 4-4v-9H20.899l-1.297.942z\"&gt;&lt;/path&gt;&lt;path fill=\"#EF2B2D\" d=\"M32 5H4a4 4 0 0 0-4 4v9h15.101l-1.296-.942h3.205L18 14.01l.99 3.048h3.205L20.899 18H36V9a4 4 0 0 0-4-4z\"&gt;&lt;/path&gt;&lt;path fill=\"#FCD116\" d=\"M15.407 21.99L18 20.106l2.593 1.884l-.991-3.048L20.899 18l1.296-.942H18.99L18 14.01l-.99 3.048h-3.205l1.296.942l1.297.942z\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  Tanzania: html`&lt;svg width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#1EB53A\" d=\"M4 5a4 4 0 0 0-4 4v15.627L26.456 5H4z\"&gt;&lt;/path&gt;&lt;path fill=\"#00A3DD\" d=\"M32 31a4 4 0 0 0 4-4V11.33L9.479 31H32z\"&gt;&lt;/path&gt;&lt;path fill=\"#141414\" d=\"M32 5h-2.532L0 26.638V27a4 4 0 0 0 4 4h2.467L36 9.318V9a4 4 0 0 0-4-4z\"&gt;&lt;/path&gt;&lt;path fill=\"#FBD035\" d=\"M26.456 5L0 24.627v2.011L29.468 5zM9.479 31L36 11.33V9.318L6.467 31z\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  Kenya: html`&lt;svg width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#060\" d=\"M36 27a4 4 0 0 1-4 4H4a4 4 0 0 1-4-4V9a4 4 0 0 1 4-4h28a4 4 0 0 1 4 4v18z\"&gt;&lt;/path&gt;&lt;path fill=\"#BB1600\" d=\"M0 13h36v10H0z\"&gt;&lt;/path&gt;&lt;path fill=\"#141414\" d=\"M32 5H4a4 4 0 0 0-4 4v4h36V9a4 4 0 0 0-4-4z\"&gt;&lt;/path&gt;&lt;path fill=\"#EEE\" d=\"M0 13h36v1H0zm0 9h36v1H0z\"&gt;&lt;/path&gt;&lt;path fill=\"#141414\" d=\"M23.054 9.404c-.066-.039-.186.089-.794.764c-.216.24-.486.539-.785.86c-.608.653-1.244 1.461-.783 1.935l-7.265 12.211c-.011.018-.019.047.003.087a.432.432 0 0 0 .294.177h.003c.046 0 .068-.021.079-.039l7.268-12.215c.626.148 1.024-.784 1.305-1.616c.14-.417.274-.796.381-1.1c.302-.856.356-1.027.294-1.064z\"&gt;&lt;/path&gt;&lt;path fill=\"#FFF\" d=\"M22.305 10.208c-.216.24-.486.539-.786.861c-.886.952-1.124 1.528-.769 1.868l.018.016l-7.29 12.252c-.004.008.001.021.005.027a.378.378 0 0 0 .242.145h.002c.01 0 .023-.001.028-.01l7.279-12.234l.012-.02l.022.006c.458.13.846-.355 1.254-1.572c.14-.417.274-.796.381-1.101c.168-.475.314-.889.314-.984c-.082.046-.375.372-.712.746z\"&gt;&lt;/path&gt;&lt;path fill=\"#141414\" d=\"M15.308 12.963c.461-.474-.174-1.282-.783-1.935c-.299-.322-.569-.62-.785-.86c-.608-.674-.728-.803-.794-.764c-.062.038-.008.208.293 1.063c.107.304.241.683.381 1.1c.28.833.678 1.764 1.305 1.616l7.268 12.215c.011.018.033.039.079.039h.003a.432.432 0 0 0 .294-.177c.021-.04.014-.069.003-.087l-7.264-12.21z\"&gt;&lt;/path&gt;&lt;path fill=\"#FFF\" d=\"M15.25 12.937c.355-.34.118-.916-.769-1.868c-.3-.322-.569-.621-.786-.861c-.337-.374-.631-.7-.714-.745c0 .095.146.509.314.984c.107.305.242.684.381 1.101c.409 1.217.796 1.702 1.254 1.572l.022-.006l.012.02l7.279 12.234c.005.009.019.01.028.01h.002a.374.374 0 0 0 .242-.145c.004-.007.009-.02.005-.027l-7.29-12.252l.02-.017z\"&gt;&lt;/path&gt;&lt;path fill=\"#141414\" d=\"M18.018 10.458L18 10.444l-.018.014c-2.492 1.87-3.704 4.331-3.704 7.523s1.211 5.653 3.704 7.524l.018.013l.018-.013c2.492-1.87 3.704-4.331 3.704-7.524s-1.212-5.655-3.704-7.523z\"&gt;&lt;/path&gt;&lt;path fill=\"#BB1600\" d=\"M20.879 14.059c-.603-1.363-1.551-2.54-2.88-3.54c-1.326.999-2.273 2.174-2.877 3.533c.525 1.181.782 2.468.782 3.937c0 1.467-.256 2.751-.779 3.928c.604 1.356 1.55 2.529 2.873 3.527c1.326-.999 2.273-2.174 2.876-3.534c-.521-1.178-.776-2.461-.776-3.921c.002-1.462.258-2.747.781-3.93z\"&gt;&lt;/path&gt;&lt;path d=\"M18 18.927c.306 0 .555-.424.555-.946s-.249-.947-.555-.947c-.306 0-.554.424-.554.947c-.001.522.248.946.554.946zm-.231-2.497c-.502-.739-.746-1.677-.746-2.821c0-1.145.244-2.083.746-2.823v5.644zm.462 0c.501-.739.744-1.677.744-2.821c0-1.145-.243-2.083-.744-2.823v5.644zm-.462 3.1c-.502.738-.746 1.677-.746 2.821c0 1.146.244 2.082.746 2.822V19.53zm.462 0c.501.738.744 1.677.744 2.821c0 1.146-.243 2.082-.744 2.822V19.53z\" fill=\"#FFF\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  Ethiopia: html`&lt;svg  width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt; &lt;path fill=\"#FCDD0A\" d=\"M0 13h36v10H0z\"&gt; &lt;/path&gt; &lt;path fill=\"#088930\" d=\"M32 5H4a4 4 0 0 0-4 4v4h36V9a4 4 0 0 0-4-4z\"&gt; &lt;/path&gt; &lt;path fill=\"#DA1219\" d=\"M4 31h28a4 4 0 0 0 4-4v-4H0v4a4 4 0 0 0 4 4z\"&gt; &lt;/path&gt; &lt;circle fill=\"#0F47AF\" cx=\"18\" cy=\"18\" r=\"9\"&gt; &lt;/circle&gt; &lt;g fill=\"#FCDD0A\"&gt; &lt;path d=\"M13.25 24.469l1.719-5.531l-2.731-1.985h1.156l3.778 2.893l-.594.359l-.922-.83l-1.468 4.406z\"&gt; &lt;/path&gt; &lt;path d=\"M22.609 24.469l-4.73-3.345l-2.723 1.97l.357-1.1l3.964-2.824l.158.676l-1.128.759l3.739 2.759z\"&gt; &lt;/path&gt; &lt;path d=\"M25.382 15.64l-4.519 3.372l1.012 3.222l-.935-.677l-1.463-4.633l.693.058l.395 1.272l3.7-2.647z\"&gt; &lt;/path&gt; &lt;path d=\"M17.872 10.07l1.86 5.487l3.344.05l-.933.68l-4.549-.038l.271-.642l.979-.06l-1.327-4.37zm-7.669 5.477h5.906l1.063-3.254l.358 1.098L16.012 18l-.526-.456l.476-1.372l-4.783.029zm7.526 6.765h.417v3.647h-.417zm7.847-2.087l-.128.396L22 19.466l.128-.396z\"&gt; &lt;/path&gt; &lt;path d=\"M22.473 11.453l.337.245l-2.177 3.021l-.337-.244zm-9.359.245l.337-.245l2.174 3.021l-.336.245zm-2.637 8.923l-.129-.396l3.454-1.155l.129.397z\"&gt; &lt;/path&gt; &lt;/g&gt; &lt;/g&gt;&lt;/svg&gt;`,\n  Madagascar: html`&lt;svg  width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#FC3D32\" d=\"M32 5H13v13h23V9a4 4 0 0 0-4-4z\"&gt;&lt;/path&gt;&lt;path fill=\"#007E3A\" d=\"M13 31h19a4 4 0 0 0 4-4v-9H13v13z\"&gt;&lt;/path&gt;&lt;path fill=\"#EEE\" d=\"M13 5H4a4 4 0 0 0-4 4v18a4 4 0 0 0 4 4h9V5z\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  Mauritania: html`&lt;svg  width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#CE2540\" d=\"M32 5H4a4 4 0 0 0-4 4v18a4 4 0 0 0 4 4h28a4 4 0 0 0 4-4V9a4 4 0 0 0-4-4z\"&gt;&lt;/path&gt;&lt;path fill=\"#0F6433\" d=\"M0 9v18h36V9z\"&gt;&lt;/path&gt;&lt;path fill=\"#FFC514\" d=\"M14.936 12.664l1.894 1.375l-.722 2.221l-.002.005l.007-.005L18 14.889l1.887 1.371l.006.005l-.001-.005l-.722-2.221l1.894-1.375h-2.341L18 10.437l-.723 2.227z\"&gt;&lt;/path&gt;&lt;path fill=\"#FFC514\" d=\"M26.1 13.641c-.019 4.458-3.638 8.067-8.1 8.067s-8.081-3.609-8.1-8.067a8.373 8.373 0 0 0-.294 2.173a8.395 8.395 0 1 0 16.79 0a8.417 8.417 0 0 0-.296-2.173z\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  Niger: html`&lt;svg  width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#EEE\" d=\"M0 13h36v10H0z\"&gt;&lt;/path&gt;&lt;path fill=\"#E05206\" d=\"M32 5H4a4 4 0 0 0-4 4v4h36V9a4 4 0 0 0-4-4z\"&gt;&lt;/path&gt;&lt;circle fill=\"#E05206\" cx=\"18\" cy=\"18\" r=\"4\"&gt;&lt;/circle&gt;&lt;path fill=\"#0DB02B\" d=\"M32 31H4a4 4 0 0 1-4-4v-4h36v4a4 4 0 0 1-4 4z\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  Ghana: html`&lt;svg  width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#CC212D\" d=\"M32 5H4a4 4 0 0 0-4 4v5h36V9a4 4 0 0 0-4-4z\"&gt;&lt;/path&gt;&lt;path fill=\"#FBD116\" d=\"M15.423 22h5.185l-2.592-1.884zm3.587-4.941h3.215l-2.601 1.889l.991 3.052H36v-8H18.016zm-2.602 1.889l-2.601-1.889h3.215L18.016 14H0v8h15.416z\"&gt;&lt;/path&gt;&lt;path fill=\"#288541\" d=\"M20.617 22.006L20.608 22h-5.186l-.009.006l.003-.006H0v5a4 4 0 0 0 4 4h28a4 4 0 0 0 4-4v-5H20.615l.002.006z\"&gt;&lt;/path&gt;&lt;path d=\"M13.807 17.059l2.601 1.889L15.416 22l-.002.006l.009-.006l2.593-1.884L20.608 22l.009.006l-.002-.006l-.991-3.052l2.601-1.889H19.01L18.016 14l-.994 3.059z\" fill=\"#000000\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  Zimbabwe: html`&lt;svg  width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#EEE\" d=\"M10.154 12L1.833 5.637a4.121 4.121 0 0 0-.5.381v.001A3.992 3.992 0 0 0 0 9v18a3.992 3.992 0 0 0 1.834 3.363L18 18l-7.846-6z\"&gt;&lt;/path&gt;&lt;path fill=\"#DE200F\" d=\"M6.682 11.597l1.783 3.613l3.989.58l-2.887 2.813l.682 3.972l-3.567-1.876l-3.567 1.876l.681-3.972L.91 15.79l3.988-.58z\"&gt;&lt;/path&gt;&lt;path fill=\"#FFD200\" d=\"M7.5 15.458c-.917-.75-1.292-1.292-1.958-2.333s-1.542-.917-1.917 0c-.583.125-.75.75-.75.75c.958-.292 1.583.333 1.667 1.667s-.25 1.708-.833 2.875s.083 1.458.083 1.458l.384 2.026h5.958l.825-3.568h.5c-.001 0-3.042-2.125-3.959-2.875z\"&gt;&lt;/path&gt;&lt;path fill=\"#FFAC33\" d=\"M5.812 16.531l-.344.236s.625 1.369 1.531 1.566s3.837.523 3.837.523l.121-.523s-3.031-.365-3.792-.49s-1.353-1.312-1.353-1.312zm-.75 3.376s1.281-.106 1.938 0c.613.099 3.193.242 3.534.261l.113-.49c-.349-.056-3.075-.491-3.835-.536c-.812-.048-1.624.346-1.75.765zm.657.968l.156 1.026h4.258l.182-.785c-2.073-.41-4.596-.241-4.596-.241z\"&gt;&lt;/path&gt;&lt;path fill=\"#F15A29\" d=\"M10.173 21.951H4.134l-.008-.04l-.379-2.003a.64.64 0 0 1-.278-.345c-.109-.3-.043-.693.194-1.169c.088-.176.171-.334.247-.481c.42-.806.651-1.25.582-2.369c-.047-.746-.264-1.273-.627-1.525c-.263-.182-.591-.214-.975-.097l-.086.026l.023-.087c.007-.026.176-.638.762-.78c.186-.438.494-.707.847-.739c.407-.035.814.231 1.148.755c.643 1.004 1.021 1.564 1.948 2.322c.905.74 3.925 2.852 3.956 2.873l.13.091h-.619l-.826 3.568zm-5.956-.099h5.876l.825-3.568h.382c-.591-.415-3.032-2.132-3.832-2.787c-.938-.768-1.32-1.332-1.968-2.345c-.313-.491-.694-.744-1.055-.709c-.322.029-.604.285-.774.701l-.01.024l-.026.005c-.418.09-.612.458-.681.627c.376-.094.701-.048.968.137c.39.27.622.824.67 1.601c.072 1.147-.164 1.6-.592 2.422a37.48 37.48 0 0 0-.246.479c-.221.442-.287.817-.191 1.087c.081.225.243.3.25.303l.024.011l.005.025l.375 1.987z\"&gt;&lt;/path&gt;&lt;path fill=\"#319209\" d=\"M35.873 8A4 4 0 0 0 32 5H4c-.798 0-1.542.234-2.166.636l-.001.001L4.923 8h30.95zm0 20A4.001 4.001 0 0 1 32 31H4a3.988 3.988 0 0 1-2.166-.636l-.001-.001L4.923 28h30.95z\"&gt;&lt;/path&gt;&lt;path fill=\"#FFD200\" d=\"M4.923 8L18 18L4.923 28h30.95c.083-.321.127-.653.127-1V9c0-.343-.046-.682-.127-1c0-.002-30.95 0-30.95 0z\"&gt;&lt;/path&gt;&lt;path fill=\"#DE200F\" d=\"M10.154 12l5.231 4H36v-4zm0 12H36v-4H15.385z\"&gt;&lt;/path&gt;&lt;path fill=\"#141414\" d=\"M15.385 16L1.833 5.637a4.121 4.121 0 0 0-.5.381v.001L17 18L1.333 29.981c.156.14.324.267.501.382L15.385 20H36v-4H15.385z\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  \"Sub-Saharan Africa\": html`&lt;svg width=\"40px\" height=\"40px\" version=\"1.1\" id=\"_x32_\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 512 512\" xml:space=\"preserve\" fill=\"#32821c\" stroke=\"#32821c\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt; &lt;style type=\"text/css\"&gt; .st0{fill:#32821c;} &lt;/style&gt; &lt;g&gt; &lt;path class=\"st0\" d=\"M495.001,189.882c-0.938-1.114-2.43-1.587-3.833-1.228l-37.986,9.826c-1.562,0.403-3.194-0.228-4.088-1.562 l-16.51-24.756c-0.193-0.29-0.421-0.554-0.693-0.773l-15.58-13.247c-0.422-0.359-0.755-0.807-0.992-1.316l-19.458-42.969 c-0.088-0.219-0.202-0.42-0.342-0.605L384.122,96.97c-0.027-0.044-0.053-0.079-0.079-0.114l-15.756-24.424 c-0.526-0.825-0.729-1.825-0.526-2.79l0.464-2.317c0.22-1.105,0.922-2.053,1.912-2.587c1.001-0.535,2.176-0.596,3.22-0.167l2.413,1 c1.351,0.562,2.912,0.281,3.991-0.719c1.071-0.992,1.474-2.518,1.036-3.913l-2.711-8.51c-0.403-1.28-1.456-2.246-2.772-2.535 l-26.932-5.992c-0.57-0.122-1.176-0.114-1.737,0.027l-21.44,5.359c-0.632,0.158-1.298,0.149-1.931-0.035l-18.756-5.246 c-0.693-0.192-1.324-0.578-1.798-1.123l-4.861-5.474c-0.676-0.755-1.622-1.211-2.631-1.255l-11.641-0.587 c-1.931-0.088-3.632,1.289-3.913,3.21l-1.403,9.37c-0.158,1.018-0.711,1.93-1.544,2.518c-0.843,0.588-1.886,0.816-2.886,0.632 l-24.73-4.676c-1.351-0.263-2.448-1.22-2.877-2.518l-1.798-5.396c-0.5-1.491-1.878-2.518-3.448-2.57l-19.677-0.676 c-1.15-0.035-2.211-0.596-2.895-1.509l-6.378-8.51c-0.641-0.851-0.886-1.939-0.684-2.982c0.201-1.053,0.842-1.957,1.754-2.509 l1.675-1.009c1.72-1.027,2.325-3.22,1.403-4.992L209.93,2.004c-0.747-1.404-2.29-2.194-3.869-1.966L132.685,10.4 c-0.307,0.035-0.606,0.123-0.895,0.237l-21.432,8.729c-0.386,0.166-0.799,0.254-1.22,0.272L95.4,20.357 c-0.921,0.053-1.78,0.43-2.43,1.071L67.441,46.176c-0.578,0.562-0.965,1.289-1.096,2.079l-2.018,12.08 c-0.166,1.062-0.789,1.992-1.692,2.571l-22.696,14.37c-0.536,0.333-0.983,0.807-1.281,1.359l-20.625,37.294 c-0.342,0.614-0.508,1.298-0.474,2l1.596,34.231c0.009,0.298-0.009,0.588-0.07,0.878l-2.903,15.256 c-0.211,1.114,0.096,2.272,0.824,3.15l55.522,65.831c0.922,1.088,2.378,1.561,3.773,1.237l24.59-5.974 c0.377-0.088,0.763-0.123,1.158-0.097l34.433,2.404c0.474,0.044,0.956-0.026,1.421-0.166l25.608-8.291 c1.219-0.394,2.552-0.14,3.544,0.666l15.519,12.704c0.754,0.605,1.728,0.912,2.702,0.834l14.344-1.202 c1.053-0.079,2.088,0.271,2.859,0.991c0.782,0.71,1.229,1.71,1.229,2.772v13.905c0,0.192-0.018,0.377-0.044,0.562l-2.211,14.712 c-0.149,1.035,0.131,2.105,0.799,2.921l15.905,19.686c0.334,0.42,0.579,0.912,0.719,1.43l12.818,49.69 c0.184,0.692,0.158,1.421-0.061,2.096l-11.694,36.661c-0.28,0.878-0.228,1.834,0.14,2.676l19.976,44.733 c0.149,0.333,0.254,0.684,0.298,1.062l3.938,30.774c0.088,0.711,0.395,1.378,0.843,1.931l19.212,23.046 c0.562,0.685,0.868,1.526,0.868,2.413v16.791c0,1.079,0.465,2.114,1.29,2.833c0.807,0.72,1.894,1.036,2.974,0.895l33.977-4.421 l28.529-3.966c0.895-0.131,1.72-0.57,2.316-1.263l43.312-49.716c0.42-0.49,0.719-1.096,0.842-1.736l2.001-9.957 c0.193-0.974,0.772-1.842,1.605-2.395l4.553-3.026c1.018-0.694,1.649-1.825,1.675-3.053l0.747-30.775 c0.026-0.868,0.35-1.71,0.921-2.368l9.202-10.616c0.474-0.544,1.079-0.93,1.772-1.14l18.686-5.545 c1.606-0.473,2.702-1.938,2.702-3.615v-37.442c0-0.316-0.035-0.624-0.114-0.922l-9.106-35.67c-0.439-1.72,0.377-3.509,1.965-4.308 l3.088-1.543c0.562-0.281,1.035-0.685,1.386-1.185l27.125-38.293c0.386-0.552,0.921-0.982,1.526-1.263l21.871-9.799 c0.834-0.377,1.509-1.053,1.886-1.886l23.599-52.207C496.142,192.532,495.94,190.988,495.001,189.882z\"&gt;&lt;/path&gt; &lt;path class=\"st0\" d=\"M485.606,356.242c-0.588-1.114-1.684-1.868-2.93-2c-1.246-0.14-2.483,0.351-3.29,1.316l-18.265,21.634 c-0.369,0.447-0.834,0.799-1.369,1.027l-10.237,4.483c-1.377,0.596-2.255,1.956-2.255,3.457v21.168 c0,0.316-0.044,0.622-0.123,0.921l-2.948,11.8c-0.167,0.684-0.14,1.395,0.07,2.07l6.799,21.072c0.316,0.974,1.001,1.764,1.912,2.22 c0.904,0.448,1.966,0.518,2.914,0.184l13.632-4.747c1.158-0.404,2.045-1.333,2.395-2.5l16.072-55.488l3.728-12.677 c0.272-0.93,0.176-1.939-0.271-2.808L485.606,356.242z\"&gt;&lt;/path&gt; &lt;/g&gt; &lt;/g&gt;&lt;/svg&gt;`,\n  Malawi: html`&lt;svg  width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#77B255\" d=\"M36 27a4 4 0 0 1-4 4H4a4 4 0 0 1-4-4V9a4 4 0 0 1 4-4h28a4 4 0 0 1 4 4v18z\"&gt;&lt;/path&gt;&lt;path fill=\"#DD2E44\" d=\"M0 13h36v10H0z\"&gt;&lt;/path&gt;&lt;path fill=\"#141414\" d=\"M32 5H4a4 4 0 0 0-4 4v4h36V9a4 4 0 0 0-4-4z\"&gt;&lt;/path&gt;&lt;path d=\"M23.191 12a5.992 5.992 0 0 0-10.382 0h10.382zm-5.493-6h.603L18 8.163zm-1.514.18l.594-.102l.068 2.183zm-1.463.433l.569-.201l.435 2.14zm-1.368.673l.527-.293l.79 2.036zm-1.235.895l.47-.378l1.122 1.873zm-1.067 1.09l.401-.452l1.421 1.658zm-.866 1.255l.317-.513l1.681 1.393zM10.898 12l-1.13-.65l-.226.559l.364.091zm15.355 0l.218-.054l-.221-.557l-1.074.611zm-.731-1.951l.312.512l-2.001.872zm-.943-1.198l.394.451l-1.826 1.198zm-1.132-1.023l.464.38l-1.596 1.487zm-1.288-.816l.521.296l-1.323 1.735zm-1.408-.588l.564.204l-1.011 1.934zm-1.487-.341l.59.106l-.67 2.077z\" fill=\"#DD2E44\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  Zambia: html`&lt;svg  width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#1A8A00\" d=\"M32 5H4a4 4 0 0 0-4 4v18a4 4 0 0 0 4 4h28a4 4 0 0 0 4-4V9a4 4 0 0 0-4-4z\"&gt;&lt;/path&gt;&lt;path fill=\"#EF7D00\" d=\"M31 31h1a4 4 0 0 0 4-4V15h-5v16z\"&gt;&lt;/path&gt;&lt;path fill=\"#141414\" d=\"M26 15h5v16h-5z\"&gt;&lt;/path&gt;&lt;path fill=\"#DE200F\" d=\"M21 15h5v16h-5z\"&gt;&lt;/path&gt;&lt;path fill=\"#EF7D00\" d=\"M35.083 8.256c-.109-.021-.716.325-.716.325s.564-.65.434-.65c-.13 0-.866.346-.866.346s.455-.563.303-.498c-.152.065-.976.433-1.604.696c.088-.149.065-.372 0-.372c-.064 0-.434.238-.997.369c-.564.13-1.408.607-1.777.542c-.368-.065-1.105 0-1.105 0s-.216-.325-.043-.412c.172-.087.304.13.304.13s.304-.13.304-.314s-.521-.206-.521-.206s-.218-.281-.563-.281c-.91 0-.976.975-.976.975s-.369-.13-.715-.217c-.347-.087-.954-.043-1.56-.412c-.606-.369-.997-.498-.261.282c-1.084-.369-1.646-1.105-1.799-.786c-.152.32.412.699.412.699s-.304-.086-.563-.325c-.26-.239-.629-.39-.281.13c-.455-.13-.13.347-.13.347s-.369.108 0 .368c.368.26 1.04.369 1.04.369s-.304.216-.109.303s.521.022.521.022s-.26.216 0 .303s.585 0 .585 0s-.108.217.151.314c.261.098.673-.119.673-.119s-.195.13 0 .238c.195.108.498-.119.498-.119s-.173.292 0 .336c.173.043.455-.173.455-.173s-.173.281 0 .303c.173.022.563-.195.563-.195s-.238.303 0 .303c.239 0 .521-.151.521-.151s-.065.238.13.325c.195.087.476-.152.476-.152s.066.456.022.715c-.043.26.281.065.281.065s-.044.39-.304.369c-.26-.022-.521.325-.433.412c.087.087.433-.065.433-.065s-.021.477.108.437c.13-.04.347-.307.347-.307s.13.347.218.304c.087-.044.13-.238.13-.347s.237-.152.237-.152s.065.433.152.349c.088-.085.108-.371.238-.457c.13-.086.087.498.217.455c.131-.043.065-.434.022-.564c-.043-.13.261.108.239 0c-.021-.109-.261-.325-.261-.325s.303.109.217 0s-.13-.39 0-.329s.239-.191.239-.191s.346.26.562.173c.216-.086-.281-.39-.281-.39s.759.26.926.217c.168-.044-.255-.325-.255-.325s.477.108.564 0c.086-.109-.31-.195-.31-.195s.525.087.591 0c.065-.087-.151-.195-.151-.195s.866-.021 1.04-.325c.867.022 1.82-.671 1.907-.823c.086-.152-.151-.152-.151-.152s.521-.412.455-.477c-.065-.065-.347.086-.347.086s.672-.585.564-.606zm-6.436 3.727c-.28 0-.088-.151-.132-.303c-.044-.152.152-.021.13-.152c-.023-.13 0-.758 0-.758c.217.217.325.499.304.715c-.021.217.108.238.151.347c.044.109-.172.151-.453.151z\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  Mali: html`&lt;svg  width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#14B53A\" d=\"M4 5a4 4 0 0 0-4 4v18a4 4 0 0 0 4 4h8V5H4z\"&gt;&lt;/path&gt;&lt;path fill=\"#FCD116\" d=\"M12 5h12v26H12z\"&gt;&lt;/path&gt;&lt;path fill=\"#CE1126\" d=\"M32 5h-8v26h8a4 4 0 0 0 4-4V9a4 4 0 0 0-4-4z\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  Benin: html`&lt;svg  width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#FCD116\" d=\"M32 5H14v13h22V9a4 4 0 0 0-4-4z\"&gt;&lt;/path&gt;&lt;path fill=\"#E8112D\" d=\"M14 31h18a4 4 0 0 0 4-4v-9H14v13z\"&gt;&lt;/path&gt;&lt;path fill=\"#008751\" d=\"M14 5H4a4 4 0 0 0-4 4v18a4 4 0 0 0 4 4h10V5z\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  Uganda: html`&lt;svg  width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#D90001\" d=\"M36 27v-1H0v1a4 4 0 0 0 4 4h28a4 4 0 0 0 4-4z\"&gt;&lt;/path&gt;&lt;path fill=\"#FCDC02\" d=\"M0 22h36v4H0z\"&gt;&lt;/path&gt;&lt;path fill=\"#141414\" d=\"M0 18h36v4H0z\"&gt;&lt;/path&gt;&lt;path fill=\"#D90001\" d=\"M0 14h36v4H0z\"&gt;&lt;/path&gt;&lt;path fill=\"#FCDC02\" d=\"M0 10h36v4H0z\"&gt;&lt;/path&gt;&lt;path fill=\"#141414\" d=\"M0 9v1h36V9a4 4 0 0 0-4-4H4a4 4 0 0 0-4 4z\"&gt;&lt;/path&gt;&lt;circle fill=\"#FFF\" cx=\"18\" cy=\"18\" r=\"4\"&gt;&lt;/circle&gt;&lt;path fill=\"#D90000\" d=\"M17.344 15.031l-.267-.703s.579-.203 1.142 0c.429.155.469.703.469.703l-.671.203l-.673-.203z\"&gt;&lt;/path&gt;&lt;path fill=\"#FCDC02\" d=\"M17.594 14.922v-.684s.111-.043.423 0s.453.262.453.262l-.438.532l-.438-.11z\"&gt;&lt;/path&gt;&lt;path fill=\"#141414\" d=\"M17.745 16.896c-.083-.146 0-1 .239-1.062c.239-.062.698-.812 0-1.062s-.844.479-.844.479s-.69.203-.604.375c.083.167.667-.062.792.083s-.062.354-.562.938s-.167 1.375.062 1.579s.5.359.708.546s.448.292.448.292v.604s-.698.062-1.031.021s-.562.188-.646.458s.125.417.125.209s.083-.084.102.083c.019.167.168.104.168-.104s.083-.125.104-.021s.167-.042.188-.167s.208-.188.375-.229s.614.041.614.041v1.104s-.927.062-1.01.188s.562.104.562.104s-.188.354-.104.375s.667-.354.896-.396s.583.104.625 0s-.562-.25-.625-.354s-.188-1.062-.188-1.062s.271-.022.605-.001c.333.021.25-.271.042-.562s-.021-.375.333-.312c.354.063.625 0 .625-.563s-1.916-1.438-1.999-1.584zm.729 2.708h-.229l.083-.417c0 .001.292.417.146.417z\"&gt;&lt;/path&gt;&lt;path fill=\"#D90000\" d=\"M17.474 15.812c.029-.249-.375-.229-.396 0s.355.355.396 0z\"&gt;&lt;/path&gt;&lt;path fill=\"#9CA69C\" d=\"M17.75 17.047c.115-.041 1.406.547 1.75.703c.344.156.303.75.245 1.109s-.261.469-.261.469s-.225-.58-.938-.859c-.957-.375-1.234-1.266-.796-1.422z\"&gt;&lt;/path&gt;&lt;path fill=\"#D90000\" d=\"M19.203 17.734c.421.11 1.312.312 1.391 1.219c.078.906-.849 1.438-.849 1.438l.155-.281l-.275.094l.12-.204l-.433.094s.725-.578.472-1.094c.019.43-.269.547-.269.547s.248-.596-.828-1.25l.281-.072l-.28-.225l.594.225l-.282-.35l.562.219l-.359-.36z\"&gt;&lt;/path&gt;&lt;path fill=\"#9CA69C\" d=\"M17.594 15.336a.102.102 0 1 1-.204 0a.102.102 0 1 1 .204 0z\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  Chad: html`&lt;svg  width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#002664\" d=\"M4 5a4 4 0 0 0-4 4v18a4 4 0 0 0 4 4h8V5H4z\"&gt;&lt;/path&gt;&lt;path fill=\"#FECB00\" d=\"M12 5h12v26H12z\"&gt;&lt;/path&gt;&lt;path fill=\"#C60C30\" d=\"M32 5h-8v26h8a4 4 0 0 0 4-4V9a4 4 0 0 0-4-4z\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  Senegal: html`&lt;svg  width=\"40px\" height=\"40px\" viewBox=\"0 0 36 36\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\" role=\"img\" class=\"iconify iconify--twemoji\" preserveAspectRatio=\"xMidYMid meet\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"#00853F\" d=\"M4 5a4 4 0 0 0-4 4v18a4 4 0 0 0 4 4h8V5H4z\"&gt;&lt;/path&gt;&lt;path fill=\"#FDEF42\" d=\"M12 5h12v26H12z\"&gt;&lt;/path&gt;&lt;path fill=\"#E31B23\" d=\"M32 5h-8v26h8a4 4 0 0 0 4-4V9a4 4 0 0 0-4-4z\"&gt;&lt;/path&gt;&lt;path fill=\"#00853F\" d=\"M18.869 16.674L18 14l-.869 2.674H14.32l2.274 1.652L15.726 21L18 19.348L20.274 21l-.868-2.674l2.274-1.652z\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n});\n\nhs_icons = new Object({\n  human: html`&lt;svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 320 512\" style=\"height: 30px;fill: grey;\"&gt;&lt;path d=\"M160 0a48 48 0 1 1 0 96 48 48 0 1 1 0-96zM88 384H70.3c-10.9 0-18.6-10.7-15.2-21.1L93.3 248.1 59.4 304.5c-9.1 15.1-28.8 20-43.9 10.9s-20-28.8-10.9-43.9l53.6-89.2c20.3-33.7 56.7-54.3 96-54.3h11.6c39.3 0 75.7 20.6 96 54.3l53.6 89.2c9.1 15.1 4.2 34.8-10.9 43.9s-34.8 4.2-43.9-10.9l-33.9-56.3L265 362.9c3.5 10.4-4.3 21.1-15.2 21.1H232v96c0 17.7-14.3 32-32 32s-32-14.3-32-32V384H152v96c0 17.7-14.3 32-32 32s-32-14.3-32-32V384z\"/&gt;&lt;/svg&gt;`,\n  crop: html`&lt;svg height=\"30px\" fill=\"grey\" viewBox=\"0 0 14 14\" role=\"img\" focusable=\"false\" aria-hidden=\"true\" xmlns=\"http://www.w3.org/2000/svg\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path d=\"m 9.2809236,1.0031187 c -0.021203,1.53e-4 -0.042468,0.0042 -0.061193,0.0153 -0.037695,0.02227 -0.061682,0.06327 -0.061193,0.107087 4.895e-4,0.04895 0.014503,1.205006 0.3442088,1.774588 0.1970404,0.343658 0.4168445,0.512488 0.6731196,0.512488 0.117,0 0.240915,-0.03219 0.374805,-0.107087 0.159346,-0.08934 0.332092,-0.210197 0.390103,-0.4207 0.05042,-0.183578 0.0013,-0.395366 -0.145333,-0.650172 -0.329461,-0.57056 -1.4075533,-1.190259 -1.4533254,-1.216204 -0.018847,-0.01077 -0.039989,-0.01545 -0.061193,-0.0153 z m 2.9525474,0.902592 c -0.02099,0.002 -0.04333,0.01022 -0.06119,0.02295 -0.04014,0.02839 -0.979389,0.697902 -1.262099,1.292695 -0.247953,0.521607 -0.163079,0.877626 0.267718,1.08617 0.110147,0.05263 0.245933,0.107087 0.390103,0.107087 0.259947,0 0.467941,-0.17085 0.634874,-0.520137 0.281976,-0.594793 0.165526,-1.829539 0.160631,-1.881675 -0.0042,-0.04357 -0.02919,-0.08108 -0.06884,-0.09944 -0.02007,-0.0091 -0.0402,-0.0096 -0.06119,-0.0077 z m -2.5165495,1.545116 c -0.6430127,0 -1.4131226,0.205607 -1.4456771,0.214174 -0.042835,0.01126 -0.07337,0.04155 -0.08414,0.08414 -0.011015,0.04283 -0.00147,0.09179 0.030596,0.122385 0.035737,0.03451 0.886376,0.842318 1.5374661,1.017329 0.1436804,0.03867 0.2762855,0.06119 0.3901035,0.06119 0.3417,0 0.553488,-0.168096 0.650172,-0.512488 0.04798,-0.173053 0.085,-0.376825 -0.02295,-0.566033 -0.09619,-0.168647 -0.288584,-0.28834 -0.58133,-0.367156 -0.129239,-0.03476 -0.2872391,-0.05354 -0.4742439,-0.05354 z m 3.1820195,0.74961 c -0.02081,-0.0035 -0.04828,6.1e-5 -0.06884,0.0076 -0.04602,0.01713 -1.126374,0.423515 -1.552764,0.925539 -0.374499,0.440832 -0.384963,0.805663 -0.02295,1.116767 0.127525,0.109412 0.282404,0.221823 0.481892,0.221823 0.204384,0 0.407054,-0.111738 0.611927,-0.351858 0.426635,-0.50178 0.64136,-1.722941 0.650172,-1.774587 0.0076,-0.04308 -0.01212,-0.08683 -0.04589,-0.114737 -0.01713,-0.01395 -0.03274,-0.02705 -0.05354,-0.0306 z m -4.2911369,0.734312 c -0.03745,0.0059 -0.085303,0.02252 -0.1070872,0.06119 -0.021785,0.03867 -0.015604,0.09234 0.00765,0.130034 0.025946,0.04259 0.6465007,1.046456 1.2315027,1.384485 0.2173564,0.125812 0.3990984,0.183578 0.5660324,0.183578 0.341945,0 0.506002,-0.263985 0.558383,-0.351858 0.09154,-0.15445 0.177214,-0.340476 0.122386,-0.550734 -0.04895,-0.187984 -0.202242,-0.351369 -0.466595,-0.50484 C 9.93336,4.9483337 8.6616537,4.9349937 8.6078041,4.9347487 Z M 8.416577,5.9597267 c -0.021142,0.0031 -0.043936,0.009 -0.061193,0.02295 -0.034757,0.0279 -0.053238,0.07092 -0.045894,0.114736 0.00832,0.0492 0.2096461,1.213329 0.627225,1.743992 0.2264129,0.28736 0.4506841,0.428348 0.6807686,0.428348 0.1429461,0 0.2817311,-0.0552 0.4283484,-0.16828 0.142701,-0.110146 0.294337,-0.250951 0.321262,-0.466594 0.02399,-0.192879 -0.05581,-0.402892 -0.244771,-0.642523 -0.4188025,-0.529194 -1.5948647,-1.004906 -1.6445531,-1.024977 -0.020561,-0.0083 -0.040051,-0.01077 -0.061193,-0.0076 z m 4.245242,0.757259 c -0.0492,4.9e-4 -1.210452,0.01671 -1.782237,0.344209 -0.503248,0.28785 -0.632732,0.632304 -0.397752,1.047925 0.06854,0.120916 0.23394,0.397752 0.573681,0.397752 0.149311,0 0.314408,-0.05195 0.50484,-0.160631 0.573008,-0.328237 1.190259,-1.399905 1.216205,-1.445677 0.02203,-0.03794 0.01462,-0.08469 -0.0076,-0.122385 -0.02227,-0.03769 -0.05544,-0.0607 -0.107087,-0.06119 z m -4.696538,0.397752 c -0.021326,-0.0018 -0.041244,0.0058 -0.061193,0.0153 -0.039898,0.01909 -0.065905,0.05538 -0.068842,0.09944 -0.00343,0.04993 -0.079122,1.231992 0.2065253,1.843429 0.182599,0.393347 0.41507,0.581331 0.6960668,0.581331 0.1013351,0 0.2018134,-0.02264 0.3212616,-0.07649 0.1649754,-0.0749 0.3453103,-0.178071 0.4206996,-0.382454 0.067312,-0.182599 0.036716,-0.405647 -0.091789,-0.680769 -0.283934,-0.611437 -1.317968,-1.345994 -1.3615371,-1.376835 -0.018113,-0.01273 -0.039867,-0.02117 -0.061193,-0.02295 z m 1.5145188,2.080552 c -0.060238,0.122931 -0.075818,0.275244 -0.045894,0.451296 0.032065,0.184312 0.1067201,0.6195763 0.6731192,0.6195763 0.07735,0 0.167301,-0.0142 0.260069,-0.0306 0.648397,-0.116266 1.596762,-0.9144633 1.636904,-0.9484863 0.03329,-0.02839 0.04632,-0.07931 0.03824,-0.122386 -0.0081,-0.04332 -0.04253,-0.07759 -0.08414,-0.09179 -0.03525,-0.01224 -0.869548,-0.298314 -1.514518,-0.298314 -0.102559,0 -0.200284,0.0083 -0.283017,0.02295 -0.3562935,0.06364 -0.580371,0.192867 -0.6807677,0.397753 z M 7.1162325,8.0020317 c -0.043569,0.0081 -0.077837,0.03464 -0.091789,0.07649 -0.01591,0.04724 -0.3916332,1.171718 -0.2753671,1.835781 0.088607,0.5069203 0.3259734,0.7649083 0.6960668,0.7649083 0.053605,0 0.1058021,-0.0062 0.1606308,-0.0153 0.1781931,-0.03035 0.3792722,-0.09001 0.5048396,-0.267718 C 8.222229,10.237826 8.2473792,10.021939 8.1947536,9.7230737 8.0775084,9.0582757 7.2731306,8.0813957 7.238618,8.0402747 7.20998,8.0064947 7.160536,7.9937047 7.1162326,8.0020247 Z m -1.2315027,0.871996 c -0.044059,0.0037 -0.080836,0.0287 -0.099438,0.06884 -0.020561,0.04577 -0.5052068,1.1246603 -0.4589451,1.7975353 0.041122,0.561993 0.2702269,0.83375 0.7037158,0.83375 0.022274,0 0.045344,0.0012 0.068842,0 0.020075,-0.0013 0.040652,-0.0056 0.061193,-0.0076 -0.9887011,0.408039 -2.8534922,1.023508 -5.063695,0.940791 -0.30596346,0.340476 0.2141743,0.489541 0.2141743,0.489541 0,0 3.0660728,-0.0025 5.0407472,-1.323292 -0.021196,0.03988 -0.036343,0.08302 -0.053544,0.130035 -0.061438,0.168402 -0.1154706,0.369481 -0.022947,0.566032 0.082977,0.176235 0.2616599,0.310736 0.5507342,0.413051 0.1872496,0.06609 0.4449932,0.09944 0.7649085,0.09944 0.5717844,0 1.153482,-0.102926 1.1779591,-0.107087 0.043569,-0.0081 0.077348,-0.04204 0.091789,-0.08414 0.014442,-0.0421 0.00667,-0.08934 -0.022947,-0.122386 -0.033534,-0.03721 -0.8309966,-0.914524 -1.4686244,-1.139713 -0.2380253,-0.08408 -0.4339572,-0.106885 -0.5966286,-0.07649 0.050741,-0.04332 0.10459,-0.08439 0.1529817,-0.130035 0,0 -0.1256658,0.06461 -0.3136125,0.152982 0.00524,-0.0055 0.01021,-0.0095 0.015298,-0.0153 C 6.7542165,11.213609 6.8091063,10.996803 6.7873217,10.694511 6.7400807,10.022126 6.029328,8.9721207 5.999466,8.9275727 5.974744,8.8911027 5.928788,8.8713327 5.8847297,8.8740327 Z m 2.6389344,1.3538883 c -0.341593,0.03694 -0.5311525,0.234123 -0.5889796,0.58898 -0.02717,0.177948 -0.03696,0.383617 0.091789,0.558383 0.1155317,0.156408 0.3175288,0.253521 0.6195759,0.298314 0.065599,0.0098 0.1323597,0.0153 0.2065253,0.0153 0.6787492,0 1.6493262,-0.381597 1.6904482,-0.397752 0.04137,-0.01616 0.07062,-0.04798 0.07649,-0.09179 0.0059,-0.04381 -0.0104,-0.08806 -0.04589,-0.114736 -0.0399,-0.02986 -0.9906484,-0.741778 -1.6598516,-0.8414 -0.1474131,-0.02221 -0.2762392,-0.02761 -0.3901033,-0.0153 z\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  livestock: html`&lt;svg height=\"40px\" viewBox=\"0 0 512 512\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"grey\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;path fill=\"grey\" d=\"M468.958 108.958c-27.507 2.08-48.997 7.94-71.375 22.572-5.333-2.214-12.62-17.738-16-16-11.82 6.08-14.892 19.555-4.916 32.817l-59.084 9.916c-24.776 3.341-49.567 4.838-74.187 5.334 1.326 3.832 2.96 7.636 4.812 10.05 5.219 6.802 20.323 6.21 21.07 14.75 1.935 22.098-24.876 47.415-47.056 47.057-15.401-.248-17.017-28.762-31.604-33.713-19.097-6.482-41.62 18.77-59.699 9.832-15.267-7.547-24.992-39.8-27.836-50.41-10.213-.127-20.327-.142-30.316.035-12.564.366-22.902 5.645-29.408 14.239-8.676 11.458-11.652 26.658-13.254 42.925-1.78 18.057 6.147 53.007 5.517 70.282-.504 13.85-7.493 11.87-11.912 18.888-13.52 21.47 8.894 20.83 17.014 5.56 12.482-23.473 4.253-63.11 7.195-92.974 1.855-35.76 10.597-23.937 15.664-24.588-4.2 13.065-6.21 30.962-7 51.334 6.895-2.342 36.498-11.6 42.73-.174 6.872 12.598-27.802 22.016-23.878 35.819 2.464 8.666 22.95 2.378 24.582 11.238 3.322 18.035-32.13 38.713-42.236 44.209.812 23.329 1.564 45.567 1.238 65.086H88.91c-4.234-16.543-12.038-49.944-4.06-55.084 21.425-18.091 29.836-37.484 42.732-56.428 8.755 2.556 16.92 4.787 24.782 6.672 3.553.972 7.244 1.771 10.984 2.44 24.859 4.967 61.553 5.678 90.783-.172 3.76 34.12 7.263 68.452 4.602 102.572h28.957c-12.375-26.902-4.263-65.044 13.892-86.27l44.934-33.462c24.881-16.384 42.93-37.996 55.982-63.38 30.402 3.413 57.086 3.29 77.192-.786l12.84-19.55c-24.257-17.857-43.3-36.585-62.948-58.13 10.063-14.533 25.027-22.765 39.375-32.506zm-39.375 54.572a8 8 0 1 1 0 16 8 8 0 0 1 0-16zM366.2 183.481c5.029 9.822-26.17 10.808-24.933 21.772.998 8.847 22.204 3.839 23.53 12.643 3.818 25.373-28.44 53.805-54.08 54.78-14.262.544-34.902-14.06-32.308-28.093 2.605-14.092 34.551-1.657 40.383-14.748 4.724-10.603-18.352-22.01-12.992-32.307 6.264-12.032 30.364-22.553 41.934-22.646 11.57-.093 15.606 3.347 18.466 8.6zm-26.585 126.346l-34.707 23.96 6.464 69.255h34.414c-11.783-22.454-15.58-55.506-6.171-93.215zm-204.561 1.41c-6.047 12.184-14.147 21.97-22.174 31.242 5.97 3.235 11.648 5.414 17.154 6.614 11.218 2.443 21.636.333 29.948-4.408 10.056-5.737 17.521-14.452 24.115-23.368-14.615-.869-32.96-2.962-49.043-10.08zm24.252 52c-8.737 2.585-17.452 3.7-25.566 2.96 5.167 12.624 10.45 24.152 15.824 36.845h28.306c-10.393-18.48-16.148-29.285-18.564-39.805z\"&gt;&lt;/path&gt;&lt;/g&gt;&lt;/svg&gt;`,\n});\n\nclimate_risk_icons = new Object({\n  \"Extreme Weather Events\": html`&lt;svg width=\"35px\" height=\"35px\" viewBox=\"0 0 60 60\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt; &lt;title&gt;crazy-weather&lt;/title&gt; &lt;desc&gt;Created with Sketch.&lt;/desc&gt; &lt;defs&gt; &lt;/defs&gt; &lt;g id=\"People\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\"&gt; &lt;g id=\"Icon-31\" fill=\"#000000\"&gt; &lt;path d=\"M25.8945,48.5527 C25.6475,48.0597 25.0465,47.8597 24.5525,48.1057 C24.0585,48.3527 23.8585,48.9527 24.1055,49.4477 L25.1055,51.4477 C25.2805,51.7977 25.6335,51.9997 26.0005,51.9997 C26.1505,51.9997 26.3035,51.9657 26.4475,51.8947 C26.9415,51.6477 27.1415,51.0467 26.8945,50.5527 L25.8945,48.5527 Z M25.8945,54.5527 C25.6475,54.0597 25.0465,53.8597 24.5525,54.1057 C24.0585,54.3527 23.8585,54.9527 24.1055,55.4477 L25.1055,57.4477 C25.2805,57.7977 25.6335,57.9997 26.0005,57.9997 C26.1505,57.9997 26.3035,57.9657 26.4475,57.8947 C26.9415,57.6477 27.1415,57.0467 26.8945,56.5527 L25.8945,54.5527 Z M19.8945,44.5527 C19.6475,44.0587 19.0475,43.8597 18.5525,44.1057 C18.0585,44.3527 17.8585,44.9527 18.1055,45.4477 L19.1055,47.4477 C19.2805,47.7977 19.6335,47.9997 20.0005,47.9997 C20.1505,47.9997 20.3035,47.9657 20.4475,47.8947 C20.9415,47.6477 21.1415,47.0467 20.8945,46.5527 L19.8945,44.5527 Z M19.8945,50.5527 C19.6475,50.0587 19.0475,49.8597 18.5525,50.1057 C18.0585,50.3527 17.8585,50.9527 18.1055,51.4477 L19.1055,53.4477 C19.2805,53.7977 19.6335,53.9997 20.0005,53.9997 C20.1505,53.9997 20.3035,53.9657 20.4475,53.8947 C20.9415,53.6477 21.1415,53.0467 20.8945,52.5527 L19.8945,50.5527 Z M31.8945,56.5527 C31.6475,56.0597 31.0485,55.8607 30.5525,56.1057 C30.0585,56.3527 29.8585,56.9527 30.1055,57.4477 L31.1055,59.4477 C31.2805,59.7977 31.6335,59.9997 32.0005,59.9997 C32.1505,59.9997 32.3035,59.9657 32.4475,59.8947 C32.9415,59.6477 33.1415,59.0467 32.8945,58.5527 L31.8945,56.5527 Z M19.8945,56.5527 C19.6475,56.0597 19.0475,55.8607 18.5525,56.1057 C18.0585,56.3527 17.8585,56.9527 18.1055,57.4477 L19.1055,59.4477 C19.2805,59.7977 19.6335,59.9997 20.0005,59.9997 C20.1505,59.9997 20.3035,59.9657 20.4475,59.8947 C20.9415,59.6477 21.1415,59.0467 20.8945,58.5527 L19.8945,56.5527 Z M3.8355,13.8007 L5.6835,14.5667 C5.8085,14.6177 5.9385,14.6427 6.0655,14.6427 C6.4585,14.6427 6.8305,14.4097 6.9905,14.0257 C7.2015,13.5157 6.9595,12.9297 6.4495,12.7187 L4.6015,11.9527 C4.0905,11.7407 3.5065,11.9847 3.2945,12.4937 C3.0835,13.0037 3.3255,13.5897 3.8355,13.8007 L3.8355,13.8007 Z M23.9745,6.9897 C24.0995,7.0407 24.2295,7.0657 24.3565,7.0657 C24.7495,7.0657 25.1215,6.8327 25.2815,6.4487 L26.0465,4.6007 C26.2585,4.0907 26.0165,3.5057 25.5055,3.2937 C24.9955,3.0817 24.4115,3.3247 24.1995,3.8347 L23.4335,5.6827 C23.2225,6.1927 23.4645,6.7777 23.9745,6.9897 L23.9745,6.9897 Z M12.7185,6.4487 C12.8785,6.8337 13.2505,7.0667 13.6435,7.0667 C13.7705,7.0667 13.8995,7.0417 14.0255,6.9897 C14.5355,6.7797 14.7775,6.1947 14.5665,5.6837 L13.8005,3.8347 C13.5885,3.3247 13.0045,3.0817 12.4945,3.2937 C11.9835,3.5047 11.7415,4.0897 11.9535,4.6007 L12.7185,6.4487 Z M0.9995,20.0007 L4.9995,19.9997 C5.5525,19.9997 5.9995,19.5517 5.9995,18.9997 C5.9995,18.4477 5.5525,17.9997 4.9995,17.9997 L0.9995,18.0007 C0.4475,18.0007 -0.0005,18.4487 -0.0005,19.0007 C-0.0005,19.5537 0.4475,20.0007 0.9995,20.0007 L0.9995,20.0007 Z M8.3935,9.8087 C8.5885,10.0037 8.8445,10.1017 9.1005,10.1017 C9.3565,10.1017 9.6125,10.0037 9.8075,9.8087 C10.1985,9.4177 10.1985,8.7847 9.8075,8.3947 L6.9785,5.5657 C6.5875,5.1747 5.9555,5.1747 5.5645,5.5657 C5.1735,5.9557 5.1735,6.5887 5.5645,6.9797 L8.3935,9.8087 Z M18.9995,5.9997 C19.5525,5.9997 19.9995,5.5527 19.9995,4.9997 L19.9995,0.9997 C19.9995,0.4477 19.5525,-0.0003 18.9995,-0.0003 C18.4475,-0.0003 17.9995,0.4477 17.9995,0.9997 L17.9995,4.9997 C17.9995,5.5527 18.4475,5.9997 18.9995,5.9997 L18.9995,5.9997 Z M28.8995,10.1017 C29.1555,10.1017 29.4115,10.0037 29.6065,9.8087 L32.4355,6.9797 C32.8265,6.5887 32.8265,5.9557 32.4355,5.5657 C32.0445,5.1747 31.4125,5.1747 31.0215,5.5657 L28.1925,8.3947 C27.8015,8.7847 27.8015,9.4177 28.1925,9.8087 C28.3875,10.0037 28.6435,10.1017 28.8995,10.1017 L28.8995,10.1017 Z M9.0025,17.9637 C9.0705,17.9777 9.1375,17.9847 9.2045,17.9847 C9.6695,17.9847 10.0855,17.6577 10.1825,17.1847 C11.0355,13.0217 14.7435,9.9997 18.9995,9.9997 C20.9685,10.0007 22.8375,10.6247 24.4055,11.8047 C24.8475,12.1377 25.4745,12.0477 25.8055,11.6077 C26.1385,11.1657 26.0495,10.5387 25.6075,10.2067 C23.6905,8.7637 21.4055,8.0007 18.9995,7.9997 C13.7975,7.9997 9.2655,11.6947 8.2235,16.7837 C8.1125,17.3247 8.4615,17.8537 9.0025,17.9637 L9.0025,17.9637 Z M30.9995,49.9997 L40.9625,49.9997 C44.8225,49.9997 47.9625,46.8597 47.9625,42.9997 C47.9625,39.1407 44.8225,35.9997 40.9625,35.9997 C37.1025,35.9997 33.9625,39.1407 33.9625,42.9997 C33.9625,43.5527 34.4105,43.9997 34.9625,43.9997 C35.5155,43.9997 35.9625,43.5527 35.9625,42.9997 C35.9625,40.2427 38.2065,37.9997 40.9625,37.9997 C43.7195,37.9997 45.9625,40.2427 45.9625,42.9997 C45.9625,45.7567 43.7195,47.9997 40.9625,47.9997 L30.9995,47.9997 C30.4475,47.9997 29.9995,48.4477 29.9995,48.9997 C29.9995,49.5527 30.4475,49.9997 30.9995,49.9997 L30.9995,49.9997 Z M57.9625,37.9997 C57.9625,40.5617 56.9955,42.9977 55.2375,44.8607 C54.8585,45.2627 54.8765,45.8957 55.2785,46.2747 C55.4715,46.4557 55.7185,46.5467 55.9645,46.5467 C56.2305,46.5467 56.4955,46.4417 56.6925,46.2337 C58.8015,43.9977 59.9625,41.0737 59.9625,37.9997 C59.9625,34.1097 58.0625,30.4437 54.8795,28.1937 C54.4285,27.8727 53.8045,27.9827 53.4865,28.4327 C53.1675,28.8837 53.2745,29.5077 53.7255,29.8257 C56.3785,31.7017 57.9625,34.7577 57.9625,37.9997 L57.9625,37.9997 Z M53.9625,47.9997 L48.9625,47.9997 C48.4105,47.9997 47.9625,48.4477 47.9625,48.9997 C47.9625,49.5527 48.4105,49.9997 48.9625,49.9997 L53.9625,49.9997 C56.1685,49.9997 57.9625,51.7937 57.9625,53.9997 C57.9625,56.2057 56.1685,57.9997 53.9625,57.9997 C52.8805,57.9997 51.8665,57.5737 51.1075,56.8007 C50.7205,56.4067 50.0865,56.4007 49.6935,56.7867 C49.2985,57.1737 49.2925,57.8067 49.6795,58.2007 C50.8175,59.3617 52.3385,59.9997 53.9625,59.9997 C57.2715,59.9997 59.9625,57.3087 59.9625,53.9997 C59.9625,50.6917 57.2715,47.9997 53.9625,47.9997 L53.9625,47.9997 Z M43.9625,51.9997 L36.9995,51.9997 C36.4475,51.9997 35.9995,52.4477 35.9995,52.9997 C35.9995,53.5527 36.4475,53.9997 36.9995,53.9997 L43.9625,53.9997 C45.0655,53.9997 45.9625,54.8977 45.9625,55.9997 C45.9625,57.1027 45.0655,57.9997 43.9625,57.9997 C43.4275,57.9997 42.9245,57.7917 42.5475,57.4137 C42.1575,57.0227 41.5245,57.0237 41.1335,57.4117 C40.7425,57.8027 40.7415,58.4357 41.1325,58.8257 C41.8875,59.5827 42.8925,59.9997 43.9625,59.9997 C46.1685,59.9997 47.9625,58.2057 47.9625,55.9997 C47.9625,53.7937 46.1685,51.9997 43.9625,51.9997 L43.9625,51.9997 Z M8.9995,47.9997 L7.9995,47.9997 C4.6915,47.9997 1.9995,45.3087 1.9995,41.9997 C1.9995,38.6917 4.6915,35.9997 7.9995,35.9997 C8.5525,35.9997 8.9995,35.5527 8.9995,34.9997 C8.9995,34.4477 8.5525,33.9997 7.9995,33.9997 C3.5885,33.9997 -0.0005,37.5887 -0.0005,41.9997 C-0.0005,46.4107 3.5885,49.9997 7.9995,49.9997 L8.9995,49.9997 C10.8185,49.9997 12.1305,50.5547 13.0515,53.3167 C13.1905,53.7357 13.5815,53.9997 13.9995,53.9997 C14.1045,53.9997 14.2115,53.9837 14.3165,53.9487 C14.8405,53.7747 15.1235,53.2077 14.9485,52.6837 C13.8695,49.4447 12.0345,47.9997 8.9995,47.9997 L8.9995,47.9997 Z M22.7065,17.0927 C22.3985,17.5517 22.5205,18.1727 22.9795,18.4807 C23.4385,18.7887 24.0595,18.6657 24.3675,18.2077 C26.9775,14.3207 31.3125,11.9997 35.9625,11.9997 C43.6825,11.9997 49.9625,18.2807 49.9625,25.9997 C49.9625,27.2687 49.7935,28.5247 49.4595,29.7337 C49.3125,30.2667 49.6255,30.8177 50.1575,30.9637 C50.2465,30.9887 50.3365,30.9997 50.4245,30.9997 C50.8625,30.9997 51.2655,30.7087 51.3875,30.2667 C51.7695,28.8837 51.9625,27.4487 51.9625,25.9997 C51.9625,17.1777 44.7855,9.9997 35.9625,9.9997 C30.6445,9.9997 25.6895,12.6517 22.7065,17.0927 L22.7065,17.0927 Z M24.6525,23.1347 C24.2535,23.5157 23.6205,23.5007 23.2395,23.1017 C21.3325,21.1017 18.7615,19.9997 15.9995,19.9997 C10.4855,19.9997 5.9995,24.4867 5.9995,29.9997 C5.9995,30.6157 6.0555,31.2297 6.1655,31.8257 C6.2665,32.3687 5.9075,32.8907 5.3645,32.9907 C5.3025,33.0027 5.2415,33.0077 5.1815,33.0077 C4.7085,33.0077 4.2885,32.6707 4.1995,32.1897 C4.0665,31.4737 3.9995,30.7377 3.9995,29.9997 C3.9995,23.3827 9.3835,17.9997 15.9995,17.9997 C19.3135,17.9997 22.3985,19.3217 24.6865,21.7207 C25.0675,22.1207 25.0525,22.7537 24.6525,23.1347 L24.6525,23.1347 Z\" id=\"crazy-weather\"&gt; &lt;/path&gt; &lt;/g&gt; &lt;/g&gt; &lt;/g&gt;&lt;/svg&gt;`,\n  \"Climate Change\": html`&lt;svg fill=\"#000000\" width=\"35px\" height=\"35px\" version=\"1.1\" id=\"Layer_1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 512.00 512.00\" xml:space=\"preserve\" stroke=\"#000000\" stroke-width=\"0.00512\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt; &lt;g&gt; &lt;g&gt; &lt;g&gt; &lt;path d=\"M156.834,38.554C188.041,24.294,221.406,17.067,256,17.067c17.289,0,34.475,1.843,51.191,5.495 c-0.759,14.362,5.291,23.962,9.515,30.66c1.186,1.886,2.807,4.463,2.978,5.171c0,35.251-7.134,42.667-8.533,42.667 c-15.36,0-41.566,14.319-51.081,32.094c-5.828,10.872-5.359,22.374,1.314,32.375c4.813,7.219,8.934,15.215,12.928,22.938 c8.218,15.915,17.331,33.579,31.343,33.579c2.884,0,5.973-0.751,9.31-2.415c11.136-5.572,19.302-21.769,27.204-37.427 c3.763-7.458,9.336-18.509,12.484-21.325c11.204,1.109,16.358,10.556,23.356,25.711c4.787,10.368,9.737,21.094,19.243,25.848 c16.478,8.218,70.844-0.538,100.983-13.338c0.358-0.154,0.597-0.444,0.922-0.631c0.495-0.299,0.973-0.58,1.399-0.956 c0.41-0.375,0.734-0.794,1.058-1.237c0.324-0.427,0.631-0.853,0.87-1.34c0.247-0.495,0.384-0.998,0.529-1.536 c0.137-0.521,0.265-1.024,0.307-1.579c0.034-0.572-0.034-1.118-0.111-1.698c-0.051-0.375,0.026-0.734-0.077-1.109 c-20.659-76.399-76.791-139.955-150.161-170.001c-4.36-1.783-9.344,0.299-11.127,4.659c-1.783,4.361,0.299,9.344,4.659,11.128 c66.116,27.085,117.146,83.345,137.95,151.364c-31.795,11.546-72.166,14.711-79.573,10.999 c-4.147-2.074-7.825-10.027-11.375-17.724c-6.758-14.635-16.009-34.671-39.313-35.703c-11.52-0.41-18.099,12.612-27.264,30.78 c-5.7,11.315-13.517,26.812-19.593,29.85c-4.42,2.227-11.58-11.554-17.86-23.723c-4.011-7.765-8.55-16.572-13.892-24.576 c-3.191-4.779-3.336-9.506-0.469-14.865c7.134-13.329,27.93-23.074,36.036-23.074c16.99,0,25.6-20.096,25.6-59.733 c0-5.367-2.722-9.685-5.606-14.268c-4.343-6.878-8.823-13.995-6.135-26.274c0.99-4.506-1.784-8.969-6.246-10.103 C298.377,2.611,277.257,0,256,0c-37.06,0-72.806,7.748-106.257,23.023c-4.284,1.963-6.17,7.023-4.215,11.307 C147.49,38.622,152.55,40.516,156.834,38.554z\"&gt;&lt;/path&gt; &lt;path d=\"M375.117,262.46c-3.132,0.896-7.031,2.014-8.183,2.074c-13.03,0-21.129,9.882-27.622,17.826 c-2.978,3.644-7.492,9.148-9.719,9.148c-0.367,0-0.896-0.162-1.51-0.469c-4.284-2.15-8.772-3.226-13.355-3.226 c-11.042,0-20.591,6.502-22.707,15.471c-1.468,6.229,0.742,14.771,11.366,20.087c16.171,8.081,32.896,16.444,40.448,23.996 c4.83,4.83,13.278,7.603,23.185,7.603c15.138,0,35.251-7.339,42.146-28.006c2.91-8.73,10.069-15.582,16.384-21.623 c7.33-7.023,14.259-13.653,14.362-22.869c0.06-5.402-2.364-10.598-7.211-15.437c-6.69-6.69-15.846-10.086-27.204-10.086 C394.419,256.947,383.266,260.13,375.117,262.46z M422.844,282.283c-0.017,2.039-5.478,7.27-9.097,10.726 c-7.364,7.049-16.529,15.812-20.779,28.561c-4.011,12.041-16.034,16.333-25.95,16.333c-6.434,0-10.266-1.749-11.119-2.603 c-9.515-9.515-26.692-18.108-44.885-27.196c-0.998-0.503-1.647-0.973-2.031-1.306c1.374-1.331,6.699-2.884,11.469-0.495 c3.012,1.502,6.093,2.27,9.139,2.27c10.317-0.008,17.015-8.183,22.929-15.403c5.717-6.989,9.805-11.571,14.413-11.571 c3.328,0,7.33-1.143,12.877-2.731c7.177-2.048,16.998-4.855,25.685-4.855c6.758,0,11.716,1.664,15.138,5.086 C422.46,280.926,422.852,282.018,422.844,282.283z\"&gt;&lt;/path&gt; &lt;path d=\"M215.834,364.433c1.664,1.664,3.849,2.5,6.033,2.5c2.185,0,4.369-0.836,6.033-2.5 c9.481-9.481,13.73-20.693,11.964-31.573c-1.442-8.858-7.006-16.905-14.182-20.497c-3.072-1.527-7.1-2.705-11.767-4.062 c-8.431-2.458-21.171-6.17-24.329-12.194c-0.649-1.246-1.348-3.371,0.034-7.543c2.517-7.544,4.804-11.836,6.81-15.625 c5.504-10.334,8.371-17.101,8.371-46.805c0-15.625-7.501-27.733-21.137-34.082c-4.258-1.971-9.336-0.137-11.332,4.139 c-1.988,4.275-0.137,9.344,4.13,11.341c7.484,3.482,11.273,9.737,11.273,18.603c0,26.829-2.398,31.326-6.366,38.784 c-2.21,4.164-4.975,9.344-7.936,18.253c-2.551,7.654-2.202,14.669,1.041,20.855c6.528,12.467,22.793,17.203,34.671,20.659 c3.55,1.033,7.211,2.099,8.909,2.953c1.604,0.802,4.25,3.576,4.966,7.953c0.87,5.402-1.613,11.204-7.185,16.777 C212.497,355.703,212.497,361.097,215.834,364.433z\"&gt;&lt;/path&gt; &lt;path d=\"M93.867,452.267c0,4.71,3.823,8.533,8.533,8.533c28.237,0,51.2-22.963,51.2-51.2c0-4.71-3.823-8.533-8.533-8.533 c-4.71,0-8.533,3.823-8.533,8.533c0,18.825-15.309,34.133-34.133,34.133C97.69,443.733,93.867,447.556,93.867,452.267z\"&gt;&lt;/path&gt; &lt;path d=\"M509.568,220.57c-0.64-4.668-5.001-7.936-9.626-7.279c-4.668,0.64-7.927,4.949-7.279,9.626 c1.51,10.871,2.27,22.008,2.27,33.084c0,131.746-107.187,238.933-238.933,238.933c-37.026,0-56.047-7.714-56.405-7.859 c-4.309-1.826-9.327,0.171-11.17,4.497c-1.86,4.335,0.154,9.353,4.48,11.204C193.783,503.151,214.904,512,256,512 c141.158,0,256-114.842,256-256C512,244.139,511.181,232.218,509.568,220.57z\"&gt;&lt;/path&gt; &lt;path d=\"M153.6,320.998V85.333c0-28.237-22.963-51.2-51.2-51.2c-28.237,0-51.2,22.963-51.2,51.2v8.533 c0,4.71,3.823,8.533,8.533,8.533s8.533-3.823,8.533-8.533v-8.533c0-18.825,15.309-34.133,34.133-34.133 c18.825,0,34.133,15.309,34.133,34.133v240.725c0,3.209,1.792,6.144,4.642,7.603c28.723,14.694,46.558,43.793,46.558,75.938 c0,47.053-38.281,85.333-85.333,85.333S17.067,456.653,17.067,409.6c0-32.145,17.835-61.244,46.558-75.938 c2.85-1.459,4.642-4.395,4.642-7.603v-35.925H76.8c4.71,0,8.533-3.823,8.533-8.533s-3.823-8.533-8.533-8.533h-8.533v-34.133H76.8 c4.71,0,8.533-3.823,8.533-8.533s-3.823-8.533-8.533-8.533h-8.533v-34.133H76.8c4.71,0,8.533-3.823,8.533-8.533 s-3.823-8.533-8.533-8.533h-8.533v-34.133h42.667c4.71,0,8.533-3.823,8.533-8.533s-3.823-8.533-8.533-8.533h-51.2 c-4.71,0-8.533,3.823-8.533,8.533v192.998C19.49,339.302,0,372.787,0,409.6C0,466.065,45.935,512,102.4,512 c56.465,0,102.4-45.935,102.4-102.4C204.8,372.787,185.31,339.302,153.6,320.998z\"&gt;&lt;/path&gt; &lt;path d=\"M258.884,460.143c9.02,0,17.442-3.243,23.1-8.9c12.988-12.988,2.825-34.833-8.533-46.199 c-2.603-2.603-6.016-3.977-9.873-3.977c-11.81,0-25.745,13.764-30.865,26.129c-3.908,9.429-2.782,18.193,3.072,24.047 C241.442,456.9,249.865,460.143,258.884,460.143z M248.192,434.475c2.697-7.424,10.65-14.635,14.404-16.085 c6.562,7.296,10.359,17.749,7.322,20.787c-4.89,4.89-17.186,4.881-22.067,0C247.108,438.434,247.569,436.173,248.192,434.475z\"&gt;&lt;/path&gt; &lt;/g&gt; &lt;/g&gt; &lt;/g&gt; &lt;/g&gt;&lt;/svg&gt;`,\n  Drought: html`&lt;svg fill=\"#000000\" width=\"35px\" height=\"35px\" version=\"1.1\" id=\"Capa_1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 351.338 351.338\" xml:space=\"preserve\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt; &lt;g&gt; &lt;path d=\"M346.338,154.251c0,0-46.439,0-61.919,0c-4,0-4.128-3.5-4.128-3.5V72.772c0-2.188,0.644-2.107,1.002-0.926 c0.358,1.182,0.767,2.428,1.229,3.744c1.37,3.894,6.389,17.077,13.433,23.232c7.339,6.416,22.624,9.877,33.28,9.877 c6.971,0,11.484-1.45,14.205-4.563c3.74-4.28,3.943-12.301,0.602-23.837c-1.38-4.763-5.332-16.49-12.221-22.511 c-8.685-7.593-29.498-11.403-38.708-11.403c-1.03,0-4.224,0.001-4.734,0.001c-12.73,0-23.088,10.357-23.088,23.088V151 c0,0,0.544,3.251-4.289,3.251c-5.437,0-15.24,0-21.75,0c-3.583,0-3.461-2.499-3.461-2.499V43.036 c0-13.453-10.944-24.399-24.396-24.399c-0.542,0-4.003-0.001-5.131-0.001c-11.517,0-32.892,4.642-41.543,12.204 c-10.166,8.885-20.901,39.777-12.535,49.351c2.821,3.227,7.564,4.729,14.927,4.729h0.001c11.435,0,27.818-3.697,35.657-10.549 c7.519-6.572,12.906-20.734,14.379-24.918c1.371-3.895,3.642-7.716,3.642-6.418v108.383c0,0,0.461,2.832-4.706,2.832 c-62.229,0-57.522,0-74.791,0c-4.458,0-4.31-3.166-4.31-3.166V75.817c0-10.946-8.905-19.853-19.851-19.853 c-0.412,0-24.798,0.787-35.444,9.419c-5.951,4.824-9.022,14.67-10.154,18.575c-4.227,14.594-0.443,18.923,0.8,20.345 c2.474,2.829,6.423,4.147,12.429,4.147h0.001c6.96,0,20.551-2.229,27.392-8.209c3.67-3.208,6.608-8.484,8.621-12.927 c0.449-0.992,1.207-1.855,1.207,1.895v61.875c0,0-0.315,3.166-3.653,3.166c-27.823,0-113.331,0-113.331,0c-2.75,0-5,2.25-5,5 v162.154c0,2.75,2.25,5,5,5h5c2.75,0,5-2.25,5-5V174.251c0-2.75,2.025-5,4.501-5s6.514,1.007,8.973,2.236l11.746,5.874 c2.459,1.229,3.001,3.939,1.203,6.02l-9.456,10.948c-1.798,2.081-1.183,4.628,1.367,5.659l67.604,27.338 c2.55,1.03,3.782,3.764,2.739,6.074c-1.044,2.311-4.09,4.703-6.771,5.319l-28.684,6.586c-2.681,0.616-6.419,2.754-8.308,4.753 L33.277,278.24c-1.889,1.999-2.282,5.566-0.875,7.929l21.771,36.529c1.407,2.362,4.492,3.143,6.854,1.735l4.295-2.56 c2.362-1.407,3.143-4.492,1.735-6.855l-15.965-26.787c-1.407-2.362-1.014-5.93,0.875-7.929l15.727-16.64 c1.889-1.998,5.627-4.137,8.308-4.753l31.51-7.234c2.681-0.616,5.799-3.17,6.931-5.676l9.166-20.295 c1.133-2.506-0.027-5.4-2.577-6.431l-62.652-25.336c-2.55-1.031-3.165-3.578-1.368-5.659l8.367-9.688 c1.798-2.081,1.256-4.791-1.203-6.02l-2.166-1.083c-2.459-1.23-2.222-2.236,0.528-2.236h161.236c2.75,0,5.363,2.221,5.808,4.935 l5.413,33.084c0.444,2.714,2.949,5.626,5.565,6.471l62.949,20.317c2.616,0.845,3.293,3.244,1.503,5.332l-8.374,9.766 c-1.79,2.088-3.181,6.045-3.09,8.793l0.38,11.543c0.091,2.748-2.074,5.213-4.811,5.477l-24.792,2.391 c-2.737,0.264-6.763,1.848-8.946,3.519l-37.49,28.7c-2.184,1.672-1.779,3.551,0.898,4.177l80.502,18.816 c2.678,0.626,5.381-1.054,6.006-3.732l1.139-4.867c0.625-2.678-1.053-5.381-3.73-6.008l-49.596-11.592 c-2.678-0.627-3.082-2.506-0.898-4.178l8.88-6.798c2.184-1.672,6.21-3.255,8.947-3.518l34.536-3.33 c2.737-0.264,4.902-2.729,4.811-5.477l-0.651-19.787c-0.091-2.748,1.3-6.705,3.09-8.793l19.253-22.451 c1.79-2.088,1.113-4.487-1.503-5.332l-75.688-24.429c-2.616-0.845-5.121-3.757-5.565-6.471l-3.538-21.623 c-0.444-2.714,1.442-4.935,4.192-4.935h82.363c2.75,0,5,2.25,5,5v147.154c0,2.75,2.25,5,5,5h5c2.75,0,5-2.25,5-5V159.251 C351.338,156.501,349.088,154.251,346.338,154.251z M331.414,93.616c-1.891,1.569-21.959-2.915-25.588-6.087 c-4.772-4.17-13.095-24.882-11.69-26.126c1.283-1.137,23.928,4.283,27.814,7.68C326.76,73.287,332.731,92.522,331.414,93.616z M192.898,63.079c-4.098,3.581-27.396,8.422-28.812,6.688c-1.168-1.432,4.94-22.769,10.505-27.632 c4.489-3.924,30.39-9.641,31.305-8.496C207.252,35.335,198.403,58.266,192.898,63.079z M102.284,88.948 c-5.222,4.566-16.854,5.459-17.551,4.503c-0.889-1.221,3.845-14.167,6.827-16.773c2.571-2.247,18.056-7.359,19.081-5.577 C111.442,72.492,105.43,86.199,102.284,88.948z\"&gt;&lt;/path&gt; &lt;path d=\"M238.781,258.366l-16.425-32.852c-1.23-2.46-4.224-3.417-6.652-2.127l-32.053,17.028c-2.428,1.29-5.995,0.744-7.926-1.214 l-18.326-18.58c-1.931-1.958-5.112-1.98-7.07-0.049l-3.561,3.512c-1.958,1.931-1.979,5.112-0.049,7.07l26.174,26.537 c1.931,1.958,5.498,2.504,7.926,1.214l28.344-15.058c2.429-1.29,5.422-0.334,6.652,2.126l3.089,6.178 c1.229,2.46,0.263,5.553-2.149,6.874l-69.004,37.797c-2.412,1.32-4.749,4.622-5.193,7.336l-2.636,16.1 c-0.444,2.714,1.413,5.298,4.127,5.742l4.934,0.809c2.714,0.444,5.298-1.413,5.742-4.127l1.454-8.881 c0.444-2.714,2.781-6.016,5.193-7.337l75.26-41.224C239.044,263.92,240.011,260.826,238.781,258.366z\"&gt;&lt;/path&gt; &lt;/g&gt; &lt;/g&gt;&lt;/svg&gt;`,\n  \"Temperature increase\": html`&lt;svg width=\"35px\" height=\"35px\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt; &lt;path d=\"M18 3V21M18 3L15 6M18 3L21 6M7 15.9998C6.44772 15.9998 6 16.4475 6 16.9998C6 17.5521 6.44772 17.9998 7 17.9998C7.55228 17.9998 8 17.5521 8 16.9998C8 16.4475 7.55228 15.9998 7 15.9998ZM7 15.9998V11.9998M7 16.9998L7.00707 17.0069M11 16.9998C11 19.209 9.20914 20.9998 7 20.9998C4.79086 20.9998 3 19.209 3 16.9998C3 15.9854 3.37764 15.0591 4 14.354L4 6C4 4.34315 5.34315 3 7 3C8.65685 3 10 4.34315 10 6V14.354C10.6224 15.0591 11 15.9854 11 16.9998Z\" stroke=\"#000000\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/path&gt; &lt;/g&gt;&lt;/svg&gt;`,\n  \"Heat Stress\": html`&lt;svg version=\"1.0\" id=\"Layer_1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"35px\" width=\"35px\"  viewBox=\"0 0 64 64\" enable-background=\"new 0 0 64 64\" xml:space=\"preserve\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt; &lt;g&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M32,14.002c-9.941,0-18,8.059-18,18s8.059,18,18,18 s18-8.059,18-18S41.941,14.002,32,14.002z M32,48.002c-8.837,0-16-7.164-16-16s7.163-16,16-16s16,7.164,16,16 S40.837,48.002,32,48.002z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M32,20.002c-0.553,0-1,0.447-1,1s0.447,1,1,1 c5.522,0,10,4.477,10,10c0,0.553,0.447,1,1,1s1-0.447,1-1C44,25.375,38.627,20.002,32,20.002z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M63,31H53c-0.553,0-1,0.447-1,1s0.447,1,1,1h10 c0.553,0,1-0.447,1-1S63.553,31,63,31z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M11.457,36.47l-3.863,1.035c-0.534,0.144-0.851,0.692-0.707,1.226 c0.143,0.533,0.69,0.85,1.225,0.706l3.863-1.035c0.533-0.143,0.85-0.69,0.707-1.225C12.539,36.644,11.99,36.327,11.457,36.47z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M49.32,22c0.277,0.479,0.888,0.643,1.367,0.366l8.66-5 c0.479-0.276,0.643-0.888,0.365-1.366c-0.275-0.479-0.887-0.642-1.365-0.365l-8.66,5C49.208,20.912,49.045,21.521,49.32,22z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M17.858,46.143c-0.39-0.391-1.023-0.389-1.414,0l-2.828,2.828 c-0.391,0.391-0.39,1.025,0.001,1.415c0.39,0.391,1.022,0.39,1.413-0.001l2.828-2.828C18.249,47.168,18.249,46.534,17.858,46.143z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M42,14.68c0.479,0.276,1.09,0.113,1.367-0.366l5-8.66 C48.644,5.175,48.48,4.563,48,4.287c-0.478-0.276-1.088-0.112-1.365,0.366l-4.999,8.661C41.358,13.793,41.522,14.403,42,14.68z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M26.824,51.318c-0.532-0.143-1.08,0.176-1.225,0.707l-1.035,3.863 c-0.143,0.535,0.176,1.083,0.709,1.226c0.533,0.144,1.08-0.173,1.223-0.708l1.035-3.863C27.676,52.012,27.359,51.463,26.824,51.318 z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M32,12c0.554,0,1.001-0.446,1.002-1V1c0-0.553-0.447-1-1.002-1 c-0.551,0-0.998,0.447-0.999,1l0.001,10C31.002,11.553,31.449,12,32,12z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M38.402,52.025c-0.141-0.532-0.689-0.85-1.225-0.707 c-0.533,0.143-0.848,0.692-0.707,1.225l1.035,3.863c0.144,0.535,0.693,0.85,1.227,0.707s0.849-0.689,0.705-1.225L38.402,52.025z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M20.637,14.312c0.275,0.479,0.887,0.643,1.363,0.367 c0.48-0.277,0.645-0.887,0.368-1.367l-5-8.66C17.092,4.174,16.48,4.01,16,4.287c-0.477,0.275-0.641,0.887-0.365,1.365 L20.637,14.312z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M47.558,46.142c-0.388-0.39-1.022-0.39-1.414,0 c-0.391,0.39-0.388,1.024,0,1.414l2.828,2.828c0.392,0.392,1.025,0.389,1.415-0.001c0.391-0.39,0.391-1.021-0.001-1.413 L47.558,46.142z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M4.654,17.365l8.662,4.999c0.477,0.276,1.088,0.113,1.363-0.364 c0.277-0.479,0.115-1.09-0.364-1.367l-8.661-5C5.176,15.356,4.564,15.52,4.287,16C4.013,16.477,4.176,17.089,4.654,17.365z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M52.027,38.4l3.863,1.035c0.535,0.145,1.082-0.176,1.225-0.709 c0.144-0.532-0.172-1.079-0.707-1.223l-3.863-1.035c-0.531-0.145-1.081,0.173-1.225,0.707C51.176,37.709,51.496,38.256,52.027,38.4 z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M12,32c0.001-0.554-0.445-1-0.998-1.002L1,31 c-0.552,0-1,0.445-1,1c0.001,0.551,0.448,1,1.001,1l10.001-0.002C11.553,32.998,12.001,32.552,12,32z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M52.545,27.529l3.863-1.035c0.535-0.143,0.85-0.693,0.706-1.227 c-0.142-0.531-0.688-0.848-1.224-0.705l-3.863,1.035c-0.533,0.141-0.85,0.691-0.707,1.225 C51.461,27.356,52.012,27.67,52.545,27.529z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M14.68,42c-0.275-0.48-0.886-0.644-1.365-0.368l-8.661,5.002 C4.176,46.91,4.01,47.52,4.287,48c0.277,0.477,0.889,0.641,1.367,0.365l8.66-5.002C14.791,43.088,14.957,42.479,14.68,42z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M46.144,17.856c0.389,0.392,1.022,0.388,1.414,0l2.828-2.828 c0.392-0.392,0.39-1.024-0.002-1.415c-0.388-0.39-1.021-0.391-1.412,0.001l-2.828,2.828C45.752,16.83,45.754,17.466,46.144,17.856z \"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M22,49.32c-0.479-0.277-1.088-0.113-1.365,0.364l-5,8.663 c-0.275,0.478-0.115,1.088,0.365,1.365c0.479,0.274,1.09,0.11,1.367-0.367l4.998-8.662C22.641,50.207,22.48,49.597,22,49.32z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M37.178,12.68c0.531,0.145,1.078-0.176,1.225-0.707l1.035-3.863 c0.143-0.535-0.176-1.083-0.709-1.225c-0.531-0.144-1.08,0.172-1.223,0.707l-1.035,3.863C36.324,11.986,36.645,12.536,37.178,12.68 z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M32,52c-0.553-0.002-0.998,0.446-1,0.998l0.002,10.004 C31.002,63.552,31.445,64,32,64c0.553,0,1-0.449,1.001-1l-0.003-10.002C32.998,52.447,32.555,52,32,52z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M25.6,11.973c0.139,0.533,0.691,0.85,1.225,0.707 c0.532-0.141,0.846-0.691,0.707-1.225l-1.035-3.863c-0.145-0.535-0.693-0.851-1.227-0.706c-0.531,0.142-0.85,0.688-0.705,1.224 L25.6,11.973z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M43.363,49.687c-0.275-0.478-0.883-0.644-1.363-0.365 c-0.479,0.274-0.641,0.885-0.367,1.364l5.004,8.661c0.275,0.478,0.883,0.644,1.363,0.366c0.479-0.277,0.642-0.889,0.367-1.367 L43.363,49.687z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M16.443,17.856c0.387,0.394,1.023,0.39,1.414,0 c0.391-0.388,0.387-1.021,0-1.414l-2.828-2.828c-0.393-0.392-1.025-0.39-1.415,0.002c-0.39,0.388-0.392,1.021,0.001,1.412 L16.443,17.856z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M59.348,46.633l-8.663-4.997 c-0.478-0.276-1.087-0.116-1.363,0.366c-0.278,0.477-0.112,1.086,0.364,1.364l8.664,4.999c0.477,0.275,1.086,0.115,1.363-0.365 C59.988,47.521,59.824,46.91,59.348,46.633z\"&gt;&lt;/path&gt; &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#231F20\" d=\"M11.974,25.599L8.11,24.563c-0.536-0.144-1.083,0.175-1.225,0.708 c-0.144,0.531,0.171,1.08,0.707,1.225l3.863,1.034c0.531,0.146,1.081-0.175,1.225-0.707C12.825,26.293,12.505,25.746,11.974,25.599 z\"&gt;&lt;/path&gt; &lt;/g&gt; &lt;/g&gt;&lt;/svg&gt;`,\n  \"Rainfall Variability\": html`&lt;svg width=\"35px\" height=\"35px\" viewBox=\"0 0 24 24\" id=\"Layer_1\" data-name=\"Layer 1\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt;&lt;defs&gt;&lt;style&gt;.cls-1{fill:none;stroke:#020202;stroke-miterlimit:10;stroke-width:1.91px;}&lt;/style&gt;&lt;/defs&gt;&lt;path class=\"cls-1\" d=\"M3.41,20.07a3.83,3.83,0,0,1,1.92-7.14,4.78,4.78,0,0,1,9.56,0,5.9,5.9,0,0,1-.09,1h.57a3.34,3.34,0,0,1,1.43,6.36\"&gt;&lt;/path&gt;&lt;line class=\"cls-1\" x1=\"10.59\" y1=\"17.72\" x2=\"8.2\" y2=\"22.5\"&gt;&lt;/line&gt;&lt;line class=\"cls-1\" x1=\"14.41\" y1=\"17.72\" x2=\"12.02\" y2=\"22.5\"&gt;&lt;/line&gt;&lt;line class=\"cls-1\" x1=\"6.78\" y1=\"17.69\" x2=\"4.37\" y2=\"22.5\"&gt;&lt;/line&gt;&lt;path class=\"cls-1\" d=\"M16.51,14.1a4.79,4.79,0,1,0-7-5.91\"&gt;&lt;/path&gt;&lt;line class=\"cls-1\" x1=\"13.93\" y1=\"0.5\" x2=\"13.93\" y2=\"2.41\"&gt;&lt;/line&gt;&lt;line class=\"cls-1\" x1=\"23.5\" y1=\"10.07\" x2=\"21.59\" y2=\"10.07\"&gt;&lt;/line&gt;&lt;line class=\"cls-1\" x1=\"20.7\" y1=\"3.3\" x2=\"19.35\" y2=\"4.65\"&gt;&lt;/line&gt;&lt;line class=\"cls-1\" x1=\"8.52\" y1=\"4.65\" x2=\"7.17\" y2=\"3.3\"&gt;&lt;/line&gt;&lt;/g&gt;&lt;/svg&gt;`,\n  Flood: html`&lt;svg fill=\"#000000\" width=\"37px\" height=\"37px\" viewBox=\"-3.2 -3.2 38.40 38.40\" id=\"Layer_1\" data-name=\"Layer 1\" xmlns=\"http://www.w3.org/2000/svg\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke=\"#CCCCCC\" stroke-width=\"0.05\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt; &lt;defs&gt; &lt;style&gt; .cls-1 { fill: none; } &lt;/style&gt; &lt;/defs&gt; &lt;path d=\"M29,28a2.8828,2.8828,0,0,1-1-.1816v-.0059a3.7662,3.7662,0,0,1-2.0532-2.1338A.971.971,0,0,0,25,25a1.007,1.007,0,0,0-.9487.6836A3.4376,3.4376,0,0,1,21,28a3.44,3.44,0,0,1-3.0532-2.3213A.9894.9894,0,0,0,17,25a1.007,1.007,0,0,0-.9487.6836A3.4376,3.4376,0,0,1,13,28a3.44,3.44,0,0,1-3.0532-2.3213,1,1,0,0,0-1.8955.0049A3.4376,3.4376,0,0,1,5,28H2v2H5a4.9316,4.9316,0,0,0,4-1.9873,5.0192,5.0192,0,0,0,8,0,5.0192,5.0192,0,0,0,8,0,5.1433,5.1433,0,0,0,2.1379,1.62A4.8374,4.8374,0,0,0,29,30h1V28Z\" transform=\"translate(0 0)\"&gt;&lt;/path&gt; &lt;path d=\"M28,13.63,29.7573,15,31,13.4282,16.6123,2.2139a1.0094,1.0094,0,0,0-1.2427,0L1,13.4194l1.2427,1.5718L4,13.6211v5.1875a3.6907,3.6907,0,0,1-2,2.0039V22.896a4.9958,4.9958,0,0,0,3-1.8833,5.0192,5.0192,0,0,0,8,0,5.0192,5.0192,0,0,0,8,0A4.9316,4.9316,0,0,0,25,23h5V21H28Zm-6.0513,5.0532a1,1,0,0,0-1.8955-.0049A3.44,3.44,0,0,1,17,21a3.4376,3.4376,0,0,1-3.0513-2.3164A1.007,1.007,0,0,0,13,18a.9894.9894,0,0,0-.9468.6787A3.44,3.44,0,0,1,9,21a3.37,3.37,0,0,1-3.0021-2.19L6,12.0615l9.991-7.79L26,12.0718,26.0017,21H25A3.4376,3.4376,0,0,1,21.9487,18.6836Z\" transform=\"translate(0 0)\"&gt;&lt;/path&gt; &lt;rect id=\"_Transparent_Rectangle_\" data-name=\"&lt;Transparent Rectangle&gt;\" class=\"cls-1\" width=\"32\" height=\"32\"&gt;&lt;/rect&gt; &lt;/g&gt;&lt;/svg&gt;`,\n  \"Multiple Risks\": html`&lt;svg height=\"35px\" width=\"35px\" version=\"1.1\" id=\"Capa_1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 54.264 54.264\" xml:space=\"preserve\" fill=\"#000000\"&gt;&lt;g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_tracerCarrier\" stroke-linecap=\"round\" stroke-linejoin=\"round\"&gt;&lt;/g&gt;&lt;g id=\"SVGRepo_iconCarrier\"&gt; &lt;g&gt; &lt;g&gt; &lt;g&gt; &lt;path style=\"fill:#010002;\" d=\"M52.021,49.561c-0.011-0.001-0.02-0.001-0.029,0H2.244c-0.813,0-1.563-0.439-1.959-1.15 c-0.397-0.71-0.378-1.579,0.049-2.271L25.207,5.769c0.408-0.663,1.132-1.066,1.911-1.066c0.777,0,1.502,0.403,1.91,1.066 l24.704,40.098c0.332,0.392,0.532,0.897,0.532,1.451C54.265,48.556,53.261,49.561,52.021,49.561z M6.263,45.073h41.709 L27.118,11.224L6.263,45.073z\"&gt;&lt;/path&gt; &lt;/g&gt; &lt;g&gt; &lt;path style=\"fill:#010002;\" d=\"M27.116,38.89c0.584,0,1.082,0.205,1.492,0.612c0.408,0.412,0.613,0.907,0.613,1.49 c0,0.586-0.217,1.081-0.648,1.493c-0.434,0.406-0.919,0.612-1.457,0.612c-0.537,0-1.022-0.206-1.455-0.612 c-0.432-0.412-0.646-0.907-0.646-1.493c0-0.583,0.203-1.078,0.613-1.49C26.036,39.094,26.532,38.89,27.116,38.89z M28.589,35.945 h-2.944V18.062h2.944V35.945z\"&gt;&lt;/path&gt; &lt;/g&gt; &lt;/g&gt; &lt;/g&gt; &lt;/g&gt;&lt;/svg&gt;`,\n});\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n#style"
  },
  {
    "objectID": "notebooks/livestock-notebook/notebook.html",
    "href": "notebooks/livestock-notebook/notebook.html",
    "title": "Appendix",
    "section": "",
    "text": "import { heroImage } from \"/helpers/hero.js\";\nhero_url = \"./../../images/livestockInvest.webp\";\n\nhero = heroImage(notebookTitle, hero_url);\nhtml`${hero}`;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nimport { atlasTOC } from '/helpers/toc.ojs' \n{\n  await nbText // force wait/reload with nbText to load so headings have correct labels/languages\n  return atlasTOC({\n      heading: `&lt;b&gt;${_lang({en:\"In this notebook\", fr:\"Dans ce notebook\"})}&lt;/b&gt;`,\n      skip: [notebookTitle, \"notebook-title\", \"Appendix\", \"source-code\"]\n      })\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n// pretty view of language toggle\nviewof prettyLanguageView = {\n  return Inputs.bind(\n    Inputs.radio(languages, {\n      label: _lang(nbText.legends.language),\n      format: (d) =&gt; d.label\n    }),\n    viewof language\n  );\n}\n\n\n\n\n\n\n\nviewof colorblindData = {\n  const data = [\n    { key: \"None\", label: _lang(nbText.legends.colorblind.values.non) },\n    { key: \"Deuteranopia\", label: _lang(nbText.legends.colorblind.values.deu) },\n    { key: \"Protanopia\", label: _lang(nbText.legends.colorblind.values.pro) },\n    { key: \"Tritanopia\", label: _lang(nbText.legends.colorblind.values.tri) },\n  ];\n  return Inputs.select(data, {\n    label: _lang(nbText.legends.colorblind.label),\n    format: x =&gt; x.label,\n    value: data.find(d =&gt; d.key == 'None')\n  });\n}\n\n\n\n\n\n\n\n{\n  const title = _lang(nbText.sections.overview.title);\n  const intro = _lang(nbText.sections.overview.intro);\n  const inspiration = _lang(nbText.sections.overview.inspiration);\n\n  return md`# ${title}\n\n${intro}\n\n${inspiration}`;\n}\n\n\n\n\n\n\n\n{\n  const title = _lang(nbText.sections.livestockExplosion.title)\n  const intro = _lang(nbText.sections.livestockExplosion.intro)\n\n  return md`# ${title}\n\n  ${intro}`\n}\n\n\n\n\n\n\n\n// viewof Area_chart_type = Inputs.radio([\"Stock\", \"GHG Emissions\", \"Value of production\"], {label: \"Variable\", value: 'Stock'})\n\nviewof Area_chart_type = {\n  const data = [\n    {\n      key: \"stock\",\n      label: _lang(\n        nbText.sections.livestockExplosion.chart.variables.stock.label\n      ),\n      yLabel: _lang(nbText.sections.livestockExplosion.chart.variables.stock.tip)\n    },\n    {\n      key: \"ghg\",\n      label: _lang(\n        nbText.sections.livestockExplosion.chart.variables.ghg.label\n      ),\n      yLabel: _lang(nbText.sections.livestockExplosion.chart.variables.ghg.tip)\n    },\n    {\n      key: \"vop\",\n      label: _lang(\n        nbText.sections.livestockExplosion.chart.variables.vop.label\n      ),\n      yLabel: _lang(nbText.sections.livestockExplosion.chart.variables.vop.tip)\n    }\n  ].map((d) =&gt; ({\n    // common values\n    ...d,\n    xLabel: _lang(nbText.sections.livestockExplosion.chart.labels.year)\n  }));\n\n  return Inputs.radio(data, {\n    label: _lang(nbText.sections.livestockExplosion.chart.inputLabel),\n    format: (x) =&gt; x.label,\n    value: data.find((x) =&gt; x.key == \"stock\")\n  });\n}\n\n\n\n\n\n\n\nareaChart = {\n  // Note the colour change in the origional plots is from stock vs dataStock in other notebook...\n  // TODO: Double check this\n  if (Area_chart_type.key === \"stock\") {\n    const titles = [\n      _lang(nbText.sections.livestockExplosion.chart.variables.stock.tip),\n      _lang(nbText.sections.livestockExplosion.chart.labels.year)\n    ];\n    return buildAreaChart(\n      dataStock.map((obj, i) =&gt; convertToFloat(obj, \"TLU (millons)\")),\n      titles,\n      colorblindData.key\n    );\n  } else if (Area_chart_type.key === \"ghg\") {\n    const titles = [\n      _lang(nbText.sections.livestockExplosion.chart.variables.ghg.tip),\n      _lang(nbText.sections.livestockExplosion.chart.labels.year)\n    ];\n    return buildAreaChart(\n      dataGHG.map((obj, i) =&gt; convertToFloat(obj, \"emissions (MtCo2e)\")),\n      titles,\n      colorblindData.key\n    );\n  } else if (Area_chart_type.key === \"vop\") {\n    const titles = [\n      _lang(nbText.sections.livestockExplosion.chart.variables.vop.tip),\n      _lang(nbText.sections.livestockExplosion.chart.labels.year)\n    ];\n    return buildAreaChart(\n      dataVOP.map((obj, i) =&gt; convertToFloat(obj, \"VOP (billions usd)\")),\n      titles,\n      colorblindData.key,\n      true\n    );\n  }\n}\n\n\n\n\n\n\n\nareaDownload = {\n  let button;\n  let data;\n  let filename;\n\n  const fButtonLabel = _lang(\n    nbText.sections.livestockExplosion.download.labelFunc\n  );\n  const buttonLabel = fButtonLabel(Area_chart_type.label);\n\n  if (Area_chart_type.key === \"stock\") {\n    data = await FileAttachment(\"1_FAO_stocks_years.csv\").csv();\n    filename = \"stock\";\n  } else if (Area_chart_type.key === \"ghg\") {\n    data = await FileAttachment(\"1_FAO_ghg_years.csv\").csv();\n    filename = \"ghg\";\n  } else if (Area_chart_type.key === \"vop\") {\n    data = await FileAttachment(\"1_FAO_vop_year.csv\").csv();\n    filename = \"vop\";\n  }\n\n  button = build_download_button_dev(data, buttonLabel, filename);\n\n  return button;\n}\n\n\n\n\n\n\n\ndynamicTextQuickInsightsRegion();\n\n\n\n\n\n\n\n{\n  const title = _lang(nbText.sections.leversOfChange.title)\n  const intro = _lang(nbText.sections.leversOfChange.intro)\n\n  return md`# ${title}\n\n  ${intro}`\n}\n\n\n\n\n\n\n\nviewof map_configuration = Inputs.radio(\n  new Map([\n    [_lang(nbText.sections.leversOfChange.inputs.radio.values.adap), 'adaptation'],\n    [_lang(nbText.sections.leversOfChange.inputs.radio.values.adap_mit), 'adaptation_mitigation'],\n    [_lang(nbText.sections.leversOfChange.inputs.radio.values.mit), 'mitigation']\n  ]),\n  {label: _lang(nbText.sections.leversOfChange.inputs.radio.label), value: 'adaptation_mitigation'}\n)\n\n\n\n\n\n\n\nviewof num_priorities = {\nlet num_selector = Inputs.number([1, 42], {label: _lang(nbText.sections.leversOfChange.inputs.num.label), value : 5})\n\n  num_selector.addEventListener('input', (event) =&gt; {\n  d3.select(\"#num_countries\").html(`${event.target.value}`)\n  });\n\n\nreturn num_selector\n}\n\n\n\n\n\n\n\ncreate_map(colorblindData.key);\n\n\n\n\n\n\n\ncreate_map(colorblindData.key).node();\n\n\n\n\n\n\n\n\n\n{\n  const div = document.createElement(\"div\");\n  div.style.display = \"flex\";\n  div.style.flexDirection = \"row\";\n\n  div.appendChild(\n    build_download_button_dev(\n      data_categories,\n      _lang(nbText.sections.leversOfChange.chart.download.categories),\n      \"adaptation_mitigation_categories\",\n      \".download_data_am\"\n    )\n  );\n  div.appendChild(\n    build_download_button_dev(\n      climate,\n      _lang(nbText.sections.leversOfChange.chart.download.climate),\n      \"climate_hazards_per_adaptation\",\n      \".download_data_am\"\n    )\n  );\n  div.appendChild(\n    build_download_button_dev(\n      emissions,\n      _lang(nbText.sections.leversOfChange.chart.download.emissions),\n      \"emissions_per_animals\",\n      \".download_data_am\",\n      \"clasetatata\"\n    )\n  );\n\n  return div;\n}\n\n\n\n\n\n\n\nviewof country_select = Inputs.select([''].concat(countriesFiltered), {label: _lang(nbText.sections.leversOfChange.livestockProductionSystems.countryInput.label), value: '', format: l =&gt; _lang(nbText.general.admin0_ISO3[l])})\n\n\n\n\n\n\n\n{\n  const title = _lang(nbText.sections.leversOfChange.insights.title)\n  return md`### ${title}`\n}\n\n\n\n\n\n\n\n{\n  const template = _lang(\n    nbText.sections.leversOfChange.insights.investmentPriorities\n  );\n  const insight = template({\n    percAdaptation: initial_data[0].percent,\n    percMitigation: initial_data[1].percent,\n    countryCount: num_priorities,\n    livestockProd: insight_object.vop_text,\n    peopleExposed: insight_object.people,\n    ggEmissions: insight_object.emissions\n  });\n\n  return md`${insight}`;\n}\n\n\n\n\n\n\n\n{\n  const template = _lang(\n    nbText.sections.leversOfChange.insights.mostCritical\n  );\n  const insight = template({\n    lever: _lang(nbText.general.country_article1[insight_object.iso_selected]), \n    percVop: insight_object.per_vop, \n    percEmissions: insight_object.per_emi\n  });\n\n  return md`${insight}`;\n}\n\n\n\n\n\n\n\n{\n  const template = _lang(\n    nbText.sections.leversOfChange.insights.countrySystems\n  );\n  const insight = template({\n    first: _lang(nbText.general.lps[insight_object.lps1]),\n    second: _lang(nbText.general.lps[insight_object.lps2]),\n    third: _lang(nbText.general.lps[insight_object.lps3]),\n  });\n\n  return md`${insight}`;\n}\n\n\n\n\n\n\n\n{\n  const template = _lang(\n    nbText.sections.leversOfChange.insights.sigHazard\n  );\n  const insight = template({\n    location: _lang(nbText.general.country_article2[insight_object.iso_selected]),\n    hazard: insight_object.top_hazard,\n    vop: insight_object.top_haz_vop\n  });\n\n  return md`${insight}`;\n}\n\n\n\n\n\n\n\n{\n  const header = _lang(nbText.sections.leversOfChange.livestockProductionSystems.header)\n  const intro = _lang(nbText.sections.leversOfChange.livestockProductionSystems.tableIntro)\n\n  return md`### ${header}\n\n  ${intro}`\n}\n\n\n\n\n\n\n\nrender_country_table();\n\n\n\n\n\n\n\n{\n  const div = document.createElement(\"div\");\n  div.style.display = \"flex\";\n  div.style.flexDirection = \"row\";\n\n  FileAttachment(\"country_emissions_hazards-4.csv\")\n    .csv()\n    .then((data) =&gt; {\n      div.appendChild(\n        build_download_button_dev(\n          data,\n          _lang(nbText.sections.leversOfChange.livestockProductionSystems.download.ghg),\n          \"GHG emissions and exposure\",\n          \".button_container_ghg\",\n          \"button_download_ghg\"\n        )\n      );\n    });\n\n  FileAttachment(\"3_country_lps_hazards.csv\")\n    .csv()\n    .then((data_lps) =&gt; {\n      div.appendChild(\n        build_download_button_dev(\n          data_lps,\n          _lang(nbText.sections.leversOfChange.livestockProductionSystems.download.lps_hazards),\n          \"LPS Hazards\",\n          \".button_container_ghg\",\n          \"button_download_lps_hazards\"\n        )\n      );\n    });\n\n  FileAttachment(\"3_country_lps_emissions.csv\")\n    .csv()\n    .then((data_lps) =&gt; {\n      div.appendChild(\n        build_download_button_dev(\n          data_lps,\n          _lang(nbText.sections.leversOfChange.livestockProductionSystems.download.lps_emissions),\n          \"LPS Emissions\",\n          \".button_container_ghg\",\n          \"button_download_lps_emissions\"\n        )\n      );\n    });\n\n  return div;\n}\n\n\n\n\n\n\n\n{\n  const title = _lang(nbText.sections.scalableSolutions.title)\n  const intro = _lang(nbText.sections.scalableSolutions.intro)\n\n  return md`# ${title}\n\n  ${intro}`\n}\n\n\n\n\n\n\n\nviewof solution_Selectors = {\n  const title = _lang(nbText.sections.scalableSolutions.table.title);\n  return Inputs.form([viewof select_system, viewof select_species], {\n    template: (inputs) =&gt;\n      html`&lt;h3&gt;${title}&lt;/h3&gt;&lt;div style=\"display: flex; gap: 2em;\"&gt; ${Object.values(\n        inputs\n      )}&lt;/div&gt;`\n  });\n}\n\n\n\n\n\n\n\ncreateSolutionTable(filterSolutions);\n\n\n\n\n\n\n\nbuild_download_button_dev(\n  solutionData,\n  _lang(nbText.sections.scalableSolutions.download),\n  \"Adaptation and mitigation options\",\n  \".button_container\",\n);\n\n\n\n\n\n\n\n{\n  const title = _lang(nbText.sections.summary.title)\n  return md`# ${title}`\n}\n\n\n\n\n\n\n\n{\n  // summary, based on num countries in 'levers of change'\n  \n  const iIntro = _lang(nbText.sections.summary.intro);\n\n  const countryListFunc = _lang(nbText.sections.summary.countryListFunc);\n  const multiCountryString =\n    num_priorities &gt; 1\n      ? _lang(nbText.sections.summary.countryListSupport.topStringFunc)({\n          num: num_priorities\n        })\n      : \"\";\n  const topCountry = _lang(\n    nbText.sections.summary.countryListSupport.topCountryFunc\n  )({\n    top: _lang(nbText.general.country_article1[summary_object.firstCountry])\n  });\n  let countryList = summary_object.countryArray\n    .map((d, i) =&gt; (i &lt; 4 ? ` **${_lang(nbText.general.country_article1[d])}**` : \"\"))\n    .filter(Boolean)\n    .join(\", \");\n  const followedBy = _lang(nbText.sections.summary.countryListSupport.followedBy);\n  countryList =\n    summary_object.countryArray.length &gt; 0\n      ? `${followedBy} ${countryList}`\n      : countryList;\n  const severalOthers =\n    summary_object.countryArray.length &gt; 4\n      ? _lang(nbText.sections.summary.countryListSupport.severalOthers)\n      : \"\";\n\n  const iCountryList = countryListFunc({\n    num: num_priorities,\n    multiCountryString: multiCountryString,\n    topCountryString: topCountry,\n    multiString: countryList,\n    severalOthersString: severalOthers\n  });\n\n  const outroFunc = _lang(nbText.sections.summary.outroFunc);\n  const iOutro = outroFunc({\n    people: summary_object.sumPopulationMillion.toFixed(0),\n    livestock: summary_object.sumVOPBillion.toFixed(0),\n    footprint: summary_object.sumGHG.toFixed(2)\n  });\n  return md`${iIntro} ${iCountryList} ${iOutro}`;\n}\n\n\n\n\n\n\n\nhtml`&lt;section&gt;\n  &lt;h1&gt;${_lang(nbText.sections.methods.title)}&lt;/h1&gt;\n  &lt;div&gt;\n    &lt;h3&gt;${_lang(nbText.sections.methods.sections.datasets.title)}&lt;/h3&gt;\n    &lt;p&gt;${_lang(nbText.sections.methods.sections.datasets.body)}&lt;/p&gt;\n  &lt;/div&gt;\n  &lt;div&gt;\n    &lt;h4&gt;${_lang(nbText.sections.methods.sections.livestockProdSystems.title)}&lt;/h4&gt;\n    &lt;p&gt;${_lang(nbText.sections.methods.sections.livestockProdSystems.body)}&lt;/p&gt;\n  &lt;/div&gt;\n  &lt;div&gt;\n    &lt;h4&gt;${_lang(nbText.sections.methods.sections.exposureData.title)}&lt;/h4&gt;\n    &lt;p&gt;${_lang(nbText.sections.methods.sections.exposureData.body)}&lt;/p&gt;\n  &lt;/div&gt;\n  &lt;div&gt;\n    &lt;h4&gt;${_lang(nbText.sections.methods.sections.hazardData.title)}&lt;/h4&gt;\n    &lt;p&gt;${_lang(nbText.sections.methods.sections.hazardData.body)}&lt;/p&gt;\n  &lt;/div&gt;\n  &lt;div&gt;\n    &lt;h4&gt;${_lang(nbText.sections.methods.sections.povertyData.title)}&lt;/h4&gt;\n    &lt;p&gt;${_lang(nbText.sections.methods.sections.povertyData.body)}&lt;/p&gt;\n  &lt;/div&gt;\n  &lt;div&gt;\n    &lt;h4&gt;${_lang(nbText.sections.methods.sections.greenhouseEmissionsData.title)}&lt;/h4&gt;\n    &lt;p&gt;${_lang(nbText.sections.methods.sections.greenhouseEmissionsData.body)}&lt;/p&gt;\n  &lt;/div&gt;\n  &lt;div&gt;\n    &lt;h4&gt;${_lang(nbText.sections.methods.sections.boundaries.title)}&lt;/h4&gt;\n    &lt;p&gt;${_lang(nbText.sections.methods.sections.boundaries.body)}&lt;/p&gt;\n  &lt;/div&gt;\n  &lt;div&gt;\n    &lt;h4&gt;${_lang(nbText.sections.methods.sections.adaptationOptions.title)}&lt;/h4&gt;\n    &lt;p&gt;${_lang(nbText.sections.methods.sections.adaptationOptions.body)}&lt;/p&gt;\n  &lt;/div&gt;\n  &lt;div&gt;\n    &lt;h3&gt;${_lang(nbText.sections.methods.sections.methods.title)}&lt;/h3&gt;\n    &lt;h4&gt;${_lang(nbText.sections.methods.sections.prioritizationAnalysis.title)}&lt;/h4&gt;\n    &lt;p&gt;${_lang(nbText.sections.methods.sections.prioritizationAnalysis.body)}&lt;/p&gt;\n  &lt;/div&gt;\n  &lt;div&gt;\n    &lt;h3&gt;${_lang(nbText.sections.methods.sections.references.title)}&lt;/h3&gt;\n    &lt;p&gt;${_lang(nbText.sections.methods.sections.references.body)}&lt;/p&gt;\n  &lt;/div&gt;\n&lt;/section&gt;`;\n\n\n\n\n\n\n\nAppendix\n\nmd`### Download Button`;\n\n\n\n\n\n\n\nbuild_download_button_dev = (data, text, file_name) =&gt; {\n  const container = DOM.element(\"div\");\n  const button = DOM.element(\"button\");\n  button.className = \"button_download_data\";\n  button.textContent = text;\n  button.onclick = () =&gt; download_data(data, file_name);\n  container.appendChild(button);\n  return container;\n};\n\n\n\n\n\n\n\ndownload_data = (data, file_name) =&gt; {\n  const csv_file_name = file_name + \".csv\";\n  const csvContent = convertToCSV(data);\n  const blob = new Blob([csvContent], { type: \"text/csv\" });\n  const url = window.URL.createObjectURL(blob);\n\n  const link = document.createElement(\"a\");\n  link.href = url;\n  link.setAttribute(\"download\", csv_file_name);\n  document.body.appendChild(link);\n\n  link.click();\n\n  // Limpiar y revocar el objeto URL creado\n  window.URL.revokeObjectURL(url);\n  document.body.removeChild(link);\n};\n\n\n\n\n\n\n\nconvertToCSV = (data) =&gt; {\n  const csvContent = [];\n\n  // En cabezados del CSV\n  const headers = Object.keys(data[0]);\n\n  csvContent.push(headers.join(\",\"));\n\n  // Filas de datos del CSV\n  data.forEach((item) =&gt; {\n    const values = headers.map((header) =&gt; item[header]);\n    csvContent.push(values.join(\",\"));\n  });\n\n  return csvContent.join(\"\\n\");\n};\n\n\n\n\n\n\n\nmd`### Color Blind Helpers`;\n\n\n\n\n\n\n\ncolor_blind = import(\"https://cdn.jsdelivr.net/npm/color-blind@0.1.3/+esm\");\n\n\n\n\n\n\n\nfunction getColorBlind(colorBlind) {\n  let colorScaleBase = d3[`schemeTableau10`];\n  if (colorBlind === \"Deuteranopia\")\n    colorScaleBase = colorScaleBase.map((e) =&gt;\n      color_blind.default.deuteranopia(e),\n    );\n  else if (colorBlind === \"Protanopia\")\n    colorScaleBase = colorScaleBase.map((e) =&gt;\n      color_blind.default.protanopia(e),\n    );\n  else if (colorBlind === \"Tritanopia\")\n    colorScaleBase = colorScaleBase.map((e) =&gt;\n      color_blind.default.tritanopia(e),\n    );\n  return colorScaleBase;\n}\n\n\n\n\n\n\n\nfunction getColorBlind_Input(colorBlind, color) {\n  if (colorBlind === \"Deuteranopia\")\n    color = color_blind.default.deuteranopia(color);\n  else if (colorBlind === \"Protanopia\")\n    color = color_blind.default.protanopia(color);\n  else if (colorBlind === \"Tritanopia\")\n    color = color_blind.default.tritanopia(color);\n  return color;\n}\n\n\n\n\n\n\n\nfunction getColorBlindRGB(colorBlind, color) {\n  if (colorBlind === \"Deuteranopia\")\n    color = color_blind.default.deuteranopia(color, true);\n  else if (colorBlind === \"Protanopia\")\n    color = color_blind.default.protanopia(color, true);\n  else if (colorBlind === \"Tritanopia\")\n    color = color_blind.default.tritanopia(color, true);\n\n  return !color.R ? color : `rgb(${color.R}, ${color.G}, ${color.B})`;\n}\n\n\n\n\n\n\n\ngetColorBlindRGB(colorblindData.key, \"#216729\");\n\n\n\n\n\n\n\nmd`## Livestock Explosion / Area Plot`;\n\n\n\n\n\n\n\nfunction convertToFloat(obj, i) {\n  obj[i] = parseFloat(obj[i]);\n  obj[\"year\"] = parseInt(obj[\"year\"]);\n  return obj;\n}\n\n\n\n\n\n\n\nbuildAreaChart = (data, titles, colorBlind = \"None\", condition = false) =&gt; {\n  // const areaContainer = d3.select(\"#main_area_chart\")\n  //   .append(\"div\")\n  //   .attr(\"id\", \"area_container\");\n\n  const data_titles = Object.keys(data[0]);\n\n  let plotAreaGraph = Plot.areaY(data, {\n    x: data_titles[0],\n    y: data_titles[2],\n    fill: data_titles[1],\n    tip: {\n      channels: {\n        cat: {\n          label: _lang(\n            nbText.sections.livestockExplosion.chart.labels.category,\n          ),\n          value: (d) =&gt;\n            _lang(\n              nbText.sections.livestockExplosion.chart.legend[\n                d.category.replace(\" \", \"\").toLowerCase()\n              ],\n            ),\n        },\n      },\n      format: {\n        x: (d) =&gt; d3.format(\"d\")(d).replace(/\\D/g, \"\"),\n        cat: true,\n        y: true,\n        fill: false,\n        z: false,\n      },\n    },\n  });\n\n  let chartColor = {\n    legend: true,\n    range: getColorBlind(colorBlind),\n    tickFormat: (label) =&gt;\n      _lang(\n        nbText.sections.livestockExplosion.chart.legend[\n          label.replace(\" \", \"\").toLowerCase()\n        ],\n      ),\n  };\n\n  if (condition) {\n    plotAreaGraph = Plot.areaY(data, {\n      x: data_titles[0],\n      y: data_titles[1],\n      fill: true,\n      tip: {\n        format: {\n          x: (d) =&gt; d3.format(\"d\")(d).replace(/\\D/g, \"\"),\n          z: false,\n          fill: false,\n        },\n      },\n    });\n\n    chartColor = {\n      range: getColorBlind(colorBlind),\n      tickFormat: (label) =&gt;\n        _lang(\n          nbText.sections.livestockExplosion.chart.legend[\n            label.replace(\" \", \"\").toLowerCase()\n          ],\n        ),\n    };\n  }\n  const plotArea = Plot.plot({\n    color: chartColor,\n    y: {\n      label: titles[0],\n    },\n    x: {\n      label: titles[1],\n      tickFormat: (d) =&gt; d3.format(\"d\")(d).replace(/\\D/g, \"\"),\n    },\n    marginBottom: 35,\n    marginLeft: condition ? 65 : titles[0] == \"Emissions\" ? 45 : 60,\n    marks: [plotAreaGraph, Plot.ruleY([0])],\n  });\n\n  // document\n  //   .querySelector(\"#area_container\")\n  //   .appendChild(\n  //     plotArea\n  //   )\n  return plotArea;\n};\n\n\n\n\n\n\n\nasync function dynamicTextLivestockExplosion() {\n  // // await createAreaChart(select);\n  // const lalivestockInvest.webpstYear =  [...document.querySelectorAll('#area_container .plot-d6a7b5-figure g[aria-label=\"x-axis tick label\"] text')].map(label =&gt; label.textContent).pop();\n\n  // const firstYear =  [...document.querySelectorAll('#area_container .plot-d6a7b5-figure g[aria-label=\"x-axis tick label\"] text')].map(label =&gt; label.textContent).shift()\n\n  // let labels = Array.from(test_areachart.querySelectorAll('.plot-d6a7b5-figure g[aria-label=\"x-axis tick label\"] text'))\n  //   .map(label =&gt; label.textContent);\n\n  // // Crear un nuevo elemento &lt;b&gt; con el contenido del último año\n  // const boldElement = document.createElement('b');\n  // boldElement.textContent = `(${d3.min(labels)} - ${d3.max(labels)})`;\n\n  // hardc oding these as they seem constany anyway...\n  const boldElement = document.createElement(\"b\");\n  boldElement.textContent = `(2010 - 2021)`;\n\n  return Object.assign(\n    html`&lt;h1&gt;The livestock explosion&lt;/h1&gt;&lt;p&gt;The visualization below helps you explore historical &lt;b&gt; ${boldElement.textContent}  &lt;/b&gt;trends in livestock population, value of production (VoP), and greenhouse gas (GHG) emissions. These trends give a measure of the rapid pace of growth of the sector, and therefore its importance for people and the environment.&lt;/p&gt;`,\n  );\n}\n\n\n\n\n\n\n\nfunction dynamicTextQuickInsightsRegion() {\n  const maxYearStock = Math.max(...dataStock.map((obj) =&gt; parseInt(obj.year)));\n  const minYearStock = Math.min(...dataStock.map((obj) =&gt; parseInt(obj.year)));\n\n  const lastYearDataStock = dataStock.filter(\n    (obj) =&gt; parseInt(obj.year) === maxYearStock,\n  );\n  const firstYearDataStock = dataStock.filter(\n    (obj) =&gt; parseInt(obj.year) === minYearStock,\n  );\n\n  const sumTLULastMillion = lastYearDataStock.reduce(\n    (acc, obj) =&gt; acc + parseFloat(obj[\"TLU (millons)\"]),\n    0,\n  );\n  const sumTLULastBillion = sumTLULastMillion / 1000;\n  const sumTLUFirstMillion = firstYearDataStock.reduce(\n    (acc, obj) =&gt; acc + parseFloat(obj[\"TLU (millons)\"]),\n    0,\n  );\n  const sumTLUFirstBillion = sumTLUFirstMillion / 1000;\n\n  const percentageIncreaseStock =\n    ((sumTLULastBillion - sumTLUFirstBillion) / sumTLUFirstBillion) * 100;\n\n  const maxYearVOP = Math.max(...dataVOP.map((obj) =&gt; parseInt(obj.year)));\n  const minYearVOP = Math.min(...dataVOP.map((obj) =&gt; parseInt(obj.year)));\n\n  const lastYearDataVOP = dataVOP.filter(\n    (obj) =&gt; parseInt(obj.year) === maxYearVOP,\n  );\n  const firstYearDataVOP = dataVOP.filter(\n    (obj) =&gt; parseInt(obj.year) === minYearVOP,\n  );\n\n  const sumVOPLastMillion = lastYearDataVOP.reduce(\n    (acc, obj) =&gt; acc + parseFloat(obj[\"VOP (millones usd)\"]),\n    0,\n  );\n  const sumVOPLastBillion = sumVOPLastMillion / 1000;\n  const sumVOPFirstMillion = firstYearDataVOP.reduce(\n    (acc, obj) =&gt; acc + parseFloat(obj[\"VOP (millones usd)\"]),\n    0,\n  );\n  const sumVOPFirstBillion = sumVOPFirstMillion / 1000;\n\n  const percentageIncreaseVOP =\n    ((sumVOPLastBillion - sumVOPFirstBillion) / sumVOPFirstBillion) * 100;\n\n  const maxYearGHG = Math.max(...dataGHG.map((obj) =&gt; parseInt(obj.year)));\n  const minYearGHG = Math.min(...dataGHG.map((obj) =&gt; parseInt(obj.year)));\n\n  const lastYearDataGHG = dataGHG.filter(\n    (obj) =&gt; parseInt(obj.year) === maxYearGHG,\n  );\n  const firstYearDataGHG = dataGHG.filter(\n    (obj) =&gt; parseInt(obj.year) === minYearGHG,\n  );\n\n  const sumGHGLast = lastYearDataGHG.reduce(\n    (acc, obj) =&gt; acc + parseFloat(obj[\"emissions (MtCo2e)\"]),\n    0,\n  );\n  const sumGHGFirst = firstYearDataGHG.reduce(\n    (acc, obj) =&gt; acc + parseFloat(obj[\"emissions (MtCo2e)\"]),\n    0,\n  );\n\n  const timesIncreaseGHG = sumGHGLast / sumGHGFirst;\n\n  // insight, translated\n  const i = {\n    title: _lang(nbText.sections.quickInsightsGeneral.header)({\n      selection: _lang(nbText.legends.ssa),\n    }),\n    livestock: _lang(nbText.sections.livestockExplosion.insights.livestock)({\n      selection: _lang(nbText.legends.ssa),\n      year: maxYearStock,\n      population: sumTLULastBillion.toFixed(0),\n      percent: percentageIncreaseStock.toFixed(1),\n      yearSince: minYearStock,\n    }),\n    vop: _lang(nbText.sections.livestockExplosion.insights.vop)({\n      selection: _lang(nbText.legends.ssa),\n      year: maxYearVOP,\n      population: sumVOPLastBillion.toFixed(0),\n      percent: percentageIncreaseVOP.toFixed(1),\n      yearSince: minYearVOP,\n    }),\n    ghg: _lang(nbText.sections.livestockExplosion.insights.ghg)({\n      mult: timesIncreaseGHG.toFixed(1),\n    }),\n  };\n\n  return Object.assign(\n    html`&lt;h3&gt;${i.title}&lt;/h3&gt;\n&lt;p&gt;${i.livestock}&lt;/p&gt;\n&lt;p&gt;${i.vop}&lt;/p&gt;\n&lt;p&gt;${i.ghg}&lt;/p&gt;`,\n  );\n\n  //   return Object.assign(\n  //     html`&lt;h3&gt;Quick Insights for Sub-Saharan Africa&lt;/h3&gt;\n  // &lt;p&gt;&lt;b&gt;Sub-Saharan Africa’s&lt;/b&gt; livestock population in &lt;b&gt;${maxYearStock}&lt;/b&gt; is &lt;b&gt;${sumTLULastBillion.toFixed(\n  //       0\n  //     )} billion&lt;/b&gt;, and has grown by &lt;b&gt;${percentageIncreaseStock.toFixed(\n  //       1\n  //     )}%&lt;/b&gt; since &lt;b&gt;${minYearStock}&lt;/b&gt;&lt;/p&gt;\n  // &lt;p&gt;&lt;b&gt;Sub-Saharan Africa’s&lt;/b&gt; value of production in &lt;b&gt;${maxYearVOP}&lt;/b&gt; is &lt;b&gt;${sumVOPLastBillion.toFixed(\n  //       0\n  //     )} billion&lt;/b&gt;, and has grown by &lt;b&gt;${percentageIncreaseVOP.toFixed(\n  //       1\n  //     )}%&lt;/b&gt; since &lt;b&gt;${minYearVOP}&lt;/b&gt;&lt;/p&gt;\n  // &lt;p&gt;The explosion in livestock numbers comes at the expense of a growth in &lt;b&gt;GHG emissions&lt;/b&gt; of &lt;b&gt;${timesIncreaseGHG.toFixed(\n  //       1\n  //     )}&lt;/b&gt; times in the same period&lt;/p&gt;`\n  //   );\n}\n\n\n\n\n\n\n\nmd`## Countries as Levers / Map`;\n\n\n\n\n\n\n\nmd`### Icons`;\n\n\n\n\n\n\n\nicons = new Object({\n  bovine:\n    '&lt;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"45px\" height=\"45px\" viewBox=\"0 0 512 512\"&gt;&lt;path fill=\"currentColor\" d=\"M468.958 108.958c-27.507 2.08-48.997 7.94-71.375 22.572c-5.333-2.214-12.62-17.738-16-16c-11.82 6.08-14.892 19.555-4.916 32.817l-59.084 9.916c-24.776 3.341-49.567 4.838-74.187 5.334c1.326 3.832 2.96 7.636 4.812 10.05c5.219 6.802 20.323 6.21 21.07 14.75c1.935 22.098-24.876 47.415-47.056 47.057c-15.401-.248-17.017-28.762-31.604-33.713c-19.097-6.482-41.62 18.77-59.699 9.832c-15.267-7.547-24.992-39.8-27.836-50.41c-10.213-.127-20.327-.142-30.316.035c-12.564.366-22.902 5.645-29.408 14.239c-8.676 11.458-11.652 26.658-13.254 42.925c-1.78 18.057 6.147 53.007 5.517 70.282c-.504 13.85-7.493 11.87-11.912 18.888c-13.52 21.47 8.894 20.83 17.014 5.56c12.482-23.473 4.253-63.11 7.195-92.974c1.855-35.76 10.597-23.937 15.664-24.588c-4.2 13.065-6.21 30.962-7 51.334c6.895-2.342 36.498-11.6 42.73-.174c6.872 12.598-27.802 22.016-23.878 35.819c2.464 8.666 22.95 2.378 24.582 11.238c3.322 18.035-32.13 38.713-42.236 44.209c.812 23.329 1.564 45.567 1.238 65.086H88.91c-4.234-16.543-12.038-49.944-4.06-55.084c21.425-18.091 29.836-37.484 42.732-56.428c8.755 2.556 16.92 4.787 24.782 6.672c3.553.972 7.244 1.771 10.984 2.44c24.859 4.967 61.553 5.678 90.783-.172c3.76 34.12 7.263 68.452 4.602 102.572h28.957c-12.375-26.902-4.263-65.044 13.892-86.27l44.934-33.462c24.881-16.384 42.93-37.996 55.982-63.38c30.402 3.413 57.086 3.29 77.192-.786l12.84-19.55c-24.257-17.857-43.3-36.585-62.948-58.13c10.063-14.533 25.027-22.765 39.375-32.506zm-39.375 54.572a8 8 0 1 1 0 16a8 8 0 0 1 0-16M366.2 183.481c5.029 9.822-26.17 10.808-24.933 21.772c.998 8.847 22.204 3.839 23.53 12.643c3.818 25.373-28.44 53.805-54.08 54.78c-14.262.544-34.902-14.06-32.308-28.093c2.605-14.092 34.551-1.657 40.383-14.748c4.724-10.603-18.352-22.01-12.992-32.307c6.264-12.032 30.364-22.553 41.934-22.646c11.57-.093 15.606 3.347 18.466 8.6zm-26.585 126.346l-34.707 23.96l6.464 69.255h34.414c-11.783-22.454-15.58-55.506-6.171-93.215m-204.561 1.41c-6.047 12.184-14.147 21.97-22.174 31.242c5.97 3.235 11.648 5.414 17.154 6.614c11.218 2.443 21.636.333 29.948-4.408c10.056-5.737 17.521-14.452 24.115-23.368c-14.615-.869-32.96-2.962-49.043-10.08m24.252 52c-8.737 2.585-17.452 3.7-25.566 2.96c5.167 12.624 10.45 24.152 15.824 36.845h28.306c-10.393-18.48-16.148-29.285-18.564-39.805\"/&gt;&lt;/svg&gt;',\n  pig: '&lt;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"40px\" height=\"40px\" viewBox=\"0 0 512 512\"&gt;&lt;path fill=\"currentColor\" d=\"m213.705 344.935l2.7 53.87h-26.24l-19.46-55.41zm150.56.33l-.34 4.38l18.15 49.16h24.44l-5.66-56.51a326.16 326.16 0 0 1-36.57 2.97zm32.79-164.08a90.06 90.06 0 0 0 13.05-1.12c51.2-7.62 36.49-49.56 36.49-49.56s-40.36 9-52.83 23.42c.02 0-28.12 27.26 3.31 27.26zm81.85-25.33s-6.81 0-15.92.82a47 47 0 0 1-13.28 22.9a116.55 116.55 0 0 1 7.44 14.09c25.25-9.43 21.79-37.81 21.79-37.81zm11.8 100.18v41.49s-53.15 31.9-134.5 31.9c-2.19 0-4.44-.15-6.67-.2l-5.48 69.58h-19l-24.45-66.86l-162.59-5.87l-9.4 72.73h-22.63s-48.15-101.58-23.18-182.06c-5.55-3.84-11.38-8.17-16.73-12.7c-5.13 2.65-10.26 4.11-15 3.85c-15.76-.85-28.37-12.73-29.78-14.09l11.16-11.46c2.6 2.5 11.21 9.13 19.48 9.57a7.93 7.93 0 0 0 1.7-.11a46.36 46.36 0 0 1-4.59-6.47c-5.65-9.83-7-20.32-3.84-28.79a25.1 25.1 0 0 1 15.94-14.87c11.29-3.81 26.85-3.35 34.75 4.9c2.94 3.07 7.24 9.84 3 20.7c-3.59 9.29-10.85 19.34-19.36 27.12c2.87 2.3 5.94 4.61 9.09 6.87c9.46-20.85 24.84-39.58 48.52-53.76a238.9 238.9 0 0 1 124-34.31a259.14 259.14 0 0 1 120.54 30.12a80.94 80.94 0 0 0-7.77 9.25c-7.6 10.67-9.67 20.49-6.15 29.19c2.85 7 10.23 15.42 29.24 15.42a105 105 0 0 0 15.41-1.3a80.49 80.49 0 0 0 24-7.18c15.75 25.72 17.22 58.67 28 61c12.79 2.72 26.29 6.34 26.29 6.34m-406.69-94.52c.43-1.12 1.05-3.11.32-3.87c-1.32-1.38-4.81-2.26-8.92-2.26a29.18 29.18 0 0 0-9.16 1.42c-3.13 1.05-5.12 2.81-6.09 5.38c-1.46 3.95-.46 9.62 2.75 15.19a36.3 36.3 0 0 0 4.79 6.25c6.66-5.82 13.19-14.04 16.31-22.11m331.14 81.55a9.05 9.05 0 1 0-9.05 9.05a9.05 9.05 0 0 0 9.05-9.05\"/&gt;&lt;/svg&gt;',\n  poultry:\n    '&lt;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"40px\" height=\"40px\" viewBox=\"0 0 24 24\"&gt;&lt;path fill=\"currentColor\" d=\"M19.886 7.426c.057-.011.126-.018.179-.026a.4.4 0 0 1 .2.049a.061.061 0 0 0 .089-.067c-.02-.063-.049-.138-.065-.19a.144.144 0 0 0-.1-.093a.106.106 0 0 1-.081-.126a.266.266 0 0 1 .049-.108a.762.762 0 0 0 .142-.64a.511.511 0 0 0-.2-.261a.077.077 0 0 1-.02-.115a.233.233 0 0 0 .044-.13a.91.91 0 0 0-.06-.294a.489.489 0 0 1 0-.168c.016-.078-.086-.126-.086-.126s.077-.082 0-.246c-.077-.164-.6-.215-.6-.215s.077-.335-.345-.5c-.341-.13-.613.4-.706.617a.124.124 0 0 1-.142.067a.08.08 0 0 1-.053-.13l.28-.3a.112.112 0 0 0-.041-.179l-.032-.015l.016-.007a.236.236 0 0 0 .146-.3v-.001a.237.237 0 0 0-.142-.145l-.058-.023a.273.273 0 0 1-.138-.126l-.044-.089a.282.282 0 0 0-.268-.145a1.46 1.46 0 0 0-.894.412c-.511.469-.869 2.523-.93 2.928a.25.25 0 0 1-.06.127c-.053.063-.143.167-.268.305a3.734 3.734 0 0 1-1.708 1.027a17.71 17.71 0 0 1-2.3.126a6.685 6.685 0 0 1-2.347-.405c-.538-.314-.997-1.946-1.61-2.552a3.388 3.388 0 0 0-1.559-.811a1.1 1.1 0 0 0-.341-.015a.076.076 0 0 1-.077-.112a1.039 1.039 0 0 0 .073-.138c.008-.048-.069-.167-.069-.167l-.138-.112l-.057-.078l-.155-.048l-.028-.019a.072.072 0 0 0-.1.037l-.045.131s-.1-.2-.167-.168c-.109.056 0 .35 0 .35s-.2-.335-.312-.283c-.2.09.04.521.04.521s-.15-.264-.255-.223c-.053.018 0 .35 0 .35s-.109-.038-.15-.019c-.041.019.045.279.045.279H4.31a.082.082 0 0 0-.077.052l-.016.045l-.073.059a.212.212 0 0 0-.073.2l.016.086l-.021.089l.009.1a1.785 1.785 0 0 0-.313.294a.831.831 0 0 0-.118.457a.415.415 0 0 1 .179-.119l.191-.1a.664.664 0 0 1 .381-.067a.479.479 0 0 0 .065 0h.175a1.275 1.275 0 0 0-.1.361a.574.574 0 0 0 .669.566a.536.536 0 0 0 .39-.257A6.978 6.978 0 0 0 4.952 8.8a4.639 4.639 0 0 0 .921 3.318C7.035 13.6 8.781 13.971 9.2 14.272c.419.301.974.923 1.364 1.131c.345.186.845.729 1.393 1.15a3.7 3.7 0 0 0 .642.431a11.784 11.784 0 0 1-.662 2.065a.278.278 0 0 1-.285.156a5.751 5.751 0 0 0-.836-.022a2.259 2.259 0 0 0-.54.167c-.041.015-.024.067.016.067c.191 0 .483 0 .593.011c0 0 .219.067.223.067c-.032 0-.3.008-.345.012a7.256 7.256 0 0 0-1.218.186a.036.036 0 0 0 .008.07c.2.019.585.056.755.082c.256.041.362.164.63.212a1.689 1.689 0 0 1-.309.164c-.13.03-.312.335-.422.536c-.016.029.02.063.057.048c.227-.119.731-.387.792-.409a5.557 5.557 0 0 1 1.27-.376c.029-.007.078-.019.159-.145c.219.03.463.071.662.108a1.6 1.6 0 0 1-.309.163c-.13.03-.3.324-.418.529a.039.039 0 0 0 .057.048c.2-.115.572-.335.735-.42a6.957 6.957 0 0 1 1.319-.354c.033-.007.094-.026.2-.216a.291.291 0 0 1 .171-.137a1.772 1.772 0 0 1 .426-.108c.09.1.382.1.512.093h.085a.025.025 0 0 0 .02-.041l-.056-.059c0-.008-.143-.153-.248-.253a1.471 1.471 0 0 0-.646-.1c.094-.253.207-.577.333-1.012c.118-.372.224-.748.309-1.075a2.083 2.083 0 0 0 1.027-1.112a2.957 2.957 0 0 0 1.218-2a8.472 8.472 0 0 0-.58-2.392a3.86 3.86 0 0 0 1.266-.4a2.678 2.678 0 0 0 .845-1.715a8.267 8.267 0 0 0 .049-1.034a.218.218 0 0 1 .122-.175a.7.7 0 0 0 .146-.085A2.716 2.716 0 0 1 20.243 8a.067.067 0 0 0 .053-.1a.876.876 0 0 0-.207-.205l-.236-.156a.064.064 0 0 1 .033-.113M14.2 19.041c-.04.09-.2.09-.308.082a5.074 5.074 0 0 0-.861-.022a3.3 3.3 0 0 0-.333.048c.089-.245.585-1.856.682-2.221a4.536 4.536 0 0 0 .755-.457c.285-.264.309-.395.309-.395a1.391 1.391 0 0 0 .451.8a12.607 12.607 0 0 1-.695 2.165\"/&gt;&lt;/svg&gt;',\n  shoat:\n    '&lt;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"40px\" height=\"40px\" viewBox=\"0 0 512 512\"&gt;&lt;path fill=\"currentColor\" d=\"M392.8 107.5c9.3 5.3 25.8 9.3 40 9.2c7.7-.1 14.6-1.2 19.5-3.2c5-1.8 6.9-4.9 8.9-8.8c-9.2-6.08-22.1-12.27-31.8-12.87c-14.9.53-28.8 8.13-36.6 15.67m-253 20.2c-1.7 5.5-7.9 8.1-13 5.4c-26.5-14.5-50.46-6.9-67.71 8.7c-35.93 32.6-45.13 87.3-32.47 145.7c7.31 33.6 18.99 53 41.29 62.8c0 .1.1.1.15.1c2.22 1 4.21 1.9 6.09 2.8l4.61-22c1.02-4.9 5.8-8 10.66-7s7.98 5.8 6.96 10.7l-23.5 112c4.79 7.2 16.4 1.2 21.3-1.2l38.12-106.5c10.8-9.4 21.2-19 28.7-29.2c6.6-9.1 10.4-18.4 10.6-23.5c.2-5 4.4-8.9 9.4-8.7c5 .2 9 4.6 8.6 9.6c-.6 11.2-6.2 22.4-14 33.2c-7.3 10-16.7 19.6-27.2 27.2l-3.3 8.9c6.9 8.7 13.4 13.8 19.6 16.8c8.8 4.1 17.7 4.6 28.5 3.3c16.4-1.9 34.6-12.9 43.5-37.2c2.8-7.7 13.6-8 16.8-.5c7.7 21.2 36.1 32.6 55.1 24l-3.9-23.3c-.8-4.9 2.5-9.6 7.4-10.4c4.9-.9 9.6 2.5 10.4 7.4l17.6 105.9c9.2 6.3 14.5 2.4 19.9-4.4l-13.8-114.4c-.7-5.3 3.3-10 8.6-10.2c4.8-.2 8.8 3.3 9.3 8l4.3 35.7c5.1-1.2 9.1-2.5 12.4-5c4.3-3.2 8.5-8.7 12.1-21.5c1.7-6 9-8.5 14.1-4.7c13.6 8.3 27.4-1.8 35.6-12.2c12.9-16.5 14.7-42.4 13.2-69.2c-2.1.3-4.2.5-6.3.6c-8.8.5-17.9-.9-25.7-4.4c-12.4-7-22-18.4-28.2-28.9c-3.9-6.8-7.3-13.7-10.5-20c-5.4 9.9-11 23.1-19.2 25c-12.5 2.1-23.9-3.7-29.8-12.7c-5.9-8.9-7.4-20.2-4.8-31.1c2.7-11.7 9.8-38.3 22.6-56.1c2.2-2.9 4.5-5.3 6.8-7.4c-7.5-3.1-16.2-3.8-22.9-3.8c-5.8 0-13.5 1.8-19.7 5c-6.2 3.3-10.7 7.8-12.2 11.8c-3.2 8.5-15.5 7.5-17.3-1.3c-3.8-22.78-53.9-17.8-65.6 2c-3.8 7-14.1 5.9-16.5-1.7c-8.1-22.61-62.7-21.3-66.7 5.9m345-1.5c1.7 16.4 3.5 32.2 4.2 45.6c1.8 6.5 6 18.9 8.7 7.3c.9-4.1.8-11-.4-18.6c-.1-7.1-14.5-47.3-12.5-34.3m-112.7-2.5c-11.9 15-19.2 37.4-23.3 53.7c-.6 5.8-.6 12.6 2.3 17.1c2.3 3.4 4.8 5.2 9.4 5c5.8-9.4 12.1-19.8 15.6-28.2c-1.2-7.9-2.8-19.9-3.6-31.4c-.4-5.8-.6-11.2-.4-16.2m94.4 2.4c-2.4 1.6-4.8 3.1-7.5 4.1c-7.8 3.2-16.8 4.4-26 4.5c-14.8.1-30.2-2.7-42.9-8.4c0 3.6.1 7.7.4 12.3c.9 12.6 3 27.2 4 33.5c10.5 16.6 19.9 44.4 36.8 52.5c5.8 2 11.9 3.1 17.2 2.9c6-.4 10.6-2.6 11.5-3.7c3.5-8 5.9-15.2 7.3-22.3c2.1-10.9 3.4-23.3 3.6-31.6c.3-6.4-.6-13.3-1.1-18.7c-1.4 4.1-5.7 6.6-10 5.9c-4.3-.7-7.5-4.4-7.5-8.8c0-5.1 4.2-9.2 9.3-9c3 0 5.8 1.7 7.4 4.3c-.9-6.1-1.4-12-2.5-17.5m-58.3 16.5c4.9.2 8.7 4.2 8.7 9c0 5-4 9-9 9c-4.9 0-9-4-9-9s4.2-9.1 9.3-9m47.5 48.3c3.7-.1 6.5 1.9 6.5 6.2c0 7.8-5.8 15-12.7 19l-1-23.1c2.5-1.4 5-2.1 7.2-2.1m-24.1 2c1.8-.1 3.9.4 5.8 1.3l3.8 22.5c-6-3.7-15.4-3.6-16.5-16.1c-.5-5.2 2.8-7.7 6.9-7.7m-30.9 164.2c-3.7 5.1-7.6 9.1-12.6 12.1l16.6 62c7.6 1.5 15.9 1 19.2-5.1zm-241.2 33.7l1.5 46.8c7.9 7.9 12.9 4.8 19.7-3l-3.7-39.5c-6.3-.9-12.6-2.2-17.5-4.3\"/&gt;&lt;/svg&gt;',\n  \"forest loss to pasture\":\n    '&lt;svg width=\"40px\" height=\"40px\" viewBox=\"0 0 559 455\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"&gt;&lt;path d=\"M547.5 131H389.5\" stroke=\"black\" stroke-width=\"23\" stroke-linecap=\"round\"/&gt;&lt;path d=\"M427.563 0.938011C279.435 127.053 198.49 333.144 176.313 454.5H253.531C285.128 332.005 304.666 191.006 427.564 0.937012L427.563 0.938011ZM44.375 53.374C96.772 116.17 146.685 185.824 186.469 252.654C193.619 264.667 200.557 276.804 207.279 289.062C215.326 269.35 224.029 249.911 233.374 230.78C181.557 159.55 119.91 95.775 44.374 53.375L44.375 53.374ZM435.563 187.094C383.975 233.592 356.707 301.547 344.969 377.749C358.744 403.584 371.673 429.044 383.905 453.624H423.28C398.03 382.164 411.743 291.264 435.563 187.094ZM33 202.437C105.962 275.697 153.794 391.037 113.094 453.217H158.094C162.588 428.097 169.434 399.584 178.781 368.967C160.338 284.68 97.42 204.927 33 202.44V202.437ZM0.125 290.374C53.145 371.31 61.83 415.34 41.063 452.97H108.563C95.463 380.95 77.119 336.665 0.125 290.375V290.374ZM301.063 335.968C290.413 377.328 281.875 416.405 272.25 454.218H363.97C344.826 415.932 324.051 375.826 301.063 335.968Z\" fill=\"black\"/&gt;&lt;/svg&gt;',\n  \"forest loss to soy\":\n    '&lt;svg width=\"40px\" height=\"40px\" viewBox=\"0 0 72 72\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"&gt;&lt;g clip-path=\"url(#clip0_297_267)\"&gt;&lt;path d=\"M23.98 40.57C28.548 44.089 38.95 49.85 44.593 51.988C47.791 53.2 54.507 54.605 58.152 55.006C58.817 55.08 59.67 54.977 60.572 54.87C61.606 54.746 63.165 54.561 63.653 54.862C63.807 55.005 64.128 55.67 64.416 56.432C63.646 56.785 62.592 57.292 62.114 57.637C61.733 57.913 61.249 58.295 60.717 58.715C60.03 59.259 59.189 59.923 58.432 60.449C53.535 61.629 47.989 60.298 44.572 58.983C34.665 55.173 25.804 47.837 20.947 42.98C18.057 40.09 15.789 36.86 13.017 32.293V28.463C15.237 31.458 19.9 37.428 23.98 40.57Z\" fill=\"white\"/&gt;&lt;path d=\"M25.2002 38.985C25.0782 38.891 24.9532 38.785 24.8302 38.685C25.1878 37.7642 25.8158 36.9732 26.6315 36.4159C27.4471 35.8587 28.4123 35.5614 29.4002 35.563C30.3706 35.5615 31.3198 35.8471 32.1283 36.3838C32.9369 36.9204 33.5686 37.6842 33.9442 38.579C34.0479 38.8229 34.2438 39.0159 34.4892 39.1159C34.7346 39.2159 35.0095 39.2149 35.2542 39.113C35.4091 39.0454 35.544 38.939 35.646 38.8042C35.7479 38.6693 35.8134 38.5105 35.8362 38.343C36.0262 38.9221 36.1369 39.5242 36.1652 40.133C34.955 41.3032 34.1375 42.8198 33.8252 44.474C30.4212 42.55 27.2222 40.543 25.2002 38.985ZM47.0612 50.694C46.3992 50.499 45.7982 50.304 45.3012 50.115C42.7542 49.15 39.2142 47.427 35.7032 45.516C35.9382 42.343 38.5892 39.831 41.8212 39.831C42.8354 39.8304 43.834 40.0812 44.7275 40.5611C45.6211 41.0411 46.3816 41.7351 46.9412 42.581C47.0882 42.8018 47.3169 42.9552 47.5769 43.0075C47.837 43.0598 48.1072 43.0068 48.3282 42.86C48.5227 42.7282 48.6638 42.5313 48.7261 42.3047C48.7885 42.0781 48.7679 41.8368 48.6682 41.624C49.159 42.4036 49.5122 43.2617 49.7122 44.161C48.8699 44.9745 48.2 45.9492 47.7425 47.0271C47.2849 48.105 47.0492 49.264 47.0492 50.435C47.0492 50.522 47.0592 50.607 47.0612 50.694ZM60.3352 52.881C59.5832 52.971 58.8062 53.06 58.3702 53.015C56.0262 52.758 52.2382 52.041 49.1022 51.25C49.0702 50.98 49.0482 50.708 49.0482 50.435C49.0482 46.711 52.0782 43.682 55.8012 43.682C59.5242 43.682 62.5552 46.712 62.5552 50.435C62.5552 51.216 62.4152 51.979 62.1542 52.708C61.5632 52.736 60.9442 52.808 60.3342 52.881M23.2512 37.307C21.4492 35.619 19.6192 33.561 18.0292 31.632C18.523 31.317 19.0955 31.1472 19.6812 31.142C20.4045 31.1431 21.1052 31.3942 21.6647 31.8527C22.2242 32.3112 22.608 32.949 22.7512 33.658C22.7766 33.7868 22.8273 33.9093 22.9001 34.0185C22.973 34.1278 23.0666 34.2216 23.1758 34.2946C23.2849 34.3676 23.4073 34.4183 23.5361 34.444C23.6649 34.4696 23.7974 34.4696 23.9262 34.444C24.1508 34.3977 24.3522 34.2745 24.4957 34.0956C24.6392 33.9167 24.7157 33.6933 24.7122 33.464C24.7502 33.715 24.7892 33.965 24.7892 34.226C24.7892 34.681 24.7032 35.11 24.5852 35.526C24.0471 36.0436 23.5965 36.645 23.2512 37.307Z\" fill=\"white\"/&gt;&lt;path d=\"M8.51997 23.86C8.96397 23.565 10.088 23.3 11.36 23.776C12.281 24.12 13.205 24.664 14.105 25.394C14.358 25.6 14.594 25.806 14.807 26.006H12.019C11.7538 26.006 11.4994 26.1114 11.3119 26.2989C11.1243 26.4864 11.019 26.7408 11.019 27.006V31.11L10.067 29.863C9.88397 29.623 9.60197 29.479 9.29897 29.47C8.98297 29.482 8.70697 29.591 8.51097 29.822L7.72397 30.747C7.52697 29.403 7.35697 28.076 7.35697 27.594C7.35697 26.242 7.55997 24.496 8.51997 23.86ZM13.017 34.066V32.173L13.045 32.219V32.312C15.817 36.88 18.085 40.109 20.975 42.999C25.832 47.856 34.692 55.192 44.599 59.002C47.283 60.035 51.279 61.072 55.243 60.9C55.31 60.898 55.377 60.896 55.443 60.892C55.684 60.879 55.923 60.86 56.163 60.837C56.291 60.826 56.42 60.817 56.548 60.802C56.67 60.789 56.791 60.768 56.913 60.752C57.413 60.685 57.908 60.589 58.399 60.477C57.919 60.809 57.474 61.084 57.127 61.233C51.501 63.643 44.393 61.266 42.348 60.479C31.382 56.261 22.292 47.697 19.768 45.173C16.934 42.339 14.745 39.151 12.242 35.028C12.274 35.021 12.306 35.023 12.337 35.013C12.5351 34.9461 12.7073 34.8187 12.8293 34.6488C12.9512 34.479 13.0169 34.2751 13.017 34.066ZM64.53 49.914L64.543 49.922C65.031 50.232 65.783 51.284 66.043 51.885C65.814 51.978 65.623 52.04 65.435 52.098C65.089 52.208 64.733 52.321 64.287 52.584H64.284C64.463 51.8823 64.5544 51.1612 64.556 50.437C64.556 50.261 64.54 50.088 64.53 49.914Z\" fill=\"black\"/&gt;&lt;path d=\"M34.8499 38.19C34.3729 37.0577 33.556 36.1015 32.5121 35.4535C31.4682 34.8056 30.2488 34.4979 29.0224 34.573C27.7961 34.6481 26.6233 35.1023 25.6662 35.8728C24.7092 36.6432 24.0151 37.692 23.6799 38.874M47.7569 42.027C46.9098 40.7471 45.6728 39.7743 44.2293 39.2527C42.7858 38.7311 41.2127 38.6885 39.7431 39.1313C38.2736 39.574 36.9858 40.4786 36.0707 41.7107C35.1556 42.9429 34.6619 44.4372 34.6629 45.972M62.9299 53.454C63.396 52.3491 63.5995 51.1511 63.5243 49.9543C63.4492 48.7574 63.0974 47.5943 62.4968 46.5564C61.8961 45.5184 61.0629 44.6339 60.0627 43.9725C59.0624 43.311 57.9223 42.8905 56.7321 42.7441C55.5418 42.5977 54.3339 42.7294 53.2031 43.1288C52.0724 43.5282 51.0497 44.1844 50.2154 45.0459C49.3812 45.9073 48.7581 46.9505 48.3952 48.0935C48.0322 49.2365 47.9394 50.4481 48.1239 51.633\" stroke=\"black\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/&gt;&lt;path d=\"M13.2701 27.141C15.2621 29.877 20.2601 36.456 24.5731 39.777C29.1831 43.327 39.4901 48.989 44.9301 51.051C48.1191 52.259 54.8551 53.637 58.2441 54.009C59.7141 54.171 62.9031 53.232 64.1611 54.009C64.8641 54.444 65.6411 56.968 65.6411 56.968C65.6411 56.968 63.3531 57.964 62.6811 58.448C61.4091 59.365 58.9461 61.528 57.5041 62.145C52.3271 64.365 45.7841 62.872 41.9721 61.405C32.3561 57.707 23.7571 50.588 19.0421 45.873C16.0841 42.915 13.8051 39.609 10.9071 34.779C10.2281 33.648 9.82712 32.379 9.59512 31.161M6.33711 20.34C6.33711 20.34 5.88712 19.778 5.43812 18.856C4.93512 17.822 4.98811 15.709 4.98811 15.709\" stroke=\"black\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/&gt;&lt;path d=\"M23.7149 33.463C23.565 32.7135 23.2101 32.0203 22.6897 31.4605C22.1692 30.9008 21.5037 30.4963 20.7671 30.2923C20.0305 30.0882 19.2518 30.0925 18.5175 30.3046C17.7832 30.5168 17.1222 30.9285 16.6079 31.494M63.6169 53.796C63.6169 53.796 64.6029 53.55 64.7219 53.476C65.4549 53.028 65.8579 53.106 66.9109 52.576C67.7099 52.174 65.9819 49.66 65.0609 49.076C64.5969 48.781 63.9909 48.489 63.2849 48.202M11.6899 22.832C12.8579 23.268 13.8839 23.936 14.7159 24.611C16.1759 25.796 17.0409 27.001 17.0409 27.001H11.9999V34.06L9.25293 30.464L7.04893 33.054C7.04893 33.054 6.33693 28.697 6.33693 27.587C6.33693 24.629 7.21193 23.507 7.94693 23.02C8.65893 22.549 10.1029 22.242 11.6889 22.833L11.6899 22.832Z\" stroke=\"black\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/&gt;&lt;path d=\"M43 26.5C56.2 26.5 60.8333 26.5 61.5 26.5\" stroke=\"black\" stroke-width=\"3\" stroke-linecap=\"round\"/&gt;&lt;/g&gt;&lt;defs&gt;&lt;clipPath id=\"clip0_297_267\"&gt;&lt;rect width=\"72\" height=\"72\" fill=\"white\" transform=\"matrix(-1 0 0 1 72 0)\"/&gt;&lt;/clipPath&gt;&lt;/defs&gt;&lt;/svg&gt;',\n});\n\n\n\n\n\n\n\nicons1 = new Object({\n  \"Tropical livestock units\":\n    '&lt;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\" viewBox=\"0 0 72 72\"&gt;&lt;path fill=\"#fff\" d=\"M15 12.021c0 .612.306 1.183.815 1.522l4.244 2.83c.577.384 1.774.872 1.688 1.56l-1.705 6.728c-.028.224-.014.451.04.67l1.835 7.338a1.8 1.8 0 0 1 .04.67l-.915 7.322c-.028.224-.014.452.04.67l1.747 6.983c.11.442.38.826.76 1.078l1.73 1.154c.434.29.723.749.797 1.264l-.26 3.798s-.292 3.108 2.301 6.05c1.633 1.854 5.715 3.885 8.266 3.885c3.34 0 5.954-1.938 7.395-3.646c.891-1.058 2.54-2.498 3.282-5.825c.201-.902-.1-3.696-.1-3.696c0-.248.401-1.311.499-1.539l1.306-2.508a.574.574 0 0 1 .039-.08c.54-.863.788-1.878.885-2.892c0 0 .904-4.975 1.158-6.64c.005-.033-.5-5.516-.495-5.549l1.55-6.817a1.827 1.827 0 0 0-.019-.698l-1.536-6.913a1.829 1.829 0 0 1 1.341-2.172l1.642-.41a1.83 1.83 0 0 0 1.02-.677l2.244-2.993c.238-.316.366-.701.366-1.097v-.11c0-1.17-1.115-1.144-2.258-.89l-6.19.487c-.36.08-.735.05-1.077-.087l-4.36-1.745a1.819 1.819 0 0 0-.236-.076l-7.362-1.84a1.828 1.828 0 0 0-1.022.039l-5.372 1.79c-.082.028-.162.06-.24.1l-3.41 1.705a1.83 1.83 0 0 1-1 .184l-7.462-.746A1.83 1.83 0 0 0 15 12.022Z\"/&gt;&lt;path fill=\"#8d8d8d\" d=\"m65.182 16.575l-3.566.242c-.13.009-.26.035-.383.077l-7.08 2.42a1.518 1.518 0 0 0-.128.05l-2.64 1.18a1.44 1.44 0 0 1-.361.11c-1.374.226-10.173 1.887-10.02 7.265c0 0-.464 3.6 1.951 6.148c1.88 1.982 2.99 4.647 2.52 7.34c-.31 1.776-1.252 3.53-3.47 4.593l2.91 1.022c.43.15.767.489.917.918l1.476 4.22l1.662-1.772c1.114-1.194 1.969-5.874 1.969-5.874a40.135 40.135 0 0 0-.039-11.157s1.26-.965 1.26-.965c.162-.124.346-.213.542-.263l5.563-1.415c.172-.043.334-.117.48-.217l4.302-2.961a1.5 1.5 0 0 0 .443-.478l2.601-4.446a1.5 1.5 0 0 0 .193-.566l.485-3.787a1.497 1.497 0 0 0-1.587-1.684m-58.315 0l3.566.242c.13.009.259.035.383.077l7.08 2.42c.044.015.086.031.127.05l2.641 1.18c.117.053.234.089.361.11c1.374.226 10.173 1.887 10.02 7.265c0 0 .464 3.6-1.952 6.148c-1.88 1.982-2.988 4.647-2.519 7.34c.31 1.776 1.252 3.53 3.47 4.593l-2.91 1.022c-.43.15-.767.489-.917.918l-1.477 4.22l-1.661-1.772c-1.114-1.194-2.041-6.908-2.041-6.908a29.648 29.648 0 0 1 .507-9.482a1.497 1.497 0 0 0-.553-1.507l-.466-.357a1.499 1.499 0 0 0-.632-.283l-6.06-1.144a1.502 1.502 0 0 1-.57-.238l-4.262-2.933a1.498 1.498 0 0 1-.444-.478l-2.6-4.446a1.498 1.498 0 0 1-.193-.566L5.28 18.26a1.497 1.497 0 0 1 1.587-1.684\"/&gt;&lt;path fill=\"#bababa\" d=\"m27.32 47.995l-.66 1.131a15.722 15.722 0 0 0-.703 6.741a2.229 2.229 0 0 0 2.01 1.968l.082.007l6.496-.515a19.891 19.891 0 0 1 3.75.058l5.926.654a2.554 2.554 0 0 0 2.064-.712a2.58 2.58 0 0 0 .775-1.723l.048-1.02a13.7 13.7 0 0 0-1.491-6.896a2.602 2.602 0 0 0-2.234-1.415L34.754 46h-3.963c-1.43 0-2.751.76-3.471 1.994\"/&gt;&lt;path d=\"M26.162 31.06s-3.048-.22-3.829-1a2 2 0 0 1 2.829-2.829c.78.781 1 3.828 1 3.828\"/&gt;&lt;path fill=\"none\" stroke=\"#000\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"m19.62 26.235l2.037-9.248s-7.68-.627-6.505-7.445c0 0 9.953 3.292 12.775.47c0 0 6.237-6.664 16.195-.043c3.323 2.21 12.775-.47 12.775-.47c1.176 6.818-6.505 7.445-6.505 7.445l2.038 9.248M28.483 46h15.726c.272 0 .532.114.708.321c.847 1 3.144 4.347 2.094 10.297a1.895 1.895 0 0 1-2.203 1.55c-3.476-.64-11.324-1.79-16.76-.326a1.87 1.87 0 0 1-2.343-1.591c-.302-2.511-.315-6.628 2.01-9.868a.945.945 0 0 1 .768-.383\"/&gt;&lt;path fill=\"none\" stroke=\"#000\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M29.867 50.277s-.686 2.855 3.154 2.926m-3.893 8.263s6.348 7.916 13.793.314M17.518 20.154c-3.064-1.957-7.38-4.587-12.436-3.342c0 0-1.489 14.029 15.362 15.518l1.213.88s-2.29 8.918 1.262 16.102\"/&gt;&lt;path d=\"M45.887 31.014s3.047-.22 3.828-1a2 2 0 1 0-2.828-2.828c-.78.78-1 3.828-1 3.828\"/&gt;&lt;path fill=\"none\" stroke=\"#000\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M43.182 50.234s.686 2.855-3.154 2.926m14.746-33.201c3.048-1.888 7.269-4.402 12.192-3.19c0 0 1.49 14.029-15.36 15.518l-1.214.88s2.538 7.978-1.014 15.162\"/&gt;&lt;/svg&gt;',\n  \"Pasture area\":\n    '&lt;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\" viewBox=\"0 0 512 512\"&gt;&lt;path fill=\"currentColor\" d=\"M166.83 19.52c-28.898.023-61.718 16.366-86.002 55.16c70.773-24.38 69.905 19.077 130.02 36.95c12.785 18.24 21.513 41.086 27.45 72.214c1.056 9.14 1.425 18.935 1.495 29.078c.16 23.53-1.74 48.726-3.072 69.72v.008c-.405 6.982 2.976 17.98 9.282 29.364c2.745 4.956 6.048 9.978 9.584 14.9c2.945-59.286 1.044-113.128 11.27-161.432c7.12-19.412 16.723-35.71 28.833-49.156c67.6-14.804 59.14-58.506 140.966-33.137c-32.607-39-72.186-55.092-104.357-54.516c-43.914.786-74.014 32.628-53.743 79.654c-11.398 13.628-20.738 29.502-27.87 47.6c-5.473-19.157-12.575-35.512-21.55-49.703c14.37-51.287-19.7-86.736-62.307-86.704zm35.234 169.918l-75.488 1.767l-69.416 94.99l72.125 67.22l89.992-8.677l-89.04 36.268l-57.38-54.893l37.702 84.155l110.41 28.816l-99.382-4.197l5.566 12.425L294.17 494.85L422 423.97v-.01l-31.676-45.116l-94.816 42.367l99.135-72.116l28.097 41.947l1.78-79.19l-66.54-78.248l-55.644-12.608l-24.406 36.445l6.95 26.154l-9.353 14.8c-.525 15.73-1.216 31.995-2.38 48.768l23.2 32.524l-36.1 41.71l15.515 31.862l-37.116-35.465l33.95-39.223l-11.094-15.55l-4.88-5.268c-10.016-10.814-19.717-23.594-26.968-36.682c-4.9-8.843-8.81-17.798-10.6-26.716l-18.118-36.536L216.27 217.8l.554-.048z\"/&gt;&lt;/svg&gt;',\n  \"Rural population\":\n    '&lt;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\" viewBox=\"0 0 72 72\"&gt;&lt;path fill=\"currentColor\" d=\"M54.97 59.042s2-13.993-10-13.993c-3.192 2.128-5.926 3.599-9 3.593h.125c-3.073.006-5.808-1.465-9-3.593c-12 0-10 13.993-10 13.993\"/&gt;&lt;path fill=\"currentColor\" d=\"m27.033 45.049l5.803 8.887l3.197-5.294m9-3.593l-5.804 8.887l-3.196-5.294\"/&gt;&lt;path fill=\"#7f7f7f\" d=\"M57.912 39.453h5.48v4.245h-5.48z\"/&gt;&lt;path fill=\"#8d8d8d\" d=\"M62.652 54.839v-11.1h-4v15.303h4.203v-4.203z\"/&gt;&lt;path fill=\"#b2b2b2\" d=\"M22.162 45.09h4.288v13.971h-4.288z\"/&gt;&lt;path fill=\"#b2b2b2\" d=\"m49.653 58.205l-27.491-.17v.978h27.491z\"/&gt;&lt;path fill=\"#b2b2b2\" d=\"M48.92 45.09h-4.289v13.942h4.289z\"/&gt;&lt;path fill=\"#bababa\" d=\"M27.185 16.27V8.068l8.785 1.418l8.785-1.418v8.202\"/&gt;&lt;path fill=\"#a6a6a6\" d=\"M27.185 12.854h17.446v2.659H27.185z\"/&gt;&lt;path fill=\"#c9c9c9\" d=\"M24.724 24.994a17.756 17.756 0 0 0-.169 5.69l-.473-.523s-4.653-6.851 2.553-13.89h18.213c7.206 7.039 2.554 13.89 2.554 13.89l-5.66-12.625s-1.478 3.806-5.654 3.493c0 0 1.064-4.759-.284-4.759c0 0-5.183 6.217-11.073 8.725\"/&gt;&lt;path fill=\"#bfbfbf\" d=\"M41.742 17.536s-1.478 3.806-5.654 3.493c0 0 1.064-4.759-.284-4.759c0 0-5.18 6.212-11.066 8.722c-.015.075-.032.147-.046.222c-.062.344-.11.695-.152 1.048c-.02.167-.046.331-.06.5a17.81 17.81 0 0 0-.077 1.594c0 .45.021.893.054 1.331c.01.14.027.276.04.414c.69 7.003 5.456 12.428 11.245 12.428c5.992 0 10.887-5.815 11.298-13.175z\"/&gt;&lt;path d=\"M41.97 26.995a2 2 0 1 1-4.001-.001a2 2 0 0 1 4.001.001m-8 0a2 2 0 1 1-4.001-.001a2 2 0 0 1 4.001.001m2 10.003c-1.152 0-2.304-.287-3.447-.858a1 1 0 1 1 .894-1.79c1.718.86 3.388.86 5.106 0a1 1 0 0 1 .894 1.79c-1.143.571-2.295.858-3.447.858\"/&gt;&lt;path fill=\"none\" stroke=\"#000\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" d=\"m27.033 45.049l5.803 8.887l3.197-5.294m9-3.593l-5.804 8.887l-3.196-5.294M53.48 23.795s-2.376 15.416 7.085 15.658V23.795m7.085 0s2.376 15.416-7.085 15.658V23.795m-2.653 15.658h5.48v4.245h-5.48zm4.74 18.616v-14.33h-4v14.32\"/&gt;&lt;path fill=\"none\" stroke=\"#000\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" d=\"M54.97 58.05s2-13-10-13c-3.192 2.127-5.926 3.598-9 3.592h.125c-3.073.006-5.808-1.465-9-3.593c-12 0-10 13-10 13m5.067-12.048v12.034m27.491-12.034v12.063\"/&gt;&lt;path fill=\"none\" stroke=\"#000\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" d=\"M27.301 45.305v12.73l17.448-.014V45.284\"/&gt;&lt;path fill=\"none\" stroke=\"#000\" stroke-miterlimit=\"10\" d=\"M24.724 24.994a17.756 17.756 0 0 0-.169 5.69l-.473-.523s-4.653-6.851 2.553-13.89h18.213c7.206 7.039 2.554 13.89 2.554 13.89l-5.66-12.625s-1.478 3.806-5.654 3.493c0 0 1.064-4.759-.284-4.759c0 0-5.183 6.217-11.073 8.725\"/&gt;&lt;path fill=\"none\" stroke=\"#000\" stroke-miterlimit=\"10\" stroke-width=\"2\" d=\"M24.953 24.994a17.608 17.608 0 0 0-.321 3.362c0 7.828 5.076 14.173 11.338 14.173c5.97 0 10.862-5.767 11.306-13.087\"/&gt;&lt;path fill=\"none\" stroke=\"#000\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" d=\"M45.077 16.27c7.206 7.04 2.553 13.89 2.553 13.89l-5.66-12.624s-1.478 3.806-5.654 3.493c0 0 1.065-4.759-.283-4.759c0 0-5.184 6.217-11.073 8.725\"/&gt;&lt;path fill=\"none\" stroke=\"#000\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" d=\"M24.31 30.16s-4.652-6.85 2.553-13.89m.322 0V8.068l8.785 1.418l8.785-1.418v8.202m-17.57-3.505h17.57M19.513 16.27h32.568\"/&gt;&lt;/svg&gt;',\n  \"Value of production\":\n    '&lt;svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1.25em\" height=\"1em\" viewBox=\"0 0 640 512\"&gt;&lt;path fill=\"black\" d=\"M621.16 54.46C582.37 38.19 543.55 32 504.75 32c-123.17-.01-246.33 62.34-369.5 62.34c-30.89 0-61.76-3.92-92.65-13.72c-3.47-1.1-6.95-1.62-10.35-1.62C15.04 79 0 92.32 0 110.81v317.26c0 12.63 7.23 24.6 18.84 29.46C57.63 473.81 96.45 480 135.25 480c123.17 0 246.34-62.35 369.51-62.35c30.89 0 61.76 3.92 92.65 13.72c3.47 1.1 6.95 1.62 10.35 1.62c17.21 0 32.25-13.32 32.25-31.81V83.93c-.01-12.64-7.24-24.6-18.85-29.47M48 132.22c20.12 5.04 41.12 7.57 62.72 8.93C104.84 170.54 79 192.69 48 192.69zm0 285v-47.78c34.37 0 62.18 27.27 63.71 61.4c-22.53-1.81-43.59-6.31-63.71-13.62M320 352c-44.19 0-80-42.99-80-96c0-53.02 35.82-96 80-96s80 42.98 80 96c0 53.03-35.83 96-80 96m272 27.78c-17.52-4.39-35.71-6.85-54.32-8.44c5.87-26.08 27.5-45.88 54.32-49.28zm0-236.11c-30.89-3.91-54.86-29.7-55.81-61.55c19.54 2.17 38.09 6.23 55.81 12.66z\"/&gt;&lt;/svg&gt;',\n});\n\n\n\n\n\n\n\nmd`### Data`;\n\n\n\n\n\n\n\ndata_categories = FileAttachment(\n  \"adaptation-mitigation-categories-subsahara.csv\",\n).csv();\n\n\n\n\n\n\n\nhazards = await FileAttachment(\"country_emissions_hazards-2(1).csv\").csv();\n\n\n\n\n\n\n\nemissions = FileAttachment(\"emissions_per_animals_subsahara.csv\").csv();\n\n\n\n\n\n\n\nclimate = FileAttachment(\n  \"2_climate_hazards_per_adapatation_areas_subshara(1).csv\",\n).csv();\n\n\n\n\n\n\n\nmd`### Map`;\n\n\n\n\n\n\n\nd3_geoProj = require(\"d3-geo-projection\");\n\n\n\n\n\n\n\nfunction map_legend(colorBlind) {\n  const legendWidth = 270;\n  const legendHeight = 80;\n  const padding = 5;\n\n  const legendScale = d3\n    .scaleLinear()\n    .domain([0.2, 1])\n    .range([0, legendWidth - 60]);\n\n  const legendSvg = d3\n    .create(\"svg\")\n    .attr(\"width\", legendWidth)\n    .attr(\"height\", legendHeight)\n    .attr(\"font-size\", \"10\")\n    .attr(\"font-family\", \"system-ui, sans-serif\")\n    .attr(\"font-weight\", \"bold\");\n\n  const gradient = legendSvg\n    .append(\"defs\")\n    .append(\"linearGradient\")\n    .attr(\"id\", \"gradient\")\n    .attr(\"x1\", \"0%\")\n    .attr(\"y1\", \"0%\")\n    .attr(\"x2\", \"100%\")\n    .attr(\"y2\", \"0%\");\n\n  const text = {\n    title: _lang(nbText.sections.leversOfChange.chart.map.legend.title),\n    lo: _lang(nbText.sections.leversOfChange.chart.map.legend.lo),\n    md: _lang(nbText.sections.leversOfChange.chart.map.legend.md),\n    hi: _lang(nbText.sections.leversOfChange.chart.map.legend.hi),\n  };\n\n  gradient\n    .append(\"stop\")\n    .attr(\"offset\", \"0%\")\n    .attr(\"stop-color\", getColorBlindRGB(colorBlind, \"#F4BB21\"));\n\n  gradient\n    .append(\"stop\")\n    .attr(\"offset\", \"100%\")\n    .attr(\"stop-color\", getColorBlindRGB(colorBlind, \"#EC5A47\"));\n\n  legendSvg\n    .append(\"rect\")\n    .attr(\"width\", legendWidth - 60)\n    .attr(\"height\", 10)\n    .attr(\"transform\", \"translate(30,30)\")\n    .style(\"fill\", \"url(#gradient)\");\n\n  legendSvg\n    .append(\"line\")\n    .attr(\"x1\", 30)\n    .attr(\"y1\", 30)\n    .attr(\"x2\", 30)\n    .attr(\"y2\", 45)\n    .style(\"stroke\", \"#000\")\n    .style(\"stroke-width\", 1);\n\n  legendSvg\n    .append(\"text\")\n    .attr(\"x\", 20)\n    .attr(\"y\", legendHeight - 15)\n    .text(text.lo);\n\n  legendSvg\n    .append(\"line\")\n    .attr(\"x1\", legendWidth / 2)\n    .attr(\"y1\", 30)\n    .attr(\"x2\", legendWidth / 2)\n    .attr(\"y2\", 45)\n    .style(\"stroke\", \"#000\")\n    .style(\"stroke-width\", 1);\n\n  legendSvg\n    .append(\"text\")\n    .attr(\"x\", legendWidth / 2)\n    .attr(\"y\", legendHeight - 15)\n    .attr(\"text-anchor\", \"middle\")\n    .text(text.md);\n\n  legendSvg\n    .append(\"line\")\n    .attr(\"x1\", legendWidth - 30)\n    .attr(\"y1\", 30)\n    .attr(\"x2\", legendWidth - 30)\n    .attr(\"y2\", 45)\n    .style(\"stroke\", \"#000\")\n    .style(\"stroke-width\", 1);\n\n  legendSvg\n    .append(\"text\")\n    .attr(\"x\", legendWidth - 40)\n    .attr(\"y\", legendHeight - 15)\n    .text(text.hi);\n\n  legendSvg\n    .append(\"text\")\n    .attr(\"x\", legendWidth / 2)\n    .attr(\"y\", 25)\n    .attr(\"text-anchor\", \"middle\")\n    .text(text.title);\n\n  return legendSvg.node();\n}\n\n\n\n\n\n\n\nworld = FileAttachment(\"africa_50m-1.json\").json();\n\n\n\n\n\n\n\ninitial_data ={\n  if( map_configuration === \"adaptation_mitigation\"){\n    d3.select(\"#per_adap\").html(`50%`)\n    d3.select(\"#per_miti\").html(`50%`)\n   return [\n  {\n    percent: 50,\n    color: \"#C51617\",\n    name: \"Adaptation\"\n  },\n  {\n    percent: 50,\n    color: \"#5651FF\",\n    name: \"Mitigation\",\n    last: true\n  }\n]\n  } else if (map_configuration === \"adaptation\"){\n    d3.select(\"#per_adap\").html(`100%`)\n    d3.select(\"#per_miti\").html(`0%`)\n    return [\n  {\n    percent: 100,\n    color: \"#C51617\",\n    name: \"Adaptation\"\n  },\n  {\n    percent: 0,\n    color: \"#5651FF\",\n    name: \"Mitigation\",\n    last: true\n  }\n]\n  } else {\n    d3.select(\"#per_adap\").html(`0%`)\n    d3.select(\"#per_miti\").html(`100%`)\n    return [\n  {\n    percent: 0,\n    color: \"#C51617\",\n    name: \"Adaptation\"\n  },\n  {\n    percent: 100,\n    color: \"#5651FF\",\n    name: \"Mitigation\",\n    last: true\n  }\n]\n  }\n}\n\n\n\n\n\n\n\nfilterCountries1 = (mode, combined, composite, count, name) =&gt; {\n  if (mode)\n    return data_categories\n      .filter((d) =&gt; {\n        return composite.adaptation === \"\" || composite.mitigation === \"\"\n          ? true\n          : d.adaptation_cat === composite.adaptation &&\n              d.mitigation_cat === composite.mitigation;\n      })\n      .map((d) =&gt; {\n        return d.ISO3;\n      });\n  else {\n    return data_categories\n      .sort((a, b) =&gt; {\n        if (combined[0].percent === 0) {\n          return b.mitigation_index - a.mitigation_index;\n        } else if (combined[0].percent === 100) {\n          return b.adaptation_index - a.adaptation_index;\n        } else {\n          const prop = `${combined[0].percent}ada-${combined[1].percent}mit`;\n          return b[prop] - a[prop];\n        }\n      })\n      .map((d) =&gt; {\n        return name ? d.country : d.ISO3;\n      })\n      .slice(0, count || -1);\n  }\n};\n\n\n\n\n\n\n\ngetTrafficLight = (name) =&gt; {\n  const countryData = data_categories.find((d) =&gt; d.ISO3 === name);\n  return countryData ? parseInt(countryData.traffic_light) : 0;\n};\n\n\n\n\n\n\n\ncolors = [\n  //low mitigation / low adaptation, middle mitigation / low adaptation, high mitigation / low adaptation\n  \"#B22222\",\n  \"#FF0000\",\n  \"#FFE800\",\n  //low mitigation / middle adaptation, middle mitigation / middle adaptation, high mitigation / middle adaptation\n  \"#FF0000\",\n  \"#FFE800\",\n  \"#3CB371\",\n  //low mitigation / high adaptation, middle mitigation / high adaptation, high mitigation / high adaptation\n  \"#FFE800\",\n  \"#3CB371\",\n  \"#008000\",\n];\n\n\n\n\n\n\n\ncolor1 = {\n  return (value, select, mode) =&gt; {\n    //Makes features with null values black\n    if (!value || !mode ) return \"#EFEFEF\";\n    //Defines color's relationship to the variables\n    return getColorBlind(select, colors[value - 1]);\n  };\n}\n\n\n\n\n\n\n\ngetTooltipContents = (d, colorBlind) =&gt; {\n  function showAttributes(group, data) {\n    var atributos = \"\";\n    for (var atributo in group) {\n      let unidad;\n\n      switch (atributo) {\n        case \"Rural population\":\n          unidad = _lang(\n            nbText.sections.leversOfChange.chart.map.tooltip.data.hazards\n              .popRural.unit,\n          );\n          break;\n        case \"Value of production\":\n          unidad = _lang(\n            nbText.sections.leversOfChange.chart.map.tooltip.data.hazards.vop\n              .unit,\n          );\n          break;\n        case \"Tropical livestock units\":\n          unidad = _lang(\n            nbText.sections.leversOfChange.chart.map.tooltip.data.hazards.tlu\n              .unit,\n          );\n          break;\n        case \"Pasture area\":\n          unidad = _lang(\n            nbText.sections.leversOfChange.chart.map.tooltip.data.hazards\n              .pastureArea.unit,\n          );\n          break;\n        default:\n          unidad = _lang(\n            nbText.sections.leversOfChange.chart.map.tooltip.data.emissions\n              .unit,\n          );\n      }\n\n      const filterData = data.find(\n        (country) =&gt; country.ISO3 === d.properties.iso_a3,\n      );\n      const perc = filterData[atributo + \"_perc\"]\n        ? filterData[atributo + \"_perc\"]\n        : 0;\n      const value = filterData[atributo] ? filterData[atributo] : 0;\n      const deg = perc * 3.6 + \"deg\";\n      //atributo[0].toUpperCase() + atributo.slice(1)\n      atributos += `&lt;div class=\"icon-item\"&gt;\n          &lt;div style=\"position: relative;\"&gt;\n            &lt;div class=\"progress\" style=\"--p:${deg}\"&gt;&lt;/div&gt;\n            ${group[atributo]}\n          &lt;/div&gt;\n          &lt;span&gt;${td.leversChangeMap?.[atributo]}: &lt;br/&gt;${value}\n            &lt;span style=\"font-size: 9px;\"&gt;(${unidad})&lt;/span&gt;\n          &lt;/span&gt;\n        &lt;/div&gt;`;\n    }\n    return atributos;\n  }\n\n  const headers = {\n    hazards: _lang(\n      nbText.sections.leversOfChange.chart.map.tooltip.headers.hazards,\n    ),\n    emissions: _lang(\n      nbText.sections.leversOfChange.chart.map.tooltip.headers.emissions,\n    ),\n  };\n  console.log(\"attrData:\", d);\n  return html`&lt;div&gt;\n      &lt;h3 style=\"padding-top: 4px;\"&gt;${_lang(nbText.general.admin0_ISO3[d.properties.iso_a3])}&lt;/h3&gt;\n      &lt;div class=\"content-wrapper-adaptation\"&gt;\n        &lt;div class=\"icons-emissions\"&gt;\n          &lt;label&gt;${headers.hazards}:&lt;/label&gt;\n          ${showAttributes(icons1, hazards)}\n        &lt;/div&gt;\n        &lt;div class=\"icons-emissions\"&gt;\n          &lt;label&gt;${headers.emissions}:&lt;/label&gt;\n          ${showAttributes(icons, emissions)}\n        &lt;/div&gt;\n      &lt;/div&gt;\n    &lt;/div&gt;`;\n};\n\n\n\n\n\n\n\ncountriesFiltered = filterCountries1(false, initial_data, NaN, num_priorities);\n\n\n\n\n\n\n\nfunction create_map(colorBlind) {\n  const width = 1000;\n  const height = 700;\n  const padding = 10;\n\n  // Projection & path\n  const projection = d3.geoMercator();\n  const path = d3.geoPath().projection(projection);\n\n  projection.fitExtent(\n    [\n      [padding, padding],\n      [width - padding, height - padding],\n    ],\n    world,\n  );\n\n  // Root container\n  const root = d3.create(\"div\").style(\"position\", \"relative\");\n\n  const figure = root.append(\"figure\").attr(\"id\", \"svg_contain\");\n\n  // Legend\n  figure\n    .append(() =&gt; map_legend(colorBlind))\n    .attr(\"transform\", \"translate(10,0)\");\n\n  // SVG map\n  const svg = figure\n    .append(\"svg\")\n    .attr(\"viewBox\", [0, 0, width, height])\n    .attr(\"id\", \"svg_map\");\n\n  // Tooltip\n  const tooltip = root\n    .append(\"div\")\n    .attr(\"class\", \"cooltip\")\n    .style(\"position\", \"absolute\")\n    .style(\"pointer-events\", \"none\")\n    .style(\"display\", \"none\");\n\n  // Countries\n  svg\n    .append(\"g\")\n    .attr(\"stroke\", \"white\")\n    .attr(\"stroke-linejoin\", \"round\")\n    .selectAll(\"path\")\n    .data(world.features)\n    .join(\"path\")\n    .attr(\"d\", path)\n    .attr(\"fill\", (d) =&gt; {\n      const index = countriesFiltered.indexOf(d.properties.iso_a3);\n      if (index === -1) {\n        return getColorBlindRGB(colorBlind, \"#EFEFEF\");\n      }\n\n      const fillScale = d3\n        .scaleLinear()\n        .domain([0, countriesFiltered.length])\n        .range([\"#EC5A47\", \"#F4BB21\"]);\n\n      return getColorBlindRGB(colorBlind, fillScale(index));\n    })\n\n    // ─────────────────────────────\n    // Mouse events (D3 v6+)\n    // ─────────────────────────────\n    .on(\"mouseover\", function (event, d) {\n      if (!countriesFiltered.includes(d.properties.iso_a3)) return;\n\n      tooltip.style(\"display\", \"block\").html(\"\");\n      tooltip.node().appendChild(getTooltipContents(d, colorBlind));\n\n      d3.select(this).attr(\"stroke\", \"black\").raise();\n    })\n\n    .on(\"mousemove\", function (event, d) {\n      if (!countriesFiltered.includes(d.properties.iso_a3)) return;\n\n      const [x, y] = d3.pointer(event, root.node());\n\n      const tooltipWidth = tooltip.node().offsetWidth;\n      const screenWidth = window.innerWidth;\n      const isSmallScreen = screenWidth &lt;= 600;\n\n      const left = isSmallScreen\n        ? 20\n        : x + tooltipWidth &gt; screenWidth\n          ? x - tooltipWidth - 20\n          : x + 20;\n\n      tooltip.style(\"left\", `${left}px`).style(\"top\", `${y + 20}px`);\n    })\n\n    .on(\"mouseout\", function () {\n      tooltip.style(\"display\", \"none\");\n\n      d3.select(this).attr(\"stroke\", null).lower();\n    });\n\n  console.log(\"root node:\", root.node());\n\n  return root.node();\n}\n\n\n\n\n\n\n\nmd`### Dynamic Insight and Table`;\n\n\n\n\n\n\n\ndata_climate_hazards = FileAttachment(\n  \"2_climate_hazards_per_adapatation_areas_subshara(2).csv\",\n).csv();\n\n\n\n\n\n\n\ndata_ghg = FileAttachment(\"country_emissions_hazards-4.csv\").csv();\n\n\n\n\n\n\n\ndata_lps_top = FileAttachment(\"3_quickinsights_sort_lps_country.csv\").csv();\n\n\n\n\n\n\n\ndata_lps_hazards = FileAttachment(\"3_country_lps_hazards.csv\").csv();\n\n\n\n\n\n\n\ndata_lps_emissions = FileAttachment(\"3_country_lps_emissions-1(1).csv\").csv();\n\n\n\n\n\n\n\ndata_lps = FileAttachment(\"LPS-2.csv\").csv();\n\n\n\n\n\n\n\ninsight_object = {\n  const totalEmissions = 566.1;\n  const totalVop = 22785.2;\n  const dataIni = data_ghg.map(obj =&gt; ({ ...obj }));\n  let dataTable = dataIni\n  const countryFilter = countriesFiltered\n  const selectedValue = country_select !== \"\"? dataIni.filter((d) =&gt; d.ISO3 === country_select)[0].country : undefined\n  \n  let totalData = {\n      country: 'Total',\n      \"direct_emissions (Mt C02e)\": 0,\n      \"indirect_emission(Mt C02e)\": 0,\n      \"total_emissions(Mt C02e)\": 0,\n      \"rural_pop (Millions)\": 0,\n      \"VOP(Millons usd)\": 0,\n      \"TLU(Millons)\": 0,\n      \"Pasture_area(Millions Ha)\": 0\n  };\n  \n  if(countryFilter.length &gt; 0){\n    dataTable = []\n    countryFilter.forEach(name =&gt; {\n      const filteredData = dataIni.filter(ghg =&gt; ghg.ISO3 === name);\n      dataTable = dataTable.concat(filteredData);\n    });\n  }\n  \n  dataTable.forEach(entry =&gt; {\n    delete entry.ISO2;\n    // delete entry.ISO3;\n\n    for (const key in entry) {\n        if (key !== 'country' && entry[key] && entry[key] !== \"-\") {\n            totalData[key] += parseFloat(entry[key]);\n        }\n    }\n   });\n\n  dataTable.push(totalData);\n  \n  const countrySelect = selectedValue ? dataTable.find(country =&gt; country.country === selectedValue) : dataTable[0]\n\n  const hazardTop = getTopHazards(dataTable[0])\n  const top_country = hazardTop.country\n  console.log(hazardTop)\n  const top_hazard = _lang(nbText.sections.leversOfChange.insights.hazard_defs[hazardTop.climate_hazards])\n  const top_haz_vop = parseFloat(hazardTop.value).toFixed(1) //USD Billion VoP`\n\n  const LPStop = getTopLPS(countrySelect)\n\n  const lps1 = LPStop[0].lps\n  const lps2 = LPStop[1].lps || \"\"\n  const lps3 = LPStop[2].lps || \"\"\n\n  const vop_text = (totalData[\"VOP(Millons usd)\"] / 1000 ).toFixed(1) // billion USD\n  const people = totalData[\"rural_pop (Millions)\"].toFixed(0) // million\n  const emissions = totalData[\"total_emissions(Mt C02e)\"].toFixed(0) //MT CO2e\n  const country_selected = countrySelect.country\n  const iso_selected = countrySelect.ISO3\n  const per_vop = ((countrySelect[\"VOP(Millons usd)\"]/totalVop)*100).toFixed(0) //%\n  const per_emi = ((countrySelect[\"total_emissions(Mt C02e)\"]/totalEmissions)*100).toFixed(0) // %\n\n  return {\n    top_country: top_country,\ntop_hazard: top_hazard,\ntop_haz_vop: top_haz_vop,\nlps1: lps1,\nlps2: lps2,\nlps3: lps3,\nvop_text: vop_text,\npeople: people,\nemissions: emissions,\ncountry_selected: country_selected,\niso_selected: iso_selected,\nper_vop: per_vop,\nper_emi: per_emi\n  }\n}\n\n\n\n\n\n\n\ndataTable_dev = {\n    const totalEmissions = 566.1;\n  const totalVop = 22785.2;\n  const dataIni = data_ghg.map(obj =&gt; ({ ...obj }));\n  let dataTable = dataIni\n  const countryFilter = countriesFiltered\n  const selectedValue = country_select !== \"\"? dataIni.filter((d) =&gt; d.ISO3 === country_select)[0].country : undefined\n  \n  let totalData = {\n      country: 'Total',\n      ISO3: \"TOTAL\",\n      \"direct_emissions (Mt C02e)\": 0,\n      \"indirect_emission(Mt C02e)\": 0,\n      \"total_emissions(Mt C02e)\": 0,\n      \"rural_pop (Millions)\": 0,\n      \"VOP(Millons usd)\": 0,\n      \"TLU(Millons)\": 0,\n      \"Pasture_area(Millions Ha)\": 0\n  };\n  \n  if(countryFilter.length &gt; 0){\n    dataTable = []\n    countryFilter.forEach(name =&gt; {\n      const filteredData = dataIni.filter(ghg =&gt; ghg.ISO3 === name);\n      dataTable = dataTable.concat(filteredData);\n    });\n  }\n  \n  dataTable.forEach(entry =&gt; {\n    delete entry.ISO2;\n    // delete entry.country;\n\n    for (const key in entry) {\n        if (key !== 'country' && key !== 'ISO3' && entry[key] && entry[key] !== \"-\") {\n            totalData[key] += parseFloat(entry[key]);\n        }\n    }\n   });\n\n  dataTable.push(totalData);\n  return dataTable\n}\n\n\n\n\n\n\n\nrender_country_table = () =&gt; {\n  const selectedValue =\n    country_select !== \"\"\n      ? data_ghg.filter((d) =&gt; d.ISO3 === country_select)[0].country\n      : undefined;\n  let table;\n  if (!selectedValue) {\n    table = doble_tittle_table(dataTable_dev);\n  } else {\n    const countrySelect = selectedValue\n      ? dataTable_dev.find((country) =&gt; country.country === selectedValue)\n      : dataTable_dev[0];\n\n    const lps_hazards = data_lps_hazards.filter(\n      (d) =&gt; d.country === countrySelect.country,\n    );\n    const lps_emissions = data_lps_emissions.filter(\n      (d) =&gt; d.country === countrySelect.country,\n    );\n    table = doble_tittle_table1(lps_emissions, lps_hazards);\n  }\n  table.classList.add(\".table\");\n\n  //   const style = document.createElement(\"style\");\n  // style.innerHTML = `\n  //     thead {\n  //       color: green !important;\n  //     }\n  //   `;\n\n  //   table.appendChild(style);\n\n  return table;\n};\n\n\n\n\n\n\n\ngetTopHazards = (country) =&gt; {\n  const dataFilter = data_climate_hazards.filter(\n    (lps) =&gt; lps.country == country.country && lps.variable == \"Value\",\n  );\n\n  let maxIndex = 0;\n  let maxValueProp = parseFloat(dataFilter[0].value_prop);\n  for (let i = 1; i &lt; dataFilter.length; i++) {\n    const currentValueProp = parseFloat(dataFilter[i].value_prop);\n    if (currentValueProp &gt; maxValueProp) {\n      maxIndex = i;\n      maxValueProp = currentValueProp;\n    }\n  }\n  const hazardTop = dataFilter[maxIndex];\n\n  return hazardTop;\n};\n\n\n\n\n\n\n\ngetTopLPS = (country) =&gt; {\n  const dataFilter = data_lps_top.filter(\n    (lps) =&gt; lps.country == country.country,\n  );\n\n  return dataFilter;\n};\n\n\n\n\n\n\n\nhazards_descrip = new Object({\n  Thi: \"Livestock heat stress\",\n  RF: \"Extreme or high rainfall variability\",\n  D: \"Drought\",\n  F: \"Flooding\",\n  CV: \"Rainfall variability\",\n  ExCV: \"Extremely high rainfall variability\",\n  HCV: \"High rainfall variability\",\n  \"CV+D\": \"Rainfall variability and drought\",\n  \"CV+D+F\": \"Rainfall variability, drought and flooding\",\n  \"CV+F\": \"Rainfall variability and flooding\",\n  \"CV+Thi\": \"Rainfall variability and livestock heat stress\",\n  \"CV+Thi+D\": \"Rainfall variability, livestock heat stress and drought\",\n  \"CV+Thi+D+F\":\n    \"Rainfall variability, livestock heat stress, drought and flooding\",\n  \"CV+Thi+F\": \"Rainfall variability, livestock heat stress and flooding\",\n  \"D+F\": \"Drought and flooding\",\n  \"Thi+D\": \"Livestock heat stress and drought\",\n  \"Thi+D+F\": \"Livestock heat stress, drought and flooding\",\n  \"Thi+F\": \"Livestock heat stress and flooding\",\n});\n\n\n\n\n\n\n\nlps_descrip = new Object({\n  MIA: \"Mixed irrigated arid\",\n  MIH: \"Mixed irrigated humid\",\n  MIT: \"Mixed irrigated temperate\",\n  MIY: \"Mixed irrigated hyperarid\",\n  MRA: \"Mixed rainfed arid\",\n  MRH: \"Mixed rainfed humid\",\n  MRT: \"Mixed rainfed temperate\",\n  MRY: \"Mixed rainfed hyperarid\",\n  LGA: \"Rangelands arid\",\n  LGH: \"Rangelands humid\",\n  LGT: \"Rangelands temperate\",\n  LGY: \"Rangelands hyperarid\",\n});\n\n\n\n\n\n\n\nmapping_lps = new Object({\n  \"Mixed irrigated\": [\"MIA\", \"MIH\", \"MIT\", \"MIY\"],\n  \"Mixed rainfed\": [\"MRA\", \"MRH\", \"MRT\", \"MRY\"],\n  Rangelands: [\"LGA\", \"LGH\", \"LGT\", \"LGY\", \"Other\"],\n});\n\n\n\n\n\n\n\ntable_titles = [\n  _lang(\n    nbText.sections.leversOfChange.livestockProductionSystems.table.headers\n      .emissionsDirect,\n  ),\n  _lang(\n    nbText.sections.leversOfChange.livestockProductionSystems.table.headers\n      .emissionsIndirect,\n  ),\n  _lang(\n    nbText.sections.leversOfChange.livestockProductionSystems.table.headers\n      .emissionsTotal,\n  ),\n  _lang(\n    nbText.sections.leversOfChange.livestockProductionSystems.table.headers\n      .popRural,\n  ),\n  _lang(\n    nbText.sections.leversOfChange.livestockProductionSystems.table.headers.vop,\n  ),\n  _lang(\n    nbText.sections.leversOfChange.livestockProductionSystems.table.headers.tlu,\n  ),\n  _lang(\n    nbText.sections.leversOfChange.livestockProductionSystems.table.headers\n      .pastureArea,\n  ),\n];\n\n\n\n\n\n\n\ncreateHtmlTable = (title) =&gt; {\n  const tableContainer = d3\n    .create(\"div\")\n    .attr(\"id\", \"table_container\")\n    .style(\"overflow\", \"auto\")\n    .style(\"max-height\", \"900px\")\n    .style(\"margin-top\", \"10px\");\n\n  const headerGhg = _lang(\n    nbText.sections.leversOfChange.livestockProductionSystems.table.headers\n      .ghgEmissions,\n  );\n  const headerExposure = _lang(\n    nbText.sections.leversOfChange.livestockProductionSystems.table.headers\n      .climateExposure,\n  );\n\n  tableContainer.html(`&lt;table id=\"main_table\"&gt;\n    &lt;thead style=\"position: sticky;top: 0;z-index: 1;\"&gt;\n      &lt;tr id=\"first_head\"&gt;\n        &lt;th rowspan=\"2\" style=\"width: 150px;\"&gt;&lt;h3&gt;${title}&lt;/h3&gt;&lt;/th&gt;\n        &lt;th colspan=\"3\"&gt;&lt;h3&gt;${headerGhg}&lt;/h3&gt;&lt;/th&gt;\n        &lt;th colspan=\"4\"&gt;&lt;h3&gt;${headerExposure}&lt;/h3&gt;&lt;/th&gt;\n      &lt;/tr&gt;\n      &lt;tr id=\"second_head\"&gt;\n      &lt;/tr&gt;\n    &lt;/thead&gt;\n    &lt;tbody class=\"body\"&gt;\n    &lt;/tbody&gt;\n  &lt;/table&gt;`);\n\n  const tabla = tableContainer.select(\"#main_table\");\n\n  tabla\n    .select(\"#second_head\")\n    .selectAll(\"th\")\n    .data(table_titles)\n    .enter()\n    .append(\"th\")\n    .append(\"h4\")\n    .text((d) =&gt; d);\n\n  return tableContainer.node();\n};\n\n\n\n\n\n\n\ndoble_tittle_table = (data) =&gt; {\n  const tableName = _lang(\n    nbText.sections.leversOfChange.livestockProductionSystems.table.headers\n      .country,\n  );\n\n  createHtmlTable(tableName);\n\n  const tableNode = createHtmlTable(tableName);\n\n  // const tabla = d3.select(\"#main_table\");\n  const tabla = d3.select(tableNode);\n\n  // const tabla = d3.select(\"#main_table\");\n\n  if (data.length &gt; 0) {\n    const tooltip = d3\n      .select(\"body\")\n      .append(\"div\")\n      .style(\"opacity\", 0)\n      .style(\"position\", \"absolute\")\n      .style(\"background-color\", \"white\")\n      .style(\"padding\", \"10px 15px\")\n      .style(\"box-shadow\", \"rgba(149, 157, 165, 0.2) 0px 8px 24px\")\n      .style(\"border-radius\", \"12px\")\n      .style(\"z-index\", 100)\n      .style(\"font-size\", \"16px\");\n\n    tabla\n      .select(\".body\")\n      .selectAll(\"tr\")\n      .data(data)\n      .enter()\n      .append(\"tr\")\n      .on(\"mouseover\", function (event, d) {\n        const country = d.country;\n        if (country !== \"Total\") {\n          const filteredData = data_lps.filter(\n            (obj) =&gt; obj.country === country,\n          );\n\n          tooltip\n            .style(\"opacity\", 1)\n            .style(\"display\", \"block\")\n\n            .style(\"position\", \"fixed\")\n            .style(\"left\", `${event.pageX + 10}px`)\n            .style(\"top\", `${event.pageY}px`)\n            .style(\"box-shadow\", \"rgba(149, 157, 165, 0.2) 0px 8px 24px\");\n\n          if (filteredData.length &gt; 0) {\n            const lps_data = filteredData[0].LSP.split(\",\")\n              .map((v) =&gt; _lang(nbText.general.lps[v]))\n              .join(\", \");\n            const constraints =\n              `&lt;strong&gt;${_lang(nbText.general.admin0_ISO3[d.ISO3])}&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;${_lang(nbText.sections.leversOfChange.livestockProductionSystems.table.headers.livestockSystem)}&lt;/strong&gt;&lt;br&gt;` +\n              `${lps_data}&lt;br&gt;`;\n\n            tooltip.html(constraints);\n          }\n        }\n      })\n      .on(\"mouseout\", function () {\n        tooltip\n          .style(\"opacity\", 0)\n          .style(\"display\", \"none\")\n          .style(\"box-shadow\", \"0\")\n          .html(\"\");\n      })\n      .on(\"mousemove\", function (event, d) {\n        tooltip\n          .style(\"left\", `${event.pageX + 10}px`) // Adjust tooltip position\n          .style(\"top\", `${event.pageY}px`);\n      })\n      .selectAll(\"td\")\n      .data((d) =&gt; Object.values(d).slice(1, 9))\n      .enter()\n      .append(\"td\")\n      .text((d) =&gt;\n        !isNaN(parseFloat(d))\n          ? parseFloat(d).toFixed(1)\n          : _lang(nbText.general.admin0_ISO3[d]) || \"-\",\n      );\n  }\n\n  return tableNode;\n};\n\n\n\n\n\n\n\ndoble_tittle_table1 = (lps_emissions, lps_hazards) =&gt; {\n  const tableName = _lang(\n    nbText.sections.leversOfChange.livestockProductionSystems.table.headers\n      .livestockSystem,\n  );\n  const tableNode = createHtmlTable(tableName);\n\n  // const tabla = d3.select(\"#main_table\");\n  const tabla = d3.select(tableNode);\n  // const tabla = d3.select(\"#main_table\");\n\n  const body = tabla.select(\".body\");\n  const tooltip = d3\n    .select(\"body\")\n    .append(\"div\")\n    .style(\"opacity\", 0)\n    .style(\"position\", \"absolute\")\n    .style(\"background-color\", \"white\")\n    .style(\"padding\", \"10px 15px\")\n    .style(\"box-shadow\", \"rgba(149, 157, 165, 0.2) 0px 8px 24px\")\n    .style(\"border-radius\", \"12px\")\n    .style(\"z-index\", 100)\n    .style(\"font-size\", \"16px\");\n\n  function format(str) {\n    if (str !== \"0\" && str.trim() !== \"\") {\n      let numero = parseFloat(str);\n      if (!isNaN(numero)) {\n        if (numero &lt; 0.05) {\n          return \"&lt; 0.05\";\n        } else {\n          return numero.toFixed(2);\n        }\n      } else {\n        return \"NaN\";\n      }\n    } else {\n      return \"0\";\n    }\n  }\n\n  let tableBody = \"\";\n\n  for (const key in mapping_lps) {\n    tableBody += `&lt;tr&gt;&lt;td colspan=\"8\"&gt;&lt;strong&gt;${_lang(nbText.general.lps[key])}&lt;/strong&gt;&lt;/td&gt;&lt;/tr&gt;`;\n\n    mapping_lps[key].forEach((code) =&gt; {\n      const emissions = lps_emissions.find((item) =&gt; item.lps === code) || {};\n      const hazards = lps_hazards.find((item) =&gt; item.lps === code) || {};\n\n      tableBody += `&lt;tr id=${code}&gt;&lt;td&gt;${_lang(nbText.general.lps[code])}&lt;/td&gt;`;\n      tableBody += `&lt;td&gt;${\n        emissions.direct_emissions ? format(emissions.direct_emissions) : \"-\"\n      }&lt;/td&gt;`;\n      tableBody += `&lt;td&gt;${\n        emissions.indirect_emissions\n          ? format(emissions.indirect_emissions)\n          : \"-\"\n      }&lt;/td&gt;`;\n      tableBody += `&lt;td&gt;${\n        emissions.total_emissions ? format(emissions.total_emissions) : \"-\"\n      }&lt;/td&gt;`;\n      tableBody += `&lt;td&gt;${\n        hazards[\"rural_pop (millons)\"]\n          ? format(hazards[\"rural_pop (millons)\"])\n          : \"-\"\n      }&lt;/td&gt;`;\n      tableBody += `&lt;td&gt;${\n        hazards[\"VOP (millos usd)\"] ? format(hazards[\"VOP (millos usd)\"]) : \"-\"\n      }&lt;/td&gt;`;\n      tableBody += `&lt;td&gt;${\n        hazards[\"TLU (millons))\"] ? format(hazards[\"TLU (millons))\"]) : \"-\"\n      }&lt;/td&gt;`;\n      tableBody += `&lt;td&gt;${\n        hazards[\"pasture_area (millons)\"]\n          ? format(hazards[\"pasture_area (millons)\"])\n          : \"-\"\n      }&lt;/td&gt;&lt;/tr&gt;`;\n    });\n  }\n\n  body.html(tableBody);\n\n  body\n    .selectAll(\"tr\")\n    .on(\"mouseover\", function (event) {\n      const id = d3.select(this).attr(\"id\");\n      if (id && id !== \"Other\") {\n        tooltip\n          .style(\"opacity\", 1)\n          .style(\"display\", \"block\")\n          .style(\"left\", `${event.pageX + 10}px`)\n          .style(\"top\", `${event.pageY}px`);\n        tooltip.html(`&lt;strong&gt;${_lang(nbText.general.lps[id])}&lt;/strong&gt;`);\n      }\n    })\n    .on(\"mouseout\", function () {\n      tooltip.style(\"opacity\", 0).style(\"display\", \"none\");\n    })\n    .on(\"mousemove\", function (event) {\n      tooltip\n        .style(\"left\", `${event.pageX + 10}px`) // Adjust tooltip position\n        .style(\"top\", `${event.pageY}px`);\n    });\n\n  return tableNode;\n};\n\n\n\n\n\n\n\nmd`## Solution Table`;\n\n\n\n\n\n\n\ndataOption = {\n  if (language.key === \"en\"){  \n    return FileAttachment(\"4_livestock_prod_system_priority_countries-5.csv\").csv()\n} else if (language.key === \"fr\"){  \n    return FileAttachment(\"french_livestock_prod_system_priority_countries.csv\").csv()}\n}\n\n\n\n\n\n\n\nfilterSolutions = {\n   let  select_species_notebook = solution_Selectors[1]\n   let  select_system_notebook = solution_Selectors[0]\n  let filteredData = dataOption;\n\n  // Verificar si al menos una opción está seleccionada en select_species_notebook\n  const speciesSelected = select_species_notebook && select_species_notebook.length &gt; 0;\n\n    console.log(speciesSelected)\n  // Verificar si al menos una opción está seleccionada en select_system_notebook\n  const systemsSelected = select_system_notebook && select_system_notebook.length &gt; 0;\n\n    console.log(systemsSelected)\n  // Filtrar los datos solo si al menos una opción está seleccionada en uno de los select\n  if (speciesSelected && systemsSelected) {\n    if (systemsSelected) {\n      filteredData = filteredData.filter(d =&gt; {\n        return select_system_notebook.every(s =&gt; d[_lang(solution_table_columns_translations.system)].includes(s));\n      });\n    }\n\n    if (speciesSelected) {\n      filteredData = filteredData.filter(d =&gt; {\n        return select_species_notebook.every(s =&gt; d[_lang(solution_table_columns_translations.species)].includes(s));\n      });\n    }\n  } else {\n    // Si no hay opciones seleccionadas, mantener los datos sin filtrar\n    filteredData ={};\n  }\n    return filteredData\n}\n\n\n\n\n\n\n\ngetLivestockSystem = () =&gt; {\n  let livestockSystemArray = [];\n  dataOption.forEach((d) =&gt; {\n    const systems = d[_lang(solution_table_columns_translations.system)]\n      .split(\",\")\n      .map((s) =&gt; s.trim()); // Divide por comas y quita espacios en blanco\n    livestockSystemArray.push(...systems); // Agrega todos los sistemas al arreglo\n  });\n  livestockSystemArray = Array.from(new Set(livestockSystemArray)); // Elimina duplicados\n  livestockSystemArray = livestockSystemArray.filter((item) =&gt; item !== \"\");\n\n  return livestockSystemArray;\n};\n\n\n\n\n\n\n\ngetSpecies = () =&gt; {\n  let speciesArray = [];\n  dataOption.forEach((d) =&gt; {\n    const species = d[_lang(solution_table_columns_translations.species)]\n      .split(\",\")\n      .map((s) =&gt; s.trim()); // Divide por comas y quita espacios en blanco\n    speciesArray.push(...species); // Agrega todos los sistemas al arreglo\n  });\n  speciesArray = Array.from(new Set(speciesArray)); // Elimina duplicados\n  speciesArray = speciesArray.filter((item) =&gt; item !== \"\");\n\n  return speciesArray;\n};\n\n\n\n\n\n\n\ncreateSolutionTable = (filteredData) =&gt; {\n  // Seleccionar el contenedor de tabla\n  const tableContainer = d3\n    .create(\"div\")\n    .attr(\"id\", \"table_container\")\n    // .style(\"overflow\", \"auto\")\n    // .style(\"max-height\", \"727px\")\n    .style(\"margin-top\", \"10px\"); //.select(\"#table_container_options\");\n\n  // Si el contenedor no existe, crear uno nuevo\n  if (tableContainer.empty()) {\n    tableContainer = d3\n      .select(\"#table_options\")\n      .append(\"div\")\n      .attr(\"id\", \"table_container_options\");\n  } else {\n    // Vaciar el contenido anterior del contenedor\n    tableContainer.html(\"\");\n  }\n\n  // Crear la tabla dentro del contenedor\n  const table = tableContainer.append(\"table\");\n\n  // Encabezados de la tabla\n  const headers = [\n    _lang(nbText.sections.scalableSolutions.table.headers.option),\n    _lang(nbText.sections.scalableSolutions.table.headers.priority),\n    _lang(nbText.sections.scalableSolutions.table.headers.description),\n  ];\n  table\n    .append(\"thead\")\n    .append(\"tr\")\n    .selectAll(\"th\")\n    .data(headers)\n    .enter()\n    .append(\"th\")\n    .text((d) =&gt; d);\n  // Verificar si filteredData está vacío\n  if (Object.keys(filteredData).length === 0) {\n    const noDataMessage = table\n      .append(\"tbody\")\n      .append(\"tr\")\n      .append(\"td\")\n      .attr(\"colspan\", 3) // Colspan para ocupar todas las columnas\n      .text(\n        \"We could not find information for the values you selected. Please try with other parameters\",\n      );\n    return; // Terminar la función si no hay datos\n  }\n  // Filas de la tabla\n  const rows = table\n    .append(\"tbody\")\n    .selectAll(\"tr\")\n    .data(filteredData)\n    .enter()\n    .append(\"tr\");\n\n  // Celdas de la tabla\n  rows\n    .selectAll(\"td\")\n    .data((d) =&gt; [\n      d.Option,\n      d[_lang(solution_table_columns_translations.priority)],\n      d[_lang(solution_table_columns_translations.description)],\n    ])\n    .enter()\n    .append(\"td\")\n    .html(function (d) {\n      // Verificar si la descripción contiene un hipervínculo\n      if (/&lt;a\\s+(?:[^&gt;]*?\\s+)?href=([\"'])(.*?)\\1/i.test(d)) {\n        return d; // Si contiene un hipervínculo, mantenerlo como está\n      } else {\n        // Si no contiene un hipervínculo, agregar etiqueta &lt;a&gt; si es necesario\n        return d.replace(\n          /\\b(https?:\\/\\/\\S+)/gi,\n          '&lt;a href=\"$1\" target=\"_blank\"&gt;$1&lt;/a&gt;',\n        );\n      }\n    });\n  return tableContainer.node();\n};\n\n\n\n\n\n\n\nsolutionData = FileAttachment(\n  \"adaptation-mitigation-options-with-constraints-4.csv\",\n).csv();\n\n\n\n\n\n\n\nsolution_table_columns_translations = new Object({\n  species: { en: \"Species for which suitable\", fr: \"Espèces appropriées\" },\n  system: { en: \"Systems where suitable\", fr: \"Systèmes appropriés\" },\n  priority: { en: \"Priority addressed\", fr: \"Priorité abordée\" },\n  description: {\n    en: \"Description and implementation constraints\",\n    fr: \"Description et contraintes de mise en œuvre\",\n  },\n});\n\n\n\n\n\n\n\nmd`## Summary`;\n\n\n\n\n\n\n\nsummary_object = {\n  const countryOptions = countriesFiltered\n        const countryArray = [];\n        \n        countryOptions.forEach(option =&gt; {\n            if (option !== \"\") { // Asegurarse de no incluir la opción vacía\n                countryArray.push(option);\n            }\n        });\n      \n        const dataFiltered = dataSummary.filter(d =&gt; countryArray.includes(d.ISO3));\n\n        const sumPopulationMillion = dataFiltered.reduce((acc, obj) =&gt; acc + parseFloat(obj['rural_pop (Millions)']), 0);\n        const sumPopulationBillion = sumPopulationMillion/1000;\n      const sumVOPMillion = dataFiltered.reduce((acc, obj) =&gt; acc + parseFloat(obj['VOP(Millons usd)']), 0);\n        const sumVOPBillion = sumVOPMillion/1000;\n      const sumGHG = dataFiltered.reduce((acc, obj) =&gt; acc + parseFloat(obj['total_emissions(Mt C02e)']), 0);\n      \n        const firstCountry = countryArray.shift();\n  return {\n    firstCountry: firstCountry,\n    sumPopulationMillion: sumPopulationMillion,\n    sumPopulationBillion: sumPopulationBillion,\n    sumVOPMillion: sumVOPMillion,\n    sumVOPBillion: sumVOPBillion,\n    sumGHG: sumGHG,\n    countryArray: countryArray\n  }\n}\n\n\n\n\n\n\n\nmd`## Styling and imports`;\n\n\n\n\n\n\n\nstyling = { \n  return htl.html`&lt;style&gt;\n  /*------------Estilo multi dropdown*/\n  span.dropdown-form button {\n          padding: 0;\n          border: 0 !important;\n          border-radius: 0 !important;\n      }\n      \n      form.oi-3a86ea.dropdown-action-buttons button:hover {\n          background: #EFEFEF !important;\n      }\n\n      form.oi-3a86ea dropdown-button {\n          max-width: none !important;\n      }\n      \n      span.dropdown-form .button-inner {\n          padding: 8px 0;\n      }\n\n      span.dropdown-form form {\n          // width: calc(var(--input-width) + var(--label-width) - 10px) !important;\n          width: 24vw !important;\n      }\n      \n      .dropdown-action-buttons button {\n          width: 49%  !important;\n      }\n      \n      span.dropdown-form label {\n          padding: 8px 0;\n          display: flex;\n          border-bottom: 1px solid black;\n          font-size: 12px !important;\n          font-weight: 400 !important;\n          text-transform: uppercase;\n          width: 100%;\n      }\n      \n      .dropdown-inner {\n          border: 1px #333 solid !important;\n          border-radius: 0 !important;\n          margin-top: 12px !important;\n      }\n  \n  /*------------------------ Estilos propios -----------------------------------*/\n\n  /*-------------- Estilo todo el notebook*/\n  p {\n   /* min-width: 100%;*/\n    text-wrap: pretty;\n  }\n\n  /* ------------- Estilos Radio buttom */\n\n  .hidden-radio{\n    accent-color: #216729;\n  }\n\n/* Create a custom radio button */\n\n  \n  /*-------------- Estilos select */\n  #type_container {\n    --label-width: 120px;\n    --input-width: 240px;\n    flex-wrap: wrap;\n    display: flex;\n    align-items: center;\n    min-height: 25.5px;\n    width: calc(var(--input-width) + var(--label-width));\n    max-width: 100%;\n  }\n  \n  #type_container&gt;label {\n    padding: 8px 0;\n    font-family: \"IBM Plex Sans\";\n    font-size: 12px;\n    text-transform: uppercase;\n    border-bottom: 1px solid #333;\n    width: 100%;\n  }\n  \n  #type_container&gt;select {\n    border: 0;\n    height: 40px;\n    font-family: \"IBM Plex Sans\";\n    font-size: 14px;\n    display: flex;\n    align-items: center;\n    width: 100%;\n  }\n  \n  #country_container {\n    --label-width: 120px;\n    --input-width: 240px;\n    flex-wrap: wrap;\n    display: flex !important;\n    align-items: center;\n    min-height: 25.5px;\n    width: calc(var(--input-width) + var(--label-width));\n    max-width: 100%;\n  }\n  \n  #country_container&gt;label {\n    padding: 8px 0;\n    font-family: \"IBM Plex Sans\";\n    font-size: 12px;\n    text-transform: uppercase;\n    border-bottom: 1px solid #333;\n    width: 100%;\n  }\n  \n  #country_container&gt;select {\n    border: 0;\n    height: 40px;\n    font-family: \"IBM Plex Sans\";\n    font-size: 14px;\n    display: flex;\n    align-items: center;\n    width: 100%;\n  }\n\n  /*------------------------ Estilos botones */\n  .button_container{\n    margin-bottom: 1%;\n  }\n\n  .button_container_ghg{\n    display: flex;\n    gap: 20px;\n  }\n  \n  .download_data_am {\n    display: inline-flex;\n    flex-wrap: wrap;\n    gap: 12px;\n    margin: 10px 0;\n  }\n  \n  /*.button_download_data {\n    background-color: ${getColorBlindRGB(colorblindData.key, \"#216729\")};\n  }\n\n  .button_download_data:hover {\n    background-color: ${getColorBlindRGB(colorblindData.key, \"#194d1f\")};\n  }\n\n  .button_download_lps_hazards {\n    background-color: ${getColorBlindRGB(colorblindData.key, \"#216729\")};\n  }\n\n  .button_download_lps_hazards:hover {\n    background-color: ${getColorBlindRGB(colorblindData.key, \"#194d1f\")};\n  }\n\n  .button_download_lps_emissions {\n    background-color: ${getColorBlindRGB(colorblindData.key, \"#216729\")};\n  }\n\n  .button_download_lps_emissions:hover {\n    background-color: ${getColorBlindRGB(colorblindData.key, \"#194d1f\")};\n  }\n\n  .button_download_ghg {\n    background-color: ${getColorBlindRGB(colorblindData.key, \"#216729\")};\n  }\n\n  .button_download_ghg:hover {\n    background-color: ${getColorBlindRGB(colorblindData.key, \"#194d1f\")};\n  }\n\n  .clasetatata {\n    background-color: ${getColorBlindRGB(colorblindData.key, \"#216729\")};\n  }\n\n  .clasetatata:hover {\n    background-color: ${getColorBlindRGB(colorblindData.key, \"#194d1f\")};\n  }\n\n  .button_download_area {\n    background-color: ${getColorBlindRGB(colorblindData.key, \"#216729\")};\n  }\n\n  .button_download_area:hover {\n    background-color: ${getColorBlindRGB(colorblindData.key, \"#194d1f\")};\n  }*/\n\n  .button_download_data, .button_download_lps_hazards, .button_download_lps_emissions, .button_download_ghg, .clasetatata, .button_download_area{\n    background: #FFFFFF;\n    border: 1px solid black;\n    padding: 10px 20px;\n  }\n\n  .button_download_data:hover, .button_download_lps_hazards:hover, .button_download_lps_emissions:hover, .button_download_ghg:hover, .clasetatata:hover, .button_download_area:hover{\n    background: #EFEFEF;\n  }\n\n  .button_download_data:active, .button_download_lps_hazards:active, .button_download_lps_emissions:active, .button_download_ghg:active, .clasetatata:active, .button_download_area:active{\n    background: #DCDCDC;\n  }\n\n  /*-------------------- Estilos scroll*/\n  *::-webkit-scrollbar {\n    width: 5px;\n  }\n\n  *::-webkit-scrollbar-track {\n    background: rgb(245, 245, 245);\n  }\n\n  *::-webkit-scrollbar-thumb {\n    background: #216729;\n    border-radius: 20px;\n  }\n\n  /*------------ Estilo tablas*/\n  .content_table a {\n    cursor: pointer;\n  }\n\n  table .head{\n    background-color: \"#216729\";\n  }\n\n  th h3 {\n    color: white !important;\n    padding: 0;\n  }\n\n  th h4 {\n    color: white !important;\n  }\n  \n  #main{\n    margin-bottom: 1%;\n  }\n  \n  #main_table{\n    margin: 0;\n  }\n\n  .head {\n    display: grid;\n    grid-template-columns: repeat(9,1fr);\n    grid-template-rows: repeat(2,1fr);\n  }\n\n  .first_head {\n    grid-column: 1/10;\n    grid-row: 1/3;\n    display: grid;\n    grid-template-columns: repeat(9,1fr);\n  }\n\n  .first_head_one{\n    grid-column: 1 / 3;\n    grid-row: 1 / 3;\n  }\n\n  .first_head_two{\n    grid-column: 3 / 6;\n    grid-row: 1 / 2;\n  }\nBase Layer\nLayer Opacity\n\n  .first_head_three{\n    grid-column: 6 / 10;\n    grid-row: 1 / 2;\n  }\n\n  .second_head{\n    grid-row: 2/3;\n    grid-column: 3/10;\n    display: grid;\n    grid-template-columns: repeat(7,1fr);\n  }\n\n  .body_row{\n    width: 100%;\n    display: grid;\n    grid-template-columns: repeat(9,1fr);width: 100%;\n    display: grid;\n    grid-template-columns: repeat(9,1fr);\n  }\n\n  .body_row &gt; :first-child{\n    grid-column: 1/3;\n  }\n\n  table {\n    font-family: \"IBM Plex Sans\", \"Source Serif Pro\";\n    border-collapse: collapse;\n    width: 100%;\n    max-width:100%;\n    font-size: 16px;\n  }\n  \n  table td, table th {\n    border: 1px solid #ddd!important;\n    padding: 8px;\n  }\n  \n  table tr:nth-child(even){background-color: #f2f2f2 !important;}\n  \n  #main_table &gt; tbody tr:hover {background-color: #ddd !important;}\n  \n  table th {\n    padding-top: 12px;\n    padding-bottom: 12px;\n    text-align: left;\n    background-color: ${getColorBlindRGB(colorblindData.key, \"#216729\")} !important;\n    color: white;\n    text-align: center;\n    vertical-align: middle;\n  }\n\n  /*-------- Estilos tooltip*/\n   #tooltip_contraint{\n    background-color: white;\n    padding: 10px 15px;\n    box-shadow: rgba(149, 157, 165, 0.2) 0px 8px 24px;\n    border-radius: 12px;\n    z-index:100;\n    font-size:16px\n  }\n  \n  #tooltip_contraint &gt; hr{\n    margin: 10px 0;\n    padding: 0;\n  }\n\n  #tooltip_contraint_ghg{\n    border: 2px solid currentColor; \n    background-color: white;\n    padding: 10px 15px;\n    z-index:100;\n  }\n  \n  #tooltip_contraint_ghg &gt; hr{\n    margin: 10px 0;\n    padding: 0;\n  }\n\n   .oportunity_level_high{\n    background: ${getColorBlindRGB(colorblindData.key, \"#39ff0033\")};\n    color: ${getColorBlind(colorblindData.key, \"#094200\")};\n  }\n  .oportunity_level_medium{\n    background:  ${getColorBlindRGB(colorblindData.key, \"#faea5d3b\")};\n    color: ${getColorBlind(colorblindData.key, \"#807305\")};\n  }  \n\n  /*------- Estilos lista*/\n   /*td &gt; ul{\n    display: flex;\n    flex-wrap: wrap;\n    column-gap:30px;\n  }\n\n  td &gt; ul &gt; li::marker{\n    content: '• '\n  }\n  li {\n    position: relative;\n    color: #000;\n    text-decoration: none;\n    max-width:fit-content;\n  }\n  */\n  /*li:hover {\n    color: #000;\n  }\n  \n  li::before {\n    content: \"\";\n    position: absolute;\n    display: block;\n    width: 100%;\n    height: 2px;\n    bottom: 0;\n    left: 0;\n    background-color: #000;\n    transform: scaleX(0);\n    transform-origin: left;\n    transition: transform 0.3s ease;\n  }\n  \n  li:hover::before {\n    transform: scaleX(1);\n  }*/\n\n  /*------------ Estilos  checkbox*/\n  .container_checkbox{\n    display: flex;\n    justify-content: space-around;\n    flex-wrap: wrap;\n    align-items: center;\n    gap: 10px 0px;\n  }\n  \n  .label_checkbox{\n    display:flex;\n  }\n  \n  .label_checkbox input[type=\"checkbox\"] {\n    display: none;\n    visibility: hidden;\n  }\n\n  .label_checkbox label {\n    display: inline-block;\n  }\n\n  .label_checkbox .cbx {\n    position: relative;\n    top: 1px;\n    width: 17px;\n    height: 17px;\n    border: 1px solid #c8ccd4;\n    border-radius: 3px;\n    vertical-align: middle;\n    transition: background 0.1s ease;\n    cursor: pointer;\n    margin-right:5px;\n  }\n  .label_checkbox .cbx:after {\n    content: '';\n    position: absolute;\n    top: 1px;\n    left: 5px;\n    width: 5px;\n    height: 11px;\n    opacity: 0;\n    transform: rotate(45deg) scale(0);\n    border-right: 2px solid #fff;\n    border-bottom: 2px solid #fff;\n    transition: all 0.3s ease;\n    transition-delay: 0.15s;\n  }\n  .label_checkbox .lbl {\n    margin-left: 5px;\n    vertical-align: middle;\n    cursor: pointer;\n  }\n  .label_checkbox input[type=\"checkbox\"]:checked ~ .cbx {\n    border-color: transparent;\n    background:  ${getColorBlindRGB(colorblindData.key, \"#216729\")};\n    animation: jelly-42 0.6s ease;\n  }\n  .label_checkbox input[type=\"checkbox\"]:checked ~ .cbx:after {\n    opacity: 1;\n    transform: rotate(45deg) scale(1);\n  }\n  .label_checkbox .cntr {\n    position: absolute;\n    top: 50%;\n    left: 0;\n    width: 100%;\n    text-align: center;\n  }\n\n  /*------- Animacion checkbox*/\n   @-moz-keyframes jelly-42 {\n    from {\n      transform: scale(1, 1);\n    }\n    30% {\n      transform: scale(1.25, 0.75);\n    }\n    40% {\n      transform: scale(0.75, 1.25);\n    }\n    50% {\n      transform: scale(1.15, 0.85);\n    }\n    65% {\n      transform: scale(0.95, 1.05);\n    }\n    75% {\n      transform: scale(1.05, 0.95);\n    }\n    to {\n      transform: scale(1, 1);\n    }\n  }\n  @-webkit-keyframes jelly-42 {\n    from {\n      transform: scale(1, 1);\n    }\n    30% {\n      transform: scale(1.25, 0.75);\n    }\n    40% {\n      transform: scale(0.75, 1.25);\n    }\n    50% {\n      transform: scale(1.15, 0.85);\n    }\n    65% {\n      transform: scale(0.95, 1.05);\n    }\n    75% {\n      transform: scale(1.05, 0.95);\n    }\n    to {\n      transform: scale(1, 1);\n    }\n  }\n  @-o-keyframes jelly-42 {\n    from {\n      transform: scale(1, 1);\n    }\n    30% {\n      transform: scale(1.25, 0.75);\n    }\n    40% {\n      transform: scale(0.75, 1.25);\n    }\n    50% {\n      transform: scale(1.15, 0.85);\n    }\n    65% {\n      transform: scale(0.95, 1.05);\n    }\n    75% {\n      transform: scale(1.05, 0.95);\n    }\n    to {\n      transform: scale(1, 1);\n    }\n  }\n  @keyframes jelly-42 {\n    from {\n      transform: scale(1, 1);\n    }\n    30% {\n      transform: scale(1.25, 0.75);\n    }\n    40% {\n      transform: scale(0.75, 1.25);\n    }\n    50% {\n      transform: scale(1.15, 0.85);\n    }\n    65% {\n      transform: scale(0.95, 1.05);\n    }\n    75% {\n      transform: scale(1.05, 0.95);\n    }\n    to {\n      transform: scale(1, 1);\n    }\n  }\n  /*---------- CSS Victor*/\n  .cooltip {\n    background: white;    \n    border: 2px solid currentColor; \n    padding: 10px;\n    position: absolute;\n    display: none;\n    max-width: 500px;\n    font-family: \"IBM Plex Sans\", \"Source Serif Pro\";\n    z-index:10000\n  }\n  \n  .content-wrapper-adaptation {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 16px\n  }\n  \n  .chart-adaptation {\n    flex: 1; /* Para que ocupe el espacio restante */\n    margin-top: 30px;\n  }\n  \n  .icons-emissions {\n    display: flex;\n    flex-wrap: wrap;\n    flex-direction: column;\n    gap: 10px;\n    max-width: 200px;\n    flex: 1\n  }\n  \n  .icon-item {\n    display: flex;\n    align-items: center;\n    font-size: small;\n  }\n  \n  .icon-item svg {\n    width: 31px;\n    height: 31px;\n    margin: 7px 12px 0 7px;\n  }\n  \n  @media (max-width: 600px) {\n    .content-wrapper-adaptation {\n      flex-direction: column;\n    }\n  \n    .chart-adaptation {\n      flex-basis: 60%; /* Tamaño inicial del gráfico */\n      margin-right: 20px; /* Espacio entre el gráfico y los iconos */\n      margin-top: 10px;\n    }\n  \n    .icons-emissions {\n      flex-basis: 40%; /* Tamaño inicial de los iconos */\n    }\n  }\n\n  .Adaptation {\n    fill:  ${getColorBlindRGB(colorblindData.key, \"rgb(197, 22, 23)\")} !important;\n  }\n\n  .Mitigation {\n    fill:  ${getColorBlindRGB(colorblindData.key, \"rgb(86, 81, 255)\")} !important;\n  }\n\n  .color-box {\n    display: inline-block;\n    width: 20px;\n    height: 20px;\n    margin-right: 5px;\n    vertical-align: sub;\n  }\n  .custom-slider {\n    -webkit-appearance: none;\n    width: 100%;\n    height: 15px;\n    background: linear-gradient(to right, ${getColorBlindRGB(colorblindData.key, \"#C51617\")}, ${getColorBlindRGB(colorblindData.key, \"#C51617\")} 50%, ${getColorBlindRGB(colorblindData.key, \"#5651FF\")} 50%, ${getColorBlindRGB(colorblindData.key, \"#5651FF\")});\n    border-radius: 5px;\n    outline: none;\n    margin: 20px 0;\n  }\n  \n  .custom-slider::-webkit-slider-thumb {\n    -webkit-appearance: none;\n    width: 25px;\n    height: 25px;\n    background: grey;\n    border-radius: 50%;\n    cursor: pointer;\n  }\n  \n  .progress {\n    height: 45px;\n    width: 45px;\n    border-radius: 50%;\n    -webkit-mask: radial-gradient(#0000 59%,#000 60% 70%,#0000 71%);\n    position: absolute;\n    top: 0;\n    left: 0;\n    z-index: 1;\n  }\n  \n  .progress::before {\n    content: '';\n    display: block;\n    width: 100%;\n    height: 100%;\n    border-radius: inherit;\n    background: conic-gradient(${getColorBlindRGB(colorblindData.key, \"#40C70D\")} var(--angle),lightgrey 0);\n    animation: 2s animate linear forwards;\n  }\n  \n  @keyframes animate {\n    from {\n        --angle: 0deg;\n    }\n    to {\n        --angle: var(--p);\n    }\n    \n  }\n  \n  @property --angle {\n    syntax: \"&lt;angle&gt;\"; /* this can be angle or percentage */\n    initial-value: 0deg;\n    inherits: false;\n  }\n\n  #checkbox_adapatation input{\n    accent-color: ${getColorBlindRGB(colorblindData.key, \"#6871f1\")};\n  }\n\n  @media only screen and (max-width: 768px) {\n\n    #main_table{\n      font-size: 10px;\n    }\n    \n  }\n\n  .laber_input {\n    padding: 8px 0;\n    font-family: \"IBM Plex Sans\";\n    font-size: 12px;\n    text-transform: uppercase;\n    border-bottom: 1px solid #333;\n    width: 100%;\n    display: block;\n  }\n\n  figure svg {\n    font-size: 10px;\n  }\n&lt;/style&gt;`\n}\n\n\n\n\n\n\n\nhtml`${styling}`;\n\n\n\n\n\n\n\nnotebookTitle = _lang({\n  en: \"Prioritize Livestock Investments\",\n  fr: \"Prioriser les investissements dans le bétail\",\n});\n\n\n\n\n\n\n\nimport { dropdownInput, dropdownCSS } from \"@tashapiro/dropdown-input\";\n\n\n\n\n\n\n\ndropdownCSS;\n\n\n\n\n\n\n\ndebounce = (delay, input) =&gt; {\n  class DelayedEvent extends Event {}\n  let id;\n  input.addEventListener(\"input\", (e) =&gt; {\n    if (e instanceof DelayedEvent) return;\n    e.stopImmediatePropagation();\n    clearTimeout(id);\n    id = setTimeout(\n      () =&gt; input.dispatchEvent(new DelayedEvent(\"input\", { bubbles: true })),\n      delay,\n    );\n  });\n  return input;\n};\n\n\n\n\n\n\n\n// admin multi-select: countries\nviewof select_species = {\n  const data = getSpecies().map((d) =&gt; ({\n    value: d,\n    label: d\n  }));\n  const input = dropdownInput({\n    inputLabel: _lang(nbText.sections.scalableSolutions.table.inputs.selectSpecies.label),\n    inputId: \"positionsTest\",\n    placeholderText: _lang(nbText.sections.scalableSolutions.table.inputs.selectSpecies.placeholder),\n    options: data,\n    selected: [data[0].value]\n  });\n  return debounce(500, input);\n}\n\n\n\n\n\n\n\n// admin multi-select: countries\nviewof select_system = {\n  const data = getLivestockSystem().map((d) =&gt; ({\n    value: d,\n    label: d\n  }));\n  const input = dropdownInput({\n    inputLabel: _lang(nbText.sections.scalableSolutions.table.inputs.selectLivestock.label),\n    inputId: \"positionsTest\",\n    placeholderText: _lang(nbText.sections.scalableSolutions.table.inputs.selectLivestock.placeholder),\n    options: data,\n    selected: [data[0].value]\n  });\n  return debounce(500, input);\n}\n\n\n\n\n\n\n\ndataStock = FileAttachment(\"1_FAO_stocks_years.csv\").csv();\n\n\n\n\n\n\n\ndataVOP = FileAttachment(\"1_FAO_vop_year.csv\").csv();\n\n\n\n\n\n\n\ndataGHG = FileAttachment(\"1_FAO_ghg_years.csv\").csv();\n\n\n\n\n\n\n\ndataSummary = FileAttachment(\"country_emissions_hazards.csv\").csv();\n\n\n\n\n\n\n\nmd`## Translation`;\n\n\n\n\n\n\n\nimport { Lang } from \"7d46679f7d0d917e\";\n\n\n\n\n\n\n\nlanguages = [\n  { key: \"en\", label: \"English\", locale: \"en-US\" },\n  { key: \"fr\", label: \"Français\", locale: \"fr-FR\" },\n];\n\n\n\n\n\n\n\n// get the default language key from parameter, or use default\ndefaultLangKey = {\n  const name = \"lang\";\n  const list = languages.map((d) =&gt; d.key);\n  const defaultKey = \"en\";\n\n  const queryParam = await Lang.getParamFromList({ name, list });\n\n  return queryParam ?? defaultKey;\n}\n\n\n\n\n\n\n\n// helper shorthand for Lang text-getting\n_lang = Lang.lg(language.key);\n\n\n\n\n\n\n\n// main toggle of language key\nviewof language = Inputs.radio(languages, {\n  label: \"Main language toggle\",\n  format: (d) =&gt; d.key,\n  value: languages.find((x) =&gt; x.key === defaultLangKey),\n})\n\n\n\n\n\n\n\nnbText = {\n  return {\n    legends: {\n      language: {\n        en: \"language\",\n        fr: \"langue\"\n      },\n      toc: {\n        en: \"in this notebook\",\n        fr: \"dans ce notebook\"\n      },\n      ssa: {\n        en: \"Sub-Saharan Africa\",\n        fr: \"d'Afrique subsaharienne\"\n      },\n      colorblind: {\n        label: {\n          en: \"Do you see colors clearly or have trouble distinguishing them?\",\n          fr: \"Voyez-vous clairement les couleurs ou avez-vous du mal à les distinguer?\"\n        },\n        values: {\n          non: {\n            en: \"None\",\n            fr: \"Aucun\"\n          },\n          deu: {\n            en: \"Deuteranopia\",\n            fr: \"Deutéranopie\"\n          },\n          pro: {\n            en: \"Protanopia\",\n            fr: \"Protanopie\"\n          },\n          tri: {\n            en: \"Tritanopia\",\n            fr: \"Tritanopie\"\n          }\n        }\n      }\n    },\n    sections: {\n      quickInsightsGeneral: {\n        header: {\n          en: ({ selection } = {}) =&gt; md`Quick Insights for ${selection}`,\n          fr: ({ selection } = {}) =&gt; md`Aperçu Rapide pour ${selection}`\n        }\n      },\n      overview: {\n        title: {\n          en: `Overview`,\n          fr: `Vue d’Ensemble`\n        },\n        intro: {\n          en: md`No conceivable Global Future can neglect livestock production. Livestock production systems are the main source of income and livelihood for 300 million people in sub-Saharan Africa. Animals generate revenue through milk and meat production, provide draught power for on-farm activities, and act as insurance when everything else fails. Livestock are at risk from a plethora of climate hazards, and they also generate greenhouse gas emissions that warm the planet. Given livestock are both at risk from and a source of climate change, where should investment be directed for impact?`,\n          fr: md`Aucun avenir mondial imaginable ne peut négliger la production de bétail. Les systèmes de production de bétail constituent la principale source de revenus et de subsistance pour 300 millions de personnes en Afrique subsaharienne. Les animaux génèrent des revenus grâce à la production de lait et de viande, fournissent de la puissance de traction pour les activités agricoles sur place, et servent d'assurance lorsque tout le reste échoue. Les animaux sont menacés par une multitude de risques climatiques, et ils produisent également des émissions de gaz à effet de serre qui réchauffent la planète. Étant donné que le bétail est à la fois en danger par et une source de changement climatique, où les investissements doivent-ils être dirigés pour avoir un impact?`\n        },\n        inspiration: {\n          en: md`This spotlight is inspired by the Nature Sustainability Publication &lt;a href=\"https://nature.com/articles/s41893-023-01161-1\"&gt;Priority areas for investment in more sustainable and climate-resilient livestock systems&lt;/a&gt;.`,\n          fr: md`Ce *spotlight* est inspiré par la publication de Nature Sustainability sur &lt;a href=\"https://nature.com/articles/s41893-023-01161-1\"&gt;les zones prioritaires pour l'investissement dans des systèmes de bétail plus durables et résilients au climat.&lt;/a&gt;.`\n        }\n      },\n      livestockExplosion: {\n        title: {\n          en: `The Livestock Explosion`,\n          fr: `L’explosion du Bétail`\n        },\n        intro: {\n          en: `The visualization below helps you explore historical **(2010 - 2021)** trends in livestock population, value of production (VoP), and greenhouse gas (GHG) emissions. These trends give a measure of the rapid pace of growth of the sector, and therefore its importance for people and the environment.`,\n          fr: `La visualisation ci-dessous vous aide à explorer les tendances historiques **(2010 - 2021)** de la population de bétail, de la valeur de la production (VDP) et des émissions de gaz à effet de serre (GES). Ces tendances donnent une mesure de la rapidité de croissance du secteur, et donc de son importance pour les personnes et l'environnement.`\n        },\n        chart: {\n          legend: {\n            \"breedinganimals\": {en: 'Breeding animals', fr: \"Animaux d'élevage\"},\n            \"marketanimals\": {en: 'Market animals', fr: \"Animaux de marché\"},\n            \"grazinganimals\": {en: 'Grazing animals', fr: \"Animaux de pâturage\"},\n            \"poultry\": {en: 'Poultry', fr: \"Volaille\"},\n            \"workinganimals\": {en: 'Working animals', fr: \"Animaux de travail\"}\n          },\n          labels: {\n            year: {\n              en: \"Year\",\n              fr: \"Année\"\n            },\n            category: {\n              en: \"Category\",\n              fr: \"Catégorie\"\n            }\n          },\n          inputLabel: {\n            en: \"Variable\",\n            fr: \"Variable\"\n          },\n          variables: {\n            stock: {\n              label: {\n                en: \"Stock\",\n                fr: \"Stock\"\n              },\n              tip: {\n                en: \"Stock (million)\",\n                fr: \"Stock (millions)\"\n              }\n            },\n            ghg: {\n              label: {\n                en: \"GHG Emissions\",\n                fr: \"Émissions de GES\"\n              },\n              tip: {\n                en: \"Emissions (MtCo2e)\",\n                fr: \"Émissions (MtCo2e)\"\n              }\n            },\n            vop: {\n              label: {\n                en: \"Value of production\",\n                fr: \"Valeur de la production\"\n              },\n              tip: {\n                en: \"VOP (billion usd)\",\n                fr: \"VDP (milliard de dollars)\"\n              }\n            }\n          }\n        },\n        download: {\n          labelFunc: {\n            en: (d) =&gt; `Download ${d} Data`,\n            fr: (d) =&gt; `Télécharger les Données ${d}`\n          }\n        },\n        insights: {\n          livestock: {\n            en: ({ selection, year, population, percent, yearSince } = {}) =&gt;\n              htl.html`&lt;b&gt;${selection}&lt;/b&gt;’s livestock population in &lt;b&gt;${year}&lt;/b&gt; is &lt;b&gt;${population} billion&lt;/b&gt;, and has grown by &lt;b&gt;${percent}%&lt;/b&gt; since &lt;b&gt;${yearSince}&lt;/b&gt;.`,\n            fr: ({ selection, year, population, percent, yearSince } = {}) =&gt;\n              htl.html`Le bétail de &lt;b&gt;${selection}&lt;/b&gt; au &lt;b&gt;${year}&lt;/b&gt; s’élève à &lt;b&gt;${population} milliards&lt;/b&gt; et a augmenté de &lt;b&gt;${percent}%&lt;/b&gt; depuis &lt;b&gt;${yearSince}&lt;/b&gt;.`\n          },\n          vop: {\n            en: ({ selection, year, population, percent, yearSince } = {}) =&gt;\n              htl.html`&lt;b&gt;${selection}&lt;/b&gt;’s value of production in &lt;b&gt;${year}&lt;/b&gt; is &lt;b&gt;${population} billion&lt;/b&gt;, and has grown by &lt;b&gt;${percent}%&lt;/b&gt; since &lt;b&gt;${yearSince}&lt;/b&gt;.`,\n            fr: ({ selection, year, population, percent, yearSince } = {}) =&gt;\n              htl.html`La valeur de la production de &lt;b&gt;${selection}&lt;/b&gt; en &lt;b&gt;${year}&lt;/b&gt; est de &lt;b&gt;${population} milliards de dollars&lt;/b&gt; et a augmenté de &lt;b&gt;${percent}%&lt;/b&gt; depuis &lt;b&gt;${yearSince}&lt;/b&gt;.`\n          },\n          ghg: {\n            en: ({ mult } = {}) =&gt;\n              htl.html`The explosion in livestock numbers comes at the expense of a growth in &lt;b&gt;GHG emissions&lt;/b&gt; of &lt;b&gt;${mult}&lt;/b&gt; times in the same period.`,\n            fr: ({ mult } = {}) =&gt;\n              htl.html`L’explosion du bétail se fait au détriment d’une croissance des &lt;b&gt;émissions de GES&lt;/b&gt; de &lt;b&gt;${mult}&lt;/b&gt; fois sur la même période.`\n          }\n        }\n      },\n      leversOfChange: {\n        title: {\n          en: \"Countries As Levers Of Change\",\n          fr: \"Les Pays Comme Leviers de Changement\"\n        },\n        intro: {\n          en: `Livestock’s exposure to climate hazards and GHG emissions totals imply that climate actions need to address both adaptation and mitigation outcomes. Investing in actions begs the question of where those investments should be targeted. This section explores geographic priorities for investment in climate action for livestock systems. Hover over the selected priorities to get an overview of emissions totals and hazard exposure.`,\n          fr: `L'exposition du bétail aux aléas climatiques et le total des émissions de GES impliquent que les actions climatiques doivent aborder à la fois les résultats d'adaptation et d'atténuation. Investir dans des actions soulève la question de savoir où ces investissements devraient être ciblés. Cette section explore les priorités géographiques pour l'investissement dans l'action climatique pour les systèmes de bétail. Survolez les priorités sélectionnées pour obtenir un aperçu du total des émissions et de l'exposition aux risques.`\n        },\n        inputs: {\n          radio: {\n            label: {\n              en: \"Configuration\",\n              fr: \"Configuration\"\n            },\n            values: {\n              adap: {\n                en: \"Adaptation only\",\n                fr: \"Adaptation uniquement\"\n              },\n              adap_mit: {\n                en: \"Adaptation and mitigation equally\",\n                fr: \"Adaptation et atténuation à parts égales\"\n              },\n              mit: {\n                en: \"Mitigation only\",\n                fr: \"Atténuation uniquement\"\n              }\n            }\n          },\n          num: {\n            label: {\n              en: \"Maximum number of priorities\",\n              fr: \"Nombre maximum de priorités\"\n            }\n          }\n        },\n        chart: {\n          map: {\n            legend: {\n              title: {\n                en: \"Prioritization\",\n                fr: \"Priorisation\"\n              },\n              lo: {\n                en: \"Low\",\n                fr: \"Faible\"\n              },\n              md: {\n                en: \"Medium\",\n                fr: \"Moyen\"\n              },\n              hi: {\n                en: \"High\",\n                fr: \"Élevé\"\n              }\n            },\n            tooltip: {\n              headers: {\n                hazards: {\n                  en: \"Hazards\",\n                  fr: \"Dangers\"\n                },\n                emissions: {\n                  en: \"Emissions\",\n                  fr: \"Émissions\"\n                }\n              },\n              data: {\n                hazards: {\n                  tlu: {\n                    name: {\n                      en: \"Tropical livestock units\",\n                      fr: \"Unités de bétail tropicales\"\n                    },\n                    unit: {\n                      en: \"Million\",\n                      fr: \"Millions\"\n                    }\n                  },\n                  pastureArea: {\n                    name: {\n                      en: \"Pasture area\",\n                      fr: \"Superficie de pâturage\"\n                    },\n                    unit: {\n                      en: \"Million ha\",\n                      fr: \"Millions ha\"\n                    }\n                  },\n                  popRural: {\n                    name: {\n                      en: \"Rural population\",\n                      fr: \"Population rurale\"\n                    },\n                    unit: {\n                      en: \"Million people\",\n                      fr: \"Millions de personnes\"\n                    }\n                  },\n                  vop: {\n                    name: {\n                      en: \"Value of production\",\n                      fr: \"Valeur de la production\"\n                    },\n                    unit: {\n                      en: \"Million USD\",\n                      fr: \"Millions de dollars\"\n                    }\n                  }\n                },\n                emissions: {\n                  unit: {\n                    en: \"Mt CO2e\",\n                    fr: \"Mt CO2e\"\n                  },\n                  values: {\n                    bovine: {\n                      en: \"Bovine\",\n                      fr: \"Bovine\"\n                    },\n                    pig: {\n                      en: \"Pig\",\n                      fr: \"Cochon\"\n                    },\n                    poultry: {\n                      en: \"Poultry\",\n                      fr: \"Volaille\"\n                    },\n                    shoat: {\n                      en: \"Shoat\",\n                      fr: \"Shoat\"\n                    },\n                    flPasture: {\n                      en: \"Forest loss to pasture\",\n                      fr: \"Perte de forêt au profit des pâturages\"\n                    },\n                    flSoy: {\n                      en: \"Forest loss to soy\",\n                      fr: \"Perte de forêt à cause du soja\"\n                    }\n                  }\n                }\n              }\n            }\n          },\n          download: {\n            categories: {\n              en: \"Download Data Categories\",\n              fr: \"Télécharger Données sur les Catégories\"\n            },\n            climate: {\n              en: \"Download Data Climate Hazard\",\n              fr: \"Télécharger les Données sur les Aléas Climatiques\"\n            },\n            emissions: {\n              en: \"Download Data Emissions\",\n              fr: \"Télécharger les Données sur les Émissions\"\n            }\n          }\n        },\n        insights: {\n          title: {\n            en: \"Quick Insights For The Identified Priority Countries\",\n            fr: \"Aperçus rapides pour les pays prioritaires identifiés\"\n          },\n          investmentPriorities: {\n            en: ({\n              percAdaptation,\n              percMitigation,\n              countryCount,\n              livestockProd,\n              peopleExposed,\n              ggEmissions\n            } = {}) =&gt;\n              `The selected weighting of **${percAdaptation}%** adaptation, **${percMitigation}%** mitigation, and number of geographies selected, result in investment priorities that span **${countryCount}** countries and encompass **${livestockProd} billion USD** in livestock production. Climate actions in these countries can benefit **${peopleExposed} million** people exposed to hazards, and contribute to reducing some of the **${ggEmissions} MT CO2e** in greenhouse gas emissions.`,\n            fr: ({\n              percAdaptation,\n              percMitigation,\n              countryCount,\n              livestockProd,\n              peopleExposed,\n              ggEmissions\n            } = {}) =&gt;\n              `La pondération sélectionnée de **${percAdaptation}%** d'adaptation, **${percMitigation}%** d'atténuation et le nombre de zones géographiques sélectionnées aboutissent à des priorités d'investissement qui couvrent **${countryCount}** pays et englobent **${livestockProd} milliards de dollars** dans la production animale. Les actions climatiques dans ces pays peuvent bénéficier à **${peopleExposed} millions** de personnes exposées à des aléas et contribuer à réduire une partie des **${ggEmissions} MT CO2e** des émissions de gaz à effet de serre.`\n          },\n          mostCritical: {\n            en: ({ lever, percVop, percEmissions } = {}) =&gt;\n              `The most critical lever of change in the priority list is **${lever}**, which constitutes **${percVop}%** of exposed value of production and **${percEmissions}%** of emissions in relation to the overall sub-Saharan Africa total.`,\n            fr: ({ lever, percVop, percEmissions } = {}) =&gt;\n              `Le levier de changement le plus critique dans la liste des priorités est **${lever}**, qui constitue **${percVop}%** de la valeur exposée de la production et **${percEmissions}%** des émissions par rapport au total global de l’Afrique subsaharienne.`\n          },\n          countrySystems: {\n            en: ({ first, second, third } = {}) =&gt;\n              `In this country, the systems that have the greatest exposure and emissions, and should therefore be the highest priorities are **${first}**, followed by **${second}**, and **${third}**.`,\n            fr: ({ first, second, third } = {}) =&gt;\n              `Dans ce pays, les systèmes les plus exposés et les plus émetteurs, et qui devraient donc être les plus prioritaires, sont **${first}**, suivis de **${second}** et **${third}**.`\n          },\n          sigHazard: {\n            en: ({ location, hazard, vop } = {}) =&gt;\n              `The most significant hazard(s) in **${location}** is **${hazard}** potentially impacting **${vop} USD billion VoP**.`,\n            fr: ({ location, hazard, vop } = {}) =&gt;\n              `Le(s) danger(s) le plus important(s) **${location}** est **${hazard}**, avec un impact potentiel de **${vop} milliard de dollars de VDP**.`\n          },\n            hazard_defs: {\n              \"Thi\": { en: \"Livestock heat stress\", \n                       fr: \"Le stress thermique du bétail\" \n                     },\n              \"RF\": { en: \"Extreme or high rainfall variability\", \n                      fr: \"La variabilité extrême ou élevée des précipitations\" \n                     },\n              \"D\": { en: \"Drought\", \n                     fr: \"La sécheresse\" \n                   },\n              \"F\": { en: \"Flooding\", \n                     fr: \"L'inondation\" \n                   },\n              \"CV\": { en: \"Rainfall variability\", \n                      fr: \"La variabilité des précipitations\" \n                     },\n              \"ExCV\": { en: \"Extremely high rainfall variability\", \n                        fr: \"La variabilité extrêmement élevée des précipitations\" \n                       },\n              \"HCV\": { en: \"High rainfall variability\", \n                       fr: \"La variabilité élevée des précipitations\" \n                     },\n              \"CV+D\": { en: \"Rainfall variability and drought\", \n                        fr: \"La variabilité des précipitations et la sécheresse\" \n                       },\n              \"CV+D+F\": { en: \"Rainfall variability, drought and flooding\", \n                          fr: \"La variabilité des précipitations, la sécheresse et l'inondation\" \n                         },\n              \"CV+F\": { en: \"Rainfall variability and flooding\", \n                        fr: \"La variabilité des précipitations et l'inondation\" \n                       },\n              \"CV+Thi\": { en: \"Rainfall variability and livestock heat stress\", \n                          fr: \"La variabilité des précipitations et le stress thermique du bétail\" \n                         },\n              \"CV+Thi+D\": { en: \"Rainfall variability, livestock heat stress and drought\", \n                            fr: \"La variabilité des précipitations, le stress thermique du bétail et la sécheresse\" \n                           },\n              \"CV+Thi+D+F\": { en: \"Rainfall variability, livestock heat stress, drought and flooding\", \n                              fr: \"La variabilité des précipitations, le stress thermique du bétail, la sécheresse et l'inondation\" \n                           },\n              \"CV+Thi+F\": { en: \"Rainfall variability, livestock heat stress and flooding\", \n                            fr: \"La variabilité des précipitations, le stress thermique du bétail et l'inondation\" \n                         },\n              \"D+F\": { en: \"Drought and flooding\", \n                       fr: \"La sécheresse et l'inondation\" \n                     },\n              \"Thi+D\": { en: \"Livestock heat stress and drought\", \n                         fr: \"Le stress thermique du bétail et la sécheresse\" \n                       },\n              \"Thi+D+F\": { en: \"Livestock heat stress, drought and flooding\", \n                           fr: \"Le stress thermique du bétail, la sécheresse et l'inondation\" \n                         },\n              \"Thi+F\": { en: \"Livestock heat stress and flooding\", \n                         fr: \"Le stress thermique du bétail et l'inondation\"\n                       }\n          }\n        },\n        livestockProductionSystems: {\n          header: {\n            en: `Livestock Production Systems Within Priority Countries`,\n            fr: `Systèmes de Production Animale Dans les Pays Prioritaires`\n          },\n          tableIntro: {\n            en: `Explore the overall country ranking and their livestock production systems using the table below.`,\n            fr: `Explorez le classement général des pays et leurs systèmes de production animale à l’aide du tableau ci-dessous.`\n          },\n          countryInput: {\n            label: {\n              en: \"Country\",\n              fr: \"Pays\"\n            }\n          },\n          table: {\n            headers: {\n              country: {\n                en: \"Country\",\n                fr: \"Pays\"\n              },\n              ghgEmissions: {\n                en: \"GHG Emissions\",\n                fr: \"Émissions de GES\"\n              },\n              livestockSystem: {\n                en: \"Livestock production system\",\n                fr: \"Système de production animale\"\n              },\n              climateExposure: {\n                en: \"Climate Hazard Exposure\",\n                fr: \"Exposition aux Aléas Climatiques\"\n              },\n              emissionsDirect: {\n                en: \"Direct emissions (Mt CO2e)\",\n                fr: \"Émissions directes (Mt CO2e)\"\n              },\n              emissionsIndirect: {\n                en: \"Indirect emissions (Mt CO2e)\",\n                fr: \"Émissions indirectes (Mt CO2e)\"\n              },\n              emissionsTotal: {\n                en: \"Total emissions (Mt CO2e)\",\n                fr: \"Émissions totales (Mt CO2e)\"\n              },\n              popRural: {\n                en: \"Rural population (Million people)\",\n                fr: \"Population rurale (Millions de personnes)\"\n              },\n              vop: {\n                en: \"Value of production (Million USD)\",\n                fr: \"Valeur de la production (Millions de dollars)\"\n              },\n              tlu: {\n                en: \"Tropical livestock units (Million)\",\n                fr: \"Unités de bétail tropicales (Millions)\"\n              },\n              pastureArea: {\n                en: \"Pasture area (Million ha)\",\n                fr: \"Superficie de pâturage (Millions ha)\"\n              }\n            }\n          },\n          download: {\n            ghg: {\n              en: \"Download GHG Data\",\n              fr: \"Télécharger les Données sur les GES\"\n            },\n            lps_hazards: {\n              en: \"Download LPS Hazards Data\",\n              fr: \"Télécharger les Données sur les Dangers du LPS\"\n            },\n            lps_emissions: {\n              en: \"Download LPS Emissions Data\",\n              fr: \"Télécharger les Données sur les Émissions LPS\"\n            }\n          }\n        }\n      },\n      scalableSolutions: {\n        title: {\n          en: `Scalable Solutions`,\n          fr: `Solutions Évolutives`\n        },\n        intro: {\n          en: `Many actions exist that would be no-regret investments, delivering benefits for both adaptation and mitigation. However, why are they not yet reaching scale? This section helps explore some key adaptation and mitigation actions and their typical adoption constraints.`,\n          fr: `Il existe de nombreuses actions qui constitueraient des investissements sans regret, apportant des bénéfices tant pour l'adaptation que pour l'atténuation. Cependant, pourquoi ne sont-elles pas encore déployées à grande échelle ? Cette section permet d'explorer certaines actions clés d'adaptation et d'atténuation ainsi que les contraintes habituelles à leur adoption.`\n        },\n        table: {\n          title: {\n            en: \"Hazard Selectors (One of each must be selected)\",\n            fr: \"Sélecteurs de danger (un de chaque doit être sélectionné)\"\n          },\n          inputs: {\n            selectLivestock: {\n              label: {\n                en: \"Livestock System\",\n                fr: \"Système d'Élevage\"\n              },\n              placeholder: {\n                en: \"Select Livestock System...\",\n                fr: \"Sélectionnez le système d'élevage...\"\n              }\n            },\n            selectSpecies: {\n              label: {\n                en: \"Species\",\n                fr: \"Espèces\"\n              },\n              placeholder: {\n                en: \"Select species...\",\n                fr: \"Sélectionner une espèce...\"\n              }\n            }\n          },\n          headers: {\n            option: {\n              en: \"Option\",\n              fr: \"Option\"\n            },\n            priority: {\n              en: \"Priority\",\n              fr: \"Priorité\"\n            },\n            description: {\n              en: \"Description\",\n              fr: \"Description\"\n            }\n          }\n        },\n        download: {\n          en: \"Download Data\",\n          fr: \"Télécharger les Données\"\n        }\n      },\n      summary: {\n        title: {\n          en: `Summary`,\n          fr: `Résumé`\n        },\n        intro: {\n          en: `The livestock sector must transform in sub-Saharan Africa, if the region is to meet Sustainable Development Goals (SDGs). Critically, the livestock sector affects 10 of 17 SDGs.`,\n          fr: `Le secteur de l’élevage doit se transformer en Afrique subsaharienne si la région veut atteindre les objectifs de développement durable (ODD). De manière cruciale, le secteur de l’élevage affecte 10 des 17 ODD.`\n        },\n        countryListFunc: {\n          en: ({\n            num,\n            multiCountryString,\n            topCountryString,\n            multiString,\n            severalOthersString\n          } = {}) =&gt;\n            `Based on the analysis above, ${multiCountryString} ${topCountryString}${multiString}${severalOthersString}.`,\n          fr: ({\n            num,\n            multiCountryString,\n            topCountryString,\n            multiString,\n            severalOthersString\n          } = {}) =&gt;\n            `Sur la base de l'analyse ci-dessus, ${multiCountryString} ${topCountryString}${multiString}${severalOthersString}.`\n        },\n        countryListSupport: {\n          topStringFunc: {\n            en: ({ num } = {}) =&gt; `of the top **${num}** countries,`,\n            fr: ({ num } = {}) =&gt; `parmi les **${num}** principaux pays`\n          },\n          topCountryFunc: {\n            en: ({ top } = {}) =&gt;\n              `**${top}** is the most critical lever of change in the region`,\n            fr: ({ top } = {}) =&gt;\n              `**${top}** est le levier de changement le plus critique dans la région`\n          },\n          followedBy: {\n            en: `, followed by`,\n            fr: `, suivi par`\n          },\n          severalOthers: {\n            en: ` **and several others**`,\n            fr: ` **et plusieurs autres**`\n          }\n        },\n        outroFunc: {\n          en: ({ people, livestock, footprint } = {}) =&gt;\n            `Catalyzing climate action in these countries could help address adaptation for **${people} million** people, avoid devastating impacts that could affect some of the **${livestock} billion** in livestock production, while contributing to reducing livestock’s carbon footprint of **${footprint} MT CO2e**.`,\n          fr: ({ people, livestock, footprint } = {}) =&gt;\n            `Catalyser l’action climatique dans ces pays pourrait contribuer à l’adaptation pour **${people} millions** de personnes, éviter les impacts dévastateurs qui pourraient affecter une partie des **${livestock} milliards** de production animale, tout en contribuant à réduire l’empreinte carbone de l’élevage de **${footprint} MT CO2e**.`\n        }\n      },\n      methods: {\n        title: {\n          en: htl.html`Methods & Sources`,\n          fr: htl.html`Méthodes & Sources`\n        },\n        sections: {\n          datasets: {\n            title: {\n              en: htl.html`Datasets`,\n              fr: htl.html`Ensembles de Données`\n            },\n            body: {\n              en: htl.html`The data and methods used here are all documented by &lt;a href=\"https://www.nature.com/articles/s41893-023-01161-1\"&gt;Bonilla-Cedrez et al. (2023)&lt;/a&gt;. Here we provide a summarized version, and encourage the readers to read the original study. The data and code for the analysis of the original study is available in &lt;a href=\"https://github.com/CIAT/livestock_prioritization/tree/main\"&gt;GitHub&lt;/a&gt;. The original study and this Spotlight were conducted in collaboration with the &lt;a href=\"https://www.cgiar.org/initiative/livestock-and-climate/\"&gt;CGIAR Livestock & Climate Initiative&lt;/a&gt;.`,\n              fr: htl.html`Les données et méthodes utilisées ici sont toutes documentées par &lt;a href=\"https://www.nature.com/articles/s41893-023-01161-1\"&gt;Bonilla-Cedrez et al. (2023)&lt;/a&gt;. Nous fournissons ici une version résumée et encourageons les lecteurs à lire l’étude originale. Les données et le code pour l'analyse de l'étude originale sont disponibles sur &lt;a href=\"https://github.com/CIAT/livestock_prioritization/tree/main\"&gt;GitHub&lt;/a&gt;. L'étude originale et ce Spotlight ont été menés en collaboration avec &lt;a href=\"https://www.cgiar.org/initiative/livestock-and-climate/\"&gt;l'Initiative CGIAR Livestock & Climate&lt;/a&gt;.`\n            }\n          },\n          livestockProdSystems: {\n            title: {\n              en: htl.html`Livestock production systems`,\n              fr: htl.html`Systèmes de production animale`\n            },\n            body: {\n              en: htl.html`We used the livestock production system classification from the Food and Agriculture Organization of the United Nations (FAO) (Robinson et al., 2011). This classification divides livestock production systems into landless, rangeland, mixed irrigated, and mixed rainfed systems. Rangelands, and the mixed systems are each divided by agroecology into arid, hyperarid, temperate, and humid. This gives rise to twelve categories (the category landless is not considered for the analysis) for analysis.`,\n              fr: htl.html`Nous avons utilisé la classification des systèmes de production animale de l'Organisation des Nations Unies pour l'alimentation et l'agriculture (FAO) (Robinson et al., 2011). Cette classification divise les systèmes de production animale en systèmes sans terre, en parcours, irrigués mixtes et pluviaux mixtes. Les parcours et les systèmes mixtes sont chacun divisés par l'agroécologie en arides, hyperarides, tempérés et humides. Cela donne lieu à douze catégories (la catégorie sans terre n'est pas prise en compte pour l'analyse).`\n            }\n          },\n          exposureData: {\n            title: {\n              en: htl.html`Exposure data`,\n              fr: htl.html`Données d'exposition`\n            },\n            body: {\n              en: htl.html`Exposure was represented by the &lt;a href=\"https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/exposure_catalog/GLW3_livestock/GLW3_livestock_vop/GLW3_livestock_vop.json\"&gt;total value of production&lt;/a&gt;, &lt;a href=\"https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/population/worldpop_2020/collection.json\"&gt;total rural population&lt;/a&gt;, &lt;a href=\"http://www.earthstat.org/cropland-pasture-area-2000/\"&gt;pasture area&lt;/a&gt;, and Total Livestock Units (TLUs). TLU values were computed using data from the Gridded Livestock of the World database (&lt;a href=\"https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/exposure_catalog/GLW3_livestock/GLW3_livestock_no/GLW3_livestock_no.json\"&gt;GLW version 3&lt;/a&gt;).`,\n              fr: htl.html`L'exposition était représentée par la &lt;a href=\"https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/exposure_catalog/GLW3_livestock/GLW3_livestock_vop/GLW3_livestock_vop.json\"&gt;valeur totale de la production&lt;/a&gt;, &lt;a href=\"https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/population/worldpop_2020/collection.json\"&gt;la population rurale totale&lt;/a&gt;, &lt;a href=\"http://www.earthstat.org/cropland-pasture-area-2000/\"&gt;la superficie des pâturages&lt;/a&gt; et le nombre total d'unités de bétail (UBT). Les valeurs TLU ont été calculées à l'aide des données de la base de données Gridded Livestock of the World (&lt;a href=\"https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/exposure_catalog/GLW3_livestock/GLW3_livestock_no/GLW3_livestock_no.json\"&gt;GLW version 3&lt;/a&gt;).`\n            }\n          },\n          hazardData: {\n            title: {\n              en: htl.html`Hazard data`,\n              fr: htl.html`Données sur les aléas`\n            },\n            body: {\n              en: htl.html`This notebook uses six climate hazard data layers, namely, rainfall variability, heat stress, flooding risk, and risk of drought. Rainfall variability is represented by the coefficient of variation of annual mean rainfall (15–30% = highly variable; &gt;30% = extremely variable) computed using rainfall data from the Climate Hazards Group InfraRed Precipitation with Stations (CHIRPS) &lt;a href=\"https://doi.org/10.1038/sdata.2015.66\"&gt;dataset&lt;/a&gt;. Areas of heat stress were defined as having thermal stress with a Thermal Humidity Index (THI) of ≥79, with THI data derived from &lt;a href=\"https://doi.org/10.1111/gcb.15825\"&gt;Thornton et al. (2021)&lt;/a&gt;. To define areas at risk of flooding, we used the UN Environment Programme–Division of Early Warning and Assessment–GRID-Europe &lt;a href=\"https://unepgrid.ch/en/activity/1BDE1705\"&gt;dataset&lt;/a&gt;, in which flooding risk\nis ranked from 0 (no risk) to 5 (extreme). Areas at risk of drought were defined as having more than 25 days without rain per month on average based on historical rainfall records from CHIRPS.`,\n              fr: htl.html`Ce &lt;i&gt;notebook&lt;/i&gt; utilise six couches de données sur les risques climatiques, à savoir la variabilité des précipitations, le stress thermique, le risque d'inondation et le risque de sécheresse. La variabilité des précipitations est représentée par le coefficient de variation des précipitations moyennes annuelles (15 à 30 % = très variable ; &gt; 30 % = extrêmement variable) calculé à l'aide des données pluviométriques de &lt;a href=\"https://doi.org/10.1038/sdata.2015.66\"&gt;l'ensemble de données&lt;/a&gt; sur les précipitations infrarouges avec stations du Climate Hazards Group (CHIRPS). Les zones de stress thermique ont été définies comme présentant un stress thermique avec un indice d'humidité thermique (THI) ≥79, les données THI étant dérivées de &lt;a href=\"https://doi.org/10.1111/gcb.15825\"&gt;Thornton et al. (2021)&lt;/a&gt;. Pour définir les zones à risque d'inondation, nous avons utilisé &lt;a href=\"https://unepgrid.ch/en/activity/1BDE1705\"&gt;l'ensemble de données&lt;/a&gt; GRID-Europe du Programme des Nations Unies pour l'environnement – Division de l'alerte précoce et de l'évaluation – dans lequel le risque d'inondation est classé de 0 (aucun risque) à 5 (extrême). Les zones à risque de sécheresse ont été définies comme ayant plus de 25 jours sans pluie par mois en moyenne sur la base des enregistrements de précipitations historiques du CHIRPS.`\n            }\n          },\n          povertyData: {\n            title: {\n              en: htl.html`Poverty data`,\n              fr: htl.html`Données sur la pauvreté`\n            },\n            body: {\n              en: htl.html`National-level poverty headcount ratios at US$1.90 per day at 2021 international prices were gathered from The World Bank indicators database (&lt;a href=\"https://maps.worldbank.org/projects\"&gt;World Bank Maps&lt;/a&gt;).`,\n              fr: htl.html`Les ratios de pauvreté au niveau national, à 1,90 USD par jour aux prix internationaux de 2021, ont été collectés à partir de la base de données d'indicateurs de la Banque mondiale (&lt;a href=\"https://maps.worldbank.org/projects\"&gt;World Bank Maps&lt;/a&gt;).`\n            }\n          },\n          greenhouseEmissionsData: {\n            title: {\n              en: htl.html`Greenhouse gas emissions data`,\n              fr: htl.html`Données sur les émissions de gaz à effet de serre`\n            },\n            body: {\n              en: htl.html`Greenhouse gas emissions, totals of livestock, and value of production per year for the period 2010-2021 were all gathered from FAOSTAT, and used to produce the stacked line plot in the first section of this notebook. For the remaining sections, total livestock emissions by geography were computed as the sum of direct and estimated emissions from deforestation. Direct emissions data come from &lt;a href=\"https://doi.org/10.1073/pnas.130814911\"&gt;Herrero et al. (2013)&lt;/a&gt; and are for the year 2010, updated to 2019 using FAOSTAT. Emissions linked to deforestation combined above- and below-ground carbon biomass data from &lt;a href=\"https://doi.org/10.1098/rstb.2019.0128\"&gt;Soto-Navarro et al. (2020)&lt;/a&gt;, tree cover data (&lt;a href=\"https://doi.org/10.1126/science.1244693\"&gt;Hansen et al., 2013&lt;/a&gt;), and commodity-linked deforestation data (for soybean and pasture) from &lt;a href=\"https://www.wri.org/research/estimating-role-seven-commodities-agriculture-linked-deforestation-oil-palm-soy-cattle\"Goldman et al. (2020)&lt;/a&gt;. We included deforestation due to soybeans given that a substantial portion of soybean production is used for livestock feed.`,\n              fr: htl.html`Les émissions de gaz à effet de serre, le total du bétail et la valeur de la production annuelle pour la période 2010-2021 ont tous été collectés à partir de FAOSTAT et utilisés pour produire le graphique linéaire empilé dans la première section de ce cahier. Pour les sections restantes, les émissions totales du bétail par géographie ont été calculées comme la somme des émissions directes et estimées dues à la déforestation. Les données sur les émissions directes proviennent de &lt;a href=\"https://doi.org/10.1073/pnas.130814911\"&gt;Herrero et al. (2013)&lt;/a&gt; et concernent l’année 2010, mis à jour jusqu’en 2019 à l’aide de FAOSTAT. Les émissions liées à la déforestation combinaient les données sur la biomasse de carbone aérienne et souterraine de &lt;a href=\"https://doi.org/10.1098/rstb.2019.0128\"&gt;Soto-Navarro et al. (2020)&lt;/a&gt;, les données sur la couverture arborée (&lt;a href=\"https://doi.org/10.1126/science.1244693\"&gt;Hansen et al., 2013&lt;/a&gt;), et les données sur la déforestation liée aux produits de base (pour le soja et les pâturages) de &lt;a href=\"https://www.wri.org/research/estimating-role-seven-commodities-agriculture-linked-deforestation-oil-palm-soy-cattle\"&gt;Goldman et al. (2020)&lt;/a&gt;. Nous avons inclus la déforestation due au soja étant donné qu'une part substantielle de la production de soja est utilisée pour l'alimentation du bétail.`\n            }\n          },\n          boundaries: {\n            title: {\n              en: htl.html`Boundaries`,\n              fr: htl.html`Délimitations`\n            },\n            body: {\n              en: htl.html`&lt;a href=\"https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/boundary_catalog/geoBoundaries_SSA/collection.json\"&gt;Administrative areas&lt;/a&gt; used in this notebook come from &lt;a href=\"https://github.com/wmgeolab/geoBoundaries\"&gt;geoBoundaries 6.0.0&lt;/a&gt;. The gbHumanitarian boundaries are used and if not available then the gbOpen boundaries are substituted.`,\n              fr: htl.html`&lt;a href=\"https://radiantearth.github.io/stac-browser/#/external/digital-atlas.s3.amazonaws.com/stac/public_stac/boundary_catalog/geoBoundaries_SSA/collection.json\"&gt;Les zones administratives&lt;/a&gt; utilisées dans ce bloc-notes proviennent de &lt;a href=\"https://github.com/wmgeolab/geoBoundaries\"&gt;geoBoundaries 6.0.0&lt;/a&gt;. Les limites gbHumanitarian sont utilisées et si elles ne sont pas disponibles, les limites gbOpen sont remplacées.`\n            }\n          },\n          adaptationOptions: {\n            title: {\n              en: htl.html`Adaptation and mitigation options`,\n              fr: htl.html`Options d’adaptation et d’atténuation`\n            },\n            body: {\n              en: htl.html`Adaptation and mitigation options were compiled through literature review and expert input.`,\n              fr: htl.html`Les options d'adaptation et d'atténuation ont été compilées grâce à une revue de la littérature et à la contribution d'experts.`\n            }\n          },\n          methods: {\n            title: {\n              en: htl.html`Methods`,\n              fr: htl.html`Méthodologie`\n            }\n          },\n          prioritizationAnalysis: {\n            title: {\n              en: htl.html`Prioritization analysis`,\n              fr: htl.html`Analyse de priorisation`\n            },\n            body: {\n              en: htl.html`All indicators were normalized by dividing the value of each indicator per country by the maximum value across all considered countries to rank countries and visualize adaptation and mitigation indicators. Each normalized exposure indicator was then weighted and summed, creating a unique adaptation index. Adaptation indicators were four: (i) TLUs exposed to climate hazards, (ii) rural population exposed to climate hazards, (iii) value of production exposed to climate hazards, and (iv) pasture area exposed to climate hazards. For the case of mitigation, each indicator corresponding to emissions was normalized by dividing by the maximum value across geographies. A total of six individual indicators were considered, namely, emissions from bovine, pigs, poultry, shoats, forest loss to pasture, and forest loss to soybean. In the prioritization analysis, a weight factor is considered that shifts the relative importance of adaptation and mitigation.`,\n              fr: htl.html`Tous les indicateurs ont été normalisés en divisant la valeur de chaque indicateur par pays par la valeur maximale pour tous les pays considérés afin de classer les pays et de visualiser les indicateurs d'adaptation et d'atténuation. Chaque indicateur d'exposition normalisé a ensuite été pondéré et additionné, créant ainsi un indice d'adaptation unique. Les indicateurs d'adaptation étaient au nombre de quatre : (i) les UGT exposées aux aléas climatiques, (ii) la population rurale exposée aux aléas climatiques, (iii) la valeur de la production exposée aux aléas climatiques et (iv) la superficie des pâturages exposée aux aléas climatiques. Dans le cas de l’atténuation, chaque indicateur correspondant aux émissions a été normalisé en divisant par la valeur maximale selon les zones géographiques. Au total, six indicateurs individuels ont été pris en compte, à savoir les émissions provenant des bovins, des porcs, de la volaille, des chevreuils, la perte de forêt au profit des pâturages et la perte de forêt au profit du soja. Dans l’analyse de priorisation, un facteur de pondération est pris en compte, qui modifie l’importance relative de l’adaptation et de l’atténuation.`\n            }\n          },\n          references: {\n            title: {\n              en: htl.html`References`,\n              fr: htl.html`Les références`\n            },\n            body: {\n              en: htl.html`\n&lt;ul&gt;\n  &lt;li&gt;Bonilla-Cedrez, C., Steward, P., Rosenstock, T.S., Thornton, P.K., Arango, J., Kropff, M., and Ramirez-Villegas, J. 2023. Priority areas for investment in more sustainable and climate-resilient livestock systems. Nature Sustainability, 6, 1279–1286. &lt;a href=\"https://doi.org/10.1038/s41893-023-01161-1\"&gt;https://doi.org/10.1038/s41893-023-01161-1&lt;/a&gt;&lt;/li&gt;\n  &lt;li&gt;Goldman, E., Weisse, M. J., Harris, N. & Schneider, M. (2020) Estimating the Role of Seven Commodities in Agriculture-Linked Deforestation: Oil Palm, Soy, Cattle, Wood Fiber, Cocoa, Coffee, and Rubber. World Resources Institute.&lt;/li&gt;\n  &lt;li&gt;Hansen, M. C. et al. (2013) High-resolution global maps of 21st-century forest cover change. Science 342, 850–853. &lt;a href=\"https://doi.org/10.1126/science.1244693\"&gt;https://doi.org/10.1126/science.1244693&lt;/a&gt;&lt;/li&gt;\n  &lt;li&gt;Herrero, M. et al. (2013) Biomass use, production, feed efficiencies, and greenhouse gas emissions from global livestock systems. Proc. Natl Acad. Sci. USA 110, 20888–20893. &lt;a href=\"https://doi.org/10.1073/pnas.1308149110\"&gt;https://doi.org/10.1073/pnas.1308149110&lt;/a&gt;&lt;/li&gt;\n  &lt;li&gt;Robinson TP, Thornton PK, Franceschini G, Kruska RL, Chiozza F, et al. (2011) Global livestock production systems. Rome: Food and Agriculture Organization of the United Nations (FAO) and International Livestock Research Institute (ILRI). pp. 152.&lt;/li&gt;\n  &lt;li&gt;Soto-Navarro, C. et al. (2020) Mapping co-benefits for carbon storage and biodiversity to inform conservation policy and action. Phil. Trans. R. Soc. B Biol. Sci. 375, 20190128. &lt;a href=\"https://doi.org/10.1098/rstb.2019.0128\"&gt;https://doi.org/10.1098/rstb.2019.0128&lt;/a&gt;&lt;/li&gt;\n  &lt;li&gt;Thornton, P., Nelson, G., Mayberry, D. & Herrero, M. (2021) Increases in extreme heat stress in domesticated livestock species during the twenty‐first century. Glob. Change Biol. 27, 5762–5772. &lt;a href=\"https://doi.org/10.1111/gcb.15825\"&gt;https://doi.org/10.1111/gcb.15825&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;`,\n              fr: htl.html`\n&lt;ul&gt;\n  &lt;li&gt;Bonilla-Cedrez, C., Steward, P., Rosenstock, T.S., Thornton, P.K., Arango, J., Kropff, M., and Ramirez-Villegas, J. 2023. Priority areas for investment in more sustainable and climate-resilient livestock systems. Nature Sustainability, 6, 1279–1286. &lt;a href=\"https://doi.org/10.1038/s41893-023-01161-1\"&gt;https://doi.org/10.1038/s41893-023-01161-1&lt;/a&gt;&lt;/li&gt;\n  &lt;li&gt;Goldman, E., Weisse, M. J., Harris, N. & Schneider, M. (2020) Estimating the Role of Seven Commodities in Agriculture-Linked Deforestation: Oil Palm, Soy, Cattle, Wood Fiber, Cocoa, Coffee, and Rubber. World Resources Institute.&lt;/li&gt;\n  &lt;li&gt;Hansen, M. C. et al. (2013) High-resolution global maps of 21st-century forest cover change. Science 342, 850–853. &lt;a href=\"https://doi.org/10.1126/science.1244693\"&gt;https://doi.org/10.1126/science.1244693&lt;/a&gt;&lt;/li&gt;\n  &lt;li&gt;Herrero, M. et al. (2013) Biomass use, production, feed efficiencies, and greenhouse gas emissions from global livestock systems. Proc. Natl Acad. Sci. USA 110, 20888–20893. &lt;a href=\"https://doi.org/10.1073/pnas.1308149110\"&gt;https://doi.org/10.1073/pnas.1308149110&lt;/a&gt;&lt;/li&gt;\n  &lt;li&gt;Robinson TP, Thornton PK, Franceschini G, Kruska RL, Chiozza F, et al. (2011) Global livestock production systems. Rome: Food and Agriculture Organization of the United Nations (FAO) and International Livestock Research Institute (ILRI). pp. 152.&lt;/li&gt;\n  &lt;li&gt;Soto-Navarro, C. et al. (2020) Mapping co-benefits for carbon storage and biodiversity to inform conservation policy and action. Phil. Trans. R. Soc. B Biol. Sci. 375, 20190128. &lt;a href=\"https://doi.org/10.1098/rstb.2019.0128\"&gt;https://doi.org/10.1098/rstb.2019.0128&lt;/a&gt;&lt;/li&gt;\n  &lt;li&gt;Thornton, P., Nelson, G., Mayberry, D. & Herrero, M. (2021) Increases in extreme heat stress in domesticated livestock species during the twenty‐first century. Glob. Change Biol. 27, 5762–5772. &lt;a href=\"https://doi.org/10.1111/gcb.15825\"&gt;https://doi.org/10.1111/gcb.15825&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;`\n            }\n          }\n        }\n      }\n    },\n    general : {\n      \"admin0_ISO3\": {\n        \"AGO\": {\n          \"en\": \"Angola\",\n          \"fr\": \"Angola\"\n        },\n        \"BEN\": {\n          \"en\": \"Benin\",\n          \"fr\": \"Bénin\"\n        },\n        \"BWA\": {\n          \"en\": \"Botswana\",\n          \"fr\": \"Botswana\"\n        },\n        \"BFA\": {\n          \"en\": \"Burkina Faso\",\n          \"fr\": \"Burkina Faso\"\n        },\n        \"BDI\": {\n          \"en\": \"Burundi\",\n          \"fr\": \"Burundi\"\n        },\n        \"CMR\": {\n          \"en\": \"Cameroon\",\n          \"fr\": \"Cameroun\"\n        },\n        \"CAF\": {\n          \"en\": \"Central African Republic\",\n          \"fr\": \"République Centrafricaine\"\n        },\n        \"TCD\": {\n          \"en\": \"Chad\",\n          \"fr\": \"Tchad\"\n        },\n        \"COG\": {\n          \"en\": \"Congo - Brazzaville\",\n          \"fr\": \"Congo - Brazzaville\"\n        },\n        \"COD\": {\n          \"en\": \"Congo - Kinshasa\",\n          \"fr\": \"Congo - Kinshasa\"\n        },\n        \"CIV\": {\n          \"en\": \"Côte d’Ivoire\",\n          \"fr\": \"Côte d’Ivoire\"\n        },\n        \"DJI\": {\n          \"en\": \"Djibouti\",\n          \"fr\": \"Djibouti\"\n        },\n        \"GNQ\": {\n          \"en\": \"Equatorial Guinea\",\n          \"fr\": \"Guinée Équatoriale\"\n        },\n        \"ERI\": {\n          \"en\": \"Eritrea\",\n          \"fr\": \"Érythrée\"\n        },\n        \"SWZ\": {\n          \"en\": \"Eswatini\",\n          \"fr\": \"Eswatini\"\n        },\n        \"ETH\": {\n          \"en\": \"Ethiopia\",\n          \"fr\": \"Éthiopie\"\n        },\n        \"GAB\": {\n          \"en\": \"Gabon\",\n          \"fr\": \"Gabon\"\n        },\n        \"GMB\": {\n          \"en\": \"Gambia\",\n          \"fr\": \"Gambie\"\n        },\n        \"GHA\": {\n          \"en\": \"Ghana\",\n          \"fr\": \"Ghana\"\n        },\n        \"GIN\": {\n          \"en\": \"Guinea\",\n          \"fr\": \"Guinée\"\n        },\n        \"GNB\": {\n          \"en\": \"Guinea-Bissau\",\n          \"fr\": \"Guinée-Bissau\"\n        },\n        \"KEN\": {\n          \"en\": \"Kenya\",\n          \"fr\": \"Kenya\"\n        },\n        \"LSO\": {\n          \"en\": \"Lesotho\",\n          \"fr\": \"Lesotho\"\n        },\n        \"LBR\": {\n          \"en\": \"Liberia\",\n          \"fr\": \"Libéria\"\n        },\n        \"MDG\": {\n          \"en\": \"Madagascar\",\n          \"fr\": \"Madagascar\"\n        },\n        \"MWI\": {\n          \"en\": \"Malawi\",\n          \"fr\": \"Malawi\"\n        },\n        \"MLI\": {\n          \"en\": \"Mali\",\n          \"fr\": \"Mali\"\n        },\n        \"MRT\": {\n          \"en\": \"Mauritania\",\n          \"fr\": \"Mauritanie\"\n        },\n        \"MOZ\": {\n          \"en\": \"Mozambique\",\n          \"fr\": \"Mozambique\"\n        },\n        \"NAM\": {\n          \"en\": \"Namibia\",\n          \"fr\": \"Namibie\"\n        },\n        \"NER\": {\n          \"en\": \"Niger\",\n          \"fr\": \"Niger\"\n        },\n        \"NGA\": {\n          \"en\": \"Nigeria\",\n          \"fr\": \"Nigéria\"\n        },\n        \"RWA\": {\n          \"en\": \"Rwanda\",\n          \"fr\": \"Rwanda\"\n        },\n        \"SEN\": {\n          \"en\": \"Senegal\",\n          \"fr\": \"Sénégal\"\n        },\n        \"SLE\": {\n          \"en\": \"Sierra Leone\",\n          \"fr\": \"Sierra Leone\"\n        },\n        \"SOM\": {\n          \"en\": \"Somalia\",\n          \"fr\": \"Somalie\"\n        },\n        \"ZAF\": {\n          \"en\": \"South Africa\",\n          \"fr\": \"Afrique du Sud\"\n        },\n        \"SSD\": {\n          \"en\": \"South Sudan\",\n          \"fr\": \"Soudan du Sud\"\n        },\n        \"SDN\": {\n          \"en\": \"Sudan\",\n          \"fr\": \"Soudan\"\n        },\n        \"TZA\": {\n          \"en\": \"Tanzania\",\n          \"fr\": \"Tanzanie\"\n        },\n        \"TGO\": {\n          \"en\": \"Togo\",\n          \"fr\": \"Togo\"\n        },\n        \"UGA\": {\n          \"en\": \"Uganda\",\n          \"fr\": \"Ouganda\"\n        },\n        \"ZMB\": {\n          \"en\": \"Zambia\",\n          \"fr\": \"Zambie\"\n        },\n        \"ZWE\": {\n          \"en\": \"Zimbabwe\",\n          \"fr\": \"Zimbabwe\"\n        },\n        \"TOTAL\" : {\n          \"en\": \"Total\",\n          \"fr\": \"Total\"\n        },\n      },\n      country_article1: {\n          \"AGO\": {\"en\": \"Angola\", \"fr\": \"L’Angola\"},\n          \"BEN\": {\"en\": \"Benin\", \"fr\": \"Le Bénin\"},\n          \"BWA\": {\"en\": \"Botswana\", \"fr\": \"Le Botswana\"},\n          \"BFA\": {\"en\": \"Burkina Faso\", \"fr\": \"Le Burkina Faso\"},\n          \"BDI\": {\"en\": \"Burundi\", \"fr\": \"Le Burundi\"},\n          \"CMR\": {\"en\": \"Cameroon\", \"fr\": \"Le Cameroun\"},\n          \"CAF\": {\"en\": \"Central African Republic\", \"fr\": \"La République Centrafricaine\"},\n          \"TCD\": {\"en\": \"Chad\", \"fr\": \"Le Tchad\"},\n          \"COG\": {\"en\": \"Congo - Brazzaville\", \"fr\": \"Le Congo - Brazzaville\"},\n          \"COD\": {\"en\": \"Congo - Kinshasa\", \"fr\": \"Le Congo - Kinshasa\"},\n          \"CIV\": {\"en\": \"Côte d'Ivoire\", \"fr\": \"La Côte d'Ivoire\"},\n          \"DJI\": {\"en\": \"Djibouti\", \"fr\": \"Djibouti\"},\n          \"GNQ\": {\"en\": \"Equatorial Guinea\", \"fr\": \"La Guinée Équatoriale\"},\n          \"ERI\": {\"en\": \"Eritrea\", \"fr\": \"L’Érythrée\"},\n          \"SWZ\": {\"en\": \"Eswatini\", \"fr\": \"L’Eswatini\"},\n          \"ETH\": {\"en\": \"Ethiopia\", \"fr\": \"L’Éthiopie\"},\n          \"GAB\": {\"en\": \"Gabon\", \"fr\": \"Le Gabon\"},\n          \"GMB\": {\"en\": \"Gambia\", \"fr\": \"La Gambie\"},\n          \"GHA\": {\"en\": \"Ghana\", \"fr\": \"Le Ghana\"},\n          \"GIN\": {\"en\": \"Guinea\", \"fr\": \"La Guinée\"},\n          \"GNB\": {\"en\": \"Guinea-Bissau\", \"fr\": \"La Guinée-Bissau\"},\n          \"KEN\": {\"en\": \"Kenya\", \"fr\": \"Le Kenya\"},\n          \"LSO\": {\"en\": \"Lesotho\", \"fr\": \"Le Lesotho\"},\n          \"LBR\": {\"en\": \"Liberia\", \"fr\": \"Le Libéria\"},\n          \"MDG\": {\"en\": \"Madagascar\", \"fr\": \"Madagascar\"},\n          \"MWI\": {\"en\": \"Malawi\", \"fr\": \"Le Malawi\"},\n          \"MLI\": {\"en\": \"Mali\", \"fr\": \"Le Mali\"},\n          \"MRT\": {\"en\": \"Mauritania\", \"fr\": \"La Mauritanie\"},\n          \"MOZ\": {\"en\": \"Mozambique\", \"fr\": \"Le Mozambique\"},\n          \"NAM\": {\"en\": \"Namibia\", \"fr\": \"La Namibie\"},\n          \"NER\": {\"en\": \"Niger\", \"fr\": \"Le Niger\"},\n          \"NGA\": {\"en\": \"Nigeria\", \"fr\": \"Le Nigéria\"},\n          \"RWA\": {\"en\": \"Rwanda\", \"fr\": \"Le Rwanda\"},\n          \"SEN\": {\"en\": \"Senegal\", \"fr\": \"Le Sénégal\"},\n          \"SLE\": {\"en\": \"Sierra Leone\", \"fr\": \"Sierra Leone\"},\n          \"SOM\": {\"en\": \"Somalia\", \"fr\": \"La Somalie\"},\n          \"ZAF\": {\"en\": \"South Africa\", \"fr\": \"L’Afrique du Sud\"},\n          \"SSD\": {\"en\": \"South Sudan\", \"fr\": \"Le Soudan du Sud\"},\n          \"SDN\": {\"en\": \"Sudan\", \"fr\": \"Le Soudan\"},\n          \"TZA\": {\"en\": \"Tanzania\", \"fr\": \"La Tanzanie\"},\n          \"TGO\": {\"en\": \"Togo\", \"fr\": \"Le Togo\"},\n          \"UGA\": {\"en\": \"Uganda\", \"fr\": \"L’Ouganda\"},\n          \"ZMB\": {\"en\": \"Zambia\", \"fr\": \"La Zambie\"},\n          \"ZWE\": {\"en\": \"Zimbabwe\", \"fr\": \"Le Zimbabwe\"}\n      },    \n      country_article2: {\n          \"AGO\": {\"en\": \"Angola\", \"fr\": \"En Angola\"},\n          \"BEN\": {\"en\": \"Benin\", \"fr\": \"Au Bénin\"},\n          \"BWA\": {\"en\": \"Botswana\", \"fr\": \"Au Botswana\"},\n          \"BFA\": {\"en\": \"Burkina Faso\", \"fr\": \"Au Burkina Faso\"},\n          \"BDI\": {\"en\": \"Burundi\", \"fr\": \"Au Burundi\"},\n          \"CMR\": {\"en\": \"Cameroon\", \"fr\": \"Au Cameroun\"},\n          \"CAF\": {\"en\": \"Central African Republic\", \"fr\": \"En République Centrafricaine\"},\n          \"TCD\": {\"en\": \"Chad\", \"fr\": \"Au Tchad\"},\n          \"COG\": {\"en\": \"Congo - Brazzaville\", \"fr\": \"Au Congo - Brazzaville\"},\n          \"COD\": {\"en\": \"Congo - Kinshasa\", \"fr\": \"Au Congo - Kinshasa\"},\n          \"CIV\": {\"en\": \"Côte d'Ivoire\", \"fr\": \"En Côte d'Ivoire\"},\n          \"DJI\": {\"en\": \"Djibouti\", \"fr\": \"A Djibouti\"},\n          \"GNQ\": {\"en\": \"Equatorial Guinea\", \"fr\": \"En Guinée Équatoriale\"},\n          \"ERI\": {\"en\": \"Eritrea\", \"fr\": \"En Érythrée\"},\n          \"SWZ\": {\"en\": \"Eswatini\", \"fr\": \"En Eswatini\"},\n          \"ETH\": {\"en\": \"Ethiopia\", \"fr\": \"En Éthiopie\"},\n          \"GAB\": {\"en\": \"Gabon\", \"fr\": \"Au Gabon\"},\n          \"GMB\": {\"en\": \"Gambia\", \"fr\": \"En Gambie\"},\n          \"GHA\": {\"en\": \"Ghana\", \"fr\": \"Au Ghana\"},\n          \"GIN\": {\"en\": \"Guinea\", \"fr\": \"En Guinée\"},\n          \"GNB\": {\"en\": \"Guinea-Bissau\", \"fr\": \"En Guinée-Bissau\"},\n          \"KEN\": {\"en\": \"Kenya\", \"fr\": \"Au Kenya\"},\n          \"LSO\": {\"en\": \"Lesotho\", \"fr\": \"Au Lesotho\"},\n          \"LBR\": {\"en\": \"Liberia\", \"fr\": \"Au Libéria\"},\n          \"MDG\": {\"en\": \"Madagascar\", \"fr\": \"À Madagascar\"},\n          \"MWI\": {\"en\": \"Malawi\", \"fr\": \"Au Malawi\"},\n          \"MLI\": {\"en\": \"Mali\", \"fr\": \"Au Mali\"},\n          \"MRT\": {\"en\": \"Mauritania\", \"fr\": \"En Mauritanie\"},\n          \"MOZ\": {\"en\": \"Mozambique\", \"fr\": \"Au Mozambique\"},\n          \"NAM\": {\"en\": \"Namibia\", \"fr\": \"En Namibie\"},\n          \"NER\": {\"en\": \"Niger\", \"fr\": \"Au Niger\"},\n          \"NGA\": {\"en\": \"Nigeria\", \"fr\": \"Au Nigéria\"},\n          \"RWA\": {\"en\": \"Rwanda\", \"fr\": \"Au Rwanda\"},\n          \"SEN\": {\"en\": \"Senegal\", \"fr\": \"Au Sénégal\"},\n          \"SLE\": {\"en\": \"Sierra Leone\", \"fr\": \"À Sierra Leone\"},\n          \"SOM\": {\"en\": \"Somalia\", \"fr\": \"En Somalie\"},\n          \"ZAF\": {\"en\": \"South Africa\", \"fr\": \"En Afrique du Sud\"},\n          \"SSD\": {\"en\": \"South Sudan\", \"fr\": \"Au Soudan du Sud\"},\n          \"SDN\": {\"en\": \"Sudan\", \"fr\": \"Au Soudan\"},\n          \"TZA\": {\"en\": \"Tanzania\", \"fr\": \"En Tanzanie\"},\n          \"TGO\": {\"en\": \"Togo\", \"fr\": \"Au Togo\"},\n          \"UGA\": {\"en\": \"Uganda\", \"fr\": \"En Ouganda\"},\n          \"ZMB\": {\"en\": \"Zambia\", \"fr\": \"En Zambie\"},\n          \"ZWE\": {\"en\": \"Zimbabwe\", \"fr\": \"Au Zimbabwe\"}\n      },\n      lps :{\n          \"Mixed irrigated\": {en: \"Mixed Irrigated\", fr: \"Mixte Irrigué\"},\n          \"Mixed rainfed\": {en: \"Mixed Rainfed\", fr: \"Mixte Pluvial\"},\n          \"Rangelands\": {en: \"Rangelands\", fr: \"Pâturages\"},\n          \"Other\": {en: \"Other\", fr: \"Autre\"},\n          MIA: {en: \"Mixed irrigated arid\",  fr: \"Mixte irrigué aride\"},\n          MIH: {en: \"Mixed irrigated humid\",  fr: \"Mixte irrigué humide\"},\n          MIT: {en: \"Mixed irrigated temperate\", fr: \"Mixte irrigué tempéré\"},\n          MIY: {en: \"Mixed irrigated hyperarid\", fr: \"Mixte irrigué hyperaride\"},\n          MRA: {en: \"Mixed rainfed arid\", fr: \"Mixte pluvial aride\"},\n          MRH: {en: \"Mixed rainfed humid\", fr: \"Mixte pluvial humide\"},\n          MRT: {en: \"Mixed rainfed temperate\", fr: \"Mixte pluvial tempéré\"},\n          MRY: {en: \"Mixed rainfed hyperarid\", fr: \"Mixte pluvial hyperaride\"},\n          LGA: {en: \"Rangelands arid\", fr: \"Pâturages arides\"},\n          LGH: {en: \"Rangelands humid\", fr: \"Pâturages humides\"},\n          LGT: {en: \"Rangelands temperate\", fr: \"Pâturages tempérés\"},\n          LGY: {en: \"Rangelands hyperarid\", fr: \"Pâturages hyperarides\"}\n      }\n    }\n  }\n}\n\n\n\n\n\n\n\ntd = {\n  // translation data\n  return {\n    leversChangeMap: {\n      // uses data values from map data (hazards/emissions)\n      \"Tropical livestock units\": _lang(\n        nbText.sections.leversOfChange.chart.map.tooltip.data.hazards.tlu.name\n      ),\n      \"Pasture area\": _lang(\n        nbText.sections.leversOfChange.chart.map.tooltip.data.hazards.pastureArea.name\n      ),\n      \"Rural population\": _lang(\n        nbText.sections.leversOfChange.chart.map.tooltip.data.hazards.popRural.name\n      ),\n      \"Value of production\": _lang(\n        nbText.sections.leversOfChange.chart.map.tooltip.data.hazards.vop.name\n      ),\n      \"bovine\": _lang(\n        nbText.sections.leversOfChange.chart.map.tooltip.data.emissions.values.bovine\n      ),\n      \"pig\": _lang(\n        nbText.sections.leversOfChange.chart.map.tooltip.data.emissions.values.pig\n      ),\n      \"poultry\": _lang(\n        nbText.sections.leversOfChange.chart.map.tooltip.data.emissions.values.poultry\n      ),\n      \"shoat\": _lang(\n        nbText.sections.leversOfChange.chart.map.tooltip.data.emissions.values.shoat\n      ),\n      \"forest loss to pasture\": _lang(\n        nbText.sections.leversOfChange.chart.map.tooltip.data.emissions.values.flPasture\n      ),\n      \"forest loss to soy\": _lang(\n        nbText.sections.leversOfChange.chart.map.tooltip.data.emissions.values.flSoy\n      ),\n    }\n  };\n}"
  },
  {
    "objectID": "notebooks/solutions/notebook.html",
    "href": "notebooks/solutions/notebook.html",
    "title": "",
    "section": "",
    "text": "import { heroImage } from \"/helpers/hero.js\";\nhero_url = \"./../../images/solution.webp\";\n\nhero = heroImage(nbTitle, hero_url);\nhtml`${hero}`;\nimport { atlasTOC } from '/helpers/toc.ojs' \n{\n  await nbText // force wait/reload with nbText to load so headings have correct labels/languages\n  return atlasTOC({\n      heading: `&lt;b&gt;${_lang({en:\"In this notebook\", fr:\"Dans ce notebook\"})}&lt;/b&gt;`,\n      skip: [nbTitle, \"Appendix\", \"source-code\"]\n      })\n}\nviewof prettyLanguageView = {\n  return Inputs.bind(\n    Inputs.radio(languages, {\n      label: _lang({en: \"Language\", fr: \"Langue\"}),\n      format: (d) =&gt; d.label\n    }),\n    viewof language\n  );\n}"
  },
  {
    "objectID": "notebooks/solutions/notebook.html#cropDiff",
    "href": "notebooks/solutions/notebook.html#cropDiff",
    "title": "",
    "section": "",
    "text": "viewof selectCropMeanDiff_new = {\n  const data = [...new Set(data_meanDiff_practiceCrop_new.map((d) =&gt; d.Crop))]\n    .map((d) =&gt; {\n      return { field: d, translation: td.Crop.values?.[d] };\n    })\n    .sort((a, b) =&gt; _lang(a.translation) &gt; _lang(b.translation));\n  return Inputs.select(data, {\n    label: _lang(td.Crop),\n    value: data.find(x =&gt; x.field == 'Maize'),\n    format: (x) =&gt; _lang(x.translation)\n  });\n}\n\nviewof radioSortDotPlotCrop_new = {\n  const data = [\n    {\n      key: \"mean\",\n      label: _lang(nbText.inputs.radioSort.fields.mean),\n      channel: \"x\",\n      reverse: true,\n    },\n    {\n      key: \"observations\",\n      label: _lang(nbText.inputs.radioSort.fields.observations),\n      channel: \"nObs\",\n      reverse: true,\n    },\n    {\n      key: \"alpha\",\n      label: _lang(nbText.inputs.radioSort.fields.alpha),\n      channel: \"y\",\n      reverse: false,\n    },\n  ]\n  return Inputs.radio(data, { label: _lang(nbText.supportNbText.labels.sort), format: d =&gt; d.label, value: data.find(x =&gt; x.key === 'mean') });\n}\n\nviewof toggleCIsCrop_new = {\n  const data = [\n    _lang(nbText.practicalImpact.inputs.toggleConfInt.fields.visible)\n  ]\n  return Inputs.checkbox(data, {\n    label: _lang(nbText.supportNbText.labels.confidenceIntervals)\n  });\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nView table code\n{\n  const plotData = data_meanDiff_practiceCrop_new.filter(\n    (d) =&gt; d.Crop === selectCropMeanDiff_new.field\n  );\n  const marginBottom = 0;\n  const marginTop = 60;\n  const yHeight = 25;\n  const height =\n    marginTop +\n    marginBottom +\n    d3.group(plotData, (d) =&gt; d.Practice).size * yHeight;\n  const _formatNum = formatNum;\n  const _toggleCIs = toggleCIsCrop_new;\n  const _radioSort = radioSortDotPlotCrop_new;\n  const langLookup = {\n    xLabel: _lang(nbText.practicalImpact.labels.xMeanDiff),\n    tooltip: {\n      aez: _lang(nbText.practicalImpact.tooltips.aez),\n      meanDiff: _lang(nbText.practicalImpact.tooltips.meanDiff),\n      meanControl: _lang(nbText.practicalImpact.tooltips.meanControl),\n      crop: Lang.toSentenceCase(_lang(nbText.supportNbText.words.crop.singular)),\n      ciLo: _lang(nbText.practicalImpact.tooltips.ciLower),\n      ciHi: _lang(nbText.practicalImpact.tooltips.ciUpper),\n      obs: Lang.toSentenceCase(_lang(nbText.supportNbText.words.observation.plural)),\n      practice: Lang.toSentenceCase(_lang(nbText.supportNbText.words.practice.singular))\n    }\n  }\n  const y = (d) =&gt; _lang(td.Practice.values?.[d]);\n\n  return Plot.plot({\n    height,\n    marginBottom,\n    marginTop,\n    marginLeft: 200,\n    marginRight: 70,\n    width,\n    x: {\n      axis: \"top\",\n      nice: true,\n      grid: true,\n      label: langLookup.xLabel,\n      labelAnchor: \"center\",\n      labelOffset: 40,\n      labelArrow: \"none\"\n    },\n    y: {\n      tickSize: 0,\n      label: null\n    },\n    color: {\n      range: colorYellowGreen\n    },\n    marks: [\n      // main y-axis\n      Plot.axisY({\n        tickSize: 0\n      }),\n      // pointer white-out\n      Plot.axisY(\n        Plot.pointerY({\n          fill: \"white\",\n          textStroke: \"white\",\n          textStrokeWidth: 2,\n          tickSize: 0\n        })\n      ),\n      // bold pointer\n      Plot.axisY(\n        Plot.pointerY({\n          fontWeight: \"bold\",\n          tickSize: 0\n        })\n      ),\n      // zero point\n      Plot.ruleX([0], { stroke: \"#333\", strokeDasharray: [4] }),\n      // span lines: CI\n      Plot.ruleY(_toggleCIs.length &gt; 0 ? plotData : [], {\n        y: (d) =&gt; y(d.Practice),\n        x1: (d) =&gt; d.Lower,\n        x2: (d) =&gt; d.Upper,\n        stroke: \"#333\"\n      }),\n      // mean diff dots\n      Plot.dot(plotData, {\n        x: \"Mean_Difference\",\n        y: (d) =&gt; y(d.Practice),\n        sort: { y: _radioSort.channel, reverse: _radioSort.reverse },\n        fill: (d) =&gt; d.Mean_Difference,\n        r: 8,\n        stroke: \"#fff\",\n        strokeWidth: 0.7,\n        channels: {\n          nObs: {\n            value: \"N_Obs\"\n          },\n          prac: {\n            value: (d) =&gt; y(d.Practice),\n          },\n          crop: {\n            value: \"Crop\"\n          },\n          diff: {\n            label: langLookup.tooltip.meanDiff,\n            value: \"Mean_Difference\"\n          },\n          control: {\n            label: langLookup.tooltip.meanControl,\n            value: 'Mean_Control',\n          },\n          ciLow: {\n            label: langLookup.tooltip.ciLo,\n            value: \"Lower\"\n          },\n          ciHigh: {\n            label: langLookup.tooltip.ciHi,\n            value: \"Upper\"\n          }\n        },\n        tip: {\n          format: {\n            x: false,\n            y: false,\n            fill: false,\n            prac: false,\n            crop: false,\n            nObs: false,\n            diff: (d) =&gt; _formatNum(d),\n            control: (d) =&gt; _formatNum(d),\n            ciLow: (d) =&gt; _formatNum(d),\n            ciHigh: (d) =&gt; _formatNum(d)\n          }\n        }\n      }),\n      // dot highlight on hover\n      Plot.dot(plotData, Plot.pointer({\n        x: \"Mean_Difference\",\n        y: (d) =&gt; y(d.Practice),\n        r: 8,\n        stroke: \"#333\",\n        strokeWidth: 0.7,\n        channels: {\n          nObs: {\n            label: \"# Observations\",\n            value: \"N_Obs\"\n          },\n        }\n      })),\n      // observation counts\n      Plot.textY(plotData, {\n        y: (d) =&gt; y(d.Practice),\n        text: (d) =&gt; d.N_Obs + \" obs.\",\n        frameAnchor: \"right\",\n        textAnchor: \"start\",\n        dx: 16\n      }),\n      // counts white-out\n      Plot.textY(\n        plotData,\n        Plot.pointerY({\n          y: (d) =&gt; y(d.Practice),\n          text: (d) =&gt; d.N_Obs + \" obs.\",\n          fill: \"white\",\n          stroke: \"white\",\n          strokeWidth: 2,\n          frameAnchor: \"right\",\n          textAnchor: \"start\",\n          dx: 16\n        })\n      ),\n      // counts bold hover\n      Plot.textY(\n        plotData,\n        Plot.pointerY({\n          y: (d) =&gt; y(d.Practice),\n          text: (d) =&gt; d.N_Obs + \" obs.\",\n          fontWeight: \"bold\",\n          frameAnchor: \"right\",\n          textAnchor: \"start\",\n          dx: 16\n        })\n      )\n    ]\n  });\n}\n\n\n\n\n\n\n\n\n\n\n// insights\n{\n  const langRoot = nbText;\n  const langBasePath = langRoot.practicalImpact.meanCropDiff.insights; // base path for language\n\n  const data = data_meanDiff_practiceCrop_new;\n  const selection = selectCropMeanDiff_new.field;\n\n  const tl_crop = (crop) =&gt; _lang(td.Crop.values?.[crop]);\n  const tl_crop_article = (crop) =&gt; _lang(td.Crop_with_articles.values?.[crop]);\n  const tl_prac = (prac) =&gt; _lang(td.Practice.values?.[prac]);\n\n  // top 5 crops by unique practices\n  const top5CropsByPractices = T.tidy(\n    data,\n    T.count([\"Crop\"]),\n    T.arrange(T.desc(\"n\")),\n    T.sliceHead(5)\n  );\n  const top5CropsByPracticesString = top5CropsByPractices\n    .map((d, i) =&gt; {\n      if (i == top5CropsByPractices.length - 1) return `and **${tl_crop(d.Crop)}**`;\n      return `**${tl_crop(d.Crop)}**`;\n    })\n    .join(\", \");\n  const langTop5 = _lang(langBasePath.top5);\n  const langTop5Format = langTop5.replace(\n    Lang.getRegexForNamedInsertion(\"top5CropsByPracticesString\"),\n    top5CropsByPracticesString\n  );\n  const insightTop5 = md`${langTop5Format}`;\n\n  // crop selection\n  const selectedCrop = selection;\n  const dataCrop = T.tidy(\n    data,\n    T.filter((d) =&gt; d.Crop == selectedCrop)\n  );\n\n  // crop overview\n  const cropOverview = T.tidy(\n    dataCrop,\n    T.summarize({\n      totalObs: T.sum(\"N_Obs\"),\n      totalPractices: T.n()\n    })\n  )?.[0];\n  const langCropOverview = _lang(langBasePath.cropOverview);\n  const langCropOverviewItems = [\n    { insertName: \"selectedCrop\", value: Lang.toSentenceCase(tl_crop_article(selectedCrop)) },\n    { insertName: \"totalObs\", value: formatComma(cropOverview.totalObs) },\n    { insertName: \"totalPractices\", value: cropOverview.totalPractices }\n  ];\n  const insightCropOverview = langCropOverviewItems.reduce((overview, item) =&gt; {\n    return overview.replace(\n      Lang.getRegexForNamedInsertion(item.insertName),\n      item.value\n    );\n  }, langCropOverview);\n\n  // positive yield\n  const cropPositive = T.tidy(\n    dataCrop,\n    T.filter((d) =&gt; d.Mean_Difference &gt; 0)\n  )?.length;\n  const langCropPositive = _lang(langBasePath.cropPositive.main);\n  const langCropSubstring = `**${cropPositive}** ${\n    cropPositive == 1\n      ? _lang(langBasePath.cropPositive.singular)\n      : _lang(langBasePath.cropPositive.plural)\n  }`;\n  const insightCropPositive = langCropPositive.replace(\n    Lang.getRegexForNamedInsertion(\"cropPositiveText\"),\n    langCropSubstring\n  );\n\n  // top for selected crop\n  const n = 2; // # top crops to include\n  const topCrop = T.tidy(\n    dataCrop,\n    T.sliceMax(n, \"Mean_Difference\"),\n    T.arrange(T.desc(\"Mean_Difference\"))\n  );\n  const diff1 = topCrop?.[0];\n  const diff2 = topCrop?.[1];\n\n  const langDiffFirst = _lang(langBasePath.diffFirst.main);\n  const langDiffFirst_incDec =\n    diff1.Mean_Difference &gt;= 0\n      ? _lang(nbText.supportNbText.words.increase)\n      : _lang(nbText.supportNbText.words.decrease);\n  const langDiffFirst_observations = diff1.N_Obs;\n  const langDiffFirstItems = [\n    { insertName: \"practice\", value: tl_prac(diff1.Practice) },\n    {\n      insertName: \"incDec\",\n      value:\n        diff1.Mean_Difference &gt;= 0\n          ? _lang(nbText.supportNbText.words.increase)\n          : _lang(nbText.supportNbText.words.decrease)\n    },\n    { insertName: \"meanDiff\", value: formatNum(diff1.Mean_Difference) },\n    { insertName: \"observationCount\", value: formatComma(diff1.N_Obs) },\n    {\n      insertName: \"observationString\",\n      value:\n        diff1.N_Obs &gt; 1\n          ? _lang(nbText.supportNbText.words.observation.plural)\n          : _lang(nbText.supportNbText.words.observation.singular)\n    }\n  ];\n  const insightDiffFirst = langDiffFirstItems.reduce((overview, item) =&gt; {\n    return overview.replace(\n      Lang.getRegexForNamedInsertion(item.insertName),\n      item.value\n    );\n  }, langDiffFirst);\n\n  const langDiffSecond = _lang(langBasePath.diffSecond.main);\n  const langDiffSecond_incDec =\n    diff2?.Mean_Difference &gt;= 0\n      ? _lang(nbText.supportNbText.words.increase)\n      : _lang(nbText.supportNbText.words.decrease);\n  const langDiffSecond_observations = diff2?.N_Obs;\n  const langDiffSecondItems = [\n    { insertName: \"practice\", value: tl_prac(diff2?.Practice) },\n    {\n      insertName: \"incDec\",\n      value:\n        diff2?.Mean_Difference &gt;= 0\n          ? _lang(nbText.supportNbText.words.increase)\n          : _lang(nbText.supportNbText.words.decrease)\n    },\n    { insertName: \"meanDiff\", value: formatNum(diff2?.Mean_Difference) },\n    { insertName: \"observationCount\", value: formatComma(diff2?.N_Obs) },\n    {\n      insertName: \"observationString\",\n      value:\n        diff2?.N_Obs &gt; 1\n          ? _lang(nbText.supportNbText.words.observation.plural)\n          : _lang(nbText.supportNbText.words.observation.singular)\n    }\n  ];\n  const insightDiffSecond = diff2\n    ? langDiffSecondItems.reduce((overview, item) =&gt; {\n        return overview.replace(\n          Lang.getRegexForNamedInsertion(item.insertName),\n          item.value\n        );\n      }, langDiffSecond)\n    : \"\";\n\n  return md`${insightTop5}\n\n${insightCropOverview} ${insightCropPositive}\n\n${insightDiffFirst} ${insightDiffSecond}`;\n}"
  },
  {
    "objectID": "notebooks/solutions/notebook.html#cropDiffAEZ",
    "href": "notebooks/solutions/notebook.html#cropDiffAEZ",
    "title": "",
    "section": "",
    "text": "viewof selectCropMeanDiffAEZ = {\n  const data = [\n    ...new Set(data_meanDiff_aezPracticeCrop_new.map((d) =&gt; d.Crop))\n  ]\n    .map((d) =&gt; {\n      return { field: d, translation: td.Crop.values?.[d] };\n    })\n    .sort((a, b) =&gt; _lang(a.translation) &gt; _lang(b.translation));\n  return Inputs.select(data, {\n    label: _lang(td.Crop),\n    value: data.find((x) =&gt; x.field == \"Maize\"),\n    format: (x) =&gt; _lang(x.translation)\n  });\n}\n\nviewof radioSortDotPlotCropAEZ_new = {\n  const data = [\n    {\n      key: \"mean\",\n      label: _lang(nbText.inputs.radioSort.fields.mean),\n      channel: \"x\",\n      reverse: true\n    },\n    {\n      key: \"observations\",\n      label: _lang(nbText.inputs.radioSort.fields.observations),\n      channel: \"nObs\",\n      reverse: true\n    },\n    {\n      key: \"alpha\",\n      label: _lang(nbText.inputs.radioSort.fields.alpha),\n      channel: \"y\",\n      reverse: false\n    }\n  ];\n  return Inputs.radio(data, {\n    label: _lang(nbText.supportNbText.labels.sort),\n    format: (d) =&gt; d.label,\n    value: data.find((x) =&gt; x.key === \"mean\")\n  });\n}\n\nviewof aezSelect_new = {\n  const data = data_meanDiff_aezPracticeCrop_new.filter(\n    (d) =&gt; d.Crop === selectCropMeanDiffAEZ.field\n  );\n  const aezNames = d3\n    .groups(data, (d) =&gt; d.AEZ_Class_FAO)\n    .map((d) =&gt; d[0])\n    .sort();\n  const options = aezNames.map((d) =&gt; ({\n    field: d,\n    translation: td.AEZ_Class_FAO.values?.[d]\n  }));\n  const nullValue = {\n    field: null,\n    translation: nbText.inputs.defaults.aez\n  };\n  const inputNames = [nullValue, ...options];\n  return Inputs.select(inputNames, {\n    label: _lang(nbText.supportNbText.labels.highlightAez),\n    value: aezNames,\n    format: x =&gt; _lang(x.translation)\n  });\n}\n\nviewof toggleCIsCropAEZ_new = {\n  const data = [\n    _lang(nbText.practicalImpact.inputs.toggleConfInt.fields.visible)\n  ];\n  return Inputs.checkbox(data, {\n    label: _lang(nbText.supportNbText.labels.confidenceIntervals)\n  });\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nView table code\nplotDotAEZ_new = {\n  const baseData = data_meanDiff_aezPracticeCrop_new;\n  const plotData = baseData.filter(\n    (d) =&gt; d.Crop === selectCropMeanDiffAEZ.field\n  );\n  const aezData = T.tidy(\n    plotData,\n    T.filter((d) =&gt; {\n      if (aezSelect_new.field == null) return d;\n      return d.AEZ_Class_FAO == aezSelect_new.field;\n    }),\n    T.arrange(\"Mean_Difference\")\n  );\n  const colorDomain = aezColor_new.domain;\n  const colorRange = aezColor_new.range;\n  const marginBottom = 0;\n  const marginTop = 80;\n  const yHeight = 25;\n  const height =\n    marginTop +\n    marginBottom +\n    d3.group(plotData, (d) =&gt; d.Practice).size * yHeight;\n  const _formatNum = formatNum;\n  const _toggleCIs = toggleCIsCropAEZ_new;\n  const _radioSort = radioSortDotPlotCropAEZ_new;\n  const langLookup = {\n    xLabel: _lang(nbText.practicalImpact.labels.xMeanDiff),\n    tooltip: {\n      aez: _lang(nbText.practicalImpact.tooltips.aez),\n      meanDiff: _lang(nbText.practicalImpact.tooltips.meanDiff),\n      meanControl: _lang(nbText.practicalImpact.tooltips.meanControl),\n      crop: Lang.toSentenceCase(\n        _lang(nbText.supportNbText.words.crop.singular)\n      ),\n      ciLo: _lang(nbText.practicalImpact.tooltips.ciLower),\n      ciHi: _lang(nbText.practicalImpact.tooltips.ciUpper),\n      obs: Lang.toSentenceCase(\n        _lang(nbText.supportNbText.words.observation.plural)\n      ),\n      practice: Lang.toSentenceCase(\n        _lang(nbText.supportNbText.words.practice.singular)\n      )\n    }\n  };\n  const y = (d) =&gt; _lang(td.Practice.values?.[d]);\n  const color = (d) =&gt; _lang(td.AEZ_Class_FAO.values?.[d]);\n\n  return Plot.plot({\n    height,\n    marginBottom,\n    marginTop,\n    marginLeft: 200,\n    marginRight: 70,\n    width,\n    x: {\n      axis: \"top\",\n      nice: true,\n      grid: true,\n      label: langLookup.xLabel,\n      labelAnchor: \"center\",\n      labelOffset: 40,\n      labelArrow: \"none\"\n    },\n    y: {\n      tickSize: 0,\n      label: null\n    },\n    color: {\n      domain: colorDomain,\n      range: colorRange\n    },\n    marks: [\n      // main y-axis\n      Plot.axisY({\n        tickSize: 0\n      }),\n      // pointer white-out\n      Plot.axisY(\n        Plot.pointerY({\n          fill: \"white\",\n          textStroke: \"white\",\n          textStrokeWidth: 2,\n          tickSize: 0\n        })\n      ),\n      // bold pointer\n      Plot.axisY(\n        Plot.pointerY({\n          fontWeight: \"bold\",\n          tickSize: 0\n        })\n      ),\n      // zero point\n      Plot.ruleX([0], { stroke: \"#333\", strokeDasharray: [4] }),\n      // base dots\n      Plot.dot(plotData, {\n        x: \"Mean_Difference\",\n        y: (d) =&gt; y(d.Practice),\n        sort: { y: _radioSort.channel, reverse: _radioSort.reverse },\n        r: 8,\n        stroke: \"#fff\",\n        strokeWidth: 0.7,\n        fill: \"#efefef\",\n        channels: {\n          nObs: {\n            label: \"# Observations\",\n            value: \"N_Obs\"\n          }\n        }\n      }),\n      // selection: span lines: CI\n      Plot.ruleY(_toggleCIs.length &gt; 0 ? aezData : [], {\n        y: (d) =&gt; y(d.Practice),\n        x1: (d) =&gt; (d.Lower == \"NA\" ? null : d.Lower),\n        x2: (d) =&gt; (d.Upper == \"NA\" ? null : d.Upper),\n        stroke: \"#333\"\n      }),\n      // selection: mean diff dots\n      Plot.dot(aezData, {\n        x: \"Mean_Difference\",\n        y: (d) =&gt; y(d.Practice),\n        fill: (d) =&gt; {\n          return color(d.AEZ_Class_FAO);\n        },\n        r: 8,\n        stroke: \"#fff\",\n        strokeWidth: 0.7,\n        channels: {\n          aez: {\n            label: langLookup.tooltip.aez,\n            value: (d) =&gt; color(d.AEZ_Class_FAO)\n          },\n          nObs: {\n            label: langLookup.tooltip.obs,\n            value: \"N_Obs\"\n          },\n          diff: {\n            label: langLookup.tooltip.meanDiff,\n            value: \"Mean_Difference\"\n          },\n          control: {\n            label: langLookup.tooltip.meanControl,\n            value: \"Mean_Control\"\n          },\n          prac: {\n            label: langLookup.tooltip.practice,\n            value: (d) =&gt; y(d.Practice)\n          },\n          crop: {\n            label: langLookup.tooltip.crop,\n            value: \"Crop\"\n          },\n          ciLow: {\n            label: langLookup.tooltip.ciLo,\n            value: \"Lower\"\n          },\n          ciHigh: {\n            label: langLookup.tooltip.ciHi,\n            value: \"Upper\"\n          }\n        },\n        tip: {\n          format: {\n            x: false,\n            y: false,\n            fill: false,\n            prac: false,\n            crop: false,\n            aez: true,\n            diff: (d) =&gt; _formatNum(d),\n            control: (d) =&gt; _formatNum(d),\n            ciLow: (d) =&gt; _formatNum(d),\n            ciHigh: (d) =&gt; _formatNum(d),\n            nObs: true\n          }\n        }\n      }),\n      // dot highlight on hover\n      Plot.dot(\n        aezData,\n        Plot.pointer({\n          x: \"Mean_Difference\",\n          y: (d) =&gt; y(d.Practice),\n          r: 8,\n          fill: (d) =&gt; {\n            return d.AEZ_Class_FAO;\n          },\n          stroke: \"#333\",\n          strokeWidth: 0.7,\n          channels: {\n            nObs: {\n              label: \"# Observations\",\n              value: \"N_Obs\"\n            }\n          }\n        })\n      ),\n      // observation counts\n      Plot.textY(\n        aezData,\n        Plot.map(\n          { text: (values) =&gt; values.map((d) =&gt; d + \" obs.\") },\n          Plot.groupY(\n            { text: \"sum\" },\n            {\n              y: (d) =&gt; y(d.Practice),\n              text: \"N_Obs\",\n              frameAnchor: \"right\",\n              textAnchor: \"start\",\n              dx: 16\n            }\n          )\n        )\n      ),\n      // digital white-out\n      Plot.textY(\n        aezData,\n        Plot.pointerY(\n          Plot.map(\n            { text: (values) =&gt; values.map((d) =&gt; d + \" obs.\") },\n            Plot.groupY(\n              { text: \"sum\" },\n              {\n                y: (d) =&gt; y(d.Practice),\n                text: \"N_Obs\",\n                frameAnchor: \"right\",\n                textAnchor: \"start\",\n                dx: 16,\n                fill: \"white\",\n                stroke: \"white\",\n                strokeWidth: 2\n              }\n            )\n          )\n        )\n      ),\n      // observation counts bold hover\n      Plot.textY(\n        aezData,\n        Plot.pointerY(\n          Plot.map(\n            { text: (values) =&gt; values.map((d) =&gt; d + \" obs.\") },\n            Plot.groupY(\n              { text: \"sum\" },\n              {\n                y: (d) =&gt; y(d.Practice),\n                text: \"N_Obs\",\n                frameAnchor: \"right\",\n                textAnchor: \"start\",\n                dx: 16,\n                fontWeight: \"bold\"\n              }\n            )\n          )\n        )\n      )\n    ]\n  });\n}\n\nplotDotAEZ_new.legend('color', {columns: 3})\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n{\n  const langRoot = nbText;\n  const langBasePath = langRoot.practicalImpact.meanCropDiffAEZ.insights; // base path for language\n\n  // top practice by aez\n  const selectedCrop = selectCropMeanDiffAEZ.field;\n\n  // crop selection\n  const dataCropNoAEZ = T.tidy(\n    data_meanDiff_aezPracticeCrop_new,\n    T.filter((d) =&gt; d.Crop === selectedCrop)\n  );\n\n  // find aez with the largest mean diff\n  const maxMeanDiff = T.tidy(\n    dataCropNoAEZ,\n    T.sliceMax(1, \"Mean_Difference\")\n  )?.[0];\n\n  // use aez with max value for no highlight\n  const selectedAEZ =\n    aezSelect_new.field == null ? maxMeanDiff.AEZ_Class_FAO : aezSelect_new.field;\n  const selectedAEZTranslated = _lang(td.AEZ_Class_FAO.values[selectedAEZ]);\n\n  const dataCrop = T.tidy(\n    dataCropNoAEZ,\n    T.filter((d) =&gt; d.AEZ_Class_FAO == selectedAEZ)\n  );\n\n  // selected aez square\n  const aezSwatchColor =\n    aezColor_new.range[aezColor_new.domain.indexOf(selectedAEZTranslated)];\n  const squareSize = 13;\n  const aezSquare = `&lt;svg width=\"${squareSize}\" height=\"${squareSize}\"&gt;\n    &lt;rect width=\"${squareSize}\" height=\"${squareSize}\" fill=${aezSwatchColor}  /&gt;\n  &lt;/svg&gt;`;\n\n  // crop overview\n  const cropOverview = T.tidy(\n    dataCrop,\n    T.summarize({\n      totalObs: T.sum(\"N_Obs\"),\n      totalPractices: T.n()\n    })\n  )?.[0];\n  const langCropOverview = _lang(\n    langBasePath.cropOverview.main\n  );\n  const langCropOverviewItems = [\n    { insertName: \"selectedCrop\", value: _lang(td.Crop_with_articles.values[selectedCrop]) },\n    { insertName: \"selectedAEZSquare\", value: aezSquare },\n    { insertName: \"selectedAEZ\", value: selectedAEZTranslated },\n    { insertName: \"totalObs\", value: formatComma(cropOverview.totalObs) },\n    {\n      insertName: \"totalObsString\",\n      value:\n        cropOverview.totalObs == 1\n          ? _lang(nbText.supportNbText.words.observation.singular)\n          : _lang(nbText.supportNbText.words.observation.plural)\n    },\n    { insertName: \"totalPractices\", value: cropOverview.totalPractices },\n    {\n      insertName: \"totalPracticesString\",\n      value:\n        cropOverview.totalPractices == 1\n          ? _lang(nbText.supportNbText.words.practice.singular)\n          : _lang(nbText.supportNbText.words.practice.plural)\n    }\n  ];\n  const insightCropOverview = langCropOverviewItems.reduce((overview, item) =&gt; {\n    return overview.replace(\n      Lang.getRegexForNamedInsertion(item.insertName),\n      item.value\n    );\n  }, langCropOverview);\n\n  // positive yield\n  const cropPositive = T.tidy(\n    dataCrop,\n    T.filter((d) =&gt; d.Mean_Difference &gt; 0)\n  )?.length;\n  const langCropPositive = _lang(\n    nbText.practicalImpact.meanCropDiffAEZ.insights.cropPositive.main\n  );\n  const langCropSubstring = `**${cropPositive}** ${\n    cropPositive == 1\n      ? _lang(\n          nbText.practicalImpact.meanCropDiffAEZ.insights.cropPositive.singular\n        )\n      : _lang(\n          nbText.practicalImpact.meanCropDiffAEZ.insights.cropPositive.plural\n        )\n  }`;\n  const insightCropPositive = langCropPositive.replace(\n    Lang.getRegexForNamedInsertion(\"cropPositiveText\"),\n    langCropSubstring\n  );\n\n  // top for selected crop\n  const n = 2; // # top crops to include\n  const topCrop = T.tidy(\n    dataCrop,\n    T.sliceMax(n, \"Mean_Difference\"),\n    T.arrange(T.desc(\"Mean_Difference\"))\n  );\n  const diff1 = topCrop?.[0];\n  const diff2 = topCrop?.[1];\n\n  const langDiffFirst = _lang(langBasePath.diffFirst.main);\n  const langDiffFirst_incDec =\n    diff1.Mean_Difference &gt;= 0\n      ? _lang(nbText.supportNbText.words.increase)\n      : _lang(nbText.supportNbText.words.decrease);\n  const langDiffFirst_observations = diff1.N_Obs;\n  const langDiffFirstItems = [\n    { insertName: \"practice\", value: _lang(td.Practice.values[diff1.Practice]) },\n    {\n      insertName: \"incDec\",\n      value:\n        diff1.Mean_Difference &gt;= 0\n          ? _lang(nbText.supportNbText.words.increase)\n          : _lang(nbText.supportNbText.words.decrease)\n    },\n    { insertName: \"meanDiff\", value: formatNum(diff1.Mean_Difference) },\n    {\n      insertName: \"observationCount\",\n      value: formatComma(langDiffFirst_observations)\n    },\n    {\n      insertName: \"observationString\",\n      value:\n        langDiffFirst_observations &gt; 1\n          ? _lang(nbText.supportNbText.words.observation.plural)\n          : _lang(nbText.supportNbText.words.observation.singular)\n    }\n  ];\n  const insightDiffFirst = langDiffFirstItems.reduce((overview, item) =&gt; {\n    return overview.replace(\n      Lang.getRegexForNamedInsertion(item.insertName),\n      item.value\n    );\n  }, langDiffFirst);\n\n  const langDiffSecond = _lang(langBasePath.diffSecond.main);\n  const langDiffSecond_incDec =\n    diff2?.Mean_Difference &gt;= 0\n      ? _lang(nbText.supportNbText.words.increase)\n      : _lang(nbText.supportNbText.words.decrease);\n  const langDiffSecond_observations = diff2?.N_Obs;\n  const langDiffSecondItems = [\n    { insertName: \"practice\", value: _lang(td.Practice.values[diff2?.Practice]) },\n    {\n      insertName: \"incDec\",\n      value:\n        diff2?.Mean_Difference &gt;= 0\n          ? _lang(nbText.supportNbText.words.increase)\n          : _lang(nbText.supportNbText.words.decrease)\n    },\n    { insertName: \"meanDiff\", value: formatNum(diff2?.Mean_Difference) },\n    {\n      insertName: \"observationCount\",\n      value: formatComma(langDiffSecond_observations)\n    },\n    {\n      insertName: \"observationString\",\n      value:\n        langDiffSecond_observations &gt; 1\n          ? _lang(nbText.supportNbText.words.observation.plural)\n          : _lang(nbText.supportNbText.words.observation.singular)\n    }\n  ];\n  const insightDiffSecond = diff2\n    ? langDiffSecondItems.reduce((overview, item) =&gt; {\n        return overview.replace(\n          Lang.getRegexForNamedInsertion(item.insertName),\n          item.value\n        );\n      }, langDiffSecond)\n    : \"\";\n\n  return md`${insightCropOverview} ${insightCropPositive}\n\n${insightDiffFirst} ${insightDiffSecond ?? \"\"}`;\n}"
  },
  {
    "objectID": "notebooks/solutions/notebook.html#data_sources",
    "href": "notebooks/solutions/notebook.html#data_sources",
    "title": "",
    "section": "",
    "text": "md`${_lang(nbText.methodsSources.h2DataSourcesSubsection)}`;"
  },
  {
    "objectID": "notebooks/solutions/notebook.html#methods-1",
    "href": "notebooks/solutions/notebook.html#methods-1",
    "title": "",
    "section": "",
    "text": "md`\n### ${_lang(nbText.methodsSources.h3Era)}\n${_lang(nbText.methodsSources.h3EraSubsection)}\n`;"
  },
  {
    "objectID": "notebooks/solutions/notebook.html#text-translations-and-language-support",
    "href": "notebooks/solutions/notebook.html#text-translations-and-language-support",
    "title": "",
    "section": "Text translations and language support",
    "text": "Text translations and language support\n\nnbTitle = _lang({ en: \"Discover Solutions\", fr: \"Découvrir des solutions\" });\n// h1\nOverview = _lang(nbText.overview.h1);\n\nInterventions = _lang(nbText.interventions.h1);\n\nPracticalImpact = _lang(nbText.practicalImpact.meanCropDiff.h1);\n\nRisks = _lang(nbText.risks.h1);\n\nFactors = _lang(nbText.adoptionFactors.h1);\n\nSummary = _lang(nbText.summary.h1);\n\nMethods = _lang(nbText.methodsSources.h1);\n\n// h2\ncrop_diff = _lang(nbText.practicalImpact.meanCropDiff.h2.meanDiff);\n\ncrop_diff_aez = _lang(nbText.practicalImpact.meanCropDiffAEZ.h2);\n\naez_dif = _lang(nbText.practicalImpact.meanCropDiffAEZ.h2);\n\ndata_sources = _lang(nbText.methodsSources.h2DataSources);\n\nmethods = _lang(nbText.methodsSources.h2Methods);\n\nquickInsight = _lang(nbText.supportNbText.labels.quickInsights);\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nimport {nbText} from \"/data/DiscoverSolutions/nbText.ojs\"\n\nimport {lang as Lang } from \"/helpers/lang.js\"\n\n_lang = await Lang.lg(language.key)\n\ndefaultLangKey = {\n  const list = languages.map((d) =&gt; d.key);\n  const defaultKey = \"en\";\n  const queryParam = await Lang.getParamFromList({ name: \"lang\", list });\n  return queryParam ?? defaultKey;\n}\n\nlanguages = [\n  { key: \"en\", label: \"English\", locale: 'en-US' },\n  { key: \"fr\", label: \"Français\", locale: 'fr-FR' }\n]\n\nviewof language = Inputs.radio(languages, {\n  label: \"Main language toggle\",\n  format: (d) =&gt; d.key,\n  value: languages.find((x) =&gt; x.key === defaultLangKey),\n})\n\n// data translation values\ntd = {\n  let data = await FileAttachment(\"/data/DiscoverSolutions/translation_v2@1.json\").json();\n\n  /* Additions */\n  data.practices.values[\"All practices\"] = {\n    en: \"All practices\",\n    fr: \"Toutes les pratiques\"\n  };\n\n  data.summarySystems = {\n    en: \"system\",\n    fr: \"système\",\n    values: {\n      Agroforesty: {\n        en: \"Agroforestry\",\n        fr: \"Agroforestière\"\n      },\n      \"Cereal-based\": {\n        en: \"Cereal-based\",\n        fr: \"À base de céréales\"\n      },\n      \"Cereal-based, Rice-based\": {\n        en: \"Cereal-based, Rice-based\",\n        fr: \"À base de céréales, À base de riz\"\n      },\n      \"Maize, Napier grass, Desmodium legume\": {\n        en: \"Maize, Napier grass, Desmodium legume\",\n        fr: \"Maïs, herbe Napier, légumineuse Desmodium\"\n      },\n      \"Maize, Other\": {\n        en: \"Maize, Other\",\n        fr: \"Maïs, autre\"\n      },\n      \"Rice-based\": {\n        en: \"Rice-based\",\n        fr: \"À base de riz\"\n      },\n      Unspecified: {\n        en: \"Unspecified\",\n        fr: \"Non spécifié\"\n      },\n      \"Vegetables, Fruits, Rice\": {\n        en: \"Vegetables, Fruits, Rice\",\n        fr: \"Légumes, Fruits, Riz\"\n      }\n    }\n  };\n\n  data.summaryPractices = {\n    en: \"Practice\",\n    fr: \"Pratique\",\n    values: {\n      \"Agroforestry Fallow\": {\n        en: \"Agroforestry Fallow\",\n        fr: \"Jachère agroforestière\"\n      },\n      \"Agroforestry Pruning\": {\n        en: \"Agroforestry Pruning\",\n        fr: \"Taille agroforestière\"\n      },\n      Alleycropping: {\n        en: \"Alleycropping\",\n        fr: \"Culture en allées\"\n      },\n      Biochar: {\n        en: \"Biochar\",\n        fr: \"Biochar\"\n      },\n      \"Boundary Planting\": {\n        en: \"Boundary Planting\",\n        fr: \"Plantation en bordure\"\n      },\n      Composting: {\n        en: \"Composting\",\n        fr: \"Compostage\"\n      },\n      \"Crop Residue Incorporation\": {\n        en: \"Crop Residue Incorporation\",\n        fr: \"Incorporation des résidus de récolte\"\n      },\n      \"Crop Residue Management\": {\n        en: \"Crop Residue Management\",\n        fr: \"Gestion des résidus de récolte\"\n      },\n      \"Crop Rotation\": {\n        en: \"Crop Rotation\",\n        fr: \"Rotation des cultures\"\n      },\n      \"Deficit Irrigation\": {\n        en: \"Deficit Irrigation\",\n        fr: \"Irrigation déficitaire\"\n      },\n      \"Green Manure\": {\n        en: \"Green Manure\",\n        fr: \"Engrais vert\"\n      },\n      \"Improved Fallows\": {\n        en: \"Improved Fallows\",\n        fr: \"Jachères améliorées\"\n      },\n      \"Improved Varieties\": {\n        en: \"Improved Varieties\",\n        fr: \"Variétés améliorées\"\n      },\n      \"Inorganic Fertilizer\": {\n        en: \"Inorganic Fertilizer\",\n        fr: \"Engrais inorganique\"\n      },\n      Intercropping: {\n        en: \"Intercropping\",\n        fr: \"Culture intercalaire\"\n      },\n      Mulching: {\n        en: \"Mulching\",\n        fr: \"Paillage\"\n      },\n      \"Organic Fertilizer\": {\n        en: \"Organic Fertilizer\",\n        fr: \"Engrais organique\"\n      },\n      \"Other Agroforestry\": {\n        en: \"Other Agroforestry\",\n        fr: \"Autre agroforestière\"\n      },\n      Parklands: {\n        en: \"Parklands\",\n        fr: \"Parcs agroforestiers\"\n      },\n      \"pH Control\": {\n        en: \"pH Control\",\n        fr: \"Contrôle du pH\"\n      },\n      Silvopasture: {\n        en: \"Silvopasture\",\n        fr: \"Sylvopastoralisme\"\n      },\n      \"Supplemental Irrigation\": {\n        en: \"Supplemental Irrigation\",\n        fr: \"Irrigation supplémentaire\"\n      },\n      \"Tillage Management\": {\n        en: \"Tillage Management\",\n        fr: \"Gestion du travail du sol\"\n      },\n      \"Water Harvesting\": {\n        en: \"Water Harvesting\",\n        fr: \"Collecte des eaux\"\n      }\n    }\n  };\n\n  // adoption factors, with articles\n  data.adoption_factors_with_articles = {\n    en: \"adoption_factors\",\n    fr: \"facteurs_dadoption\",\n    values: {\n      \"Access to credit\": { en: \"Access to credit\", fr: \"L'Accès au crédit\" },\n      \"Access to information\": {\n        en: \"Access to information\",\n        fr: \"L'Accès à l'information\"\n      },\n      \"Availability of labor\": {\n        en: \"Availability of labor\",\n        fr: \"La Disponibilité de la main-d'œuvre\"\n      },\n      \"Biophyiscal factors\": {\n        en: \"Biophyiscal factors\",\n        fr: \"Les Facteurs biophysiques\"\n      },\n      \"Changes in weather\": {\n        en: \"Changes in weather\",\n        fr: \"Les Changements climatiques\"\n      },\n      \"Distance to market\": {\n        en: \"Distance to market\",\n        fr: \"La Distance au marché\"\n      },\n      \"Exposure to risks and shocks\": {\n        en: \"Exposure to risks and shocks\",\n        fr: \"L'Exposition aux risques et chocs\"\n      },\n      Other: { en: \"Other\", fr: \"Autre\" },\n      \"Resource endowments\": {\n        en: \"Resource endowments\",\n        fr: \"La Dotation en ressources\"\n      },\n      \"Secure tenure\": { en: \"Secure tenure\", fr: \"La Tenure sécurisée\" },\n      \"Social capital\": { en: \"Social capital\", fr: \"La Capital social\" },\n      \"Socio-demographics\": {\n        en: \"Socio-demographics\",\n        fr: \"La Socio-démographie\"\n      }\n    }\n  };\n\n  // crop articles\n  data.Crop_with_articles = {\n    en: \"crop_with_articles\",\n    fr: \"crop_with_articles\",\n    values: {\n      Maize: { en: \"maize\", fr: \"le maïs\" },\n      Rice: { en: \"rice\", fr: \"le riz\" },\n      \"Pearl Millet\": { en: \"pearl millet\", fr: \"le millet perlé\" },\n      Sorghum: { en: \"sorghum\", fr: \"le sorgho\" },\n      Cowpea: { en: \"cowpea\", fr: \"le niébé\" },\n      \"Common Bean\": { en: \"common bean\", fr: \"le haricot commun\" },\n      Soybean: { en: \"soybean\", fr: \"le soja\" },\n      Cassava: { en: \"cassava\", fr: \"le manioc\" },\n      Groundnut: { en: \"groundnut\", fr: \"l'arachide\" },\n      Wheat: { en: \"wheat\", fr: \"le blé\" },\n      Yam: { en: \"yam\", fr: \"l'igname\" },\n      Cotton: { en: \"cotton\", fr: \"coton\" },\n      Teff: { en: \"teff\", fr: \"le teff\" },\n      Tomato: { en: \"tomato\", fr: \"la tomate\" },\n      Potato: { en: \"potato\", fr: \"la pomme de terre\" },\n      \"Sugar Cane\": { en: \"sugar cane\", fr: \"la canne à sucre\" },\n      \"Pigeon Pea\": { en: \"pigeon pea\", fr: \"le pois cajan\" },\n      Chickpea: { en: \"chickpea\", fr: \"le pois chiche\" },\n      Okra: { en: \"okra\", fr: \"le gombo\" },\n      \"Sweet Potato\": { en: \"sweet potato\", fr: \"la patate douce\" },\n      \"Fodder Legume\": {\n        en: \"fodder legume\",\n        fr: \"la légumineuse fourragère\"\n      },\n      Barley: { en: \"barley\", fr: \"l'orge\" },\n      Olive: { en: \"olive\", fr: \"l'olive\" },\n      Cabbage: { en: \"cabbage\", fr: \"le chou\" },\n      \"Banana Sweet\": { en: \"banana sweet\", fr: \"la banane douce\" },\n      Rape: { en: \"rape\", fr: \"le colza\" },\n      Sunflower: { en: \"sunflower\", fr: \"le tournesol\" },\n      \"Cooking Banana\": {\n        en: \"cooking banana\",\n        fr: \"la banane de cuisine\"\n      },\n      Sesame: { en: \"sesame\", fr: \"le sésame\" }\n    }\n  };\n\n  return data;\n}"
  },
  {
    "objectID": "notebooks/solutions/notebook.html#formatting-functions",
    "href": "notebooks/solutions/notebook.html#formatting-functions",
    "title": "",
    "section": "Formatting functions",
    "text": "Formatting functions\n\nformatNumCompactLong = function (number, { locale = \"en-US\" } = {}) {\n  return new Intl.NumberFormat(locale, {\n    notation: \"compact\",\n    compactDisplay: \"long\",\n    unitDisplay: \"long\",\n  }).format(number);\n};\n\nformatNumStandard = function (number, { locale = \"en-US\" } = {}) {\n  return new Intl.NumberFormat(locale, {}).format(number);\n};\n\n// format number, 2 decimal places\nformatNum = d3.format(\".2f\");\n\nformatComma = d3.format(\",\");"
  },
  {
    "objectID": "notebooks/solutions/notebook.html#import-data-helpers",
    "href": "notebooks/solutions/notebook.html#import-data-helpers",
    "title": "",
    "section": "import data helpers",
    "text": "import data helpers\n\nparseBool = (d) =&gt; {\n  if (d === \"TRUE\") return true;\n  if (d === \"FALSE\") return false;\n  else return null;\n};\n\n// Parsing numbers, blank strings as NaN's\nparseNum = (d) =&gt; {\n  if (typeof d === \"number\" && !isNaN(d)) return d;\n  return d.trim() === \"\" ? NaN : +d;\n};"
  },
  {
    "objectID": "notebooks/solutions/notebook.html#style-things",
    "href": "notebooks/solutions/notebook.html#style-things",
    "title": "",
    "section": "Style things",
    "text": "Style things\n\ncolorYellowGreen = [\"#F7D732\", \"#216729\"]\n\n// aez color scale\naezColor_new = {\n  const lookupAEZ = (aez) =&gt; _lang(td.AEZ_Class_FAO.values[aez])\n  return {\n    domain: [\n      lookupAEZ('Desert/Arid climate'),\n      lookupAEZ(\"Tropics, highland; semi-arid\"),\n      lookupAEZ(\"Tropics, lowland; semi-arid\"),\n      lookupAEZ(\"Subtropics, moderately cool; sub-humid\"),\n      lookupAEZ(\"Tropics, highland; sub-humid\"),\n      lookupAEZ(\"Tropics, lowland; sub-humid\"),\n      lookupAEZ(\"Tropics, highland; humid\"),\n      lookupAEZ(\"Tropics, lowland; humid\"),\n      lookupAEZ(\"Land with ample irrigated soils\"),\n      lookupAEZ(\"Severe soil/terrain limitations\"),\n      lookupAEZ(\"Dominantly urban/built-up land\"),\n    ],\n    range: [\n      \"#F3D6B0\",\n      \"#FCA034\",\n      \"#F7D732\",\n      \"#523D4E\",\n      \"#EF6D94\",\n      \"#F9B1C1\",\n      \"#2A79A8\",\n      \"#79A1B7\",\n      \"#74B95A\",\n      \"#2E7637\",\n      \"#B1B1B1\"\n    ]\n  };\n}"
  },
  {
    "objectID": "notebooks/solutions/notebook.html#sections",
    "href": "notebooks/solutions/notebook.html#sections",
    "title": "",
    "section": "Sections",
    "text": "Sections\n\nshared data\n\nworkbook_meanDifference = FileAttachment(\"/data/DiscoverSolutions/Mean_yield_difference.xlsx\").xlsx()\n\ndata_extendedTable2 = {\n  // data from file\n  const file = FileAttachment(\"/data/DiscoverSolutions/spotlight2_Extended Table 2.csv\").csv();\n\n  // return data\n  return file.then((x) =&gt; {\n    return x.map((row) =&gt; ({\n      practice: String(row.Practice),\n      outcome: String(row.Outcome),\n      product: String(row.Product),\n      is_combo: parseBool(row[\"Is.Combo\"]),\n      observations: parseNum(row.Observations),\n      studies: parseNum(row.Studies),\n      value: parseNum(row.Value),\n      sig: parseNum(row.Sig),\n      value_se: parseNum(row[\"Value.se\"]),\n      ci_low: parseNum(row.CIlow),\n      ci_high: parseNum(row.CIhigh),\n      source: String(row.Source)\n    }));\n  });\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\ndata_extendedTable2_total = {\n  // data from file\n  const file = FileAttachment(\"/data/DiscoverSolutions/spotlight2_Extended Table 2@1.csv\").csv();\n\n  // return data\n  return file.then((x) =&gt; {\n    return x.map((row) =&gt; ({\n      practice: String(row.Practice),\n      outcome: String(row.Outcome),\n      product: String(row.Product),\n      // is_combo: parseBool(row[\"Is.Combo\"]),\n      observations: parseNum(row.Observations),\n      studies: parseNum(row.Studies),\n      value: parseNum(row.Value),\n      sig: parseNum(row.Sig),\n      value_se: parseNum(row[\"Value.se\"]),\n      ci_low: parseNum(row.CIlow),\n      ci_high: parseNum(row.CIhigh),\n      // source: String(row.Source)\n    }));\n  });\n}\n\n\n\n\n\n\n\ncsaManuals = {\n  const file = FileAttachment(\"/data/DiscoverSolutions/CSA-Manuals_Sheet1.csv\").csv()\n\n  // parse columns\n  return file.then((x) =&gt; {\n    return x.map(d =&gt; ({\n      practice: String(d['Practice']).trim(),\n      country_region: String(d['Country or Region']).trim(),\n      system: String(d['System']).trim(),\n      author: String(d['Author']).trim(),\n      title: String(d['Title']).trim(),\n      link: String(d['Link']).trim()\n    }))\n  })\n}\n\n// selections\ncsaResourceHtml = {\n  const data = T.tidy(\n    csaManuals,\n    T.filter((d) =&gt; d.practice == selectResourcePractice.field),\n    T.arrange([\"system\", \"title\"])\n  );\n  const translateSystem = (d) =&gt; _lang(td.summarySystems.values?.[d]);\n  const systemWord = Lang.toTitleCase(_lang(td.summarySystems))\n\n  const htmlList = data.map((d) =&gt; {\n    const system = translateSystem(d.system);\n    return `&lt;li style='padding: 10px 0'&gt;${system}: &lt;a href=${d.link} target='_blank'&gt;${d.title}&lt;/a&gt;&lt;/li&gt;`;\n  });\n\n  return `&lt;b&gt;${systemWord}&lt;/b&gt;\n&lt;ul style='list-style-type:none; padding: 0'&gt;${htmlList.join(\n    \"\"\n  )}&lt;/ul&gt;`;\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPractice/Crop dot plot\n\ndata_meanDiff_practiceCrop = {\n  const raw = workbook_meanDifference.sheet(\"Practice_Crop\", { headers: true });\n  return raw.filter((d) =&gt; {\n    return Object.keys(d).length &gt; 0\n      && meanDiffCropList.includes(d.Crop)\n  });\n}\n\ndata_meanDiff_practiceCrop_new = {\n  const raw = await FileAttachment(\"/data/DiscoverSolutions/figure_2_data@1.csv\").csv({typed: true})\n\n  return raw.map(d =&gt; {\n    return {\n      Practice: d['Practice'],\n      Crop: d['Crop'],\n      N_Obs: d['N_Obs'],\n      N_Pub: d[\"N_Pub\"],\n      Mean_Treatment: d[\"Mean_T\"],\n      Mean_Control: d[\"Mean_C\"],\n      Mean_Difference: d[\"Mean_Difference\"],\n      Se: d['Se'],\n      Lower: d[\"Lower\"],\n      Upper: d[\"Upper\"],\n    }\n  })\n}\n\n// shared column for mean difference dot plots\nviewof selectCropMeanDiff = Inputs.select(meanDiffCropList, {label: \"Crop\", unique: true, sort: true, value: 'Maize'})\n\n// list of crops to show for mean difference (study cutoff)\nmeanDiffCropList = [\n  'Maize',\n  'Cowpea',\n  'Sorghum',\n  'Rice',\n  'Pearl Millet',\n  'Cassava or Yuca',\n  'Common Bean',\n  'Groundnut',\n  'Soybean',\n  'Wheat',\n  'Tomato',\n  'Potato',\n  'Yam',\n  'Cotton',\n  'Sugar Cane',\n  'Okra',\n  'Sweet Potato',\n  'Teff',\n  'Pigeon Pea',\n  'Sesame Seed',\n]\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nAEZ Dot Plot\n\ndata_meanDiff_aezPracticeCrop_new = {\n  const raw = await FileAttachment(\"/data/DiscoverSolutions/Mean_yield_difference@1.csv\").csv({typed: true})\n  \n  const formatted = T.tidy(\n    raw,\n    T.filter((d) =&gt; Object.keys(d).length &gt; 0),\n    T.rename({\n      Mean_T: 'Mean_Treatment',\n      Mean_C: 'Mean_Control',\n    })\n  )\n  return formatted\n}\n\n\n\n\n\n\n\n\nRisk\n\ndata_lclRisk = data_extendedTable2.filter((d) =&gt; d.outcome == \"LCL Risk\");\n\n\n\n\n\n\n\n\nAdoption Factors\n\nadoptionFactorAllLabel = \"All practices\"\n\nrawAdoptionFactors = {\n  const raw = await FileAttachment(\"/data/DiscoverSolutions/adoption_factors_20mar24.csv\").csv()\n\n  return raw.map(d =&gt; {\n    return {\n      index: d[''],\n      practice: String(d['practices']),\n      factor: String(d['adoption_factors']),\n      direction: String(d['direction']),\n      n: parseNum(d.n)\n    }\n  })\n}\n\ndataAdoptionFactors = {\n  const allPractices = T.tidy(\n    rawAdoptionFactors,\n    T.groupBy(\n      [\"factor\", \"direction\"],\n      [\n        T.summarize({\n          n: T.sum(\"n\")\n        })\n      ]\n    ),\n    T.groupBy(\n      [\"factor\"],\n      [\n        T.mutateWithSummary({\n          total: T.sum(\"n\")\n        })\n      ]\n    ),\n    T.mutate({ perc: (d) =&gt; (d.n / d.total) * 100 }),\n    T.mutate({ practice: (d) =&gt; adoptionFactorAllLabel }),\n    T.select([\"practice\", T.everything()])\n  );\n\n  const wrangled = T.tidy(\n    rawAdoptionFactors,\n    T.select(T.negate(\"index\")),\n    T.groupBy(\n      [\"practice\", \"factor\"],\n      [T.mutateWithSummary({ total: T.sum(\"n\") })]\n    ),\n    T.mutate({\n      perc: (d) =&gt; (d.n / d.total) * 100\n    })\n  );\n\n  return [\n    ...wrangled,\n    ...allPractices\n  ]\n}\n\n// mapped adoption data\ndataAdoptionFactorsMap = d3.group(dataAdoptionFactors, d =&gt; d.practice)\n\nadoptionFactorsLookup = ({\n  \"Not significant\": _lang(nbText.adoptionFactors.plot.labels.notSig),\n  \"Negative\": _lang(nbText.adoptionFactors.plot.labels.neg),\n  \"Positive\": _lang(nbText.adoptionFactors.plot.labels.pos),\n})\n\nfunction markBoldSidebarText(data, {textFormat=(d) =&gt; d + ' obs.', ...options } = {}) {\n  return Plot.marks(\n    // observation counts\n    Plot.textY(\n      data,\n      Plot.map(\n        { text: (values) =&gt; values.map((d) =&gt; textFormat(d)) },\n        Plot.groupY(\n          { text: \"sum\" },\n          {\n            frameAnchor: \"right\",\n            textAnchor: \"start\",\n            dx: 16,\n            ...options\n          }\n        )\n      )\n    ),\n    // digital white-out\n    Plot.textY(\n      data,\n      Plot.pointerY(\n        Plot.map(\n          { text: (values) =&gt; values.map((d) =&gt; textFormat(d)) },\n          Plot.groupY(\n            { text: \"sum\" },\n            {\n              // y: \"factor\",\n              // text: \"n\",\n              frameAnchor: \"right\",\n              textAnchor: \"start\",\n              dx: 16,\n              fill: \"white\",\n              stroke: \"white\",\n              strokeWidth: 2,\n              ...options\n            }\n          )\n        )\n      )\n    ),\n    // observation counts bold hover\n    Plot.textY(\n      data,\n      Plot.pointerY(\n        Plot.map(\n          { text: (values) =&gt; values.map((d) =&gt; textFormat(d)) },\n          Plot.groupY(\n            { text: \"sum\" },\n            {\n              // y: \"factor\",\n              // text: \"n\",\n              frameAnchor: \"right\",\n              textAnchor: \"start\",\n              dx: 16,\n              fontWeight: \"bold\",\n              ...options\n            }\n          )\n        )\n      )\n    )\n  );\n}"
  },
  {
    "objectID": "notebooks/solutions/notebook.html#imports",
    "href": "notebooks/solutions/notebook.html#imports",
    "title": "",
    "section": "Imports",
    "text": "Imports\n\nimport { T } from \"@pbeshai/tidyjs\";"
  }
]